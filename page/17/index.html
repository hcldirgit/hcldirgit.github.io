<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>失落的乐章</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="失落的乐章的Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="失落的乐章">
<meta property="og:url" content="https://hcldirgit.github.io/page/17/index.html">
<meta property="og:site_name" content="失落的乐章">
<meta property="og:description" content="失落的乐章的Blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="失落的乐章">
<meta name="twitter:description" content="失落的乐章的Blog">
  
    <link rel="alternative" href="/atom.xml" title="失落的乐章" type="application/atom+xml">
  
  
    <link rel="icon" href="https://github.com/hcldirgit/image/blob/master/0.png?raw=true">
  
  <link rel="stylesheet" href="/css/style.css">
  
  
<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-85415703-1', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  <script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>
  <script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>

  
</head>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://github.com/hcldirgit/image/blob/master/0.png?raw=true" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">失落的乐章</a></h1>
		</hgroup>

		
		<p class="header-subtitle">技术面前，永远都是学生。</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/tags">静心阅读</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Ansible/" style="font-size: 10.42px;">Ansible</a> <a href="/tags/Apache/" style="font-size: 18.33px;">Apache</a> <a href="/tags/Cacti/" style="font-size: 11.67px;">Cacti</a> <a href="/tags/DNS/" style="font-size: 13.33px;">DNS</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/FTP/" style="font-size: 11.25px;">FTP</a> <a href="/tags/Git/" style="font-size: 10.83px;">Git</a> <a href="/tags/HA集群/" style="font-size: 11.67px;">HA集群</a> <a href="/tags/Hadoop/" style="font-size: 12.5px;">Hadoop</a> <a href="/tags/Jenkins/" style="font-size: 10.42px;">Jenkins</a> <a href="/tags/LAMP/" style="font-size: 19.58px;">LAMP</a> <a href="/tags/LNMP/" style="font-size: 17.08px;">LNMP</a> <a href="/tags/LVS/" style="font-size: 16.67px;">LVS</a> <a href="/tags/Linux/" style="font-size: 19.17px;">Linux</a> <a href="/tags/Linux命令/" style="font-size: 20px;">Linux命令</a> <a href="/tags/Linux安全/" style="font-size: 14.17px;">Linux安全</a> <a href="/tags/Memcached/" style="font-size: 11.25px;">Memcached</a> <a href="/tags/MongoDB/" style="font-size: 15.42px;">MongoDB</a> <a href="/tags/MySQL/" style="font-size: 17.5px;">MySQL</a> <a href="/tags/NFS/" style="font-size: 10px;">NFS</a> <a href="/tags/Nagios/" style="font-size: 11.67px;">Nagios</a> <a href="/tags/Nginx/" style="font-size: 17.92px;">Nginx</a> <a href="/tags/OpenStack/" style="font-size: 11.25px;">OpenStack</a> <a href="/tags/Php/" style="font-size: 14.58px;">Php</a> <a href="/tags/Puppet/" style="font-size: 11.25px;">Puppet</a> <a href="/tags/Python/" style="font-size: 14.58px;">Python</a> <a href="/tags/Redis/" style="font-size: 16.25px;">Redis</a> <a href="/tags/Resin/" style="font-size: 10px;">Resin</a> <a href="/tags/Saltstack/" style="font-size: 10px;">Saltstack</a> <a href="/tags/Samba/" style="font-size: 12.08px;">Samba</a> <a href="/tags/Squid/" style="font-size: 14.58px;">Squid</a> <a href="/tags/Tomcat/" style="font-size: 13.75px;">Tomcat</a> <a href="/tags/Zabbix/" style="font-size: 15.83px;">Zabbix</a> <a href="/tags/haproxy/" style="font-size: 12.5px;">haproxy</a> <a href="/tags/keepalived/" style="font-size: 12.92px;">keepalived</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/shell练习/" style="font-size: 18.75px;">shell练习</a> <a href="/tags/正则表达式/" style="font-size: 12.92px;">正则表达式</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">失落的乐章</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="https://github.com/hcldirgit/image/blob/master/0.png?raw=true" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">失落的乐章</h1>
			</hgroup>
			
			<p class="header-subtitle">技术面前，永远都是学生。</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/tags">静心阅读</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-OpenStack/2. keystone概念解析" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/OpenStack/2. keystone概念解析/" class="article-date">
  	<time datetime="2017-09-02T18:09:22.855Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/OpenStack/2. keystone概念解析/">
        keystone概念解析
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Keystone简介"><a href="#Keystone简介" class="headerlink" title="Keystone简介"></a>Keystone简介</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Keystone（OpenStack Identity Service）是OpenStack框架中，负责身份验证、服务规则和服务令牌的功能， 它实现了OpenStack的Identity API。Keystone类似一个服务总线， 或者说是整个Openstack框架的注册表， 其他服务通过keystone来注册其服务的Endpoint（服务访问的URL），任何服务之间相互的调用， 需要经过Keystone的身份验证， 来获得目标服务的Endpoint来找到目标服务。</p>
<h2 id="Keystone基本概念介绍"><a href="#Keystone基本概念介绍" class="headerlink" title="Keystone基本概念介绍"></a>Keystone基本概念介绍</h2><h3 id="1-User"><a href="#1-User" class="headerlink" title="1.User"></a>1.User</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;User即用户，他们代表可以通过keystone进行访问的人或程序。Users通过认证信息（credentials，如密码、API Keys等）进行验证。</p>
<h3 id="2-Tenant"><a href="#2-Tenant" class="headerlink" title="2.Tenant"></a>2.Tenant</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Tenant即租户，它是各个服务中的一些可以访问的资源集合。例如，在Nova中一个tenant可以是一些机器，在Swift和Glance中一个tenant可以是一些镜像存储，在Quantum中一个tenant可以是一些网络资源。Users默认的总是绑定到某些tenant上。</p>
<h3 id="3-Role"><a href="#3-Role" class="headerlink" title="3.Role"></a>3.Role</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Role即角色，Roles代表一组用户可以访问的资源权限，例如Nova中的虚拟机、Glance中的镜像。Users可以被添加到任意一个全局的 或 租户内的角色中。在全局的role中，用户的role权限作用于所有的租户，即可以对所有的租户执行role规定的权限；在租户内的role中，用户仅能在当前租户内执行role规定的权限。</p>
<h3 id="4-Service"><a href="#4-Service" class="headerlink" title="4.Service"></a>4.Service</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Service即服务，如Nova、Glance、Swift。根据前三个概念（User，Tenant和Role）一个服务可以确认当前用户是否具有访问其资源的权限。但是当一个user尝试着访问其租户内的service时，他必须知道这个service是否存在以及如何访问这个service，这里通常使用一些不同的名称表示不同的服务。在上文中谈到的Role，实际上也是可以绑定到某个service的。例如，当swift需要一个管理员权限的访问进行对象创建时，对于相同的role我们并不一定也需要对nova进行管理员权限的访问。为了实现这个目标，我们应该创建两个独立的管理员role，一个绑定到swift，另一个绑定到nova，从而实现对swift进行管理员权限访问不会影响到Nova或其他服务。</p>
<h3 id="5-Endpoint"><a href="#5-Endpoint" class="headerlink" title="5.Endpoint"></a>5.Endpoint</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Endpoint，翻译为“端点”，我们可以理解它是一个服务暴露出来的访问点，如果需要访问一个服务，则必须知道他的endpoint。因此，在keystone中包含一个endpoint模板（endpoint template，在安装keystone的时候我们可以在conf文件夹下看到这个文件），这个模板提供了所有存在的服务endpoints信息。一个endpoint template包含一个URLs列表，列表中的每个URL都对应一个服务实例的访问地址，并且具有public、private和admin这三种权限。public url可以被全局访问（如<a href="http://compute.example.com），private" target="_blank" rel="external">http://compute.example.com），private</a> url只能被局域网访问（如<a href="http://compute.example.local），admin" target="_blank" rel="external">http://compute.example.local），admin</a> url被从常规的访问中分离。</p>
<h3 id="keystone的理解"><a href="#keystone的理解" class="headerlink" title="keystone的理解"></a>keystone的理解</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;keystone 里面的概念很多，有：User，Credentials，Authentication，Token，Tenant，Service，Endpoint，Role。在这么多概念中，其实最主要的就是 User 和 Tenant 。由于一些安全，服务问题，才引发了其它的概念。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;那什么叫做 User ，Tenant 呢？这里我举个比较好理解的例子。我们去宾馆住的时候，我们自己就相当于 User ，而宾馆就是 Tenant 。这是最简单的情况，宾馆值提供房间，我们只需要住房。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;随着后来生活物质等的提高，这种现象就变了。我们去宾馆住的时候，很多东西都不一样，比如，开房间要身份证，房间的钥匙是一个可以当卡刷的牌子，我们进出宾馆的时候需要用自己的钥匙来开启宾馆的大门；还有就是，宾馆不仅仅是用来住的了，它可以给我们提供饮食，娱乐，健身等各种服务；而且服务层次的不同，房间也不同，房间里面的配置豪华程度也不一样。在这种情况下，描述我们和宾馆之间的关系就复杂一些了，这就引发了一些新的概念。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;举完这个例子， keystone 中的各种概念就可以和例子中的事物相挂钩了。</p>
<table>
<thead>
<tr>
<th style="text-align:center">User</th>
<th style="text-align:center">住宾馆的人</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Credentials</td>
<td style="text-align:center">开启房间的钥匙</td>
</tr>
<tr>
<td style="text-align:center">Authentication</td>
<td style="text-align:center">宾馆为了拒绝不必要的人进出宾馆，专门设置的机制，只有拥有钥匙的人才能进出</td>
</tr>
<tr>
<td style="text-align:center">Token</td>
<td style="text-align:center">也是一种钥匙，有点特别Tenant宾馆Service宾馆可以提供的服务类别，比如，饮食类，娱乐类</td>
</tr>
<tr>
<td style="text-align:center">Endpoint</td>
<td style="text-align:center">具体的一种服务，比如吃烧烤，打羽毛球</td>
</tr>
<tr>
<td style="text-align:center">Role</td>
<td style="text-align:center">VIP 等级，VIP越高，享有越高的权限</td>
</tr>
</tbody>
</table>
<h2 id="Keystone在OpenStack中的访问流程范例"><a href="#Keystone在OpenStack中的访问流程范例" class="headerlink" title="Keystone在OpenStack中的访问流程范例"></a>Keystone在OpenStack中的访问流程范例</h2><p><img src="https://github.com/hcldirgit/image/blob/master/keystone%E6%A6%82%E5%BF%B5%E8%A7%A3%E6%9E%90/01.png?raw=true" alt=""></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenStack/">OpenStack</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Resin/1. resin安装与配置" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Resin/1. resin安装与配置/" class="article-date">
  	<time datetime="2017-09-02T18:09:22.853Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Resin/1. resin安装与配置/">
        resin安装与配置
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;resin 同样也需要 jdk 的支持，所以第一步也是安装 jdk 。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<a href="http://caucho.com/" target="_blank" rel="external">resin官方网站</a> ，它分两个版本，resin 是开源的，另外一个 resinpro 为商业版本。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@192 src]<span class="comment"># wget http://caucho.com/download/resin-4.0.51.tar.gz</span></div><div class="line">[root@192 src]<span class="comment"># tar zxvf resin-4.0.51.tar.gz </span></div><div class="line">[root@192 src]<span class="comment"># cd resin-4.0.51</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">./configure --prefix=/usr/<span class="built_in">local</span>/resin --with-java-home=/usr/<span class="built_in">local</span>/jdk1.8.0_111</div><div class="line">make &amp;&amp; make install</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@192 resin-4.0.51]<span class="comment"># /etc/init.d/resin start</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;下面简单配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@192 resin-4.0.51]<span class="comment"># cd /usr/local/resin/conf/</span></div><div class="line">[root@192 conf]<span class="comment"># vim resin.xml</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;resin 的配置文件和 tomcat 的很像，基本结构为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;cluster id=<span class="string">"app"</span>&gt;</div><div class="line">&lt;host&gt;&lt;/host&gt;</div><div class="line">&lt;/cluster&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;其中虚拟主机配置就在 <host></host> 里配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@192 conf]<span class="comment"># vim resin.xml</span></div><div class="line"></div><div class="line">&lt;host id=<span class="string">"www.123.com"</span> root-directory=<span class="string">"."</span>&gt;</div><div class="line">  &lt;web-app id=<span class="string">"/"</span> root-directory=<span class="string">"/tmp/resin"</span>&gt;</div><div class="line">&lt;/host&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注意，这里要放在  <cluster id="app"> 下边</cluster></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建文件夹，并重启 resin</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@192 conf]<span class="comment"># mkdir /tmp/resin</span></div><div class="line">[root@192 conf]<span class="comment"># service resin stop</span></div><div class="line">Stopping resin: .</div><div class="line">[root@192 conf]<span class="comment"># service resin start</span></div><div class="line">Starting resin: .</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后编辑一个测试文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@192 conf]<span class="comment"># vim /tmp/resin/222.jsp</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;html&gt;&lt;body&gt;&lt;center&gt; </div><div class="line"> </div><div class="line">Now time is: &lt;%=new java.util.Date()%&gt; </div><div class="line"> </div><div class="line">&lt;/center&gt;&lt;/body&gt;&lt;/html&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@192 conf]<span class="comment"># curl -x127.0.0.1:80 www.123.com/222.jsp</span></div><div class="line">&lt;html&gt;&lt;body&gt;&lt;center&gt; </div><div class="line"> </div><div class="line">Now time is: Wed Apr 05 13:30:44 CST 2017 </div><div class="line"> </div><div class="line">&lt;/center&gt;&lt;/body&gt;&lt;/html&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;更改监听端口，需编辑配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@192 conf]<span class="comment"># vim resin.properties</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/resin%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/01.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改为</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/resin%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/02.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;重启服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@192 conf]<span class="comment"># service resin stop</span></div><div class="line">Stopping resin: .</div><div class="line">[root@192 conf]<span class="comment"># service resin start</span></div><div class="line">Starting resin: .</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;登录本地 IP 就能访问 resin 的默认页面</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/resin%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/03.png?raw=true" alt=""></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Resin/">Resin</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-NFS/1. nfs部署和优化" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/NFS/1. nfs部署和优化/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.833Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/NFS/1. nfs部署和优化/">
        nfs部署和优化
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;NFS = network file system</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;NFS服务比较常用，用于在网络上共享储存。</p>
<h2 id="服务端配置-NFS"><a href="#服务端配置-NFS" class="headerlink" title="服务端配置 NFS"></a>服务端配置 NFS</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;centos 上使用 NFS 服务，需要安装两个包（nfs-utils 和 rpcbind），不过当使用 yum 安装 nfs-utils 时会把 rpcbind 一起安装上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># yum install -y nfs-utils rpcbind</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在以前的 centos 版本中，是需要安装 portmap 包的，从 centos 6 开始，就改为rpcbind了。NFS 配置起来很简单，只需要编辑配置文件 /etc/exports 即可。先创建一个简单的 NFS 服务器。 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># vim /etc/exports</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;写入一下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/home/ 192.168.0.0/24(rw,sync,all_squash,anonuid=501,anongid=501)</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这个配置文件就这样简单一行。共分为三部分，第一部分就是本地要共享出去的目录，第二部分为允许访问的主机（可以是一个 IP 也可以是一个 IP 段），第三部分就是小括号里面的，为一些权限选项。</p>
<ul>
<li><p>rw： 读写；</p>
</li>
<li><p>ro： 只读；</p>
</li>
<li><p>sync： 同步模式，内存中数据时时写入磁盘；</p>
</li>
<li><p>async： 不同步，把内存中数据定期写入磁盘中；</p>
</li>
<li><p>no_root_squash： 加上这个选项后，root 用户就会对共享的目录拥有至高的权限控制，就像是对本机的目录操作一样。但这样不安全，不建议使用。</p>
</li>
<li><p>roo_squash： 和上面的选项对应，root 用户对共享目录权限不高，只有普通用户的权限，即限制了 root 。</p>
</li>
<li><p>all_squash： 不管使用 NFS 的用户是谁，他的身份都会被限定成一个指定的普通用户身份。</p>
</li>
<li><p>anonuid/anongid： 要和root_squash 以及 all_squash一同使用，用于指定使用 NFS 的用户限定后的 uid 和 gid ，前提是本机的 /etc/passwd 存在这个 uid 和 gid 。</p>
</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;现在分析一下刚才配置的那个 /etc/exports 文件。其中共享的目录为 /home ，信任的主机为 192.168.0.0/24 这个网段，权限为读写，同步，限定所有使用者，并且限定 uid 和 gid 都为501.</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑好配置文件后，就该启动服务了 ：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># service rpcbind start</span></div><div class="line">正在启动 rpcbind： [确定]</div><div class="line">[root@localhost ~]<span class="comment"># service nfs start</span></div><div class="line">启动 NFS 服务： [确定]</div><div class="line">启动 NFS mountd： [确定]</div><div class="line">启动 NFS 守护进程： [确定]</div><div class="line">正在启动 RPC idmapd： [确定]</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在启动服务以前，需要先启动 rpcbind 服务，以前的 centos 老版本中并不是 rpcbind ，而是叫做 portmap。</p>
<h2 id="客户端上挂载-NFS"><a href="#客户端上挂载-NFS" class="headerlink" title="客户端上挂载 NFS"></a>客户端上挂载 NFS</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;客户端挂载 NFS 以前，需要先查看服务端都共享了哪些目录，需要使用 showmount 命令，但这个命令是 nfs-utils 这个包带的，所以同样需要安装 nfs-utils</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@192 ~]<span class="comment"># yum install -y nfs-utils</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;现在可以查看服务器端都共享了那些目录了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@192 ~]<span class="comment"># showmount -e 192.168.0.73</span></div><div class="line">Export list <span class="keyword">for</span> 192.168.0.73:</div><div class="line">/home 192.168.0.0/24</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明：其中 192.168.0.73 为 NFS 服务端 IP。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;可以看到在服务器端配置的 nfs 共享信息。showmount -e 加 ip 就可以查看 nfs 的共享情况，可以看到 192.168.0.73 的共享目录为 /home ，信任主机为 192.168.0.0/24 这个网段。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;下面的命令是在客户端上挂载 nfs ：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@192 ~]<span class="comment"># mount -t nfs -o nfsvers=3 192.168.0.73:/home/ /mnt/</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明： -o 后面跟挂载选项，如果不加 -o nfsvers=3 则在挂载目录下的文件属主和组都是 nobody，如果指定 nfsers=3 则显示501，所以尽量加上这个选项，避免权限混乱。</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/nfs%E9%83%A8%E7%BD%B2%E5%92%8C%E4%BC%98%E5%8C%96/01.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;用 df -h 命令可以查看到多出来的一个 /mnt 分区，它就是 NFS 共享的目录了。</p>
<h2 id="命令-exportfs"><a href="#命令-exportfs" class="headerlink" title="命令 exportfs"></a>命令 exportfs</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;还有一个常用的命令就是 exportfs ，它的常用选项为 [-aruv]</p>
<ul>
<li>-a： 全部挂载或者卸载；</li>
<li>-r： 重新挂载；</li>
<li>-u： 卸载某一个目录；</li>
<li>-v： 显示共享的目录</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;使用 exportfs 命令，当改变 /etc/exports 配置文件后，不用重启 nfs 服务直接用这个 exportfs 即可。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;下面先更改服务端的配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@192 ~]<span class="comment"># vim /etc/exports</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;增加一行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/tmp/ 192.168.0.0/24(rw,sync,no_root_squash)</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后服务端上执行命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@192 ~]<span class="comment"># exportfs -arv</span></div><div class="line">exporting 192.168.0.0/24:/tmp</div><div class="line">exporting 192.168.0.0/24:/home</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在之前的命令中用到了 mount 命令来挂载 nfs ，其实 mount 这个 nfs 服务还是有些说法的。首先是用 -t nfs 来指定挂载的类型为 nfs 另外在使用 nfs 时，常用一个选项就是 -o nolock 了，即在挂载 nfs 服务时，不加锁。在客户端上执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@192 ~]<span class="comment"># mkdir /test</span></div><div class="line">[root@192 ~]<span class="comment"># mount -t nfs -o nolock 192.168.0.73:/tmp/ /test/</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;还可以把要挂载的 nfs 目录写到 client 上的 /etc/fstab 文件中，挂载时只需要执行 mount -a 即可。在 /etc/fstab 里加一行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@192 ~]<span class="comment"># vim /etc/fstab</span></div><div class="line"></div><div class="line">1192.168.0.73:/tmp/     /<span class="built_in">test</span>     nfs     nolock     0 0</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/nfs%E9%83%A8%E7%BD%B2%E5%92%8C%E4%BC%98%E5%8C%96/02.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;因为刚挂载过，所以先卸载：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@192 ~]<span class="comment"># umount /test/</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/nfs%E9%83%A8%E7%BD%B2%E5%92%8C%E4%BC%98%E5%8C%96/03.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@192 ~]<span class="comment"># mount -a</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/nfs%E9%83%A8%E7%BD%B2%E5%92%8C%E4%BC%98%E5%8C%96/04.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这样也可以挂载上，而且以后开机会自动挂载。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NFS/">NFS</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Nagios/5. nagios调用短信接口" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Nagios/5. nagios调用短信接口/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.830Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Nagios/5. nagios调用短信接口/">
        nagios调用短信接口
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;公司正好有自己的短信接口平台，接下来带大家一起配置nagios调用第三方短信接口。</p>
<ol>
<li>首先我们要写一个调用短信接口的脚本，网上的脚本大都是python写的，我这个是shell写的，比较好理解。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /root/duanxin.sh</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 脚本的日志文件 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">LOGFILE=<span class="string">"/data1/sms_log/sms_send_.log"</span>  <span class="comment">#定义发送短信的日志信息 文件</span></div><div class="line">:&gt;&gt;<span class="string">"<span class="variable">$LOGFILE</span>"</span> </div><div class="line"><span class="built_in">exec</span> 1&gt;&gt;<span class="string">"<span class="variable">$LOGFILE</span>"</span> </div><div class="line"><span class="built_in">exec</span> 2&gt;&amp;1 </div><div class="line"></div><div class="line">Uid=<span class="string">"test"</span>    <span class="comment">#接口的用户名，这个使用接口时对方会提供，我这里的test是随意写的</span></div><div class="line">Key=<span class="string">"123456"</span>  <span class="comment">#密码与用户名对应，也是接口方提供</span></div><div class="line"></div><div class="line">MOBILE_NUMBER=<span class="variable">$1</span> <span class="comment"># 接受短信的手机号码  </span></div><div class="line">QIANMING=<span class="string">"%e3%80%90%e9%a9%ac%e5%8f%af%e6%b3%a2%e7%bd%97%e7%bd%91%e3%80%91"</span> <span class="comment">#这里重点说一下，签名有的接口需要，有的不需要，因为我们公司的接口需要，所以需要添加上，我这里的签名内容是经过编码的，不加编码会导致发送失败，具体工作中需不需要编码还得看接口哪边有没有要求。</span></div><div class="line">XXD=<span class="string">"/usr/bin/xxd"</span> </div><div class="line">CURL=<span class="string">"/usr/bin/curl"</span> </div><div class="line">TIMEOUT=5 </div><div class="line">MESSAGE_ENCODE=$(<span class="built_in">echo</span> $(/usr/<span class="built_in">local</span>/bin/php -r <span class="string">"echo urlencode(\"<span class="variable">$2</span>\");"</span>; ) )  <span class="comment">#这里的$2是nagios发送短信的第二个变量</span></div><div class="line">URL=<span class="string">"http://192.168.100.100:8888/services/msgsend.asmx/SendMsg?userCode=<span class="variable">$&#123;$Uid&#125;</span>&amp;userPass=<span class="variable">$&#123;Key&#125;</span>&amp;DesNo=<span class="variable">$&#123;MOBILE_NUMBER&#125;</span>&amp;Msg=<span class="variable">$&#123;MESSAGE_ENCODE&#125;</span><span class="variable">$&#123;QIANMING&#125;</span>&amp;Channel=0"</span></div><div class="line"><span class="comment">#这里的URL是胡乱写的，不可能暴漏自己公司的接口哈，但是格式大体是这样的，到时候接口方会提供URL的格式的</span></div><div class="line"><span class="comment"># Send it </span></div><div class="line"><span class="built_in">set</span> -x </div><div class="line"><span class="variable">$&#123;CURL&#125;</span> -s --connect-timeout <span class="variable">$&#123;TIMEOUT&#125;</span> <span class="string">"<span class="variable">$&#123;URL&#125;</span>"</span></div></pre></td></tr></table></figure>
<ol>
<li>测试脚本</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bash /root/duanxin.sh <span class="string">"手机号"</span> “内容”</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;如果脚本报错，可以根据报错信息检查脚本，如果脚本没有问题，但是短信发不出去，可以看看sms_send_log里面的报错信息</p>
<ol>
<li>nagios 调用脚本，不要忘记脚本要给执行权限，一般脚本放在root目录下，nagios在调用脚本时是不能访问root目录的，所以你还要看你/root目录的权限</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">define <span class="built_in">command</span> &#123;</div><div class="line">       command_name host-notify-by-sms</div><div class="line">       command_line /root/duanxin.sh <span class="variable">$CONTACTPAGER</span>$ <span class="string">"<span class="variable">$HOSTNAME</span>$ <span class="variable">$HOSTSTATE</span>$ <span class="variable">$SHORTDATETIME</span>$"</span></div><div class="line">       &#125;</div><div class="line"></div><div class="line">define <span class="built_in">command</span> &#123;</div><div class="line">       command_name service-notify-by-sms</div><div class="line">       command_line /root/duanxin.sh <span class="variable">$CONTACTPAGER</span>$ <span class="string">"<span class="variable">$SERVICESTATE</span>$ <span class="variable">$SERVICEOUTPUT</span>$ <span class="variable">$HOSTALIAS</span>$/<span class="variable">$SERVICEDESC</span>$ <span class="variable">$SHORTDATETIME</span>$"</span></div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<ol>
<li>看到这里大家可能对上面脚本的$1和$2概念比较模糊，其实刚开始我也迷糊，nagios怎么知道我要发送的号码呢，后来研究发现，$CONTACTPAGER$这个<br>量就是nagios内部联系人的变量，也就是他会调用我们在contacts.cfg里面定义的手机号，而我们脚本里面定义的$1就对应$CONTACTPAGER$，$2就对应”$HOSTNAME$ $HOSTSTATE$ $SHORTDATETIME$” </li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nagios/">Nagios</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Nagios/4. Nagios整合微信订阅号报警" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Nagios/4. Nagios整合微信订阅号报警/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.829Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Nagios/4. Nagios整合微信订阅号报警/">
        Nagios整合微信订阅号报警
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;环境：rhel6.5 selinux 和 iptables 关闭。要求能上外网的（虚拟机亲测可用）</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;以下是nagios服务与微信订阅号的整合过程，最终实现当服务或主机出现故障，自动调用微信报警。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;重点讲述如何配置微信公众平台私有接口，至于nagios服务的配置请大家参照nagios官方文档进行，此处不再赘述。（www.nagios.org）</p>
<h2 id="1-下载微信公众平台私有接口"><a href="#1-下载微信公众平台私有接口" class="headerlink" title="1.下载微信公众平台私有接口"></a>1.下载微信公众平台私有接口</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum install -y git</div><div class="line">git <span class="built_in">clone</span> https://github.com/lealife/WeiXin-Private-API</div></pre></td></tr></table></figure>
<h2 id="2-修改微信公众平台私有接口代码，以配合nagios报警"><a href="#2-修改微信公众平台私有接口代码，以配合nagios报警" class="headerlink" title="2.修改微信公众平台私有接口代码，以配合nagios报警"></a>2.修改微信公众平台私有接口代码，以配合nagios报警</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cp -r WeiXin-Private-API /usr/<span class="built_in">local</span>/nagios/libexec/weixin</div><div class="line">chown -R nagios.nagios /usr/<span class="built_in">local</span>/nagios/libexec/weixin</div><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/nagios/libexec/weixin</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改config.php文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$G_CONFIG</span>[<span class="string">"weiXin"</span>] = array(</div><div class="line"></div><div class="line">        <span class="string">'account'</span> =&gt; <span class="string">'微信公众平台登录帐号'</span>,<span class="comment">#填写你注册的微信订阅号的帐号和密码</span></div><div class="line"></div><div class="line">        <span class="string">'password'</span> =&gt; <span class="string">'微信公众平台登录密码'</span>,</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改test.php文件,只保留如下几行即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">require <span class="string">"config.php"</span>;</div><div class="line">require <span class="string">"include/WeiXin.php"</span>;</div><div class="line"></div><div class="line"><span class="variable">$weiXin</span> = new WeiXin(<span class="variable">$G_CONFIG</span>[<span class="string">'weiXin'</span>]);</div><div class="line"></div><div class="line"><span class="variable">$testFakeId</span> = <span class="string">"<span class="variable">$argv</span>[1]"</span>;<span class="comment">#微信好友ID号，这里通过nagios传入</span></div><div class="line"></div><div class="line"><span class="variable">$msg</span> = `cat /usr/<span class="built_in">local</span>/nagios/var/nagios.msg`;<span class="comment">#要发送的报警信息，由nagios传入</span></div><div class="line"></div><div class="line">print_r(<span class="variable">$weiXin</span>-&gt;send(<span class="variable">$testFakeId</span>, <span class="string">"<span class="variable">$msg</span>"</span>));<span class="comment">#给微信好友发送信息</span></div></pre></td></tr></table></figure>
<h2 id="3-整合nagios和微信公共平台私有接口"><a href="#3-整合nagios和微信公共平台私有接口" class="headerlink" title="3.整合nagios和微信公共平台私有接口"></a>3.整合nagios和微信公共平台私有接口</h2><h3 id="增加微信报警选项-templates-cfg"><a href="#增加微信报警选项-templates-cfg" class="headerlink" title="增加微信报警选项: templates.cfg"></a>增加微信报警选项: templates.cfg</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改 /usr/local/nagios/etc/objects/templates.cfg</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在 define contact{…} 部分,将以下两行:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">host_notification_commands notify-host-by-email</div><div class="line">service_notification_commands notify-service-by-email</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;改为:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">host_notification_commands notify-host-by-email,notify-host-by-weixin</div><div class="line">service_notification_commands notify-service-by-email,notify-service-by-weixin</div></pre></td></tr></table></figure>
<h3 id="增加调用命令-commands-cfg"><a href="#增加调用命令-commands-cfg" class="headerlink" title="增加调用命令: commands.cfg"></a>增加调用命令: commands.cfg</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改 /usr/local/nagios/etc/objects/commands.cfg</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在该文件的最后增加以下部分:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">        <span class="comment">####notify-service-by-weixin</span></div><div class="line">define <span class="built_in">command</span>&#123;</div><div class="line">                command_name notify-service-by-weixin</div><div class="line">                command_line /usr/bin/<span class="built_in">printf</span> <span class="string">"%b"</span> <span class="string">"***** Nagios *****\n\nNotification Type: <span class="variable">$NOTIFICATIONTYPE</span>$\nHost: <span class="variable">$HOSTNAME</span>$\nState: <span class="variable">$HOSTSTATE</span>$\nAddress: <span class="variable">$HOSTADDRESS</span>$\nInfo: <span class="variable">$HOSTOUTPUT</span>$\n\nDate/Time: <span class="variable">$LONGDATETIME</span>$\n"</span> &gt; /usr/<span class="built_in">local</span>/nagios/var/nagios.msg &amp;&amp; /usr/bin/php /usr/<span class="built_in">local</span>/nagios/libexec/weixin/test.php <span class="variable">$CONTACTADDRESS1</span>$  &amp;&gt;/dev/null        </div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">####notify-host-by-weixin        </span></div><div class="line">define <span class="built_in">command</span>&#123;</div><div class="line">                command_name notify-host-by-weixin</div><div class="line">                command_line /usr/bin/<span class="built_in">printf</span> <span class="string">"%b"</span> <span class="string">"***** Nagios *****\n\nNotification Type: <span class="variable">$NOTIFICATIONTYPE</span>$\nHost: <span class="variable">$HOSTNAME</span>$\nState: <span class="variable">$HOSTSTATE</span>$\nAddress: <span class="variable">$HOSTADDRESS</span>$\nInfo: <span class="variable">$HOSTOUTPUT</span>$\n\nDate/Time: <span class="variable">$LONGDATETIME</span>$\n"</span> &gt; /usr/<span class="built_in">local</span>/nagios/var/nagios.msg &amp;&amp; /usr/bin/php /usr/<span class="built_in">local</span>/nagios/libexec/weixin/test.php <span class="variable">$CONTACTADDRESS1</span>$  &amp;&gt;/dev/null        </div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<h3 id="修改联系人选项-contact-cfg"><a href="#修改联系人选项-contact-cfg" class="headerlink" title="修改联系人选项: contact.cfg"></a>修改联系人选项: contact.cfg</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改 /usr/local/nagios/etc/objects/contact.cfg</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在 define contact{…} 部分增加如下一行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">address     11206***<span class="comment">#微信好友ID，登录微信公众平台网页版，在用户管理中点击你要发微信的好友，此时在地址上显示的fakeid就是微信好友的ID。</span></div></pre></td></tr></table></figure>
<h3 id="重载nagios配置"><a href="#重载nagios配置" class="headerlink" title="重载nagios配置"></a>重载nagios配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service nagios reload</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Nagios%E6%95%B4%E5%90%88%E5%BE%AE%E4%BF%A1%E8%AE%A2%E9%98%85%E5%8F%B7%E6%8A%A5%E8%AD%A6/01.png?raw=true" alt=""></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Nagios%E6%95%B4%E5%90%88%E5%BE%AE%E4%BF%A1%E8%AE%A2%E9%98%85%E5%8F%B7%E6%8A%A5%E8%AD%A6/02.png?raw=true" alt=""></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nagios/">Nagios</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Nagios/3. nagios配置邮件告警" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Nagios/3. nagios配置邮件告警/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.828Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Nagios/3. nagios配置邮件告警/">
        nagios配置邮件告警
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;目前 nagios 只能在浏览器上查看各个服务的状态，当某个机器宕掉或者某个服务宕掉时，我们是不知道的，因为我们不可能一直盯着服务器看。这时候，就需要用到警告系统了，让它自动化，当发现问题时及时通知到我们。下面配置使用发邮件的方式来实现告警。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;以下操作都在服务器上完成。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;首先定义发邮件接收者。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nagios ~]<span class="comment"># vim /etc/nagios/objects/contacts.cfg</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;增加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">define contact&#123;</div><div class="line">    contact_name 123</div><div class="line">    use generic-contact</div><div class="line">    <span class="built_in">alias</span> yanyi</div><div class="line">    email 18983111118@189.cn</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">define contact&#123;</div><div class="line">    contact_name 456</div><div class="line">    use generic-contact</div><div class="line">    <span class="built_in">alias</span> aaa</div><div class="line">    email 89429541@qq.com</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">define contactgroup&#123;</div><div class="line">    contactgroup_name common</div><div class="line">    <span class="built_in">alias</span> common</div><div class="line">    members 123,456</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明： contacts.cfg 里面既可以定义 user 也可以定义 group ，先定义两个 user 123 和 456 ，然后把这两个 user 加入到 common 组里面。等会发邮件就发给 common 组就可以了，那这样 18983111118@189.cn 和 89429541@qq.com 都会收到邮件。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后在需要告警的服务里面加上 contactgroup</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nagios ~]<span class="comment"># vim /etc/nagios/conf.d/192.168.0.98.cfg</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;针对 check_load 服务增加告警相关的配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">define service&#123;</div><div class="line">    use generic-service</div><div class="line">    host_name 192.168.0.98</div><div class="line">    service_description check_load</div><div class="line">    check_command check_nrpe!check_load</div><div class="line">    max_check_attempts 5</div><div class="line">    normal_check_interval 1</div><div class="line">    contact_groups common</div><div class="line">    notifications_enabled 1</div><div class="line">    notification_period 24x7</div><div class="line">    notification_options w,u,c,r</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明：notifications_enabled  1  表示是否开启提醒功能。 1 为开启，0 为禁用。一般，这个选项会在主配置文件 （nagios.cfg） 中定义，效果相同。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;notification_period 24×7 表示发送提醒的时间段。非常重要的主机（服务）定义为问题发生，都不会发送提醒。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;notification_options:w,u,c,r 表示 service 的状态。w 为 waning，u 为 unknown，c 为 critical，r 为 recover（恢复了），类似的还有一个 host对应的状态：d,u,r    d 状态为 DOWN，u 状态为 UNREACHABLE，r 状态恢复为 OK，需要加入到 host 的定义配置里。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑完成配置文件后，需要重启 nagios 服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nagios ~]<span class="comment"># service nagios restart</span></div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nagios/">Nagios</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Nagios/2. nagios 监控客户端" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Nagios/2. nagios 监控客户端/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.827Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Nagios/2. nagios 监控客户端/">
        nagios 监控客户端
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在客户端机器阿航安装 epel 扩展源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y epel-release</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;安装 nagios 以及 nagios-plugins</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y nagios-plugins nagios-plugins-all nrpe nagios-plugins-nrpe</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vim /etc/nagios/nrpe.cfg</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;找到 “allowed_hosts=127.0.0.1” 改为 “allowed_hosts=127.0.0.1，192.168.0.62 ” 后面的 ip 为服务端 ip ； 找到 “dont_blame_nrpe=0” 改为 “dont_blam_nrpe=1” </p>
<p><img src="https://github.com/hcldirgit/image/blob/master/nagios%E7%9B%91%E6%8E%A7%E5%AE%A2%E6%88%B7%E7%AB%AF/01.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改为</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/nagios%E7%9B%91%E6%8E%A7%E5%AE%A2%E6%88%B7%E7%AB%AF/02.png?raw=true" alt=""></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/nagios%E7%9B%91%E6%8E%A7%E5%AE%A2%E6%88%B7%E7%AB%AF/03.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改为</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/nagios%E7%9B%91%E6%8E%A7%E5%AE%A2%E6%88%B7%E7%AB%AF/04.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;启动客户端</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/etc/init.d/nrpe start</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;客户端配置好以后，在到服务端继续配置。客户端 ip 为 192.168.0.98，下面定义子配置文件。（以下操作在服务端上完成）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@nagios ~]<span class="comment"># cd /etc/nagios/conf.d/</span></div><div class="line">[root@nagios conf.d]<span class="comment"># vim /192.168.0.98.cfg</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;增加配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">define host&#123;</div><div class="line">    use linux-server</div><div class="line">    host_name 192.168.0.98</div><div class="line">    <span class="built_in">alias</span> 0.98</div><div class="line">    address 192.168.0.98</div><div class="line">&#125;</div><div class="line"></div><div class="line">define service&#123;</div><div class="line">    use generic-service</div><div class="line">    host_name 192.168.0.98</div><div class="line">    service_description check_ping</div><div class="line">    check_command check_ping!100.0,20%!200.0,50%</div><div class="line">    max_check_attempts 5</div><div class="line">    normal_check_interval 1</div><div class="line">&#125;</div><div class="line"></div><div class="line">define service&#123;</div><div class="line">    use generic-service</div><div class="line">    host_name 192.168.0.98</div><div class="line">    service_description check_ssh</div><div class="line">    check_command check_ssh</div><div class="line">    max_check_attempts 5 </div><div class="line">    normal_check_interval 1 </div><div class="line">    notification_interval 60</div><div class="line">&#125;</div><div class="line"></div><div class="line">define service&#123;</div><div class="line">    use generic-service</div><div class="line">    host_name 192.168.0.98</div><div class="line">    service_description check_http</div><div class="line">    check_command check_http</div><div class="line">    max_check_attempts 5</div><div class="line">    normal_check_interval 1</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明：</p>
<ul>
<li>“max_check_attempts  5” ：表示当nagios检测到问题时，一共尝试检测5次都有问题才会告警，如果该数值为1，那么检测到问题立即告警</li>
<li>“normal_check_interval 1”：表示重新检测的时间间隔，单位是分钟，默认是3分钟</li>
<li>“notification_interval 60”：表示在服务出现异常后，故障一直没有解决，nagios再次对使用者发出通知的时间。单位是分钟。如果你认为，所有的事件只需要一次通知就够了，可以把这里的选项设为0。</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;以上服务不依赖于客户端 nrpe 服务，可以想象，在子机电脑上可以使用 ping 或者 telnet 探测远程任何一台机器是否存活、是否开启某个端口或服务。而当想要检测客户端上的某个具体服务的情况时，就需要借助于 nrpe 了，比如想知道客户端机器的负载或磁盘使用情况。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑完成配置文件后，检测配置是否有错</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nagios conf.d]<span class="comment"># nagios -v /etc/nagios/nagios.cfg</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;再服务端重启一下 nagios 服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nagios conf.d]<span class="comment"># service nagios restart</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后在浏览器里访问 nagios ，刷新会发现多出来一台主机，并且多出来三个服务。只不过这三个服务并不是我们想要的，想要监控系统负载，监控磁盘使用率等服务，这时候就要使用 nrpe 服务了。继续在服务端上添加服务。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nagios ~]<span class="comment"># vim /etc/nagios/objects/commands.cfg</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;增加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">define <span class="built_in">command</span>&#123;</div><div class="line">    command_name check_nrpe</div><div class="line">    command_line <span class="variable">$USER1</span>$/check_nrpe -H <span class="variable">$HOSTADDRESS</span>$ -c <span class="variable">$ARG1</span>$</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后继续编辑</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nagios conf.d]<span class="comment"># vim 192.168.0.98.cfg</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;增加内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">define service&#123;</div><div class="line">    use generic-service</div><div class="line">    host_name 192.168.0.98</div><div class="line">    service_description check_load</div><div class="line">    check_command check_nrpe!check_load</div><div class="line">    max_check_attempts 5</div><div class="line">    normal_check_interval 1</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">define service&#123;</div><div class="line">    use generic-service</div><div class="line">    host_name 192.168.0.98</div><div class="line">    service_description check_disk_sda1</div><div class="line">    check_command check_nrpe!check_sda1</div><div class="line">    max_check_attempts 5</div><div class="line">    normal_check_interval 1</div><div class="line">&#125;</div><div class="line"></div><div class="line">define service&#123;</div><div class="line">    use generic-service</div><div class="line">    host_name 192.168.0.98</div><div class="line">    service_description check_disk_sda3</div><div class="line">    check_command check_nrpe!check_sda3</div><div class="line">    max_check_attempts 5</div><div class="line">    normal_check_interval 1</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明：“check_nrpe!check_load” 这里的 check_nrpe 就是在 commands.cfg 刚刚定义的，check_load 是远程主机上的一个检测脚本。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在远程主机上编辑 nrpe.cfg 配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nagios conf.d]<span class="comment"># vim /etc/nagios/nrpe.cfg</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;搜索 check_load ，这行就是在服务器上要执行的脚本了。然后把 check_hda1 更改一下：/dev/hds1 改为 ，/dev/sda1 。</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/nagios%E7%9B%91%E6%8E%A7%E5%AE%A2%E6%88%B7%E7%AB%AF/05.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改为</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/nagios%E7%9B%91%E6%8E%A7%E5%AE%A2%E6%88%B7%E7%AB%AF/06.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;再加一行</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/nagios%E7%9B%91%E6%8E%A7%E5%AE%A2%E6%88%B7%E7%AB%AF/07.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;客户端上重启一下 nrpe 服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@lnmp ~]<span class="comment"># service nrpe restart</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;服务端也重启下 nagios 服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nagios conf.d]<span class="comment"># service nagios restart</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;再到浏览器刷新，会看到又多出来三个服务</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/nagios%E7%9B%91%E6%8E%A7%E5%AE%A2%E6%88%B7%E7%AB%AF/08.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;稍微等一会就可以查看到具体的状态了。</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/nagios%E7%9B%91%E6%8E%A7%E5%AE%A2%E6%88%B7%E7%AB%AF/09.png?raw=true" alt=""></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nagios/">Nagios</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Nagios/1. Nagios 安装" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Nagios/1. Nagios 安装/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.827Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Nagios/1. Nagios 安装/">
        Nagios安装
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<a href="http://nagios.org" target="_blank" rel="external">Nagios官网</a></p>
<h2 id="1-nagios-简介"><a href="#1-nagios-简介" class="headerlink" title="1.nagios 简介"></a>1.nagios 简介</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;nagios 是一个开源软件，可以监控网络设备网络流量、linux/windows 主机状态，甚至可以监控打印机。它可以运行在 linux 上或 windows 上。基于浏览器的 web 界面方便运维人员查看监控项目的状态，支持 web 界面配置、管理操作、支持短信、邮件通知，可以自定义脚本实现自定义化监控。</p>
<h2 id="2-nagios-安装-服务端（192-168-0-62）"><a href="#2-nagios-安装-服务端（192-168-0-62）" class="headerlink" title="2.nagios 安装 - 服务端（192.168.0.62）"></a>2.nagios 安装 - 服务端（192.168.0.62）</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;首先来安装服务器，nagios 同样也是需要 apache + php 的环境，centos 6 默认的 yum 源里没有 nagios 相关的 rpm 包，需要安装一个 epel 的扩展源。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nagios ~]<span class="comment"># yum install -y epel-release</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后安装 nagios 相关的包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nagios ~]<span class="comment"># yum install -y httpd nagios nagios-plugins nagios-plugins-all nrpe nagios-plugins-nrpe</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;设置登录 nagios 后台的用户和密码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@nagios ~]<span class="comment"># htpasswd -c /etc/nagios/passwd nagiosadmin</span></div><div class="line">New password: </div><div class="line">Re-type new password: </div><div class="line">Adding password <span class="keyword">for</span> user nagiosadmin</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;检查配置文件是否有问题</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nagios ~]<span class="comment"># nagios -v /etc/nagios/nagios.cfg</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/nagios%E5%AE%89%E8%A3%85/01.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明配置文件没有问题</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;启动服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@nagios ~]<span class="comment"># service httpd start</span></div><div class="line">[root@nagios ~]<span class="comment"># service nagios start</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;浏览器访问 <a href="http://ip/nagios" target="_blank" rel="external">http://ip/nagios</a></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/nagios%E5%AE%89%E8%A3%85/03.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;输入设置的帐号密码登录</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/nagios%E5%AE%89%E8%A3%85/02.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;此时，nagios 监控的只有 localhost ，还没有其他机器，要想添加监控客户机，还需要在客户端安装 nagios 相关的软件包，并且需要在服务端配置。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nagios/">Nagios</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-MySQL/9. mysql的root密码重置" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/MySQL/9. mysql的root密码重置/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.824Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/MySQL/9. mysql的root密码重置/">
        mysql的root密码重置
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="mysql设置密码"><a href="#mysql设置密码" class="headerlink" title="mysql设置密码"></a>mysql设置密码</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@lamp ~]<span class="comment"># mysqladmin -uroot password 'yanyi'</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注意：如果mysql已经有密码，该命令要加上 -p</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@lamp ~]<span class="comment"># mysqladmin -uroot -pyanyi password '123456'</span></div></pre></td></tr></table></figure>
<h2 id="碰到mysql-root密码忘记该如何做呢？"><a href="#碰到mysql-root密码忘记该如何做呢？" class="headerlink" title="碰到mysql root密码忘记该如何做呢？"></a>碰到mysql root密码忘记该如何做呢？</h2><h3 id="1-编辑mysql主配置文件my-cnf"><a href="#1-编辑mysql主配置文件my-cnf" class="headerlink" title="1.编辑mysql主配置文件my.cnf"></a>1.编辑mysql主配置文件my.cnf</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@lamp ~]<span class="comment"># vim /etc/my.cnf</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在 [mysql] 字段下添加参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">skip-grant</div></pre></td></tr></table></figure>
<h3 id="2-重启数据库服务"><a href="#2-重启数据库服务" class="headerlink" title="2.重启数据库服务"></a>2.重启数据库服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@lamp ~]<span class="comment"># service mysqld restart</span></div></pre></td></tr></table></figure>
<h3 id="3-进入mysql数据库（此时数据库不用授权）"><a href="#3-进入mysql数据库（此时数据库不用授权）" class="headerlink" title="3.进入mysql数据库（此时数据库不用授权）"></a>3.进入mysql数据库（此时数据库不用授权）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@lamp ~]<span class="comment"># /usr/local/mysql/bin/mysql -uroot</span></div></pre></td></tr></table></figure>
<h3 id="4-修改相应的用户密码"><a href="#4-修改相应的用户密码" class="headerlink" title="4.修改相应的用户密码"></a>4.修改相应的用户密码</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;使用mysql库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; use mysql;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;更新一个表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mysql&gt; update user <span class="built_in">set</span> password=password(<span class="string">'yanyi'</span>) <span class="built_in">where</span> user=<span class="string">'root'</span>;</div><div class="line">mysql&gt; select * from user <span class="built_in">where</span> user=<span class="string">'root'</span>\G;</div><div class="line">mysql&gt; flush privileges;</div><div class="line">mysql&gt; quit;</div></pre></td></tr></table></figure>
<h3 id="5-修改-etc-my-cnf去掉skip-grant，重启mysql服务"><a href="#5-修改-etc-my-cnf去掉skip-grant，重启mysql服务" class="headerlink" title="5.修改/etc/my.cnf去掉skip-grant，重启mysql服务"></a>5.修改/etc/my.cnf去掉skip-grant，重启mysql服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@lamp ~]<span class="comment"># vim /etc/my.cnf</span></div><div class="line">[root@lamp ~]<span class="comment"># service mysqld restart</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这样就可以用新密码登录了</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/mysql%E7%9A%84root%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE/01.png?raw=true" alt=""></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-MySQL/8. 关于mysql一些优化心得" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/MySQL/8. 关于mysql一些优化心得/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.821Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/MySQL/8. 关于mysql一些优化心得/">
        关于mysql一些优化心得
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>先介绍下服务器架构及配置8核8G，10M带宽Centos6.5 64</strong></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>Nginx&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;1.8.1PHP   &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;5.3.29Mysql&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;5.5.42</strong></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;一电商网站后台查询订单时 经常php超时，导致php报错以下是排查过程</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;一、php执行超时，首先我们想到的就是php.ini文件中max_execution_time =  #把默认的值调整了下</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;二、然后在后台执行订单查询php不报错了，但是查询耗时较长，用时65s.  而且一些表成锁死状态碎片比较多，本人对mysql数据库优化不是很了解，于是百度了一下：一般mysql调优主要是根据慢查询日志去优化sql语句，my.cnf里面没啥可调的。 下面就是分析mysql慢日志,调整参数3、mysql参数优化，主要调整的参数如下。根据机器性能来调整，如果你对参数不是很了解，建议不要盲目的调</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;把一些配置文件修改好后重启相关服务，由原来的65s变成了十几秒。效果还是不是很理想，查看了下mysql默认引擎为MyISAM，决定把引擎改为Innodb</p>
<ol>
<li>导出shop数据库的表结构</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysqldump -d -uxxx -p shop &gt; shop_table.sql</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;其中-d参数表示不导出数据，只导出表结构</p>
<ol>
<li>替换shop_table.sql里的MyISAM为INNODB</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sed -i <span class="string">'s/MyISAM/INNODB/g'</span> shop_table.sql</div></pre></td></tr></table></figure>
<ol>
<li>新建数据库shop_new,并导入表结构</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql &gt; create database shop_new;mysql -uroot -p shop_new &lt; shop_table.sql</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;可以通过show table status来检查表引擎是否为INNODB。</p>
<ol>
<li>导出shop的数据</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysqldump -t -uroot -p shop &gt; shop_data.sql</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;其中-t参数表示只导数据，不导表结构</p>
<ol>
<li>导入数据到</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shop_newmysql -uroot -p shop_new &lt; shop_data.sql</div></pre></td></tr></table></figure>
<ol>
<li>首先开启慢日志，修改/etc/my.cnf  增加以下两段配置，保存重启mysql</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">vim /etc/my.cnf</div><div class="line"></div><div class="line">long_query_time = 2</div><div class="line">log_slow_queries = /data/mysql/slow.log</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;重启mysql服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service mysqld restart</div></pre></td></tr></table></figure>
<ol>
<li>查看慢日志来定位mysql哪条语句执行慢，然后建立索引，优化sql执行语句。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;font color=<span class="string">"Red"</span>&gt;tail -n20 /data/mysql/slow.log <span class="comment">#查看20行&lt;/font&gt;</span></div><div class="line"> </div><div class="line"> </div><div class="line"> <span class="comment"># Time: 160303 12:12:38</span></div><div class="line"> <span class="comment"># User@Host: root[root] @ [10.165.34.182]</span></div><div class="line"> <span class="comment"># Query_time: 10.145685 Lock_time: 0.000395 Rows_sent: 1 Rows_examined: 24306970</span></div><div class="line"> use shop;</div><div class="line">SET timestamp=1456978358;</div><div class="line"> SELECT COUNT(*) FROM `shop`.`ecs_order_info` o LEFT JOIN`shop`.`ecs_users` u ON o.user_id = u.user_id LEFT JOIN `shop`.`ecs_affiliate_log` a ON o.order_id = a.order_id WHERE o.user_id &gt; 0 AND (u.parent_id &gt; 0 AND o.is_separate = 0 OR o.is_separate &gt; 0);</div><div class="line"> <span class="comment"># Time: 160303 12:12:44</span></div><div class="line"> <span class="comment"># User@Host: root[root] @ [10.165.34.182]</span></div><div class="line"> <span class="comment"># Query_time: 6.073441 Lock_time: 0.000152 Rows_sent: 15 Rows_examined: 24314767</span></div><div class="line">SET timestamp=1456978364;</div><div class="line">SELECT o.*, a.log_id, a.user_id as suid, a.user_name as auser, a.money, a.point, a.separate_type,u.parent_id as up FROM `shop`.`ecs_order_info` o LEFT JOIN`shop`.`ecs_users` u ON o.user_id = u.user_id LEFT JOIN `shop`.`ecs_affiliate_log` a ON o.order_id = a.order_id WHERE o.user_id &gt; 0 AND (u.parent_id &gt; 0 AND o.is_separate = 0 OR o.is_separate &gt; 0) ORDER BY order_id DESC LIMIT 0,15;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;通过慢日志发现其中有几个表查询耗时较长，下面就是把这个查询慢的表建立索引</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;用到的软件 NAvicat，对查询慢的表进行设计，增加索引</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E5%85%B3%E4%BA%8Emysql%E4%B8%80%E4%BA%9B%E4%BC%98%E5%8C%96%E5%BF%83%E5%BE%97/01.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;根据 explain 的解释，查看下索引是否建立，一般都是这样调整就行。</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E5%85%B3%E4%BA%8Emysql%E4%B8%80%E4%BA%9B%E4%BC%98%E5%8C%96%E5%BF%83%E5%BE%97/02.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改完后重启 mysql 服务，查询时间从65s,缩短到 0.017407 秒</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E5%85%B3%E4%BA%8Emysql%E4%B8%80%E4%BA%9B%E4%BC%98%E5%8C%96%E5%BF%83%E5%BE%97/03.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;参考了大量的网络资料，头一次搞优化。优化完后很有成就感，算是一次新的挑战</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/16/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="page-number" href="/page/16/">16</a><span class="page-number current">17</span><a class="page-number" href="/page/18/">18</a><a class="page-number" href="/page/19/">19</a><span class="space">&hellip;</span><a class="page-number" href="/page/63/">63</a><a class="extend next" rel="next" href="/page/18/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2017 失落的乐章
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/smackgg/hexo-theme-smackdown" target="_blank">Smackdown</a>
        </div>
    </div>
  </div>
</footer>
    </div>
    

<script>
	var yiliaConfig = {
		fancybox: ,
		mathjax: ,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="/js/main.js"></script>



  </div>
</body>
</html>