<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>失落的乐章</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="失落的乐章的Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="失落的乐章">
<meta property="og:url" content="https://hcldirgit.github.io/page/17/index.html">
<meta property="og:site_name" content="失落的乐章">
<meta property="og:description" content="失落的乐章的Blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="失落的乐章">
<meta name="twitter:description" content="失落的乐章的Blog">
  
    <link rel="alternative" href="/atom.xml" title="失落的乐章" type="application/atom+xml">
  
  
    <link rel="icon" href="https://github.com/hcldirgit/image/blob/master/0.png?raw=true">
  
  <link rel="stylesheet" href="/css/style.css">
  
  
<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-85415703-1', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  <script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>
  <script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>

  
</head>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://github.com/hcldirgit/image/blob/master/0.png?raw=true" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">失落的乐章</a></h1>
		</hgroup>

		
		<p class="header-subtitle">技术面前，永远都是学生。</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Ansible/" style="font-size: 10.42px;">Ansible</a> <a href="/tags/Apache/" style="font-size: 18.33px;">Apache</a> <a href="/tags/Cacti/" style="font-size: 11.67px;">Cacti</a> <a href="/tags/DNS/" style="font-size: 13.33px;">DNS</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/FTP/" style="font-size: 11.25px;">FTP</a> <a href="/tags/Git/" style="font-size: 10.83px;">Git</a> <a href="/tags/HA集群/" style="font-size: 11.67px;">HA集群</a> <a href="/tags/Hadoop/" style="font-size: 12.5px;">Hadoop</a> <a href="/tags/Jenkins/" style="font-size: 10.42px;">Jenkins</a> <a href="/tags/LAMP/" style="font-size: 19.58px;">LAMP</a> <a href="/tags/LNMP/" style="font-size: 17.08px;">LNMP</a> <a href="/tags/LVS/" style="font-size: 16.67px;">LVS</a> <a href="/tags/Linux/" style="font-size: 19.17px;">Linux</a> <a href="/tags/Linux命令/" style="font-size: 20px;">Linux命令</a> <a href="/tags/Linux安全/" style="font-size: 14.17px;">Linux安全</a> <a href="/tags/Memcached/" style="font-size: 11.25px;">Memcached</a> <a href="/tags/MongoDB/" style="font-size: 15.42px;">MongoDB</a> <a href="/tags/MySQL/" style="font-size: 17.5px;">MySQL</a> <a href="/tags/NFS/" style="font-size: 10px;">NFS</a> <a href="/tags/Nagios/" style="font-size: 11.67px;">Nagios</a> <a href="/tags/Nginx/" style="font-size: 17.92px;">Nginx</a> <a href="/tags/OpenStack/" style="font-size: 11.25px;">OpenStack</a> <a href="/tags/Php/" style="font-size: 14.58px;">Php</a> <a href="/tags/Puppet/" style="font-size: 11.25px;">Puppet</a> <a href="/tags/Python/" style="font-size: 14.58px;">Python</a> <a href="/tags/Redis/" style="font-size: 16.25px;">Redis</a> <a href="/tags/Resin/" style="font-size: 10px;">Resin</a> <a href="/tags/Saltstack/" style="font-size: 10px;">Saltstack</a> <a href="/tags/Samba/" style="font-size: 12.08px;">Samba</a> <a href="/tags/Squid/" style="font-size: 14.58px;">Squid</a> <a href="/tags/Tomcat/" style="font-size: 13.75px;">Tomcat</a> <a href="/tags/Zabbix/" style="font-size: 15.83px;">Zabbix</a> <a href="/tags/haproxy/" style="font-size: 12.5px;">haproxy</a> <a href="/tags/keepalived/" style="font-size: 12.92px;">keepalived</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/shell练习/" style="font-size: 18.75px;">shell练习</a> <a href="/tags/正则表达式/" style="font-size: 12.92px;">正则表达式</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">失落的乐章</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="https://github.com/hcldirgit/image/blob/master/0.png?raw=true" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">失落的乐章</h1>
			</hgroup>
			
			<p class="header-subtitle">技术面前，永远都是学生。</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-OpenStack/1. 云计算 OpenStack" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/OpenStack/1. 云计算 OpenStack/" class="article-date">
  	<time datetime="2017-09-02T18:09:22.855Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/OpenStack/1. 云计算 OpenStack/">
        云计算 OpenStack
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-云计算概述"><a href="#1-云计算概述" class="headerlink" title="1.云计算概述"></a>1.云计算概述</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;云计算是一个资源池，它为我们提供了诸如水、电、煤气一样的基础服务。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;云计算是一种按使用量付费的模式，这种模式可以快速、高效地提供网络，服务器，存储，应用软件，服务等，我们不必关心如何实现，所以只需投入很少的管理工作，只需和服务供应商进行很少的交互。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;云计算从广义上可以分为如下几种模式：IaaS（基础设施即服务）、PaaS（平台即服务）、SaaS（软件即服务）</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;IaaS Amazon、阿里云、腾讯云提供的云主机即IaaS，我们拿到的是一台机器，可以自定义操作系统。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;PaaS 面向开发者，直接给用户提供一个平台来运行用户的程序，早期的idc服务商卖的主机、新浪的sae、阿里云的云数据库等。<br>    SaaS 卖的是服务，比如腾讯企业邮箱、印象笔记等</p>
<h2 id="2-openstack-简介"><a href="#2-openstack-简介" class="headerlink" title="2.openstack 简介"></a>2.openstack 简介</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;openstack是目前比较流行的一个实现云计算平台的项目，<a href="https://www.openstack.org/" target="_blank" rel="external">官网</a></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;由NASA（美国国家航空航天局）和Rackspace合作研发并发起的，以Apache许可证授权的自由软件和开放源代码项目，用python语言开发，可以实现私有云或者公有云</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;主要有三个最基础组件：计算服务、网络服务、存储服务</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/01.png?raw=true" alt="01"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;发布版本  <a href="http://releases.openstack.org/，目前稳定版本为Liberty" target="_blank" rel="external">http://releases.openstack.org/，目前稳定版本为Liberty</a></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;6个核心服务：nova（计算中心，对比阿里云的ESC，支持kvm,xen等虚拟化技术）、keystone（认证中心）、neutron（网络服务中心）、swift（对象存储服务，存储图片，附件等文件，对比腾讯云的COS）、cinder（块存储服务，云盘）、glance（镜像管理中心）</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/02.png?raw=true" alt="02"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;openstack其他可选组件：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/03.png?raw=true" alt="03"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;实验环境：至少两台机器。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Controller Node: 1 processor, 2 GB memory, and 5 GB storage</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Compute Node: 1 processor, 2 GB memory, and 10 GB storage</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;生产环境硬件要求：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/04.png?raw=true" alt="04"></p>
<h2 id="3-前期准备"><a href="#3-前期准备" class="headerlink" title="3.前期准备"></a>3.前期准备</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在RHEL7/CentOS7上安装openstack  liberty</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<a href="http://docs.openstack.org/liberty/install-guide-rdo/" target="_blank" rel="external">官方文档</a></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;两台虚拟机，安装centos7系统（准备两个网卡，一个NAT，另一个仅主机）</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;nat网卡设置ip，可以联网，仅主机的网卡只要我们windows可以通就行，主要是用远程连接工具远程连接的，如果登录很慢。则修改</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># vim /etc/ssh/sshd_config</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/05.png?raw=true" alt="05"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改为</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/06.png?raw=true" alt="06"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;重启设置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># systemctl restart sshd</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;关闭selinux</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># setenforce 0 </span></div><div class="line">[root@controller ~]<span class="comment"># vim /etc/selinux/config</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;关闭iptables</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># systemctl stop firewalld</span></div><div class="line">[root@controller ~]<span class="comment"># systemctl disable firewalld</span></div><div class="line">Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.</div><div class="line">Removed symlink /etc/systemd/system/basic.target.wants/firewalld.service.</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;关闭NetworkManager</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># systemctl stop NetworkManager</span></div><div class="line">[root@controller ~]<span class="comment"># systemctl disable NetworkManager</span></div><div class="line">Removed symlink /etc/systemd/system/multi-user.target.wants/NetworkManager.service.</div><div class="line">Removed symlink /etc/systemd/system/dbus-org.freedesktop.NetworkManager.service.</div><div class="line">Removed symlink /etc/systemd/system/dbus-org.freedesktop.nm-dispatcher.service.</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;centos7 配置iptables <a href="https://hcldirgit.github.io/2017/08/19/1.%20Linux%20%E5%9F%BA%E7%A1%80/69.%20CentOS%207%20%E4%B8%8B%E4%BD%BF%E7%94%A8iptables/">CentOS 7 下使用iptables</a></p>
<h3 id="定义密码"><a href="#定义密码" class="headerlink" title="定义密码"></a>定义密码</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在部署openstack过程中会在多个地方使用到密码，为了方便管理和安全设置，我们需要提前先定义好密码，使用命令mkpasswd -s 0生成随机字符串，没有 mkpasswd先安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># yum install -y expect</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">Database password (no variable used) Root password <span class="keyword">for</span> the database tn1Pi6Ytm</div><div class="line">ADMIN_PASS        Password of user admin 3qiVpzU2x</div><div class="line">CEILOMETER_DBPASS Database password <span class="keyword">for</span> the Telemetry service Czn3bF1hm</div><div class="line">CEILOMETER_PASS  Password of Telemetry service user ceilometer abquh12GU</div><div class="line">CINDER_DBPASS    Database password <span class="keyword">for</span> the Block Storage service O3bwbpoZ3</div><div class="line">CINDER_PASS      Password of Block Storage service user cinder hf8LX9bow</div><div class="line">DASH_DBPASS      Database password <span class="keyword">for</span> the dashboard 5qBZxnn1g</div><div class="line">DEMO_PASS        Password of user demo 9TtbgaA1q</div><div class="line">GLANCE_DBPASS    Database password <span class="keyword">for</span> Image service Zznky4tP0</div><div class="line">GLANCE_PASS      Password of Image service user glance Wuyaf4cV6</div><div class="line">HEAT_DBPASS      Database password <span class="keyword">for</span> the Orchestration service b7Fk5wjLg</div><div class="line">HEAT_DOMAIN_PASS Password of Orchestration domain 7Gotb3eoH</div><div class="line">HEAT_PASS        Password of Orchestration service user heat eqQ2jLgz0</div><div class="line">KEYSTONE_DBPASS  Database password of Identity service f6zx0gURv</div><div class="line">NEUTRON_DBPASS   Database password <span class="keyword">for</span> the Networking service quidyOC50</div><div class="line">NEUTRON_PASS     Password of Networking service user neutron mdcGVl29i</div><div class="line">NOVA_DBPASS      Database password <span class="keyword">for</span> Compute service RYgv0rg7p</div><div class="line">NOVA_PASS        Password of Compute service user nova hsSNsqc43</div><div class="line">RABBIT_PASS      Password of user guest of RabbitMQ o3NXovnz5</div><div class="line">SWIFT_PASS       Password of Object Storage service user swift 6ci5xWOdk</div><div class="line">METADATA_SECRET  m8uhmQTu2</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;两台机器，设置hostname</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># vim /etc/hostname</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;两台机器分别修改为 controller、compute。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hostnamectl <span class="built_in">set</span>-hostname controller</div><div class="line">hostnamectl <span class="built_in">set</span>-hostname compute</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑/etc/hosts：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># vim /etc/hosts</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;添加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">192.168.1.99 controller</div><div class="line">192.168.1.98 compute</div></pre></td></tr></table></figure>
<h3 id="controller上："><a href="#controller上：" class="headerlink" title="controller上："></a>controller上：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># yum install -y chrony</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># vim /etc/chrony.conf</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;增加或更改：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">allow 192.168.1.0/24</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/07.png?raw=true" alt="07"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;保存后，执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># systemctl enable chronyd.service</span></div><div class="line">[root@controller ~]<span class="comment"># systemctl start chronyd.service</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;查看是否启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># ps aux |grep chrony</span></div><div class="line">chrony 26153 0.0 0.0 100636 1540 ? S 13:45 0:00 /usr/sbin/chronyd</div><div class="line">root 26359 0.0 0.0 112664 972 pts/0 S+ 14:18 0:00 grep --color=auto chrony</div></pre></td></tr></table></figure>
<h3 id="compute上："><a href="#compute上：" class="headerlink" title="compute上："></a>compute上：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># yum install -y chrony</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># vim /etc/chrony.conf</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;增加或更改： </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">server controller iburst</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/08.png?raw=true" alt="08"></p>
<p>改为</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/09.png?raw=true" alt="09"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;保存后，执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># systemctl enable chronyd.service</span></div><div class="line">[root@compute ~]<span class="comment"># systemctl start chronyd.service</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;同样查看是否启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># ps aux |grep chrony</span></div><div class="line">chrony 25948 0.0 0.0 100636 1540 ? S 14:20 0:00 /usr/sbin/chronyd</div><div class="line">root 26009 0.0 0.0 112664 972 pts/0 R+ 14:28 0:00 grep --color=auto chrony</div></pre></td></tr></table></figure>
<h2 id="4-配置-yum-和更新"><a href="#4-配置-yum-和更新" class="headerlink" title="4.配置 yum 和更新"></a>4.配置 yum 和更新</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;安装openstack的yum源（两个机器上都操作）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># yum install -y centos-release-openstack-liberty</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;升级所有的包（两个机器上都操作）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># yum upgrade</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;结束后重启系统</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;安装openstack 客户端和openstack-selinux</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># yum install -y python-openstackclient openstack-selinux</span></div></pre></td></tr></table></figure>
<h2 id="5-安装-sql-和-rabiitmq-服务"><a href="#5-安装-sql-和-rabiitmq-服务" class="headerlink" title="5.安装 sql 和  rabiitmq 服务"></a>5.安装 sql 和  rabiitmq 服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># yum install -y mariadb mariadb-server MySQL-python</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑配置文件 vim /etc/my.cnf.d/mariadb_openstack.cnf  加入下面内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># vim /etc/my.cnf.d/mariadb_openstack.cnf</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[mysqld]</div><div class="line"><span class="built_in">bind</span>-address = 192.168.1.99</div><div class="line">default-storage-engine = innodb</div><div class="line">innodb_file_per_table</div><div class="line">collation-server = utf8_general_ci</div><div class="line">init-connect = <span class="string">'SET NAMES utf8'</span></div><div class="line">character-set-server = utf8</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;启动mariadb：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># systemctl enable mariadb.service</span></div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/mariadb.service to /usr/lib/systemd/system/mariadb.service.</div><div class="line">[root@controller ~]<span class="comment"># systemctl start mariadb.service</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;安全配置，设置root密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># mysql_secure_installation</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;设置root密码为 tn1Pi6Ytm</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;测试密码是否正常登录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># mysql -uroot -ptn1Pi6Ytm</span></div><div class="line">Welcome to the MariaDB monitor. Commands end with ; or \g.</div><div class="line">Your MariaDB connection id is 10</div><div class="line">Server version: 10.1.18-MariaDB MariaDB Server</div><div class="line"></div><div class="line">Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others.</div><div class="line"></div><div class="line">Type <span class="string">'help;'</span> or <span class="string">'\h'</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">'\c'</span> to clear the current input statement.</div><div class="line"></div><div class="line">MariaDB [(none)]&gt;</div></pre></td></tr></table></figure>
<h3 id="安装-nosql"><a href="#安装-nosql" class="headerlink" title="安装 nosql"></a>安装 nosql</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;nosql数据库被Telemetry service用到</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在这里我们安装的是mongodb</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># yum install -y mongodb-server mongodb</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># vim /etc/mongod.conf</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;更改如下配置 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">bind_ip = 192.168.16.111</div><div class="line">smallfiles = <span class="literal">true</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/10.png?raw=true" alt="10"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;改为 </p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/11.png?raw=true" alt="11"></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/12.png?raw=true" alt="12"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;改为</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/13.png?raw=true" alt="13"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;启动服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># systemctl enable mongod.service</span></div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/mongod.service to /usr/lib/systemd/system/mongod.service.</div><div class="line">[root@controller ~]<span class="comment"># systemctl start mongod.service</span></div></pre></td></tr></table></figure>
<h3 id="安装消息列队（controller）"><a href="#安装消息列队（controller）" class="headerlink" title="安装消息列队（controller）"></a>安装消息列队（controller）</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;rabbitmq消息队列服务在openstack中起到非常关键的作用，它好比是一个交通枢纽，各个组件之间的通信由它来完成。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># yum install -y rabbitmq-server</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;启动rabbitmq-server服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># systemctl enable rabbitmq-server</span></div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/rabbitmq-server.service to /usr/lib/systemd/system/rabbitmq-server.service.</div><div class="line">[root@controller ~]<span class="comment"># systemctl start rabbitmq-server</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;添加openstack用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># rabbitmqctl add_user openstack o3NXovnz5 </span></div><div class="line">Creating user <span class="string">"openstack"</span> ...</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;密码 o3NXovnz5   用户名为openstack</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;为openstack用户授权</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># rabbitmqctl set_permissions openstack ".*" ".*" ".*"</span></div><div class="line">Setting permissions <span class="keyword">for</span> user <span class="string">"openstack"</span> <span class="keyword">in</span> vhost <span class="string">"/"</span> ...</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;允许openstack用户可以配置，可以写，可以读</p>
<h2 id="6-增加identity-keystone介绍-controller"><a href="#6-增加identity-keystone介绍-controller" class="headerlink" title="6.增加identity - keystone介绍(controller)"></a>6.增加identity - keystone介绍(controller)</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;identity即keystone，它是openstack的验证中心，所有的服务都由它来认证。参考 <a href="https://hcldirgit.github.io/2017/08/19/OpenStack/3.%20keystone%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E4%B8%8E%E5%8A%9F%E8%83%BD/">openstack keystone整体架构与功能</a></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在keyston中有以下角色：tenants(租户或项目)、用户、角色、服务目录和端点</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;如果把宾馆比作为Tenant，住宿的人就是User ，宾馆可以提供多种诸如住宿、娱乐、饮食等多种服务（Service），具体来说，住宿是一种具体的服务（Endpoint）。就住宿而言，有普通间和总统套房，如果你的VIP等级（Role）高，你可以享受到豪华的总统套房。入住前，我们需要拿身份证开房（Credential），认证身份证不是冒牌货后  （Authenticaiton），会给你一个房卡（Token），然后你拿着房卡，就可以进入房间和享受各种服务。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;以创建一个虚拟机（server）为例，keystone在openstack的访问流程大致如下：</p>
<p>1). 用户Alice通过自己的户名和密码向keystone申请token，keystone认证用户名和密码后，返回token1</p>
<p>2). Alice通过token1发送keystone查询他所拥有的租户，keystone验证token1成功后，返回Alice的所有Tenant</p>
<p>3). Alice选择一个租户，通过用户名和密码申请token，keystone认证用户名、密码、tenant后，返回token2。（其实1、2步仅仅是为了查询tenant，如果已经知道tenant，可以忽略1、2步）</p>
<p>4). Alice通过token2发送创建server的请求，keystone验证token2(包括该token是否有效，是否有权限创建虚拟机等)成功后，然后再把请求下发到nova，最终创建虚拟机</p>
<h2 id="7-增加identity-前期准备-controller"><a href="#7-增加identity-前期准备-controller" class="headerlink" title="7.增加identity - 前期准备(controller)"></a>7.增加identity - 前期准备(controller)</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;登陆mysql，创建数据库 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># mysql -uroot -ptn1Pi6Ytm</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">MariaDB [(none)]&gt; create database keystone;</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line"> </div><div class="line">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON keystone.* TO <span class="string">'keystone'</span>@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'f6zx0gURv'</span>;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"> </div><div class="line">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON keystone.* TO <span class="string">'keystone'</span>@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'f6zx0gURv'</span>; </div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明，创建一个keystone库，并且授权给keystone用户所有权限，密码为f6zx0gURv</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;安装相关的包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># yum install -y openstack-keystone httpd mod_wsgi memcached python-memcached</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;启动memcached服务 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># systemctl enable memcached.service</span></div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/memcached.service to /usr/lib/systemd/system/memcached.service.</div><div class="line">[root@controller ~]<span class="comment"># systemctl start memcached.service</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑keystone配置文件 /etc/keystone/keystone.conf 修改或增加配置如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># vim /etc/keystone/keystone.conf</span></div><div class="line">``` </div><div class="line"></div><div class="line">```bash</div><div class="line">[DEFAULT]</div><div class="line">admin_token = 3qiVpzU2x</div><div class="line">verbose = <span class="literal">true</span></div><div class="line">[database]</div><div class="line">connection = mysql://keystone:f6zx0gURv@controller/keystone</div><div class="line">[memcache]</div><div class="line">servers = localhost:11211</div><div class="line">[token]</div><div class="line">provider = uuid</div><div class="line">driver = memcache</div><div class="line">[revoke]</div><div class="line">driver = sql</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/14.png?raw=true" alt="14"></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/15.png?raw=true" alt="15"></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/16.png?raw=true" alt="16"></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/17.png?raw=true" alt="17"></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/18.png?raw=true" alt="18"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;导入keystone相关的数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># su -s /bin/sh -c "keystone-manage db_sync" keystone</span></div><div class="line">No handlers could be found <span class="keyword">for</span> logger <span class="string">"oslo_config.cfg"</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这里会有个提示  No handlers could be found for logger “oslo_config.cfg”  忽略它，不影响</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;检查有没有正常导入数据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># mysql -uroot -ptn1Pi6Ytm</span></div><div class="line">MariaDB [(none)]&gt; use keystone;</div><div class="line">Reading table information <span class="keyword">for</span> completion of table and column names</div><div class="line">You can turn off this feature to get a quicker startup with -A</div><div class="line"></div><div class="line">Database changed</div><div class="line">MariaDB [keystone]&gt; show tables;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;或者</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># mysql -ukeystone -pf6zx0gURv -hcontroller -t keystone -e "show tables"</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;看是否有列出表来，如果是空，说明没有成功导入数据</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;配置apache</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;先编辑配置文件 /etc/httpd/conf/httpd.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># vim /etc/httpd/conf/httpd.conf</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;增加或更改 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ServerName controller</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/19.png?raw=true" alt="19"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑配置文件  vim /etc/httpd/conf.d/wsgi-keystone.conf  内容如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># vim /etc/httpd/conf.d/wsgi-keystone.conf</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"> Listen 5000</div><div class="line"> Listen 35357</div><div class="line"> &lt;VirtualHost *:5000&gt;</div><div class="line"> WSGIDaemonProcess keystone-public processes=5 threads=1 user=keystone group=keystone display-name=%&#123;GROUP&#125;</div><div class="line"> WSGIProcessGroup keystone-public</div><div class="line"> WSGIScriptAlias / /usr/bin/keystone-wsgi-public</div><div class="line"> WSGIApplicationGroup %&#123;GLOBAL&#125;</div><div class="line"> WSGIPassAuthorization On</div><div class="line"> &lt;IfVersion &gt;= 2.4&gt;</div><div class="line"> ErrorLogFormat <span class="string">"%&#123;cu&#125;t %M"</span></div><div class="line"> &lt;/IfVersion&gt;</div><div class="line"> ErrorLog /var/<span class="built_in">log</span>/httpd/keystone-error.log</div><div class="line"> CustomLog /var/<span class="built_in">log</span>/httpd/keystone-access.log combined</div><div class="line"> &lt;Directory /usr/bin&gt;</div><div class="line"> &lt;IfVersion &gt;= 2.4&gt;</div><div class="line"> Require all granted</div><div class="line"> &lt;/IfVersion&gt;</div><div class="line"> &lt;IfVersion &lt; 2.4&gt;</div><div class="line"> Order allow,deny</div><div class="line"> Allow from all</div><div class="line"> &lt;/IfVersion&gt;</div><div class="line"> &lt;/Directory&gt;</div><div class="line"> &lt;/VirtualHost&gt;</div><div class="line"> &lt;VirtualHost *:35357&gt;</div><div class="line"> WSGIDaemonProcess keystone-admin processes=5 threads=1 user=keystone group=keystone display-name=%&#123;GROUP&#125;</div><div class="line"> WSGIProcessGroup keystone-admin</div><div class="line"> WSGIScriptAlias / /usr/bin/keystone-wsgi-admin</div><div class="line"> WSGIApplicationGroup %&#123;GLOBAL&#125;</div><div class="line"> WSGIPassAuthorization On</div><div class="line"> &lt;IfVersion &gt;= 2.4&gt;</div><div class="line"> ErrorLogFormat <span class="string">"%&#123;cu&#125;t %M"</span></div><div class="line"> &lt;/IfVersion&gt;</div><div class="line"> ErrorLog /var/<span class="built_in">log</span>/httpd/keystone-error.log</div><div class="line">CustomLog /var/<span class="built_in">log</span>/httpd/keystone-access.log combined</div><div class="line"> &lt;Directory /usr/bin&gt;</div><div class="line"> &lt;IfVersion &gt;= 2.4&gt;</div><div class="line"> Require all granted</div><div class="line"> &lt;/IfVersion&gt;</div><div class="line"> &lt;IfVersion &lt; 2.4&gt;</div><div class="line"> Order allow,deny</div><div class="line"> Allow from all</div><div class="line"> &lt;/IfVersion&gt;</div><div class="line"> &lt;/Directory&gt;</div><div class="line"> &lt;/VirtualHost</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;启动apache</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># systemctl enable httpd.service</span></div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/httpd.service to /usr/lib/systemd/system/httpd.service.</div><div class="line">[root@controller ~]<span class="comment"># systemctl start httpd.service</span></div></pre></td></tr></table></figure>
<h2 id="8-增加identity-创建服务实例-controller"><a href="#8-增加identity-创建服务实例-controller" class="headerlink" title="8.增加identity - 创建服务实例(controller)"></a>8.增加identity - 创建服务实例(controller)</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;首先设置环境变量：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># export OS_TOKEN=3qiVpzU2x</span></div><div class="line">[root@controller ~]<span class="comment"># export OS_URL=http://controller:35357/v3</span></div><div class="line">[root@controller ~]<span class="comment"># export OS_IDENTITY_API_VERSION=3</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># echo $OS_TOKEN</span></div><div class="line">3qiVpzU2x</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;成功之后可以用命令查看密码</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后创建服务实例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack service create --name keystone --description "OpenStack Identity" identity</span></div><div class="line">+-------------+----------------------------------+</div><div class="line">| Field       | Value                            |</div><div class="line">+-------------+----------------------------------+</div><div class="line">| description | OpenStack Identity               |</div><div class="line">| enabled     | True                             |</div><div class="line">| id          | 798a1feefccb4e8d817fa96aa44bb26e |</div><div class="line">| name        | keystone                         |</div><div class="line">| <span class="built_in">type</span>        | identity                         |</div><div class="line">+-------------+----------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建端点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack endpoint create --region RegionOne identity public http://controller:5000/v2.0</span></div><div class="line">+--------------+----------------------------------+</div><div class="line">| Field        | Value                            |</div><div class="line">+--------------+----------------------------------+</div><div class="line">| enabled      | True                             |</div><div class="line">| id           | 3d6e544e7e3e4844aef5c699e4841771 |</div><div class="line">| interface    | public                           |</div><div class="line">| region       | RegionOne                        |</div><div class="line">| region_id    | RegionOne                        |</div><div class="line">| service_id   | 798a1feefccb4e8d817fa96aa44bb26e |</div><div class="line">| service_name | keystone                         |</div><div class="line">| service_type | identity                         |</div><div class="line">| url          | http://controller:5000/v2.0      |</div><div class="line">+--------------+----------------------------------+</div><div class="line">[root@controller ~]<span class="comment"># openstack endpoint create --region RegionOne identity internal http://controller:5000/v2.0</span></div><div class="line">+--------------+----------------------------------+</div><div class="line">| Field        | Value                            |</div><div class="line">+--------------+----------------------------------+</div><div class="line">| enabled      | True                             |</div><div class="line">| id           | 38d5f56bba0f40b6a312dfd3a55b5275 |</div><div class="line">| interface    | internal                         |</div><div class="line">| region       | RegionOne                        |</div><div class="line">| region_id    | RegionOne                        |</div><div class="line">| service_id   | 798a1feefccb4e8d817fa96aa44bb26e |</div><div class="line">| service_name | keystone                         |</div><div class="line">| service_type | identity                         |</div><div class="line">| url          | http://controller:5000/v2.0      |</div><div class="line">+--------------+----------------------------------+</div><div class="line">[root@controller ~]<span class="comment"># openstack endpoint create --region RegionOne identity admin http://controller:35357/v2.0</span></div><div class="line">+--------------+----------------------------------+</div><div class="line">| Field        | Value                            |</div><div class="line">+--------------+----------------------------------+</div><div class="line">| enabled      | True                             |</div><div class="line">| id           | fc20fb651f844827be6b519cdb961c09 |</div><div class="line">| interface    | admin                            |</div><div class="line">| region       | RegionOne                        |</div><div class="line">| region_id    | RegionOne                        |</div><div class="line">| service_id   | 798a1feefccb4e8d817fa96aa44bb26e |</div><div class="line">| service_name | keystone                         |</div><div class="line">| service_type | identity                         |</div><div class="line">| url          | http://controller:35357/v2.0     |</div><div class="line">+--------------+----------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建租户（tenants）、用户以及角色</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建admin 租户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack project create --domain default --description "Admin Project" admin</span></div><div class="line">+-------------+----------------------------------+</div><div class="line">| Field       | Value                            |</div><div class="line">+-------------+----------------------------------+</div><div class="line">| description | Admin Project                    |</div><div class="line">| domain_id   | default                          |</div><div class="line">| enabled     | True                             |</div><div class="line">| id          | 6a1d53e8e3b04b8bb83d19e92092ea38 |</div><div class="line">| is_domain   | False                            |</div><div class="line">| name        | admin                            |</div><div class="line">| parent_id   | None                             |</div><div class="line">+-------------+----------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建admin用户 （密码为3qiVpzU2x）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack user create --domain default --password-prompt admin</span></div><div class="line">User Password:</div><div class="line">Repeat User Password:</div><div class="line">+-----------+----------------------------------+</div><div class="line">| Field     | Value                            |</div><div class="line">+-----------+----------------------------------+</div><div class="line">| domain_id | default                          |</div><div class="line">| enabled   | True                             |</div><div class="line">| id        | 5d580681150c4814a33b53367f3ca453 |</div><div class="line">| name      | admin                            |</div><div class="line">+-----------+----------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建admin角色</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack role create admin</span></div><div class="line">+-------+----------------------------------+</div><div class="line">| Field | Value                            |</div><div class="line">+-------+----------------------------------+</div><div class="line">| id    | 45d56dc92dc84001932949aa9391ac05 |</div><div class="line">| name  | admin                            |</div><div class="line">+-------+----------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;添加admin角色到admin租户和用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack role add --project admin --user admin admin</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;下面我们再来创建一个service 租户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack project create --domain default --description "Service Project" service</span></div><div class="line">+-------------+----------------------------------+</div><div class="line">| Field       | Value |</div><div class="line">+-------------+----------------------------------+</div><div class="line">| description | Service Project                  |</div><div class="line">| domain_id   | default                          |</div><div class="line">| enabled     | True                             |</div><div class="line">| id          | ad59d222484e4c9381d46322a8f34ebe |</div><div class="line">| is_domain   | False                            |</div><div class="line">| name        | service                          |</div><div class="line">| parent_id   | None                             |</div><div class="line">+-------------+----------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建demo租户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack project create --domain default --description "Demo Project" demo</span></div><div class="line">+-------------+----------------------------------+</div><div class="line">| Field       | Value                            |</div><div class="line">+-------------+----------------------------------+</div><div class="line">| description | Demo Project                     |</div><div class="line">| domain_id   | default                          |</div><div class="line">| enabled     | True                             |</div><div class="line">| id          | 003e738c4cc848d2b3d19c63a69169e1 |</div><div class="line">| is_domain   | False                            |</div><div class="line">| name        | demo                             |</div><div class="line">| parent_id   | None                             |</div><div class="line">+-------------+----------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建demo用户 （密码9TtbgaA1q）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack user create --domain default --password-prompt demo</span></div><div class="line">User Password:</div><div class="line">Repeat User Password:</div><div class="line">+-----------+----------------------------------+</div><div class="line">| Field     | Value                            |</div><div class="line">+-----------+----------------------------------+</div><div class="line">| domain_id | default                          |</div><div class="line">| enabled   | True                             |</div><div class="line">| id        | a4e31690c437446ab1fcfc68beef9b1c |</div><div class="line">| name      | demo                             |</div><div class="line">+-----------+----------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建角色user</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack role create user</span></div><div class="line">+-------+----------------------------------+</div><div class="line">| Field | Value                            |</div><div class="line">+-------+----------------------------------+</div><div class="line">| id    | b55d5c19857740239c9b2cca2e064359 |</div><div class="line">| name  | user                             |</div><div class="line">+-------+----------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;添加user角色到demo租户和demo用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack role add --project demo --user demo user</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;验证admin用户和demo用户是否能正常登陆</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;首先做一个安全设置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># vim /usr/share/keystone/keystone-dist-paste.ini</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;搜索admin_token_auth， 从[pipeline:public_api], [pipeline:admin_api]和[pipeline:api_v3]中，把admin_token_auth去掉，例如把</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/20.png?raw=true" alt="20"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;改为</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/21.png?raw=true" alt="21"></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/22.png?raw=true" alt="22"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;改为</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/23.png?raw=true" alt="23"></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/24.png?raw=true" alt="24"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;改为</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/25.png?raw=true" alt="25"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;取消环境变量OS_TOKEN和OS_URL</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># unset OS_TOKEN OS_URL</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后再登陆admin和demo用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack --os-auth-url http://controller:35357/v3 --os-project-domain-id default --os-user-domain-id default --os-project-name admin --os-username admin --os-auth-type password token issue</span></div><div class="line">Password: </div><div class="line">+------------+----------------------------------+</div><div class="line">| Field      | Value                            |</div><div class="line">+------------+----------------------------------+</div><div class="line">| expires    | 2017-01-16T03:56:24.514931Z      |</div><div class="line">| id         | 3a9529d4a2b1446291d54ea764f67832 |</div><div class="line">| project_id | 6a1d53e8e3b04b8bb83d19e92092ea38 |</div><div class="line">| user_id    | 5d580681150c4814a33b53367f3ca453 |</div><div class="line">+------------+----------------------------------+</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack --os-auth-url http://controller:5000/v3 --os-project-domain-id default --os-user-domain-id default --os-project-name demo --os-username demo --os-auth-type password token issue</span></div><div class="line">Password: </div><div class="line">+------------+----------------------------------+</div><div class="line">| Field      | Value                            |</div><div class="line">+------------+----------------------------------+</div><div class="line">| expires    | 2017-01-16T03:58:00.066876Z      |</div><div class="line">| id         | 8712ff834d954a1c9ed30c4d45902d99 |</div><div class="line">| project_id | 003e738c4cc848d2b3d19c63a69169e1 |</div><div class="line">| user_id    | a4e31690c437446ab1fcfc68beef9b1c |</div><div class="line">+------------+----------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建openstack客户端脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># vim admin-openrc.sh</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> OS_PROJECT_DOMAIN_ID=default</div><div class="line"><span class="built_in">export</span> OS_USER_DOMAIN_ID=default</div><div class="line"><span class="built_in">export</span> OS_PROJECT_NAME=admin</div><div class="line"><span class="built_in">export</span> OS_TENANT_NAME=admin</div><div class="line"><span class="built_in">export</span> OS_USERNAME=admin</div><div class="line"><span class="built_in">export</span> OS_PASSWORD=3qiVpzU2x</div><div class="line"><span class="built_in">export</span> OS_AUTH_URL=http://controller:35357/v3</div><div class="line"><span class="built_in">export</span> OS_IDENTITY_API_VERSION=3</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;执行脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># source admin-openrc.sh</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;申请认证令牌</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack token issue </span></div><div class="line">+------------+----------------------------------+</div><div class="line">| Field      | Value                            |</div><div class="line">+------------+----------------------------------+</div><div class="line">| expires    | 2017-01-16T04:16:18.542286Z      |</div><div class="line">| id         | 3e4ceb2f0c404e309b9ced709dfc61cd |</div><div class="line">| project_id | 6a1d53e8e3b04b8bb83d19e92092ea38 |</div><div class="line">| user_id    | 5d580681150c4814a33b53367f3ca453 |</div><div class="line">+------------+----------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建openstack客户端脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># vim demo-openrc.sh</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> OS_PROJECT_DOMAIN_ID=default</div><div class="line"><span class="built_in">export</span> OS_USER_DOMAIN_ID=default</div><div class="line"><span class="built_in">export</span> OS_PROJECT_NAME=demo</div><div class="line"><span class="built_in">export</span> OS_TENANT_NAME=demo</div><div class="line"><span class="built_in">export</span> OS_USERNAME=demo</div><div class="line"><span class="built_in">export</span> OS_PASSWORD=9TtbgaA1q</div><div class="line"><span class="built_in">export</span> OS_AUTH_URL=http://controller:5000/v3</div><div class="line"><span class="built_in">export</span> OS_IDENTITY_API_VERSION=3</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;执行脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># source demo-openrc.sh</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;申请认证令牌</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># source demo-openrc.sh </span></div><div class="line">[root@controller ~]<span class="comment"># openstack token issue</span></div><div class="line">+------------+----------------------------------+</div><div class="line">| Field      | Value                            |</div><div class="line">+------------+----------------------------------+</div><div class="line">| expires    | 2017-01-16T04:16:33.929333Z      |</div><div class="line">| id         | b6010fc692754602a202354ca9efd475 |</div><div class="line">| project_id | 003e738c4cc848d2b3d19c63a69169e1 |</div><div class="line">| user_id    | a4e31690c437446ab1fcfc68beef9b1c |</div><div class="line">+------------+----------------------------------+</div></pre></td></tr></table></figure>
<h2 id="9-增加-glance-组件"><a href="#9-增加-glance-组件" class="headerlink" title="9.增加 glance 组件"></a>9.增加 glance 组件</h2><h3 id="增加image-前期准备-controller"><a href="#增加image-前期准备-controller" class="headerlink" title="增加image - 前期准备(controller)"></a>增加image - 前期准备(controller)</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;image又叫做glance，是用来管理镜像的一个组件，我们用镜像来安装操作系统。glance支持让用户自己管理自定义镜像。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建glance库和用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># mysql -uroot -ptn1Pi6Ytm</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">MariaDB [(none)]&gt; CREATE database glance;</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line"> </div><div class="line">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON glance.* TO <span class="string">'glance'</span>@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'Zznky4tP0'</span>;</div><div class="line">Query OK, 0 rows affected (0.01 sec)</div><div class="line"> </div><div class="line">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON glance.* TO <span class="string">'glance'</span>@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'Zznky4tP0'</span>;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;执行 admin-openrc.sh 脚本  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># source admin-openrc.sh</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建glance用户（密码为hf8LX9bow）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack user create --domain default --password-prompt glance</span></div><div class="line">User Password:</div><div class="line">Repeat User Password:</div><div class="line">+-----------+----------------------------------+</div><div class="line">| Field     | Value                            |</div><div class="line">+-----------+----------------------------------+</div><div class="line">| domain_id | default                          |</div><div class="line">| enabled   | True                             |</div><div class="line">| id        | ccaa39f341a84ba28efbdc12858ab147 |</div><div class="line">| name      | glance                           |</div><div class="line">+-----------+----------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;把admin角色添加到glance用户和service租户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack role add --project service --user glance admin</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建glance服务实体</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack service create --name glance --description "OpenStack Image service" image</span></div><div class="line">+-------------+----------------------------------+</div><div class="line">| Field       | Value                            |</div><div class="line">+-------------+----------------------------------+</div><div class="line">| description | OpenStack Image service          |</div><div class="line">| enabled     | True                             |</div><div class="line">| id          | 08b9dc2e841740b2bdeba8413aca368c |</div><div class="line">| name        | glance                           |</div><div class="line">| <span class="built_in">type</span>        | image                            |</div><div class="line">+-------------+----------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建image服务api 端点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack endpoint create --region RegionOne image public http://controller:9292</span></div><div class="line">+--------------+----------------------------------+</div><div class="line">| Field        | Value                            |</div><div class="line">+--------------+----------------------------------+</div><div class="line">| enabled      | True                             |</div><div class="line">| id           | 82fdb35f5d974143852d294246a73d7f |</div><div class="line">| interface    | public                           |</div><div class="line">| region       | RegionOne                        |</div><div class="line">| region_id    | RegionOne                        |</div><div class="line">| service_id   | 08b9dc2e841740b2bdeba8413aca368c |</div><div class="line">| service_name | glance                           |</div><div class="line">| service_type | image                            |</div><div class="line">| url          | http://controller:9292           |</div><div class="line">+--------------+----------------------------------+</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack endpoint create --region RegionOne image internal http://controller:9292</span></div><div class="line">+--------------+----------------------------------+</div><div class="line">| Field        | Value                            |</div><div class="line">+--------------+----------------------------------+</div><div class="line">| enabled      | True                             |</div><div class="line">| id           | 29fa12237cfe44f9b2304565edebd650 |</div><div class="line">| interface    | internal                         |</div><div class="line">| region       | RegionOne                        |</div><div class="line">| region_id    | RegionOne                        |</div><div class="line">| service_id   | 08b9dc2e841740b2bdeba8413aca368c |</div><div class="line">| service_name | glance                           |</div><div class="line">| service_type | image                            |</div><div class="line">| url          | http://controller:9292           |</div><div class="line">+--------------+----------------------------------+</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack endpoint create --region RegionOne image admin http://controller:9292</span></div><div class="line">+--------------+----------------------------------+</div><div class="line">| Field        | Value                            |</div><div class="line">+--------------+----------------------------------+</div><div class="line">| enabled      | True                             |</div><div class="line">| id           | 4ca144efb4d74f628f7ba472e144a908 |</div><div class="line">| interface    | admin                            |</div><div class="line">| region       | RegionOne                        |</div><div class="line">| region_id    | RegionOne                        |</div><div class="line">| service_id   | 08b9dc2e841740b2bdeba8413aca368c |</div><div class="line">| service_name | glance                           |</div><div class="line">| service_type | image                            |</div><div class="line">| url          | http://controller:9292           |</div><div class="line">+--------------+----------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;安装包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># yum install -y openstack-glance python-glance python-glanceclient</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># vim /etc/glance/glance-api.conf</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;更改或增加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">[database]</div><div class="line">connection = mysql://glance:Zznky4tP0@controller/glance</div><div class="line"></div><div class="line">[keystone_authtoken]</div><div class="line">auth_uri = http://controller:5000</div><div class="line">auth_url = http://controller:35357</div><div class="line">auth_plugin = password</div><div class="line">project_domain_id = default</div><div class="line">user_domain_id = default</div><div class="line">project_name = service</div><div class="line">username = glance</div><div class="line">password = hf8LX9bow</div><div class="line"></div><div class="line">[paste_deploy]</div><div class="line">flavor = keystone</div><div class="line"></div><div class="line">[glance_store]</div><div class="line">default_store = file</div><div class="line">filesystem_store_datadir = /var/lib/glance/images/</div><div class="line"></div><div class="line">[DEFAULT]</div><div class="line">notificaction_driver = noop</div><div class="line">verbose=True</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/26.png?raw=true" alt="26"></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/27.png?raw=true" alt="27"></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/28.png?raw=true" alt="28"></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/29.png?raw=true" alt="29"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># vim /etc/glance/glance-registry.conf</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;更改或增加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[DEFAULT]</div><div class="line">notificaction_driver = noop</div><div class="line">verbose=True</div><div class="line"></div><div class="line">[database]</div><div class="line">connection = mysql://glance:Zznky4tP0@controller/glance</div><div class="line"></div><div class="line">[keystone_authtoken]</div><div class="line">auth_uri = http://controller:5000</div><div class="line">auth_url = http://controller:35357</div><div class="line">auth_plugin = password</div><div class="line">project_domain_id = default</div><div class="line">user_domain_id = default</div><div class="line">project_name = service</div><div class="line">username = glance</div><div class="line">password = hf8LX9bow</div><div class="line"></div><div class="line">[paste_deploy]</div><div class="line">flavor = keystone</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/30.png?raw=true" alt="30"></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/31.png?raw=true" alt="31"></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/32.png?raw=true" alt="32"></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/33.png?raw=true" alt="33"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;同步glance数据库数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># su -s /bin/sh -c "glance-manage db_sync" glance</span></div><div class="line">No handlers could be found <span class="keyword">for</span> logger <span class="string">"oslo_config.cfg"</span></div><div class="line">/usr/lib64/python2.7/site-packages/sqlalchemy/engine/default.py:450: Warning: Duplicate index <span class="string">'ix_image_properties_image_id_name'</span> defined on the table <span class="string">'glance.image_properties'</span>. This is deprecated and will be disallowed <span class="keyword">in</span> a future release.</div><div class="line"> cursor.execute(statement, parameters)</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;启动服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># systemctl enable openstack-glance-api.service openstack-glance-registry.service</span></div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-glance-api.service to /usr/lib/systemd/system/openstack-glance-api.service.</div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-glance-registry.service to /usr/lib/systemd/system/openstack-glance-registry.service.</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># systemctl start openstack-glance-api.service openstack-glance-registry.service</span></div></pre></td></tr></table></figure>
<h3 id="增加image-验证操作-controller"><a href="#增加image-验证操作-controller" class="headerlink" title="增加image - 验证操作(controller)"></a>增加image - 验证操作(controller)</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(1) 添加环境变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># echo "export OS_IMAGE_API_VERSION=2" | tee -a admin-openrc.sh demo-openrc.sh</span></div><div class="line"><span class="built_in">export</span> OS_IMAGE_API_VERSION=2</div><div class="line">[root@controller ~]<span class="comment"># tail admin-openrc.sh </span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="built_in">export</span> OS_PROJECT_DOMAIN_ID=default</div><div class="line"><span class="built_in">export</span> OS_USER_DOMAIN_ID=default</div><div class="line"><span class="built_in">export</span> OS_PROJECT_NAME=admin</div><div class="line"><span class="built_in">export</span> OS_TENANT_NAME=admin</div><div class="line"><span class="built_in">export</span> OS_USERNAME=admin</div><div class="line"><span class="built_in">export</span> OS_PASSWORD=3qiVpzU2x</div><div class="line"><span class="built_in">export</span> OS_AUTH_URL=http://controller:35357/v3</div><div class="line"><span class="built_in">export</span> OS_IDENTITY_API_VERSION=3</div><div class="line"><span class="built_in">export</span> OS_IMAGE_API_VERSION=2</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(2) 执行admin-openrc.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># source admin-openrc.sh</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;（3）下载镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># wget http://download.cirros-cloud.net/0.3.4/cirros-0.3.4-x86_64-disk.img</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(4) 把刚刚下载的镜像上传到镜像服务中心</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># glance image-create --name "cirros" \</span></div><div class="line">&gt; --file cirros-0.3.4-x86_64-disk.img \</div><div class="line">&gt; --disk-format qcow2 --container-format bare \</div><div class="line">&gt; --visibility public --progress</div><div class="line">[=============================&gt;] 100%</div><div class="line">+------------------+--------------------------------------+</div><div class="line">| Property         | Value                                |</div><div class="line">+------------------+--------------------------------------+</div><div class="line">| checksum         | 617966a8b6bec61f9d7bcc442deae50d     |</div><div class="line">| container_format | bare                                 |</div><div class="line">| created_at       | 2017-01-16T04:46:14Z                 |</div><div class="line">| disk_format      | qcow2                                |</div><div class="line">| id               | 8def7abc-11f1-47d7-8449-bca9f26b1c6e |</div><div class="line">| min_disk         | 0                                    |</div><div class="line">| min_ram          | 0                                    |</div><div class="line">| name             | cirros                               |</div><div class="line">| owner            | 6a1d53e8e3b04b8bb83d19e92092ea38     |</div><div class="line">| protected        | False                                |</div><div class="line">| size             | 2102282                              |</div><div class="line">| status           | active                               |</div><div class="line">| tags             | []                                   |</div><div class="line">| updated_at       | 2017-01-16T04:46:15Z                 |</div><div class="line">| virtual_size     | None                                 |</div><div class="line">| visibility       | public                               |</div><div class="line">+------------------+--------------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后我们可以在 /var/lib/glance/images/目录下看到一个文件，这个就是刚刚上传的镜像，你会发现这个文件的名字和id是一致的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># ls /var/lib/glance/images/8def7abc-11f1-47d7-8449-bca9f26b1c6e </span></div><div class="line">/var/lib/glance/images/8def7abc-11f1-47d7-8449-bca9f26b1c6e</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;使用命令  <strong>glance image-list</strong> 可以查看镜像列表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># glance image-list</span></div><div class="line">+--------------------------------------+--------+</div><div class="line">| ID                                   | Name   |</div><div class="line">+--------------------------------------+--------+</div><div class="line">| 8def7abc-11f1-47d7-8449-bca9f26b1c6e | cirros |</div><div class="line">+--------------------------------------+--------+</div></pre></td></tr></table></figure>
<h2 id="10-增加-nova-组件"><a href="#10-增加-nova-组件" class="headerlink" title="10.增加 nova 组件"></a>10.增加 nova 组件</h2><h3 id="增加compute-前期准备-controller"><a href="#增加compute-前期准备-controller" class="headerlink" title="增加compute - 前期准备(controller)"></a>增加compute - 前期准备(controller)</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;compute又叫nova，是OpenStack中的计算组织控制器。OpenStack中实例（instances）生命周期的所有活动都由Nova处理。这样使得Nova成为一个负责管理计算资源、网络、认证、所需可扩展性的平台。但是，Nova自身并没有提供任何虚拟化能力，相反它使用libvirt API来与被支持的Hypervisors（kvm、xen、vmware等）交互。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建nova库，并创建nova用户 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># mysql -uroot -ptn1Pi6Ytm</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">MariaDB [(none)]&gt; CREATE DATABASE nova;</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line"></div><div class="line">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON nova.* TO <span class="string">'nova'</span>@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'RYgv0rg7p'</span>; </div><div class="line">Query OK, 0 rows affected (0.05 sec)</div><div class="line"></div><div class="line">MariaDB [(none)]&gt; MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON nova.* TO <span class="string">'nova'</span>@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'RYgv0rg7p'</span>;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;初始化环境变量   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># source admin-openrc.sh</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建nova用户 密码为 hsSNsqc43  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack user create --domain default --password-prompt nova</span></div><div class="line">User Password:</div><div class="line">Repeat User Password:</div><div class="line">+-----------+----------------------------------+</div><div class="line">| Field     | Value                            |</div><div class="line">+-----------+----------------------------------+</div><div class="line">| domain_id | default                          |</div><div class="line">| enabled   | True                             |</div><div class="line">| id        | 43d1f84437414405a654b375a83c03ff |</div><div class="line">| name      | nova                             |</div><div class="line">+-----------+----------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;添加admin角色到nova用户  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack role add --project service --user nova admin</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建nova服务实例 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack service create --name nova --description "OpenStack Compute" compute</span></div><div class="line">+-------------+----------------------------------+</div><div class="line">| Field       | Value                            |</div><div class="line">+-------------+----------------------------------+</div><div class="line">| description | OpenStack Compute                |</div><div class="line">| enabled     | True                             |</div><div class="line">| id          | 23c52463f4ee43798f0adf5b1ba6da93 |</div><div class="line">| name        | nova                             |</div><div class="line">| <span class="built_in">type</span>        | compute                          |</div><div class="line">+-------------+----------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建api端点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack endpoint create --region RegionOne compute public http://controller:8774/v2/%\(tenant_id\)s</span></div><div class="line">+--------------+-----------------------------------------+</div><div class="line">| Field        | Value                                   |</div><div class="line">+--------------+-----------------------------------------+</div><div class="line">| enabled      | True                                    |</div><div class="line">| id           | d15accf37377409e82388e625440a066        |</div><div class="line">| interface    | public                                  |</div><div class="line">| region       | RegionOne                               |</div><div class="line">| region_id    | RegionOne                               |</div><div class="line">| service_id   | 23c52463f4ee43798f0adf5b1ba6da93        |</div><div class="line">| service_name | nova                                    |</div><div class="line">| service_type | compute                                 |</div><div class="line">| url          | http://controller:8774/v2/%(tenant_id)s |</div><div class="line">+--------------+-----------------------------------------+</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack endpoint create --region RegionOne compute internal http://controller:8774/v2/%\(tenant_id\)s</span></div><div class="line">+--------------+-----------------------------------------+</div><div class="line">| Field        | Value                                   |</div><div class="line">+--------------+-----------------------------------------+</div><div class="line">| enabled      | True                                    |</div><div class="line">| id           | 7cd1a5f1ecd84a96a1fea1bd50c29721        |</div><div class="line">| interface    | internal                                |</div><div class="line">| region       | RegionOne                               |</div><div class="line">| region_id    | RegionOne                               |</div><div class="line">| service_id   | 23c52463f4ee43798f0adf5b1ba6da93        |</div><div class="line">| service_name | nova                                    |</div><div class="line">| service_type | compute                                 |</div><div class="line">| url          | http://controller:8774/v2/%(tenant_id)s |</div><div class="line">+--------------+-----------------------------------------+</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack endpoint create --region RegionOne compute admin http://controller:8774/v2/%\(tenant_id\)s</span></div><div class="line">+--------------+-----------------------------------------+</div><div class="line">| Field        | Value                                   |</div><div class="line">+--------------+-----------------------------------------+</div><div class="line">| enabled      | True                                    |</div><div class="line">| id           | bf598c8a131143b4aecedd21a9ffd345        |</div><div class="line">| interface    | admin                                   |</div><div class="line">| region       | RegionOne                               |</div><div class="line">| region_id    | RegionOne                               |</div><div class="line">| service_id   | 23c52463f4ee43798f0adf5b1ba6da93        |</div><div class="line">| service_name | nova                                    |</div><div class="line">| service_type | compute                                 |</div><div class="line">| url          | http://controller:8774/v2/%(tenant_id)s |</div><div class="line">+--------------+-----------------------------------------+</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># yum install -y openstack-nova-api openstack-nova-cert openstack-nova-conductor openstack-nova-console \</span></div><div class="line">&gt; openstack-nova-novncproxy openstack-nova-scheduler python-novaclient</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑配置文件  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># vim /etc/nova/nova.conf</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;更改或增加配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">[DEFAULT]</div><div class="line">rpc_backend=rabbit</div><div class="line">my_ip=192.168.16.111</div><div class="line">auth_strategy=keystone</div><div class="line">network_api_class = nova.network.neutronv2.api.API</div><div class="line">security_group_api = neutron</div><div class="line">linuxnet_interface_driver = nova.network.linux_net.NeutronLinuxBridgeInterfaceDriver</div><div class="line">firewall_driver = nova.virt.firewall.NoopFirewallDriver</div><div class="line">enabled_apis=osapi_compute,metadata</div><div class="line">verbose=<span class="literal">true</span></div><div class="line"></div><div class="line">[database]</div><div class="line">connection = mysql://nova:RYgv0rg7p@controller/nova</div><div class="line"></div><div class="line">[keystone_authtoken]</div><div class="line">auth_uri = http://controller:5000</div><div class="line">auth_url = http://controller:35357</div><div class="line">auth_plugin = password</div><div class="line">project_domain_id = default</div><div class="line">user_domain_id = default</div><div class="line">project_name = service</div><div class="line">username = nova</div><div class="line">password = hsSNsqc43</div><div class="line"></div><div class="line">[oslo_messaging_rabbit]</div><div class="line">rabbit_host = controller</div><div class="line">rabbit_userid = openstack</div><div class="line">rabbit_password = o3NXovnz5</div><div class="line"></div><div class="line">[vnc]</div><div class="line">vncserver_listen = <span class="variable">$my_ip</span></div><div class="line">vncserver_proxyclient_address = <span class="variable">$my_ip</span></div><div class="line"></div><div class="line">[glance]</div><div class="line">host = controller</div><div class="line"></div><div class="line">[oslo_concurrency]</div><div class="line">lock_path = /var/lib/nova/tmp</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/34.png?raw=true" alt="34"></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/35.png?raw=true" alt="35"></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/36.png?raw=true" alt="36"></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/37.png?raw=true" alt="37"></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/38.png?raw=true" alt="38"></p>
<blockquote>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/39.png?raw=true" alt="39"></p>
</blockquote>
<h1 id=""><a href="#" class="headerlink" title=""></a><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/40.png?raw=true" alt="40"></h1><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;同步数据创建nova库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># su -s /bin/sh -c "nova-manage db sync" nova</span></div><div class="line">No handlers could be found <span class="keyword">for</span> logger <span class="string">"oslo_config.cfg"</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;启动服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># systemctl enable openstack-nova-api.service \</span></div><div class="line">&gt; openstack-nova-cert.service openstack-nova-consoleauth.service \</div><div class="line">&gt; openstack-nova-scheduler.service openstack-nova-conductor.service \</div><div class="line">&gt; openstack-nova-novncproxy.service</div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-api.service to /usr/lib/systemd/system/openstack-nova-api.service.</div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-cert.service to /usr/lib/systemd/system/openstack-nova-cert.service.</div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-consoleauth.service to /usr/lib/systemd/system/openstack-nova-consoleauth.service.</div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-scheduler.service to /usr/lib/systemd/system/openstack-nova-scheduler.service.</div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-conductor.service to /usr/lib/systemd/system/openstack-nova-conductor.service.</div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-novncproxy.service to /usr/lib/systemd/system/openstack-nova-novncproxy.service.</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># systemctl start openstack-nova-api.service \</span></div><div class="line">&gt; openstack-nova-cert.service openstack-nova-consoleauth.service \</div><div class="line">&gt; openstack-nova-scheduler.service openstack-nova-conductor.service \</div><div class="line">&gt; openstack-nova-novncproxy.service</div></pre></td></tr></table></figure>
<h2 id="11-增加-nova-组件"><a href="#11-增加-nova-组件" class="headerlink" title="11.增加 nova 组件"></a>11.增加 nova 组件</h2><h3 id="增加compute-安装包并配置-compute"><a href="#增加compute-安装包并配置-compute" class="headerlink" title="增加compute - 安装包并配置(compute)"></a>增加compute - 安装包并配置(compute)</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;安装nova-compute包 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># yum install -y openstack-nova-compute sysfsutils</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑配置文件 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># vim /etc/nova/nova.conf</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;更改或增加如下配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">[DEFAULT]</div><div class="line">rpc_backend = rabbit</div><div class="line">auth_strategy = keystone</div><div class="line">my_ip = 192.168.16.112</div><div class="line">network_api_class = nova.network.neutronv2.api.API</div><div class="line">security_group_api = neutron</div><div class="line">linuxnet_interface_driver = nova.network.linux_net.NeutronLinuxBridgeInterfaceDriver</div><div class="line">firewall_driver = nova.virt.firewall.NoopFirewallDriver</div><div class="line">verbose=<span class="literal">true</span></div><div class="line"> </div><div class="line">[oslo_messaging_rabbit]</div><div class="line">rabbit_host = controller</div><div class="line">rabbit_userid = openstack</div><div class="line">rabbit_password = o3NXovnz5</div><div class="line"> </div><div class="line">[keystone_authtoken]</div><div class="line">auth_uri = http://controller:5000</div><div class="line">auth_url = http://controller:35357</div><div class="line">auth_plugin = password</div><div class="line">project_domain_id = default</div><div class="line">user_domain_id = default</div><div class="line">project_name = service</div><div class="line">username = nova</div><div class="line">password = hsSNsqc43</div><div class="line"> </div><div class="line">[vnc]</div><div class="line">enabled = True</div><div class="line">vncserver_listen = 0.0.0.0</div><div class="line">vncserver_proxyclient_address = <span class="variable">$my_ip</span></div><div class="line">novncproxy_base_url = http://controller:6080/vnc_auto.html</div><div class="line"> </div><div class="line">[glance]</div><div class="line">host = controller</div><div class="line"> </div><div class="line">[oslo_concurrency]</div><div class="line">lock_path = /var/lib/nova/tmp</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/41.png?raw=true" alt="41"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/42.png?raw=true" alt="42"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/43.png?raw=true" alt="43"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/44.png?raw=true" alt="44"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/45.png?raw=true" alt="45"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/46.png?raw=true" alt="46"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;使用如下命令检查你的机器cpu是否支持虚拟化</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># egrep -c '(vmx|svm)' /proc/cpuinfo</span></div><div class="line">2</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;如果得到的数字大于0，说明是支持的，否则说明不支持，若为0，需要编辑配置文件，不等于0就不用编辑配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># vim /etc/nova/nova.conf</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[libvirt]</div><div class="line">virt_type = qemu</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;启动服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># systemctl enable libvirtd.service openstack-nova-compute.service</span></div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-compute.service to /usr/lib/systemd/system/openstack-nova-compute.service.</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># systemctl start libvirtd.service openstack-nova-compute.service</span></div></pre></td></tr></table></figure>
<h3 id="增加compute-验证操作-controller"><a href="#增加compute-验证操作-controller" class="headerlink" title="增加compute - 验证操作(controller)"></a>增加compute - 验证操作(controller)</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;执行脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># source admin-openrc.sh</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;列出服务组件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># nova service-list</span></div><div class="line">+----+------------------+------------+----------+---------+-------+----------------------------+-----------------+</div><div class="line">| Id | Binary           | Host       | Zone     | Status  | State | Updated_at                 | Disabled Reason |</div><div class="line">+----+------------------+------------+----------+---------+-------+----------------------------+-----------------+</div><div class="line">| 1  | nova-consoleauth | controller | internal | enabled | up | 2017-01-17T04:53:08.000000    | -               |</div><div class="line">| 2  | nova-cert        | controller | internal | enabled | up | 2017-01-17T04:53:10.000000    | -               |</div><div class="line">| 3  | nova-conductor   | controller | internal | enabled | up | 2017-01-17T04:53:10.000000    | -               |</div><div class="line">| 4  | nova-scheduler   | controller | internal | enabled | up | 2017-01-17T04:53:10.000000    | -               |</div><div class="line">| 5  | nova-compute     | compute    | nova     | enabled | up | 2017-01-17T04:53:11.000000    | -               |</div><div class="line">+----+------------------+------------+----------+---------+-------+----------------------------+-----------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;共有5个：nova-consoleauth nova-conductor nova-scheduler nova-cert nova-compute</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;列出api端点，一共有9组： nova三组，glance三组，keystone三组</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># nova endpoints</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;如果有提示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">WARNING: nova has no endpoint <span class="keyword">in</span> ! Available endpoints <span class="keyword">for</span> this service:</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;可以忽略掉，也可以编辑  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># vim admin-openrc.sh</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;增加一行 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> OS_REGION_NAME=RegionOne</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;列出镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># nova image-list</span></div></pre></td></tr></table></figure>
<h2 id="12-增加-neutron-组件"><a href="#12-增加-neutron-组件" class="headerlink" title="12.增加 neutron 组件"></a>12.增加 neutron 组件</h2><h3 id="增加Networking-前期准备-controller"><a href="#增加Networking-前期准备-controller" class="headerlink" title="增加Networking - 前期准备(controller)"></a>增加Networking - 前期准备(controller)</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Networking又叫做Neutron，是Openstack必不可少的组件，它其实是网络虚拟化的实现工具，可以让我们模拟出路由器、交换机、网卡等网络设备。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;关于Neutron的电子书 <a href="https://yeasy.gitbooks.io/openstack_understand_neutron/content/" target="_blank" rel="external">深入理解 Neutron – OpenStack 网络实现</a></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Neutron支持两种网络模式，第一种是非常简单的网络架构，它仅支持是让实例连接外网，不支持自定义网络、路由器以及浮动ip。只有管理员或者授权的用户有权限去管理网络。第二种网络功能比较强大，支持自定义网络管理，支持自建路由器并且也支持浮动ip。即使没有授权的用户也可以管理网络，支持用户自己配置和管理。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建库、授权账号 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># mysql -uroot -ptn1Pi6Ytm</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">MariaDB [(none)]&gt; CREATE DATABASE neutron;</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line"> </div><div class="line">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON neutron.* TO <span class="string">'neutron'</span>@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'quidyOC50'</span>;</div><div class="line">Query OK, 0 rows affected (0.03 sec)</div><div class="line"> </div><div class="line">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON neutron.* TO <span class="string">'neutron'</span>@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'quidyOC50'</span>;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;执行脚本 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># source admin-openrc.sh</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建neutron用户（密码为mdcGVl29i）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack user create --domain default --password-prompt neutron</span></div><div class="line">User Password:</div><div class="line">Repeat User Password:</div><div class="line">+-----------+----------------------------------+</div><div class="line">| Field     | Value                            |</div><div class="line">+-----------+----------------------------------+</div><div class="line">| domain_id | default                          |</div><div class="line">| enabled   | True                             |</div><div class="line">| id        | 36a6f48840294e71970f5d13af7325f6 |</div><div class="line">| name      | neutron                          |</div><div class="line">+-----------+----------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;把admin角色添加到neutron用户里  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack role add --project service --user neutron admin</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建neutron实例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack service create --name neutron --description "OpenStack Networking" network</span></div><div class="line">+-------------+----------------------------------+</div><div class="line">| Field       | Value                            |</div><div class="line">+-------------+----------------------------------+</div><div class="line">| description | OpenStack Networking             |</div><div class="line">| enabled     | True                             |</div><div class="line">| id          | 27e0015e24654eb7bc06569ca10046b5 |</div><div class="line">| name        | neutron                          |</div><div class="line">| <span class="built_in">type</span>        | network                          |</div><div class="line">+-------------+----------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建networking服务api终端</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack endpoint create --region RegionOne network public http://controller:9696</span></div><div class="line">+--------------+----------------------------------+</div><div class="line">| Field        | Value                            |</div><div class="line">+--------------+----------------------------------+</div><div class="line">| enabled      | True                             |</div><div class="line">| id           | c46e6aaffb6d4de09a995168f6c05b5b |</div><div class="line">| interface    | public                           |</div><div class="line">| region       | RegionOne                        |</div><div class="line">| region_id    | RegionOne                        |</div><div class="line">| service_id   | 27e0015e24654eb7bc06569ca10046b5 |</div><div class="line">| service_name | neutron                          |</div><div class="line">| service_type | network                          |</div><div class="line">| url          | http://controller:9696           |</div><div class="line">+--------------+----------------------------------+</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack endpoint create --region RegionOne network internal http://controller:9696</span></div><div class="line">+--------------+----------------------------------+</div><div class="line">| Field        | Value                            |</div><div class="line">+--------------+----------------------------------+</div><div class="line">| enabled      | True                             |</div><div class="line">| id           | 41fa137019f940a98fbe027caadf5b96 |</div><div class="line">| interface    | internal                         |</div><div class="line">| region       | RegionOne                        |</div><div class="line">| region_id    | RegionOne                        |</div><div class="line">| service_id   | 27e0015e24654eb7bc06569ca10046b5 |</div><div class="line">| service_name | neutron                          |</div><div class="line">| service_type | network                          |</div><div class="line">| url          | http://controller:9696           |</div><div class="line">+--------------+----------------------------------+</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack endpoint create --region RegionOne network admin http://controller:9696 </span></div><div class="line">+--------------+----------------------------------+</div><div class="line">| Field        | Value                            |</div><div class="line">+--------------+----------------------------------+</div><div class="line">| enabled      | True                             |</div><div class="line">| id           | cab01468677d44258344b56b797e862a |</div><div class="line">| interface    | admin                            |</div><div class="line">| region       | RegionOne                        |</div><div class="line">| region_id    | RegionOne                        |</div><div class="line">| service_id   | 27e0015e24654eb7bc06569ca10046b5 |</div><div class="line">| service_name | neutron                          |</div><div class="line">| service_type | network                          |</div><div class="line">| url          | http://controller:9696           |</div><div class="line">+--------------+----------------------------------+</div></pre></td></tr></table></figure>
<h3 id="增加Networking-配置-controller"><a href="#增加Networking-配置-controller" class="headerlink" title="增加Networking - 配置(controller)"></a>增加Networking - 配置(controller)</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;安装组件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># yum install openstack-neutron openstack-neutron-ml2 \</span></div><div class="line">&gt; openstack-neutron-linuxbridge python-neutronclient ebtables ipset</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;配置服务端组件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># vim /etc/neutron/neutron.conf</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;更改或增加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">[DEFAULT]</div><div class="line">core_plugin = ml2</div><div class="line">service_plugins =</div><div class="line">rpc_backend = rabbit</div><div class="line">auth_strategy = keystone</div><div class="line">notify_nova_on_port_status_changes = True</div><div class="line">notify_nova_on_port_data_changes = True</div><div class="line">nova_url = http://controller:8774/v2</div><div class="line">verbose = True</div><div class="line"></div><div class="line">[database]</div><div class="line">connection = mysql://neutron:quidyOC50@controller/neutron</div><div class="line"></div><div class="line">[oslo_messaging_rabbit]</div><div class="line">rabbit_host = controller</div><div class="line">rabbit_userid = openstack</div><div class="line">rabbit_password = o3NXovnz5</div><div class="line"></div><div class="line">[keystone_authtoken]</div><div class="line">auth_uri = http://controller:5000</div><div class="line">auth_url = http://controller:35357</div><div class="line">auth_plugin = password</div><div class="line">project_domain_id = default</div><div class="line">user_domain_id = default</div><div class="line">project_name = service</div><div class="line">username = neutron</div><div class="line">password = mdcGVl29i</div><div class="line"></div><div class="line">[nova]</div><div class="line">auth_url = http://controller:35357</div><div class="line">auth_plugin = password</div><div class="line">project_domain_id = default</div><div class="line">user_domain_id = default</div><div class="line">region_name = RegionOne</div><div class="line">project_name = service</div><div class="line">username = nova</div><div class="line">password = hsSNsqc43</div><div class="line"></div><div class="line">[oslo_concurrency]</div><div class="line">lock_path = /var/lib/neutron/tmp</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/47.png?raw=true" alt="47"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/48.png?raw=true" alt="48"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/49.png?raw=true" alt="49"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/50.png?raw=true" alt="50"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/51.png?raw=true" alt="51"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/52.png?raw=true" alt="52"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;配置ml2 插件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># vim /etc/neutron/plugins/ml2/ml2_conf.ini</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;更改或增加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[ml2]</div><div class="line">type_drivers = flat,vlan</div><div class="line">tenant_network_types =</div><div class="line">mechanism_drivers = linuxbridge</div><div class="line">extension_drivers = port_security</div><div class="line"></div><div class="line">[ml2_type_flat]</div><div class="line">flat_networks = public</div><div class="line"></div><div class="line">[securitygroup]</div><div class="line">enable_ipset = True</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/53.png?raw=true" alt="53"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/54.png?raw=true" alt="54"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/55.png?raw=true" alt="55"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑linux桥接agent</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># vim /etc/neutron/plugins/ml2/linuxbridge_agent.ini</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;增加或更改</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[linux_bridge]</div><div class="line">physical_interface_mappings = public:ens33</div><div class="line"></div><div class="line">[vxlan]</div><div class="line">enable_vxlan = False</div><div class="line"></div><div class="line">[agent]</div><div class="line">prevent_arp_spoofing = True</div><div class="line"></div><div class="line">[securitygroup]</div><div class="line">enable_security_group = True</div><div class="line">firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/56.png?raw=true" alt="56"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/57.png?raw=true" alt="57"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/58.png?raw=true" alt="58"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/59.png?raw=true" alt="59"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;配置dhcp agent</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># vim /etc/neutron/dhcp_agent.ini</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;增加或更改</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[DEFAULT]</div><div class="line">interface_driver = neutron.agent.linux.interface.BridgeInterfaceDriver</div><div class="line">dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq</div><div class="line">enable_isolated_metadata = True</div><div class="line">verbose = True</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/60.png?raw=true" alt="60"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># vim /etc/neutron/metadata_agent.ini</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;更改或增加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[DEFAULT]</div><div class="line">auth_uri = http://controller:5000</div><div class="line">auth_url = http://controller:35357</div><div class="line">auth_region = RegionOne</div><div class="line">auth_plugin = password</div><div class="line">project_domain_id = default</div><div class="line">user_domain_id = default</div><div class="line">project_name = service</div><div class="line">username = neutron</div><div class="line">password = mdcGVl29i</div><div class="line">nova_metadata_ip = controller</div><div class="line">metadata_proxy_shared_secret = m8uhmQTu2</div><div class="line">verbose = True</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/61.png?raw=true" alt="61"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明：需要删除掉配置文件里原有的 auth_url   auth_region admin_tenant_name  admin_user  admin_password</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># vim /etc/nova/nova.conf</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;更改或添加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[neutron]</div><div class="line">url = http://controller:9696</div><div class="line">auth_url = http://controller:35357</div><div class="line">auth_plugin = password</div><div class="line">project_domain_id = default</div><div class="line">user_domain_id = default</div><div class="line">region_name = RegionOne</div><div class="line">project_name = service</div><div class="line">username = neutron</div><div class="line">password = mdcGVl29i</div><div class="line"></div><div class="line">service_metadata_proxy = True</div><div class="line">metadata_proxy_shared_secret = m8uhmQTu2</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/62.png?raw=true" alt="62"></p>
<h3 id="增加Networking-启动服务-controller"><a href="#增加Networking-启动服务-controller" class="headerlink" title="增加Networking - 启动服务(controller)"></a>增加Networking - 启动服务(controller)</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建ml2插件配置文件创建软连接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># ln -s /etc/neutron/plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;生成数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># su -s /bin/sh -c "neutron-db-manage --config-file /etc/neutron/neutron.conf \</span></div><div class="line">&gt; --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head<span class="string">" neutron</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;重启compute api服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># systemctl restart openstack-nova-api.service</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;启动服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># systemctl enable neutron-server.service \</span></div><div class="line">&gt; neutron-linuxbridge-agent.service neutron-dhcp-agent.service \</div><div class="line">&gt; neutron-metadata-agent.service</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># systemctl start neutron-server.service \</span></div><div class="line">&gt; neutron-linuxbridge-agent.service neutron-dhcp-agent.service \</div><div class="line">&gt; neutron-metadata-agent.service</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># systemctl enable neutron-l3-agent.service</span></div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/neutron-l3-agent.service to /usr/lib/systemd/system/neutron-l3-agent.service.</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># systemctl start neutron-l3-agent.service</span></div></pre></td></tr></table></figure>
<h3 id="增加Networking-配置compute节点-compute"><a href="#增加Networking-配置compute节点-compute" class="headerlink" title="增加Networking - 配置compute节点(compute)"></a>增加Networking - 配置compute节点(compute)</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;安装组件 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># yum install -y openstack-neutron openstack-neutron-linuxbridge ebtables ipset</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;配置普通组件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># vim /etc/neutron/neutron.conf</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;更改或增加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[DEFAULT]</div><div class="line">rpc_backend = rabbit</div><div class="line">auth_strategy = keystone</div><div class="line">verbose = True</div><div class="line"></div><div class="line">[oslo_messaging_rabbit]</div><div class="line">rabbit_host = controller</div><div class="line">rabbit_userid = openstack</div><div class="line">rabbit_password = o3NXovnz5</div><div class="line"></div><div class="line">[keystone_authtoken]</div><div class="line">auth_uri = http://controller:5000</div><div class="line">auth_url = http://controller:35357</div><div class="line">auth_plugin = password</div><div class="line">project_domain_id = default</div><div class="line">user_domain_id = default</div><div class="line">project_name = service</div><div class="line">username = neutron</div><div class="line">password = mdcGVl29i</div><div class="line"></div><div class="line">[oslo_concurrency]</div><div class="line">lock_path = /var/lib/neutron/tmp</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/63.png?raw=true" alt="63"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/64.png?raw=true" alt="64"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/65.png?raw=true" alt="65"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/66.png?raw=true" alt="66"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;配置linux桥接agent</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># vim /etc/neutron/plugins/ml2/linuxbridge_agent.ini</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[linux_bridge]</div><div class="line">physical_interface_mappings = public:ens33</div><div class="line"></div><div class="line">[vxlan]</div><div class="line">enable_vxlan = False</div><div class="line"></div><div class="line">[agent]</div><div class="line">prevent_arp_spoofing = True</div><div class="line"></div><div class="line">[securitygroup]</div><div class="line">enable_security_group = True</div><div class="line">firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/67.png?raw=true" alt="67"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/68.png?raw=true" alt="68"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/69.png?raw=true" alt="69"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/70.png?raw=true" alt="70"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;配置compute使用网络</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># vim /etc/nova/nova.conf</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;更改或增加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[neutron]</div><div class="line">url = http://controller:9696</div><div class="line">auth_url = http://controller:35357</div><div class="line">auth_plugin = password</div><div class="line">project_domain_id = default</div><div class="line">user_domain_id = default</div><div class="line">region_name = RegionOne</div><div class="line">project_name = service</div><div class="line">username = neutron</div><div class="line">password = mdcGVl29i</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/71.png?raw=*true*" alt="71"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;启动服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># systemctl restart openstack-nova-compute.service</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># systemctl enable neutron-linuxbridge-agent.service</span></div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/neutron-linuxbridge-agent.service to /usr/lib/systemd/system/neutron-linuxbridge-agent.service.</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># systemctl start neutron-linuxbridge-agent.service</span></div></pre></td></tr></table></figure>
<h3 id="增加Networking-验证配置-controller"><a href="#增加Networking-验证配置-controller" class="headerlink" title="增加Networking - 验证配置(controller)"></a>增加Networking - 验证配置(controller)</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;执行环境变量脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># source admin-openrc.sh</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;列出所有的扩展</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># neutron ext-list</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;列出所有agent</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># neutron agent-list</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;agent type如下：</p>
<ul>
<li>Linux bridge agent</li>
<li>Linux bridge agent</li>
<li>DHCP agent</li>
<li>Metadata agent</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;必须要有4个，否则说明上面的某个步骤配置有问题。</p>
<h2 id="13-增加-dashboard-组件"><a href="#13-增加-dashboard-组件" class="headerlink" title="13.增加 dashboard 组件"></a>13.增加 dashboard 组件</h2><h3 id="增加dashboard-horizon-controller"><a href="#增加dashboard-horizon-controller" class="headerlink" title="增加dashboard  - horizon (controller)"></a>增加dashboard  - horizon (controller)</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;安装包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># yum install -y openstack-dashboard</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># vim /etc/openstack-dashboard/local_settings</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;更改或增加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">OPENSTACK_HOST = <span class="string">"controller"</span></div><div class="line">ALLOWED_HOSTS = [<span class="string">'*'</span>, ]</div><div class="line">CACHES = &#123;</div><div class="line"><span class="string">'default'</span>: &#123;</div><div class="line"><span class="string">'BACKEND'</span>: <span class="string">'django.core.cache.backends.locmem.LocMemCache'</span>,</div><div class="line"><span class="string">'LOCATION'</span>: <span class="string">'127.0.0.1:11211'</span>,</div><div class="line">&#125; &#125;</div><div class="line">OPENSTACK_KEYSTONE_DEFAULT_ROLE = <span class="string">"user"</span></div><div class="line">OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = True</div><div class="line">OPENSTACK_API_VERSIONS = &#123;</div><div class="line"><span class="string">"identity"</span>: 3,</div><div class="line"><span class="string">"volume"</span>: 2,</div><div class="line">&#125;</div><div class="line">TIME_ZONE = <span class="string">"Asia/Chongqing"</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/72.png?raw=true" alt="72"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;改为</p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/73.png?raw=true" alt="73"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/74.png?raw=true" alt="74"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;改为</p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/75.png?raw=true" alt="75"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/76.png?raw=true" alt="76"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;改为</p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/77.png?raw=true" alt="77"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/78.png?raw=true" alt="78"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;改为</p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/79.png?raw=true" alt="79"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/80.png?raw=true" alt="80"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;改为</p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/81.png?raw=true" alt="81"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/82.png?raw=true" alt="82"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;改为</p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/83.png?raw=true" alt="83"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/84.png?raw=true" alt="84"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;改为</p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/85.png?raw=true" alt="85"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;重启服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># systemctl restart httpd.service memcached.service</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;此时可以去访问了 <a href="http://controller/dashboard" target="_blank" rel="external">http://controller/dashboard</a>   使用账号admin或者demon用户登陆即可，域为default</p>
<h2 id="14-增加-cinder-组件"><a href="#14-增加-cinder-组件" class="headerlink" title="14.增加 cinder 组件"></a>14.增加 cinder 组件</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;增加block storage - 前期准备 (controller)</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;block storage又叫做cinder，用来给openstack提供存储服务，比如我们在阿里云购买一台云主机，同时想购买容量大的磁盘，通常叫做云盘，这个云盘就是block storage。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建库并授权cinder用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># mysql -uroot -ptn1Pi6Ytm</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">MariaDB [(none)]&gt; CREATE DATABASE cinder;</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line"> </div><div class="line">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON cinder.* TO <span class="string">'cinder'</span>@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'O3bwbpoZ3'</span>; </div><div class="line">Query OK, 0 rows affected (0.01 sec)</div><div class="line"> </div><div class="line">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON cinder.* TO <span class="string">'cinder'</span>@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'O3bwbp </span></div><div class="line"><span class="string">Query OK, 0 rows affected (0.00 sec)</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;执行初始化脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># source admin-openrc.sh</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建cinder用户 （密码为hf8LX9bow）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack user create --domain default --password-prompt cinder</span></div><div class="line">User Password:</div><div class="line">Repeat User Password:</div><div class="line">+-----------+----------------------------------+</div><div class="line">| Field     | Value                            |</div><div class="line">+-----------+----------------------------------+</div><div class="line">| domain_id | default                          |</div><div class="line">| enabled   | True                             |</div><div class="line">| id        | d40f3763630e42eea28fbc23d932e1db |</div><div class="line">| name      | cinder                           |</div><div class="line">+-----------+----------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;添加admin角色</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack role add --project service --user cinder admin</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建cinder和cinderv2 实例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack service create --name cinder \</span></div><div class="line">&gt; --description <span class="string">"OpenStack Block Storage"</span> volume</div><div class="line">+-------------+----------------------------------+</div><div class="line">| Field       | Value                            |</div><div class="line">+-------------+----------------------------------+</div><div class="line">| description | OpenStack Block Storage          |</div><div class="line">| enabled     | True                             |</div><div class="line">| id          | 75380a0ca9764ed29f69241b34130173 |</div><div class="line">| name        | cinder                           |</div><div class="line">| <span class="built_in">type</span>        | volume                           |</div><div class="line">+-------------+----------------------------------+</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack service create --name cinderv2 \</span></div><div class="line">&gt; --description <span class="string">"OpenStack Block Storage"</span> volumev2</div><div class="line">+-------------+----------------------------------+</div><div class="line">| Field       | Value                            |</div><div class="line">+-------------+----------------------------------+</div><div class="line">| description | OpenStack Block Storage          |</div><div class="line">| enabled     | True                             |</div><div class="line">| id          | d680833b65fc446480b6aa4ccf15073b |</div><div class="line">| name        | cinderv2                         |</div><div class="line">| <span class="built_in">type</span>        | volumev2                         |</div><div class="line">+-------------+----------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建块存储服务api终端</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack endpoint create --region RegionOne volume public http://controller:8776/v1/%\(tenant_id\)s</span></div><div class="line">+--------------+-----------------------------------------+</div><div class="line">| Field        | Value                                   |</div><div class="line">+--------------+-----------------------------------------+</div><div class="line">| enabled      | True                                    |</div><div class="line">| id           | 12cfa0383a8a474e8dbd04bfeebc0a3f        |</div><div class="line">| interface    | public                                  |</div><div class="line">| region       | RegionOne                               |</div><div class="line">| region_id    | RegionOne                               |</div><div class="line">| service_id   | 75380a0ca9764ed29f69241b34130173        |</div><div class="line">| service_name | cinder                                  |</div><div class="line">| service_type | volume                                  |</div><div class="line">| url          | http://controller:8776/v1/%(tenant_id)s |</div><div class="line">+--------------+-----------------------------------------+</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack endpoint create --region RegionOne volume internal http://controller:8776/v1/%\(tenant_id\)s</span></div><div class="line">+--------------+-----------------------------------------+</div><div class="line">| Field        | Value                                   |</div><div class="line">+--------------+-----------------------------------------+</div><div class="line">| enabled      | True                                    |</div><div class="line">| id           | 06b12355e6554f4d8228975f4bb58b46        |</div><div class="line">| interface    | internal                                |</div><div class="line">| region       | RegionOne                               |</div><div class="line">| region_id    | RegionOne                               |</div><div class="line">| service_id   | 75380a0ca9764ed29f69241b34130173        |</div><div class="line">| service_name | cinder                                  |</div><div class="line">| service_type | volume                                  |</div><div class="line">| url          | http://controller:8776/v1/%(tenant_id)s |</div><div class="line">+--------------+-----------------------------------------+</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack endpoint create --region RegionOne volume admin http://controller:8776/v1/%\(tenant_id\)s</span></div><div class="line">+--------------+-----------------------------------------+</div><div class="line">| Field        | Value                                   |</div><div class="line">+--------------+-----------------------------------------+</div><div class="line">| enabled      | True                                    |</div><div class="line">| id           | d3dc8b0eba2744d1b2abd79da965b846        |</div><div class="line">| interface    | admin                                   |</div><div class="line">| region       | RegionOne                               |</div><div class="line">| region_id    | RegionOne                               |</div><div class="line">| service_id   | 75380a0ca9764ed29f69241b34130173        |</div><div class="line">| service_name | cinder                                  |</div><div class="line">| service_type | volume                                  |</div><div class="line">| url          | http://controller:8776/v1/%(tenant_id)s |</div><div class="line">+--------------+-----------------------------------------+</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack endpoint create --region RegionOne volumev2 public http://controller:8776/v2/%\(tenant_id\)s</span></div><div class="line">+--------------+-----------------------------------------+</div><div class="line">| Field        | Value                                   |</div><div class="line">+--------------+-----------------------------------------+</div><div class="line">| enabled      | True                                    |</div><div class="line">| id           | f34bbb14772d473b8b6e3e721d03f61a        |</div><div class="line">| interface    | public                                  |</div><div class="line">| region       | RegionOne                               |</div><div class="line">| region_id    | RegionOne                               |</div><div class="line">| service_id   | d680833b65fc446480b6aa4ccf15073b        |</div><div class="line">| service_name | cinderv2                                |</div><div class="line">| service_type | volumev2                                |</div><div class="line">| url          | http://controller:8776/v2/%(tenant_id)s |</div><div class="line">+--------------+-----------------------------------------+</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack endpoint create --region RegionOne volumev2 internal http://controller:8776/v2/%\(tenant_id\)s</span></div><div class="line">+--------------+-----------------------------------------+</div><div class="line">| Field        | Value                                   |</div><div class="line">+--------------+-----------------------------------------+</div><div class="line">| enabled      | True                                    |</div><div class="line">| id           | e9d91f0776b149869262b0cb8983e12b        |</div><div class="line">| interface    | internal                                |</div><div class="line">| region       | RegionOne                               |</div><div class="line">| region_id    | RegionOne                               |</div><div class="line">| service_id   | d680833b65fc446480b6aa4ccf15073b        |</div><div class="line">| service_name | cinderv2                                |</div><div class="line">| service_type | volumev2                                |</div><div class="line">| url          | http://controller:8776/v2/%(tenant_id)s |</div><div class="line">+--------------+-----------------------------------------+</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># openstack endpoint create --region RegionOne volumev2 admin http://controller:8776/v2/%\(tenant_id\)s</span></div><div class="line">+--------------+-----------------------------------------+</div><div class="line">| Field        | Value                                   |</div><div class="line">+--------------+-----------------------------------------+</div><div class="line">| enabled      | True                                    |</div><div class="line">| id           | 73d9a239b47542119256ab8183ba2b77        |</div><div class="line">| interface    | admin                                   |</div><div class="line">| region       | RegionOne                               |</div><div class="line">| region_id    | RegionOne                               |</div><div class="line">| service_id   | d680833b65fc446480b6aa4ccf15073b        |</div><div class="line">| service_name | cinderv2                                |</div><div class="line">| service_type | volumev2                                |</div><div class="line">| url          | http://controller:8776/v2/%(tenant_id)s |</div><div class="line">+--------------+-----------------------------------------+</div></pre></td></tr></table></figure>
<h3 id="增加block-storage-安装和配置-controller"><a href="#增加block-storage-安装和配置-controller" class="headerlink" title="增加block storage - 安装和配置 (controller)"></a>增加block storage - 安装和配置 (controller)</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;安装包  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># yum install -y openstack-cinder python-cinderclient</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑配置文件 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># vim /etc/cinder/cinder.conf</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;更改或增加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">[DEFAULT]</div><div class="line">rpc_backend = rabbit</div><div class="line">auth_strategy = keystone</div><div class="line">my_ip = 192.168.1.99</div><div class="line">verbose = True</div><div class="line"></div><div class="line">[database]</div><div class="line">connection = mysql://cinder:O3bwbpoZ3@controller/cinder</div><div class="line"></div><div class="line"></div><div class="line">[keystone_authtoken]</div><div class="line">auth_uri = http://controller:5000</div><div class="line">auth_url = http://controller:35357</div><div class="line">auth_plugin = password</div><div class="line">project_domain_id = default</div><div class="line">user_domain_id = default</div><div class="line">project_name = service</div><div class="line">username = cinder</div><div class="line">password = hf8LX9bow</div><div class="line"></div><div class="line">[oslo_messaging_rabbit]</div><div class="line">rabbit_host = controller</div><div class="line">rabbit_userid = openstack</div><div class="line">rabbit_password = o3NXovnz5</div><div class="line"></div><div class="line">[oslo_concurrency]</div><div class="line">lock_path = /var/lib/cinder/tmp</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/86.png?raw=true" alt="86"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/87.png?raw=true" alt="87"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/88.png?raw=true" alt="88"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/89.png?raw=true" alt="89"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/90.png?raw=true" alt="90"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;同步数据  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># su -s /bin/sh -c "cinder-manage db sync" cinder</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;配置compute使用块存储</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># vim /etc/nova/nova.conf</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[cinder]</div><div class="line">os_region_name=RegionOne</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/91.png?raw=true" alt="91"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;启动服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># systemctl restart openstack-nova-api.service</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># systemctl enable openstack-cinder-api.service openstack-cinder-scheduler.service</span></div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-cinder-api.service to /usr/lib/systemd/system/openstack-cinder-api.service.</div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-cinder-scheduler.service to /usr/lib/systemd/system/openstack-cinder-scheduler.service.</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># systemctl start openstack-cinder-api.service openstack-cinder-scheduler.service</span></div></pre></td></tr></table></figure>
<h3 id="增加block-storage-配置storage节点-compute"><a href="#增加block-storage-配置storage节点-compute" class="headerlink" title="增加block storage - 配置storage节点 (compute)"></a>增加block storage - 配置storage节点 (compute)</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;我们理应需要再准备一台单独的机器来做storage服务的，但是为了节省资源，我们就 那compute节点和storage节点共用。这里需要为compute（storage）节点再增加一块磁盘 （/dev/sdb）作为存储磁盘。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;安装lvm </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># yum install -y lvm2</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;启动服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># systemctl enable lvm2-lvmetad.service</span></div><div class="line">Created symlink from /etc/systemd/system/sysinit.target.wants/lvm2-lvmetad.service to /usr/lib/systemd/system/lvm2-lvmetad.service.</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># systemctl start lvm2-lvmetad.service</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建物理卷 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># pvcreate /dev/sdb</span></div><div class="line"> Physical volume <span class="string">"/dev/sdb"</span> successfully created.</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建卷组  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># vgcreate cinder-volumes /dev/sdb</span></div><div class="line"> Volume group <span class="string">"cinder-volumes"</span> successfully created</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># vim /etc/lvm/lvm.conf</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">devices &#123;</div><div class="line"> filter = [ <span class="string">"a/sdb/"</span>, <span class="string">"r/.*/"</span>]</div><div class="line"> 说明： 如果还有第三块磁盘，应该再加上</div><div class="line">filter = [ <span class="string">"a/sda/"</span>, <span class="string">"a/sdb/"</span>, <span class="string">"r/.*/"</span>]</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/92.png?raw=true" alt="92"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;安装包 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># yum install -y openstack-cinder targetcli python-oslo-policy</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># vim /etc/cinder/cinder.conf</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">[DEFAULT]</div><div class="line">rpc_backend = rabbit</div><div class="line">auth_strategy = keystone</div><div class="line">my_ip = 192.168.1.98</div><div class="line">enabled_backends = lvm</div><div class="line">glance_host = controller</div><div class="line">verbose = True</div><div class="line"></div><div class="line">[database]</div><div class="line">connection = mysql://cinder:O3bwbpoZ3@controller/cinder</div><div class="line"></div><div class="line">[oslo_messaging_rabbit]</div><div class="line">rabbit_host = controller</div><div class="line">rabbit_userid = openstack</div><div class="line">rabbit_password = o3NXovnz5</div><div class="line"></div><div class="line">[keystone_authtoken]</div><div class="line">auth_uri = http://controller:5000</div><div class="line">auth_url = http://controller:35357</div><div class="line">auth_plugin = password</div><div class="line">project_domain_id = default</div><div class="line">user_domain_id = default</div><div class="line">project_name = service</div><div class="line">username = cinder</div><div class="line">password = hf8LX9bow</div><div class="line"></div><div class="line">[lvm]</div><div class="line">volume_driver = cinder.volume.drivers.lvm.LVMVolumeDriver</div><div class="line">volume_group = cinder-volumes</div><div class="line">iscsi_protocol = iscsi</div><div class="line">iscsi_helper = lioadm</div><div class="line"></div><div class="line">[oslo_concurrency]</div><div class="line">lock_path = /var/lib/cinder/tmp</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/93.png?raw=true" alt="93"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/94.png?raw=~~true~~" alt="94"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/95.png?raw=true" alt="95"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/96.png?raw=true" alt="96"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/97.png?raw=true" alt="97"></p>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/98.png?raw=true" alt="98"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;启动服务 (compute)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># systemctl enable openstack-cinder-volume.service target.service</span></div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-cinder-volume.service to /usr/lib/systemd/system/openstack-cinder-volume.service.</div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/target.service to /usr/lib/systemd/system/target.service.</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@compute ~]<span class="comment"># systemctl start openstack-cinder-volume.service target.service</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;验证操作  (controller)</p>
<p>1). 执行初始化脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># source admin-openrc.sh</span></div></pre></td></tr></table></figure>
<p>2). 列出服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># cinder service-list</span></div></pre></td></tr></table></figure>
<h2 id="15-运行实例"><a href="#15-运行实例" class="headerlink" title="15.运行实例"></a>15.运行实例</h2><h3 id="创建公网网络-controller"><a href="#创建公网网络-controller" class="headerlink" title="创建公网网络   (controller)"></a>创建公网网络   (controller)</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;执行初始化脚本 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># source admin-openrc.sh</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建网络</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># neutron net-create public --shared --provider:physical_network public \</span></div><div class="line">&gt; --provider:network_type flat</div><div class="line">Created a new network:</div><div class="line">+---------------------------+--------------------------------------+</div><div class="line">| Field                     | Value                                |</div><div class="line">+---------------------------+--------------------------------------+</div><div class="line">| admin_state_up            | True                                 |</div><div class="line">| id                        | 7685414f-e88f-46e0-b7f3-5867771331bf |</div><div class="line">| mtu                       | 0                                    |</div><div class="line">| name                      | public                               |</div><div class="line">| port_security_enabled     | True                                 |</div><div class="line">| provider:network_type     | flat                                 |</div><div class="line">| provider:physical_network | public                               |</div><div class="line">| provider:segmentation_id  |                                      |</div><div class="line">| router:external           | False                                |</div><div class="line">| shared                    | True                                 |</div><div class="line">| status                    | ACTIVE                               |</div><div class="line">| subnets                   |                                      |</div><div class="line">| tenant_id                 | 4b9a26837e5443bc9b35ffa36f97f868     |</div><div class="line">+---------------------------+--------------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建子网</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># neutron subnet-create public 192.168.1.0/24 --name public \</span></div><div class="line">&gt; --allocation-pool start=192.168.1.10,end=192.168.1.30 \</div><div class="line">&gt; --dns-nameserver 61.128.128.68 --gateway 192.168.1.2</div><div class="line">Created a new subnet:</div><div class="line">+-------------------+--------------------------------------------------+</div><div class="line">| Field             | Value                                            |</div><div class="line">+-------------------+--------------------------------------------------+</div><div class="line">| allocation_pools  | &#123;<span class="string">"start"</span>: <span class="string">"192.168.1.10"</span>, <span class="string">"end"</span>: <span class="string">"192.168.1.30"</span>&#125; |</div><div class="line">| cidr              | 192.168.1.0/24                                   |</div><div class="line">| dns_nameservers   | 61.128.128.68                                    |</div><div class="line">| enable_dhcp       | True                                             |</div><div class="line">| gateway_ip        | 192.168.1.2                                      |</div><div class="line">| host_routes       |                                                  |</div><div class="line">| id                | 201038f1-c327-46b7-ba34-695ea712f742             |</div><div class="line">| ip_version        | 4                                                |</div><div class="line">| ipv6_address_mode |                                                  |</div><div class="line">| ipv6_ra_mode      |                                                  |</div><div class="line">| name              | public                                           |</div><div class="line">| network_id        | 7685414f-e88f-46e0-b7f3-5867771331bf             |</div><div class="line">| subnetpool_id     |                                                  |</div><div class="line">| tenant_id         | 4b9a26837e5443bc9b35ffa36f97f868                 |</div><div class="line">+-------------------+--------------------------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明：这里的公网，实际上是虚拟机用的那个网段，我们暂时把它作为公网，在这里因为涉及到dhcp服务，会和局域网内的路由器上的dhcp服务产生冲突，所以需要先把路由器上的dhcp服务关掉。</p>
<h3 id="创建key-controller"><a href="#创建key-controller" class="headerlink" title="创建key   (controller)"></a>创建key   (controller)</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;执行初始化脚本 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># source demo-openrc.sh</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;生成密钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># ssh-keygen -q -N ""</span></div><div class="line">Enter file <span class="keyword">in</span> <span class="built_in">which</span> to save the key (/root/.ssh/id_rsa):</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># nova keypair-add --pub-key ~/.ssh/id_rsa.pub mykey</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;验证密钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># nova keypair-list</span></div><div class="line">+-------+-------------------------------------------------+</div><div class="line">| Name  | Fingerprint                                     |</div><div class="line">+-------+-------------------------------------------------+</div><div class="line">| mykey | 11:c7:8b:e5:72:9d:13:19:03:46:bf:d8:8d:ef:69:c3 |</div><div class="line">+-------+-------------------------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;增加安全组规则</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># nova secgroup-add-rule default icmp -1 -1 0.0.0.0/0</span></div><div class="line">+-------------+-----------+---------+-----------+--------------+</div><div class="line">| IP Protocol | From Port | To Port | IP Range  | Source Group |</div><div class="line">+-------------+-----------+---------+-----------+--------------+</div><div class="line">| icmp        | -1        | -1      | 0.0.0.0/0 |              |</div><div class="line">+-------------+-----------+---------+-----------+--------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;允许ssh 访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># nova secgroup-add-rule default tcp 22 22 0.0.0.0/0</span></div><div class="line">+-------------+-----------+---------+-----------+--------------+</div><div class="line">| IP Protocol | From Port | To Port | IP Range  | Source Group |</div><div class="line">+-------------+-----------+---------+-----------+--------------+</div><div class="line">| tcp         | 22        | 22      | 0.0.0.0/0 |              |</div><div class="line">+-------------+-----------+---------+-----------+--------------+</div></pre></td></tr></table></figure>
<h3 id="配置实例选项-controller"><a href="#配置实例选项-controller" class="headerlink" title="配置实例选项   (controller)"></a>配置实例选项   (controller)</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;执行初始化脚本 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># source demo-openrc.sh</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;列出实例类型</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># nova flavor-list</span></div><div class="line">+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+</div><div class="line">| ID | Name      | Memory_MB | Disk | Ephemeral | Swap | VCPUs | RXTX_Factor | Is_Public |</div><div class="line">+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+</div><div class="line">| 1  | m1.tiny   | 512       | 1    | 0         |      | 1     | 1.0         | True      |</div><div class="line">| 2  | m1.small  | 2048      | 20   | 0         |      | 1     | 1.0         | True      |</div><div class="line">| 3  | m1.medium | 4096      | 40   | 0         |      | 2     | 1.0         | True      |</div><div class="line">| 4  | m1.large  | 8192      | 80   | 0         |      | 4     | 1.0         | True      |</div><div class="line">| 5  | m1.xlarge | 16384     | 160  | 0         |      | 8     | 1.0         | True      |</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;列出所有镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># nova image-list </span></div><div class="line">+--------------------------------------+--------+--------+--------+</div><div class="line">| ID                                   | Name   | Status | Server |</div><div class="line">+--------------------------------------+--------+--------+--------+</div><div class="line">| 3b1625d2-9f42-43f3-af8d-3a976c1825f7 | cirros | ACTIVE |        |</div><div class="line">+--------------------------------------+--------+--------+--------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;列出可用网络</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># neutron net-list</span></div><div class="line">+--------------------------------------+--------+-----------------------------------------------------+</div><div class="line">| id                                   | name   | subnets                                             |</div><div class="line">+--------------------------------------+--------+-----------------------------------------------------+</div><div class="line">| 7685414f-e88f-46e0-b7f3-5867771331bf | public | 201038f1-c327-46b7-ba34-695ea712f742 192.168.1.0/24 |</div><div class="line">+--------------------------------------+--------+-----------------------------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;列出安全组</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># nova secgroup-list</span></div><div class="line">+--------------------------------------+---------+------------------------+</div><div class="line">| Id                                   | Name    | Description            |</div><div class="line">+--------------------------------------+---------+------------------------+</div><div class="line">| ce571d20-ba6d-4aa5-b752-0181753ca729 | default | Default security group |</div><div class="line">+--------------------------------------+---------+------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;运行实例</p>
<p>nova boot –flavor m1.tiny –image cirros –nic net-id=PUBLIC_NET_ID \<br>  –security-group default –key-name mykey public-instance</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明：这里的PUBLIC_NET_ID需要替换为可用网络里面public网络的id</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># nova boot --flavor m1.tiny --image cirros --nic net-id=7685414f-e88f-46e0-b7f3-5867771331bf --security-group default --key-name mykey public-instance</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/5122697837c4adea982d2ac177624d498ba146df/%E4%BA%91%E8%AE%A1%E7%AE%97%20OpenStack/99.png?raw=true" alt="99"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;检测实例状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># nova list</span></div><div class="line">+--------------------------------------+-----------------+--------+------------+-------------+---------------------+</div><div class="line">| ID                                   | Name            | Status | Task State | Power State | Networks            |</div><div class="line">+--------------------------------------+-----------------+--------+------------+-------------+---------------------+</div><div class="line">| 12633a6f-841f-4f1c-bbb8-8823ede33f07 | public-instance | ACTIVE | -          | Running     | public=192.168.1.11 |</div><div class="line">+--------------------------------------+-----------------+--------+------------+-------------+---------------------+</div></pre></td></tr></table></figure>
<h3 id="连接实例-controller"><a href="#连接实例-controller" class="headerlink" title="连接实例   (controller)"></a>连接实例   (controller)</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;使用vnc连接（使用下面命令可以列出vnc的连接）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># nova get-vnc-console public-instance novnc</span></div><div class="line">+-------+---------------------------------------------------------------------------------+</div><div class="line">| Type  | Url                                                                             |</div><div class="line">+-------+---------------------------------------------------------------------------------+</div><div class="line">| novnc | http://controller:6080/vnc_auto.html?token=e30b64d1-b322-4760-8c56-a38bc9109b9d |</div><div class="line">+-------+---------------------------------------------------------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;验证网络（在实例里面）  </p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;ping -c 4 192.168.1.2</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;远程连接实例</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;首先用nova list 查看实例的ip（假如为192.168.1.11）</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;验证ip</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;ping -c4 192.168.16.11</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;远程ssh登录   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># ssh cirros@192.168.1.11</span></div></pre></td></tr></table></figure>
<h2 id="16-给实例增加云盘"><a href="#16-给实例增加云盘" class="headerlink" title="16.给实例增加云盘"></a>16.给实例增加云盘</h2><h3 id="增加云盘-controller"><a href="#增加云盘-controller" class="headerlink" title="增加云盘   (controller)"></a>增加云盘   (controller)</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;先执行初始化脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># source demo-openrc.sh</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建一个2G的云盘，名字为volume1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># cinder create --display-name volume1 2</span></div><div class="line">+---------------------------------------+--------------------------------------+</div><div class="line">| Property                              | Value                                |</div><div class="line">+---------------------------------------+--------------------------------------+</div><div class="line">| attachments                           | []                                   |</div><div class="line">| availability_zone                     | nova                                 |</div><div class="line">| bootable                              | <span class="literal">false</span>                                |</div><div class="line">| consistencygroup_id                   | None                                 |</div><div class="line">| created_at                            | 2017-01-20T10:32:05.000000           |</div><div class="line">| description                           | None                                 |</div><div class="line">| encrypted                             | False                                |</div><div class="line">| id                                    | fddd495f-448b-4133-a7d0-4a1970aa57ad |</div><div class="line">| metadata                              | &#123;&#125;                                   |</div><div class="line">| multiattach                           | False                                |</div><div class="line">| name                                  | volume1                              |</div><div class="line">| os-vol-tenant-attr:tenant_id          | e42c063541c34399a6d57ab1199ed368     |</div><div class="line">| os-volume-replication:driver_data     | None                                 |</div><div class="line">| os-volume-replication:extended_status | None                                 |</div><div class="line">| replication_status                    | disabled                             |</div><div class="line">| size                                  | 2                                    |</div><div class="line">| snapshot_id                           | None                                 |</div><div class="line">| source_volid                          | None                                 |</div><div class="line">| status                                | creating                             |</div><div class="line">| user_id                               | 8a6d52addac6463ba10bfbf7db625b3f     |</div><div class="line">| volume_type                           | None                                 |</div><div class="line">+---------------------------------------+--------------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;列出所有云盘</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># cinder list</span></div><div class="line">+--------------------------------------+-----------+---------+------+-------------+----------+-------------+-------------+</div><div class="line">| ID                                   | Status    | Name    | Size | Volume Type | Bootable | Multiattach | Attached to |</div><div class="line">+--------------------------------------+-----------+---------+------+-------------+----------+-------------+-------------+</div><div class="line">| fddd495f-448b-4133-a7d0-4a1970aa57ad | available | volume1 | 2    | -           | <span class="literal">false</span>    | False       |             |</div><div class="line">+--------------------------------------+-----------+---------+------+-------------+----------+-------------+-------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;把云盘挂到实例中</p>
<p>nova volume-attach INSTANCE_NAME VOLUME_ID</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># nova volume-attach public-instance fddd495f-448b-4133-a7d0-4a1970aa57ad</span></div><div class="line">+----------+--------------------------------------+</div><div class="line">| Property | Value                                |</div><div class="line">+----------+--------------------------------------+</div><div class="line">| device   | /dev/vdb                             |</div><div class="line">| id       | fddd495f-448b-4133-a7d0-4a1970aa57ad |</div><div class="line">| serverId | 12633a6f-841f-4f1c-bbb8-8823ede33f07 |</div><div class="line">| volumeId | fddd495f-448b-4133-a7d0-4a1970aa57ad |</div><div class="line">+----------+--------------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明：INSTACE_NAME可以用nova list查看，VOLUME_ID就是用cinder list查看到的云盘id</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;列出已经挂上的云盘</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># nova volume-list</span></div><div class="line">WARNING: Command volume-list is deprecated and will be removed after Nova 13.0.0 is released. Use python-cinderclient or openstackclient instead.</div><div class="line">+--------------------------------------+--------+--------------+------+-------------+--------------------------------------+</div><div class="line">| ID                                   | Status | Display Name | Size | Volume Type | Attached to                          |</div><div class="line">+--------------------------------------+--------+--------------+------+-------------+--------------------------------------+</div><div class="line">| fddd495f-448b-4133-a7d0-4a1970aa57ad | <span class="keyword">in</span>-use | volume1      | 2    | -           | 12633a6f-841f-4f1c-bbb8-8823ede33f07 |</div><div class="line">+--------------------------------------+--------+--------------+------+-------------+--------------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后登陆到实例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@controller ~]<span class="comment"># ssh cirros@192.168.1.11</span></div><div class="line">cirros@192.168.1.11<span class="string">'s password: </span></div><div class="line"><span class="string">$</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;查看云盘</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">$ sudo fdisk -l</div><div class="line"> </div><div class="line">Disk /dev/vda: 1073 MB, 1073741824 bytes</div><div class="line">255 heads, 63 sectors/track, 130 cylinders, total 2097152 sectors</div><div class="line">Units = sectors of 1 * 512 = 512 bytes</div><div class="line">Sector size (logical/physical): 512 bytes / 512 bytes</div><div class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</div><div class="line">Disk identifier: 0x00000000</div><div class="line"> </div><div class="line"> Device Boot Start End Blocks Id System</div><div class="line">/dev/vda1 * 16065 2088449 1036192+ 83 Linux</div><div class="line"> </div><div class="line">Disk /dev/vdb: 2147 MB, 2147483648 bytes</div><div class="line">16 heads, 63 sectors/track, 4161 cylinders, total 4194304 sectors</div><div class="line">Units = sectors of 1 * 512 = 512 bytes</div><div class="line">Sector size (logical/physical): 512 bytes / 512 bytes</div><div class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</div><div class="line">Disk identifier: 0x00000000</div><div class="line"> </div><div class="line">Disk /dev/vdb doesn<span class="string">'t contain a valid partition table</span></div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenStack/">OpenStack</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Resin/1. resin安装与配置" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Resin/1. resin安装与配置/" class="article-date">
  	<time datetime="2017-09-02T18:09:22.853Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Resin/1. resin安装与配置/">
        resin安装与配置
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;resin 同样也需要 jdk 的支持，所以第一步也是安装 jdk 。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<a href="http://caucho.com/" target="_blank" rel="external">resin官方网站</a> ，它分两个版本，resin 是开源的，另外一个 resinpro 为商业版本。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@192 src]<span class="comment"># wget http://caucho.com/download/resin-4.0.51.tar.gz</span></div><div class="line">[root@192 src]<span class="comment"># tar zxvf resin-4.0.51.tar.gz </span></div><div class="line">[root@192 src]<span class="comment"># cd resin-4.0.51</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">./configure --prefix=/usr/<span class="built_in">local</span>/resin --with-java-home=/usr/<span class="built_in">local</span>/jdk1.8.0_111</div><div class="line">make &amp;&amp; make install</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@192 resin-4.0.51]<span class="comment"># /etc/init.d/resin start</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;下面简单配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@192 resin-4.0.51]<span class="comment"># cd /usr/local/resin/conf/</span></div><div class="line">[root@192 conf]<span class="comment"># vim resin.xml</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;resin 的配置文件和 tomcat 的很像，基本结构为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;cluster id=<span class="string">"app"</span>&gt;</div><div class="line">&lt;host&gt;&lt;/host&gt;</div><div class="line">&lt;/cluster&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;其中虚拟主机配置就在 <host></host> 里配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@192 conf]<span class="comment"># vim resin.xml</span></div><div class="line"></div><div class="line">&lt;host id=<span class="string">"www.123.com"</span> root-directory=<span class="string">"."</span>&gt;</div><div class="line">  &lt;web-app id=<span class="string">"/"</span> root-directory=<span class="string">"/tmp/resin"</span>&gt;</div><div class="line">&lt;/host&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注意，这里要放在  <cluster id="app"> 下边</cluster></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建文件夹，并重启 resin</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@192 conf]<span class="comment"># mkdir /tmp/resin</span></div><div class="line">[root@192 conf]<span class="comment"># service resin stop</span></div><div class="line">Stopping resin: .</div><div class="line">[root@192 conf]<span class="comment"># service resin start</span></div><div class="line">Starting resin: .</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后编辑一个测试文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@192 conf]<span class="comment"># vim /tmp/resin/222.jsp</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;html&gt;&lt;body&gt;&lt;center&gt; </div><div class="line"> </div><div class="line">Now time is: &lt;%=new java.util.Date()%&gt; </div><div class="line"> </div><div class="line">&lt;/center&gt;&lt;/body&gt;&lt;/html&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@192 conf]<span class="comment"># curl -x127.0.0.1:80 www.123.com/222.jsp</span></div><div class="line">&lt;html&gt;&lt;body&gt;&lt;center&gt; </div><div class="line"> </div><div class="line">Now time is: Wed Apr 05 13:30:44 CST 2017 </div><div class="line"> </div><div class="line">&lt;/center&gt;&lt;/body&gt;&lt;/html&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;更改监听端口，需编辑配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@192 conf]<span class="comment"># vim resin.properties</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/resin%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/01.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改为</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/resin%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/02.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;重启服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@192 conf]<span class="comment"># service resin stop</span></div><div class="line">Stopping resin: .</div><div class="line">[root@192 conf]<span class="comment"># service resin start</span></div><div class="line">Starting resin: .</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;登录本地 IP 就能访问 resin 的默认页面</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/resin%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/03.png?raw=true" alt=""></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Resin/">Resin</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-NFS/1. nfs部署和优化" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/NFS/1. nfs部署和优化/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.833Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/NFS/1. nfs部署和优化/">
        nfs部署和优化
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;NFS = network file system</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;NFS服务比较常用，用于在网络上共享储存。</p>
<h2 id="服务端配置-NFS"><a href="#服务端配置-NFS" class="headerlink" title="服务端配置 NFS"></a>服务端配置 NFS</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;centos 上使用 NFS 服务，需要安装两个包（nfs-utils 和 rpcbind），不过当使用 yum 安装 nfs-utils 时会把 rpcbind 一起安装上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># yum install -y nfs-utils rpcbind</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在以前的 centos 版本中，是需要安装 portmap 包的，从 centos 6 开始，就改为rpcbind了。NFS 配置起来很简单，只需要编辑配置文件 /etc/exports 即可。先创建一个简单的 NFS 服务器。 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># vim /etc/exports</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;写入一下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/home/ 192.168.0.0/24(rw,sync,all_squash,anonuid=501,anongid=501)</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这个配置文件就这样简单一行。共分为三部分，第一部分就是本地要共享出去的目录，第二部分为允许访问的主机（可以是一个 IP 也可以是一个 IP 段），第三部分就是小括号里面的，为一些权限选项。</p>
<ul>
<li><p>rw： 读写；</p>
</li>
<li><p>ro： 只读；</p>
</li>
<li><p>sync： 同步模式，内存中数据时时写入磁盘；</p>
</li>
<li><p>async： 不同步，把内存中数据定期写入磁盘中；</p>
</li>
<li><p>no_root_squash： 加上这个选项后，root 用户就会对共享的目录拥有至高的权限控制，就像是对本机的目录操作一样。但这样不安全，不建议使用。</p>
</li>
<li><p>roo_squash： 和上面的选项对应，root 用户对共享目录权限不高，只有普通用户的权限，即限制了 root 。</p>
</li>
<li><p>all_squash： 不管使用 NFS 的用户是谁，他的身份都会被限定成一个指定的普通用户身份。</p>
</li>
<li><p>anonuid/anongid： 要和root_squash 以及 all_squash一同使用，用于指定使用 NFS 的用户限定后的 uid 和 gid ，前提是本机的 /etc/passwd 存在这个 uid 和 gid 。</p>
</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;现在分析一下刚才配置的那个 /etc/exports 文件。其中共享的目录为 /home ，信任的主机为 192.168.0.0/24 这个网段，权限为读写，同步，限定所有使用者，并且限定 uid 和 gid 都为501.</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑好配置文件后，就该启动服务了 ：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># service rpcbind start</span></div><div class="line">正在启动 rpcbind： [确定]</div><div class="line">[root@localhost ~]<span class="comment"># service nfs start</span></div><div class="line">启动 NFS 服务： [确定]</div><div class="line">启动 NFS mountd： [确定]</div><div class="line">启动 NFS 守护进程： [确定]</div><div class="line">正在启动 RPC idmapd： [确定]</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在启动服务以前，需要先启动 rpcbind 服务，以前的 centos 老版本中并不是 rpcbind ，而是叫做 portmap。</p>
<h2 id="客户端上挂载-NFS"><a href="#客户端上挂载-NFS" class="headerlink" title="客户端上挂载 NFS"></a>客户端上挂载 NFS</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;客户端挂载 NFS 以前，需要先查看服务端都共享了哪些目录，需要使用 showmount 命令，但这个命令是 nfs-utils 这个包带的，所以同样需要安装 nfs-utils</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@192 ~]<span class="comment"># yum install -y nfs-utils</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;现在可以查看服务器端都共享了那些目录了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@192 ~]<span class="comment"># showmount -e 192.168.0.73</span></div><div class="line">Export list <span class="keyword">for</span> 192.168.0.73:</div><div class="line">/home 192.168.0.0/24</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明：其中 192.168.0.73 为 NFS 服务端 IP。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;可以看到在服务器端配置的 nfs 共享信息。showmount -e 加 ip 就可以查看 nfs 的共享情况，可以看到 192.168.0.73 的共享目录为 /home ，信任主机为 192.168.0.0/24 这个网段。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;下面的命令是在客户端上挂载 nfs ：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@192 ~]<span class="comment"># mount -t nfs -o nfsvers=3 192.168.0.73:/home/ /mnt/</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明： -o 后面跟挂载选项，如果不加 -o nfsvers=3 则在挂载目录下的文件属主和组都是 nobody，如果指定 nfsers=3 则显示501，所以尽量加上这个选项，避免权限混乱。</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/nfs%E9%83%A8%E7%BD%B2%E5%92%8C%E4%BC%98%E5%8C%96/01.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;用 df -h 命令可以查看到多出来的一个 /mnt 分区，它就是 NFS 共享的目录了。</p>
<h2 id="命令-exportfs"><a href="#命令-exportfs" class="headerlink" title="命令 exportfs"></a>命令 exportfs</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;还有一个常用的命令就是 exportfs ，它的常用选项为 [-aruv]</p>
<ul>
<li>-a： 全部挂载或者卸载；</li>
<li>-r： 重新挂载；</li>
<li>-u： 卸载某一个目录；</li>
<li>-v： 显示共享的目录</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;使用 exportfs 命令，当改变 /etc/exports 配置文件后，不用重启 nfs 服务直接用这个 exportfs 即可。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;下面先更改服务端的配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@192 ~]<span class="comment"># vim /etc/exports</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;增加一行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/tmp/ 192.168.0.0/24(rw,sync,no_root_squash)</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后服务端上执行命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@192 ~]<span class="comment"># exportfs -arv</span></div><div class="line">exporting 192.168.0.0/24:/tmp</div><div class="line">exporting 192.168.0.0/24:/home</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在之前的命令中用到了 mount 命令来挂载 nfs ，其实 mount 这个 nfs 服务还是有些说法的。首先是用 -t nfs 来指定挂载的类型为 nfs 另外在使用 nfs 时，常用一个选项就是 -o nolock 了，即在挂载 nfs 服务时，不加锁。在客户端上执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@192 ~]<span class="comment"># mkdir /test</span></div><div class="line">[root@192 ~]<span class="comment"># mount -t nfs -o nolock 192.168.0.73:/tmp/ /test/</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;还可以把要挂载的 nfs 目录写到 client 上的 /etc/fstab 文件中，挂载时只需要执行 mount -a 即可。在 /etc/fstab 里加一行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@192 ~]<span class="comment"># vim /etc/fstab</span></div><div class="line"></div><div class="line">1192.168.0.73:/tmp/     /<span class="built_in">test</span>     nfs     nolock     0 0</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/nfs%E9%83%A8%E7%BD%B2%E5%92%8C%E4%BC%98%E5%8C%96/02.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;因为刚挂载过，所以先卸载：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@192 ~]<span class="comment"># umount /test/</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/nfs%E9%83%A8%E7%BD%B2%E5%92%8C%E4%BC%98%E5%8C%96/03.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@192 ~]<span class="comment"># mount -a</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/nfs%E9%83%A8%E7%BD%B2%E5%92%8C%E4%BC%98%E5%8C%96/04.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这样也可以挂载上，而且以后开机会自动挂载。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NFS/">NFS</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Nagios/5. nagios调用短信接口" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Nagios/5. nagios调用短信接口/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.830Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Nagios/5. nagios调用短信接口/">
        nagios调用短信接口
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;公司正好有自己的短信接口平台，接下来带大家一起配置nagios调用第三方短信接口。</p>
<ol>
<li>首先我们要写一个调用短信接口的脚本，网上的脚本大都是python写的，我这个是shell写的，比较好理解。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /root/duanxin.sh</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 脚本的日志文件 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">LOGFILE=<span class="string">"/data1/sms_log/sms_send_.log"</span>  <span class="comment">#定义发送短信的日志信息 文件</span></div><div class="line">:&gt;&gt;<span class="string">"<span class="variable">$LOGFILE</span>"</span> </div><div class="line"><span class="built_in">exec</span> 1&gt;&gt;<span class="string">"<span class="variable">$LOGFILE</span>"</span> </div><div class="line"><span class="built_in">exec</span> 2&gt;&amp;1 </div><div class="line"></div><div class="line">Uid=<span class="string">"test"</span>    <span class="comment">#接口的用户名，这个使用接口时对方会提供，我这里的test是随意写的</span></div><div class="line">Key=<span class="string">"123456"</span>  <span class="comment">#密码与用户名对应，也是接口方提供</span></div><div class="line"></div><div class="line">MOBILE_NUMBER=<span class="variable">$1</span> <span class="comment"># 接受短信的手机号码  </span></div><div class="line">QIANMING=<span class="string">"%e3%80%90%e9%a9%ac%e5%8f%af%e6%b3%a2%e7%bd%97%e7%bd%91%e3%80%91"</span> <span class="comment">#这里重点说一下，签名有的接口需要，有的不需要，因为我们公司的接口需要，所以需要添加上，我这里的签名内容是经过编码的，不加编码会导致发送失败，具体工作中需不需要编码还得看接口哪边有没有要求。</span></div><div class="line">XXD=<span class="string">"/usr/bin/xxd"</span> </div><div class="line">CURL=<span class="string">"/usr/bin/curl"</span> </div><div class="line">TIMEOUT=5 </div><div class="line">MESSAGE_ENCODE=$(<span class="built_in">echo</span> $(/usr/<span class="built_in">local</span>/bin/php -r <span class="string">"echo urlencode(\"<span class="variable">$2</span>\");"</span>; ) )  <span class="comment">#这里的$2是nagios发送短信的第二个变量</span></div><div class="line">URL=<span class="string">"http://192.168.100.100:8888/services/msgsend.asmx/SendMsg?userCode=<span class="variable">$&#123;$Uid&#125;</span>&amp;userPass=<span class="variable">$&#123;Key&#125;</span>&amp;DesNo=<span class="variable">$&#123;MOBILE_NUMBER&#125;</span>&amp;Msg=<span class="variable">$&#123;MESSAGE_ENCODE&#125;</span><span class="variable">$&#123;QIANMING&#125;</span>&amp;Channel=0"</span></div><div class="line"><span class="comment">#这里的URL是胡乱写的，不可能暴漏自己公司的接口哈，但是格式大体是这样的，到时候接口方会提供URL的格式的</span></div><div class="line"><span class="comment"># Send it </span></div><div class="line"><span class="built_in">set</span> -x </div><div class="line"><span class="variable">$&#123;CURL&#125;</span> -s --connect-timeout <span class="variable">$&#123;TIMEOUT&#125;</span> <span class="string">"<span class="variable">$&#123;URL&#125;</span>"</span></div></pre></td></tr></table></figure>
<ol>
<li>测试脚本</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bash /root/duanxin.sh <span class="string">"手机号"</span> “内容”</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;如果脚本报错，可以根据报错信息检查脚本，如果脚本没有问题，但是短信发不出去，可以看看sms_send_log里面的报错信息</p>
<ol>
<li>nagios 调用脚本，不要忘记脚本要给执行权限，一般脚本放在root目录下，nagios在调用脚本时是不能访问root目录的，所以你还要看你/root目录的权限</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">define <span class="built_in">command</span> &#123;</div><div class="line">       command_name host-notify-by-sms</div><div class="line">       command_line /root/duanxin.sh <span class="variable">$CONTACTPAGER</span>$ <span class="string">"<span class="variable">$HOSTNAME</span>$ <span class="variable">$HOSTSTATE</span>$ <span class="variable">$SHORTDATETIME</span>$"</span></div><div class="line">       &#125;</div><div class="line"></div><div class="line">define <span class="built_in">command</span> &#123;</div><div class="line">       command_name service-notify-by-sms</div><div class="line">       command_line /root/duanxin.sh <span class="variable">$CONTACTPAGER</span>$ <span class="string">"<span class="variable">$SERVICESTATE</span>$ <span class="variable">$SERVICEOUTPUT</span>$ <span class="variable">$HOSTALIAS</span>$/<span class="variable">$SERVICEDESC</span>$ <span class="variable">$SHORTDATETIME</span>$"</span></div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<ol>
<li>看到这里大家可能对上面脚本的$1和$2概念比较模糊，其实刚开始我也迷糊，nagios怎么知道我要发送的号码呢，后来研究发现，$CONTACTPAGER$这个<br>量就是nagios内部联系人的变量，也就是他会调用我们在contacts.cfg里面定义的手机号，而我们脚本里面定义的$1就对应$CONTACTPAGER$，$2就对应”$HOSTNAME$ $HOSTSTATE$ $SHORTDATETIME$” </li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nagios/">Nagios</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Nagios/4. Nagios整合微信订阅号报警" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Nagios/4. Nagios整合微信订阅号报警/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.829Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Nagios/4. Nagios整合微信订阅号报警/">
        Nagios整合微信订阅号报警
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;环境：rhel6.5 selinux 和 iptables 关闭。要求能上外网的（虚拟机亲测可用）</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;以下是nagios服务与微信订阅号的整合过程，最终实现当服务或主机出现故障，自动调用微信报警。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;重点讲述如何配置微信公众平台私有接口，至于nagios服务的配置请大家参照nagios官方文档进行，此处不再赘述。（www.nagios.org）</p>
<h2 id="1-下载微信公众平台私有接口"><a href="#1-下载微信公众平台私有接口" class="headerlink" title="1.下载微信公众平台私有接口"></a>1.下载微信公众平台私有接口</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum install -y git</div><div class="line">git <span class="built_in">clone</span> https://github.com/lealife/WeiXin-Private-API</div></pre></td></tr></table></figure>
<h2 id="2-修改微信公众平台私有接口代码，以配合nagios报警"><a href="#2-修改微信公众平台私有接口代码，以配合nagios报警" class="headerlink" title="2.修改微信公众平台私有接口代码，以配合nagios报警"></a>2.修改微信公众平台私有接口代码，以配合nagios报警</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cp -r WeiXin-Private-API /usr/<span class="built_in">local</span>/nagios/libexec/weixin</div><div class="line">chown -R nagios.nagios /usr/<span class="built_in">local</span>/nagios/libexec/weixin</div><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/nagios/libexec/weixin</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改config.php文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$G_CONFIG</span>[<span class="string">"weiXin"</span>] = array(</div><div class="line"></div><div class="line">        <span class="string">'account'</span> =&gt; <span class="string">'微信公众平台登录帐号'</span>,<span class="comment">#填写你注册的微信订阅号的帐号和密码</span></div><div class="line"></div><div class="line">        <span class="string">'password'</span> =&gt; <span class="string">'微信公众平台登录密码'</span>,</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改test.php文件,只保留如下几行即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">require <span class="string">"config.php"</span>;</div><div class="line">require <span class="string">"include/WeiXin.php"</span>;</div><div class="line"></div><div class="line"><span class="variable">$weiXin</span> = new WeiXin(<span class="variable">$G_CONFIG</span>[<span class="string">'weiXin'</span>]);</div><div class="line"></div><div class="line"><span class="variable">$testFakeId</span> = <span class="string">"<span class="variable">$argv</span>[1]"</span>;<span class="comment">#微信好友ID号，这里通过nagios传入</span></div><div class="line"></div><div class="line"><span class="variable">$msg</span> = `cat /usr/<span class="built_in">local</span>/nagios/var/nagios.msg`;<span class="comment">#要发送的报警信息，由nagios传入</span></div><div class="line"></div><div class="line">print_r(<span class="variable">$weiXin</span>-&gt;send(<span class="variable">$testFakeId</span>, <span class="string">"<span class="variable">$msg</span>"</span>));<span class="comment">#给微信好友发送信息</span></div></pre></td></tr></table></figure>
<h2 id="3-整合nagios和微信公共平台私有接口"><a href="#3-整合nagios和微信公共平台私有接口" class="headerlink" title="3.整合nagios和微信公共平台私有接口"></a>3.整合nagios和微信公共平台私有接口</h2><h3 id="增加微信报警选项-templates-cfg"><a href="#增加微信报警选项-templates-cfg" class="headerlink" title="增加微信报警选项: templates.cfg"></a>增加微信报警选项: templates.cfg</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改 /usr/local/nagios/etc/objects/templates.cfg</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在 define contact{…} 部分,将以下两行:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">host_notification_commands notify-host-by-email</div><div class="line">service_notification_commands notify-service-by-email</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;改为:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">host_notification_commands notify-host-by-email,notify-host-by-weixin</div><div class="line">service_notification_commands notify-service-by-email,notify-service-by-weixin</div></pre></td></tr></table></figure>
<h3 id="增加调用命令-commands-cfg"><a href="#增加调用命令-commands-cfg" class="headerlink" title="增加调用命令: commands.cfg"></a>增加调用命令: commands.cfg</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改 /usr/local/nagios/etc/objects/commands.cfg</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在该文件的最后增加以下部分:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">        <span class="comment">####notify-service-by-weixin</span></div><div class="line">define <span class="built_in">command</span>&#123;</div><div class="line">                command_name notify-service-by-weixin</div><div class="line">                command_line /usr/bin/<span class="built_in">printf</span> <span class="string">"%b"</span> <span class="string">"***** Nagios *****\n\nNotification Type: <span class="variable">$NOTIFICATIONTYPE</span>$\nHost: <span class="variable">$HOSTNAME</span>$\nState: <span class="variable">$HOSTSTATE</span>$\nAddress: <span class="variable">$HOSTADDRESS</span>$\nInfo: <span class="variable">$HOSTOUTPUT</span>$\n\nDate/Time: <span class="variable">$LONGDATETIME</span>$\n"</span> &gt; /usr/<span class="built_in">local</span>/nagios/var/nagios.msg &amp;&amp; /usr/bin/php /usr/<span class="built_in">local</span>/nagios/libexec/weixin/test.php <span class="variable">$CONTACTADDRESS1</span>$  &amp;&gt;/dev/null        </div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">####notify-host-by-weixin        </span></div><div class="line">define <span class="built_in">command</span>&#123;</div><div class="line">                command_name notify-host-by-weixin</div><div class="line">                command_line /usr/bin/<span class="built_in">printf</span> <span class="string">"%b"</span> <span class="string">"***** Nagios *****\n\nNotification Type: <span class="variable">$NOTIFICATIONTYPE</span>$\nHost: <span class="variable">$HOSTNAME</span>$\nState: <span class="variable">$HOSTSTATE</span>$\nAddress: <span class="variable">$HOSTADDRESS</span>$\nInfo: <span class="variable">$HOSTOUTPUT</span>$\n\nDate/Time: <span class="variable">$LONGDATETIME</span>$\n"</span> &gt; /usr/<span class="built_in">local</span>/nagios/var/nagios.msg &amp;&amp; /usr/bin/php /usr/<span class="built_in">local</span>/nagios/libexec/weixin/test.php <span class="variable">$CONTACTADDRESS1</span>$  &amp;&gt;/dev/null        </div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<h3 id="修改联系人选项-contact-cfg"><a href="#修改联系人选项-contact-cfg" class="headerlink" title="修改联系人选项: contact.cfg"></a>修改联系人选项: contact.cfg</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改 /usr/local/nagios/etc/objects/contact.cfg</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在 define contact{…} 部分增加如下一行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">address     11206***<span class="comment">#微信好友ID，登录微信公众平台网页版，在用户管理中点击你要发微信的好友，此时在地址上显示的fakeid就是微信好友的ID。</span></div></pre></td></tr></table></figure>
<h3 id="重载nagios配置"><a href="#重载nagios配置" class="headerlink" title="重载nagios配置"></a>重载nagios配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service nagios reload</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Nagios%E6%95%B4%E5%90%88%E5%BE%AE%E4%BF%A1%E8%AE%A2%E9%98%85%E5%8F%B7%E6%8A%A5%E8%AD%A6/01.png?raw=true" alt=""></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Nagios%E6%95%B4%E5%90%88%E5%BE%AE%E4%BF%A1%E8%AE%A2%E9%98%85%E5%8F%B7%E6%8A%A5%E8%AD%A6/02.png?raw=true" alt=""></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nagios/">Nagios</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Nagios/3. nagios配置邮件告警" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Nagios/3. nagios配置邮件告警/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.828Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Nagios/3. nagios配置邮件告警/">
        nagios配置邮件告警
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;目前 nagios 只能在浏览器上查看各个服务的状态，当某个机器宕掉或者某个服务宕掉时，我们是不知道的，因为我们不可能一直盯着服务器看。这时候，就需要用到警告系统了，让它自动化，当发现问题时及时通知到我们。下面配置使用发邮件的方式来实现告警。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;以下操作都在服务器上完成。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;首先定义发邮件接收者。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nagios ~]<span class="comment"># vim /etc/nagios/objects/contacts.cfg</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;增加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">define contact&#123;</div><div class="line">    contact_name 123</div><div class="line">    use generic-contact</div><div class="line">    <span class="built_in">alias</span> yanyi</div><div class="line">    email 18983111118@189.cn</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">define contact&#123;</div><div class="line">    contact_name 456</div><div class="line">    use generic-contact</div><div class="line">    <span class="built_in">alias</span> aaa</div><div class="line">    email 89429541@qq.com</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">define contactgroup&#123;</div><div class="line">    contactgroup_name common</div><div class="line">    <span class="built_in">alias</span> common</div><div class="line">    members 123,456</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明： contacts.cfg 里面既可以定义 user 也可以定义 group ，先定义两个 user 123 和 456 ，然后把这两个 user 加入到 common 组里面。等会发邮件就发给 common 组就可以了，那这样 18983111118@189.cn 和 89429541@qq.com 都会收到邮件。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后在需要告警的服务里面加上 contactgroup</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nagios ~]<span class="comment"># vim /etc/nagios/conf.d/192.168.0.98.cfg</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;针对 check_load 服务增加告警相关的配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">define service&#123;</div><div class="line">    use generic-service</div><div class="line">    host_name 192.168.0.98</div><div class="line">    service_description check_load</div><div class="line">    check_command check_nrpe!check_load</div><div class="line">    max_check_attempts 5</div><div class="line">    normal_check_interval 1</div><div class="line">    contact_groups common</div><div class="line">    notifications_enabled 1</div><div class="line">    notification_period 24x7</div><div class="line">    notification_options w,u,c,r</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明：notifications_enabled  1  表示是否开启提醒功能。 1 为开启，0 为禁用。一般，这个选项会在主配置文件 （nagios.cfg） 中定义，效果相同。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;notification_period 24×7 表示发送提醒的时间段。非常重要的主机（服务）定义为问题发生，都不会发送提醒。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;notification_options:w,u,c,r 表示 service 的状态。w 为 waning，u 为 unknown，c 为 critical，r 为 recover（恢复了），类似的还有一个 host对应的状态：d,u,r    d 状态为 DOWN，u 状态为 UNREACHABLE，r 状态恢复为 OK，需要加入到 host 的定义配置里。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑完成配置文件后，需要重启 nagios 服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nagios ~]<span class="comment"># service nagios restart</span></div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nagios/">Nagios</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Nagios/2. nagios 监控客户端" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Nagios/2. nagios 监控客户端/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.827Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Nagios/2. nagios 监控客户端/">
        nagios 监控客户端
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在客户端机器阿航安装 epel 扩展源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y epel-release</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;安装 nagios 以及 nagios-plugins</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y nagios-plugins nagios-plugins-all nrpe nagios-plugins-nrpe</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vim /etc/nagios/nrpe.cfg</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;找到 “allowed_hosts=127.0.0.1” 改为 “allowed_hosts=127.0.0.1，192.168.0.62 ” 后面的 ip 为服务端 ip ； 找到 “dont_blame_nrpe=0” 改为 “dont_blam_nrpe=1” </p>
<p><img src="https://github.com/hcldirgit/image/blob/master/nagios%E7%9B%91%E6%8E%A7%E5%AE%A2%E6%88%B7%E7%AB%AF/01.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改为</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/nagios%E7%9B%91%E6%8E%A7%E5%AE%A2%E6%88%B7%E7%AB%AF/02.png?raw=true" alt=""></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/nagios%E7%9B%91%E6%8E%A7%E5%AE%A2%E6%88%B7%E7%AB%AF/03.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改为</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/nagios%E7%9B%91%E6%8E%A7%E5%AE%A2%E6%88%B7%E7%AB%AF/04.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;启动客户端</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/etc/init.d/nrpe start</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;客户端配置好以后，在到服务端继续配置。客户端 ip 为 192.168.0.98，下面定义子配置文件。（以下操作在服务端上完成）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@nagios ~]<span class="comment"># cd /etc/nagios/conf.d/</span></div><div class="line">[root@nagios conf.d]<span class="comment"># vim /192.168.0.98.cfg</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;增加配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">define host&#123;</div><div class="line">    use linux-server</div><div class="line">    host_name 192.168.0.98</div><div class="line">    <span class="built_in">alias</span> 0.98</div><div class="line">    address 192.168.0.98</div><div class="line">&#125;</div><div class="line"></div><div class="line">define service&#123;</div><div class="line">    use generic-service</div><div class="line">    host_name 192.168.0.98</div><div class="line">    service_description check_ping</div><div class="line">    check_command check_ping!100.0,20%!200.0,50%</div><div class="line">    max_check_attempts 5</div><div class="line">    normal_check_interval 1</div><div class="line">&#125;</div><div class="line"></div><div class="line">define service&#123;</div><div class="line">    use generic-service</div><div class="line">    host_name 192.168.0.98</div><div class="line">    service_description check_ssh</div><div class="line">    check_command check_ssh</div><div class="line">    max_check_attempts 5 </div><div class="line">    normal_check_interval 1 </div><div class="line">    notification_interval 60</div><div class="line">&#125;</div><div class="line"></div><div class="line">define service&#123;</div><div class="line">    use generic-service</div><div class="line">    host_name 192.168.0.98</div><div class="line">    service_description check_http</div><div class="line">    check_command check_http</div><div class="line">    max_check_attempts 5</div><div class="line">    normal_check_interval 1</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明：</p>
<ul>
<li>“max_check_attempts  5” ：表示当nagios检测到问题时，一共尝试检测5次都有问题才会告警，如果该数值为1，那么检测到问题立即告警</li>
<li>“normal_check_interval 1”：表示重新检测的时间间隔，单位是分钟，默认是3分钟</li>
<li>“notification_interval 60”：表示在服务出现异常后，故障一直没有解决，nagios再次对使用者发出通知的时间。单位是分钟。如果你认为，所有的事件只需要一次通知就够了，可以把这里的选项设为0。</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;以上服务不依赖于客户端 nrpe 服务，可以想象，在子机电脑上可以使用 ping 或者 telnet 探测远程任何一台机器是否存活、是否开启某个端口或服务。而当想要检测客户端上的某个具体服务的情况时，就需要借助于 nrpe 了，比如想知道客户端机器的负载或磁盘使用情况。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑完成配置文件后，检测配置是否有错</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nagios conf.d]<span class="comment"># nagios -v /etc/nagios/nagios.cfg</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;再服务端重启一下 nagios 服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nagios conf.d]<span class="comment"># service nagios restart</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后在浏览器里访问 nagios ，刷新会发现多出来一台主机，并且多出来三个服务。只不过这三个服务并不是我们想要的，想要监控系统负载，监控磁盘使用率等服务，这时候就要使用 nrpe 服务了。继续在服务端上添加服务。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nagios ~]<span class="comment"># vim /etc/nagios/objects/commands.cfg</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;增加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">define <span class="built_in">command</span>&#123;</div><div class="line">    command_name check_nrpe</div><div class="line">    command_line <span class="variable">$USER1</span>$/check_nrpe -H <span class="variable">$HOSTADDRESS</span>$ -c <span class="variable">$ARG1</span>$</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后继续编辑</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nagios conf.d]<span class="comment"># vim 192.168.0.98.cfg</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;增加内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">define service&#123;</div><div class="line">    use generic-service</div><div class="line">    host_name 192.168.0.98</div><div class="line">    service_description check_load</div><div class="line">    check_command check_nrpe!check_load</div><div class="line">    max_check_attempts 5</div><div class="line">    normal_check_interval 1</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">define service&#123;</div><div class="line">    use generic-service</div><div class="line">    host_name 192.168.0.98</div><div class="line">    service_description check_disk_sda1</div><div class="line">    check_command check_nrpe!check_sda1</div><div class="line">    max_check_attempts 5</div><div class="line">    normal_check_interval 1</div><div class="line">&#125;</div><div class="line"></div><div class="line">define service&#123;</div><div class="line">    use generic-service</div><div class="line">    host_name 192.168.0.98</div><div class="line">    service_description check_disk_sda3</div><div class="line">    check_command check_nrpe!check_sda3</div><div class="line">    max_check_attempts 5</div><div class="line">    normal_check_interval 1</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明：“check_nrpe!check_load” 这里的 check_nrpe 就是在 commands.cfg 刚刚定义的，check_load 是远程主机上的一个检测脚本。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在远程主机上编辑 nrpe.cfg 配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nagios conf.d]<span class="comment"># vim /etc/nagios/nrpe.cfg</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;搜索 check_load ，这行就是在服务器上要执行的脚本了。然后把 check_hda1 更改一下：/dev/hds1 改为 ，/dev/sda1 。</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/nagios%E7%9B%91%E6%8E%A7%E5%AE%A2%E6%88%B7%E7%AB%AF/05.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改为</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/nagios%E7%9B%91%E6%8E%A7%E5%AE%A2%E6%88%B7%E7%AB%AF/06.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;再加一行</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/nagios%E7%9B%91%E6%8E%A7%E5%AE%A2%E6%88%B7%E7%AB%AF/07.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;客户端上重启一下 nrpe 服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@lnmp ~]<span class="comment"># service nrpe restart</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;服务端也重启下 nagios 服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nagios conf.d]<span class="comment"># service nagios restart</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;再到浏览器刷新，会看到又多出来三个服务</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/nagios%E7%9B%91%E6%8E%A7%E5%AE%A2%E6%88%B7%E7%AB%AF/08.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;稍微等一会就可以查看到具体的状态了。</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/nagios%E7%9B%91%E6%8E%A7%E5%AE%A2%E6%88%B7%E7%AB%AF/09.png?raw=true" alt=""></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nagios/">Nagios</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Nagios/1. Nagios 安装" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Nagios/1. Nagios 安装/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.827Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Nagios/1. Nagios 安装/">
        Nagios安装
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<a href="http://nagios.org" target="_blank" rel="external">Nagios官网</a></p>
<h2 id="1-nagios-简介"><a href="#1-nagios-简介" class="headerlink" title="1.nagios 简介"></a>1.nagios 简介</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;nagios 是一个开源软件，可以监控网络设备网络流量、linux/windows 主机状态，甚至可以监控打印机。它可以运行在 linux 上或 windows 上。基于浏览器的 web 界面方便运维人员查看监控项目的状态，支持 web 界面配置、管理操作、支持短信、邮件通知，可以自定义脚本实现自定义化监控。</p>
<h2 id="2-nagios-安装-服务端（192-168-0-62）"><a href="#2-nagios-安装-服务端（192-168-0-62）" class="headerlink" title="2.nagios 安装 - 服务端（192.168.0.62）"></a>2.nagios 安装 - 服务端（192.168.0.62）</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;首先来安装服务器，nagios 同样也是需要 apache + php 的环境，centos 6 默认的 yum 源里没有 nagios 相关的 rpm 包，需要安装一个 epel 的扩展源。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nagios ~]<span class="comment"># yum install -y epel-release</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后安装 nagios 相关的包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nagios ~]<span class="comment"># yum install -y httpd nagios nagios-plugins nagios-plugins-all nrpe nagios-plugins-nrpe</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;设置登录 nagios 后台的用户和密码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@nagios ~]<span class="comment"># htpasswd -c /etc/nagios/passwd nagiosadmin</span></div><div class="line">New password: </div><div class="line">Re-type new password: </div><div class="line">Adding password <span class="keyword">for</span> user nagiosadmin</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;检查配置文件是否有问题</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@nagios ~]<span class="comment"># nagios -v /etc/nagios/nagios.cfg</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/nagios%E5%AE%89%E8%A3%85/01.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明配置文件没有问题</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;启动服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@nagios ~]<span class="comment"># service httpd start</span></div><div class="line">[root@nagios ~]<span class="comment"># service nagios start</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;浏览器访问 <a href="http://ip/nagios" target="_blank" rel="external">http://ip/nagios</a></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/nagios%E5%AE%89%E8%A3%85/03.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;输入设置的帐号密码登录</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/nagios%E5%AE%89%E8%A3%85/02.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;此时，nagios 监控的只有 localhost ，还没有其他机器，要想添加监控客户机，还需要在客户端安装 nagios 相关的软件包，并且需要在服务端配置。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nagios/">Nagios</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-MySQL/9. mysql的root密码重置" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/MySQL/9. mysql的root密码重置/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.824Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/MySQL/9. mysql的root密码重置/">
        mysql的root密码重置
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="mysql设置密码"><a href="#mysql设置密码" class="headerlink" title="mysql设置密码"></a>mysql设置密码</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@lamp ~]<span class="comment"># mysqladmin -uroot password 'yanyi'</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注意：如果mysql已经有密码，该命令要加上 -p</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@lamp ~]<span class="comment"># mysqladmin -uroot -pyanyi password '123456'</span></div></pre></td></tr></table></figure>
<h2 id="碰到mysql-root密码忘记该如何做呢？"><a href="#碰到mysql-root密码忘记该如何做呢？" class="headerlink" title="碰到mysql root密码忘记该如何做呢？"></a>碰到mysql root密码忘记该如何做呢？</h2><h3 id="1-编辑mysql主配置文件my-cnf"><a href="#1-编辑mysql主配置文件my-cnf" class="headerlink" title="1.编辑mysql主配置文件my.cnf"></a>1.编辑mysql主配置文件my.cnf</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@lamp ~]<span class="comment"># vim /etc/my.cnf</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在 [mysql] 字段下添加参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">skip-grant</div></pre></td></tr></table></figure>
<h3 id="2-重启数据库服务"><a href="#2-重启数据库服务" class="headerlink" title="2.重启数据库服务"></a>2.重启数据库服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@lamp ~]<span class="comment"># service mysqld restart</span></div></pre></td></tr></table></figure>
<h3 id="3-进入mysql数据库（此时数据库不用授权）"><a href="#3-进入mysql数据库（此时数据库不用授权）" class="headerlink" title="3.进入mysql数据库（此时数据库不用授权）"></a>3.进入mysql数据库（此时数据库不用授权）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@lamp ~]<span class="comment"># /usr/local/mysql/bin/mysql -uroot</span></div></pre></td></tr></table></figure>
<h3 id="4-修改相应的用户密码"><a href="#4-修改相应的用户密码" class="headerlink" title="4.修改相应的用户密码"></a>4.修改相应的用户密码</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;使用mysql库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; use mysql;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;更新一个表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mysql&gt; update user <span class="built_in">set</span> password=password(<span class="string">'yanyi'</span>) <span class="built_in">where</span> user=<span class="string">'root'</span>;</div><div class="line">mysql&gt; select * from user <span class="built_in">where</span> user=<span class="string">'root'</span>\G;</div><div class="line">mysql&gt; flush privileges;</div><div class="line">mysql&gt; quit;</div></pre></td></tr></table></figure>
<h3 id="5-修改-etc-my-cnf去掉skip-grant，重启mysql服务"><a href="#5-修改-etc-my-cnf去掉skip-grant，重启mysql服务" class="headerlink" title="5.修改/etc/my.cnf去掉skip-grant，重启mysql服务"></a>5.修改/etc/my.cnf去掉skip-grant，重启mysql服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@lamp ~]<span class="comment"># vim /etc/my.cnf</span></div><div class="line">[root@lamp ~]<span class="comment"># service mysqld restart</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这样就可以用新密码登录了</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/mysql%E7%9A%84root%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE/01.png?raw=true" alt=""></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-MySQL/8. 关于mysql一些优化心得" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/MySQL/8. 关于mysql一些优化心得/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.821Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/MySQL/8. 关于mysql一些优化心得/">
        关于mysql一些优化心得
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>先介绍下服务器架构及配置8核8G，10M带宽Centos6.5 64</strong></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>Nginx&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;1.8.1PHP   &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;5.3.29Mysql&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;5.5.42</strong></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;一电商网站后台查询订单时 经常php超时，导致php报错以下是排查过程</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;一、php执行超时，首先我们想到的就是php.ini文件中max_execution_time =  #把默认的值调整了下</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;二、然后在后台执行订单查询php不报错了，但是查询耗时较长，用时65s.  而且一些表成锁死状态碎片比较多，本人对mysql数据库优化不是很了解，于是百度了一下：一般mysql调优主要是根据慢查询日志去优化sql语句，my.cnf里面没啥可调的。 下面就是分析mysql慢日志,调整参数3、mysql参数优化，主要调整的参数如下。根据机器性能来调整，如果你对参数不是很了解，建议不要盲目的调</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;把一些配置文件修改好后重启相关服务，由原来的65s变成了十几秒。效果还是不是很理想，查看了下mysql默认引擎为MyISAM，决定把引擎改为Innodb</p>
<ol>
<li>导出shop数据库的表结构</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysqldump -d -uxxx -p shop &gt; shop_table.sql</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;其中-d参数表示不导出数据，只导出表结构</p>
<ol>
<li>替换shop_table.sql里的MyISAM为INNODB</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sed -i <span class="string">'s/MyISAM/INNODB/g'</span> shop_table.sql</div></pre></td></tr></table></figure>
<ol>
<li>新建数据库shop_new,并导入表结构</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql &gt; create database shop_new;mysql -uroot -p shop_new &lt; shop_table.sql</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;可以通过show table status来检查表引擎是否为INNODB。</p>
<ol>
<li>导出shop的数据</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysqldump -t -uroot -p shop &gt; shop_data.sql</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;其中-t参数表示只导数据，不导表结构</p>
<ol>
<li>导入数据到</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shop_newmysql -uroot -p shop_new &lt; shop_data.sql</div></pre></td></tr></table></figure>
<ol>
<li>首先开启慢日志，修改/etc/my.cnf  增加以下两段配置，保存重启mysql</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">vim /etc/my.cnf</div><div class="line"></div><div class="line">long_query_time = 2</div><div class="line">log_slow_queries = /data/mysql/slow.log</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;重启mysql服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service mysqld restart</div></pre></td></tr></table></figure>
<ol>
<li>查看慢日志来定位mysql哪条语句执行慢，然后建立索引，优化sql执行语句。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;font color=<span class="string">"Red"</span>&gt;tail -n20 /data/mysql/slow.log <span class="comment">#查看20行&lt;/font&gt;</span></div><div class="line"> </div><div class="line"> </div><div class="line"> <span class="comment"># Time: 160303 12:12:38</span></div><div class="line"> <span class="comment"># User@Host: root[root] @ [10.165.34.182]</span></div><div class="line"> <span class="comment"># Query_time: 10.145685 Lock_time: 0.000395 Rows_sent: 1 Rows_examined: 24306970</span></div><div class="line"> use shop;</div><div class="line">SET timestamp=1456978358;</div><div class="line"> SELECT COUNT(*) FROM `shop`.`ecs_order_info` o LEFT JOIN`shop`.`ecs_users` u ON o.user_id = u.user_id LEFT JOIN `shop`.`ecs_affiliate_log` a ON o.order_id = a.order_id WHERE o.user_id &gt; 0 AND (u.parent_id &gt; 0 AND o.is_separate = 0 OR o.is_separate &gt; 0);</div><div class="line"> <span class="comment"># Time: 160303 12:12:44</span></div><div class="line"> <span class="comment"># User@Host: root[root] @ [10.165.34.182]</span></div><div class="line"> <span class="comment"># Query_time: 6.073441 Lock_time: 0.000152 Rows_sent: 15 Rows_examined: 24314767</span></div><div class="line">SET timestamp=1456978364;</div><div class="line">SELECT o.*, a.log_id, a.user_id as suid, a.user_name as auser, a.money, a.point, a.separate_type,u.parent_id as up FROM `shop`.`ecs_order_info` o LEFT JOIN`shop`.`ecs_users` u ON o.user_id = u.user_id LEFT JOIN `shop`.`ecs_affiliate_log` a ON o.order_id = a.order_id WHERE o.user_id &gt; 0 AND (u.parent_id &gt; 0 AND o.is_separate = 0 OR o.is_separate &gt; 0) ORDER BY order_id DESC LIMIT 0,15;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;通过慢日志发现其中有几个表查询耗时较长，下面就是把这个查询慢的表建立索引</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;用到的软件 NAvicat，对查询慢的表进行设计，增加索引</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E5%85%B3%E4%BA%8Emysql%E4%B8%80%E4%BA%9B%E4%BC%98%E5%8C%96%E5%BF%83%E5%BE%97/01.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;根据 explain 的解释，查看下索引是否建立，一般都是这样调整就行。</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E5%85%B3%E4%BA%8Emysql%E4%B8%80%E4%BA%9B%E4%BC%98%E5%8C%96%E5%BF%83%E5%BE%97/02.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改完后重启 mysql 服务，查询时间从65s,缩短到 0.017407 秒</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E5%85%B3%E4%BA%8Emysql%E4%B8%80%E4%BA%9B%E4%BC%98%E5%8C%96%E5%BF%83%E5%BE%97/03.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;参考了大量的网络资料，头一次搞优化。优化完后很有成就感，算是一次新的挑战</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/16/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="page-number" href="/page/16/">16</a><span class="page-number current">17</span><a class="page-number" href="/page/18/">18</a><a class="page-number" href="/page/19/">19</a><span class="space">&hellip;</span><a class="page-number" href="/page/63/">63</a><a class="extend next" rel="next" href="/page/18/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2017 失落的乐章
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/smackgg/hexo-theme-smackdown" target="_blank">Smackdown</a>
        </div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="/js/main.js"></script>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js"></script>


  </div>
</body>
</html>