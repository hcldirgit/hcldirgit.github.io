<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>失落的乐章</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="失落的乐章的Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="失落的乐章">
<meta property="og:url" content="https://hcldirgit.github.io/page/61/index.html">
<meta property="og:site_name" content="失落的乐章">
<meta property="og:description" content="失落的乐章的Blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="失落的乐章">
<meta name="twitter:description" content="失落的乐章的Blog">
  
    <link rel="alternative" href="/atom.xml" title="失落的乐章" type="application/atom+xml">
  
  
    <link rel="icon" href="https://github.com/hcldirgit/image/blob/master/0.png?raw=true">
  
  <link rel="stylesheet" href="/css/style.css">
  
  
<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-85415703-1', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  <script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>
  <script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>

  
</head>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://github.com/hcldirgit/image/blob/master/0.png?raw=true" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">失落的乐章</a></h1>
		</hgroup>

		
		<p class="header-subtitle">技术面前，永远都是学生。</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/tags">静心阅读</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Ansible/" style="font-size: 10.42px;">Ansible</a> <a href="/tags/Apache/" style="font-size: 18.33px;">Apache</a> <a href="/tags/Cacti/" style="font-size: 11.67px;">Cacti</a> <a href="/tags/DNS/" style="font-size: 13.33px;">DNS</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/FTP/" style="font-size: 11.25px;">FTP</a> <a href="/tags/Git/" style="font-size: 10.83px;">Git</a> <a href="/tags/HA集群/" style="font-size: 11.67px;">HA集群</a> <a href="/tags/Hadoop/" style="font-size: 12.5px;">Hadoop</a> <a href="/tags/Jenkins/" style="font-size: 10.42px;">Jenkins</a> <a href="/tags/LAMP/" style="font-size: 19.58px;">LAMP</a> <a href="/tags/LNMP/" style="font-size: 17.08px;">LNMP</a> <a href="/tags/LVS/" style="font-size: 16.67px;">LVS</a> <a href="/tags/Linux/" style="font-size: 19.17px;">Linux</a> <a href="/tags/Linux命令/" style="font-size: 20px;">Linux命令</a> <a href="/tags/Linux安全/" style="font-size: 14.17px;">Linux安全</a> <a href="/tags/Memcached/" style="font-size: 11.25px;">Memcached</a> <a href="/tags/MongoDB/" style="font-size: 15.42px;">MongoDB</a> <a href="/tags/MySQL/" style="font-size: 17.5px;">MySQL</a> <a href="/tags/NFS/" style="font-size: 10px;">NFS</a> <a href="/tags/Nagios/" style="font-size: 11.67px;">Nagios</a> <a href="/tags/Nginx/" style="font-size: 17.92px;">Nginx</a> <a href="/tags/OpenStack/" style="font-size: 11.25px;">OpenStack</a> <a href="/tags/Php/" style="font-size: 14.58px;">Php</a> <a href="/tags/Puppet/" style="font-size: 11.25px;">Puppet</a> <a href="/tags/Python/" style="font-size: 14.58px;">Python</a> <a href="/tags/Redis/" style="font-size: 16.25px;">Redis</a> <a href="/tags/Resin/" style="font-size: 10px;">Resin</a> <a href="/tags/Saltstack/" style="font-size: 10px;">Saltstack</a> <a href="/tags/Samba/" style="font-size: 12.08px;">Samba</a> <a href="/tags/Squid/" style="font-size: 14.58px;">Squid</a> <a href="/tags/Tomcat/" style="font-size: 13.75px;">Tomcat</a> <a href="/tags/Zabbix/" style="font-size: 15.83px;">Zabbix</a> <a href="/tags/haproxy/" style="font-size: 12.5px;">haproxy</a> <a href="/tags/keepalived/" style="font-size: 12.92px;">keepalived</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/shell练习/" style="font-size: 18.75px;">shell练习</a> <a href="/tags/正则表达式/" style="font-size: 12.92px;">正则表达式</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">失落的乐章</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="https://github.com/hcldirgit/image/blob/master/0.png?raw=true" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">失落的乐章</h1>
			</hgroup>
			
			<p class="header-subtitle">技术面前，永远都是学生。</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/tags">静心阅读</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-Shell 练习/11. shell 练习-自动重启php-fpm" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/08/31/Shell 练习/11. shell 练习-自动重启php-fpm/" class="article-date">
  	<time datetime="2017-08-30T16:07:07.486Z" itemprop="datePublished">2017-08-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/31/Shell 练习/11. shell 练习-自动重启php-fpm/">
        shell 练习-自动重启php-fpm
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>服务器上跑的是LNMP环境，近期总是有502现象。502为网站访问的状态码，200正常，502错误是nginx最为普通的错误状态码。由于502只是暂时的，并且只要一重启php-fpm服务则502消失，但不重启的话，则会一直持续很长时间。所以有必要写一个监控脚本，监控访问日志的状态码，一旦发生502，则自动重启一下php-fpm。</p>
<p>我们设定： </p>
<ol>
<li>access_log  /data1/log/access.log</li>
<li>脚本死循环，每10s检测一次 （假设每10s钟的日志条数为300左右）</li>
<li>重启php-fpm的方法是  /etc/init.d/php-fpm restart</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#! /bin/bash</span></div><div class="line"><span class="built_in">log</span>=/data1/<span class="built_in">log</span>/access.log</div><div class="line">N=10</div><div class="line"><span class="keyword">while</span> :; <span class="keyword">do</span></div><div class="line">    <span class="comment">##因为10秒钟大概产生300条日志</span></div><div class="line">    tail -n 300 <span class="variable">$log</span> &gt; /tmp/<span class="built_in">log</span></div><div class="line">    n_502=`grep -c <span class="string">' 502"'</span> /tmp/<span class="built_in">log</span>`</div><div class="line">    <span class="keyword">if</span> [ <span class="variable">$n_502</span> -ge <span class="variable">$N</span> ]; <span class="keyword">then</span></div><div class="line">        <span class="comment">##记录系统的状态</span></div><div class="line">        top -bn1 &amp;gt;/tmp/`date +%H%M%S`-top.log</div><div class="line">        vmstat 1 5 &amp;gt;/tmp/`date +%H%M%S`-vm.log</div><div class="line">        /etc/init.d/php-fpm restart 2&amp;gt; /dev/null</div><div class="line">        <span class="comment">##重启php-fpm服务后，应先暂缓1分钟，而后继续每隔10s检测一次</span></div><div class="line">        sleep 60</div><div class="line">    <span class="keyword">fi</span></div><div class="line">    sleep 10</div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/shell练习/">shell练习</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Shell 练习/10. shell 练习-每天删除两天前的文件" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/08/31/Shell 练习/10. shell 练习-每天删除两天前的文件/" class="article-date">
  	<time datetime="2017-08-30T16:07:07.485Z" itemprop="datePublished">2017-08-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/31/Shell 练习/10. shell 练习-每天删除两天前的文件/">
        shell 练习-每天删除两天前的文件
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>web服务器上有个目录，它的结构是这样的，首先有256个一级子目录和一个特殊目录，另外这256个一级子目录下还有256个二级子目录（特殊目录除外）。在这些二级子目录下有很多小文件，而且是每时每刻都会生成很多个。 虽然文件不大，但是时间长了，逐渐发现该分区的下inode快被占用满了。 所以请写一个小脚本，实现每天删除两天前的小文件，注意忽略那个特殊的一级子目录default。</p>
<p>目录： /data/web/abc/    </p>
<blockquote>
<p>三级子目录： 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 10 11 12 13 14 15 16 17 18 19 1a 1b 1c 1d 1e 1f 20 21 22 23 24 25 26 27 28 29 2a 2b 2c 2d 2e 2f 30 31 32 33 34 35 36 37 38 39 3a 3b 3c 3d 3e 3f 40 41 42 43 44 45 46 47 48 49 4a 4b 4c 4d 4e 4f 50 51 52 53 54 55 56 57 58 59 5a 5b 5c 5d 5e 5f 60 61 62 63 64 65 66 67 68 69 6a 6b 6c 6d 6e 6f 70 71 72 73 74 75 76 77 78 79 7a 7b 7c 7d 7e 7f 80 81 82 83 84 85 86 87 88 89 8a 8b 8c 8d 8e 8f 90 91 92 93 94 95 96 97 98 99 9a 9b 9c 9d 9e 9f a0 a1 a2 a3 a4 a5 a6 a7 a8 a9 aa ab ac ad ae af b0 b1 b2 b3 b4 b5 b6 b7 b8 b9 ba bb bc bd be bf c0 c1 c2 c3 c4 c5 c6 c7 c8 c9 ca cb cc cd ce cf d0 d1 d2 d3 d4 d5 d6 d7 d8 d9 da db dc dd de default df e0 e1 e2 e3 e4 e5 e6 e7 e8 e9 ea eb ec ed ee ef f0 f1 f2 f3 f4 f5 f6 f7 f8 f9 fa fb fc fd fe ff  （三级子目录下没有default目录）</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#! /bin/bash</span></div><div class="line"><span class="built_in">cd</span> /data/web/abc</div><div class="line"><span class="keyword">for</span> f <span class="keyword">in</span> `ls |grep -v default`; <span class="keyword">do</span></div><div class="line">    <span class="keyword">for</span> f1 <span class="keyword">in</span> `ls <span class="variable">$f</span>`; <span class="keyword">do</span></div><div class="line">        find <span class="variable">$f</span>/<span class="variable">$f1</span> -<span class="built_in">type</span> f -mtime +2|xargs rm -f</div><div class="line">    <span class="keyword">done</span></div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/shell练习/">shell练习</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Shell 练习/9. shell 练习-日志汇总" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/08/31/Shell 练习/9. shell 练习-日志汇总/" class="article-date">
  	<time datetime="2017-08-30T16:07:07.484Z" itemprop="datePublished">2017-08-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/31/Shell 练习/9. shell 练习-日志汇总/">
        shell 练习-日志汇总
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>我有一个日志（php的slow_log) 几乎每分钟都有输出信息。需要我们来写个脚本分析一下它，目的就是为了归类汇总，按照它们出现的频次做个排序，假如日志是每天0点5分清空，那么按照每小时一次汇总分析该日志，最后在第二天0点0分时，再汇总一下整天的日志，怎么写呢？ 下面我给出一个日志样例和我写的分析汇总脚本供参考。日志样例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">[24-Oct-2013 00:05:39]  [pool www.lishiming.net] pid 19101</div><div class="line">script_filename = /data/release/www.lishiming.net/forum.php</div><div class="line">[0x00007f9279237e98] mysql_unbuffered_query() /data/release/www.lishiming.net/<span class="built_in">source</span>/class/db/db_driver_mysql.php:147</div><div class="line">[0x00007f92792377a8] query() /data/release/www.lishiming.net/<span class="built_in">source</span>/class/discuz/discuz_database.php:136</div><div class="line">[0x00007f9279236f40] query() /data/release/www.lishiming.net/<span class="built_in">source</span>/class/table/table_forum_thread.php:932</div><div class="line">[0x00007f92792365e8] increase() /data/release/www.lishiming.net/<span class="built_in">source</span>/module/forum/forum_viewthread.php:1034</div><div class="line">[0x00007f9279218f48] viewthread_updateviews() /data/release/www.lishiming.net/<span class="built_in">source</span>/module/forum/forum_viewthread.php:353</div><div class="line">[0x00007f9279218050] +++ dump failed</div><div class="line"></div><div class="line">[24-Oct-2013 00:05:39]  [pool www.lishiming.net] pid 19754</div><div class="line">script_filename = /data/release/www.lishiming.net/forum.php</div><div class="line">[0x00007f9279237938] mysql_query() /data/release/www.lishiming.net/<span class="built_in">source</span>/class/db/db_driver_mysql.php:147</div><div class="line">[0x00007f9279237248] query() /data/release/www.lishiming.net/<span class="built_in">source</span>/class/discuz/discuz_database.php:136</div><div class="line">[0x00007f9279236dc0] query() /data/release/www.lishiming.net/<span class="built_in">source</span>/class/discuz/discuz_database.php:100</div><div class="line">[0x00007f9279235d48] fetch_all() /data/release/www.lishiming.net/<span class="built_in">source</span>/class/table/table_forum_thread.php:523</div><div class="line">[0x00007f9279218f48] fetch_all_search() /data/release/www.lishiming.net/<span class="built_in">source</span>/module/forum/forum_forumdisplay.php:637</div><div class="line">[0x00007f9279218050] +++ dump failed</div><div class="line"></div><div class="line">[24-Oct-2013 00:06:07]  [pool www.lishiming.net] pid 22624</div><div class="line">script_filename = /data/release/www.lishiming.net/forum.php</div><div class="line">[0x00007f9279237938] mysql_query() /data/release/www.lishiming.net/<span class="built_in">source</span>/class/db/db_driver_mysql.php:147</div><div class="line">[0x00007f9279237248] query() /data/release/www.lishiming.net/<span class="built_in">source</span>/class/discuz/discuz_database.php:136</div><div class="line">[0x00007f9279236dc0] query() /data/release/www.lishiming.net/<span class="built_in">source</span>/class/discuz/discuz_database.php:100</div><div class="line">[0x00007f9279235d48] fetch_all() /data/release/www.lishiming.net/<span class="built_in">source</span>/class/table/table_forum_thread.php:523</div><div class="line">[0x00007f9279218f48] fetch_all_search() /data/release/www.lishiming.net/<span class="built_in">source</span>/module/forum/forum_forumdisplay.php:637</div><div class="line">[0x00007f9279218050] +++ dump failed</div><div class="line"></div><div class="line">[24-Oct-2013 00:06:18]  [pool www.lishiming.net] pid 22624</div><div class="line">script_filename = /data/release/www.lishiming.net/forum.php</div><div class="line">[0x00007f9279237938] mysql_query() /data/release/www.lishiming.net/<span class="built_in">source</span>/class/db/db_driver_mysql.php:147</div><div class="line">[0x00007f9279237248] query() /data/release/www.lishiming.net/<span class="built_in">source</span>/class/discuz/discuz_database.php:136</div><div class="line">[0x00007f9279236dc0] query() /data/release/www.lishiming.net/<span class="built_in">source</span>/class/discuz/discuz_database.php:100</div><div class="line">[0x00007f9279235d48] fetch_all() /data/release/www.lishiming.net/<span class="built_in">source</span>/class/table/table_forum_thread.php:523</div><div class="line">[0x00007f9279218f48] fetch_all_search() /data/release/www.lishiming.net/<span class="built_in">source</span>/module/forum/forum_forumdisplay.php:637</div><div class="line">[0x00007f9279218050] +++ dump failed</div></pre></td></tr></table></figure>
<p>脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#! /bin/bash </span></div><div class="line"></div><div class="line">slow_log=/usr/<span class="built_in">local</span>/php/<span class="built_in">log</span>/php.slow</div><div class="line"></div><div class="line">d=`date -d <span class="string">"-1 minute"</span> +%H:%M`</div><div class="line"></div><div class="line">d_h=`date +%H`</div><div class="line"></div><div class="line">d_m=`date +%M`</div><div class="line"></div><div class="line">d_d=`date +%Y%d`</div><div class="line"></div><div class="line">d_d2=`date -d <span class="string">"-1 day"</span> +%Y%d`</div><div class="line"></div><div class="line">logdir=<span class="string">"/log/php_slow/<span class="variable">$d_d</span>"</span></div><div class="line"></div><div class="line">logdir2=<span class="string">"/log/php_slow/<span class="variable">$d_d2</span>"</span></div><div class="line"></div><div class="line">[ -d <span class="variable">$logdir</span> ] || mkdir -p <span class="variable">$logdir</span></div><div class="line"></div><div class="line">[ -d <span class="variable">$logdir2</span> ] || mkdir -p <span class="variable">$logdir2</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> [ <span class="variable">$d_m</span> -eq <span class="string">"00"</span> ]; <span class="keyword">then</span> </div><div class="line"></div><div class="line">    d1=`date -d <span class="string">"-1 hour"</span> +%H`</div><div class="line"></div><div class="line">    n1=`grep -n <span class="string">" <span class="variable">$d1</span>:[0-9][0-9]:"</span> <span class="variable">$slow_log</span>|head -n1 |awk -F<span class="string">':'</span> <span class="string">'&#123;print $1&#125;'</span>`</div><div class="line"></div><div class="line">    n2=`wc -l <span class="variable">$slow_log</span> |awk <span class="string">'&#123;print $1&#125;'</span>`</div><div class="line"></div><div class="line">    n3=$[<span class="variable">$n2</span>-<span class="variable">$n1</span>]</div><div class="line"></div><div class="line">    tail -n <span class="variable">$n3</span> <span class="variable">$slow_log</span>&gt;/tmp/1.txt</div><div class="line"></div><div class="line">    sed <span class="string">'s/\[0x.*\]//g'</span> /tmp/1.txt |xargs &gt; /tmp/2.txt</div><div class="line"></div><div class="line">    n=`grep <span class="string">'\[pool'</span> /tmp/1.txt|wc -l`</div><div class="line"></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> `seq 1 <span class="variable">$n</span>`; <span class="keyword">do</span> awk -F <span class="string">'+++ dump failed'</span> <span class="string">'&#123;print $'</span><span class="string">"<span class="variable">$i</span>"</span><span class="string">'&#125;'</span> /tmp/2.txt; <span class="keyword">done</span> &gt; /tmp/3.txt</div><div class="line"></div><div class="line">    <span class="keyword">if</span> [ <span class="variable">$d_h</span> -ne <span class="string">"00"</span> ]; <span class="keyword">then</span></div><div class="line"></div><div class="line">        sed <span class="string">'s/^.*script_filename = //'</span> /tmp/3.txt |grep -v <span class="string">'^$'</span>|sort |uniq -c |sort -rn &gt; <span class="variable">$logdir</span>/<span class="variable">$d1</span>\_slow_log</div><div class="line"></div><div class="line">    <span class="keyword">else</span></div><div class="line"></div><div class="line">        sed <span class="string">'s/^.*script_filename = //'</span> /tmp/3.txt |grep -v <span class="string">'^$'</span>|sort |uniq -c |sort -rn &gt; <span class="variable">$logdir2</span>/<span class="variable">$d1</span>\_slow_log</div><div class="line"></div><div class="line">        sed <span class="string">'s/^.*[0-9] \//\//'</span> <span class="variable">$logdir2</span>/*_log |sort |uniq -c |sort -rn &gt; <span class="variable">$logdir2</span>/<span class="variable">$d_d2</span>\_slow_log</div><div class="line"></div><div class="line">    <span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="keyword">fi</span></div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/shell练习/">shell练习</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Shell 练习/8. shell 练习" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/08/31/Shell 练习/8. shell 练习/" class="article-date">
  	<time datetime="2017-08-30T16:07:07.483Z" itemprop="datePublished">2017-08-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/31/Shell 练习/8. shell 练习/">
        shell 练习8
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>需求： 两台web:A和B机器，其中一台B只打算跑附件（大多为图片），另一台A跑除了附件外的其他东西。其中附件会在A上生成，默认附件会通过A机器访问，但当我们更改某个附件的标志位时，那么附件则会跑到B上去访问。 假如提供给我们了将要在B上跑的附件列表和更改这些附件的标志位的一个sql文件，那么我们如何做呢？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#! /bin/bash</span></div><div class="line"><span class="comment">## 1. rsync att to remote server.</span></div><div class="line"><span class="comment">## 2. execute the sql for changing tag 0 to 1.</span></div><div class="line"><span class="comment">## 3. delete the file att_list and sql.</span></div><div class="line">base_dir=/data/wwwroot/bbs.xxx.com/data</div><div class="line">r_dir=160.11.274.32::img</div><div class="line">d=`date +%Y%m%d`</div><div class="line"><span class="comment">#文件列表的文件</span></div><div class="line">f_list=<span class="variable">$base_dir</span>/attachment_move_list.php   </div><div class="line"><span class="comment">#更改附件标志位的sql文件</span></div><div class="line">f_sql=<span class="variable">$base_dir</span>/attachment_move_sql.php  更改附件标志位的sql文件</div><div class="line">file_dir=<span class="variable">$base_dir</span>/oldatt_list_sql</div><div class="line"><span class="keyword">if</span> [ ! -d <span class="variable">$file_dir</span> ] ; <span class="keyword">then</span></div><div class="line">    mkdir <span class="variable">$file_dir</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">if</span> [ ! -f <span class="variable">$f_list</span> ] || [ ! -f <span class="variable">$f_sql</span> ]; <span class="keyword">then</span></div><div class="line">    <span class="built_in">exit</span></div><div class="line"><span class="keyword">fi</span></div><div class="line">grep -v <span class="string">'exit()'</span> <span class="variable">$f_list</span> |sed <span class="string">'s#/data/wwwroot/bbs.xxx.com/data/attachment/forum#.#'</span>  &gt; /tmp/1.txt</div><div class="line"><span class="built_in">cd</span> <span class="variable">$base_dir</span>/attachment/forum</div><div class="line">rsync -aL --files-from=/tmp/1.txt ./ <span class="variable">$r_dir</span>/</div><div class="line">/bin/mv <span class="variable">$f_list</span> <span class="variable">$file_dir</span>/<span class="variable">$d</span>.list</div><div class="line">grep -v <span class="string">'exit()'</span> <span class="variable">$f_sql</span> &lt; /tmp/2.txt</div><div class="line">mysql -h192.168.1.11 -uuser -p<span class="string">'passwd'</span> bbs &amp;lt; /tmp/2.txt</div><div class="line">/bin/mv <span class="variable">$f_sql</span> <span class="variable">$file_dir</span>/<span class="variable">$d</span>.sql</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/shell练习/">shell练习</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Shell 练习/7. shell 练习-备份数据库" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/08/31/Shell 练习/7. shell 练习-备份数据库/" class="article-date">
  	<time datetime="2017-08-30T16:07:07.482Z" itemprop="datePublished">2017-08-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/31/Shell 练习/7. shell 练习-备份数据库/">
        shell 练习-备份数据库
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>设计一个shell脚本来备份数据库，首先在本地服务器上保存一份数据，然后再远程拷贝一份，本地保存一周的数据，远程保存一个月。<br>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;假定，我们知道mysql root账号的密码，要备份的库为discuz，本地备份目录为/bak/mysql, 远程服务器ip为192.168.123.30，远程提供了一个rsync服务，备份的地址是 192.168.123.30::backup  . 写完脚本后，需要加入到cron中，每天凌晨3点执行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="comment">##backup mysql</span></div><div class="line"><span class="comment">##writen by yanyi</span></div><div class="line"></div><div class="line">PATH=<span class="variable">$PATH</span>:/usr/<span class="built_in">local</span>/mysql/bin</div><div class="line">bakdir=/bak/mysql</div><div class="line">r_bakdir=192.168.123.30:backup</div><div class="line">d1=`date +%w`</div><div class="line">d2=`date +%d`</div><div class="line">passwd=<span class="string">"mysql_password"</span></div><div class="line"></div><div class="line"><span class="built_in">exec</span> 1&gt; /var/<span class="built_in">log</span>/mysqlbak.log 2&gt;/var/<span class="built_in">log</span>/mysqlbak.log</div><div class="line"><span class="built_in">echo</span> <span class="string">"mysql backup begin at `date +"</span>%F %T<span class="string">"`."</span></div><div class="line">mysqldump -uroot -p<span class="variable">$passwd</span> --default-character=gbk discuz &gt; <span class="variable">$d1</span>.sql</div><div class="line">rsync -a <span class="variable">$bakdir</span>/<span class="variable">$d1</span>.sql <span class="variable">$r_bakdir</span>/<span class="variable">$d2</span>.sql</div><div class="line"><span class="built_in">echo</span> <span class="string">"mysql backup end at `date +"</span>%F %T<span class="string">"`."</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后加入cron</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">0 3 * * *  /bin/bash  /usr/<span class="built_in">local</span>/sbin/mysqlbak.sh</div></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/shell练习/">shell练习</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Shell 练习/6. shell 练习-判断80端口是否开启" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/08/31/Shell 练习/6. shell 练习-判断80端口是否开启/" class="article-date">
  	<time datetime="2017-08-30T16:07:07.481Z" itemprop="datePublished">2017-08-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/31/Shell 练习/6. shell 练习-判断80端口是否开启/">
        shell 练习-判断80端口是否开启
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>写一个脚本，判断本机的80端口是否开启着，如果开启着什么都不做，如果发现端口不存在，那么重启一下httpd服务，并发邮件通知你自己。脚本写好后，可以每一分钟执行一次，也可以写一个死循环的脚本，30s检测一次。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">mail=123@123.com</div><div class="line"><span class="keyword">if</span> netstat -lnp|grep <span class="string">':80'</span>|grep -q <span class="string">'LISTEN'</span></div><div class="line"><span class="keyword">then</span></div><div class="line">    <span class="built_in">exit</span></div><div class="line"><span class="keyword">else</span></div><div class="line">    /usr/<span class="built_in">local</span>/apache2/bin/apachectl restart &gt; /dev/null 2&gt; /dev/null</div><div class="line">    <span class="built_in">echo</span> <span class="string">"The 80 port is down."</span>|mail -s <span class="string">'check_80'</span> <span class="variable">$mail</span></div><div class="line">    n=`pa aux|grep httpd|grep -cv grep`</div><div class="line">    <span class="keyword">if</span> [<span class="variable">$n</span> -eq 0 ]</div><div class="line">    <span class="keyword">then</span></div><div class="line">        /usr/<span class="built_in">local</span>/apache2/bin/apachectl start 2&gt; tmp/apache_start.err</div><div class="line">    <span class="keyword">fi</span></div><div class="line">    <span class="keyword">if</span> [ -s /tmp/apache_start.err ]</div><div class="line">    <span class="keyword">then</span></div><div class="line">        mail -s <span class="string">'apache_start_error'</span> <span class="variable">$mail</span> &lt; /tmp/apache_start.err</div><div class="line">    <span class="keyword">fi</span></div><div class="line"><span class="keyword">fi</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;脚本用 crontab -e 加入任务计划，每分钟执行一次     </p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;也可以用 while 死循环</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">mail=123@123.com</div><div class="line"><span class="keyword">while</span> :</div><div class="line"><span class="keyword">do</span></div><div class="line">    <span class="keyword">if</span> netstat -lnp|grep <span class="string">':80'</span>|grep -q <span class="string">'LISTEN'</span></div><div class="line">    <span class="keyword">then</span></div><div class="line">        <span class="built_in">exit</span></div><div class="line">    <span class="keyword">else</span></div><div class="line">        /usr/<span class="built_in">local</span>/apache2/bin/apachectl restart &gt; /dev/null 2&gt; /dev/null</div><div class="line">        <span class="built_in">echo</span> <span class="string">"The 80 port is down."</span>|mail -s <span class="string">'check_80'</span> <span class="variable">$mail</span></div><div class="line">        n=`pa aux|grep httpd|grep -cv grep`</div><div class="line">        <span class="keyword">if</span> [<span class="variable">$n</span> -eq 0 ]</div><div class="line">        <span class="keyword">then</span></div><div class="line">            /usr/<span class="built_in">local</span>/apache2/bin/apachectl start 2&gt; tmp/apache_start.err</div><div class="line">        <span class="keyword">fi</span></div><div class="line">        <span class="keyword">if</span> [ -s /tmp/apache_start.err ]</div><div class="line">        <span class="keyword">then</span></div><div class="line">            mail -s <span class="string">'apache_start_error'</span> <span class="variable">$mail</span> &lt; /tmp/apache_start.err</div><div class="line">        <span class="keyword">fi</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line">    sleep 30</div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/shell练习/">shell练习</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Shell 练习/5. shell 练习-还原 .bak备份文件" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/08/31/Shell 练习/5. shell 练习-还原 .bak备份文件/" class="article-date">
  	<time datetime="2017-08-30T16:07:07.480Z" itemprop="datePublished">2017-08-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/31/Shell 练习/5. shell 练习-还原 .bak备份文件/">
        shell 练习-还原 .bak备份文件
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在你的/root 目录下有 .bak 后缀的备份文件，请写一脚本批量把这些文件都还原，也就是把.bak的后缀都去掉。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#! /bin/bash</span></div><div class="line"><span class="built_in">cd</span> /root</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `ls|grep <span class="string">'bak'</span>`;<span class="keyword">do</span></div><div class="line">a=`<span class="built_in">echo</span> <span class="variable">$i</span>|awk -F<span class="string">'.bak'</span> <span class="string">'&#123;print $0&#125;'</span>`</div><div class="line">b=`<span class="built_in">echo</span> <span class="variable">$i</span>|awk -F<span class="string">'.bak'</span> <span class="string">'&#123;print $1&#125;'</span>`</div><div class="line">mv <span class="variable">$a</span> <span class="variable">$b</span></div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/shell练习/">shell练习</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Shell 练习/4. shell 练习-监控机器存活状态" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/08/31/Shell 练习/4. shell 练习-监控机器存活状态/" class="article-date">
  	<time datetime="2017-08-30T16:07:07.479Z" itemprop="datePublished">2017-08-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/31/Shell 练习/4. shell 练习-监控机器存活状态/">
        shell 练习-监控机器存活状态
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>设计一个脚本，监控远程的一台机器(假设ip为123.23.11.21)的存活状态，当发现宕机时发一封邮件给你自己。<br>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;提示：</p>
<ol>
<li>你可以使用ping命令   ping -c10 www.baidu.com</li>
<li>发邮件的命令是  echo “邮件内容” |mail -s “主题” abc@139.com</li>
<li>脚本可以搞成死循环，每隔30s检测一次</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">#!/bin/bash</span></div><div class="line"><span class="comment">#Remotemonitoring.Ifthenetworkisbroken,emailme~</span></div><div class="line"></div><div class="line">ping-c10www.baidu.com&gt;33.log</div><div class="line"></div><div class="line"><span class="keyword">while</span>[<span class="string">"1"</span>=<span class="string">"1"</span>]</div><div class="line"><span class="keyword">do</span></div><div class="line">t=$(awk<span class="string">'&#123;print$1&#125;'</span>33.log)</div><div class="line"><span class="keyword">if</span>[!-z$(<span class="variable">$t</span>)];<span class="keyword">then</span></div><div class="line"><span class="built_in">echo</span><span class="string">""</span></div><div class="line">sleep30</div><div class="line"><span class="keyword">else</span></div><div class="line"><span class="built_in">break</span>;</div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div><div class="line"><span class="built_in">echo</span><span class="string">"DiaoXianLe"</span>|mail<span class="_">-s</span><span class="string">"down"</span>abc@139.com</div></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/shell练习/">shell练习</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Shell 练习/3. shell 练习-计算进程占用内存和" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/08/31/Shell 练习/3. shell 练习-计算进程占用内存和/" class="article-date">
  	<time datetime="2017-08-30T16:07:07.478Z" itemprop="datePublished">2017-08-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/31/Shell 练习/3. shell 练习-计算进程占用内存和/">
        shell 练习-计算进程占用内存和
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>ps 可以查看进程的内存占用大小，写一个脚本计算一下所有进程所占用内存大小的和。（提示，使用ps aux 列出所有进程，过滤出RSS那列，然后求和）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#! /bin/bash</span></div><div class="line">sum=0</div><div class="line"><span class="keyword">for</span> mem <span class="keyword">in</span> `ps aux |awk <span class="string">'&#123;print $6&#125;'</span> |grep -v <span class="string">'RSS'</span>`</div><div class="line"><span class="keyword">do</span></div><div class="line">    sum=$[<span class="variable">$sum</span>+<span class="variable">$mem</span>]</div><div class="line"><span class="keyword">done</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"The total memory is <span class="variable">$sum</span>"</span><span class="string">"k"</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;也可以一条 awk 命令完成</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ps aux|awk <span class="string">'&#123;print $6&#125;'</span>|awk <span class="string">'&#123;(sum=sum+$1)&#125;;END&#123;print sum&#125;'</span></div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/shell练习/">shell练习</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Shell 练习/2. shell 练习-统计IP访问量" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/08/31/Shell 练习/2. shell 练习-统计IP访问量/" class="article-date">
  	<time datetime="2017-08-30T16:07:07.477Z" itemprop="datePublished">2017-08-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/31/Shell 练习/2. shell 练习-统计IP访问量/">
        shell 练习-统计IP访问量
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>抓包 ip 访问日志 /var/log/1.log 然后进行系统分析：要求统计出每个 IP 的访问量有多少？提示，先 awk 过滤出 ip ，然后进行排序，统计重复数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">awk <span class="string">'&#123;print $1&#125;'</span> /var/<span class="built_in">log</span>/1.log |sort -n|uniq -c|sort-rn</div></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/shell练习/">shell练习</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/60/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/59/">59</a><a class="page-number" href="/page/60/">60</a><span class="page-number current">61</span><a class="page-number" href="/page/62/">62</a><a class="page-number" href="/page/63/">63</a><a class="extend next" rel="next" href="/page/62/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2017 失落的乐章
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/smackgg/hexo-theme-smackdown" target="_blank">Smackdown</a>
        </div>
    </div>
  </div>
</footer>
    </div>
    

<script>
	var yiliaConfig = {
		fancybox: ,
		mathjax: ,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="/js/main.js"></script>



  </div>
</body>
</html>