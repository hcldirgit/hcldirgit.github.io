<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>失落的乐章</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="失落的乐章的Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="失落的乐章">
<meta property="og:url" content="https://hcldirgit.github.io/page/20/index.html">
<meta property="og:site_name" content="失落的乐章">
<meta property="og:description" content="失落的乐章的Blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="失落的乐章">
<meta name="twitter:description" content="失落的乐章的Blog">
  
    <link rel="alternative" href="/atom.xml" title="失落的乐章" type="application/atom+xml">
  
  
    <link rel="icon" href="https://github.com/hcldirgit/image/blob/master/0.png?raw=true">
  
  <link rel="stylesheet" href="/css/style.css">
  
  
<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-85415703-1', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  <script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>
  <script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>

  
</head>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://github.com/hcldirgit/image/blob/master/0.png?raw=true" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">失落的乐章</a></h1>
		</hgroup>

		
		<p class="header-subtitle">技术面前，永远都是学生。</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/tags">静心阅读</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Ansible/" style="font-size: 10.42px;">Ansible</a> <a href="/tags/Apache/" style="font-size: 18.33px;">Apache</a> <a href="/tags/Cacti/" style="font-size: 11.67px;">Cacti</a> <a href="/tags/DNS/" style="font-size: 13.33px;">DNS</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/FTP/" style="font-size: 11.25px;">FTP</a> <a href="/tags/Git/" style="font-size: 10.83px;">Git</a> <a href="/tags/HA集群/" style="font-size: 11.67px;">HA集群</a> <a href="/tags/Hadoop/" style="font-size: 12.5px;">Hadoop</a> <a href="/tags/Jenkins/" style="font-size: 10.42px;">Jenkins</a> <a href="/tags/LAMP/" style="font-size: 19.58px;">LAMP</a> <a href="/tags/LNMP/" style="font-size: 17.08px;">LNMP</a> <a href="/tags/LVS/" style="font-size: 16.67px;">LVS</a> <a href="/tags/Linux/" style="font-size: 19.17px;">Linux</a> <a href="/tags/Linux命令/" style="font-size: 20px;">Linux命令</a> <a href="/tags/Linux安全/" style="font-size: 14.17px;">Linux安全</a> <a href="/tags/Memcached/" style="font-size: 11.25px;">Memcached</a> <a href="/tags/MongoDB/" style="font-size: 15.42px;">MongoDB</a> <a href="/tags/MySQL/" style="font-size: 17.5px;">MySQL</a> <a href="/tags/NFS/" style="font-size: 10px;">NFS</a> <a href="/tags/Nagios/" style="font-size: 11.67px;">Nagios</a> <a href="/tags/Nginx/" style="font-size: 17.92px;">Nginx</a> <a href="/tags/OpenStack/" style="font-size: 11.25px;">OpenStack</a> <a href="/tags/Php/" style="font-size: 14.58px;">Php</a> <a href="/tags/Puppet/" style="font-size: 11.25px;">Puppet</a> <a href="/tags/Python/" style="font-size: 14.58px;">Python</a> <a href="/tags/Redis/" style="font-size: 16.25px;">Redis</a> <a href="/tags/Resin/" style="font-size: 10px;">Resin</a> <a href="/tags/Saltstack/" style="font-size: 10px;">Saltstack</a> <a href="/tags/Samba/" style="font-size: 12.08px;">Samba</a> <a href="/tags/Squid/" style="font-size: 14.58px;">Squid</a> <a href="/tags/Tomcat/" style="font-size: 13.75px;">Tomcat</a> <a href="/tags/Zabbix/" style="font-size: 15.83px;">Zabbix</a> <a href="/tags/haproxy/" style="font-size: 12.5px;">haproxy</a> <a href="/tags/keepalived/" style="font-size: 12.92px;">keepalived</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/shell练习/" style="font-size: 18.75px;">shell练习</a> <a href="/tags/正则表达式/" style="font-size: 12.92px;">正则表达式</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">失落的乐章</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="https://github.com/hcldirgit/image/blob/master/0.png?raw=true" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">失落的乐章</h1>
			</hgroup>
			
			<p class="header-subtitle">技术面前，永远都是学生。</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/tags">静心阅读</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-MySQL/23. mysql主从复制" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/MySQL/23. mysql主从复制/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.781Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/MySQL/23. mysql主从复制/">
        mysql 主从复制
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="mysql复制"><a href="#mysql复制" class="headerlink" title="mysql复制"></a>mysql复制</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;MySQL复制支持单向，异步复制。通过一台主服务器将更新写入二进制日志文件，并维护文件的一个索引以跟踪日志循环。这些日志可以记录发送到从服务器的更新。当一个从服务器连接主服务器时，它通知主服务器从服务器在日志中读取的最后一次成功更新的位置。从服务器接收从那时起发生的任何更新，然后封锁并等待主服务器通知新的更新。MySQL主从复制是异步进行的。同步需要版本为5.5,使用google提供的插件来实现。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;MySQL主从复制操作很灵活既可以实现整个服务的级别的复制，也可以实现对某个库，甚至某个数据库中的指定的某个对象进行复制。</p>
<h2 id="MySQL主从复制应用场景"><a href="#MySQL主从复制应用场景" class="headerlink" title="MySQL主从复制应用场景"></a>MySQL主从复制应用场景</h2><ol>
<li>提高性能。通过一(多)主多从的部署方案，将涉及数据写的操作放在Master端操作，而将数据读的操作分散到众多的Slave当中。降低了Master的负载，提高数据写入的响应效率；多台从服务器提供读，分担了请求，提高了读的效率。</li>
<li>数据安全。数据复制到Slave节点，即使Master宕机，Slave节点还保存着完整数据。</li>
<li>数据分析。将数据分析，放在slave上。</li>
</ol>
<h2 id="主从复制的原理"><a href="#主从复制的原理" class="headerlink" title="主从复制的原理"></a>主从复制的原理</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;MySQL的Replication是一个异步的复制过程，从一个MySQL实例(Master)复制到另一台MySQL实例上。在Master和Slave之间复制的整个过程主要由3个线程完成，其中两个线程（SQL线程和IO线程）在Slave端，另外一个线程(IO线程)在Master端。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;要实现主从复制，首先要在Master端打开Binary Log功能。因为整个复制过程实际上    就是Slave从Master上获取二进制日志，然后在自己身上完全按照产生的顺序一次执行日志中记录的各种操作的过程。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;复制的具体过程如下：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/mysql%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/01.jpeg?raw=true" alt=""></p>
<ol>
<li>Slave的IO线程连上Master，并请求日志文件指定位置(或从开始的日志)之后的日志的内容。</li>
<li>Master接收到来自Slave的IO线程请求后，负责复制IO线程根据请求的信息读取指定日志之后的日志信息，返回给Slave端的IO线程。返回信息中除了日志所包含的信息，还包含了包括本次返回的信息在Master端的Binary Log文件的名称和位置。</li>
<li>Slave的IO线程接受到信息后，将日志内容一次写入Slave端的Relay Log文件(mysql-relay-bin.xxxx)的末端，并将读取到的Master端的bin-log的文件和位置记录到master-info文件中，以便在下一次读取时能够清楚地告诉Master，下次从bin-log哪个位置开始往后的日志内容。</li>
<li>Slave的SQL线程检测检测到Relay Log中更新内容后，会马上解析该Log文件中的内容，还原成在Master端真实执行时的可执行的SQL语句，并执行这些SQK语句。实际上Master和Slave执行同样的语句。</li>
</ol>
<h2 id="Binary-Log-记录方式"><a href="#Binary-Log-记录方式" class="headerlink" title="Binary Log 记录方式"></a>Binary Log 记录方式</h2><h3 id="Row-Level"><a href="#Row-Level" class="headerlink" title="Row Level"></a>Row Level</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Binary Log会记录成每一行数据被修改的形式，然后在Slave端再对相同的数据进行修改。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>优点</strong>：在Row Level模式下，Binnary Log可以不记录执行的Query语句的上下文相关信息，只要记录哪一行修改了，修改成什么样子。Row Level会详细的记录下每一行数据的修改细节，而且不会出现某个特定情况下的存储过程，或Function，以及Trigger的调用和触发无法被正确复制问题。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>缺点</strong>：产生大量的日志内容。</p>
<h3 id="Statment-Level"><a href="#Statment-Level" class="headerlink" title="Statment Level"></a>Statment Level</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;每一条会修改的SQL语句都会记录到Master的Binnary中。Slave端在复制的时候，SQL线程会解析成和原来Master端执行过相同的SQL语句，并再次执行。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>优点</strong>：首先，解决了Row Level下的缺点，不须要记录每一行的数据变化，减少了Binnary Log日志量，节约了IO成本，提高了性能。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>缺点</strong>：由于它是记录的执行语句，为了让这些语句在Slave端也能正确执行。那么它还必须记录每条语句在执行时的一些相关信息，即上下文信息，以保证所有语句在Slave端被执行的时候能够得到和在Master端执行时相同的结果。另外，由于MySQL发展比较快，很多新功能不断加入，使得MySQL复制遇到了不小的挑战，复制时设计的内容岳父在，越容易出bug。在Statement Level下，目前已发现不少的情况下会造成MySQL的复制问题。主要是在修改数据使用了某些特定的函数货功能后，出现，比如：Sleep()函数在有些版本中就不能正确的复制，在存储过程中使用了last_insert_id()函数，可能会使Slave和Master的到不一致的ID，等等。</p>
<h3 id="Mixed-Level"><a href="#Mixed-Level" class="headerlink" title="Mixed Level"></a>Mixed Level</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在Mixed模式下，MySQL会根据执行的每一条具体的SQL语句来区分对待记录的日志形式，也就是在Statement和Row之间选择一种。除了MySQL认为通过Statement方式可能造成复制过程中Master和Slave之间产生不一致数据。(如特殊Procedure和Funtion的使用，UUID()函数的使用等特殊情况)时，它会选择ROW的模式来记录变更之外，都会使用Statement方式。</p>
<h2 id="设置主从"><a href="#设置主从" class="headerlink" title="设置主从"></a>设置主从</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;主从设置的主要步骤是</p>
<ol>
<li>修改Master和Slave的my.cnf中的server-id，使之唯一,开启binlog。</li>
<li>若不停Master时，加入全局锁，记录bin-log文件和bin-log文件的位置，全备要同步的数据库；解除全局锁</li>
<li>若可以停库时，停止主库，物理备份所需要同步的数据库。</li>
<li>在Slave端恢复备份的数据。</li>
<li>用change master在Slave建立与master的联系。</li>
<li>启动Slave。</li>
<li>检查Slave的状态。</li>
</ol>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><ol>
<li>不停主库的建立主从复制。</li>
</ol>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>第一部分 对主库的操作</strong></p>
<ol>
<li>修改主库的文件，开启MySQL的bin-log。（一般安装的时候最好先做好，这样可以不停库。）<br>修改主库的配置文件my.cnf：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">vim /etc/my.cnf</div><div class="line"></div><div class="line">server-id = 1 <span class="comment"># 设置server-id 确保id为唯一，最好用ip地址，后三位</span></div><div class="line">bin-log=mysql-bin <span class="comment"># 设置 bin-log，这地方可以指定为bin-log的目录？</span></div><div class="line"></div><div class="line">/etc/init.d/mysqld restart</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改完成后，重启mysql</p>
<ol>
<li>登录主库，添加从库的同步账号。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql –uroot –p</div><div class="line">grant replication slave on *.* to <span class="string">'rep'</span>@<span class="string">'%'</span> identified by <span class="string">'passwd'</span>;</div></pre></td></tr></table></figure>
<ol>
<li>对主库进行锁表操作，禁止更新，（为了防止备份时的数据不一致问题）。并查看bin-log的名字和日志的（position）。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">flush tables with <span class="built_in">read</span> lock；</div><div class="line">show master status；</div><div class="line"></div><div class="line">mysql&gt; show master status;</div><div class="line">+------------------+----------+--------------+------------------+</div><div class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |</div><div class="line">+------------------+----------+--------------+------------------+</div><div class="line">| mysql-bin.000107 | 38874616 |              |                  |</div><div class="line">+------------------+----------+--------------+------------------+</div><div class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;记录这两个值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql-bin.000107</div><div class="line">38874616</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;取得<code>bin-log</code> 和 <code>position</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql -uroot -p<span class="string">'yz11235'</span> -e <span class="string">"show master status"</span> | awk <span class="string">'&#123;if (NR == 2)&#123; print $1 "\n" $2;&#125;&#125;'</span> &gt; temp.txt</div></pre></td></tr></table></figure>
<ol>
<li>对主库进行全备份。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysqldump -h hostname -uroot -p’’ -A -B -F | gzip &gt;alldb.sql.gz</div></pre></td></tr></table></figure>
<ol>
<li>导出数据库后，进行对数据库表解锁。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">unlock tables</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>第二部分 从库上操作</strong></p>
<ol>
<li>在从库上设置my.cnf，设置server-id，和注释bin-log。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">server-id = 2</div><div class="line"><span class="comment"># bin-log = mysql-bin</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;重启 mysql。</p>
<ol>
<li>登录从库，并设置从库信息</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">CHANGE MASTER TO </div><div class="line">MASTER_HOST=<span class="string">'10.143.39.174'</span>,</div><div class="line">MASTER_PORT=3306,</div><div class="line">MASTER_USER=<span class="string">'rep'</span>,</div><div class="line">MASTER_PASSWORD=<span class="string">'passwd'</span>,</div><div class="line">MASTER_LOG_FILE=<span class="string">'mysql-bin.000003'</span>,</div><div class="line">MASTER_LOG_POS=151348020,</div><div class="line">MASTER_CONNECT_RETRY=10;</div></pre></td></tr></table></figure>
<ol>
<li>启动 从库</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">start slave;</div></pre></td></tr></table></figure>
<ol>
<li>查看从库状态，</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">show slave status\G;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;观察：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">slave_IO_Running : Yes</div><div class="line">Slave_SQL_Running : Yes</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;以上两个为Yes 说明主从已经成功。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Second_behind_master = 0</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这是从库落后主库的秒数。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-MySQL/21. 同一台MySQL服务器启动多个端口" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/MySQL/21. 同一台MySQL服务器启动多个端口/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.777Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/MySQL/21. 同一台MySQL服务器启动多个端口/">
        同一台MySQL服务器启动多个端口
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;首先安装二进制源码包的mysql</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;安装到初始化数据库的时候，因为是多个端口，所以要根据配置文件来初始化多个数据库。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;比如有2个端口</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;则要运行两次</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">./scripts/mysql_install_db --datadir=/home/mysql1 --user=mysql</div><div class="line">./scripts/mysql_install_db --datadir=/home/mysql2 --user=mysql</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">[mysqld0]</div><div class="line">port = 3300</div><div class="line">socket = /tmp/mysql0.sock</div><div class="line">pid-file = /home/mysql0/localhost.localdomain0.pid</div><div class="line">datadir = /home/mysql0</div><div class="line"><span class="comment">#log = /data/mysql0/mysql0.log</span></div><div class="line">user = mysql</div><div class="line">skip-locking</div><div class="line">skip-name-resolve</div><div class="line"><span class="comment">#skip-bdb</span></div><div class="line"><span class="comment">#skip-innodb</span></div><div class="line">key_buffer = 128M</div><div class="line">max_allowed_packet = 1M</div><div class="line">table_cache = 864</div><div class="line">sort_buffer_size = 1M</div><div class="line">read_buffer_size = 512K</div><div class="line">read_rnd_buffer_size = 1M</div><div class="line">myisam_sort_buffer_size = 32M</div><div class="line">thread_cache_size = 16</div><div class="line">query_cache_size = 32M</div><div class="line">thread_concurrency = 8</div><div class="line"><span class="comment">#skip-networking</span></div><div class="line">wait_timeout=8</div><div class="line">max_connections=512</div><div class="line">max_connect_errors = 10000000</div><div class="line">max_user_connections=20</div><div class="line"><span class="comment">#slow_queries=/data/mysql0slowquer.sql</span></div><div class="line"><span class="comment">#log_slow_queries=/data/mysql0slowquer.sql</span></div><div class="line"><span class="comment">#long_query_time=3</span></div><div class="line"><span class="comment">#log-bin=mysql0-bin</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">[mysqld1]</div><div class="line">port = 3301</div><div class="line">socket = /tmp/mysql1.sock</div><div class="line">pid-file = /home/mysql1/localhost.localdomain1.pid</div><div class="line">datadir = /home/mysql1</div><div class="line"><span class="comment">#log = /data/mysql1/mysql1.log</span></div><div class="line">user = mysql</div><div class="line">skip-locking</div><div class="line">skip-name-resolve</div><div class="line"><span class="comment">#skip-innodb</span></div><div class="line"><span class="comment">#skip-bdb</span></div><div class="line">key_buffer = 128M</div><div class="line">max_allowed_packet = 1M</div><div class="line">table_cache = 864</div><div class="line">sort_buffer_size = 1M</div><div class="line">read_buffer_size = 512K</div><div class="line">read_rnd_buffer_size = 1M</div><div class="line">myisam_sort_buffer_size = 32M</div><div class="line">thread_cache_size = 16</div><div class="line">query_cache_size = 32M</div><div class="line">thread_concurrency = 8</div><div class="line"><span class="comment">#skip-networking</span></div><div class="line">wait_timeout=8</div><div class="line">max_connections=512</div><div class="line">max_connect_errors = 10000000</div><div class="line">max_user_connections=20</div><div class="line"><span class="comment">#log_slow_queries=/data/mysql1slowquer.sql</span></div><div class="line"><span class="comment">#long_query_time=3</span></div><div class="line"><span class="comment">#log-bin=mysql1-bin</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;把配置文件放在 /etc/my.cnf</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;启动mysql</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/<span class="built_in">local</span>/mysql/bin/mysqld_multi start 0-1</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这里的0或1是根据配置文件中 <code>[mysqld0]</code> 来定的。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-MySQL/2. MySQL 5.5 源码安装" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/MySQL/2. MySQL 5.5 源码安装/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.776Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/MySQL/2. MySQL 5.5 源码安装/">
        MySQL 5.5 源码安装
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;首先安装必要的库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y gcc*</div></pre></td></tr></table></figure>
<h2 id="首先安装cmake"><a href="#首先安装cmake" class="headerlink" title="首先安装cmake"></a>首先安装cmake</h2><ol>
<li>支持yum安装</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y cmake</div></pre></td></tr></table></figure>
<ol>
<li>也可以源码安装</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src</div><div class="line"><span class="comment">#下载cmake</span></div><div class="line">wget http://www.cmake.org/files/v2.8/cmake-2.8.7.tar.gz</div><div class="line">tar zxvf cmake-2.8.7.tar.gz</div><div class="line"><span class="built_in">cd</span> cmake-2.8.7</div><div class="line"><span class="comment">#安装cmake</span></div><div class="line">./configure</div><div class="line">make</div><div class="line">make install</div></pre></td></tr></table></figure>
<h2 id="安装-MySQL"><a href="#安装-MySQL" class="headerlink" title="安装 MySQL"></a>安装 MySQL</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<a href="http://dev.mysql.com/downloads" target="_blank" rel="external">官网</a>下载mysql5.5版本Linux系统源码包。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">groupadd mysql</div><div class="line">useradd -g mysql mysql</div><div class="line">tar zxvf mysql-5.2.25.tar.gz</div><div class="line"><span class="built_in">cd</span> mysql-5.2.25</div></pre></td></tr></table></figure>
<ul>
<li>cmake：默认情况下安装，安装目录为/usr/local/mysql ，数据目录为/usr/local/mysql/data</li>
<li>也可以指定参数安装，如指定UTF8，数据引擎等</li>
<li>具体参照<a href="https://dev.mysql.com/doc/refman/5.5/en/source-configuration-options.html" target="_blank" rel="external">官方说明文档</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">cmake -DCMAKE_INSTALL_PREFIX=/usr/<span class="built_in">local</span>/mysql -DMYSQL_DATADIR=/mysql/data -DDEFAULT_CHARSET=utf8 -DDEFAULT_COLLATION=utf8_general_ci -DWITH_EXTRA_CHARSETS:STRING=all -DWITH_DEBUG=0 -DWITH_SSL=yes -DWITH_READLINE=1 -DENABLED_LOCAL_INFILE=1</div><div class="line">make &amp;&amp; make install</div><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/mysql</div><div class="line">chown -R mysql:mysql /usr/<span class="built_in">local</span>/mysql</div><div class="line">./scripts/mysql_install_db --user=mysql -datadir=/mysql/data</div><div class="line"><span class="comment">#此处如不指定datadir，到启动时会报错</span></div><div class="line">chown -R root .</div><div class="line">chown -R mysql data</div><div class="line">cp support-files/my-medium.cnf /etc/my.cnf</div><div class="line">bin/mysqld_safe --user=mysql &amp;amp;</div><div class="line"><span class="comment"># Next command is optional</span></div><div class="line">cp support-files/mysql.server /etc/init.d/mysqld</div><div class="line">chmod +x /etc/init.d/mysqld</div><div class="line">/etc/init.d/mysqld start</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;到此，安装完成。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-MySQL/20.mysql字符集调整总结" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/MySQL/20.mysql字符集调整总结/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.776Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/MySQL/20.mysql字符集调整总结/">
        mysql字符集调整总结
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;字符集是一套符号和编码的规则，不论是在oracle数据库还是在mysql数据库，都存在字符集的选择问题。对于数据库来说，字符集又是比较重要的，因为数据库存储的数据大部分都是各种文字，字符集对于数据库的存储、处理性能以及数据迁移都有重要的影响。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;如果在数据库创建阶段没有正确选择字符集，那么可能在后期需要更换字符集，而字符集的更换是代价比较高的操作，也存在一定的风险，所以我们建议在应用开始阶段，就按照需求正确的选择合适的字符集，尽量避免后期不必要的调整。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;mysql编译安装时，指定字符集的方法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./configure  --with-charset=utf8</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;mysql的字符集有4个级别的默认设置：服务器级、数据库级、表级和字段级。分别在不同的地方设置，作用也不相同。</p>
<h2 id="1、服务器字符集设定，在mysql服务启动的时候确定。"><a href="#1、服务器字符集设定，在mysql服务启动的时候确定。" class="headerlink" title="1、服务器字符集设定，在mysql服务启动的时候确定。"></a>1、服务器字符集设定，在mysql服务启动的时候确定。</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;可以在my.cnf中设置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[mysql]</div><div class="line"><span class="comment">### 默认字符集为utf8</span></div><div class="line">default-character-set=utf8</div><div class="line">[mysqld]</div><div class="line"><span class="comment">### 默认字符集为utf8</span></div><div class="line">default-character-set=utf8</div><div class="line"><span class="comment">### （设定连接mysql数据库时使用utf8编码，以让mysql数据库为utf8运行）</span></div><div class="line">init_connect=<span class="string">'SET NAMES utf8'</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;或者在启动选项中指定：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysqld --default-character-set=utf8</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;如果没有特别的指定服务器字符集，默认使用latin1(ISO-8859-1的别名)作为服务器字符集。上面三种设置的方式都只指定了字符集，没有去做校对，我们可以用show variables like ‘char%’;命令查询当前服务器的字符<br>集和校对规则。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">mysql&gt;show variables like <span class="string">'char%'</span>;</div><div class="line">   +--------------------------+----------------------------+</div><div class="line"></div><div class="line">　　| Variable_name | Value |</div><div class="line"></div><div class="line">　　+--------------------------+----------------------------+</div><div class="line"></div><div class="line">　　| character_set_client | utf8 |</div><div class="line"></div><div class="line">　　| character_set_connection | utf8 |</div><div class="line"></div><div class="line">　　| character_set_database | utf8 |</div><div class="line"></div><div class="line">　　| character_set_filesystem | binary |</div><div class="line"></div><div class="line">　　| character_set_results | utf8 |</div><div class="line"></div><div class="line">　　| character_set_server | utf8 |</div><div class="line"></div><div class="line">　　| character_set_system | utf8 |</div><div class="line"></div><div class="line">　　| character_sets_dir | /usr/share/mysql/charsets/ |</div><div class="line"></div><div class="line">　　+--------------------------+----------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注：如果增加default-character-set=utf8后，MYSQL启动报错。可以用character_set_server=utf8来取代default-character-set=utf8，就能正常启动了。这是因为MYSQL不同版本识别的问题。</p>
<h2 id="2、数据库级"><a href="#2、数据库级" class="headerlink" title="2、数据库级"></a>2、数据库级</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建数据库时指定字符集</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt;CREATE DATABASE my_db default charset utf8 COLLATE utf8_general_ci;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注意后面这句话 “COLLATE utf8_general_ci”,大致意思是在排序时根据utf8编码格式来排序<br>如果指定了数据库编码，那么在这个数据库下创建的所有数据表的默认字符集都会是utf8了</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改MYSQL数据库编码，如果是MYSQL数据库编码不正确，可以在MYSQL执行如下命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ALTER DATABASE my_db DEFAULT CHARACTER SET utf8;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;以上命令就是将MYSQL的my_db数据库的编码设为utf8</p>
<h2 id="3、表级"><a href="#3、表级" class="headerlink" title="3、表级"></a>3、表级</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建表时指定字符集</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt;create table my_table (name varchar(20) not null default <span class="string">''</span>)<span class="built_in">type</span>=myisam default charset utf8;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这句话就是创建一个表,指定默认字符集为utf8</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改MYSQL表的编码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ALTER TABLE my_table DEFAULT CHARACTER SET utf8;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;以上命令就是将一个表my_table的编码改为utf8</p>
<h2 id="4、字段级"><a href="#4、字段级" class="headerlink" title="4、字段级"></a>4、字段级</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">alter table <span class="built_in">test</span> add column address varchar(110) after stu_id;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在stu_id后增加一个字段address</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">alter table <span class="built_in">test</span> add id int unsigned not Null auto_increment primary key;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改字段的编码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ALTER TABLE `<span class="built_in">test</span>` CHANGE `name` `name` VARCHAR( 45 ) CHARACTER SET utf8 COLLATE utf8_bin NOT NULL</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;以上命令就是将MYSQL数据库test表中name的字段编码改为utf8</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在命令行下插入汉字时如下代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">set</span> names utf8;有时候这一句很关键！</div><div class="line">insert into charset values(<span class="string">'王达'</span>);</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注意：alter修改的方法不能更新已有记录的字符集，只是对新创建的表和记录生效。对已有记录字符集的调整，需要先将数据导出，经过适当调整后重新导入才可以完全修改编码。</p>
<h2 id="导出导入的字符调整方法"><a href="#导出导入的字符调整方法" class="headerlink" title="导出导入的字符调整方法"></a>导出导入的字符调整方法</h2><h3 id="导出表结构"><a href="#导出表结构" class="headerlink" title="导出表结构"></a>导出表结构</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysqldump -uroot -pmysql --default-character-set=latin1 -d  my_db&gt; createtab.sql</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;手工修改createtab.sql表结构定义中的字符集为新的字符集</p>
<h4 id="导出所有记录"><a href="#导出所有记录" class="headerlink" title="导出所有记录"></a>导出所有记录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysqldump -uroot -pmysql --quick --no-create-info --extended-insert --default-character-set=latin1 --host=localhost  my_db&gt; data.sql</div></pre></td></tr></table></figure>
<h4 id="打开data-sql，将set-names-latin1修改成set-names-utf8"><a href="#打开data-sql，将set-names-latin1修改成set-names-utf8" class="headerlink" title="打开data.sql，将set names latin1修改成set names utf8"></a>打开data.sql，将set names latin1修改成set names utf8</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">:%s/latin1/utf8/g</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;全文替换</p>
<h4 id="使用新的字符集创建新的数据库"><a href="#使用新的字符集创建新的数据库" class="headerlink" title="使用新的字符集创建新的数据库"></a>使用新的字符集创建新的数据库</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">create database  mydata  default charset utf8;</div></pre></td></tr></table></figure>
<h4 id="创建表，执行createtab-sql"><a href="#创建表，执行createtab-sql" class="headerlink" title="创建表，执行createtab.sql"></a>创建表，执行createtab.sql</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql -uroot -pmysql mydata&lt;creattab.sql</div></pre></td></tr></table></figure>
<h4 id="导入数据"><a href="#导入数据" class="headerlink" title="导入数据"></a>导入数据</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql -uroot -pmysql mydata&lt;data.sql</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注意一点就是目标字符集要大于等于源字符集，否则会丢失一部分不支持的汉字数据。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;附：旧数据升级办法</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;以原来的字符集为latin1为例，升级成为utf8的字符集。原来的表: old_table (default charset=latin1)，新表：new_table(default charset=utf8)。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;第一步：导出旧数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysqldump --default-character-set=latin1 -hlocalhost -uroot -B my_db --tables old_table &gt; old.sql</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;第二步：转换编码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iconv -t utf8  -f latin1 -c old.sql &gt; new.sql</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在这里，假定原来的数据默认是latin1编码。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;第三步：导入</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改old.sql，增加一条sql语句： “SET NAMES utf8;”，保存。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql -hlocalhost -uroot my_db &lt; new.sql</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;大功告成！</p>
<h2 id="Mysql-collate规则："><a href="#Mysql-collate规则：" class="headerlink" title="Mysql collate规则："></a>Mysql collate规则：</h2><ul>
<li>*_bin: 表示的是binary case sensitive collation，也就是说是区分大小写的</li>
<li>*_cs: case sensitive collation，区分大小写</li>
<li>*_ci: case insensitive collation，不区分大小写</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-MySQL/19. mysqld_multi stop 不能停掉mysql" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/MySQL/19. mysqld_multi stop 不能停掉mysql/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.775Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/MySQL/19. mysqld_multi stop 不能停掉mysql/">
        mysqld_multi stop 不能停掉mysql
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;使用mysqld_multi start  启动了多个mysql实例，但是mysqld_multi stop 却不能停止，为啥呢？因为还没有授权呢。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/<span class="built_in">local</span>/mysql/bin/mysqld_multi stop</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;但是默认是停不掉的，需要做一个授权</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grant shutdown on *.* to <span class="string">'username'</span>@<span class="string">'localhost'</span> identified by <span class="string">'password'</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;另外还需要在my.cnf配置文件中加上：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[mysqld_multi]</div><div class="line">mysqld = /usr/<span class="built_in">local</span>/mysql/bin/mysqld_safe</div><div class="line">mysqladmin = /usr/<span class="built_in">local</span>/mysql/bin/mysqladmin</div><div class="line">user = username</div><div class="line">password = password</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-MySQL/18. innobackupex 备份 Xtrabackup 增量备份" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/MySQL/18. innobackupex 备份 Xtrabackup 增量备份/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.775Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/MySQL/18. innobackupex 备份 Xtrabackup 增量备份/">
        innobackupex 备份 Xtrabackup 增量备份
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Xtrabackup中包含两个工具：</p>
<ul>
<li>xtrabackup - 用于热备份innodb, xtradb表的工具，不能备份其他表(MYISAM表)。</li>
<li>innobackupex - 对xtrabackup封装的perl脚本，提供了myisam表备份的能力。（能进行整库和数据表备份）。</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注：备份恢复之前请做好全库备份</p>
<h2 id="安装Xtrabackup"><a href="#安装Xtrabackup" class="headerlink" title="安装Xtrabackup"></a>安装Xtrabackup</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<a href="http://www.percona.com/doc/percona-xtrabackup/index.html" target="_blank" rel="external">官网网址</a></p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;配置文件中需要添加 <code>datadir = /usr/local/mysql/datadir</code> ，MYSQL数据文件目录</p>
<h3 id="1-自动安装yum源后，用yum安装"><a href="#1-自动安装yum源后，用yum安装" class="headerlink" title="1.自动安装yum源后，用yum安装"></a>1.自动安装yum源后，用yum安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">yum install -y gnupg</div><div class="line">rpm -Uhv http://www.percona.com/downloads/percona-release/percona-release-0.0-1.x86_64.rpm</div><div class="line"> </div><div class="line">yum install -y percona-xtrabackup</div></pre></td></tr></table></figure>
<h3 id="2-手动写入yum源"><a href="#2-手动写入yum源" class="headerlink" title="2.手动写入yum源"></a>2.手动写入yum源</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;新建文件 <code>/etc/yum.repos.d/Percona.repo</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[percona]</div><div class="line">name = CentOS <span class="variable">$releasever</span> - Percona</div><div class="line">baseurl=http://repo.percona.com/centos/<span class="variable">$releasever</span>/os/<span class="variable">$basearch</span>/</div><div class="line">enabled = 1</div><div class="line">gpgkey = file:///etc/pki/rpm-gpg/RPM-GPG-KEY-percona</div><div class="line">gpgcheck = 1</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;之后yum安装 ，安装后可执行 <code>xtrabackup -v</code> 查看</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;之后可以用xtrabackup 备份</p>
<h2 id="innobackupex-备份全库"><a href="#innobackupex-备份全库" class="headerlink" title="innobackupex 备份全库"></a>innobackupex 备份全库</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;备份主程序为 /usr/bin/innobackupex-1.5.1，其需要从 mysql 配置文件中读取相关信息，Mysql缺省配置文件 my.cnf 中未配置 datadir 选项，必须显性添加，否则备份程序会报错：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">1innobackupex:: Warning: Ignored unrecognized line 2 <span class="keyword">in</span> options : <span class="string">'xtrabackup: Error: Please set parameter '</span>datadir<span class="string">'</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在Mysql 配置文件 <code>/etc/my.cnf</code> 配置文件添加 <code>datadir</code> 内容：</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在[mysqld]段加入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">datadir = /usr/<span class="built_in">local</span>/mysql/var</div></pre></td></tr></table></figure>
<h3 id="1-备份"><a href="#1-备份" class="headerlink" title="1.备份"></a>1.备份</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#/usr/bin/innobackupex-1.5.1 --user=root --password=password --defaults-file=/etc/my.cnf /usr/local/bbsBackup</span></div></pre></td></tr></table></figure>
<h3 id="2-恢复"><a href="#2-恢复" class="headerlink" title="2.恢复"></a>2.恢复</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">/usr/bin/innobackupex-1.5.1 --apply-log /usr/<span class="built_in">local</span>/bbsBackup/2011-09-26_02-00-01/</div><div class="line">/usr/bin/innobackupex-1.5.1 --copy-back /usr/<span class="built_in">local</span>/bbsBackup/2011-09-26_02-00-01/</div><div class="line">chown -R mysql:mysql /usr/<span class="built_in">local</span>/mysql/</div><div class="line">/etc/init.d/mysqld start</div></pre></td></tr></table></figure>
<h2 id="全量备份及恢复"><a href="#全量备份及恢复" class="headerlink" title="全量备份及恢复"></a>全量备份及恢复</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注：使用xtrabackup，仅限InnoDB和xtradb表，且注意mysql配置文件my.cnf中需设置“<code>default_table_type = InnoDB</code>”否则不成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/bin/xtrabackup --defaults-file=/etc/my.cnf --backup --target-dir=/usr/<span class="built_in">local</span>/bbsBackup/base/</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;恢复时执行两次：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/usr/bin/xtrabackup --defaults-file=/etc/my.cnf --prepare --target-dir=/usr/<span class="built_in">local</span>/bbsBackup/base</div><div class="line">/usr/bin/xtrabackup --defaults-file=/etc/my.cnf --prepare --target-dir=/usr/<span class="built_in">local</span>/bbsBackup/base</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#将数据库停掉</span></div><div class="line">/etc/init.d/mysqld stop</div><div class="line"><span class="comment">#删除数据库目录下的ib*（ib开头的所有）文件。</span></div><div class="line">rm /usr/<span class="built_in">local</span>/mysql/var/ib*</div><div class="line"><span class="comment">#将/usr/local/bbsBackup/base目录下的ib*文件拷贝到数据库目录。</span></div><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/mysql/var/</div><div class="line">cp /usr/<span class="built_in">local</span>/bbsBackup/base/ib* ./</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;设置权限：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chown mysql:mysql ib*</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;重启数据库后测试，是否成功。</p>
<h2 id="增量备份及恢复"><a href="#增量备份及恢复" class="headerlink" title="增量备份及恢复"></a>增量备份及恢复</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注：做增量前当然要先进行全量备份，在全量的基础上来进行增量。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;首先进行全量备份。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/bin/xtrabackup --defaults-file=/etc/my.cnf --backup --target-dir=/usr/<span class="built_in">local</span>/bbsBackup/base/</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在全量备份的基础上进行增量。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/bin/xtrabackup --defaults-file=/etc/my.cnf --backup --target-dir=/usr/<span class="built_in">local</span>/bbsBackup/1 --incremental-basedir=/usr/<span class="built_in">local</span>/bbsBackup/base/</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注：/usr/local/bbsBackup/1是每次都需修改的。比如第二次增量就改成/usr/local/bbsBackup/2增量恢复。（步骤同全量恢复，只是在执行恢复命令的时候中间多一步）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/usr/bin/xtrabackup --defaults-file=/etc/my.cnf --prepare --target-dir=/usr/<span class="built_in">local</span>/bbsBackup/base</div><div class="line">/usr/bin/xtrabackup --target-dir=/usr/<span class="built_in">local</span>/bbsBackup/base --prepare --incremental-dir=/usr/<span class="built_in">local</span>/bbsBackup/1</div><div class="line">/usr/bin/xtrabackup --defaults-file=/etc/my.cnf --prepare --target-dir=/usr/<span class="built_in">local</span>/bbsBackup/base</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#将数据库停掉</span></div><div class="line">/etc/init.d/mysqld stop</div><div class="line"><span class="comment">#删除数据库目录下的ib*（ib开头的所有）文件。</span></div><div class="line">rm /usr/<span class="built_in">local</span>/mysql/var/ib*</div><div class="line"><span class="comment">#将/usr/local/bbsBackup/base目录下的ib*文件拷贝到数据库目录。</span></div><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/mysql/var/</div><div class="line">cp /usr/<span class="built_in">local</span>/bbsBackup/base/ib* ./</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;设置权限：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chown mysql:mysql ib*</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;重启数据库后测试，是否成功。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-MySQL/17. Mysql各种存储引擎的特性以及如何选择存储引擎" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/MySQL/17. Mysql各种存储引擎的特性以及如何选择存储引擎/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.774Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/MySQL/17. Mysql各种存储引擎的特性以及如何选择存储引擎/">
        Mysql各种存储引擎的特性以及如何选择存储引擎
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="几个常用存储引擎的特点"><a href="#几个常用存储引擎的特点" class="headerlink" title="几个常用存储引擎的特点"></a>几个常用存储引擎的特点</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;下面我们重点介绍几种常用的存储引擎并对比各个存储引擎之间的区别和推荐使用方式。</p>
<table>
<thead>
<tr>
<th style="text-align:center">特点</th>
<th style="text-align:center">Myisam</th>
<th style="text-align:center">BDB</th>
<th style="text-align:center">Memory</th>
<th style="text-align:center">InnoDB</th>
<th style="text-align:center">Archive</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">存储限制</td>
<td style="text-align:center">没有</td>
<td style="text-align:center">没有</td>
<td style="text-align:center">有</td>
<td style="text-align:center">64TB</td>
<td style="text-align:center">没有</td>
</tr>
<tr>
<td style="text-align:center">事务安全</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;支持</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
<td style="text-align:center">支持</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
</tr>
<tr>
<td style="text-align:center">锁机制</td>
<td style="text-align:center">表锁</td>
<td style="text-align:center">页锁</td>
<td style="text-align:center">表锁</td>
<td style="text-align:center">行锁</td>
<td style="text-align:center">行锁</td>
</tr>
<tr>
<td style="text-align:center">B树索引</td>
<td style="text-align:center">支持</td>
<td style="text-align:center">支持</td>
<td style="text-align:center">支持</td>
<td style="text-align:center">支持</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
</tr>
<tr>
<td style="text-align:center">哈希索引</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
<td style="text-align:center">支持</td>
<td style="text-align:center">支持&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
</tr>
<tr>
<td style="text-align:center">全文索引</td>
<td style="text-align:center">支持</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
</tr>
<tr>
<td style="text-align:center">集群索引</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;支持</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
</tr>
<tr>
<td style="text-align:center">数据缓存</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
<td style="text-align:center">支持</td>
<td style="text-align:center">支持</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
</tr>
<tr>
<td style="text-align:center">索引缓存</td>
<td style="text-align:center">支持</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
<td style="text-align:center">支持</td>
<td style="text-align:center">支持</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
</tr>
<tr>
<td style="text-align:center">数据可压缩</td>
<td style="text-align:center">支持</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
<td style="text-align:center">支持</td>
</tr>
<tr>
<td style="text-align:center">空间使用</td>
<td style="text-align:center">低</td>
<td style="text-align:center">低</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">高</td>
<td style="text-align:center">非常低</td>
</tr>
<tr>
<td style="text-align:center">内存使用</td>
<td style="text-align:center">低</td>
<td style="text-align:center">低</td>
<td style="text-align:center">中等</td>
<td style="text-align:center">高</td>
<td style="text-align:center">低</td>
</tr>
<tr>
<td style="text-align:center">批量插入的速度</td>
<td style="text-align:center">高</td>
<td style="text-align:center">高</td>
<td style="text-align:center">高</td>
<td style="text-align:center">低</td>
<td style="text-align:center">非常高</td>
</tr>
<tr>
<td style="text-align:center">支持外键</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;支持</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
</tr>
</tbody>
</table>
<h2 id="最常使用的2种存储引擎："><a href="#最常使用的2种存储引擎：" class="headerlink" title="最常使用的2种存储引擎："></a>最常使用的2种存储引擎：</h2><ul>
<li>Myisam是Mysql的默认存储引擎。当create创建新表时，未指定新表的存储引擎时，默认使用Myisam。每个MyISAM在磁盘上存储成三个文件。文件名都和表名相同，扩展名分别是.frm（存储表定义）、.MYD (MYData，存储数据)、.MYI (MYIndex，存储索引)。数据文件和索引文件可以放置在不同的目录，平均分布io，获得更快的速度。   </li>
<li>InnoDB存储引擎提供了具有提交、回滚和崩溃恢复能力的事务安全。但是对比Myisam的存储引擎，InnoDB写的处理效率差一些并且会占用更多的磁盘空间以保留数据和索引。</li>
</ul>
<h2 id="如何选择合适的存储引擎"><a href="#如何选择合适的存储引擎" class="headerlink" title="如何选择合适的存储引擎"></a>如何选择合适的存储引擎</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;选择标准：根据应用特点选择合适的存储引擎，对于复杂的应用系统可以根据实际情况选择多种存储引擎进行组合。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;下面是常用存储引擎的适用环境：</p>
<ol>
<li>MyISAM：默认的MySQL插件式存储引擎，它是在Web、数据仓储和其他应用环境下最常使用的存储引擎之一</li>
<li>InnoDB：用于事务处理应用程序，具有众多特性，包括ACID事务支持。</li>
<li>Memory：将所有数据保存在RAM中，在需要快速查找引用和其他类似数据的环境下，可提供极快的访问。</li>
<li>Merge：允许MySQL DBA或开发人员将一系列等同的MyISAM表以逻辑方式组合在一起，并作为1个对象引用它们。对于诸如数据仓储等VLDB环境十分适合。</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-MySQL/16. Mysql binlog 日志的三种模式" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/MySQL/16. Mysql binlog 日志的三种模式/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.773Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/MySQL/16. Mysql binlog 日志的三种模式/">
        Mysql binlog 日志的三种模式
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Row Level：日志中会记录成每一行数据被修改的形式，然后在slave端再对相同的数据进行修改。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;优点：在row level模式下，bin-log中可以不记录执行的sql语句的上下文相关的信息，仅仅只需要记录那一条记录被修改了，修改成什么样了。所以row level的日志内容会非常清楚的记录下每一行数据修 改的细节，非常容易理解。而且不会出现某些特定情况下的存储过程，或function，以及 trigger的调 用和触发无法被正确复制的问题。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;缺点：row level下，所有的执行的语句当记录到日志中的时候，都将以每行记录的修改来记录，这样可能会产生大量的日志内容，比如有这样一条update语句：update product set owner_member_id = ‘b’ where owner_member_id = ‘a’，执行之后，日志中记录的不是这条update语句所对应额事件(MySQL以事件的形式来记录bin-log日志)，而是这条语句所更新的每一条记录的变化情况，这样就记  录成很多条记录被更新的很多个事件。自然，bin-log日志的量就会很大。尤其是当执行alter table之类的语句的时候，产生的日志量是惊人的。因为MySQL对于alter table之类的表结构变更语句的处理 方式是整个表的每一条记录都需要变动，实际上就是重建了整个表。那么该表的每一条记录都会被记 录到日志中。</p>
<hr>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Statement Level:每一条会修改数据的sql都会记录到 master的bin-log中。slave在复制的时候sql进程会解析成和原来master端执行过的相同的sql来再次执行。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;优点：statement level下的优点首先就是解决了row level下的缺点，不需要记录每一行数据的变化，减少bin-log日志量，节约IO，提高性能。因为他只需要记录在Master上所执行的语句的细节，以及执行语句时候的上下文的信息。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;缺点：由于他是记录的执行语句，所以，为了让这些语句在slave端也能正确执行，那么他还必须记录每条语句在执行的时候的一些相关信息，也就是上下文信息，以保证所有语句在slave端杯执行的时候能够得到和在master端执行时候相同的结果。另外就是，由于MySQL现在发展比较快，很多的新功能不断的加入，使MySQL得复制遇到了不小的挑战，自然复制的时候涉及到越复杂的内容，bug也就越容易出现。在statement level下，目前已经发现的就有不少情况会造成MySQL的复制出现问题，主要是修改数据的时候使用了某些特定的函数或者功能的时候会出现，比如：sleep()函数在有些版本中就不能真确复制，在存储过程中使用了last_insert_id()函数，可能会使slave和master上得到不一致的id等等。由于row level是基于每一行来记录的变化，所以不会出现类似的问题。</p>
<hr>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Mixed，实际上就是前两种模式的结合。在Mixed模式下，MySQL会根据执行的每一条具体的sql语句来区分对待记录的日志形式，也就是在Statement和Row之间选择一种。新版本中的Statment level还是和以前一样，仅仅记录执行的语句。而新版本的MySQL中队row level模式也被做了优化，并不是所有的修改都会以row level来记录，像遇到表结构变更的时候就会以statement模式来记录，如果sql语句确实就是update或者delete等修改数据的语句，那么还是会记录所有行的变更。</p>
<hr>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在配置文件中参数如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">log</span>-bin=mysql-bin</div><div class="line"><span class="comment">#binlog_format=”STATEMENT”</span></div><div class="line"><span class="comment">#binlog_format=”ROW”</span></div><div class="line">binlog_format=”MIXED”</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;运行时在线修改：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SET SESSION binlog_format = ‘STATEMENT’;</div><div class="line">mysql&gt; SET SESSION binlog_format = ‘ROW’;</div><div class="line">mysql&gt; SET SESSION binlog_format = ‘MIXED’;</div><div class="line">mysql&gt; SET GLOBAL binlog_format = ‘STATEMENT’;</div><div class="line">mysql&gt; SET GLOBAL binlog_format = ‘ROW’;</div><div class="line">mysql&gt; SET GLOBAL binlog_format = ‘MIXED’;</div></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-MySQL/14. SQL—什么是事物？事物的特性有哪些？" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/MySQL/14. SQL—什么是事物？事物的特性有哪些？/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.772Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/MySQL/14. SQL—什么是事物？事物的特性有哪些？/">
        SQL—什么是事物？事物的特性有哪些？
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;事务(Transaction)是访问并可能更新数据库中各种数据项的一个程序执行单元(unit)。事务通常由高级数据库操纵语言或编程语言（如SQL，C++或Java）书写的用户程序的执行所引起，并用形如begin transaction和end transaction语句（或函数调用）来界定。事务由事务开始(begin transaction)和事务结束(end transaction)之间执行的全体操作组成。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;例如：在关系数据库中，一个事务可以是一条SQL语句，一组SQL语句或整个程序。</p>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;事务是恢复和并发控制的基本单位。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;事务应该具有4个属性：原子性、一致性、隔离性、持续性。这四个属性通常称为ACID特性。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;原子性（atomicity）。一个事务是一个不可分割的工作单位，事务中包括的操作要么都做，要么都不做。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;一致性（consistency）。事务必须是使数据库从一个一致性状态变到另一个一致性状态。一致性与原子性是密切相关的。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;隔离性（isolation）。一个事务的执行不能被其他事务干扰。即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间不能互相干扰。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;持久性（durability）。持续性也称永久性（permanence），指一个事务一旦提交，它对数据库中数据的改变就应该是永久性的。接下来的其他操作或故障不应该对其有任何影响。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-MySQL/15. MySQL存储引擎MyISAM与InnoDB的优劣" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/MySQL/15. MySQL存储引擎MyISAM与InnoDB的优劣/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.772Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/MySQL/15. MySQL存储引擎MyISAM与InnoDB的优劣/">
        MySQL存储引擎MyISAM与InnoDB的优劣
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;使用MySQL当然会接触到MySQL的存储引擎，在新建数据库和新建数据表的时候都会看到。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;MySQL默认的存储引擎是MyISAM，其他常用的就是InnoDB了。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;至于到底用哪种存储引擎比较好？这个问题是没有定论的，需要根据你的需求和环境来衡量。所以对这两种引擎的概念、原理、异同和各自的优劣点有了详细的了解之后，再根据自己的情况选择起来就容易多了。</p>
<table>
<thead>
<tr>
<th>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</th>
<th style="text-align:center">MyISAM</th>
<th style="text-align:center">InnoDB</th>
</tr>
</thead>
<tbody>
<tr>
<td>存储结构</td>
<td style="text-align:center">每张表被存放在三个文件： frm-表格定义      MYD(MYData)-数据文件    MYI(MYIndex)-索引文件</td>
<td style="text-align:center">所有的表都保存在同一个数据文件中（也可能是多个文件，或者是独立的表空间文件），InnoDB表的大小只受限于操作系统文件的大小，一般为2GB</td>
</tr>
<tr>
<td>存储空间</td>
<td style="text-align:center">MyISAM可被压缩，存储空间较小</td>
<td style="text-align:center">InnoDB的表需要更多的内存和存储，它会在主内存中建立其专用的缓冲池用于高速缓冲数据和索引</td>
</tr>
<tr>
<td>可移植性、备份及恢复</td>
<td style="text-align:center">由于MyISAM的数据是以文件的形式存储，所以在跨平台的数据转移中会很方便。在备份和恢复时可单独针对某个表进行操作</td>
<td style="text-align:center">免费的方案可以是拷贝数据文件、备份 binlog，或者用 mysqldump，在数据量达到几十G的时候就相对痛苦了事务安全不支持 每次查询具有原子性支持 具有事务(commit)、回滚(rollback)和崩溃修复能力(crash recovery capabilities)的事务安全(transaction-safe (ACID compliant))型表</td>
</tr>
<tr>
<td>AUTO_INCREMENT</td>
<td style="text-align:center">MyISAM表可以和其他字段一起建立联合索引</td>
<td style="text-align:center">InnoDB中必须包含只有该字段的索引</td>
</tr>
<tr>
<td>SELECT</td>
<td style="text-align:center">MyISAM更优</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;</td>
</tr>
<tr>
<td>INSERT</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
<td style="text-align:center">InnoDB更优</td>
</tr>
<tr>
<td>UPDATE</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
<td style="text-align:center">InnoDB更优</td>
</tr>
<tr>
<td>DELETE</td>
<td style="text-align:center">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</td>
<td style="text-align:center">InnoDB更优 它不会重新建立表，而是一行一行的删除</td>
</tr>
<tr>
<td>COUNT without WHERE</td>
<td style="text-align:center">MyISAM更优。因为MyISAM保存了表的具体行数</td>
<td style="text-align:center">InnoDB没有保存表的具体行数，需要逐行扫描统计，就很慢了</td>
</tr>
<tr>
<td>COUNT with WHERE</td>
<td style="text-align:center">一样</td>
<td style="text-align:center">一样，InnoDB也会锁表</td>
</tr>
<tr>
<td>锁</td>
<td style="text-align:center">只支持表锁</td>
<td style="text-align:center">支持表锁、行锁 行锁大幅度提高了多用户并发操作的新能。但是InnoDB的行锁，只是在WHERE的主键是有效的，非主键的WHERE都会锁全表的</td>
</tr>
<tr>
<td>外键</td>
<td style="text-align:center">不支持</td>
<td style="text-align:center">支持</td>
</tr>
<tr>
<td>FULLTEXT全文索引</td>
<td style="text-align:center">支持</td>
<td style="text-align:center">不支持 可以通过使用Sphinx从InnoDB中获得全文索引，会慢一点</td>
</tr>
</tbody>
</table>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;总的来说，MyISAM和InnoDB各有优劣，各有各的使用环境。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;但是InnoDB的设计目标是处理大容量数据库系统，它的CPU利用率是其它基于磁盘的关系数据库引擎所不能比的。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;我觉得使用InnoDB可以应对更为复杂的情况，特别是对并发的处理要比MyISAM高效。同时结合memcache也可以缓存SELECT来减少SELECT查询，从而提高整体性能。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/19/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="page-number" href="/page/19/">19</a><span class="page-number current">20</span><a class="page-number" href="/page/21/">21</a><a class="page-number" href="/page/22/">22</a><span class="space">&hellip;</span><a class="page-number" href="/page/63/">63</a><a class="extend next" rel="next" href="/page/21/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2017 失落的乐章
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/smackgg/hexo-theme-smackdown" target="_blank">Smackdown</a>
        </div>
    </div>
  </div>
</footer>
    </div>
    

<script>
	var yiliaConfig = {
		fancybox: ,
		mathjax: ,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="/js/main.js"></script>



  </div>
</body>
</html>