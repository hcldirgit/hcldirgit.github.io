<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>失落的乐章</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="失落的乐章的Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="失落的乐章">
<meta property="og:url" content="https://hcldirgit.github.io/page/19/index.html">
<meta property="og:site_name" content="失落的乐章">
<meta property="og:description" content="失落的乐章的Blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="失落的乐章">
<meta name="twitter:description" content="失落的乐章的Blog">
  
    <link rel="alternative" href="/atom.xml" title="失落的乐章" type="application/atom+xml">
  
  
    <link rel="icon" href="https://github.com/hcldirgit/image/blob/master/0.png?raw=true">
  
  <link rel="stylesheet" href="/css/style.css">
  
  
<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-85415703-1', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  <script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>
  <script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>

  
</head>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://github.com/hcldirgit/image/blob/master/0.png?raw=true" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">失落的乐章</a></h1>
		</hgroup>

		
		<p class="header-subtitle">技术面前，永远都是学生。</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Ansible/" style="font-size: 10.42px;">Ansible</a> <a href="/tags/Apache/" style="font-size: 18.33px;">Apache</a> <a href="/tags/Cacti/" style="font-size: 11.67px;">Cacti</a> <a href="/tags/DNS/" style="font-size: 13.33px;">DNS</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/FTP/" style="font-size: 11.25px;">FTP</a> <a href="/tags/Git/" style="font-size: 10.83px;">Git</a> <a href="/tags/HA集群/" style="font-size: 11.67px;">HA集群</a> <a href="/tags/Hadoop/" style="font-size: 12.5px;">Hadoop</a> <a href="/tags/Jenkins/" style="font-size: 10.42px;">Jenkins</a> <a href="/tags/LAMP/" style="font-size: 19.58px;">LAMP</a> <a href="/tags/LNMP/" style="font-size: 17.08px;">LNMP</a> <a href="/tags/LVS/" style="font-size: 16.67px;">LVS</a> <a href="/tags/Linux/" style="font-size: 19.17px;">Linux</a> <a href="/tags/Linux命令/" style="font-size: 20px;">Linux命令</a> <a href="/tags/Linux安全/" style="font-size: 14.17px;">Linux安全</a> <a href="/tags/Memcached/" style="font-size: 11.25px;">Memcached</a> <a href="/tags/MongoDB/" style="font-size: 15.42px;">MongoDB</a> <a href="/tags/MySQL/" style="font-size: 17.5px;">MySQL</a> <a href="/tags/NFS/" style="font-size: 10px;">NFS</a> <a href="/tags/Nagios/" style="font-size: 11.67px;">Nagios</a> <a href="/tags/Nginx/" style="font-size: 17.92px;">Nginx</a> <a href="/tags/OpenStack/" style="font-size: 11.25px;">OpenStack</a> <a href="/tags/Php/" style="font-size: 14.58px;">Php</a> <a href="/tags/Puppet/" style="font-size: 11.25px;">Puppet</a> <a href="/tags/Python/" style="font-size: 14.58px;">Python</a> <a href="/tags/Redis/" style="font-size: 16.25px;">Redis</a> <a href="/tags/Resin/" style="font-size: 10px;">Resin</a> <a href="/tags/Saltstack/" style="font-size: 10px;">Saltstack</a> <a href="/tags/Samba/" style="font-size: 12.08px;">Samba</a> <a href="/tags/Squid/" style="font-size: 14.58px;">Squid</a> <a href="/tags/Tomcat/" style="font-size: 13.75px;">Tomcat</a> <a href="/tags/Zabbix/" style="font-size: 15.83px;">Zabbix</a> <a href="/tags/haproxy/" style="font-size: 12.5px;">haproxy</a> <a href="/tags/keepalived/" style="font-size: 12.92px;">keepalived</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/shell练习/" style="font-size: 18.75px;">shell练习</a> <a href="/tags/正则表达式/" style="font-size: 12.92px;">正则表达式</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">失落的乐章</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="https://github.com/hcldirgit/image/blob/master/0.png?raw=true" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">失落的乐章</h1>
			</hgroup>
			
			<p class="header-subtitle">技术面前，永远都是学生。</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-MySQL/32. mysql一主多从同步配置" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/MySQL/32. mysql一主多从同步配置/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.789Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/MySQL/32. mysql一主多从同步配置/">
        mysql一主多从同步配置
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、环境"><a href="#一、环境" class="headerlink" title="一、环境"></a>一、环境</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;master：192.168.101<br>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;MYSQL版本：5.1.48-community-log</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;slave1:192.168.2.182<br>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;MYSQL版本：5.1.48-community-log</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;slave2:192.168.2.111<br>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;MYSQL版本：5.1.48-community-log</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;so…1 vs 2。</p>
<h2 id="二、master和-slave上的相关配置"><a href="#二、master和-slave上的相关配置" class="headerlink" title="二、master和 slave上的相关配置"></a>二、master和 slave上的相关配置</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;3台上都一样：</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>在/etc目录下可能无my.cnf文件，从/user/share/mysql目录中拷贝my-medium.cnf 到/etc并修改成my.cnf</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@localhost etc]<span class="comment"># cp /usr/share/mysql/my-medium.cnf my.cnf</span></div><div class="line">[root@localhost etc]<span class="comment"># ll |grep my</span></div><div class="line">-rwxr-xr-x 1 root root 5204 Feb 13 22:52 my_bak</div><div class="line">-rwxr-xr-x 1 root root 4765 Jul 10 23:07 my.cnf</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;master 上;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@mysql101 ~]<span class="comment"># vi /etc/my.cnf</span></div></pre></td></tr></table></figure>
<h3 id="1-修改master上的配置文件my-cnf。"><a href="#1-修改master上的配置文件my-cnf。" class="headerlink" title="1.修改master上的配置文件my.cnf。"></a>1.修改master上的配置文件my.cnf。</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在[mysqld]下添加如下字段：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">server-id = 1</div><div class="line"><span class="built_in">log</span>-bin=mysql-bin</div><div class="line">binlog-do-db=YYY //需要同步的数据库</div><div class="line">binlog-ignore-db=mysql //被忽略的数据库</div><div class="line">binlog-ignore-db=information-schema //被忽略的数据库</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在master上为slave添加一个同步账号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mysql&gt; grant replication slave on *.* to <span class="string">'affairlog'</span>@<span class="string">'192.168.2.182'</span> identified by <span class="string">'pwd123'</span>;</div><div class="line">//在slave1上登陆成功</div><div class="line">mysql&gt; grant replication slave on *.* to <span class="string">'affairlog'</span>@<span class="string">'192.168.2.111'</span> identified by <span class="string">'pwd123'</span>;</div><div class="line">//在slave2上登陆成功</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;保存后，重启master的mysql服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service mysql restart;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;用show master status命令查看日志情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show master status\G;</div><div class="line">*************************** 1. row ***************************</div><div class="line">File: mysql-bin.000087</div><div class="line">Position: 106</div><div class="line">Binlog_Do_DB: YYY</div><div class="line">Binlog_Ignore_DB: mysql,information-schema</div><div class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div></pre></td></tr></table></figure>
<h3 id="2-修改slave1上的配置文件my-cnf。"><a href="#2-修改slave1上的配置文件my-cnf。" class="headerlink" title="2.修改slave1上的配置文件my.cnf。"></a>2.修改slave1上的配置文件my.cnf。</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在[mysqld]下添加如下字段</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@mysql182 ~]<span class="comment"># vi /etc/my.cnf</span></div><div class="line">server-id=182</div><div class="line">master-host=192.168.3.101</div><div class="line">master-user= affairlog</div><div class="line">master-password=pwd123</div><div class="line">master-port=3306</div><div class="line">master-connect-retry=60</div><div class="line">replicate-do-db=YYY //同步的数据库</div><div class="line">replicate-ignore-db=mysql //被忽略的数据库</div><div class="line">replicate-ignore-db=information-schema //被忽略的数据库</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;保存后，重启slave的mysql服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service mysql restart;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改slave2上的配置文件my.cnf，和上面类似，只是把server-id改下，为了方便，我都用了相应的ip某位，</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;所以，slave2上我设置的server-id是111。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在进入两个slave机中的mysql。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">mysql&gt;start slave;</div><div class="line">mysql&gt;show slave status\G;</div><div class="line">*************************** 1. row ***************************</div><div class="line">Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</div><div class="line">Master_Host: 192.168.3.101</div><div class="line">Master_User: affairlog</div><div class="line">Master_Port: 3306</div><div class="line">Connect_Retry: 60</div><div class="line">Master_Log_File: mysql-bin.000087</div><div class="line">Read_Master_Log_Pos: 106</div><div class="line">Relay_Log_File: vm111-relay-bin.000002</div><div class="line">Relay_Log_Pos: 251</div><div class="line">Relay_Master_Log_File: mysql-bin.000087</div><div class="line">Slave_IO_Running: Yes</div><div class="line">Slave_SQL_Running: Yes</div><div class="line">Replicate_Do_DB: YYY</div><div class="line">Replicate_Ignore_DB: mysql,information-schema</div><div class="line">Replicate_Do_Table:</div><div class="line">Replicate_Ignore_Table:</div><div class="line">Replicate_Wild_Do_Table:</div><div class="line">Replicate_Wild_Ignore_Table:</div><div class="line">Last_Errno: 0</div><div class="line">Last_Error:</div><div class="line">Skip_Counter: 0</div><div class="line">Exec_Master_Log_Pos: 106</div><div class="line">Relay_Log_Space: 406</div><div class="line">Until_Condition: None</div><div class="line">Until_Log_File:</div><div class="line">Until_Log_Pos: 0</div><div class="line">Master_SSL_Allowed: No</div><div class="line">Master_SSL_CA_File:</div><div class="line">Master_SSL_CA_Path:</div><div class="line">Master_SSL_Cert:</div><div class="line">Master_SSL_Cipher:</div><div class="line">Master_SSL_Key:</div><div class="line">Seconds_Behind_Master: 0</div><div class="line">Master_SSL_Verify_Server_Cert: No</div><div class="line">Last_IO_Errno: 0</div><div class="line">Last_IO_Error:</div><div class="line">Last_SQL_Errno: 0</div><div class="line">Last_SQL_Error:</div><div class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>如果两个slave中的Slave_IO_Running、Slave_SQL_Running状态均为Yes则表明设置成功。</strong></p>
<h2 id="三、可能遇到的问题："><a href="#三、可能遇到的问题：" class="headerlink" title="三、可能遇到的问题："></a>三、可能遇到的问题：</h2><h3 id="问题1：Slave-IO-Running-No或者Slave-SQL-Running-No"><a href="#问题1：Slave-IO-Running-No或者Slave-SQL-Running-No" class="headerlink" title="问题1：Slave_IO_Running: No或者Slave_SQL_Running: No"></a>问题1：Slave_IO_Running: No或者Slave_SQL_Running: No</h3><h4 id="停掉slave服务"><a href="#停掉slave服务" class="headerlink" title="停掉slave服务"></a>停掉slave服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; slave stop;</div><div class="line">Query OK, 0 rows affected (2.01 sec)</div></pre></td></tr></table></figure>
<h4 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h4><ol>
<li>在master上查看。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show master status\G;</div><div class="line">*************************** 1. row ***************************</div><div class="line">File: mysql-bin.000087</div><div class="line">Position: 1845</div><div class="line">Binlog_Do_DB: YYY</div><div class="line">Binlog_Ignore_DB: mysql,information-schema</div><div class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div></pre></td></tr></table></figure>
<ol>
<li>到slave上手动同步。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mysql&gt;change master to</div><div class="line">&gt;master_host=<span class="string">'192.168.3.101'</span>,</div><div class="line">&gt;master_user=<span class="string">'affairlog'</span>,</div><div class="line">&gt;master_password=<span class="string">'pwd123'</span>,</div><div class="line">&gt;master_log_file=<span class="string">'mysql-bin.000087'</span>,</div><div class="line">&gt;master_log_pos=1845;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure>
<h4 id="启动slave服务"><a href="#启动slave服务" class="headerlink" title="启动slave服务"></a>启动slave服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; slave start;</div></pre></td></tr></table></figure>
<h4 id="再次查看Slave-IO-Running、Slave-SQL-Running状态，为Yes则表明设置成功。"><a href="#再次查看Slave-IO-Running、Slave-SQL-Running状态，为Yes则表明设置成功。" class="headerlink" title="再次查看Slave_IO_Running、Slave_SQL_Running状态，为Yes则表明设置成功。"></a>再次查看Slave_IO_Running、Slave_SQL_Running状态，为Yes则表明设置成功。</h4><h3 id="问题2：RROR-1198-HY000-This-operation-cannot-be-performed-with-a-running-slave-run-STOP-SLAVE-first"><a href="#问题2：RROR-1198-HY000-This-operation-cannot-be-performed-with-a-running-slave-run-STOP-SLAVE-first" class="headerlink" title="问题2：RROR 1198 (HY000): This operation cannot be performed with a running slave; run STOP SLAVE first"></a>问题2：RROR 1198 (HY000): This operation cannot be performed with a running slave; run STOP SLAVE first</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;错误重现：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mysql&gt;change master to</div><div class="line">&gt;master_host=<span class="string">'192.168.3.101'</span>,</div><div class="line">&gt;master_user=<span class="string">'affairlog'</span>,</div><div class="line">&gt;master_password=<span class="string">'pwd123'</span>,</div><div class="line">&gt;master_log_file=<span class="string">'mysql-bin.000087'</span>,</div><div class="line">&gt;master_log_pos=1845;</div><div class="line">ERROR 1198 (HY000): This operation cannot be performed with a running slave; run STOP SLAVE first</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;解决方法：</p>
<ol>
<li>停掉slave服务</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; slave stop;</div><div class="line">Query OK, 0 rows affected (2.01 sec)</div></pre></td></tr></table></figure>
<ol>
<li>重置slave服务</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; reset stop;</div><div class="line">Query OK, 0 rows affected (2.01 sec)</div></pre></td></tr></table></figure>
<ol>
<li>再执行一次change命令</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mysql&gt;change master to</div><div class="line">&gt;master_host=<span class="string">'192.168.3.101'</span>,</div><div class="line">&gt;master_user=<span class="string">'affairlog'</span>,</div><div class="line">&gt;master_password=<span class="string">'pwd123'</span>,</div><div class="line">&gt;master_log_file=<span class="string">'mysql-bin.000087'</span>,</div><div class="line">&gt;master_log_pos=1845;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure>
<ol>
<li>启动slave服务</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; slave start;</div></pre></td></tr></table></figure>
<p>5．再次查看Slave_IO_Running、Slave_SQL_Running状态，为Yes则表明设置成功。</p>
<h3 id="PS："><a href="#PS：" class="headerlink" title="PS："></a>PS：</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Slave_IO_Running：连接到主库，并读取主库的日志到本地，生成本地日志文件</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Slave_SQL_Running:读取本地日志文件，并执行日志里的SQL命令。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-MySQL/31. mysql5.1的RBR和SBR的优缺点" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/MySQL/31. mysql5.1的RBR和SBR的优缺点/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.788Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/MySQL/31. mysql5.1的RBR和SBR的优缺点/">
        mysql5.1的RBR和SBR的优缺点
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;MySQL 5.1 中，在复制方面的改进就是引进了新的复制技术：基于行的复制。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;简言之，这种新技术就是关注表中发生变化的记录，而非以前的照抄 binlog 模式。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;从 MySQL 5.1.12 开始，可以用以下三种模式来实现：</p>
<ul>
<li>基于SQL语句的复制(statement-based replication, SBR)</li>
<li>基于行的复制(row-based replication, RBR)</li>
<li>混合模式复制(mixed-based replication, MBR)。</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;相应地，binlog的格式也有三种：</p>
<ul>
<li>STATEMENT</li>
<li>ROW</li>
<li>MIXED</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;MBR 模式中，SBR 模式是默认的。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在运行时可以动态的改变binlog的格式，以下几种情况不能动态修改binlog格式：</p>
<ul>
<li>存储过程或者触发器中间。 </li>
<li>使用NDB engine类型的表</li>
<li>。 当前会话试用RBR模式，并且已打开了临时表。 </li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;如果binlog采用了MIXED 模式，那么在以下几种情况下会自动将binlog的模式由 SBR模式改成RBR模式。</p>
<ul>
<li>当DML语句更新一个NDB engine表时。 </li>
<li>当写操作中包含UUID()函数时。 </li>
<li>2个或两个以上包含AUTO_INCREMENT字段的表被更新时。 </li>
<li>进行INSERT DELAYED语句操作数据时。 </li>
<li>使用UDF时。 </li>
<li>视图中必须要求使用RBR时，例如创建视图是使用了UUID()函数。</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;设定主从复制模式的方法非常简单，只要在以前设定复制配置的基础上，再加一个参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">binlog_format=<span class="string">'STATEMENT'</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;或</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">binlog_format=<span class="string">'ROW'</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;或</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">binlog_format=<span class="string">'MIXED'</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在线动态修改binlog的格式。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SET SESSION binlog_format = <span class="string">'STATEMENT'</span>;</div><div class="line">mysql&gt; SET SESSION binlog_format = <span class="string">'ROW'</span>;</div><div class="line">mysql&gt; SET SESSION binlog_format = <span class="string">'MIXED'</span>;</div><div class="line">mysql&gt; SET GLOBAL binlog_format = <span class="string">'STATEMENT'</span>;</div><div class="line">mysql&gt; SET GLOBAL bin log_format = <span class="string">'ROW'</span>;</div><div class="line">mysql&gt; SET GLOBAL binlog_format = <span class="string">'MIXED'</span>;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;SBR和RBR两种模式各自的优缺点：</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;SBR 的优点：</p>
<ul>
<li>历史悠久，技术成熟。</li>
<li>binlog文件较小。</li>
<li>binlog中包含了所有数据库更改信息，可以据此来审核数据库的安全等情况。 </li>
<li>binlog可以用于实时的还原，而不仅仅用于复制。 </li>
<li>主从版本可以不一样，从服务器版本可以比主服务器版本高。</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;SBR 的缺点：</p>
<ul>
<li>不是所有的UPDATE语句都能被复制，尤其是包含不确定操作的时候。 </li>
<li>调用具有不确定因素的 UDF 时复制也可能出问题 </li>
<li>使用以下函数的语句也无法被复制：<ul>
<li>LOAD_FILE()</li>
<li>UUID()</li>
<li>USER()</li>
<li>FOUND_ROWS()</li>
<li>SYSDATE() (除非启动时启用了 –sysdate-is-now 选项) </li>
</ul>
</li>
<li>INSERT … SELECT 会产生比 RBR 更多的行级锁</li>
<li>复制需要进行全表扫描(WHERE 语句中没有使用到索引)的 UPDATE 时，需要比 RBR 请求更多的行级锁 </li>
<li>对于有 AUTO_INCREMENT 字段的 InnoDB表而言，INSERT 语句会阻塞其他 INSERT 语句 </li>
<li>对于一些复杂的语句，在从服务器上的耗资源情况会更严重，而 RBR 模式下，只会对那个发生变化的记录产生影响 </li>
<li>存储函数(不是存储过程)在被调用的同时也会执行一次 NOW() 函数，这个可以说是坏事也可能是好事 </li>
<li>确定了的 UDF 也需要在从服务器上执行 </li>
<li>数据表必须几乎和主服务器保持一致才行，否则可能会导致复制出错 </li>
<li>执行复杂语句如果出错的话，会消耗更多资源</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;RBR 的优点：</p>
<ul>
<li>任何情况都可以被复制，这对复制来说是最安全可靠的 </li>
<li>和其他大多数数据库系统的复制技术一样 </li>
<li>多数情况下，从服务器上的表如果有主键的话，复制就会快了很多 </li>
<li>复制以下几种语句时的行锁更少：<ul>
<li>INSERT … SELECT</li>
<li>包含 AUTO_INCREMENT 字段的 INSERT</li>
<li>没有附带条件或者并没有修改很多记录的 UPDATE 或 DELETE 语句 </li>
</ul>
</li>
<li>执行 INSERT，UPDATE，DELETE 语句时锁更少 - </li>
<li>从服务器上采用多线程来执行复制成为可能</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;RBR 的缺点：</p>
<ul>
<li>binlog 大了很多 </li>
<li>复杂的回滚时 binlog 中会包含大量的数据 </li>
<li>主服务器上执行 UPDATE 语句时，所有发生变化的记录都会写到 binlog 中，而 SBR 只会写一次，这会导致频繁发生 binlog 的并发写问题 </li>
<li>UDF 产生的大 BLOB 值会导致复制变慢 </li>
<li>无法从 binlog 中看到都复制了写什么语句 </li>
<li>当在非事务表上执行一段堆积的SQL语句时，最好采用 SBR 模式，否则很容易导致主从服务器的数据不一致情况发生</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;另外，针对系统库 mysql 里面的表发生变化时的处理规则如下：</p>
<ul>
<li>如果是采用 INSERT，UPDATE，DELETE 直接操作表的情况，则日志格式根据 binlog_format 的设定而记录 </li>
<li>如果是采用 GRANT，REVOKE，SET PASSWORD 等管理语句来做的话，那么无论如何都采用 SBR 模式记录 </li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注：采用 RBR 模式后，能解决很多原先出现的主键重复问题。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-MySQL/3. 源码编译安装MySQL5.6报错及解决方法" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/MySQL/3. 源码编译安装MySQL5.6报错及解决方法/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.787Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/MySQL/3. 源码编译安装MySQL5.6报错及解决方法/">
        源码编译安装MySQL5.6报错及解决方法
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;以前都是mysql5.1做的LAMP搭建，比较顺利。试了一下安装mysql5.6.</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;由于系统没有cmake命令，于是 <code>yum install -y cmake</code> 进行安装</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在cmake这里</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cmake -DCMAKE_INSTALL_PREFIX=/usr/<span class="built_in">local</span>/mysql -DMYSQL_DATADIR=/data/mysql_data -DMYSQL_UNIX_ADDR=/usr/<span class="built_in">local</span>/mysql/mysql.sock -DSYSCONFDIR=/etc -DWITH_MYISAM_STORAGE_ENGINE=1 -DWITH_ARCHIVE_STORAGE_ENGINE=1 -DWITH_BLACKHOLE_STORAGE_ENGINE=1 -DWITH_INNOBASE_STORAGE_ENGINE=1 -DWITH_MEMORY_STORAGE_ENGINE=1 -DWITH_READLINE=1 -DMYSQL_TCP_PORT=3306 -DENABLED_LOCAL_INFILE=1 -DWITH_PARTITION_STORAGE_ENGINE=1 -DEXTRA_CHARSETS=all -DDEFAULT_CHARSET=utf8 -DDEFAULT_COLLATION=utf8_general_ci</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;报错如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">-- Could NOT find Curses (missing: CURSES_LIBRARY CURSES_INCLUDE_PATH)</div><div class="line">CMake Error at cmake/readline.cmake:82 (MESSAGE):</div><div class="line"> Curses library not found. Please install appropriate package,</div><div class="line">    remove CMakeCache.txt and rerun cmake.On Debian/Ubuntu, package name is libncurses5-dev, on Redhat and derivates it is ncurses-devel.</div><div class="line">Call Stack (most recent call first):</div><div class="line"> cmake/readline.cmake:126 (FIND_CURSES)</div><div class="line"> cmake/readline.cmake:216 (MYSQL_USE_BUNDLED_LIBEDIT)</div><div class="line"> CMakeLists.txt:250 (MYSQL_CHECK_READLINE)</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;解决办法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@localhost mysql-5.6.1]<span class="comment"># rm CMakeCache.txt</span></div><div class="line">[root@localhost mysql-5.6.1]<span class="comment"># yum install -y ncurses-devel</span></div><div class="line">[root@localhost mysql-5.5.11]<span class="comment"># yum install -y bison</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;接着继续执行编译</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cmake......</div><div class="line">make &amp;&amp; make install</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编译完成，安装好之后。新建系统用户mysql，并禁止登录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">useradd -s /sbin/nologin mysql</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;建立数据库存放目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir -p /data/mysql_data</div><div class="line">chown -R mysql:mysql /data/mysql_data</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;进行数据库初始化</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/mysql</div><div class="line">./scripts/mysql_install_db --user=mysql --datadir=/data/mysql_data</div><div class="line">cp support-files/my-large.cnf /etc/my.cnf </div><div class="line">cp support-files/mysql.server /etc/init.d/mysqld</div><div class="line">chmod 755 /etc/init.d/mysqld </div><div class="line">vim /etc/init.d/mysqld //添加datadir=路径</div><div class="line">service mysqld start -------------------------------服务启动报错</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;报错信息如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@centos6 mysql_data]<span class="comment"># service mysqld start</span></div><div class="line">Starting MySQL...The server quit without updating PID file [失败]/mysql_data/centos6.6.pid).</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;解决方法：根据报错信息，怀疑可能文件丢失造成的原因，对比另一个测试机已经搭建好的环境，检查同样的数据库目录下，发现本机少了一个centos6.6.pid文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /data/mysql_data //数据库文件存放目录</div><div class="line">vi centos6.6.pid //编辑此文件，添加一个pid号码</div><div class="line">1583 </div><div class="line">保存退出。 //1583是我在系统中随意添加的号，只要保证系统进程里没有的ID都可以</div><div class="line">service mysqld start 正常启动 ----------------------------成功解决</div></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-MySQL/30. mysql架构由小变大的演变过程" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/MySQL/30. mysql架构由小变大的演变过程/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.787Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/MySQL/30. mysql架构由小变大的演变过程/">
        mysql架构由小变大的演变过程
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;假设一个网站（discuz）从最开始访问量很小做到日pv千万，我们来推测一下它的mysql服务器架构演变过程。</p>
<h2 id="第一阶段"><a href="#第一阶段" class="headerlink" title="第一阶段"></a>第一阶段</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;网站访问量日pv量级在1w以下。<strong>单台机器跑web和db</strong>，不需要做架构层调优（比如，不需要增加memcached缓存）。此时，数据往往都是每日冷备份的，但有时候如果考虑数据安全性，会搭建一个mysql主从。</p>
<h2 id="第二阶段"><a href="#第二阶段" class="headerlink" title="第二阶段"></a>第二阶段</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;网站访问量日pv达到几万。此时单台机器已经有点负载，<strong>需要我们把web和db分开</strong>，需要搭建memcached服务作为缓存。也就是说，在这个阶段，我们还可以使用单台机器跑mysql去承担整个网站的数据存储和查询。如果做mysql主从，目的也是为了数据安全性。</p>
<h2 id="第三阶段"><a href="#第三阶段" class="headerlink" title="第三阶段"></a>第三阶段</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;网站访问量日pv达到几十万。单台机器虽然也可以支撑，但是需要的机器配置要比之前的机器好很多。如果经费允许，可以购买配置很高的机器来跑mysql服务，但是并不是说，配置翻倍，性能也翻倍，到了一定阶段配置增加已经不能带来性能的增加。所以，此阶段，我们会想到做mysql服务的集群，也就是说我们可以拿多台机器跑mysql。但，mysql的集群和web集群是不一样的，我们需要考虑数据的一致性，所以不能简单套用做web集群的方式（lvs，nginx代理）。可以做的架构是，<strong>mysql主从，一主多从</strong>。为了保证架构的健壮和数据完整，主只能是一个，从可以是多个。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;还有一个问题，我们需要想到，就是在前端web层，我们的程序里面指定了mysql机器的ip，那么当mysql机器有多台时，程序里面如何去配置？discuz，其实有一个功能，支持mysql读写分离。即，我们可以拿多台机器跑mysql，其中一台写，其他多台是读，我们只需要把读和写的ip分别配置到程序中，程序自动会去区分机器。当然，如果不使用discuz自带的配置，我们还可以引用一个软件叫做 <strong>mysql-proxy</strong>, 使用他来实现读写分离。它支持一主多从的模式。</p>
<h2 id="第四阶段"><a href="#第四阶段" class="headerlink" title="第四阶段"></a>第四阶段</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;网站访问量日pv到几百万。之前的一主多从模式已经遇到瓶颈，因为当网站访问量变大，读数据库的量也会越来越大，我们需要多加一些从进来，但是从的数量增加到数十台时，由于主需要把bin-log全部分发到所有从上，那么这个过程本身就是一件很繁琐的事情，再加上频繁读取，势必会造成从上同步过来的数据有很大延迟。所以，我们可以做一个优化， <strong>把mysql原来的一主多从变为一主一从，然后从作为其他从的主，而前面的主只负责网站业务的写入，而后面的从不负责网站任何业务，只负责给其他从同步bin-log</strong>。这样还可以继续多叠加几个从库。</p>
<h2 id="第五阶段"><a href="#第五阶段" class="headerlink" title="第五阶段"></a>第五阶段</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;网站访问量日pv到1千万的时候，我们发现，网站的写入量非常大，我们之前架构中只有一个主，这里的主已经成为瓶颈了。所以，需要再近一步做出调整。比如，我们可以把业务分模块，把用户相关的单独分离出来，把权限、积分等也可以分离出来单独跑一个库，然后再做主从，也就是所谓的分库。当然也可以换一个纬度，把访问量或者写入量大的表单独分离出来，跑在一台服务器上，也可以把一个表分成多个小表。这一步操作，涉及到一些程序上的改动，所以需要事先和开发同事做好沟通和设计。总之，这一步要做的就是<strong>分库分表</strong>。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;再往后发展，继续把大表分小表即可。 而国内阿里淘宝网站的数据量是巨量的，他们的数据库全部都是mysql，他们的mysql架构就是遵循分库分表这个原则的，只不过他们划分规则会有很多纬度，比如可以根据地域划分，可以根据买家、卖家划分，可以根据时间划分等等。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-MySQL/29. mysql AB 常见错误" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/MySQL/29. mysql AB 常见错误/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.786Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/MySQL/29. mysql AB 常见错误/">
        mysql AB 常见错误
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这篇文章旨在记录MySQL Replication的常见错误，包括自己工作中遇到的与网友在工作中遇到的，方面自己及别人以后进行查找。每个案例都是通过Last_IO_Errno/Last_IO_Error或者Last_SQL_Errno/Last_SQL_Error给出错误关键信息，所以以后查找时只需直接ctrl+F查找关键字就行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Last_SQL_Errno: 1677</div><div class="line">Last_SQL_Error: Column 1 of table <span class="string">'test.t'</span> cannot be converted from <span class="built_in">type</span> <span class="string">'int'</span> to <span class="built_in">type</span> <span class="string">'bigint(20)'</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;解决方法：这个案例是从网上找到的，自己动手实验了一把。从错误信息来看表面上是由于在slave上无法执行一条转换字段类型的SQL语句。实际上并不是有这种语句直接引起的，而是间接引起的（之前某些操作导致主从表字段类型不一致，接下来对这个表进行DML时就会报错）。它的意思是在对这个表t进行DML操作时，发现主从上表结果不一致，比如这里是说在主上t的字段1是int类型，但是从上t的字段1是bigint类型，所以报错。那么为什么要报错呢？这是从安全角度考虑，因为如果字段类型不一致可能会导致数据截断之类的问题。那么解决方法呢？通过参数slave_type_conversions进行控制，它有三种取值：</p>
<ul>
<li>ALL_LOSSY：仅支持有损转换，什么叫有损？比如一个值本来是bigint存储为9999999999999，现在转换为int类型势必会要截断从而导致数据不一致。</li>
<li>ALL_NON_LOSSY：仅支持无损转换，只能在无损的情况下才能进行转换</li>
<li>ALL_LOSSY,ALL_NON_LOSSY：有损/无算转换都支持</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;空，即不设置这个参数：必须主从的字段类型一模一样。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注意： 前面说的这几中情况都只在binlog_format=ROW的情况下才有效。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Last_SQL_Errno: 1194</div><div class="line">Last_SQL_Error: Error <span class="string">'Table '</span>traincenter<span class="string">' is marked as crashed and should be repaired'</span> on query. Default database: <span class="string">'basketballman'</span>. Query: <span class="string">'update traincenter set points='</span>4<span class="string">',pointstime='</span>1361912066<span class="string">'  where uid = '</span>1847482697<span class="string">' limit 1'</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;解决方法：myisam表traincenter损坏，直接repair table即可。至于为什么myisam类型表比innodb更容易损坏，我觉得有两个原因：1，innodb有double write机制，损坏或者half write的页可以用它恢复，第二innodb是事务引擎，都有操作都是事务的，而myisam是非事务的，存在写一半但是操作终止情况。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Last_IO_Errno: 1236</div><div class="line">Last_IO_Error: Got fatal error 1236 from master when reading data from binary <span class="built_in">log</span>: <span class="string">'Could not find first log file name in binary log index file'</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;解决方法：主库上的binlog文件已经不存在但是在index file中确有相应记录存在。我这里发生这个错误的原因在于由于复制中断时间很长，报警出来一直没人处理，这个中断时间超过master上binlog超期时间，等恢复复制时需要的binlog已经由于其超期而被删掉，没办法只好重建这个实例了。以大家都要引以为戒。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Last_IO_Errno: 1593</div><div class="line">Last_IO_Error: Fatal error: The slave I/O thread stops because master and slave have equal MySQL server ids; these ids must be different <span class="keyword">for</span> replication to work (or the --replicate-same-server-id option must be used on slave but this does not always make sense; please check the manual before using it).</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;解决方法：主从配置的server-id一样，而在主从复制环境中server-id一样的binlog events都会被过滤掉。具体server-id的含义可以了解一下复制原理。这个一般是因为拷贝配置文件时忘记修改server-id导致，遇到这类问题也比较容易，平时操作谨慎一点即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Last_Errno: 1053</div><div class="line">Last_Error: Query partially completed on the master (error on master: 1053) and was aborted. There is a chance that your master is inconsistent at this point. If you are sure that your master is ok, run this query manually on the slave and <span class="keyword">then</span> restart the slave with SET GLOBAL SQL_SLAVE_SKIP_COUNTER=1; START SLAVE; . Query: <span class="string">'insert into ...</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;解决方法：查询在master上部分完成，然后终止了。这马上又能想到是myisam表，结果也正是这样。由于myisam不支持事务所以可能存在一个查询完成一部分然后失败的情况。解决方法一般也就是提示信息给出的跳过一个binlog event。不过确认跳过之前最好还是查询一下master上是否真的存在相应的记录，因为错误信息同时还会给出它认为在master上执行一部分然后终止的查询语句。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Last_SQL_Errno: 1666</div><div class="line">Last_SQL_Error: Error executing row event: <span class="string">'Cannot execute statement: impossible to write to binary log since statement is in row format and BINLOG_FORMAT = STATEMENT.'</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;解决方法：这个案例的背景是做一个ABC结构的复制，B、C中设定的binlog_format=statement，A中的是MIXED，所以当B尝试重做A过来的relay log，然后记录binlog（传给C）时发现relay log的binlog_format与自己设定的binlog_format不一致。我当时就是直接先更改BC的binlog_format=MIXED解决。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Last_Errno: 1032</div><div class="line">Last_Error: Could not execute Update_rows event on table db.table; Can<span class="string">'t find record in '</span>table<span class="string">', Error_code: 1032; handler error HA_ERR_KEY_NOT_FOUND; the event'</span>s master <span class="built_in">log</span> mysql-bin.000064, end_log_pos 158847</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;解决方法：这个是在binlog_format=row复制下发生的。原因是因为row格式复制是最严格的，所以在mysql看来如果在从库上找不到要更新的这条记录，那么就代表主从数据不一致，因此报错。另外顺便说一句，对于row格式binlog，如果某个更新操作实际上并没有更新行，这个操作是不会记binlog的，因为row格式的binlog宗旨就是只记录发生了改变的行。所以这个解决办法根据你自己实际应用来定，最好的方法还是重做slave吧，这样更放心。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Last_Errno: 28</div><div class="line">Last_Error: Error <span class="keyword">in</span> Append_block event: write to <span class="string">'/tmp/SQL_LOAD-32343798-72213798-1.data'</span> failed</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;解决方法： 首先说错误原因：主库执行load data infile，同步到从库后load data infile存放的文件默认是放在/tmp(由参数slave_load_tmpdir控制)，而/tmp空间不够因此报错。因此只要将从库上slave_load_tmpdir设置到一个磁盘空间足够大的分区就行。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-MySQL/28. cobar实现mysql分库分表" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/MySQL/28. cobar实现mysql分库分表/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.785Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/MySQL/28. cobar实现mysql分库分表/">
        cobar实现mysql分库分表
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;cobar 编译安装配置笔记:<a href="https://github.com/alibaba/cobar" target="_blank" rel="external">https://github.com/alibaba/cobar</a></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;windows下使用eclipse导入cobar项目,eclipse File -&gt; Import -&gt; Git :<a href="https://github.com/alibaba/cobar" target="_blank" rel="external">https://github.com/alibaba/cobar</a></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;linux下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wget https://codeload.github.com/alibaba/cobar/zip/master</div></pre></td></tr></table></figure>
<p>F:\mycat&gt;mvn compile<br>F:\mycat&gt;mvn package</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;生成压缩包cobar-server-1.2.7.tar.gz，放到linux环境中解压出来，没有logs目录，新建并运行查看目录结构如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[root@XAYQ-Test3 ~]<span class="comment"># tree /opt/cobar-server  </span></div><div class="line">/opt/software/cobar-server  </div><div class="line">├── bin  </div><div class="line">│   ├── restart.sh  </div><div class="line">│   ├── shutdown.sh  </div><div class="line">│   ├── startup.bat  </div><div class="line">│   └── startup.sh  </div><div class="line">├── conf  </div><div class="line">│   ├── log4j.xml                       <span class="comment">#日志配置文件，不需要修改  </span></div><div class="line">│   ├── rule.xml                        <span class="comment">#mysql路由规则  </span></div><div class="line">│   ├── schema.xml                      <span class="comment">#  </span></div><div class="line">│   └── server.xml                      <span class="comment">#  </span></div><div class="line">├── lib  </div><div class="line">│   ├── cobar-server-1.2.7.jar  </div><div class="line">│   └── log4j-1.2.17.jar  </div><div class="line">└── logs  </div><div class="line">    ├── alarm.log  </div><div class="line">    ├── console.log  </div><div class="line">    ├── heartbeat.log  </div><div class="line">    ├── stdout.log  </div><div class="line">    └── stdout.log.2014-07-10</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;1.主要修改以下几个文件：rule.xml </p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<!-- 路由规则定义，定义什么表，什么字段，采用什么路由算法 -->  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">&lt;tableRule name=<span class="string">"rule1"</span>&gt;  </div><div class="line">  &lt;rule&gt;  </div><div class="line">    &lt;columns&gt;id&lt;/columns&gt;  </div><div class="line">    &lt;algorithm&gt;&lt;![CDATA[ func1(<span class="variable">$&#123;id&#125;</span>) ]]&gt;&lt;/algorithm&gt;  </div><div class="line">  &lt;/rule&gt;  </div><div class="line">&lt;/tableRule&gt;  </div><div class="line">  </div><div class="line">&lt;!-- 路由函数定义 --&gt;  </div><div class="line">&lt;<span class="keyword">function</span> name=<span class="string">"func1"</span> class=<span class="string">"com.alibaba.cobar.route.function.PartitionByLong"</span>&gt;  </div><div class="line">  &lt;property name=<span class="string">"partitionCount"</span>&gt;2&lt;/property&gt;  </div><div class="line">  &lt;property name=<span class="string">"partitionLength"</span>&gt;512&lt;/property&gt;  </div><div class="line">&lt;/<span class="keyword">function</span>&gt;  </div><div class="line">```  </div><div class="line"></div><div class="line">&amp;<span class="comment">#160;&amp;#160;&amp;#160;&amp;#160;&amp;#160;&amp;#160;&amp;#160;&amp;#160;2.schema.xml ，定义数据节点</span></div><div class="line"></div><div class="line">```bash</div><div class="line">&lt;cobar:schema xmlns:cobar=<span class="string">"http://cobar.alibaba.com/"</span>&gt;  </div><div class="line">  </div><div class="line">  &lt;!-- schema定义 --&gt;  </div><div class="line">  &lt;schema name=<span class="string">"cppdb"</span> dataNode=<span class="string">"cppDb1"</span>&gt;  </div><div class="line">    &lt;table name=<span class="string">"tb2"</span> dataNode=<span class="string">"cppDb2,cppDb3"</span> rule=<span class="string">"rule1"</span> /&gt;  </div><div class="line">  &lt;/schema&gt;  </div><div class="line">  </div><div class="line">  &lt;!-- 数据节点定义，数据节点由数据源和其他一些参数组织而成。--&gt;  </div><div class="line">  &lt;dataNode name=<span class="string">"cppDb1"</span>&gt;  </div><div class="line">    &lt;property name=<span class="string">"dataSource"</span>&gt;  </div><div class="line">      &lt;dataSourceRef&gt;cppDataSource[0]&lt;/dataSourceRef&gt;  </div><div class="line">    &lt;/property&gt;  </div><div class="line">  &lt;/dataNode&gt;  </div><div class="line">  &lt;dataNode name=<span class="string">"cppDb2"</span>&gt;  </div><div class="line">    &lt;property name=<span class="string">"dataSource"</span>&gt;  </div><div class="line">      &lt;dataSourceRef&gt;cppDataSource[1]&lt;/dataSourceRef&gt;  </div><div class="line">    &lt;/property&gt;  </div><div class="line">  &lt;/dataNode&gt;  </div><div class="line">  &lt;dataNode name=<span class="string">"cppDb3"</span>&gt;  </div><div class="line">    &lt;property name=<span class="string">"dataSource"</span>&gt;  </div><div class="line">      &lt;dataSourceRef&gt;cppDataSource[2]&lt;/dataSourceRef&gt;  </div><div class="line">    &lt;/property&gt;  </div><div class="line">  &lt;/dataNode&gt;  </div><div class="line">  </div><div class="line">  &lt;!-- 数据源定义，数据源是一个具体的后端数据连接的表示。--&gt;  </div><div class="line">  &lt;dataSource name=<span class="string">"cppDataSource"</span> <span class="built_in">type</span>=<span class="string">"mysql"</span>&gt;  </div><div class="line">    &lt;property name=<span class="string">"location"</span>&gt;  </div><div class="line">      &lt;location&gt;172.22.14.7:3306/cpp1&lt;/location&gt;  </div><div class="line">      &lt;location&gt;172.22.14.7:3306/cpp2&lt;/location&gt;  </div><div class="line">      &lt;location&gt;172.22.14.7:3306/cpp3&lt;/location&gt;  </div><div class="line">    &lt;/property&gt;  </div><div class="line">    &lt;property name=<span class="string">"user"</span>&gt;root&lt;/property&gt;  </div><div class="line">    &lt;property name=<span class="string">"password"</span>&gt;root&lt;/property&gt;  </div><div class="line">    &lt;property name=<span class="string">"sqlMode"</span>&gt;STRICT_TRANS_TABLES&lt;/property&gt;  </div><div class="line">  &lt;/dataSource&gt;  </div><div class="line">  </div><div class="line">&lt;/cobar:schema&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;3.server.xml，定义cobar对外统一的数据接口。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">  &lt;!-- 用户访问定义，用户名、密码、schema等信息。 --&gt;</div><div class="line"></div><div class="line"></div><div class="line">&lt;user name=<span class="string">"root"</span>&gt;  </div><div class="line">&lt;property name=<span class="string">"password"</span>&gt;root&lt;/property&gt;  </div><div class="line">&lt;property name=<span class="string">"schemas"</span>&gt;cppdb&lt;/property&gt;  </div><div class="line">t;/user&gt;</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-MySQL/27. Mysql主主复制架构配置" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/MySQL/27. Mysql主主复制架构配置/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.784Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/MySQL/27. Mysql主主复制架构配置/">
        Mysql主主复制架构配置
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;MySQL主主复制结构区别于主从复制结构。在主主复制结构中，两台服务器的任</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;何一台上面的数据库存发生了改变都会同步到另一台服务器上，这样两台服务器</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;互为主从，并且都能向外提供服务。 这就比使用主从复制具有更好的性能。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;接下来我将使用两个同样的服务器来实现这个效果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">server1_mysql：192.168.1.108</div><div class="line">server2_mysql: 192.168.1.110</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;拓扑结构：<br>server1_mysql——-server2_mysql</p>
<h2 id="1-创建用户并授权"><a href="#1-创建用户并授权" class="headerlink" title="1.创建用户并授权"></a>1.创建用户并授权</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;server1:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; GRANT REPLICATION SLAVE ON *.* TO <span class="string">'server2'</span>@<span class="string">'192.168.1.110'</span> </div><div class="line">IDENTIFIED BY <span class="string">'server2'</span>;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;server2:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; GRANT REPLICATION SLAVE ON *.* TO <span class="string">'server1'</span>@<span class="string">'192.168.1.108'</span> </div><div class="line">IDENTIFIED BY <span class="string">'server1'</span>;</div></pre></td></tr></table></figure>
<h2 id="2-修改Mysql的主配置文件"><a href="#2-修改Mysql的主配置文件" class="headerlink" title="2.修改Mysql的主配置文件"></a>2.修改Mysql的主配置文件</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;server1:</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[mysqld]</div><div class="line">server-id = 10</div><div class="line"><span class="built_in">log</span>-bin = mysql-bin</div><div class="line">replicate-do-db = mydb</div><div class="line">auto-increment-increment = 2   //每次增长2</div><div class="line">auto-increment-offset = 1  //设置自动增长的字段的偏移量，即初始值为2</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;启动Mysql服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># service mysqld restart</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;server2:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[mysqld]</div><div class="line"> server-id = 20</div><div class="line"> <span class="built_in">log</span>-bin = mysql-bin</div><div class="line"> replicate-do-db = mydb</div><div class="line"> auto-increment-increment = 2  //每次增长2</div><div class="line"> auto-increment-offset = 2 //设置自动增长的字段的偏移量，即初始值为2</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;启动Mysql服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># service mysqld restart</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注：二都只有server-id不同和 auto-increment- offset不同.auto-increment-increment的值应设为整个结构中服务器的总数，本案例用到两台服务器，所以值设为2。</p>
<h2 id="3-重新启动两个服务器"><a href="#3-重新启动两个服务器" class="headerlink" title="3.重新启动两个服务器"></a>3.重新启动两个服务器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># service mysqld restart</span></div></pre></td></tr></table></figure>
<h2 id="4-为了让两个数据库一样，我们备份其中一个数据库，然后在另一个数据库上恢复，这样是两个数据库一开始都是一样的。"><a href="#4-为了让两个数据库一样，我们备份其中一个数据库，然后在另一个数据库上恢复，这样是两个数据库一开始都是一样的。" class="headerlink" title="4.为了让两个数据库一样，我们备份其中一个数据库，然后在另一个数据库上恢复，这样是两个数据库一开始都是一样的。"></a>4.为了让两个数据库一样，我们备份其中一个数据库，然后在另一个数据库上恢复，这样是两个数据库一开始都是一样的。</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在server1上操作:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mysqldump --databases luowei &gt; /tmp/luowei.sql</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在server2上操作：创建一个与mydb同名的空数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mysql</span></div><div class="line">    &gt; CREATE DATABASE mydb;</div><div class="line">    &gt;\q</div><div class="line"><span class="comment"># scp 192.168.1.108:/tmp/mydb.sql  ./</span></div><div class="line"><span class="comment"># mysql -uroot -p mydb &lt; /tmp/luowei.sql</span></div></pre></td></tr></table></figure>
<h2 id="5-然后两个服务器相互通告二进制日志的位置并启动复制功能："><a href="#5-然后两个服务器相互通告二进制日志的位置并启动复制功能：" class="headerlink" title="5.然后两个服务器相互通告二进制日志的位置并启动复制功能："></a>5.然后两个服务器相互通告二进制日志的位置并启动复制功能：</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在server1上：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mysql</span></div><div class="line">   &gt; CHANGE MASTER TO</div><div class="line">   &gt; MASTER_HOST=<span class="string">'192.168.1.110'</span>,</div><div class="line">   &gt; MASTER_USER=<span class="string">'server2'</span>,</div><div class="line">   &gt; MASTER_PASSWORD=<span class="string">'server2'</span>;</div><div class="line">mysql &gt; START SLAVE;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在server2上：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mysql</span></div><div class="line">   &gt; CHANGE MASTER TO</div><div class="line">   &gt; MASTER_HOST=<span class="string">'192.168.1.108'</span>,</div><div class="line">   &gt; MASTER_USER=<span class="string">'server1'</span>,</div><div class="line">   &gt; MASTER_PASSWORD=<span class="string">'server1'</span>;</div><div class="line">mysql &gt; START SLAVE;</div></pre></td></tr></table></figure>
<h2 id="6-查看，并验证"><a href="#6-查看，并验证" class="headerlink" title="6.查看，并验证"></a>6.查看，并验证</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;分别在两个数据库服务器上查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql &gt; SHOW SLAVE STATUS\G;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后查看数据库和表，你会发现内容是一样的，这样就是整个主主Mysql的架构的配置过程。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-MySQL/26. Mysql数据库主从心得整理" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/MySQL/26. Mysql数据库主从心得整理/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.783Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/MySQL/26. Mysql数据库主从心得整理/">
        Mysql数据库主从心得整理
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、mysql主从的原理"><a href="#一、mysql主从的原理" class="headerlink" title="一、mysql主从的原理"></a>一、mysql主从的原理</h2><h3 id="1、Replication-线程"><a href="#1、Replication-线程" class="headerlink" title="1、Replication 线程"></a>1、Replication 线程</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Mysql的 Replication 是一个异步的复制过程（mysql5.1.7以上版本分为异步复制和半同步两种模式），从一个 Mysql instace(我们称之为 Master)复制到另一个 Mysql instance(我们称之 Slave)。在 Master 与 Slave 之间的实现整个复制过程主要由三个线程来完成，其中两个线程(Sql线程和IO线程)在 Slave 端，另外一个线程(IO线程)在 Master 端。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;要实现 MySQL 的 Replication ，首先必须打开 Master 端的Binary Log(mysql-bin.xxxxxx)功能，否则无法实现。因为整个复制过程实际上就是Slave从Master端获取该日志然后再在自己身上完全 顺序的执行日志中所记录的各种操作。打开 MySQL 的 Binary Log 可以通过在启动 MySQL Server 的过程中使用 “—log-bin” 参数选项，或者在 my.cnf 配置文件中的 mysqld 参数组([mysqld]标识后的参数部分)增加 “log-bin” 参数项。</p>
<h3 id="2、MySQL-复制的基本过程如下："><a href="#2、MySQL-复制的基本过程如下：" class="headerlink" title="2、MySQL 复制的基本过程如下："></a>2、MySQL 复制的基本过程如下：</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;2.1．Slave 上面的IO线程连接上 Master，并请求从指定日志文件的指定位置(或者从最开始的日志)之后的日志内容；</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;2.2. Master 接收到来自 Slave 的 IO 线程的请求后，通过负责复制的 IO 线程根据请求信息读取指定日志指定位置之后的日志信息，返回给 Slave 端的 IO 线程。返回信息中除了日志所包含的信息之外，还包括本次返回的信息在 Master 端的 Binary Log 文件的名称以及在 Binary Log 中的位置；</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;2.3. Slave 的 IO 线程接收到信息后，将接收到的日志内容依次写入到 Slave 端的Relay Log文件(mysql-relay-bin.xxxxxx)的最末端，并将读取到的Master端的bin-log的文件名和位置记录到master- info文件中，以便在下一次读取的时候能够清楚的高速Master“我需要从某个bin-log的哪个位置开始往后的日志内容，请发给我”</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;2.4. Slave 的 SQL 线程检测到 Relay Log 中新增加了内容后，会马上解析该 Log 文件中的内容成为在 Master 端真实执行时候的那些可执行的 Query 语句，并在自身执行这些 Query。这样，实际上就是在 Master 端和 Slave 端执行了同样的 Query，所以两端的数据是完全一样的。</p>
<h3 id="3、Mysql复制的几种模式"><a href="#3、Mysql复制的几种模式" class="headerlink" title="3、Mysql复制的几种模式"></a>3、Mysql复制的几种模式</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;3.1.从 MySQL 5.1.12 开始，可以用以下三种模式来实现：</p>
<ul>
<li>基于SQL语句的复制(statement-based replication, SBR)，</li>
<li>基于行的复制(row-based replication, RBR)，</li>
<li>混合模式复制(mixed-based replication, MBR)。</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;相应地，binlog的格式也有三种：STATEMENT，ROW，MIXED。 MBR 模式中，SBR 模式是默认的。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在运行时可以动态改动 binlog的格式，除了以下几种情况：</p>
<ol>
<li>存储流程或者触发器中间</li>
<li>启用了NDB</li>
<li>当前会话试用 RBR 模式，并且已打开了临时表</li>
</ol>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;如果binlog采用了 MIXED 模式，那么在以下几种情况下会自动将binlog的模式由 SBR 模式改成 RBR 模式：</p>
<ol>
<li>当DML语句更新一个NDB表时</li>
<li>当函数中包含 UUID() 时</li>
<li>2个及以上包含 AUTO_INCREMENT 字段的表被更新时</li>
<li>行任何 INSERT DELAYED 语句时</li>
<li>用 UDF 时</li>
<li>视图中必须要求运用 RBR 时，例如建立视图是运用了 UUID() 函数</li>
</ol>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;3.2.设定主从复制模式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">log</span>-bin=mysql-bin</div><div class="line"><span class="comment">#binlog_format="STATEMENT"</span></div><div class="line"><span class="comment">#binlog_format="ROW"</span></div><div class="line">binlog_format=<span class="string">"MIXED"</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;也可以在运行时动态修改binlog的格式。例如</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SET SESSION binlog_format = <span class="string">'STATEMENT'</span>;</div><div class="line">mysql&gt; SET SESSION binlog_format = <span class="string">'ROW'</span>;</div><div class="line">mysql&gt; SET SESSION binlog_format = <span class="string">'MIXED'</span>;</div><div class="line">mysql&gt; SET GLOBAL binlog_format = <span class="string">'STATEMENT'</span>;</div><div class="line">mysql&gt; SET GLOBAL binlog_format = <span class="string">'ROW'</span>;</div><div class="line">mysql&gt; SET GLOBAL binlog_format = <span class="string">'MIXED'</span>;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;3.3.两种模式各自的优缺点：</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;SBR 的优点：</p>
<ul>
<li>历史悠久，技能成熟</li>
<li>binlog文件较小</li>
<li>binlog中包含了所有数据库修改信息，可以据此来审核数据库的安全等情况</li>
<li>binlog可以用于实时的还原，而不仅仅用于复制</li>
<li>主从版本可以不一样，从服务器版本可以比主服务器版本高</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;SBR 的缺点：</p>
<ul>
<li>不是所有的UPDATE语句都能被复制，尤其是包含不确定操作的时候。</li>
<li>调用具有不确定因素的 UDF 时复制也可能出疑问</li>
<li>运用以下函数的语句也不能被复制：<ul>
<li>LOAD_FILE()</li>
<li>UUID()</li>
<li>USER()</li>
<li>FOUND_ROWS()</li>
<li>SYSDATE() (除非启动时启用了 –sysdate-is-now 选项)</li>
</ul>
</li>
<li>INSERT … SELECT 会产生比 RBR 更多的行级锁</li>
<li>复制须要执行 全表扫描(WHERE 语句中没有运用到索引)的 UPDATE 时，须要比 RBR 请求更多的行级锁</li>
<li>对于有 AUTO_INCREMENT 字段的 InnoDB表而言，INSERT 语句会阻塞其他 INSERT 语句</li>
<li>对于一些复杂的语句，在从服务器上的耗资源情况会更严重，而 RBR 模式下，只会对那个发生变化的记录产生影响</li>
<li>存储函数(不是存储流程 )在被调用的同时也会执行一次 NOW() 函数，这个可以说是坏事也可能是好事</li>
<li>确定了的 UDF 也须要在从服务器上执行</li>
<li>数据表必须几乎和主服务器保持一致才行，否则可能会导致复制出错</li>
<li>执行复杂语句如果出错的话，会消耗更多资源</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;RBR 的优点：</p>
<ul>
<li>任何情况都可以被复制，这对复制来说是最安全可靠的</li>
<li>和其他大多数数据库系统的复制技能一样</li>
<li>多数情况下，从服务器上的表如果有主键的话，复制就会快了很多</li>
<li>复制以下几种语句时的行锁更少：<ul>
<li>INSERT … SELECT</li>
<li>包含 AUTO_INCREMENT 字段的 INSERT</li>
<li>没有附带条件或者并没有修改很多记录的 UPDATE 或 DELETE 语句</li>
</ul>
</li>
<li>执行 INSERT，UPDATE，DELETE 语句时锁更少</li>
<li>从服务器上采用多线程来执行复制成为可能</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;RBR 的缺点：</p>
<ul>
<li>binlog 大了很多</li>
<li>复杂的回滚时 binlog 中会包含大量的数据</li>
<li>主服务器上执行 UPDATE 语句时，所有发生变化的记录都会写到 binlog 中，而 SBR 只会写一次，这会导致频繁发生 binlog 的并发写疑问</li>
<li>UDF 产生的大 BLOB 值会导致复制变慢</li>
<li>不能从 binlog 中看到都复制了写什么语句(加密过的)</li>
<li>当在非事务表上执行一段堆积的SQL语句时，最好采用 SBR 模式，否则很容易导致主从服务器的数据不一致情况发生</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;另外，针对系统库 mysql 里面的表发生变化时的处理准则如下：</p>
<ul>
<li>如果是采用 INSERT，UPDATE，DELETE 直接操作表的情况，则日志格式根据 binlog_format 的设定而记录</li>
<li>如果是采用 GRANT，REVOKE，SET PASSWORD 等管理语句来做的话，那么无论如何 都采用 SBR 模式记录。</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注：采用 RBR 模式后，能处理很多原先出现的主键重复问题。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;实例:对于insert into db_allot_ids select * from db_allot_ids 这个语句:</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在BINLOG_FORMAT=STATEMENT 模式下:</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;BINLOG日志信息为:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">BEGIN</div><div class="line">/*!*/;</div><div class="line"><span class="comment"># at 173</span></div><div class="line"><span class="comment">#090612 16:05:42 server id 1 end_log_pos 288 Query thread_id=4 exec_time=0 error_code=0</span></div><div class="line">SET TIMESTAMP=1244793942/*!*/;</div><div class="line">insert into db_allot_ids select * from db_allot_ids</div><div class="line">/*!*/;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在BINLOG_FORMAT=ROW 模式下:</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;BINLOG日志信息为:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">BINLOG <span class="string">'</span></div><div class="line"><span class="string">hA0yShMBAAAAMwAAAOAAAAAAAA8AAAAAAAAAA1NOUwAMZGJfYWxsb3RfaWRzAAIBAwAA</span></div><div class="line"><span class="string">hA0yShcBAAAANQAAABUBAAAQAA8AAAAAAAEAAv/8AQEAAAD8AQEAAAD8AQEAAAD8AQEAAAA=</span></div><div class="line"><span class="string">'</span>/*!*/;</div></pre></td></tr></table></figure>
<h3 id="4、Mysql主从的优缺点"><a href="#4、Mysql主从的优缺点" class="headerlink" title="4、Mysql主从的优缺点"></a>4、Mysql主从的优缺点</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;MySQL的主从同步是一个很成熟的架构，优点为：①在从服务器可以执行查询工作(即我们常说的读功能)，降低主服 务器压力;②在从主服务器进行备份，避免备份期间影响主服务器服务;③当主服务器出现问题时，可以切换到从服务器。所以我在项目部署和实施中经常会采用这种方案;鉴于生产环境下的mysql的严谨性。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;实际上，在老版本中，MySQL 的复制实现在 Slave 端并不是由 SQL 线程和 IO 线程这两个线程共同协作而完成的，而是由单独的一个线程来完成所有的工作。但是 MySQL 的工程师们很快发现，这样做存在很大的风险和性能问题，主要如下：</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;首先，如果通过一个单一的线程来独立实现这个工作的话，就使复制 Master 端的，Binary Log日志，以及解析这些日志，然后再在自身执行的这个过程成为一个串行的过程，性能自然会受到较大的限制，这种架构下的 Replication 的延迟自然就比较长了。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;其次，Slave 端的这个复制线程从 Master 端获取 Binary Log 过来之后，需要接着解析这些内容，还原成 Master 端所执行的原始 Query，然后在自身执行。在这个过程中，Master端很可能又已经产生了大量的变化并生成了大量的 Binary Log 信息。如果在这个阶段 Master 端的存储系统出现了无法修复的故障，那么在这个阶段所产生的所有变更都将永远的丢失，无法再找回来。这种潜在风险在Slave 端压力比较大的时候尤其突出，因为如果 Slave 压力比较大，解析日志以及应用这些日志所花费的时间自然就会更长一些，可能丢失的数据也就会更多。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;所以，在后期的改造中，新版本的 MySQL 为了尽量减小这个风险，并提高复制的性能，将 Slave 端的复制改为两个线程来完成，也就是前面所提到的 SQL 线程和 IO 线程。最早提出这个改进方案的是Yahoo!的一位工程师“Jeremy Zawodny”。通过这样的改造，这样既在很大程度上解决了性能问题，缩短了异步的延时时间，同时也减少了潜在的数据丢失量。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;当然，即使是换成了现在这样两个线程来协作处理之后，同样也还是存在 Slave 数据延时以及数据丢失的可能性的，毕竟这个复制是异步的。只要数据的更改不是在一个事务中，这些问题都是存在的。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;如果要完全避免这些问题，就只能用 MySQL 的 Cluster 来解决了。不过 MySQL的 Cluster 知道笔者写这部分内容的时候，仍然还是一个内存数据库的解决方案，也就是需要将所有数据包括索引全部都 Load 到内存中，这样就对内存的要求就非常大的大，对于一般的大众化应用来说可实施性并不是太大。MySQL 现在正在不断改进其 Cluster 的实现，其中非常大的一个改动就是允许数据不用全部 Load 到内存中，而仅仅只是索引全部 Load 到内存中，我想信在完成该项改造之后的 MySQL Cluster 将会更加受人欢迎，可实施性也会更大。</p>
<h3 id="5、Mysql的半同步模式（Semisynchronous-Replication）"><a href="#5、Mysql的半同步模式（Semisynchronous-Replication）" class="headerlink" title="5、Mysql的半同步模式（Semisynchronous Replication）"></a>5、Mysql的半同步模式（Semisynchronous Replication）</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;我们知道在5.5之前，MySQL的复制其实是异步操作，而不是同步，也就意味着允许主从之间的数据存在一定的延迟，mysql当初这样设计的目的可能也是基于可用性的考虑，为了保证master不受slave的影响，并且异步复制使得master处于一种性能最优的状态：写完binlog后即可提交而不需要等待slave的操作完成。这样存在一个隐患，当你使用slave作为备份时，如果master挂掉，那么会存在部分已提交的事务未能成功传输到slave的可能，这就意味着数据丢失！</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在MySQL5.5版本中，引入了半同步复制模式（Semi-synchronous Replication）能够成功（只是相对的）避免上述数据丢失的隐患。在这种模式下：master会等到binlog成功传送并写入至少一个slave的relay log之后才会提交，否则一直等待，直到timeout（默认10s）。当出现timeout的时候，master会自动切换半同步为异步，直到至少有一个slave成功收到并发送Acknowledge，master会再切换回半同步模式。结合这个新功能，我们可以做到，在允许损失一定的事务吞吐量的前提下来保证同步数据的绝对安全，因为当你设置timeout为一个足够大的值的情况下，任何提交的数据都会安全抵达slave。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;mysql5.5 版本支持半同步复制功能（Semisynchronous Replication），但还不是原生的支持，是通过plugin来支持的，并且默认是没有安装这个插件的。不论是二进制发布的，还是自己源代码编译的，都会默认生成这个插件，一个是针对master 的一个是针对slave的，在使用之前需要先安装这俩plugins。</p>
<h2 id="二、Mysql主从复制的过滤"><a href="#二、Mysql主从复制的过滤" class="headerlink" title="二、Mysql主从复制的过滤"></a>二、Mysql主从复制的过滤</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;复制的过滤主要有２种方式：</p>
<ol>
<li>在主服务器在把事件从进二制日志中过滤掉，相关的参数是:binlog_do_db和binlog_ignore_db。</li>
<li>在从服务器上把事件从中继日志中过滤掉，相关的参数是replicate_*。</li>
</ol>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;复制只能扩展读取，不能扩展写入，对数据进行分区可以进行扩展写入。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;复制的优化：</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在mysql复制环境中,有8个参数可以让我们控制,需要复制或需要忽略不进行复制的DB或table分别为:</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;下面二项需要在Master上设置：</p>
<ul>
<li>Binlog_Do_DB:设定哪些数据库需要记录Binlog</li>
<li>Binlog_Ignore_DB:设定哪里数据库不需要记录Binlog</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;优点是Master端的Binlog记录所带来的Io量减少，网络IO减少，还会让slave端的IO线程,SQL线程减少，从而大幅提高复制性能,</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;缺点是mysql判断是否需要复制某个事件不是根据产生该事件的查询所在的DB,而是根据执行查询时刻所在的默认数据库（也就是登录时指定的库名或运行”use database”中指定的DB）,只有当前默认DB和配置中所设定的DB完全吻合时IO线程才会将该事件读取给slave的IO线程.所以,如果在默认DB和设定须要复制的DB不一样的情况下改变了须要复制的DB中某个Table中的数据,该事件是不会被复制到Slave中去的,这样就会造成Slave端的数据和Master的数据不一致.同样,在默认的数据库下更改了不须要复制的数据库中的数据,则会被复制到slave端,当slave端并没有该数据库时,则会造成复制出错而停止。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;下面六项需要在slave上设置：</p>
<ul>
<li>Replicate_Do_DB:设定需要复制的数据库,多个DB用逗号分隔</li>
<li>Replicate_Ignore_DB:设定可以忽略的数据库.</li>
<li>Replicate_Do_Table:设定需要复制的Table</li>
<li>Replicate_Ignore_Table:设定可以忽略的Table</li>
<li>Replicate_Wild_Do_Table:功能同Replicate_Do_Table,但可以带通配符来进行设置。</li>
<li>Replicate_Wild_Ignore_Table:功能同Replicate_Do_Table,功能同Replicate_Ignore_Table,可以带通配符。</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;优点是在slave端设置复制过滤机制,可以保证不会出现因为默认的数据库问题而造成Slave和Master数据不一致或复制出错的问题.</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;缺点是性能方面比在Master端差一些.原因在于:不管是否须要复制,事件都会被IO线程读取到Slave端,这样不仅增加了网络IO量,也给Slave端的IO线程增加了Relay Log的写入量。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <strong>注：在实际的生产应用中发现，在mysql5.0以前的版本，mysql的这个过滤设置几乎是形同虚设，不起作用：不管你在主库或是从库上设置了忽略某个数据库或是表，他依然会进行同步，所以在做5.0以前版本的主从同步时，一定保持主从数据库的一致性，主上有的库或是表从上一定要有，否则在同步的过程会出错。</strong></p>
<h2 id="三、Mysql主从同步的配置"><a href="#三、Mysql主从同步的配置" class="headerlink" title="三、Mysql主从同步的配置"></a>三、Mysql主从同步的配置</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;主库IP：192.168.1.2</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;从库IP：192.168.1.3</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;添加一个用于主从同步的用户：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GRANT REPLICATION SLAVE ON *.* TO <span class="string">'repl'</span>@<span class="string">'%'</span> IDENTIFIED BY ‘1q2w3e4r’;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;如果监控mysql主从的话，请加上一个super权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GRANT SUPER, REPLICATION SLAVE ON *.* TO &apos;repl&apos;@&apos;%&apos; IDENTIFIED BY &apos;1q2w3e4r&apos;;</div></pre></td></tr></table></figure>
<h3 id="1、主库的配置"><a href="#1、主库的配置" class="headerlink" title="1、主库的配置"></a>1、主库的配置</h3><h4 id="1-1．mysql5-0以下版本的配置"><a href="#1-1．mysql5-0以下版本的配置" class="headerlink" title="1.1．mysql5.0以下版本的配置"></a>1.1．mysql5.0以下版本的配置</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改主库mysql配置配置文件，在[mysqld]段添加以下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">server-id = 1</div><div class="line"><span class="built_in">log</span>-bin=/home/mysql/logs/binlog/bin-log</div><div class="line">max_binlog_size = 500M</div><div class="line">binlog_cache_size = 128K</div><div class="line">binlog-do-db = adb</div><div class="line">binlog-ignore-db = mysql</div><div class="line"><span class="built_in">log</span>-slave-updates</div></pre></td></tr></table></figure>
<h4 id="1-2-mysql5-0以上版本的配置"><a href="#1-2-mysql5-0以上版本的配置" class="headerlink" title="1.2. mysql5.0以上版本的配置"></a>1.2. mysql5.0以上版本的配置</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改主库mysql配置配置文件，在[mysqld]段添加以下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">server-id = 1</div><div class="line"><span class="built_in">log</span>-bin=/home/mysql/logs/binlog/bin-log</div><div class="line">max_binlog_size = 500M</div><div class="line">binlog_cache_size = 128K</div><div class="line">binlog-do-db = adb</div><div class="line">binlog-ignore-db = mysql</div><div class="line"><span class="built_in">log</span>-slave-updates</div><div class="line">expire_logs_day=2</div><div class="line">binlog_format=<span class="string">"MIXED"</span></div></pre></td></tr></table></figure>
<h4 id="1-3-各个参数的含义和相关注意项："><a href="#1-3-各个参数的含义和相关注意项：" class="headerlink" title="1.3.各个参数的含义和相关注意项："></a>1.3.各个参数的含义和相关注意项：</h4><ul>
<li>server-id = 1 #服务器标志号，注意在配置文件中不能出现多个这样的标识，如果出现多个的话mysql以第一个为准，一组主从中此标识号不能重复。</li>
<li>log-bin=/home/mysql/logs/binlog/bin-log #开启bin-log，并指定文件目录和文件名前缀。</li>
<li>max_binlog_size = 500M #每个bin-log最大大小，当此大小等于500M时会自动生成一个新的日志文件。一条记录不会写在2个日志文件中，所以有时日志文件会超过此大小。</li>
<li>binlog_cache_size = 128K #日志缓存大小</li>
<li>binlog-do-db = adb #需要同步的数据库名字，如果是多个，就以此格式在写一行即可。</li>
<li>binlog-ignore-db = mysql  #不需要同步的数据库名字，如果是多个，就以此格式在写一行即可。</li>
<li>log-slave-updates  #当Slave从Master数据库读取日志时更新新写入日志中，如果只启动log-bin 而没有启动log-slave-updates则Slave只记录针对自己数据库操作的更新。</li>
<li>expire_logs_day=2 #设置bin-log日志文件保存的天数，此参数mysql5.0以下版本不支持。</li>
<li>binlog_format=”MIXED”   #设置bin-log日志文件格式为：MIXED，可以防止主键重复。</li>
</ul>
<h3 id="2、从库的配置"><a href="#2、从库的配置" class="headerlink" title="2、从库的配置"></a>2、从库的配置</h3><h4 id="2-1-mysql5-1-7以前版本"><a href="#2-1-mysql5-1-7以前版本" class="headerlink" title="2.1.mysql5.1.7以前版本"></a>2.1.mysql5.1.7以前版本</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改从库mysql配置配置文件，在[mysqld]段添加以下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">server-id=2</div><div class="line">master-host=192.168.1.2</div><div class="line">master-user=repl</div><div class="line">master-password=1q2w3e4r</div><div class="line">master-port=3306</div><div class="line">master-connect-retry=30</div><div class="line">slave-skip-errors=1062</div><div class="line">replicate-do-db = adb</div><div class="line">replicate-ignore-db = mysql</div><div class="line">slave-skip-errors=1007,1008,1053,1062,1213,1158,1159</div><div class="line">master-info-file = /home/mysql/logs/master.info</div><div class="line">relay-log = /home/mysql/logs/relay-bin</div><div class="line">relay-log-index = /home/mysql/logs/relay-bin.index</div><div class="line">relay-log-info-file = /home/mysql/logs/relay-log.info</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;如果修改了连接主库相关信息，重启之前一定要删除master.info文件，否则重启之后由于连接信息改变从库而不会自动连接主库，造成同步失败。此文件是保存连接主库信息的。</p>
<h4 id="2-2-mysql5-1-7以后版本"><a href="#2-2-mysql5-1-7以后版本" class="headerlink" title="2.2.mysql5.1.7以后版本"></a>2.2.mysql5.1.7以后版本</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Mysql5.1.7版本在丛库上面的配置很少，主要是采用了新的同步信息记录方式，他不在支持在配置文件中配置连接主库的相关信息，而是把连接等相关信息记录在master-info-file = /home/mysql/logs/master.info文件中，如果入库变了，直接在mysql命令行执行连接信息的改变即可生效，比较灵活了，而不用去重启mysql。修改从库mysql配置配置文件，在[mysqld]段添加以下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">slave-skip-errors=1007,1008,1053,1062,1213,1158,1159</div></pre></td></tr></table></figure>
<h4 id="2-3-各个参数的含义和相关注意项"><a href="#2-3-各个参数的含义和相关注意项" class="headerlink" title="2.3.各个参数的含义和相关注意项"></a>2.3.各个参数的含义和相关注意项</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这里只讲一下2个参数，其他全部是从库连接主库的信息和中间日志relay-log的设置。</p>
<ul>
<li>master-connect-retry=30 #这个选项控制重试间隔，默认为60秒。</li>
<li>slave-skip-errors=1007,1008,1053,1062,1213,1158,1159 #这个是在同步过程中忽略掉的错误，这些错误不会影响数据的完整性，有事经常出现的错误，一般设置忽略。其中1062为主键重复错误。</li>
</ul>
<h3 id="3、实现主从同步"><a href="#3、实现主从同步" class="headerlink" title="3、实现主从同步"></a>3、实现主从同步</h3><h4 id="3-1-实现数据库的统一"><a href="#3-1-实现数据库的统一" class="headerlink" title="3.1.实现数据库的统一"></a>3.1.实现数据库的统一</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;检查主从数据库的配置文件，查看是否已正确配置。首次实现 同步要备份主库上需要同步的数据库，然后完整的导入到从库中。注：mysql5.0之前的版本涉及到mysql本身复制过滤存在问题，需要把所有的数据库都备份导入到丛库，保持。</p>
<h4 id="3-2-查看并记录主库bin-log信息"><a href="#3-2-查看并记录主库bin-log信息" class="headerlink" title="3.2.查看并记录主库bin-log信息"></a>3.2.查看并记录主库bin-log信息</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;进入主库mysql中，执行：show master status;显示信息如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show master status;</div><div class="line">+-------------+----------+--------------+------------------+</div><div class="line">| File        | Position | Binlog_do_db | Binlog_ignore_db |</div><div class="line">+-------------+----------+--------------+------------------+</div><div class="line">| bin-log.003 | 4        | adb          | mysql            |</div><div class="line">+-------------+----------+--------------+------------------+</div><div class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;记录File 和Position信息；</p>
<h4 id="3-3-在从库上执行同步语句"><a href="#3-3-在从库上执行同步语句" class="headerlink" title="3.3.在从库上执行同步语句"></a>3.3.在从库上执行同步语句</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;进入mysql，执行以下语句：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">slave stop;</div><div class="line">change master to</div><div class="line">master_host=<span class="string">'192.168.1.2'</span>,</div><div class="line">master_user=<span class="string">'repl'</span>,</div><div class="line">master_password=<span class="string">'1q2w3e4r'</span>,</div><div class="line">master_port=3306,</div><div class="line">master_log_file=<span class="string">'bin-log.003'</span>,</div><div class="line">master_log_pos=4;</div><div class="line">slave start;</div></pre></td></tr></table></figure>
<h4 id="3-4-查看主从同步状态"><a href="#3-4-查看主从同步状态" class="headerlink" title="3.4.查看主从同步状态"></a>3.4.查看主从同步状态</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;进入mysql，执行show slave status\G;显示如下（mysql版本不同查询的结果不同，但是重要的指标还是一样的）：</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Mysql5.0之前的版本如下：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%BB%E4%BB%8E%E5%BF%83%E5%BE%97%E6%95%B4%E7%90%86/01.jpeg?raw=true" alt=""> </p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Mysql5.5之前的版本如下：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%BB%E4%BB%8E%E5%BF%83%E5%BE%97%E6%95%B4%E7%90%86/02.jpeg?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Mysql5.5的版本如下：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%BB%E4%BB%8E%E5%BF%83%E5%BE%97%E6%95%B4%E7%90%86/03.jpeg?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;重要的指标为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Slave_IO_Running: Yes</div><div class="line">Slave_SQL_Running: Yes</div><div class="line">Master_Log_File: bin-log.003</div><div class="line">Relay_Master_Log_File: bin-log.003</div><div class="line">Read_Master_Log_Pos: 4</div><div class="line">Exec_master_log_pos: 4</div><div class="line">Seconds_Behind_Master: 0（5.0之前版本没有这个选项）</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;以上选项是两两对应的，只要结果是一致的，就说明主从同步成功。</p>
<h4 id="3-5-同步中的常见的错误和处理"><a href="#3-5-同步中的常见的错误和处理" class="headerlink" title="3.5.同步中的常见的错误和处理"></a>3.5.同步中的常见的错误和处理</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;1、现象：在从库上面show slave status\G;出现下列情况，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Slave_IO_Running: Yes</div><div class="line">Slave_SQL_Running: No</div><div class="line">Seconds_Behind_Master: NULL</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;原因：</p>
<ul>
<li>程序可能在slave上进行了写操作；</li>
<li>也可能是slave机器重起后，事务回滚造成的；</li>
<li>有可能是在同步过程中遇到某种错误，这个会在查看从库中状态时看到错误提示，最少见的就是主键重复1062的错误。</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;解决方法：</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;进入master</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show master status;</div><div class="line">+----------------------+----------+--------------+------------------+</div><div class="line">| File                 | Position | Binlog_Do_DB | Binlog_Ignore_DB |</div><div class="line">+----------------------+----------+--------------+------------------+</div><div class="line">| mysql-bin.000040     | 324      |adb           | mysql            |</div><div class="line">+----------------------+----------+--------------+------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后到slave服务器上执行手动同步</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">slave stop;</div><div class="line">change master to</div><div class="line">master_host=<span class="string">'10.14.0.140'</span>,</div><div class="line">master_user=<span class="string">'repl'</span>,</div><div class="line">master_password=<span class="string">'1q2w3e4r'</span>,</div><div class="line">master_port=3306,</div><div class="line">master_log_file=<span class="string">'mysql-bin.000040'</span>,</div><div class="line">master_log_pos=324;</div><div class="line">slave start;</div><div class="line">show slave status\G;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;2、现象：从数据库无法同步，show slave status显示:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Slave_IO_Running: No</div><div class="line">Slave_SQL_Running: Yes</div><div class="line">Seconds_Behind_Master: NULL</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;解决：首先查看数据库的err日志，查看是什么错误提示，看从库连接主库的IP、用户、密码等相关信息是否有误，如果有误，重新执行同步；如果确认无误，重启主数据库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show master status;</div><div class="line">+------------------+----------+--------------+------------------+</div><div class="line">| File | Position | Binlog_Do_DB | Binlog_Ignore_DB |</div><div class="line">+------------------+----------+--------------+------------------+</div><div class="line">| mysql-bin.000001 | 98 | adb| mysql|</div><div class="line">+------------------+----------+--------------+------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;进入从库mysql，执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">slave stop;</div><div class="line">change master to Master_Log_File=<span class="string">'mysql-bin.000001'</span>,Master_Log_Pos=98;</div><div class="line">slave start;</div><div class="line">或是这样：</div><div class="line">stop slave;</div><div class="line"><span class="built_in">set</span> global sql_slave_skip_counter =1;</div><div class="line">start slave;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这个现象主要是master数据库存在问题，由于连接主库信息错误、主库数据库挂掉如果说常见错等原因引起的，我在实际的操作中先重启master后重启slave即可解决这问题，出现此问题，必须要要重启master数据库。</p>
<h2 id="四、mysql主主和主主集群"><a href="#四、mysql主主和主主集群" class="headerlink" title="四、mysql主主和主主集群"></a>四、mysql主主和主主集群</h2><h3 id="1、mysql主主的实现"><a href="#1、mysql主主的实现" class="headerlink" title="1、mysql主主的实现"></a>1、mysql主主的实现</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在实际的生产应用中，为了在主库出现崩溃或是主服务器出现严重故障时快速的恢复业务，会直接切换到从库上，当主库故障处理完成后让他直接作为丛库来运行，此时主主就是一个不错的选择。</p>
<h2 id="五、mysql主从的监控"><a href="#五、mysql主从的监控" class="headerlink" title="五、mysql主从的监控"></a>五、mysql主从的监控</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在mysql主从的应用中，只要进行了合理设置，基本上不会出现问题，但是对他的监控是必不可少的，以免由于真的出现问题又不知道而造成不必要的数据损失。</p>
<h3 id="1、mysql主从监控的主要思路"><a href="#1、mysql主从监控的主要思路" class="headerlink" title="1、mysql主从监控的主要思路"></a>1、mysql主从监控的主要思路</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Mysql主从的监控，其主要是监控从库上的一些重要参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Slave_IO_Running: Yes</div><div class="line">Slave_SQL_Running: Yes</div><div class="line">Master_Log_File: bin-log.003</div><div class="line">Relay_Master_Log_File: bin-log.003</div><div class="line">Read_Master_Log_Pos: 4</div><div class="line">Exec_master_log_pos: 4</div><div class="line">Seconds_Behind_Master: 0（5.0之前版本没有这个选项）</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;通过以上的参数可以反映出主库和从库状态是否正常，从库是否落后于主库等。值得一提的是在mysql5.0以前的版本，Slave_IO_Running这个状态指标不可靠，会在主库直接挂掉的情况下不会变成NO，Seconds_Behind_Master参数也不存在。监控以上参数即可监控mysql主从。</p>
<h3 id="2、mysql主从监控的实现"><a href="#2、mysql主从监控的实现" class="headerlink" title="2、mysql主从监控的实现"></a>2、mysql主从监控的实现</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;不管mysql是那个版本，其中的从库上的Exec_master_log_pos、Exec_master_log_pos；主库上的 Master上的Log_File， Position，这四个参数可以判断出当前主从的状态。以下是适用于mysql所有版本的主从监控shell脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#/bin/sh</span></div><div class="line">user=repl</div><div class="line">passwd=123415</div><div class="line">master_ip=<span class="string">"192.168.1.2"</span></div><div class="line"><span class="built_in">log</span>=<span class="string">"/data3/check_repl.log"</span></div><div class="line">value()</div><div class="line">&#123;</div><div class="line"> master=`/usr/<span class="built_in">local</span>/mysql/bin/mysql -u<span class="variable">$user</span> -p<span class="variable">$passwd</span> -h<span class="variable">$master_ip</span> -e <span class="string">"show master status\G;"</span>|egrep <span class="string">"File|Position"</span>`</div><div class="line"> <span class="comment">#mysql 4.0</span></div><div class="line"> slave=`/usr/<span class="built_in">local</span>/mysql/bin/mysql -u<span class="variable">$user</span> -p<span class="variable">$passwd</span> -h127.0.0.1 -e <span class="string">"show slave status\G;"</span>|egrep <span class="string">"Relay_Master_Log_File|Exec_master_log_pos"</span>`</div><div class="line"> <span class="comment">#mysql 5.0</span></div><div class="line"> <span class="comment">#slave=`mysql -u$user -p$passwd -e "show slave status\G;"|egrep "Relay_Master_Log_File|Exec_Master_Log_Pos"`</span></div><div class="line"> <span class="comment">#取主库上的bin-log号及写入的当前日志位置   </span></div><div class="line"> Master_Log=`<span class="built_in">echo</span> <span class="variable">$master</span> |awk <span class="string">'&#123;print $2&#125;'</span>|awk -F <span class="string">"."</span> <span class="string">'&#123;print $2&#125;'</span>`</div><div class="line"> Master_Log_Pos=`<span class="built_in">echo</span> <span class="variable">$master</span> |awk <span class="string">'&#123;print $4&#125;'</span>`</div><div class="line"> <span class="comment">#取从库上当前同步主库的位置</span></div><div class="line"> Relay_Master_Log_File=`<span class="built_in">echo</span> <span class="variable">$slave</span> |awk <span class="string">'&#123;print $2&#125;'</span>|awk -F <span class="string">"."</span> <span class="string">'&#123;print $2&#125;'</span>`</div><div class="line"> Exec_Master_Log_Pos=`<span class="built_in">echo</span> <span class="variable">$slave</span> |awk <span class="string">'&#123;print $4&#125;'</span>`</div><div class="line"> <span class="built_in">echo</span> <span class="string">"Master_Log:"</span><span class="variable">$Master_Log</span>&gt;&gt;<span class="variable">$log</span></div><div class="line"> <span class="built_in">echo</span> <span class="string">"Master_Log_Pos:"</span><span class="variable">$Master_Log_Pos</span>&gt;&gt;<span class="variable">$log</span></div><div class="line"> <span class="built_in">echo</span> <span class="string">"Relay_Master_Log_File:"</span><span class="variable">$Relay_Master_Log_File</span>&gt;&gt;<span class="variable">$log</span></div><div class="line"> <span class="built_in">echo</span> <span class="string">"Exec_Master_Log_Pos:"</span><span class="variable">$Exec_Master_Log_Pos</span>&gt;&gt;<span class="variable">$log</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">for</span>((i=1;i&lt;=10;i++));</div><div class="line"><span class="keyword">do</span></div><div class="line"> <span class="built_in">echo</span> <span class="string">"#################################"</span>&gt;&gt;<span class="variable">$log</span></div><div class="line"> value</div><div class="line"> time=`date +<span class="string">"%Y-%m-%d %H:%M:%S"</span>`</div><div class="line"> <span class="keyword">if</span> [ <span class="variable">$Master_Log</span> -eq <span class="variable">$Relay_Master_Log_File</span> ];<span class="keyword">then</span></div><div class="line">       A=`expr <span class="variable">$Master_Log_Pos</span> - <span class="variable">$Exec_Master_Log_Pos</span>`</div><div class="line">       <span class="keyword">if</span> [ <span class="variable">$A</span> -lt 0 ];<span class="keyword">then</span></div><div class="line">             A=`expr 0 - <span class="variable">$A</span>`</div><div class="line">       <span class="keyword">fi</span></div><div class="line">       <span class="built_in">echo</span> <span class="variable">$A</span>&gt;&gt;<span class="variable">$log</span></div><div class="line">       <span class="keyword">if</span> [ <span class="variable">$A</span> -lt 10000 ];<span class="keyword">then</span></div><div class="line">             <span class="built_in">echo</span> <span class="string">"<span class="variable">$time</span> Master-Slave is OK."</span>&gt;&gt;<span class="variable">$log</span></div><div class="line">             <span class="comment">#echo "$i"</span></div><div class="line">             <span class="built_in">break</span></div><div class="line">       <span class="keyword">else</span></div><div class="line">             <span class="keyword">if</span> [ <span class="variable">$i</span> ge 3 ];<span class="keyword">then</span>              </div><div class="line">                  <span class="built_in">echo</span> <span class="string">"<span class="variable">$time</span> Warning:Slave-Master lag <span class="variable">$A</span> "</span> &gt;&gt;<span class="variable">$log</span></div><div class="line">                  <span class="built_in">echo</span> <span class="string">"<span class="variable">$i</span>"</span></div><div class="line">             <span class="keyword">fi</span></div><div class="line">             sleep 30</div><div class="line">             <span class="built_in">continue</span></div><div class="line">       <span class="keyword">fi</span></div><div class="line"> <span class="keyword">else</span></div><div class="line">       sleep 60</div><div class="line">       <span class="keyword">fi</span></div><div class="line">       <span class="keyword">if</span> [ <span class="variable">$i</span> -eq 10 ];<span class="keyword">then</span></div><div class="line">             <span class="built_in">echo</span> <span class="string">"<span class="variable">$i</span>"</span></div><div class="line">             <span class="built_in">echo</span> <span class="string">"<span class="variable">$time</span> Error:Slave-Master must be check !"</span> &gt;&gt;<span class="variable">$log</span></div><div class="line">       <span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在mysql5.0以后的版本，mysql主从已经相当的成熟了，可以只监控Slave_IO_Running，Slave_SQL_Running，Seconds_Behind_Master状态就可以了，这里不再做说明。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-MySQL/25. Mysql分库分表方案" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/MySQL/25. Mysql分库分表方案/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.782Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/MySQL/25. Mysql分库分表方案/">
        Mysql分库分表方案
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="为什么要分表："><a href="#为什么要分表：" class="headerlink" title="为什么要分表："></a>为什么要分表：</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;当一张表的数据达到几千万时，你查询一次所花的时间会变多，如果有联合查询的话，我想有可能会死在那儿了。分表的目的就在于此，减小数据库的负担，缩短查询时间。        </p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;mysql中有一种机制是表锁定和行锁定，是为了保证数据的完整性。表锁定表示你们都不能对这张表进行操作，必须等我对表操作完才行。行锁定也一样，别的sql必须等我对这条数据操作完了，才能对这条数据进行操作。</p>
<h2 id="mysql-proxy：amoeba"><a href="#mysql-proxy：amoeba" class="headerlink" title="mysql proxy：amoeba"></a>mysql proxy：amoeba</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;做mysql集群,利用amoeba。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;从上层的java程序来讲，不需要知道主服务器和从服务器的来源，即主从数据库服务器对于上层来讲是透明的。可以通过amoeba来配置。</p>
<h2 id="大数据量并且访问频繁的表，将其分为若干个表"><a href="#大数据量并且访问频繁的表，将其分为若干个表" class="headerlink" title="大数据量并且访问频繁的表，将其分为若干个表"></a>大数据量并且访问频繁的表，将其分为若干个表</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;比如对于某网站平台的数据库表-公司表，数据量很大，这种能预估出来的大数据量表，我们就事先分出个N个表，这个N是多少，根据实际情况而定。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;某网站现在的数据量至多是5000万条，可以设计每张表容纳的数据量是500万条，也就是拆分成10张表，</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;那么如何判断某张表的数据是否容量已满呢？可以在程序段对于要新增数据的表，在插入前先做统计表记录数量的操作，当&lt;500万条数据，就直接插入，当已经到达阀值，可以在程序段新创建数据库表（或者已经事先创建好），再执行插入操作。</p>
<h2 id="利用merge存储引擎来实现分表"><a href="#利用merge存储引擎来实现分表" class="headerlink" title="利用merge存储引擎来实现分表"></a>利用merge存储引擎来实现分表</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;如果要把已有的大数据量表分开比较痛苦，最痛苦的事就是改代码，因为程序里面的sql语句已经写好了。用merge存储引擎来实现分表, 这种方法比较适合.<br>举例子：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Mysql%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E6%A1%88/01.jpeg?raw=true" alt=""></p>
<h2 id="数据库架构"><a href="#数据库架构" class="headerlink" title="数据库架构"></a>数据库架构</h2><h3 id="1、简单的MySQL主从复制"><a href="#1、简单的MySQL主从复制" class="headerlink" title="1、简单的MySQL主从复制:"></a>1、简单的MySQL主从复制:</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;MySQL的主从复制解决了数据库的读写分离，并很好的提升了读的性能，其图如下：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Mysql%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E6%A1%88/02.jpeg?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;其主从复制的过程如下图所示：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Mysql%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E6%A1%88/03.jpeg?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;但是，主从复制也带来其他一系列性能瓶颈问题：</p>
<ol>
<li>写入无法扩展</li>
<li>写入无法缓存</li>
<li>复制延时</li>
<li>锁表率上升</li>
<li>表变大，缓存率下降</li>
</ol>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;那问题产生总得解决的，这就产生下面的优化方案，一起来看看。</p>
<h3 id="2、MySQL垂直分区"><a href="#2、MySQL垂直分区" class="headerlink" title="2、MySQL垂直分区"></a>2、MySQL垂直分区</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;如果把业务切割得足够独立，那把不同业务的数据放到不同的数据库服务器将是一个不错的方案，而且万一其中一个业务崩溃了也不会影响其他业务的正常进行，并且也起到了负载分流的作用，大大提升了数据库的吞吐能力。经过垂直分区后的数据库架构图如下：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Mysql%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E6%A1%88/04.jpeg?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然而，尽管业务之间已经足够独立了，但是有些业务之间或多或少总会有点联系，如用户，基本上都会和每个业务相关联，况且这种分区方式，也不能解决单张表数据量暴涨的问题，因此为何不试试水平分割呢？</p>
<h3 id="3、MySQL水平分片（Sharding）"><a href="#3、MySQL水平分片（Sharding）" class="headerlink" title="3、MySQL水平分片（Sharding）"></a>3、MySQL水平分片（Sharding）</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这是一个非常好的思路，将用户按一定规则（按id哈希）分组，并把该组用户的数据存储到一个数据库分片中，即一个sharding，这样随着用户数量的增加，只要简单地配置一台服务器即可，原理图如下：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Mysql%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E6%A1%88/05.jpeg?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;如何来确定某个用户所在的shard呢，可以建一张用户和shard对应的数据表，每次请求先从这张表找用户的shard id，再从对应shard中查询相关数据，如下图所示：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Mysql%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E6%A1%88/06.jpeg?raw=true" alt=""></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-MySQL/23. mysql主从复制" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/MySQL/23. mysql主从复制/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.781Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/MySQL/23. mysql主从复制/">
        mysql 主从复制
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="mysql复制"><a href="#mysql复制" class="headerlink" title="mysql复制"></a>mysql复制</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;MySQL复制支持单向，异步复制。通过一台主服务器将更新写入二进制日志文件，并维护文件的一个索引以跟踪日志循环。这些日志可以记录发送到从服务器的更新。当一个从服务器连接主服务器时，它通知主服务器从服务器在日志中读取的最后一次成功更新的位置。从服务器接收从那时起发生的任何更新，然后封锁并等待主服务器通知新的更新。MySQL主从复制是异步进行的。同步需要版本为5.5,使用google提供的插件来实现。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;MySQL主从复制操作很灵活既可以实现整个服务的级别的复制，也可以实现对某个库，甚至某个数据库中的指定的某个对象进行复制。</p>
<h2 id="MySQL主从复制应用场景"><a href="#MySQL主从复制应用场景" class="headerlink" title="MySQL主从复制应用场景"></a>MySQL主从复制应用场景</h2><ol>
<li>提高性能。通过一(多)主多从的部署方案，将涉及数据写的操作放在Master端操作，而将数据读的操作分散到众多的Slave当中。降低了Master的负载，提高数据写入的响应效率；多台从服务器提供读，分担了请求，提高了读的效率。</li>
<li>数据安全。数据复制到Slave节点，即使Master宕机，Slave节点还保存着完整数据。</li>
<li>数据分析。将数据分析，放在slave上。</li>
</ol>
<h2 id="主从复制的原理"><a href="#主从复制的原理" class="headerlink" title="主从复制的原理"></a>主从复制的原理</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;MySQL的Replication是一个异步的复制过程，从一个MySQL实例(Master)复制到另一台MySQL实例上。在Master和Slave之间复制的整个过程主要由3个线程完成，其中两个线程（SQL线程和IO线程）在Slave端，另外一个线程(IO线程)在Master端。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;要实现主从复制，首先要在Master端打开Binary Log功能。因为整个复制过程实际上    就是Slave从Master上获取二进制日志，然后在自己身上完全按照产生的顺序一次执行日志中记录的各种操作的过程。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;复制的具体过程如下：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/mysql%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/01.jpeg?raw=true" alt=""></p>
<ol>
<li>Slave的IO线程连上Master，并请求日志文件指定位置(或从开始的日志)之后的日志的内容。</li>
<li>Master接收到来自Slave的IO线程请求后，负责复制IO线程根据请求的信息读取指定日志之后的日志信息，返回给Slave端的IO线程。返回信息中除了日志所包含的信息，还包含了包括本次返回的信息在Master端的Binary Log文件的名称和位置。</li>
<li>Slave的IO线程接受到信息后，将日志内容一次写入Slave端的Relay Log文件(mysql-relay-bin.xxxx)的末端，并将读取到的Master端的bin-log的文件和位置记录到master-info文件中，以便在下一次读取时能够清楚地告诉Master，下次从bin-log哪个位置开始往后的日志内容。</li>
<li>Slave的SQL线程检测检测到Relay Log中更新内容后，会马上解析该Log文件中的内容，还原成在Master端真实执行时的可执行的SQL语句，并执行这些SQK语句。实际上Master和Slave执行同样的语句。</li>
</ol>
<h2 id="Binary-Log-记录方式"><a href="#Binary-Log-记录方式" class="headerlink" title="Binary Log 记录方式"></a>Binary Log 记录方式</h2><h3 id="Row-Level"><a href="#Row-Level" class="headerlink" title="Row Level"></a>Row Level</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Binary Log会记录成每一行数据被修改的形式，然后在Slave端再对相同的数据进行修改。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>优点</strong>：在Row Level模式下，Binnary Log可以不记录执行的Query语句的上下文相关信息，只要记录哪一行修改了，修改成什么样子。Row Level会详细的记录下每一行数据的修改细节，而且不会出现某个特定情况下的存储过程，或Function，以及Trigger的调用和触发无法被正确复制问题。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>缺点</strong>：产生大量的日志内容。</p>
<h3 id="Statment-Level"><a href="#Statment-Level" class="headerlink" title="Statment Level"></a>Statment Level</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;每一条会修改的SQL语句都会记录到Master的Binnary中。Slave端在复制的时候，SQL线程会解析成和原来Master端执行过相同的SQL语句，并再次执行。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>优点</strong>：首先，解决了Row Level下的缺点，不须要记录每一行的数据变化，减少了Binnary Log日志量，节约了IO成本，提高了性能。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>缺点</strong>：由于它是记录的执行语句，为了让这些语句在Slave端也能正确执行。那么它还必须记录每条语句在执行时的一些相关信息，即上下文信息，以保证所有语句在Slave端被执行的时候能够得到和在Master端执行时相同的结果。另外，由于MySQL发展比较快，很多新功能不断加入，使得MySQL复制遇到了不小的挑战，复制时设计的内容岳父在，越容易出bug。在Statement Level下，目前已发现不少的情况下会造成MySQL的复制问题。主要是在修改数据使用了某些特定的函数货功能后，出现，比如：Sleep()函数在有些版本中就不能正确的复制，在存储过程中使用了last_insert_id()函数，可能会使Slave和Master的到不一致的ID，等等。</p>
<h3 id="Mixed-Level"><a href="#Mixed-Level" class="headerlink" title="Mixed Level"></a>Mixed Level</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在Mixed模式下，MySQL会根据执行的每一条具体的SQL语句来区分对待记录的日志形式，也就是在Statement和Row之间选择一种。除了MySQL认为通过Statement方式可能造成复制过程中Master和Slave之间产生不一致数据。(如特殊Procedure和Funtion的使用，UUID()函数的使用等特殊情况)时，它会选择ROW的模式来记录变更之外，都会使用Statement方式。</p>
<h2 id="设置主从"><a href="#设置主从" class="headerlink" title="设置主从"></a>设置主从</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;主从设置的主要步骤是</p>
<ol>
<li>修改Master和Slave的my.cnf中的server-id，使之唯一,开启binlog。</li>
<li>若不停Master时，加入全局锁，记录bin-log文件和bin-log文件的位置，全备要同步的数据库；解除全局锁</li>
<li>若可以停库时，停止主库，物理备份所需要同步的数据库。</li>
<li>在Slave端恢复备份的数据。</li>
<li>用change master在Slave建立与master的联系。</li>
<li>启动Slave。</li>
<li>检查Slave的状态。</li>
</ol>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><ol>
<li>不停主库的建立主从复制。</li>
</ol>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>第一部分 对主库的操作</strong></p>
<ol>
<li>修改主库的文件，开启MySQL的bin-log。（一般安装的时候最好先做好，这样可以不停库。）<br>修改主库的配置文件my.cnf：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">vim /etc/my.cnf</div><div class="line"></div><div class="line">server-id = 1 <span class="comment"># 设置server-id 确保id为唯一，最好用ip地址，后三位</span></div><div class="line">bin-log=mysql-bin <span class="comment"># 设置 bin-log，这地方可以指定为bin-log的目录？</span></div><div class="line"></div><div class="line">/etc/init.d/mysqld restart</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改完成后，重启mysql</p>
<ol>
<li>登录主库，添加从库的同步账号。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql –uroot –p</div><div class="line">grant replication slave on *.* to <span class="string">'rep'</span>@<span class="string">'%'</span> identified by <span class="string">'passwd'</span>;</div></pre></td></tr></table></figure>
<ol>
<li>对主库进行锁表操作，禁止更新，（为了防止备份时的数据不一致问题）。并查看bin-log的名字和日志的（position）。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">flush tables with <span class="built_in">read</span> lock；</div><div class="line">show master status；</div><div class="line"></div><div class="line">mysql&gt; show master status;</div><div class="line">+------------------+----------+--------------+------------------+</div><div class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |</div><div class="line">+------------------+----------+--------------+------------------+</div><div class="line">| mysql-bin.000107 | 38874616 |              |                  |</div><div class="line">+------------------+----------+--------------+------------------+</div><div class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;记录这两个值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql-bin.000107</div><div class="line">38874616</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;取得<code>bin-log</code> 和 <code>position</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql -uroot -p<span class="string">'yz11235'</span> -e <span class="string">"show master status"</span> | awk <span class="string">'&#123;if (NR == 2)&#123; print $1 "\n" $2;&#125;&#125;'</span> &gt; temp.txt</div></pre></td></tr></table></figure>
<ol>
<li>对主库进行全备份。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysqldump -h hostname -uroot -p’’ -A -B -F | gzip &gt;alldb.sql.gz</div></pre></td></tr></table></figure>
<ol>
<li>导出数据库后，进行对数据库表解锁。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">unlock tables</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>第二部分 从库上操作</strong></p>
<ol>
<li>在从库上设置my.cnf，设置server-id，和注释bin-log。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">server-id = 2</div><div class="line"><span class="comment"># bin-log = mysql-bin</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;重启 mysql。</p>
<ol>
<li>登录从库，并设置从库信息</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">CHANGE MASTER TO </div><div class="line">MASTER_HOST=<span class="string">'10.143.39.174'</span>,</div><div class="line">MASTER_PORT=3306,</div><div class="line">MASTER_USER=<span class="string">'rep'</span>,</div><div class="line">MASTER_PASSWORD=<span class="string">'passwd'</span>,</div><div class="line">MASTER_LOG_FILE=<span class="string">'mysql-bin.000003'</span>,</div><div class="line">MASTER_LOG_POS=151348020,</div><div class="line">MASTER_CONNECT_RETRY=10;</div></pre></td></tr></table></figure>
<ol>
<li>启动 从库</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">start slave;</div></pre></td></tr></table></figure>
<ol>
<li>查看从库状态，</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">show slave status\G;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;观察：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">slave_IO_Running : Yes</div><div class="line">Slave_SQL_Running : Yes</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;以上两个为Yes 说明主从已经成功。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Second_behind_master = 0</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这是从库落后主库的秒数。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/18/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="page-number" href="/page/18/">18</a><span class="page-number current">19</span><a class="page-number" href="/page/20/">20</a><a class="page-number" href="/page/21/">21</a><span class="space">&hellip;</span><a class="page-number" href="/page/63/">63</a><a class="extend next" rel="next" href="/page/20/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2017 失落的乐章
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/smackgg/hexo-theme-smackdown" target="_blank">Smackdown</a>
        </div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="/js/main.js"></script>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js"></script>


  </div>
</body>
</html>