<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>失落的乐章</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="失落的乐章的Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="失落的乐章">
<meta property="og:url" content="https://hcldirgit.github.io/page/41/index.html">
<meta property="og:site_name" content="失落的乐章">
<meta property="og:description" content="失落的乐章的Blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="失落的乐章">
<meta name="twitter:description" content="失落的乐章的Blog">
  
    <link rel="alternative" href="/atom.xml" title="失落的乐章" type="application/atom+xml">
  
  
    <link rel="icon" href="https://hcldirgit.github.io/images/0.png">
  
  <link rel="stylesheet" href="/css/style.css">
  
  
<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-85415703-1', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  <script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>
  <script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>

  
</head>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://hcldirgit.github.io/images/0.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">失落的乐章</a></h1>
		</hgroup>

		
		<p class="header-subtitle">技术面前，永远都是学生。</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Ansible/" style="font-size: 10.42px;">Ansible</a> <a href="/tags/Apache/" style="font-size: 18.33px;">Apache</a> <a href="/tags/Cacti/" style="font-size: 11.67px;">Cacti</a> <a href="/tags/DNS/" style="font-size: 13.33px;">DNS</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/FTP/" style="font-size: 11.25px;">FTP</a> <a href="/tags/Git/" style="font-size: 10.83px;">Git</a> <a href="/tags/HA集群/" style="font-size: 11.67px;">HA集群</a> <a href="/tags/Hadoop/" style="font-size: 12.5px;">Hadoop</a> <a href="/tags/Jenkins/" style="font-size: 10.42px;">Jenkins</a> <a href="/tags/LAMP/" style="font-size: 19.58px;">LAMP</a> <a href="/tags/LNMP/" style="font-size: 17.08px;">LNMP</a> <a href="/tags/LVS/" style="font-size: 16.67px;">LVS</a> <a href="/tags/Linux/" style="font-size: 19.17px;">Linux</a> <a href="/tags/Linux命令/" style="font-size: 20px;">Linux命令</a> <a href="/tags/Linux安全/" style="font-size: 14.17px;">Linux安全</a> <a href="/tags/Memcached/" style="font-size: 11.25px;">Memcached</a> <a href="/tags/MongoDB/" style="font-size: 15.42px;">MongoDB</a> <a href="/tags/MySQL/" style="font-size: 17.5px;">MySQL</a> <a href="/tags/NFS/" style="font-size: 10px;">NFS</a> <a href="/tags/Nagios/" style="font-size: 11.67px;">Nagios</a> <a href="/tags/Nginx/" style="font-size: 17.92px;">Nginx</a> <a href="/tags/OpenStack/" style="font-size: 11.25px;">OpenStack</a> <a href="/tags/Php/" style="font-size: 14.58px;">Php</a> <a href="/tags/Puppet/" style="font-size: 11.25px;">Puppet</a> <a href="/tags/Python/" style="font-size: 14.58px;">Python</a> <a href="/tags/Redis/" style="font-size: 16.25px;">Redis</a> <a href="/tags/Resin/" style="font-size: 10px;">Resin</a> <a href="/tags/Saltstack/" style="font-size: 10px;">Saltstack</a> <a href="/tags/Samba/" style="font-size: 12.08px;">Samba</a> <a href="/tags/Squid/" style="font-size: 14.58px;">Squid</a> <a href="/tags/Tomcat/" style="font-size: 13.75px;">Tomcat</a> <a href="/tags/Zabbix/" style="font-size: 15.83px;">Zabbix</a> <a href="/tags/haproxy/" style="font-size: 12.5px;">haproxy</a> <a href="/tags/keepalived/" style="font-size: 12.92px;">keepalived</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/shell练习/" style="font-size: 18.75px;">shell练习</a> <a href="/tags/正则表达式/" style="font-size: 12.92px;">正则表达式</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">失落的乐章</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="https://hcldirgit.github.io/images/0.png" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">失落的乐章</h1>
			</hgroup>
			
			<p class="header-subtitle">技术面前，永远都是学生。</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-Dns、Iredmaill/2. DNS介绍" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Dns、Iredmaill/2. DNS介绍/" class="article-date">
  	<time datetime="2017-09-02T18:00:30.881Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Dns、Iredmaill/2. DNS介绍/">
        DNS介绍
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;DNS 为 Domain Name System （域名系统）的缩写，它是一种将 ip 地址转换成对应的主机名或将主机名转换成与之相对应 ip 的一种服务机制。其中通过域名解析出 ip 地址的叫做正向解析，通过 ip 地址解析出域名的叫做反向解析。 DNS 使用 TCP 和 UDP ，端口号都是53，但它主要使用 UDP ，服务器之间备份使用 TCP 。全世界只有 13 台 “根”服务器，1 个根服务器放在美国，其他 12 台为辅根服务器，DNS 服务器根据角色可以分为：主 DNS 、从 DNS 、缓存 DNS 服务器，DNS 转发服务器。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;首先来看看域名的结构组成，平时访问网站的时候，都会用一个域名去请求，比如 www.baidu.com ，其实在 com 后面还有一个点，这个点叫做根域。下图是一个域名的树状结构，根域下面会有 .com  .cn  .net 等顶级域，在顶级域下面又有了第二层域，比如 www.baidu.com 或者 .com.cn ，而 www.baidu.com则为子域，我们经常用子域来作为网站的域名。</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/dns%20%E4%BB%8B%E7%BB%8D/01.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;有了网站域名，下面来看看，域名是如何解析到 ip 的，下图为域名解析过程流程图</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/dns%20%E4%BB%8B%E7%BB%8D/02.png?raw=true" alt=""></p>
<ol>
<li><p>在浏览器中输入 www.sina.com.cn 域名，操作系统会先检查子机本地的 hosts 文件是否有这个网站映射关系，如果有，就先调用这个 IP 地址映射，完成域名解析。</p>
</li>
<li><p>如果 hosts 里没有这个域名的映射，则查找本地 DNS 解析器缓存，是否有这个网址映射关系，如果有，直接返回，完成域名解析。</p>
</li>
<li><p>如果 hosts 与本地 DNS 解析器缓存都没有相应的网址映射关系，首先会找本机设置的首选 DNS 服务器，在此我们叫它本地 DNS 服务器，此服务器收到查询时，如果要查询的域名，包含在本地配置区域资源中，则返回解析结果给客户机，完成域名解析，此解析具有权威性。</p>
</li>
<li><p>如果要查询的域名，不由本地 DNS 服务器区域解析，但该服务器已缓存了此网址映射关系，则调用这个 IP 地址映射，完成域名解析，此解析不具有权威性。</p>
</li>
<li><p>如果本地 DNS 服务器本地区域文件与缓存解析都失效，则分局本地 DNS 服务器的设置（是否设置转发器）进行查询，如果未用转发模式，本地 DNS 就把请求发至 13 台根 DNS ，根 DNS 服务器收到请求后会判断这个域名是谁来授权管理 ，并会返回一个负责该顶级域名服务器的一个 IP 。本地 DNS 服务器收到 IP 信息后，将会联系负责 域的这台服务器。这台负责 域的服务器收到请求后，如果自己无法解析，它就会找一个管理 管理域的下一级 DNS 服务器地址给本地 DNS 服务器。当本地 DNS 服务器收到这个地址后，就会找这个域服务器，重复上面的动作，进行查询，直至找到 www.sina.com.cn 主机。</p>
</li>
<li><p>如果用的是转发模式，此 DNS 服务器就会把请求转发至上一级服务器进行解析，上一级服务器如果不能解析，或找根 DNS 或把转请求转至上上级，以此循环。不管是本地 DNS 服务器用是是转发，还是根提示，最后都是把结果返回给本地 DNS 服务器，由此 DNS 服务器再返回给客户机。</p>
</li>
</ol>
<p><img src="https://github.com/hcldirgit/image/blob/master/dns%20%E4%BB%8B%E7%BB%8D/03.png?raw=true" alt=""></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DNS/">DNS</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Dns、Iredmaill/11. DNS服务器(五)：使用queryperf对DNS服务器作压力测试" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Dns、Iredmaill/11. DNS服务器(五)：使用queryperf对DNS服务器作压力测试/" class="article-date">
  	<time datetime="2017-09-02T18:00:30.880Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Dns、Iredmaill/11. DNS服务器(五)：使用queryperf对DNS服务器作压力测试/">
        DNS服务器(五)：使用queryperf对DNS服务器作压力测试
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、querperf简介"><a href="#一、querperf简介" class="headerlink" title="一、querperf简介"></a>一、querperf简介</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;当我们把DNS服务器配置好后，我们肯定会想测试一下DNS服务器的性能如何，上线后如果请求数够多服务器还能否响应？于是，我们可以使用软件模拟环境，对DNS服务器作评估性的测试。在bind中，有一款自带的压力测试软件，queryperf。使用这款软件可以对DNS服务器作请求测试，并且使用方法简单，我们可以使用queryperf测试多次，取一个平均值，这样就算结果不准确，也不会和实际情况相差太大。</p>
<h2 id="二、queryperf安装"><a href="#二、queryperf安装" class="headerlink" title="二、queryperf安装"></a>二、queryperf安装</h2><ol>
<li>queryperf是bind自带的测试软件，所以我们直接上官网下载bind，解压后就能找到queryperf的安装包。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wget http://www.isc.org/downloads/file/<span class="built_in">bind</span>-9-8-7rc2/?version=tar.gz</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8(%E4%BA%94" alt="">%EF%BC%9A%E4%BD%BF%E7%94%A8queryperf%E5%AF%B9DNS%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BD%9C%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/01.jpeg?raw=true)</p>
<ol>
<li>不知道为什么，这个文件下载完成后的名字是这个，index.html\?version\=tar.gz，好吧我们解压吧。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tar xf index.html\?version\=tar.gz</div></pre></td></tr></table></figure>
<ol>
<li>解压后，找到目录 contrib ，bind自带的第三方软件全在这个目录里面，我们要用到的queryperf也在里面。</li>
</ol>
<p><img src="https://github.com/hcldirgit/image/blob/master/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8(%E4%BA%94" alt="">%EF%BC%9A%E4%BD%BF%E7%94%A8queryperf%E5%AF%B9DNS%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BD%9C%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/02.jpeg?raw=true)</p>
<ol>
<li>进入queryperf目录，开始编译安装。可以使用 ./configure -h 查看安装帮助，不过我们默认安装就行了。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./configure</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8(%E4%BA%94" alt="">%EF%BC%9A%E4%BD%BF%E7%94%A8queryperf%E5%AF%B9DNS%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BD%9C%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/03.jpeg?raw=true)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">make</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8(%E4%BA%94" alt="">%EF%BC%9A%E4%BD%BF%E7%94%A8queryperf%E5%AF%B9DNS%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BD%9C%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/04.jpeg?raw=true)</p>
<ol>
<li>通过上面的编译后，展开queryperf目录，在该目录下已经生成了一个queryperf的可执行文件。这个文件就是我们要用到的程序，我们把该程序移动到/usr/bin/目录下就可以使用了。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cp queryperf /usr/bin/</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8(%E4%BA%94" alt="">%EF%BC%9A%E4%BD%BF%E7%94%A8queryperf%E5%AF%B9DNS%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BD%9C%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/05.jpeg?raw=true)</p>
<h2 id="三、使用queryperf测试DNS服务器"><a href="#三、使用queryperf测试DNS服务器" class="headerlink" title="三、使用queryperf测试DNS服务器"></a>三、使用queryperf测试DNS服务器</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在测试之前，我们先把DNS服务器架设好。我们以域名wubinary.com为例，架设DNS服务器,dns.wubinary.com。</p>
<ol>
<li>wubinary.com区域的资源记录文件wubinary.com.zone内容如下。</li>
</ol>
<p><img src="https://github.com/hcldirgit/image/blob/master/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8(%E4%BA%94" alt="">%EF%BC%9A%E4%BD%BF%E7%94%A8queryperf%E5%AF%B9DNS%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BD%9C%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/06.jpeg?raw=true)</p>
<ol>
<li>测试DNS服务器能否正常使用。</li>
</ol>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;重新启动服务：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8(%E4%BA%94" alt="">%EF%BC%9A%E4%BD%BF%E7%94%A8queryperf%E5%AF%B9DNS%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BD%9C%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/07.jpeg?raw=true)</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;测试域名blog.wubinary.com</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8(%E4%BA%94" alt="">%EF%BC%9A%E4%BD%BF%E7%94%A8queryperf%E5%AF%B9DNS%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BD%9C%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/08.jpeg?raw=true)</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;DNS服务器工作正常，接下来可以使用queryperf作压力测试了。</p>
<ol>
<li>queryperf使用格式：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">queryperf [-d datafile] [-s server_addr] [-p port] [-q num_queries]</div></pre></td></tr></table></figure>
<ul>
<li>-d: 后面接上一个文件，文件的内容是用户对DNS的请求，一行为一条请求，所以为了测试，我们可以在里面写上几千几万条。</li>
<li>-s: DNS服务器地址</li>
<li>-p: DNS服务器端口</li>
<li>-q: 请求多少次</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;使用vim命令先创建一个请求文件：vim querytest.txt</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8(%E4%BA%94" alt="">%EF%BC%9A%E4%BD%BF%E7%94%A8queryperf%E5%AF%B9DNS%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BD%9C%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/09.jpeg?raw=true)</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这几条记录还远远不够，我们使用vim命令 1,$y 复制一下。</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8(%E4%BA%94" alt="">%EF%BC%9A%E4%BD%BF%E7%94%A8queryperf%E5%AF%B9DNS%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BD%9C%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/10.jpeg?raw=true)</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;六百多万条了，开始测试吧。</p>
<ol>
<li>性能测试。</li>
</ol>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;执行命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">queryperf -d querytest.txt -s 192.168.0.6</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;此时使用top命令可以看到CPU和内存的使用率。</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8(%E4%BA%94" alt="">%EF%BC%9A%E4%BD%BF%E7%94%A8queryperf%E5%AF%B9DNS%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BD%9C%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/11.jpeg?raw=true)</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;结果如下：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8(%E4%BA%94" alt="">%EF%BC%9A%E4%BD%BF%E7%94%A8queryperf%E5%AF%B9DNS%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BD%9C%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/12.jpeg?raw=true)</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;测试过程完成，可以多测试几次取平均值。</p>
<h2 id="四、性能测试总结"><a href="#四、性能测试总结" class="headerlink" title="四、性能测试总结"></a>四、性能测试总结</h2><ol>
<li>在作服务器的性能测试时，最好不要在服务器平台自身使用测试软件测试，最好换另外一台机器，这样CPU处理的结果会更准确。</li>
<li>测试时先预估平台会遇到的最大请求数，用这个请求数作测试，量力而为，因为如果服务器遇到大流量的DDOS，单一机器性能再好，也扛不住。</li>
<li>使用queryperf作性能测试时，最好测试多次，取平均值。</li>
<li>可以修改配置文件的部分参数测试，如，开启递归，开启查询日志等功能作测试。</li>
<li>其它开源测试工具，tcpcopy</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DNS/">DNS</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Dns、Iredmaill/10. DNS服务器(四)：DNS视图及bind中rndc的使用" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Dns、Iredmaill/10. DNS服务器(四)：DNS视图及bind中rndc的使用/" class="article-date">
  	<time datetime="2017-09-02T18:00:30.879Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Dns、Iredmaill/10. DNS服务器(四)：DNS视图及bind中rndc的使用/">
        DNS服务器(四)：DNS视图及bind中rndc的使用
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、DNS服务器视图功能的实现"><a href="#一、DNS服务器视图功能的实现" class="headerlink" title="一、DNS服务器视图功能的实现"></a>一、DNS服务器视图功能的实现</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;DNS服务器有一个高级的功能，能够实现不同的用户访问同一个域名，把域名解析成不同的IP地址，使用户能够访问离他最近的服务器上的数据，这就是DNS服务器的视图功能。使用DNS服务器的视图功能可以增加网站的响应速度。例如，当我们网站的数据同步在两台web服务器上时，一台是电信服务器，一台是网通服务器，那么我们肯定希望全国访问我们网站的用户在打开网站的时候，能够自动实现，电信用户访问电信服务器，网通用户访问网通服务器。配置这种情况的前提是，web服务器必须要有一个电信的IP地址和一个网通的IP地址。DNS服务器的这种解析功能通常也被称之为智能解析。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;DNS服务器的视图通常在配置文件中是使用view实现的。把要使用某些IP地址作单独访问的zone区域，统一放在一个命名的view段落中，并且在view中定义请求的IP地址或IP地址段，把IP地址写入match-clients选项中。如果像上面说的，区分电信和网通路线的话，那么可以使用两个acl访问控制列表写上电信或网通IP地址，定义电信网通路线，把acl名字写入view段落match-clients选项中。如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">acl telecomip&#123; tele_IP; ... &#125;;</div><div class="line">acl netcomip&#123; net_IP; ... &#125;;</div><div class="line">view telecom &#123;</div><div class="line"> match-clients &#123; telecomip; &#125;;</div><div class="line"> zone <span class="string">"ZONE_NAME"</span> IN &#123;</div><div class="line"> <span class="built_in">type</span> master;</div><div class="line"> file <span class="string">"ZONE_NAME.telecom"</span>;</div><div class="line"> &#125;;</div><div class="line">&#125;;</div><div class="line">view netcom &#123;</div><div class="line"> match-clients &#123; netcomip; &#125;;</div><div class="line"> zone <span class="string">"ZONE_NAME"</span> IN &#123;</div><div class="line"> <span class="built_in">type</span> master;</div><div class="line"> file <span class="string">"ZONE_NAME.netcom"</span>;</div><div class="line"> &#125;;</div><div class="line">&#125;;</div><div class="line">view default &#123;</div><div class="line"> match-clients &#123; any; &#125;;</div><div class="line"> zone <span class="string">"ZONE_NAME"</span> IN &#123;</div><div class="line"> <span class="built_in">type</span> master;</div><div class="line"> file <span class="string">"ZONE_NAME.netcom"</span>;</div><div class="line"> &#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;需要注意的是：</p>
<ul>
<li>如果使用了视图的功能，那么配置文件中的所有zone区域都要必须写在视图里面，如，配置文件里默认要配置的三个区域，根、127.0.0.1、1.0.0.127.in-addr.arpa都要写入视图。</li>
<li>在acl中定义IP地址，IP地址的写法可以是单个IP地址也可以是一个IP地址段加掩码，如：192.168.0.0/24。</li>
<li>视图是根据配置文件从上往下匹配的，所以希望优先访问的资源记录文件，区域应该尽量写前面。</li>
<li>如果定义的若干个视图的IP地址不全的话，那么可以在最后定义一个默认视图，match-clients选项中的IP地址写上any，代表如果此次访问的IP地址上面没有一个能匹配到，则在此处归类。</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;实例：虚拟两台IP地址不同的主机，实现DNS服务器视图功能。</p>
<ol>
<li>本地电脑只有一个IP地址段，故使用两个IP地址分别代表两个不同的路线。首先，我们配置一个区域wubinary.com的DNS服务器，ip地址为,192.168.0.6。打开/etc/named.rfc1912.zones文件，编辑如下：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">acl net &#123; 192.168.0.6; &#125;;</div><div class="line">acl <span class="built_in">local</span> &#123; 192.168.0.12; &#125;;</div><div class="line">view netcom &#123;</div><div class="line">match-clients &#123; net; &#125;;</div><div class="line">zone <span class="string">"."</span> IN &#123;</div><div class="line"><span class="built_in">type</span> hint;</div><div class="line">file <span class="string">"named.ca"</span>;</div><div class="line">&#125;;</div><div class="line">zone <span class="string">"localhost.localdomain"</span> IN &#123;</div><div class="line"><span class="built_in">type</span> master;</div><div class="line">file <span class="string">"named.localhost"</span>;</div><div class="line">allow-update &#123; none; &#125;;</div><div class="line">&#125;;</div><div class="line">zone <span class="string">"localhost"</span> IN &#123;</div><div class="line"><span class="built_in">type</span> master;</div><div class="line">file <span class="string">"named.localhost"</span>;</div><div class="line">allow-update &#123; none; &#125;;</div><div class="line">&#125;;</div><div class="line">zone <span class="string">"1.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.ip6.arpa"</span> IN &#123;</div><div class="line"><span class="built_in">type</span> master;</div><div class="line">file <span class="string">"named.loopback"</span>;</div><div class="line">allow-update &#123; none; &#125;;</div><div class="line">&#125;;</div><div class="line">zone <span class="string">"1.0.0.127.in-addr.arpa"</span> IN &#123;</div><div class="line"><span class="built_in">type</span> master;</div><div class="line">file <span class="string">"named.loopback"</span>;</div><div class="line">allow-update &#123; none; &#125;;</div><div class="line">&#125;;</div><div class="line">zone <span class="string">"0.in-addr.arpa"</span> IN &#123;</div><div class="line"><span class="built_in">type</span> master;</div><div class="line">file <span class="string">"named.empty"</span>;</div><div class="line">allow-update &#123; none; &#125;;</div><div class="line">&#125;;</div><div class="line">zone <span class="string">"wubinary.com"</span> IN &#123;</div><div class="line"><span class="built_in">type</span> master;</div><div class="line">file <span class="string">"wubinary.com.net"</span>;</div><div class="line">&#125;;</div><div class="line">&#125;;</div><div class="line">view localcom &#123;</div><div class="line">match-clients &#123; <span class="built_in">local</span>; &#125;;</div><div class="line">zone <span class="string">"wubinary.com"</span> IN &#123;</div><div class="line"><span class="built_in">type</span> master;</div><div class="line">file <span class="string">"wubinary.com.local"</span>;</div><div class="line">&#125;;</div><div class="line">&#125;;</div><div class="line">view default &#123;</div><div class="line">match-clients &#123; any; &#125;;</div><div class="line">zone <span class="string">"wubinary.com"</span> IN &#123;</div><div class="line"><span class="built_in">type</span> master;</div><div class="line">file <span class="string">"wubinary.com.local"</span>;</div><div class="line">&#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明：我们分别定义两个acl，用于代表两个不同路线，IP地址为192.168.0.6的机器访问的资源记录文件是 wubinary.com.net文件，IP地址为192.168.0.12和其它的机器则访问wubinary.com.local这个文件的资源记录文件。</p>
<ol>
<li>分别编辑这两个文件</li>
</ol>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑文件/var/named/wubinary.com.net</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8(%E5%9B%9B" alt="">%EF%BC%9ADNS%E8%A7%86%E5%9B%BE%E5%8F%8Abind%E4%B8%ADrndc%E7%9A%84%E4%BD%BF%E7%94%A8/01.jpeg?raw=true)</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑文件/var/named/wubinary.com.local</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8(%E5%9B%9B" alt="">%EF%BC%9ADNS%E8%A7%86%E5%9B%BE%E5%8F%8Abind%E4%B8%ADrndc%E7%9A%84%E4%BD%BF%E7%94%A8/02.jpeg?raw=true)</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这里IP地址分别改了，192.168.0.6的机器请求时对应解析的IP是192.168开头的，192.168.0.12请求时对应解析的IP是172.16开头的。配置完成后，记得修改文件所属组及文件权限。</p>
<ol>
<li>测试一下配置文件语法。</li>
</ol>
<p><img src="https://github.com/hcldirgit/image/blob/master/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8(%E5%9B%9B" alt="">%EF%BC%9ADNS%E8%A7%86%E5%9B%BE%E5%8F%8Abind%E4%B8%ADrndc%E7%9A%84%E4%BD%BF%E7%94%A8/03.jpeg?raw=true)</p>
<ol>
<li>好的，重新载入配置文件，在分别在两台机器上测试一下吧。</li>
</ol>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;重载配置文件：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8(%E5%9B%9B" alt="">%EF%BC%9ADNS%E8%A7%86%E5%9B%BE%E5%8F%8Abind%E4%B8%ADrndc%E7%9A%84%E4%BD%BF%E7%94%A8/04.jpeg?raw=true)</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;192.168.0.6的机器，也就是我们DNS所属的这台机器，结果如下：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8(%E5%9B%9B" alt="">%EF%BC%9ADNS%E8%A7%86%E5%9B%BE%E5%8F%8Abind%E4%B8%ADrndc%E7%9A%84%E4%BD%BF%E7%94%A8/05.jpeg?raw=true)</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;192.168.0.12的机器，结果如下：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8(%E5%9B%9B" alt="">%EF%BC%9ADNS%E8%A7%86%E5%9B%BE%E5%8F%8Abind%E4%B8%ADrndc%E7%9A%84%E4%BD%BF%E7%94%A8/06.jpeg?raw=true)</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;两台机器请求DNS服务器时域名解析达到了预期的效果，测试成功。</p>
<h2 id="二、bind中rndc的使用"><a href="#二、bind中rndc的使用" class="headerlink" title="二、bind中rndc的使用"></a>二、bind中rndc的使用</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;rndc是Remote Name Domain Controllerr的简写，它是一个远程管理bind的工具。在使用rndc管理bind前需要使用rndc生成一对密钥文件，一半保存于rndc的配置文件中，另一半保存于bind主配置文件中。rndc的配置文件为/etc/rndc.conf，在CentOS或者RHEL中，rndc的密钥保存在/etc/rndc.key文件中。rndc默认监听在953号端口，其实在bind9中rndc默认就是可以使用可，不需要配置密钥文件。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;rndc常用命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">status <span class="comment">#查看DNS状态</span></div><div class="line">reload <span class="comment">#重新加载配置文件</span></div><div class="line">reload zone_name <span class="comment">#重新加载指定区域</span></div><div class="line">reconfig <span class="comment">#重读配置文件并加载新增的区域</span></div><div class="line">querylog <span class="comment">#关闭或开启查询日志</span></div><div class="line">flush <span class="comment">#清空服务器的缓存</span></div><div class="line">flushname name <span class="comment">#清空指定名称相关的缓存</span></div><div class="line">trace  <span class="comment">#打开debug, debug有级别的概念，每执行一次提升一次级别</span></div><div class="line">trace LEVEL <span class="comment">#指定 debug 的级别, trace 0 表示关闭debug</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;使用rndc：</p>
<ol>
<li>生成密钥文件</li>
</ol>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rndc-confgen &gt; /etc/rndc.conf</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;或者</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rndc-confgen -r /dev/urandom &gt; /etc/rndc.conf</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;生成的配置文件如下：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8(%E5%9B%9B" alt="">%EF%BC%9ADNS%E8%A7%86%E5%9B%BE%E5%8F%8Abind%E4%B8%ADrndc%E7%9A%84%E4%BD%BF%E7%94%A8/07.jpeg?raw=true)</p>
<ol>
<li>复制上面配置文件中下面一块被注释的区域至/etc/named.conf文件中，并把注释关闭。</li>
</ol>
<p><img src="https://github.com/hcldirgit/image/blob/master/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8(%E5%9B%9B" alt="">%EF%BC%9ADNS%E8%A7%86%E5%9B%BE%E5%8F%8Abind%E4%B8%ADrndc%E7%9A%84%E4%BD%BF%E7%94%A8/08.jpeg?raw=true)</p>
<ol>
<li>重新加载bind后就可以使用rndc管理bind了。</li>
</ol>
<p><img src="https://github.com/hcldirgit/image/blob/master/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8(%E5%9B%9B" alt="">%EF%BC%9ADNS%E8%A7%86%E5%9B%BE%E5%8F%8Abind%E4%B8%ADrndc%E7%9A%84%E4%BD%BF%E7%94%A8/09.jpeg?raw=true)</p>
<ol>
<li>使用rndc重新加载bind的配置文件。</li>
</ol>
<p><img src="https://github.com/hcldirgit/image/blob/master/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8(%E5%9B%9B" alt="">%EF%BC%9ADNS%E8%A7%86%E5%9B%BE%E5%8F%8Abind%E4%B8%ADrndc%E7%9A%84%E4%BD%BF%E7%94%A8/10.jpeg?raw=true)</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注意：如果在使用rndc时，出现如上警告时，可以删除/etc/rndc.key文件，或者重命名该文件。</p>
<ol>
<li>DNS服务器的debug功能默认是关闭的，使用rndc trace可以开启该功能，执行一次该命令 debug 级别加一级，也可以在命令后面加一个数字作为参数，指定debug级别，当数字为0时，表示关闭debug功能。</li>
</ol>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;开启debug:</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8(%E5%9B%9B" alt="">%EF%BC%9ADNS%E8%A7%86%E5%9B%BE%E5%8F%8Abind%E4%B8%ADrndc%E7%9A%84%E4%BD%BF%E7%94%A8/11.jpeg?raw=true)</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;关闭debug:</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8(%E5%9B%9B" alt="">%EF%BC%9ADNS%E8%A7%86%E5%9B%BE%E5%8F%8Abind%E4%B8%ADrndc%E7%9A%84%E4%BD%BF%E7%94%A8/12.jpeg?raw=true)</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DNS/">DNS</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Dns、Iredmaill/1. dns、iredmail邮件服务" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Dns、Iredmaill/1. dns、iredmail邮件服务/" class="article-date">
  	<time datetime="2017-09-02T18:00:30.878Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Dns、Iredmaill/1. dns、iredmail邮件服务/">
        DNS、iredmaill 邮件服务
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;全称domain name server。域名服务器，用来解析域名的。</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/dns%E3%80%81iredmaill%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1/01.png?raw=true" alt="images"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;域名标准写法：www.qq.com.</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;DNS是如何实现解析域名的：客户端先查找/etc/hosts里是否有对应域名的ip，没有的话查找dns服务器（在/etc/resolv.conf下配置的），首先查找缓存，缓存没有，找.根名称服务器DNS，根名称服务器说没有，但我知道.com，又找.com顶级名称服务器，从.com找到microsoft.com。最终找到example.microsoft.com。找的过程都是找的dns服务器。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">[root@linux ~]<span class="comment"># yum install -y bind</span></div><div class="line">[root@linux ~]<span class="comment"># vi /etc/named.conf          //以下是用到的配置信息，其它暂且不理会</span></div><div class="line">options &#123;</div><div class="line">        listen-on port 53 &#123; 127.0.0.1; &#125;;                //监听端口53，监听53端口的ip是谁</div><div class="line">        listen-on-v6 port 53 &#123; ::1; &#125;;                     //ipv6</div><div class="line">        directory       <span class="string">"/var/named"</span>;                    //子配置文件所对应的目录</div><div class="line">logging &#123;</div><div class="line">        channel default_debug &#123;</div><div class="line">                file <span class="string">"data/named.run"</span>;                    //日志。路径/var/named/data/named.run</div><div class="line">                severity dynamic;</div><div class="line">        &#125;;</div><div class="line">&#125;;</div><div class="line">zone <span class="string">"."</span> IN &#123;                                                    //.就是根域</div><div class="line">        <span class="built_in">type</span> hint;                                                //<span class="built_in">type</span>有三种，master主，slave从，hint根域的hint</div><div class="line">        file <span class="string">"named.ca"</span>;                                      //根域对应的文件。文件在/var/named/下</div><div class="line">&#125;;</div><div class="line">[root@linux ~]<span class="comment"># vim /var/named/named.ca        //每一个域对应一个机器。</span></div><div class="line">[root@linux ~]<span class="comment"># cat /var/named/named.localhost</span></div><div class="line"><span class="variable">$TTL</span> 1D                                                                          //1D就是1天生存周期</div><div class="line">@       IN SOA  @ rname.invalid. (                                 //SOA指的是解析记录。如A、CNAME等</div><div class="line">                                        0       ; serial                 //序列号</div><div class="line">                                        1D      ; refresh            //从每隔一段时间刷一次和主的数据是否有更新</div><div class="line">                                        1H      ; retry               //发现和主不通了，再过多长时间去试一下。</div><div class="line">                                        1W      ; expire            //过期时间。缓存时间，一周</div><div class="line">                                        3H )    ; minimum       //和上面的TTL有关，上面没有定义，以此项为准 </div><div class="line">          NS          @</div><div class="line">          A             127.0.0.1</div><div class="line">          AAAA      ::1                                   //ipv6</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;其中第二行的@符号指的是/etc/named.rfc1912.zones中定义的zone引号里面的内容。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@linux ~]<span class="comment"># /etc/init.d/named start</span></div><div class="line">[root@linux ~]<span class="comment"># dig @127.0.0.1 localhost</span></div><div class="line">[root@linux ~]<span class="comment"># dig @127.0.0.1 localhost.localdomain</span></div><div class="line">[root@linux ~]<span class="comment"># dig @127.0.0.1 -x 127.0.0.1     //测试反解析          //反解析</span></div></pre></td></tr></table></figure>
<h3 id="1-正向解析"><a href="#1-正向解析" class="headerlink" title="1.正向解析"></a>1.正向解析</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">[root@linux ~]<span class="comment"># vim /etc/named.conf                  //在内容的最后面增加以下内容</span></div><div class="line">zone <span class="string">"123.com"</span> IN &#123;</div><div class="line">        <span class="built_in">type</span> master;</div><div class="line">        file <span class="string">"123.com.zone"</span>;</div><div class="line">&#125;;</div><div class="line">[root@linux ~]<span class="comment"># named-checkconf                      //检测是否有错</span></div><div class="line">[root@linux ~]<span class="comment"># vim /var/named/123.com.zone</span></div><div class="line"><span class="variable">$TTL</span> 1D</div><div class="line">@        IN SOA  @ admin.123.com. (</div><div class="line">                                        20161025       ; serial</div><div class="line">                                        1D      ; refresh</div><div class="line">                                        1H      ; retry</div><div class="line">                                        1W      ; expire</div><div class="line">                                        3H )    ; minimum</div><div class="line">           IN  NS      ns.123.com.</div><div class="line">           IN  MX  5   mail.123.com.</div><div class="line">mail    IN  A       192.168.1.20</div><div class="line">ns       IN  A       192.168.1.70                       //对外服务应写公网ip</div><div class="line">www   IN  A       11.11.11.11</div><div class="line">bbs     IN  CNAME   www</div><div class="line">[root@linux ~]<span class="comment"># named-checkzone "123.com" /var/named/123.com.zone</span></div><div class="line">zone 123.com/IN: loaded serial 20161025</div><div class="line">OK</div><div class="line">[root@linux ~]<span class="comment"># vim /etc/named.conf</span></div><div class="line">options &#123;</div><div class="line">        listen-on port 53 &#123; 127.0.0.1;192.168.1.70; &#125;;</div><div class="line">[root@linux ~]<span class="comment"># /etc/init.d/named restart</span></div><div class="line">[root@linux ~]<span class="comment"># dig @192.168.1.70 www.123.com</span></div></pre></td></tr></table></figure>
<h3 id="2-反向解析"><a href="#2-反向解析" class="headerlink" title="2.反向解析"></a>2.反向解析</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;想做邮件服务器，最好加下反解析。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[root@linux ~]<span class="comment"># vim /etc/named.conf          //添加以下内容</span></div><div class="line">zone <span class="string">"1.168.192.in-addr.arpa"</span> IN &#123;</div><div class="line">        <span class="built_in">type</span> master;</div><div class="line">        file <span class="string">"1.168.192.zone"</span>;</div><div class="line">&#125;;</div><div class="line">[root@linux ~]<span class="comment"># vim /var/named/1.168.192.zone</span></div><div class="line"><span class="variable">$TTL</span> 1D</div><div class="line">@        IN SOA  @ admin.123.com. (</div><div class="line">                                        20161025       ; serial</div><div class="line">                                        1D      ; refresh</div><div class="line">                                        1H      ; retry</div><div class="line">                                        1W      ; expire</div><div class="line">                                        3H )    ; minimum</div><div class="line">           IN  NS      ns.123.com.</div><div class="line">160     IN  PTR     ns.123.com.</div><div class="line">20       IN  PTR     mail.123.com.</div><div class="line">[root@linux ~]<span class="comment"># named-checkconf</span></div><div class="line">[root@linux ~]<span class="comment"># /etc/init.d/named restart</span></div><div class="line">[root@linux ~]<span class="comment"># dig @192.168.1.70 -x 192.168.1.20</span></div></pre></td></tr></table></figure>
<h3 id="从DNS服务器"><a href="#从DNS服务器" class="headerlink" title="从DNS服务器"></a>从DNS服务器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[root@linux ~]<span class="comment"># yum install -y bind             </span></div><div class="line">[root@linux ~]<span class="comment"># vim /etc/named.conf               //注释//这两行将会监听服务器上所有端口</span></div><div class="line">options &#123;</div><div class="line">//        listen-on port 53 &#123; 127.0.0.1;192.168.1.70; &#125;;</div><div class="line">//        listen-on-v6 port 53 &#123; ::1; &#125;;</div><div class="line">[root@linux ~]<span class="comment"># vim /etc/named.conf              //在文件下面添加以下信息</span></div><div class="line">zone <span class="string">"123.com"</span> IN &#123;</div><div class="line">        <span class="built_in">type</span> slave;</div><div class="line">        file <span class="string">"slaves/123.com.zone"</span>;</div><div class="line">     masters &#123; 192.168.11.160; &#125;;                      //注意大括号前后面有空格。</div><div class="line">&#125;;</div><div class="line">[root@linux ~]<span class="comment"># /etc/init.d/named start</span></div><div class="line">[root@linux ~]<span class="comment"># ls /var/named/slave     //有没有生成这两个文件 </span></div><div class="line">11.168.192.zone   123.com.zone</div><div class="line">[root@linux ~]<span class="comment"># cat /var/named/slaves/123.com.zone         //查看和主上是否一致</span></div><div class="line">[root@linux ~]<span class="comment"># dig @192.168.1.20 www.123.com               //检测解析</span></div><div class="line">[root@linux ~]<span class="comment"># dig @192.168.1.20 -x 192.168.1.70</span></div><div class="line">[root@linux ~]<span class="comment"># vim /var/named/123.com.zone   //增加一个域名记录</span></div><div class="line">aming    IN    A          111.111.111.111</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;主上有更改，从上立马生效，需要在主配置文件中添加两条notify yes;also-notify { 192.168.1.20; };</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@linux ~]<span class="comment"># named-checkconf</span></div><div class="line">[root@linux ~]<span class="comment"># /etc/init.d/named restart</span></div></pre></td></tr></table></figure>
<h2 id="iredmaill"><a href="#iredmaill" class="headerlink" title="iredmaill"></a>iredmaill</h2><h3 id="iredmail安装"><a href="#iredmail安装" class="headerlink" title="iredmail安装"></a>iredmail安装</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;iRedMail 是一个基于 Linux/BSD 系统的零成本、功能完备、成熟的邮件服务器解决方案。<a href="www.iredmail.com">官网</a></p>
<h4 id="iRedmail包含的套件："><a href="#iRedmail包含的套件：" class="headerlink" title="iRedmail包含的套件："></a>iRedmail包含的套件：</h4><ul>
<li>postfix发邮件的</li>
<li>dovecot收邮件的</li>
<li>apache网页web访问，数据存放mysql或者openldap里面。</li>
<li>policyd拒绝黑名单</li>
<li>amavisd杀毒、扫描垃圾邮件</li>
<li>roundcube在web页面访问邮箱收发邮件的套件。即webmail</li>
<li>awstat分析日志</li>
<li>fail2ban防止暴力破解</li>
<li>iRedAdmin管理邮件，账户增加、删除、修改</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;需有域名和服务器，服务器配置内存不低于1G</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;首先修改域名的MX记录指向自定义的比如mail.lishiming.net上 ,mail.lishiming.net需A记录指向购买的公网服务器ip上。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@linux ~]<span class="comment"># hostname mail.lishiming.net</span></div><div class="line">[root@linux ~]<span class="comment"># vim /etc/hosts</span></div><div class="line">127.0.0.1   mail.lishiming.net   localhost</div><div class="line">[root@linux ~]<span class="comment"># wget https://bitbucket.org/zhb/iredmail/downloads/iRedMail-0.9.5-1.tar.bz2</span></div><div class="line">[root@linux ~]<span class="comment"># cd iRedMail-0.9.0</span></div><div class="line">[root@linux iRedMail-0.9.0]<span class="comment"># cd pkgs/</span></div><div class="line">[root@linux pkgs]<span class="comment"># vim get_all.sh           //里面的iredmail.org修改一下</span></div><div class="line">[root@linux pkgs]<span class="comment"># sed -i 's/iredmail.org/106.187.51.47/g' get_all.sh     //ip是日本的代理服务器</span></div><div class="line">[root@linux pkgs]<span class="comment"># cd ..</span></div><div class="line">[root@linux iRedMail-0.9.0]<span class="comment"># sh iRedMail.sh</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;将会出来类似于图片界面，yes–Next–按tab选择Apache（按空格键选项前会出来*号说明选中）–选择MySQL–设置mysql密码–设置域（填写域名）–设置管理员的密码–Next。输入y–是否启用iptables选择n–移动my.cnf选择y。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@linux iRedMail-0.9.0]<span class="comment"># for s in httpd iredapd amavisd clamd postfix dovecot cbpolicyd spamassassin clamd.amavisd saslauthd fail2ban; do /etc/init.d/$s restart; done</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;启动以上这些服务。</p>
<h3 id="iredmail使用"><a href="#iredmail使用" class="headerlink" title="iredmail使用"></a>iredmail使用</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;唯有dovecot启动是失败，错误提示ipv6的ip失败，这时需编辑配置文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@linux iRedMail-0.9.0]<span class="comment"># vim /etc/dovecot/dovecot.conf</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;找到：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">listen = *  [::]</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">listen = *</div><div class="line">[root@linux iRedMail-0.9.0]<span class="comment"># /etc/init.d/dovecot restart</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这时浏览器访问：<a href="https://mail.lishiming.net/iredadmin" target="_blank" rel="external">https://mail.lishiming.net/iredadmin</a>        //提示：您的连接不是私密连接，这时点击下面的“高级”–继续访问。Add–User  增加一个邮箱用户。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;foxmail新建一个账号，输入新建的邮箱用户名和密码。</p>
<p><img src="http://note.youdao.com/yws/public/resource/f413494d6e99fd7f2fc23e25ee770484/xmlnote/73083A746F144E6E865BCFAB35CBF944/7728" alt="images"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;接下来，进行发收邮件的测试。这时收件时速度有些慢，更改以下文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@linux iRedMail-0.9.0]<span class="comment"># vim /etc/policyd/cluebringer.conf           </span></div><div class="line">注释<span class="comment">#Greylisting               //灰名单</span></div><div class="line">[root@linux iRedMail-0.9.0]<span class="comment"># /etc/init.d/postfix restart; /etc/init.d/dovecot restart;/etc/init.d/cbpolicyd restart</span></div></pre></td></tr></table></figure>
<h3 id="iredmail增加域"><a href="#iredmail增加域" class="headerlink" title="iredmail增加域"></a>iredmail增加域</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;5d6d.com   MX   mail.lishiming.net.             //解析</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;浏览器访问：<a href="https://mail.lishiming.net/iredadmin" target="_blank" rel="external">https://mail.lishiming.net/iredadmin</a>        //Add–Domain  增加一个域。5d6d.com</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;之后Add增加一个邮箱用户名lishiming@5d6d.com</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在foxmail上右上角–账号管理–增加账号</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;测试收发邮件。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DNS/">DNS</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Ansible/1. Ansible 安装与配置" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Ansible/1. Ansible 安装与配置/" class="article-date">
  	<time datetime="2017-09-02T17:59:31.009Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Ansible/1. Ansible 安装与配置/">
        Ansible 安装与配置
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-ansible特点"><a href="#1-ansible特点" class="headerlink" title="1. ansible特点"></a>1. ansible特点</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;不需要安装客户端，通过sshd去通信</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;基于模块工作，模块可以由任何语言开发</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;不仅支持命令行使用模块，也支持编写yaml格式的playbook</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;支持sudo</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;有提供UI（浏览器图形化）www.ansible.com/tower  10台主机以内免费</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;开源UI  <a href="https://github.com/alaxli/ansible_ui" target="_blank" rel="external">https://github.com/alaxli/ansible_ui</a> </p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;文档 <a href="http://download.csdn.net/detail/liyang23456/7741185" target="_blank" rel="external">http://download.csdn.net/detail/liyang23456/7741185</a></p>
<h2 id="2-ansible-安装"><a href="#2-ansible-安装" class="headerlink" title="2.ansible 安装"></a>2.ansible 安装</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;两台机器 192.168.0.82    192.168.0.81</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;只需要在192.168.0.82上安装ansible即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># yum install -y epel-release</span></div><div class="line">[root@ansible ~]<span class="comment"># yum install -y ansible</span></div></pre></td></tr></table></figure>
<h3 id="ansible-配置密钥"><a href="#ansible-配置密钥" class="headerlink" title="ansible 配置密钥"></a>ansible 配置密钥</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;192.168.0.82上生成密钥对</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;ssh-keygen -t rsa  直接回车即可，不用设置密钥密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># ssh-keygen -t rsa</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;把公钥(id_rsa.pub）内容放到对方机器（111）的/root/.ssh/authorized_keys里面</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># scp .ssh/id_rsa.pub 192.168.0.81:/root/.ssh/authorized_keys</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/01.png?raw=true" alt="01"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;本机也要操作 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># cat /root/.ssh/id_rsa.pub &gt;&gt; /root/.ssh/authorized_keys</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># chmod 600 /root/.ssh/authorized_keys</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;关闭selinux</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/02.png?raw=true" alt="02"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;检测连接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># yum install -y openssh-clients</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># ssh 192.168.0.81</span></div><div class="line">Nasty PTR record <span class="string">"192.168.0.81"</span> is <span class="built_in">set</span> up <span class="keyword">for</span> 192.168.0.81, ignoring</div><div class="line">Last login: Thu Feb 23 22:34:20 2017 from 192.168.0.100</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/03.png?raw=true" alt="03"></p>
<h3 id="ansible-更改配置文件"><a href="#ansible-更改配置文件" class="headerlink" title="ansible 更改配置文件"></a>ansible 更改配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># vim /etc/ansible/hosts</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;增加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[testhost]</div><div class="line">127.0.0.1</div><div class="line">192.168.0.81</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/04.png?raw=true" alt="04"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明： testhost为主机组名字，自定义的。 下面两个ip为组内的机器ip。</p>
<h2 id="3-Ansible-远程执行命令"><a href="#3-Ansible-远程执行命令" class="headerlink" title="3.Ansible 远程执行命令"></a>3.Ansible 远程执行命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># ansible testhost -m command -a 'w'</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/05.png?raw=true" alt="05"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这样就可以批量执行命令了。这里的testhost 为主机组名，-m后边是模块名字，-a后面是命令。当然我们也可以直接写一个ip，针对某一台机器来执行命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># ansible 127.0.0.1 -m command -a 'hostname'</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/06.png?raw=true" alt="06"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;错误： “msg”: “Aborting, target uses selinux but python bindings (libselinux-python) aren’t installed!”</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;解决： </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># yum install -y libselinux-python</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;还有一个模块就是shell同样也可以实现</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># ansible testhost -m shell -a 'w'</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;shell 和 command 的区别</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/07.png?raw=true" alt="07"></p>
<h2 id="4-ansible-拷贝文件或者目录"><a href="#4-ansible-拷贝文件或者目录" class="headerlink" title="4.ansible 拷贝文件或者目录"></a>4.ansible 拷贝文件或者目录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># ansible testhost -m copy -a "src=/etc/ansible dest=/tmp/ansibletest owner=root group=root mode=0644etest owner=root group=root mode=0755"</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/08.png?raw=true" alt="08"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注意：源目录会放到目标目录下面去，如果目标指定的目录不存在，它会自动创建。如果拷贝的是文件，dest指定的名字和源如果不同，并且它不是已经存在的目录，相当于拷贝过去后又重命名。但相反，如果desc是目标机器上已经存在的目录，则会直接把文件拷贝到该目录下面。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># ansible testhost -m copy -a "src=/etc/passwd dest=/tmp/123"</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这里的/tmp/123和源机器上的/etc/passwd是一致的，但如果目标机器上已经有/tmp/123目录，则会再/tmp/123目录下面建立passwd文件.如果没有123目录，则直接创建123文件。</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/09.png?raw=true" alt="09"></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/10.png?raw=true" alt="10"></p>
<h2 id="5-ansible-远程执行脚本"><a href="#5-ansible-远程执行脚本" class="headerlink" title="5.ansible 远程执行脚本"></a>5.ansible 远程执行脚本</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;首先创建一个shell脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># vim /tmp/test.sh</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;加入内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">d=`date`</div><div class="line"><span class="built_in">echo</span> <span class="variable">$d</span> &gt; /tmp/an_test.txt</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/11.png?raw=true" alt="11"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后把该脚本分发到各个机器上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># ansible testhost -m copy -a "src=/tmp/test.sh dest=/tmp/test.sh mode=0755"</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;最后是批量执行该shell脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># ansible testhost -m shell -a "/tmp/test.sh"</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/12.png?raw=true" alt="12"></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/13.png?raw=true" alt="13"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;shell模块，还支持远程执行命令并且带管道</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># ansible testhost -m shell -a "cat /etc/passwd | wc -l"</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/14.png?raw=true" alt="14"></p>
<h2 id="6-ansible-实现任务计划"><a href="#6-ansible-实现任务计划" class="headerlink" title="6.ansible 实现任务计划"></a>6.ansible 实现任务计划</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># ansible testhost -m cron -a "name='test cron' job='/bin/touch /tmp/1212.txt' weekday=6"</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/15.png?raw=true" alt="15"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;若要删除该cron 只需要加一个字段 state=absent</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># ansible testhost -m cron -a "name='test cron' state=absent"</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/16.png?raw=true" alt="16"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;其他的时间表示：分钟 minute 小时 hour 日期 day 月份 month</p>
<h2 id="7-Ansible安装rpm包管理服务"><a href="#7-Ansible安装rpm包管理服务" class="headerlink" title="7.Ansible安装rpm包管理服务"></a>7.Ansible安装rpm包管理服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># ansible testhost -m yum -a "name=httpd"</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/17.png?raw=true" alt="17"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在name后面还可以加上state=installed</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># ansible testhost -m service -a "name=httpd state=started enabled=yes"</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/18.png?raw=true" alt="18"></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/19.png?raw=true" alt="19"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这里的name是centos系统里的服务名，可以通过chkconfig –list查到。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Ansible文档的使用</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;ansible-doc -l   列出所有的模块</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/20.png?raw=true" alt="20"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;ansible-doc cron  查看指定模块的文档</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/21.png?raw=true" alt="21"></p>
<h2 id="8-ansible-playbook-的使用"><a href="#8-ansible-playbook-的使用" class="headerlink" title="8.ansible playbook 的使用"></a>8.ansible playbook 的使用</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;相当于把模块写入到配置文件里面，例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># vim /etc/ansible/test.yml</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;添加内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">- hosts: testhost</div><div class="line">  remote_user: root</div><div class="line">  tasks:</div><div class="line">    - name: test_playbook</div><div class="line">    shell: touch /tmp/yanyi.txt</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/22.png?raw=true" alt="22"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明： hosts参数指定了对哪些主机进行参作；</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;user参数指定了使用什么用户登录远程主机操作；</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;tasks指定了一个任务，其下面的name参数同样是对任务的描述，在执行过程中会打印出来。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># ansible-playbook /etc/ansible/test.yml</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/23.png?raw=true" alt="23"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;192.168.0.82</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/24.png?raw=true" alt="24"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;192.168.0.81</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/25.png?raw=true" alt="25"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;再来一个创建用户的例子：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># vim /etc/ansible/create_user.yml</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;添加内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">- name: create_user</div><div class="line">  hosts: testhost</div><div class="line">  user: root</div><div class="line">  gather_facts: <span class="literal">false</span></div><div class="line">  vars:</div><div class="line">    - user: <span class="string">"test"</span></div><div class="line">  tasks:</div><div class="line">    - name: create user</div><div class="line">    user: name=<span class="string">"&#123;&#123; user &#125;&#125;"</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/26.png?raw=true" alt="26"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明： name参数对该playbook实现的功能做一个概述，后面执行过程中，会打印 name变量的值 ，可以省略；gather_facts参数指定了在以下任务部分执行前，是否先执行setup模块获取主机相关信息，这在后面的task会使用到setup获取的信息时用到；vars参数，指定了变量，这里指字一个user变量，其值为test ，需要注意的是，变量值一定要用引号引住；user提定了调用user模块，name是user模块里的一个参数，而增加的用户名字调用了上面user变量的值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># ansible-playbook /etc/ansible/create_user.yml</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/27.png?raw=true" alt="27"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;192.168.0.82</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/28.png?raw=true" alt="28"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;192.168.0.81</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/29.png?raw=true" alt="29"></p>
<h2 id="9-ansible-playbook-中的循环"><a href="#9-ansible-playbook-中的循环" class="headerlink" title="9.ansible playbook 中的循环"></a>9.ansible playbook 中的循环</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># vim /etc/ansible/loop.yml</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;添加内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">- hosts: testhost</div><div class="line">  user: root</div><div class="line">  tasks:</div><div class="line">    - name: change mode <span class="keyword">for</span> files</div><div class="line">      file: path=/tmp/&#123;&#123; item &#125;&#125; mode=600</div><div class="line">      with_items:</div><div class="line">        - 1.txt</div><div class="line">        - 2.txt</div><div class="line">        - 3.txt</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/30.png?raw=true" alt="30"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># ansible-playbook /etc/ansible/loop.yml</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/31.png?raw=true" alt="31"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;192.168.0.82 文件权限改为600</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/32.png?raw=true" alt="32"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;192.168.0.81 文件权限改为600</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/33.png?raw=true" alt="33"></p>
<h2 id="10-ansible-playbook-条件判断"><a href="#10-ansible-playbook-条件判断" class="headerlink" title="10.ansible playbook 条件判断"></a>10.ansible playbook 条件判断</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># vim /etc/ansible/when.yml</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;添加内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">- hosts: testhost</div><div class="line">  user: root</div><div class="line">  gather_facts: True</div><div class="line">  tasks:</div><div class="line">    - name: use when</div><div class="line">      shell: touch /tmp/when.txt</div><div class="line">      when: ansible_eth0.ipv4.address == <span class="string">"192.168.0.82"</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/34.png?raw=true" alt="34"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># ansible-playbook /etc/ansible/when.yml</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/35.png?raw=true" alt="35"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<a href="https://hcldirgit.github.io/2017/08/20/Ansible/2.%20ansible%E5%88%A4%E6%96%AD%20%E5%87%BA%E7%8E%B0FATAL%20all%20hosts%20have%20already%20failed%20--%20aborting%20%E9%94%99%E8%AF%AF/">ansible判断 出现FATAL all hosts have already failed – aborting 错误</a></p>
<h2 id="11-ansible-playbook-中的-handlers"><a href="#11-ansible-playbook-中的-handlers" class="headerlink" title="11.ansible playbook 中的 handlers"></a>11.ansible playbook 中的 handlers</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;执行task之后，服务器发生变化之后要执行的一些操作，比如我们修改了配置文件后，需要重启一下服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># vim /etc/ansible/handlers.yml</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;添加内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">- name: handlers <span class="built_in">test</span></div><div class="line">  hosts: 192.168.0.81</div><div class="line">  user: root</div><div class="line">  tasks:</div><div class="line">    - name: copy file</div><div class="line">    copy: src=/etc/passwd dest=/tmp/aaa.txt</div><div class="line">    notify: <span class="built_in">test</span> handlers</div><div class="line">  handlers:</div><div class="line">     - name: <span class="built_in">test</span> handlers</div><div class="line">       shell: <span class="built_in">echo</span> <span class="string">"111111"</span> &gt;&gt; /tmp/aaa.txt</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/36.png?raw=true" alt="36"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明，只有copy模块真正执行后，才会去调用下面的handlers相关的操作。也就是说如果1.txt和2.txt内容是一样的，并不会去执行handlers里面的shell相关命令。 这种比较适合配置文件发生更改后，重启服务的操作。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># ansible-playbook /etc/ansible/handlers.yml</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;客户端查看</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/37.png?raw=true" alt="37"></p>
<h2 id="12-ansible-安装-nginx"><a href="#12-ansible-安装-nginx" class="headerlink" title="12.ansible 安装 nginx"></a>12.ansible 安装 nginx</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;思路：先在一台机器上编译安装好nginx、打包，然后再用ansible去下发</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;进入ansible配置文件目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># cd /etc/ansible</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;创建一个nginx_install的目录，方便管理</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ansible]<span class="comment"># mkdir nginx_install</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ansible]<span class="comment"># cd nginx_install/</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible nginx_install]<span class="comment"># mkdir -p roles/&#123;common,install&#125;/&#123;handlers,files,meta,tasks,templates,vars&#125;</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明：roles目录下有两个角色，common为一些准备操作，install为安装nginx的操作。每个角色下面又有几个目录，handlers下面是当发生改变时要执行的操作，通常用在配置文件发生改变，重启服务。files为安装时用到的一些文件，meta为说明信息，说明角色依赖等信息，tasks里面是核心的配置文件，templates通常存一些配置文件，启动脚本等模板文件，vars下为定义的变量</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;需要事先准备好安装用到的文件，具体如下：</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在一台机器上事先编译安装好nginx，配置好启动脚本，配置好配置文件</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;安装好后，我们需要把nginx目录打包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># cd /usr/local</span></div><div class="line">[root@ansible <span class="built_in">local</span>]<span class="comment"># tar zcvf nginx.tar.gz nginx</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;并放到/etc/ansible/nginx_install/roles/install/files/下面，名字为nginx.tar.gz</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible nginx_install]<span class="comment"># mv /usr/local/nginx.tar.gz /etc/ansible/nginx_install/roles/install/files/</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;启动脚本、配置文件都要放/etc/ansible/nginx_install/roles/install/templates下面</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@ansible roles]<span class="comment"># cd /etc/ansible/nginx_install/roles/install</span></div><div class="line">[root@ansible install]<span class="comment"># cp /usr/local/nginx/conf/nginx.conf templates/</span></div><div class="line">[root@ansible install]<span class="comment"># cp /etc/init.d/nginx templates/</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;定义common的tasks，nginx是需要一些依赖包的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible nginx_install]<span class="comment"># cd /etc/ansible/nginx_install/roles</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible roles]<span class="comment"># vim ./common/tasks/main.yml</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;内容如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">- name: Install initializtion require software</div><div class="line">  yum: name=&#123;&#123; item &#125;&#125; state=installed</div><div class="line">  with_items:</div><div class="line">    - zlib-devel</div><div class="line">    - pcre-devel</div><div class="line">    - openssl-devel</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/38.png?raw=true" alt="38"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;定义变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible install]<span class="comment"># vim /etc/ansible/nginx_install/roles/install/vars/main.yml</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;内容如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">nginx_user: www</div><div class="line">nginx_port: 80</div><div class="line">nginx_basedir: /usr/<span class="built_in">local</span>/nginx</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/39.png?raw=true" alt="39"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;首先要把所有用到的文档拷贝到目标机器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible install]<span class="comment"># vim /etc/ansible/nginx_install/roles/install/tasks/copy.yml</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;内容如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- name: Copy Nginx Software </div><div class="line">  copy: src=nginx.tar.gz dest=/tmp/nginx.tar.gz owner=root group=root</div><div class="line">- name: Uncompression Nginx Software</div><div class="line">  shell: tar zxf /tmp/nginx.tar.gz -C /usr/<span class="built_in">local</span>/</div><div class="line">- name: Copy Nginx Start Script</div><div class="line">  template: src=nginx dest=/etc/init.d/nginx owner=root group=root mode=0755</div><div class="line">- name: Copy Nginx Config</div><div class="line">  template: src=nginx.conf dest=&#123;&#123; nginx_basedir &#125;&#125;/conf/ owner=root group=root mode=0644</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/40.png?raw=true" alt="40"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;接下来会建立用户，启动服务，删除压缩包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># vim /etc/ansible/nginx_install/roles/install/tasks/install.yml</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;内容如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- name: Create Nginx User</div><div class="line">  user: name=&#123;&#123; nginx_user &#125;&#125; state=present createhome=no shell=/sbin/nologin</div><div class="line">- name: Start Nginx Service</div><div class="line">  service: name=nginx state=restarted</div><div class="line">- name: Add Boot Start Nginx Service</div><div class="line">  shell: chkconfig --level 345 nginx on</div><div class="line">- name: Delete Nginx compression files</div><div class="line">  shell: rm -rf /tmp/nginx.tar.gz</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/41.png?raw=true" alt="41"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;再创建main.yml并且把copy和install调用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># vim /etc/ansible/nginx_install/roles/install/tasks/main.yml</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;内容如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">- include: copy.yml</div><div class="line">- include: install.yml</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/42.png?raw=true" alt="42"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;到此两个roles：common和install就定义完成了，接下来要定义一个入口配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># vim /etc/ansible/nginx_install/install.yml</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;内容如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">- hosts: testhost</div><div class="line">  remote_user: root</div><div class="line">  gather_facts: True</div><div class="line">  roles:</div><div class="line">    - common</div><div class="line">    - install</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/43.png?raw=true" alt="43"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;执行： ansible-playbook /etc/ansible/nginx_install/install.yml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># ansible-playbook /etc/ansible/nginx_install/install.yml</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/44.png?raw=true" alt="44"></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/45.png?raw=true" alt="45"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>注意：执行之前一定要检查所有机器 80 端口是否占用，否则会出错！</strong></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;客户端查看</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/46.png?raw=true" alt="46"></p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/47.png?raw=true" alt="47"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;下载整个样例库   </p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;git clone git://github.com/dl528888/ansible-examples.git</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># git clone git://github.com/dl528888/ansible-examples.git</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;git命令，需要yum先安装一下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># yum install -y git</span></div></pre></td></tr></table></figure>
<h2 id="13-ansible-管理配置文件"><a href="#13-ansible-管理配置文件" class="headerlink" title="13.ansible 管理配置文件"></a>13.ansible 管理配置文件</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;生产环境中大多时候是需要管理配置文件的，安装软件包只是在初始化环境的时候用一下。下面我们来写个管理nginx配置文件的playbook</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># mkdir -p /etc/ansible/nginx_config/roles/&#123;new,old&#125;/&#123;files,handlers,vars,tasks&#125;</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;其中new为更新时用到的，old为回滚时用到的，files下面为nginx.conf和vhosts目录，handlers为重启nginx服务的命令<br>关于回滚，需要在执行playbook之前先备份一下旧的配置，所以对于老配置文件的管理一定要严格，千万不能随便去修改线上机器的配置，并且要保证new/files下面的配置和线上的配置一致</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;先把nginx.conf和vhosts目录放到files目录下面</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># cp /usr/local/nginx/conf/nginx.conf /etc/ansible/nginx_config/roles/new/files/</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># cp -r /usr/local/nginx/conf/vhosts /etc/ansible/nginx_config/roles/new/files/</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># vim /etc/ansible/nginx_config/roles/new/vars/main.yml</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;定义变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nginx_basedir: /usr/<span class="built_in">local</span>/nginx</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/48.png?raw=true" alt="48"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># vim /etc/ansible/nginx_config/roles/new/handlers/main.yml</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;定义重新加载nginx服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">- name: restart nginx</div><div class="line">  shell: /etc/init.d/nginx reload</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/49.png?raw=true" alt="49"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># vim /etc/ansible/nginx_config/roles/new/tasks/main.yml</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这是核心的任务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">- name: copy conf file</div><div class="line"> copy: src=&#123;&#123; item.src &#125;&#125; dest=&#123;&#123; nginx_basedir &#125;&#125;/&#123;&#123; item.dest &#125;&#125; backup=yes owner=root group=root mode=0644</div><div class="line"> with_items:</div><div class="line"> - &#123; src: nginx.conf, dest: conf/nginx.conf &#125;</div><div class="line"> - &#123; src: vhosts, dest: conf/ &#125;</div><div class="line"> notify: restart nginx</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/50.png?raw=true" alt="50"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># vim /etc/ansible/nginx_config//update.yml</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;最后是定义总入口配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">- hosts: testhost</div><div class="line">  user: root</div><div class="line">  roles:</div><div class="line">    - new</div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/51.png?raw=true" alt="51"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;执行： </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># ansible-playbook /etc/ansible/nginx_config/update.yml</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/52.png?raw=true" alt="52"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;而回滚的backup.yml对应的roles为old    </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># rsync -av /etc/ansible/nginx_config/roles/new/ /etc/ansible/nginx_config/roles/old/</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]<span class="comment"># ansible-playbook /etc/ansible/nginx_config/backup.yml</span></div></pre></td></tr></table></figure>
<p><img src="https://github.com/hcldirgit/image/blob/master/Ansible%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/53.png?raw=true" alt="53"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;回滚操作就是把旧的配置覆盖，然后重新加载nginx服务</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Ansible/">Ansible</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Ansible/2. ansible判断 出现FATAL all hosts have already failed -- aborting 错误" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Ansible/2. ansible判断 出现FATAL all hosts have already failed -- aborting 错误/" class="article-date">
  	<time datetime="2017-09-02T17:59:31.009Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Ansible/2. ansible判断 出现FATAL all hosts have already failed -- aborting 错误/">
        ansible判断 出现FATAL all hosts have already failed -- aborting 错误
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;今晚做ansible实验，验证到when判断ip的时候，遇到了个问题，就是使用ansible 127.0.0.1 -m setup 显示出来的内容并不像视频里面所显示的那样，每个值都以facter_开头的；也更找不到facter_ipaddress这个值，就是说使用facts ip判断条件是不能使用的？效果如下截图：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/ansible%E5%88%A4%E6%96%AD%20%E5%87%BA%E7%8E%B0FATAL%20all%20hosts%20have%20already%20failed%20--%20aborting%20%E9%94%99%E8%AF%AF/01.jpeg?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后去谷歌搜索了下，发现也不少人也遇到这个问题得不到解决。看了那些大神回复根本看不懂，还有个使用Python把值提取出来的，但是不懂Python，好无奈。。。。只能自己想办法了。   </p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;最初试验的代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">- hosts: testhosts</div><div class="line">  remote_user: root</div><div class="line">  gather_facts: True</div><div class="line">  tasks:</div><div class="line">    - shell: touch /tmp/when.txt</div><div class="line">      when: facter_ipaddress==<span class="string">"192.168.0.82"</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;解决方案代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">- hosts: testhosts</div><div class="line">  remote_user: root</div><div class="line">  gather_facts: True</div><div class="line">  tasks:</div><div class="line">    - shell: touch /tmp/when.txt</div><div class="line">      when: ansible_eth0.ipv4.address==<span class="string">"192.168.0.82"</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;只是 facter_ipaddress变成了ansible_eth0.ipv4.address；至于为什么这样变？ ansible X.X.X.X -m setup 探索一下就知道了。</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/ansible%E5%88%A4%E6%96%AD%20%E5%87%BA%E7%8E%B0FATAL%20all%20hosts%20have%20already%20failed%20--%20aborting%20%E9%94%99%E8%AF%AF/02.png?raw=true" alt=""></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Ansible/">Ansible</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-2. Linux 命令/49. Linux 命令- iostat" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/2. Linux 命令/49. Linux 命令- iostat/" class="article-date">
  	<time datetime="2017-09-02T17:57:34.305Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/2. Linux 命令/49. Linux 命令- iostat/">
        Linux 命令- iostat
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Linux系统中的 iostat是I/O statistics（输入/输出统计）的缩写，iostat工具将对系统的磁盘操作活动进行监视。它的特点是汇报磁盘活动统计情况，同时也会汇报出CPU使用情况。同vmstat一样，iostat也有一个弱点，就是它不能对某个进程进行深入分析，仅对系统的整体情况进行分析。iostat属于sysstat软件包。可以用yum install sysstat 直接安装。</p>
<h2 id="1．命令格式"><a href="#1．命令格式" class="headerlink" title="1．命令格式"></a>1．命令格式</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iostat [参数] [时间] [次数]</div></pre></td></tr></table></figure>
<h2 id="2．命令功能"><a href="#2．命令功能" class="headerlink" title="2．命令功能"></a>2．命令功能</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;通过iostat方便查看CPU、网卡、tty设备、磁盘、CD-ROM 等等设备的活动情况,    负载信息。</p>
<h2 id="3．命令参数"><a href="#3．命令参数" class="headerlink" title="3．命令参数"></a>3．命令参数</h2><ul>
<li>-c 显示CPU使用情况</li>
<li>-d 显示磁盘使用情况</li>
<li>-k 以 KB 为单位显示</li>
<li>-m 以 M 为单位显示</li>
<li>-N 显示磁盘阵列(LVM) 信息</li>
<li>-n 显示NFS 使用情况</li>
<li>-p[磁盘] 显示磁盘和分区的情况</li>
<li>-t 显示终端和CPU的信息</li>
<li>-x 显示详细信息</li>
<li>-V 显示版本信息</li>
</ul>
<h2 id="4．使用实例"><a href="#4．使用实例" class="headerlink" title="4．使用实例"></a>4．使用实例</h2><h3 id="实例1：显示所有设备负载情况"><a href="#实例1：显示所有设备负载情况" class="headerlink" title="实例1：显示所有设备负载情况"></a>实例1：显示所有设备负载情况</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iostat</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>输出</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[root@CT1186 ~]<span class="comment"># iostat</span></div><div class="line">Linux 2.6.18-128.el5 (CT1186)   2012年12月28日</div><div class="line"></div><div class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</div><div class="line">           8.30    0.02    5.07    0.17    0.00   86.44</div><div class="line"></div><div class="line">Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtn</div><div class="line">sda              22.73        43.70       487.42  674035705 7517941952</div><div class="line">sda1              0.00         0.00         0.00       2658        536</div><div class="line">sda2              0.11         3.74         3.51   57721595   54202216</div><div class="line">sda3              0.98         0.61        17.51    9454172  270023368</div><div class="line">sda4              0.00         0.00         0.00          6          0</div><div class="line">sda5              6.95         0.12       108.73    1924834 1677123536</div><div class="line">sda6              2.20         0.18        31.22    2837260  481488056</div><div class="line">sda7             12.48        39.04       326.45  602094508 5035104240</div></pre></td></tr></table></figure>
<h4 id="说明："><a href="#说明：" class="headerlink" title="说明："></a>说明：</h4><h5 id="cpu属性值说明："><a href="#cpu属性值说明：" class="headerlink" title="cpu属性值说明："></a>cpu属性值说明：</h5><ul>
<li>%user：CPU处在用户模式下的时间百分比。</li>
<li>%nice：CPU处在带NICE值的用户模式下的时间百分比。</li>
<li>%system：CPU处在系统模式下的时间百分比。</li>
<li>%iowait：CPU等待输入输出完成时间的百分比。</li>
<li>%steal：管理程序维护另一个虚拟处理器时，虚拟CPU的无意识等待时间百分比。</li>
<li>%idle：CPU空闲时间百分比。</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>备注</strong>：如果%iowait的值过高，表示硬盘存在I/O瓶颈，%idle值高，表示CPU较空闲，如果%idle值高但系统响应慢时，有可能是CPU等待分配内存，此时应加大内存容量。%idle值如果持续低于10，那么系统的CPU处理能力相对较低，表明系统中最需要解决的资源是CPU。</p>
<h5 id="disk属性值说明："><a href="#disk属性值说明：" class="headerlink" title="disk属性值说明："></a>disk属性值说明：</h5><ul>
<li>rrqm/s:  每秒进行 merge 的读操作数目。即 rmerge/s</li>
<li>wrqm/s:  每秒进行 merge 的写操作数目。即 wmerge/s</li>
<li>r/s:  每秒完成的读 I/O 设备次数。即 rio/s</li>
<li>w/s:  每秒完成的写 I/O 设备次数。即 wio/s</li>
<li>rsec/s:  每秒读扇区数。即 rsect/s</li>
<li>wsec/s:  每秒写扇区数。即 wsect/s</li>
<li>rkB/s:  每秒读K字节数。是 rsect/s 的一半，因为每扇区大小为512字节。</li>
<li>wkB/s:  每秒写K字节数。是 wsect/s 的一半。</li>
<li>avgrq-sz:  平均每次设备I/O操作的数据大小 (扇区)。</li>
<li>avgqu-sz:  平均I/O队列长度。</li>
<li>await:  平均每次设备I/O操作的等待时间 (毫秒)。</li>
<li>svctm: 平均每次设备I/O操作的服务时间 (毫秒)。</li>
<li>%util:  一秒中有百分之多少的时间用于 I/O 操作，即被io消耗的cpu百分比</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>备注</strong>：如果 %util 接近 100%，说明产生的I/O请求太多，I/O系统已经满负荷，该磁盘可能存在瓶颈。如果 svctm 比较接近 await，说明 I/O 几乎没有等待时间；如果 await 远大于 svctm，说明I/O 队列太长，io响应太慢，则需要进行必要优化。如果avgqu-sz比较大，也表示有当量io在等待。</p>
<h3 id="实例2：定时显示所有信息"><a href="#实例2：定时显示所有信息" class="headerlink" title="实例2：定时显示所有信息"></a>实例2：定时显示所有信息</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iostat 2 3</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>输出</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">[root@CT1186 ~]<span class="comment"># iostat 2 3</span></div><div class="line">Linux 2.6.18-128.el5 (CT1186)   2012年12月28日</div><div class="line"></div><div class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</div><div class="line">           8.30    0.02    5.07    0.17    0.00   86.44</div><div class="line"></div><div class="line">Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtn</div><div class="line">sda              22.73        43.70       487.42  674035705 7517947296</div><div class="line">sda1              0.00         0.00         0.00       2658        536</div><div class="line">sda2              0.11         3.74         3.51   57721595   54202216</div><div class="line">sda3              0.98         0.61        17.51    9454172  270023608</div><div class="line">sda4              0.00         0.00         0.00          6          0</div><div class="line">sda5              6.95         0.12       108.73    1924834 1677125640</div><div class="line">sda6              2.20         0.18        31.22    2837260  481488152</div><div class="line">sda7             12.48        39.04       326.44  602094508 5035107144</div><div class="line"></div><div class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</div><div class="line">           8.88    0.00    7.94    0.19    0.00   83.00</div><div class="line"></div><div class="line">Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtn</div><div class="line">sda               6.00         0.00       124.00          0        248</div><div class="line">sda1              0.00         0.00         0.00          0          0</div><div class="line">sda2              0.00         0.00         0.00          0          0</div><div class="line">sda3              0.00         0.00         0.00          0          0</div><div class="line">sda4              0.00         0.00         0.00          0          0</div><div class="line">sda5              0.00         0.00         0.00          0          0</div><div class="line">sda6              0.00         0.00         0.00          0          0</div><div class="line">sda7              6.00         0.00       124.00          0        248</div><div class="line"></div><div class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</div><div class="line">           9.12    0.00    7.81    0.00    0.00   83.07</div><div class="line"></div><div class="line">Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtn</div><div class="line">sda               4.00         0.00        84.00          0        168</div><div class="line">sda1              0.00         0.00         0.00          0          0</div><div class="line">sda2              0.00         0.00         0.00          0          0</div><div class="line">sda3              0.00         0.00         0.00          0          0</div><div class="line">sda4              0.00         0.00         0.00          0          0</div><div class="line">sda5              0.00         0.00         0.00          0          0</div><div class="line">sda6              4.00         0.00        84.00          0        168</div><div class="line">sda7              0.00         0.00         0.00          0          0</div></pre></td></tr></table></figure>
<h4 id="说明：-1"><a href="#说明：-1" class="headerlink" title="说明："></a>说明：</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;每隔 2秒刷新显示，且显示3次</p>
<h3 id="实例3：显示指定磁盘信息"><a href="#实例3：显示指定磁盘信息" class="headerlink" title="实例3：显示指定磁盘信息"></a>实例3：显示指定磁盘信息</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iostat -d sda1</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>输出</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@CT1186 ~]<span class="comment"># iostat -d sda1</span></div><div class="line">Linux 2.6.18-128.el5 (CT1186)   2012年12月28日</div><div class="line"></div><div class="line">Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtn</div><div class="line">sda1              0.00         0.00         0.00       2658        536</div></pre></td></tr></table></figure>
<h3 id="实例4：显示tty和Cpu信息"><a href="#实例4：显示tty和Cpu信息" class="headerlink" title="实例4：显示tty和Cpu信息"></a>实例4：显示tty和Cpu信息</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iostat -t</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>输出</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@CT1186 ~]<span class="comment"># iostat -t</span></div><div class="line">Linux 2.6.18-128.el5 (CT1186)   2012年12月28日</div><div class="line"></div><div class="line">Time: 14时58分35秒</div><div class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</div><div class="line">           8.30    0.02    5.07    0.17    0.00   86.44</div><div class="line"></div><div class="line">Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtn</div><div class="line">sda              22.73        43.70       487.41  674035705 7517957864</div><div class="line">sda1              0.00         0.00         0.00       2658        536</div><div class="line">sda2              0.11         3.74         3.51   57721595   54202216</div><div class="line">sda3              0.98         0.61        17.51    9454172  270024344</div><div class="line">sda4              0.00         0.00         0.00          6          0</div><div class="line">sda5              6.95         0.12       108.73    1924834 1677128808</div><div class="line">sda6              2.20         0.18        31.22    2837260  481488712</div><div class="line">sda7             12.48        39.04       326.44  602094508 5035113248</div></pre></td></tr></table></figure>
<h3 id="实例5：以M为单位显示所有信息"><a href="#实例5：以M为单位显示所有信息" class="headerlink" title="实例5：以M为单位显示所有信息"></a>实例5：以M为单位显示所有信息</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iostat -m</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>输出</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[root@CT1186 ~]<span class="comment"># iostat -m</span></div><div class="line">Linux 2.6.18-128.el5 (CT1186)   2012年12月28日</div><div class="line"></div><div class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</div><div class="line">           8.30    0.02    5.07    0.17    0.00   86.44</div><div class="line"></div><div class="line">Device:            tps    MB_read/s    MB_wrtn/s    MB_read    MB_wrtn</div><div class="line">sda              22.72         0.02         0.24     329119    3670881</div><div class="line">sda1              0.00         0.00         0.00          1          0</div><div class="line">sda2              0.11         0.00         0.00      28184      26465</div><div class="line">sda3              0.98         0.00         0.01       4616     131848</div><div class="line">sda4              0.00         0.00         0.00          0          0</div><div class="line">sda5              6.95         0.00         0.05        939     818911</div><div class="line">sda6              2.20         0.00         0.02       1385     235102</div><div class="line">sda7             12.48         0.02         0.16     293991    2458553</div></pre></td></tr></table></figure>
<h3 id="实例6：查看TPS和吞吐量信息"><a href="#实例6：查看TPS和吞吐量信息" class="headerlink" title="实例6：查看TPS和吞吐量信息"></a>实例6：查看TPS和吞吐量信息</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iostat -d -k 1 1</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>输出</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@CT1186 ~]<span class="comment"># iostat -d -k 1 1</span></div><div class="line">Linux 2.6.18-128.el5 (CT1186)   2012年12月28日</div><div class="line"></div><div class="line">Device:            tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn</div><div class="line">sda              22.72        21.85       243.71  337017916 3758984340</div><div class="line">sda1              0.00         0.00         0.00       1329        268</div><div class="line">sda2              0.11         1.87         1.76   28860797   27101108</div><div class="line">sda3              0.98         0.31         8.75    4727086  135012508</div><div class="line">sda4              0.00         0.00         0.00          3          0</div><div class="line">sda5              6.95         0.06        54.37     962481  838566148</div><div class="line">sda6              2.20         0.09        15.61    1418630  240744712</div><div class="line">sda7             12.48        19.52       163.22  301047254 2517559596</div></pre></td></tr></table></figure>
<h4 id="说明：-2"><a href="#说明：-2" class="headerlink" title="说明："></a>说明：</h4><ul>
<li>tps：该设备每秒的传输次数（Indicate the number of transfers per second that were issued to the device.）。“一次传输”意思是“一次I/O请求”。多个逻辑请求可能会被合并为“一次I/O请求”。“一次传输”请求的大小是未知的。</li>
<li>kB_read/s：每秒从设备（drive expressed）读取的数据量；</li>
<li>kB_wrtn/s：每秒向设备（drive expressed）写入的数据量；</li>
<li>kB_read：读取的总数据量；kB_wrtn：写入的总数量数据量；</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这些单位都为Kilobytes。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;上面的例子中，我们可以看到磁盘sda以及它的各个分区的统计数据，当时统计的磁盘总TPS是22.73，下面是各个分区的TPS。（因为是瞬间值，所以总TPS并不严格等于各个分区TPS的总和）</p>
<h3 id="实例7：查看设备使用率（-util）、响应时间（await）"><a href="#实例7：查看设备使用率（-util）、响应时间（await）" class="headerlink" title="实例7：查看设备使用率（%util）、响应时间（await）"></a>实例7：查看设备使用率（%util）、响应时间（await）</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iostat -d -x -k 1 1</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>输出</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@CT1186 ~]<span class="comment"># iostat -d -x -k 1 1</span></div><div class="line">Linux 2.6.18-128.el5 (CT1186)   2012年12月28日</div><div class="line"></div><div class="line">Device:         rrqm/s   wrqm/s   r/s   w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await  svctm  %util</div><div class="line">sda               0.44    38.59  0.40 22.32    21.85   243.71    23.37     0.04    1.78   4.20   9.54</div><div class="line">sda1              0.00     0.00  0.00  0.00     0.00     0.00    18.90     0.00    8.26   6.46   0.00</div><div class="line">sda2              0.36     0.43  0.11  0.01     1.87     1.76    63.57     0.01   63.75   1.94   0.02</div><div class="line">sda3              0.00     1.24  0.04  0.95     0.31     8.75    18.42     0.04   39.77   8.73   0.86</div><div class="line">sda4              0.00     0.00  0.00  0.00     0.00     0.00     2.00     0.00   19.67  19.67   0.00</div><div class="line">sda5              0.00     6.65  0.00  6.94     0.06    54.37    15.67     0.26   36.81   4.48   3.11</div><div class="line">sda6              0.00     1.71  0.01  2.19     0.09    15.61    14.29     0.03   12.40   5.84   1.28</div><div class="line">sda7              0.08    28.56  0.25 12.24    19.52   163.22    29.28     0.27   21.46   5.00   6.25</div></pre></td></tr></table></figure>
<h4 id="说明：-3"><a href="#说明：-3" class="headerlink" title="说明："></a>说明：</h4><ul>
<li>rrqm/s：  每秒进行 merge 的读操作数目.即 delta(rmerge)/s</li>
<li>wrqm/s： 每秒进行 merge 的写操作数目.即 delta(wmerge)/s</li>
<li>r/s：  每秒完成的读 I/O 设备次数.即 delta(rio)/s</li>
<li>w/s：  每秒完成的写 I/O 设备次数.即 delta(wio)/s</li>
<li>rsec/s：  每秒读扇区数.即 delta(rsect)/s</li>
<li>wsec/s： 每秒写扇区数.即 delta(wsect)/s</li>
<li>rkB/s：  每秒读K字节数.是 rsect/s 的一半,因为每扇区大小为512字节.(需要计算)</li>
<li>wkB/s：  每秒写K字节数.是 wsect/s 的一半.(需要计算)</li>
<li>avgrq-sz：平均每次设备I/O操作的数据大小 (扇区).delta(rsect+wsect)/delta(rio+wio)</li>
<li>avgqu-sz：平均I/O队列长度.即 delta(aveq)/s/1000 (因为aveq的单位为毫秒).</li>
<li>await：  平均每次设备I/O操作的等待时间 (毫秒).即 delta(ruse+wuse)/delta(rio+wio)</li>
<li>svctm： 平均每次设备I/O操作的服务时间 (毫秒).即 delta(use)/delta(rio+wio)</li>
<li>%util： 一秒中有百分之多少的时间用于 I/O 操作,或者说一秒中有多少时间 I/O 队列是非空的，即 delta(use)/s/1000 (因为use的单位为毫秒)</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;如果 %util 接近 100%，说明产生的I/O请求太多，I/O系统已经满负荷，该磁盘可能存在瓶颈。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;idle小于70% IO压力就较大了，一般读取速度有较多的wait。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;同时可以结合vmstat 查看查看b参数(等待资源的进程数)和wa参数(IO等待所占用的CPU时间的百分比，高过30%时IO压力高)。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;另外 await 的参数也要多和 svctm 来参考。差的过高就一定有 IO 的问题。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;avgqu-sz 也是个做 IO 调优时需要注意的地方，这个就是直接每次操作的数据的大小，如果次数多，但数据拿的小的话，其实 IO 也会很小。如果数据拿的大，才IO 的数据会高。也可以通过 avgqu-sz × ( r/s or w/s ) = rsec/s or wsec/s。也就是讲，读定速度是这个来决定的。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;svctm 一般要小于 await (因为同时等待的请求的等待时间被重复计算了)，svctm 的大小一般和磁盘性能有关，CPU/内存的负荷也会对其有影响，请求过多也会间接导致 svctm 的增加。await 的大小一般取决于服务时间(svctm) 以及 I/O 队列的长度和 I/O 请求的发出模式。如果 svctm 比较接近 await，说明 I/O 几乎没有等待时间；如果 await 远大于 svctm，说明 I/O 队列太长，应用得到的响应时间变慢，如果响应时间超过了用户可以容许的范围，这时可以考虑更换更快的磁盘，调整内核 elevator 算法，优化应用，或者升级 CPU。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;队列长度(avgqu-sz)也可作为衡量系统 I/O 负荷的指标，但由于 avgqu-sz 是按照单位时间的平均值，所以不能反映瞬间的 I/O 洪水。</p>
<h4 id="形象的比喻："><a href="#形象的比喻：" class="headerlink" title="形象的比喻："></a>形象的比喻：</h4><ul>
<li>r/s+w/s 类似于交款人的总数</li>
<li>平均队列长度(avgqu-sz)类似于单位时间里平均排队人的个数</li>
<li>平均服务时间(svctm)类似于收银员的收款速度</li>
<li>平均等待时间(await)类似于平均每人的等待时间</li>
<li>平均I/O数据(avgrq-sz)类似于平均每人所买的东西多少</li>
<li>I/O 操作率 (%util)类似于收款台前有人排队的时间比例</li>
<li>设备IO操作:总IO(io)/s = r/s(读) +w/s(写) =1.46 + 25.28=26.74</li>
<li>平均每次设备I/O操作只需要0.36毫秒完成,现在却需要10.57毫秒完成，因为发出的    请求太多(每秒26.74个)，假如请求时同时发出的，可以这样计算平均等待时间:</li>
<li>平均等待时间=单个I/O服务器时间*(1+2+…+请求总数-1)/请求总数 </li>
<li>每秒发出的I/0请求很多,但是平均队列就4,表示这些请求比较均匀,大部分处理还是比较及时。</li>
</ul>
<h3 id="实例8：查看cpu状态"><a href="#实例8：查看cpu状态" class="headerlink" title="实例8：查看cpu状态"></a>实例8：查看cpu状态</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iostat -c 1 3</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>输出</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@CT1186 ~]<span class="comment">#  iostat -c 1 3</span></div><div class="line">Linux 2.6.18-128.el5 (CT1186)   2012年12月28日</div><div class="line"></div><div class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</div><div class="line">           8.30    0.02    5.07    0.17    0.00   86.44</div><div class="line"></div><div class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</div><div class="line">           8.64    0.00    5.38    0.00    0.00   85.98</div><div class="line"></div><div class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</div><div class="line">           7.62    0.00    5.12    0.50    0.00   86.75</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux命令/">Linux命令</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-2. Linux 命令/71. Linux 命令- awk" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/2. Linux 命令/71. Linux 命令- awk/" class="article-date">
  	<time datetime="2017-09-02T17:57:34.304Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/2. Linux 命令/71. Linux 命令- awk/">
        Linux 命令- awk
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;awk 是一种处理文本文件的语言，是一个强大的文本分析工具。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;之所以叫AWK是因为其取了三位创始人 Alfred Aho，Peter Weinberger, 和 Brian Kernighan 的Family Name的首字符。</p>
<h2 id="1-命令格式"><a href="#1-命令格式" class="headerlink" title="1. 命令格式"></a>1. 命令格式</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">awk [选项参数] <span class="string">'script'</span> var=value file(s)</div><div class="line">awk [选项参数] -f script var=value file(s)</div></pre></td></tr></table></figure>
<h2 id="2-命令参数"><a href="#2-命令参数" class="headerlink" title="2. 命令参数"></a>2. 命令参数</h2><ul>
<li>-F fs or –field-separator fs<br>指定输入文件折分隔符，fs是一个字符串或者是一个正则表达式，如-F:。</li>
<li>-v var=value or –asign var=value<br>赋值一个用户定义变量。</li>
<li>-f scripfile or –file scriptfile<br>从脚本文件中读取awk命令。</li>
<li>-mf nnn and -mr nnn<br>对nnn值设置内在限制，-mf选项限制分配给nnn的最大块数目；-mr选项限制记录的最大数目。这两个功能是Bell实验室版awk的扩展功能，在标准awk中不适用。</li>
<li>-W compact or –compat, -W traditional or –traditional<br>在兼容模式下运行awk。所以gawk的行为和标准的awk完全一样，所有的awk扩展都被忽略。</li>
<li>-W copyleft or –copyleft, -W copyright or –copyright<br>打印简短的版权信息。</li>
<li>-W help or –help, -W usage or –usage<br>打印全部awk选项和每个选项的简短说明。</li>
<li>-W lint or –lint<br>打印不能向传统unix平台移植的结构的警告。</li>
<li>-W lint-old or –lint-old<br>打印关于不能向传统unix平台移植的结构的警告。</li>
<li>-W posix<br>打开兼容模式。但有以下限制，不识别：/x、函数关键字、func、换码序列以及当fs是一个空格时，将新行作为一个域分隔符；操作符**和**=不能代替\^和^=；fflush无效。</li>
<li>-W re-interval or –re-inerval<br>允许间隔正则表达式的使用，参考(grep中的Posix字符类)，如括号表达式[[:alpha:]]。</li>
<li>-W source program-text or –source program-text<br>使用program-text作为源代码，可与-f命令混用。</li>
<li>-W version or –version<br>打印bug报告信息的版本。</li>
</ul>
<h2 id="3-基本用法"><a href="#3-基本用法" class="headerlink" title="3. 基本用法"></a>3. 基本用法</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;log.txt 文本内容如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">2 this is a <span class="built_in">test</span></div><div class="line">3 Are you like awk</div><div class="line">This<span class="string">'s a test</span></div><div class="line"><span class="string">10 There are orange,apple,mongo</span></div></pre></td></tr></table></figure>
<h3 id="用法一"><a href="#用法一" class="headerlink" title="用法一"></a>用法一</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'&#123;[pattern] action&#125;'</span> &#123;filenames&#125;</div></pre></td></tr></table></figure>
<h4 id="实例：每行按空格或TAB分割，输出文本中的1、4行"><a href="#实例：每行按空格或TAB分割，输出文本中的1、4行" class="headerlink" title="实例：每行按空格或TAB分割，输出文本中的1、4行"></a>实例：每行按空格或TAB分割，输出文本中的1、4行</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>输出</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># awk '&#123;print $1,$4&#125;' log.txt                </span></div><div class="line">2 a</div><div class="line">3 like</div><div class="line">This<span class="string">'s </span></div><div class="line"><span class="string">10 orange,apple,mongo</span></div><div class="line"><span class="string">[root@localhost ~]# awk '</span>&#123;<span class="built_in">printf</span> <span class="string">"%-8s %-10s\n"</span>,<span class="variable">$1</span>,<span class="variable">$4</span>&#125;<span class="string">' log.txt  #格式化输出</span></div><div class="line"><span class="string">2        a         </span></div><div class="line"><span class="string">3        like      </span></div><div class="line"><span class="string">This'</span>s             </div><div class="line">10       orange,apple,mongo</div></pre></td></tr></table></figure>
<h3 id="用法二"><a href="#用法二" class="headerlink" title="用法二"></a>用法二</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk -F</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;-F 相当于内置变量 FS ，指定分隔字符</p>
<h4 id="实例：使用分隔符截取文档某段"><a href="#实例：使用分隔符截取文档某段" class="headerlink" title="实例：使用分隔符截取文档某段"></a>实例：使用分隔符截取文档某段</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># awk -F, '&#123;print $1,$2&#125;' log.txt   #使用“,”分割</span></div><div class="line">2 this is a <span class="built_in">test</span> </div><div class="line">3 Are you like awk </div><div class="line">This<span class="string">'s a test </span></div><div class="line"><span class="string">10 There are orange apple</span></div><div class="line"><span class="string">[root@localhost ~]# awk '</span>BEGIN&#123;FS=<span class="string">","</span>&#125; &#123;<span class="built_in">print</span> <span class="variable">$1</span>,<span class="variable">$2</span>&#125;<span class="string">' log.txt     #使用内建变量</span></div><div class="line"><span class="string">2 this is a test </span></div><div class="line"><span class="string">3 Are you like awk </span></div><div class="line"><span class="string">This'</span>s a <span class="built_in">test</span> </div><div class="line">10 There are orange apple</div><div class="line">[root@localhost ~]<span class="comment"># awk -F '[ ,]' '&#123;print $1,$2,$5&#125;' log.txt      #使用多个分隔符，先使用空格分割，然后对分割结果再使用“,”分割</span></div><div class="line">2 this <span class="built_in">test</span></div><div class="line">3 Are awk</div><div class="line">This<span class="string">'s a </span></div><div class="line"><span class="string">10 There apple</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>说明</strong></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;-F 选项的作用是指定分隔符，如果不加 -F 指定，则以空格或者 tab 为分隔符。print 为打印的动作，用来打印出某个字段。$1 为第一个字段，$2 为第二个字段，以此类推，有一个特殊的就是 $0 ，它表示整行。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;也可以使用自定义字符连接每个段，awk 的格式，-F 后紧跟单引号，然后里面为分隔符，print 的动作要用 {} 括起来，否则会报错。print 还可以打印自定义的内容，但是自定义的内容要用双引号括起来。</p>
<h3 id="用法三"><a href="#用法三" class="headerlink" title="用法三"></a>用法三</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk -v</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;-v 设置变量</p>
<h4 id="实例："><a href="#实例：" class="headerlink" title="实例："></a>实例：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># awk -v a=1 '&#123;print $1,$1+a&#125;' log.txt</span></div><div class="line">2 3</div><div class="line">3 4</div><div class="line">This<span class="string">'s 1</span></div><div class="line"><span class="string">10 11</span></div><div class="line"><span class="string">[root@localhost ~]# awk -v a=1 -v b=a '</span>&#123;<span class="built_in">print</span> <span class="variable">$1</span>,<span class="variable">$1</span>+a,<span class="variable">$1b</span>&#125;<span class="string">' log.txt</span></div><div class="line"><span class="string">2 3 2a</span></div><div class="line"><span class="string">3 4 3a</span></div><div class="line"><span class="string">This'</span>s 1 This<span class="string">'sa</span></div><div class="line"><span class="string">10 11 10a</span></div></pre></td></tr></table></figure>
<h3 id="用法四"><a href="#用法四" class="headerlink" title="用法四"></a>用法四</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk -f &#123;awk脚本&#125; [文件名]</div></pre></td></tr></table></figure>
<h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk -f cal.awk log.txt</div></pre></td></tr></table></figure>
<h2 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h2><table>
<thead>
<tr>
<th>运算符</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>= += -= <em>= /= %= ^= *</em>=</td>
<td>赋值</td>
</tr>
<tr>
<td>?:</td>
<td>C条件表达式</td>
</tr>
<tr>
<td>\</td>
<td>\</td>
<td></td>
<td>逻辑或</td>
</tr>
<tr>
<td>&amp;&amp;</td>
<td>逻辑与</td>
</tr>
<tr>
<td>~ ~!</td>
<td>匹配正则表达式和不匹配正则表达式</td>
</tr>
<tr>
<td>&lt; &lt;= &gt; &gt;= != ==</td>
<td>关系运算符</td>
</tr>
<tr>
<td>空格</td>
<td>连接</td>
</tr>
<tr>
<td>+ -</td>
<td>加，减</td>
</tr>
<tr>
<td>* / %</td>
<td>乘，除与求余</td>
</tr>
<tr>
<td>+ - !</td>
<td>一元加，减和逻辑非</td>
</tr>
<tr>
<td>^ <em>*</em></td>
<td>求幂</td>
</tr>
<tr>
<td>++ –</td>
<td>增加或减少，作为前缀或后缀</td>
</tr>
<tr>
<td>$</td>
<td>字段引用</td>
</tr>
<tr>
<td>in</td>
<td>数组成员</td>
</tr>
</tbody>
</table>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;过滤第一列大于2的行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># awk '$1&gt;2' log.txt</span></div><div class="line">3 Are you like awk</div><div class="line">This<span class="string">'s a test</span></div><div class="line"><span class="string">10 There are orange,apple,mongo</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;过滤第一列等于2的行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># awk '$1==2 &#123;print $1,$3&#125;' log.txt</span></div><div class="line">2 is</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;过滤第一列大于2并且第二列等于 ‘Are’的行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># awk '$1&gt;2 &amp;&amp; $2=="Are" &#123;print $1,$2,$3&#125;' log.txt</span></div><div class="line">3 Are you</div></pre></td></tr></table></figure>
<h2 id="内建变量"><a href="#内建变量" class="headerlink" title="内建变量"></a>内建变量</h2><table>
<thead>
<tr>
<th>变量</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>\$n</td>
<td>当前记录的第n个字段，字段间由FS分割</td>
</tr>
<tr>
<td>\$0</td>
<td>完整的输入记录</td>
</tr>
<tr>
<td>ARGC</td>
<td>命令行参数的数目</td>
</tr>
<tr>
<td>ARGIND</td>
<td>命令行中当前文件的位置（从0开始算）</td>
</tr>
<tr>
<td>ARGV</td>
<td>包含命令行参数的数组</td>
</tr>
<tr>
<td>CONVFMT</td>
<td>数字转换格式（默认值为%.6g）ENVIRON环境变量关联数组</td>
</tr>
<tr>
<td>ERRNO</td>
<td>最后一个系统错误的描述</td>
</tr>
<tr>
<td>FIELDWIDTHS</td>
<td>字段宽度列表（用空格键分割）</td>
</tr>
<tr>
<td>FILENAME</td>
<td>当前文件名</td>
</tr>
<tr>
<td>FNR</td>
<td>个文件分别计数的行号</td>
</tr>
<tr>
<td>FS</td>
<td>字段分割符（默认是任何空格）</td>
</tr>
<tr>
<td>IGNORECASE</td>
<td>如果为真，则进行忽略大小写的匹配</td>
</tr>
<tr>
<td>NF</td>
<td>输入字段的分隔符</td>
</tr>
<tr>
<td>NR</td>
<td>已经读出的记录数，就是行号，从1开始</td>
</tr>
<tr>
<td>OFMT</td>
<td>数字的输出格式（默认值是%.6g）</td>
</tr>
<tr>
<td>OFS</td>
<td>输出记录分隔符（输出换行符），输出时用指定的符号代替换行符</td>
</tr>
<tr>
<td>ORS</td>
<td>输出记录分隔符（默认值是一个换行符）</td>
</tr>
<tr>
<td>RLENGTH</td>
<td>由 match 函数所匹配的字符串的长度</td>
</tr>
<tr>
<td>RS</td>
<td>记录分隔符（默认是一个换行符）</td>
</tr>
<tr>
<td>RSTART</td>
<td>由 match 函数所匹配的字符串的第一个位置</td>
</tr>
<tr>
<td>SUBSEP</td>
<td>数组下标分隔符（默认值是/034）</td>
</tr>
</tbody>
</table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">$ awk <span class="string">'BEGIN&#123;printf "%4s %4s %4s %4s %4s %4s %4s %4s %4s\n","FILENAME","ARGC","FNR","FS","NF","NR","OFS","ORS","RS";printf "---------------------------------------------\n"&#125; &#123;printf "%4s %4s %4s %4s %4s %4s %4s %4s %4s\n",FILENAME,ARGC,FNR,FS,NF,NR,OFS,ORS,RS&#125;'</span>  log.txt</div><div class="line">FILENAME ARGC  FNR   FS   NF   NR  OFS  ORS   RS</div><div class="line">---------------------------------------------</div><div class="line">log.txt    2    1         5    1</div><div class="line">log.txt    2    2         5    2</div><div class="line">log.txt    2    3         3    3</div><div class="line">log.txt    2    4         4    4</div><div class="line">$ awk -F\<span class="string">' '</span>BEGIN&#123;<span class="built_in">printf</span> <span class="string">"%4s %4s %4s %4s %4s %4s %4s %4s %4s\n"</span>,<span class="string">"FILENAME"</span>,<span class="string">"ARGC"</span>,<span class="string">"FNR"</span>,<span class="string">"FS"</span>,<span class="string">"NF"</span>,<span class="string">"NR"</span>,<span class="string">"OFS"</span>,<span class="string">"ORS"</span>,<span class="string">"RS"</span>;<span class="built_in">printf</span> <span class="string">"---------------------------------------------\n"</span>&#125; &#123;<span class="built_in">printf</span> <span class="string">"%4s %4s %4s %4s %4s %4s %4s %4s %4s\n"</span>,FILENAME,ARGC,FNR,FS,NF,NR,OFS,ORS,RS&#125;<span class="string">'  log.txt</span></div><div class="line"><span class="string">FILENAME ARGC  FNR   FS   NF   NR  OFS  ORS   RS</span></div><div class="line"><span class="string">---------------------------------------------</span></div><div class="line"><span class="string">log.txt    2    1    '</span>    1    1</div><div class="line">log.txt    2    2    <span class="string">'    1    2</span></div><div class="line"><span class="string">log.txt    2    3    '</span>    2    3</div><div class="line">log.txt    2    4    <span class="string">'    1    4</span></div><div class="line"><span class="string"># 输出顺序号 NR, 匹配文本行号</span></div><div class="line"><span class="string">$ awk '</span>&#123;<span class="built_in">print</span> NR,FNR,<span class="variable">$1</span>,<span class="variable">$2</span>,<span class="variable">$3</span>&#125;<span class="string">' log.txt</span></div><div class="line"><span class="string">---------------------------------------------</span></div><div class="line"><span class="string">1 1 2 this is</span></div><div class="line"><span class="string">2 2 3 Are you</span></div><div class="line"><span class="string">3 3 This'</span>s a <span class="built_in">test</span></div><div class="line">4 4 10 There are</div><div class="line"><span class="comment"># 指定输出分割符</span></div><div class="line">$  awk <span class="string">'&#123;print $1,$2,$5&#125;'</span> OFS=<span class="string">" $ "</span>  log.txt</div><div class="line">---------------------------------------------</div><div class="line">2 $ this $ <span class="built_in">test</span></div><div class="line">3 $ Are $ awk</div><div class="line">This<span class="string">'s $ a $</span></div><div class="line"><span class="string">10 $ There $</span></div></pre></td></tr></table></figure>
<h2 id="使用正则，字符串匹配"><a href="#使用正则，字符串匹配" class="headerlink" title="使用正则，字符串匹配"></a>使用正则，字符串匹配</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;输出第二列包含 “th”，并打印第二列与第四列</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># awk '$2 ~ /th/ &#123;print $2,$4&#125;' log.txt</span></div><div class="line">this a</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong> ~ 表示模式开始。//中是模式。</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># awk '/re/' log.txt</span></div><div class="line">3 Are you like awk</div><div class="line">10 There are orange,apple,mongo</div></pre></td></tr></table></figure>
<h2 id="忽略大小写"><a href="#忽略大小写" class="headerlink" title="忽略大小写"></a>忽略大小写</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># awk 'BEGIN&#123;IGNORECASE=1&#125; /this/' log.txt</span></div><div class="line">2 this is a <span class="built_in">test</span></div><div class="line">This<span class="string">'s a test</span></div></pre></td></tr></table></figure>
<h2 id="模式取反"><a href="#模式取反" class="headerlink" title="模式取反"></a>模式取反</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># awk '$2 !~ /th/ &#123;print $2,$4&#125;' log.txt</span></div><div class="line">Are like</div><div class="line">a </div><div class="line">There orange,apple,mongo</div><div class="line">[root@localhost ~]<span class="comment"># awk '! /th/ &#123;print $2,$4&#125;' log.txt</span></div><div class="line">Are like</div><div class="line">a </div><div class="line">There orange,apple,mongo</div></pre></td></tr></table></figure>
<h2 id="awk-脚本"><a href="#awk-脚本" class="headerlink" title="awk 脚本"></a>awk 脚本</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;关于 awk 脚本，需要注意两个关键词 BEGIN 和 END。</p>
<ul>
<li>BEGIN {这里面放的是执行前的语句｝</li>
<li>END ｛这里面放的是处理完所有的行后要执行的语句｝</li>
<li>｛这里面放的是处理每一行时要执行的语句｝</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;假设有这么一个文件（学生成绩表）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># cat score.txt </span></div><div class="line">Marry   2143 78 84 77</div><div class="line">Jack    2321 66 78 45</div><div class="line">Tom     2122 48 77 71</div><div class="line">Mike    2537 87 97 95</div><div class="line">Bob     2415 40 57 62</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;awk 脚本如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># cat cal.awk</span></div><div class="line"><span class="comment">#!/bin/awk -f</span></div><div class="line"><span class="comment">#运行前</span></div><div class="line">BEGIN &#123;</div><div class="line">    math = 0</div><div class="line">    english = 0</div><div class="line">    computer = 0</div><div class="line"> </div><div class="line">    <span class="built_in">printf</span> <span class="string">"NAME    NO.   MATH  ENGLISH  COMPUTER   TOTAL\n"</span></div><div class="line">    <span class="built_in">printf</span> <span class="string">"---------------------------------------------\n"</span></div><div class="line">&#125;</div><div class="line"><span class="comment">#运行中</span></div><div class="line">&#123;</div><div class="line">    math+=<span class="variable">$3</span></div><div class="line">    english+=<span class="variable">$4</span></div><div class="line">    computer+=<span class="variable">$5</span></div><div class="line">    <span class="built_in">printf</span> <span class="string">"%-6s %-6s %4d %8d %8d %8d\n"</span>, <span class="variable">$1</span>, <span class="variable">$2</span>, <span class="variable">$3</span>,<span class="variable">$4</span>,<span class="variable">$5</span>, <span class="variable">$3</span>+<span class="variable">$4</span>+<span class="variable">$5</span></div><div class="line">&#125;</div><div class="line"><span class="comment">#运行后</span></div><div class="line">END &#123;</div><div class="line">    <span class="built_in">printf</span> <span class="string">"---------------------------------------------\n"</span></div><div class="line">    <span class="built_in">printf</span> <span class="string">"  TOTAL:%10d %8d %8d \n"</span>, math, english, computer</div><div class="line">    <span class="built_in">printf</span> <span class="string">"AVERAGE:%10.2f %8.2f %8.2f\n"</span>, math/NR, english/NR, computer/NR</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;执行结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># awk -f cal.awk score.txt</span></div><div class="line">NAME    NO.   MATH  ENGLISH  COMPUTER   TOTAL</div><div class="line">---------------------------------------------</div><div class="line">Marry  2143     78       84       77      239</div><div class="line">Jack   2321     66       78       45      189</div><div class="line">Tom    2122     48       77       71      196</div><div class="line">Mike   2537     87       97       95      279</div><div class="line">Bob    2415     40       57       62      159</div><div class="line">---------------------------------------------</div><div class="line">  TOTAL:       319      393      350 </div><div class="line">AVERAGE:     63.80    78.60    70.00</div></pre></td></tr></table></figure>
<h2 id="另外一些实例"><a href="#另外一些实例" class="headerlink" title="另外一些实例"></a>另外一些实例</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;awk 的 hello world 程序为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">BEGIN &#123;<span class="built_in">print</span> <span class="string">"Hello, world!"</span>&#125;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;计算文件大小</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># ls -l *.txt | awk '&#123;sum+=$6&#125; END &#123;print sum&#125;'</span></div><div class="line">30</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;从文件中找出长度大于80的行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'lenght&gt;80'</span> log.txt</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;打印九九乘法表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">seq 9 | sed <span class="string">'H;g'</span> | awk -v RS=<span class="string">''</span> <span class="string">'&#123;for(i=1;i&lt;=NF;i++)printf("%dx%d=%d%s", i, NR, i*NR, i==NR?"\n":"\t")&#125;'</span></div></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux命令/">Linux命令</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/正则表达式/">正则表达式</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-2. Linux 命令/48. Linux 命令- vmstat" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/2. Linux 命令/48. Linux 命令- vmstat/" class="article-date">
  	<time datetime="2017-09-02T17:57:34.304Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/2. Linux 命令/48. Linux 命令- vmstat/">
        Linux 命令- vmstat
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;vmstat是Virtual Meomory Statistics（虚拟内存统计）的缩写，可对操作系统的虚拟内存、进程、CPU活动进行监控。他是对系统的整体情况进行统计，不足之处是无法对某个进程进行深入分析。vmstat 工具提供了一种低开销的系统性能观察方式。因为 vmstat 本身就是低开销工具，在非常高负荷的服务器上，你需要查看并监控系统的健康情况,在控制窗口还是能够使用vmstat 输出结果。在学习vmstat命令前，我们先了解一下Linux系统中关于物理内存和虚拟内存相关信息。</p>
<h2 id="物理内存和虚拟内存区别："><a href="#物理内存和虚拟内存区别：" class="headerlink" title="物理内存和虚拟内存区别："></a>物理内存和虚拟内存区别：</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;我们知道，直接从物理内存读写数据要比从硬盘读写数据要快的多，因此，我们希望所有数据的读取和写入都在内存完成，而内存是有限的，这样就引出了物理内存与虚拟内存的概念。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;物理内存就是系统硬件提供的内存大小，是真正的内存，相对于物理内存，在linux下还有一个虚拟内存的概念，虚拟内存就是为了满足物理内存的不足而提出的策略，它是利用磁盘空间虚拟出的一块逻辑内存，用作虚拟内存的磁盘空间被称为交换空间（Swap Space）。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;作为物理内存的扩展，linux会在物理内存不足时，使用交换分区的虚拟内存，更详细的说，就是内核会将暂时不用的内存块信息写到交换空间，这样以来，物理内存得到了释放，这块内存就可以用于其它目的，当需要用到原始的内容时，这些信息会被重新从交换空间读入物理内存。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;linux的内存管理采取的是分页存取机制，为了保证物理内存能得到充分的利用，内核会在适当的时候将物理内存中不经常使用的数据块自动交换到虚拟内存中，而将经常使用的信息保留到物理内存。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;要深入了解linux内存运行机制，需要知道下面提到的几个方面：</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;首先，Linux系统会不时的进行页面交换操作，以保持尽可能多的空闲物理内存，即使并没有什么事情需要内存，Linux也会交换出暂时不用的内存页面。这可以避免等待交换所需的时间。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;其次，linux进行页面交换是有条件的，不是所有页面在不用时都交换到虚拟内存，linux内核根据”最近最经常使用“算法，仅仅将一些不经常使用的页面文件交换到虚拟内存，有时我们会看到这么一个现象：linux物理内存还有很多，但是交换空间也使用了很多。其实，这并不奇怪，例如，一个占用很大内存的进程运行时，需要耗费很多内存资源，此时就会有一些不常用页面文件被交换到虚拟内存中，但后来这个占用很多内存资源的进程结束并释放了很多内存时，刚才被交换出去的页面文件并不会自动的交换进物理内存，除非有这个必要，那么此刻系统物理内存就会空闲很多，同时交换空间也在被使用，就出现了刚才所说的现象了。关于这点，不用担心什么，只要知道是怎么一回事就可以了。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;最后，交换空间的页面在使用时会首先被交换到物理内存，如果此时没有足够的物理内存来容纳这些页面，它们又会被马上交换出去，如此以来，虚拟内存中可能没有足够空间来存储这些交换页面，最终会导致linux出现假死机、服务异常等问题，linux虽然可以在一段时间内自行恢复，但是恢复后的系统已经基本不可用了。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;因此，合理规划和设计linux内存的使用，是非常重要的。</p>
<h2 id="虚拟内存原理："><a href="#虚拟内存原理：" class="headerlink" title="虚拟内存原理："></a>虚拟内存原理：</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在系统中运行的每个进程都需要使用到内存，但不是每个进程都需要每时每刻使用系统分配的内存空间。当系统运行所需内存超过实际的物理内存，内核会释放某些进程所占用但未使用的部分或所有物理内存，将这部分资料存储在磁盘上直到进程下一次调用，并将释放出的内存提供给有需要的进程使用。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在Linux内存管理中，主要是通过“调页Paging”和“交换Swapping”来完成上述的内存调度。调页算法是将内存中最近不常使用的页面换到磁盘上，把活动页面保留在内存中供进程使用。交换技术是将整个进程，而不是部分页面，全部交换到磁盘上。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;分页(Page)写入磁盘的过程被称作Page-Out，分页(Page)从磁盘重新回到内存的过程被称作Page-In。当内核需要一个分页时，但发现此分页不在物理内存中(因为已经被Page-Out了)，此时就发生了分页错误（Page Fault）。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;当系统内核发现可运行内存变少时，就会通过Page-Out来释放一部分物理内存。经管Page-Out不是经常发生，但是如果Page-out频繁不断的发生，直到当内核管理分页的时间超过运行程式的时间时，系统效能会急剧下降。这时的系统已经运行非常慢或进入暂停状态，这种状态亦被称作thrashing(颠簸)。</p>
<h2 id="1．命令格式"><a href="#1．命令格式" class="headerlink" title="1．命令格式"></a>1．命令格式</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">vmstat [-a] [-n] [-S unit] [delay [ count]]</div><div class="line">vmstat [-s] [-n] [-S unit]</div><div class="line">vmstat [-m] [-n] [delay [ count]]</div><div class="line">vmstat [-d] [-n] [delay [ count]]</div><div class="line">vmstat [-p disk partition] [-n] [delay [ count]]</div><div class="line">vmstat [-f]</div><div class="line">vmstat [-V]</div></pre></td></tr></table></figure>
<h2 id="2．命令功能"><a href="#2．命令功能" class="headerlink" title="2．命令功能"></a>2．命令功能</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;用来显示虚拟内存的信息</p>
<h2 id="3．命令参数"><a href="#3．命令参数" class="headerlink" title="3．命令参数"></a>3．命令参数</h2><ul>
<li>-a：显示活跃和非活跃内存</li>
<li>-f：显示从系统启动至今的fork数量 。</li>
<li>-m：显示slabinfo</li>
<li>-n：只在开始时显示一次各字段名称。</li>
<li>-s：显示内存相关统计信息及多种系统活动数量。</li>
<li>delay：刷新时间间隔。如果不指定，只显示一条结果。</li>
<li>count：刷新次数。如果不指定刷新次数，但指定了刷新时间间隔，这时刷新次数为无穷。</li>
<li>-d：显示磁盘相关统计信息。</li>
<li>-p：显示指定磁盘分区统计信息</li>
<li>-S：使用指定单位显示。参数有 k 、K 、m 、M ，分别代表1000、1024、1000000、1048576字节（byte）。默认单位为K（1024 bytes）</li>
<li>-V：显示vmstat版本信息。</li>
</ul>
<h2 id="4．使用实例"><a href="#4．使用实例" class="headerlink" title="4．使用实例"></a>4．使用实例</h2><h3 id="实例1：显示虚拟内存使用情况"><a href="#实例1：显示虚拟内存使用情况" class="headerlink" title="实例1：显示虚拟内存使用情况"></a>实例1：显示虚拟内存使用情况</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vmstat</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>输出</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># vmstat 5 6</span></div><div class="line">procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu------</div><div class="line"> r  b   swpd   free   buff  cache   si   so    bi    bo   <span class="keyword">in</span>   cs us sy id wa st</div><div class="line"> 0  0      0 3029876 199616 690980    0    0     0     2    3    2  0  0 100  0  0</div><div class="line"> 0  0      0 3029752 199616 690980    0    0     0    41 1009   39  0  0 100  0  0</div><div class="line"> 0  0      0 3029752 199616 690980    0    0     0     3 1004   36  0  0 100  0  0</div><div class="line"> 0  0      0 3029752 199616 690980    0    0     0     4 1004   36  0  0 100  0  0</div><div class="line"> 0  0      0 3029752 199616 690980    0    0     0     6 1003   33  0  0 100  0  0</div><div class="line"> 0  0      0 3029752 199616 690980    0    0     0     5 1003   33  0  0 100  0  0</div></pre></td></tr></table></figure>
<h4 id="说明："><a href="#说明：" class="headerlink" title="说明："></a>说明：</h4><h5 id="字段说明："><a href="#字段说明：" class="headerlink" title="字段说明："></a>字段说明：</h5><h6 id="Procs（进程）："><a href="#Procs（进程）：" class="headerlink" title="Procs（进程）："></a>Procs（进程）：</h6><ul>
<li>r: 运行队列中进程数量</li>
<li>b: 等待IO的进程数量</li>
</ul>
<h6 id="Memory（内存）："><a href="#Memory（内存）：" class="headerlink" title="Memory（内存）："></a>Memory（内存）：</h6><ul>
<li>swpd: 使用虚拟内存大小</li>
<li>free: 可用内存大小</li>
<li>buff: 用作缓冲的内存大小</li>
<li>cache: 用作缓存的内存大小</li>
</ul>
<h6 id="Swap："><a href="#Swap：" class="headerlink" title="Swap："></a>Swap：</h6><ul>
<li>si: 每秒从交换区写到内存的大小</li>
<li>so: 每秒写入交换区的内存大小</li>
<li>IO：（现在的Linux版本块的大小为1024bytes）</li>
<li>bi: 每秒读取的块数</li>
<li>bo: 每秒写入的块数</li>
</ul>
<h6 id="系统："><a href="#系统：" class="headerlink" title="系统："></a>系统：</h6><ul>
<li>in: 每秒中断数，包括时钟中断。</li>
<li>cs: 每秒上下文切换数。</li>
</ul>
<h6 id="CPU（以百分比表示）："><a href="#CPU（以百分比表示）：" class="headerlink" title="CPU（以百分比表示）："></a>CPU（以百分比表示）：</h6><ul>
<li>us: 用户进程执行时间(user time)</li>
<li>sy: 系统进程执行时间(system time)</li>
<li>id: 空闲时间(包括IO等待时间),中央处理器的空闲时间 。以百分比表示。</li>
<li>wa: 等待IO时间</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;备注： 如果 r经常大于 4 ，且id经常少于40，表示cpu的负荷很重。如果bi，bo 长期不等于0，表示内存不足。如果disk 经常不等于0， 且在 b中的队列 大于3， 表示 io性能不好。Linux在具有高稳定性、可靠性的同时，具有很好的可伸缩性和扩展性，能够针对不同的应用和硬件环境调整，优化出满足当前应用需要的最佳性能。因此企业在维护Linux系统、进行系统调优时，了解系统性能分析工具是至关重要的。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vmstat 5 5</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;表示在5秒时间内进行5次采样。将得到一个数据汇总他能够反映真正的系统情况。</p>
<h3 id="实例2：显示活跃和非活跃内存"><a href="#实例2：显示活跃和非活跃内存" class="headerlink" title="实例2：显示活跃和非活跃内存"></a>实例2：显示活跃和非活跃内存</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vmstat -a 2 5</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>输出</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># vmstat -a 2 5</span></div><div class="line">procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu------</div><div class="line"> r  b   swpd   free  inact active   si   so    bi    bo   <span class="keyword">in</span>   cs us sy id wa st</div><div class="line"> 0  0      0 3029752 387728 513008    0    0     0     2    3    2  0  0 100  0  0</div><div class="line"> 0  0      0 3029752 387728 513076    0    0     0     0 1005   34  0  0 100  0  0</div><div class="line"> 0  0      0 3029752 387728 513076    0    0     0    22 1004   36  0  0 100  0  0</div><div class="line"> 0  0      0 3029752 387728 513076    0    0     0     0 1004   33  0  0 100  0  0</div><div class="line"> 0  0      0 3029752 387728 513076    0    0     0     0 1003   32  0  0 100  0  0</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;使用-a选项显示活跃和非活跃内存时，所显示的内容除增加inact和active外，其他显示内容与例子1相同。</p>
<h5 id="字段说明：-1"><a href="#字段说明：-1" class="headerlink" title="字段说明："></a>字段说明：</h5><h6 id="Memory（内存）：-1"><a href="#Memory（内存）：-1" class="headerlink" title="Memory（内存）："></a>Memory（内存）：</h6><ul>
<li>inact: 非活跃内存大小（当使用-a选项时显示）</li>
<li>active: 活跃的内存大小（当使用-a选项时显示）</li>
</ul>
<h3 id="实例3：查看系统已经fork了多少次"><a href="#实例3：查看系统已经fork了多少次" class="headerlink" title="实例3：查看系统已经fork了多少次"></a>实例3：查看系统已经fork了多少次</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vmstat -f</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>输出</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@SCF1129 ~]<span class="comment"># vmstat -f</span></div><div class="line">     12744849 forks</div><div class="line">[root@SCF1129 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="说明：-1"><a href="#说明：-1" class="headerlink" title="说明："></a>说明：</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这个数据是从/proc/stat中的processes字段里取得的</p>
<h3 id="实例4：查看内存使用的详细信息"><a href="#实例4：查看内存使用的详细信息" class="headerlink" title="实例4：查看内存使用的详细信息"></a>实例4：查看内存使用的详细信息</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vmstat -s</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>输出</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># vmstat -s</span></div><div class="line">      4043760  total memory</div><div class="line">      1013884  used memory</div><div class="line">       513012  active memory</div><div class="line">       387728  inactive memory</div><div class="line">      3029876  free memory</div><div class="line">       199616  buffer memory</div><div class="line">       690980  swap cache</div><div class="line">      6096656  total swap</div><div class="line">            0  used swap</div><div class="line">      6096656  free swap</div><div class="line">        83587 non-nice user cpu ticks</div><div class="line">          132 nice user cpu ticks</div><div class="line">       278599 system cpu ticks</div><div class="line">    913344692 idle cpu ticks</div><div class="line">       814550 IO-wait cpu ticks</div><div class="line">        10547 IRQ cpu ticks</div><div class="line">        21261 softirq cpu ticks</div><div class="line">            0 stolen cpu ticks</div><div class="line">       310215 pages paged <span class="keyword">in</span></div><div class="line">     14254652 pages paged out</div><div class="line">            0 pages swapped <span class="keyword">in</span></div><div class="line">            0 pages swapped out</div><div class="line">    288374745 interrupts</div><div class="line">    146680577 CPU context switches</div><div class="line">   1351868832 boot time</div><div class="line">       367291 forks</div></pre></td></tr></table></figure>
<h4 id="说明-1"><a href="#说明-1" class="headerlink" title="说明"></a>说明</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这些信息的分别来自于/proc/meminfo,/proc/stat和/proc/vmstat。</p>
<h3 id="实例5：查看磁盘的读-写"><a href="#实例5：查看磁盘的读-写" class="headerlink" title="实例5：查看磁盘的读/写"></a>实例5：查看磁盘的读/写</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vmstat -d</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>输出</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># vmstat -d</span></div><div class="line">disk- ------------reads------------ ------------writes----------- -----IO------</div><div class="line">       total merged sectors      ms  total merged sectors      ms    cur    sec</div><div class="line">ram0       0      0       0       0      0      0       0       0      0      0</div><div class="line">ram1       0      0       0       0      0      0       0       0      0      0</div><div class="line">ram2       0      0       0       0      0      0       0       0      0      0</div><div class="line">ram3       0      0       0       0      0      0       0       0      0      0</div><div class="line">ram4       0      0       0       0      0      0       0       0      0      0</div><div class="line">ram5       0      0       0       0      0      0       0       0      0      0</div><div class="line">ram6       0      0       0       0      0      0       0       0      0      0</div><div class="line">ram7       0      0       0       0      0      0       0       0      0      0</div><div class="line">ram8       0      0       0       0      0      0       0       0      0      0</div><div class="line">ram9       0      0       0       0      0      0       0       0      0      0</div><div class="line">ram10      0      0       0       0      0      0       0       0      0      0</div><div class="line">ram11      0      0       0       0      0      0       0       0      0      0</div><div class="line">ram12      0      0       0       0      0      0       0       0      0      0</div><div class="line">ram13      0      0       0       0      0      0       0       0      0      0</div><div class="line">ram14      0      0       0       0      0      0       0       0      0      0</div><div class="line">ram15      0      0       0       0      0      0       0       0      0      0</div><div class="line">sda    33381   6455  615407   63224 2068111 1495416 28508288 15990289      0  10491</div><div class="line">hdc        0      0       0       0      0      0       0       0      0      0</div><div class="line">fd0        0      0       0       0      0      0       0       0      0      0</div><div class="line">md0        0      0       0       0      0      0       0       0      0      0</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="说明-2"><a href="#说明-2" class="headerlink" title="说明"></a>说明</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这些信息主要来自于/proc/diskstats.</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;merged:表示一次来自于合并的写/读请求,一般系统会把多个连接/邻近的读/写请求合并到一起来操作.</p>
<h3 id="实例6：查看-dev-sda1磁盘的读-写"><a href="#实例6：查看-dev-sda1磁盘的读-写" class="headerlink" title="实例6：查看/dev/sda1磁盘的读/写"></a>实例6：查看/dev/sda1磁盘的读/写</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vmstat -p /dev/sda1</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>输出</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@SCF1129 ~]<span class="comment"># df</span></div><div class="line">文件系统                 1K-块      已用      可用 已用% 挂载点</div><div class="line">/dev/sda3            1119336548  27642068 1034835500   3% /tmpfs                 32978376         0  32978376   0% /dev/shm</div><div class="line">/dev/sda1              1032088     59604    920056   7% /boot</div><div class="line">[root@SCF1129 ~]<span class="comment"># vmstat -p /dev/sda1</span></div><div class="line">sda1          reads   <span class="built_in">read</span> sectors  writes    requested writes</div><div class="line">               18607    4249978          6         48[root@SCF1129 ~]<span class="comment"># vmstat -p /dev/sda3</span></div><div class="line">sda3          reads   <span class="built_in">read</span> sectors  writes    requested writes</div><div class="line">              429350   35176268   28998789  980301488[root@SCF1129 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h4 id="说明-3"><a href="#说明-3" class="headerlink" title="说明"></a>说明</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这些信息主要来自于/proc/diskstats。</p>
<ul>
<li>reads:来自于这个分区的读的次数。</li>
<li>read sectors:来自于这个分区的读扇区的次数。</li>
<li>writes:来自于这个分区的写的次数。</li>
<li>requested writes:来自于这个分区的写请求次数。</li>
</ul>
<h3 id="实例7：查看系统的slab信息"><a href="#实例7：查看系统的slab信息" class="headerlink" title="实例7：查看系统的slab信息"></a>实例7：查看系统的slab信息</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vmstat -m</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>输出</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># vmstat -m</span></div><div class="line">Cache                       Num  Total   Size  Pages</div><div class="line">ip_conntrack_expect           0      0    136     28</div><div class="line">ip_conntrack                  3     13    304     13</div><div class="line">ip_fib_alias                 11     59     64     59</div><div class="line">ip_fib_hash                  11     59     64     59</div><div class="line">AF_VMCI                       0      0    960      4</div><div class="line">bio_map_info                100    105   1064      7</div><div class="line">dm_mpath                      0      0   1064      7</div><div class="line">jbd_4k                        0      0   4096      1</div><div class="line">dm_uevent                     0      0   2608      3</div><div class="line">dm_tio                        0      0     24    144</div><div class="line">dm_io                         0      0     48     77</div><div class="line">scsi_cmd_cache               10     10    384     10</div><div class="line">sgpool-128                   32     32   4096      1</div><div class="line">sgpool-64                    32     32   2048      2</div><div class="line">sgpool-32                    32     32   1024      4</div><div class="line">sgpool-16                    32     32    512      8</div><div class="line">sgpool-8                     45     45    256     15</div><div class="line">scsi_io_context               0      0    112     34</div><div class="line">ext3_inode_cache          51080  51105    760      5</div><div class="line">ext3_xattr                   36     88     88     44</div><div class="line">journal_handle               18    144     24    144</div><div class="line">journal_head                 56     80     96     40</div><div class="line">revoke_table                  4    202     16    202</div><div class="line">revoke_record                 0      0     32    112</div><div class="line">uhci_urb_priv                 0      0     56     67</div><div class="line">UNIX                         13     33    704     11</div><div class="line">flow_cache                    0      0    128     30</div><div class="line">msi_cache                    33     59     64     59</div><div class="line">cfq_ioc_pool                 14     90    128     30</div><div class="line">cfq_pool                     12     90    216     18</div><div class="line">crq_pool                     16     96     80     48</div><div class="line">deadline_drq                  0      0     80     48</div><div class="line">as_arq                        0      0     96     40</div><div class="line">mqueue_inode_cache            1      4    896      4</div><div class="line">isofs_inode_cache             0      0    608      6</div><div class="line">hugetlbfs_inode_cache         1      7    576      7</div><div class="line">Cache                       Num  Total   Size  Pages</div><div class="line">ext2_inode_cache              0      0    720      5</div><div class="line">ext2_xattr                    0      0     88     44</div><div class="line">dnotify_cache                 0      0     40     92</div><div class="line">dquot                         0      0    256     15</div><div class="line">eventpoll_pwq                 3     53     72     53</div><div class="line">eventpoll_epi                 3     20    192     20</div><div class="line">inotify_event_cache           0      0     40     92</div><div class="line">inotify_watch_cache           1     53     72     53</div><div class="line">kioctx                        0      0    320     12</div><div class="line">kiocb                         0      0    256     15</div><div class="line">fasync_cache                  0      0     24    144</div><div class="line">shmem_inode_cache           254    290    768      5</div><div class="line">posix_timers_cache            0      0    128     30</div><div class="line">uid_cache                     0      0    128     30</div><div class="line">ip_mrt_cache                  0      0    128     30</div><div class="line">tcp_bind_bucket               3    112     32    112</div><div class="line">inet_peer_cache               0      0    128     30</div><div class="line">secpath_cache                 0      0     64     59</div><div class="line">xfrm_dst_cache                0      0    384     10</div><div class="line">ip_dst_cache                  5     10    384     10</div><div class="line">arp_cache                     1     15    256     15</div><div class="line">RAW                           3      5    768      5</div><div class="line">UDP                           5     10    768      5</div><div class="line">tw_sock_TCP                   0      0    192     20</div><div class="line">request_sock_TCP              0      0    128     30</div><div class="line">TCP                           4      5   1600      5</div><div class="line">blkdev_ioc                   14    118     64     59</div><div class="line">blkdev_queue                 20     30   1576      5</div><div class="line">blkdev_requests              13     42    272     14</div><div class="line">biovec-256                    7      7   4096      1</div><div class="line">biovec-128                    7      8   2048      2</div><div class="line">biovec-64                     7      8   1024      4</div><div class="line">biovec-16                     7     15    256     15</div><div class="line">biovec-4                      7     59     64     59</div><div class="line">biovec-1                     23    202     16    202</div><div class="line">bio                         270    270    128     30</div><div class="line">utrace_engine_cache           0      0     64     59</div><div class="line">Cache                       Num  Total   Size  Pages</div><div class="line">utrace_cache                  0      0     64     59</div><div class="line">sock_inode_cache             33     48    640      6</div><div class="line">skbuff_fclone_cache           7      7    512      7</div><div class="line">skbuff_head_cache           319    390    256     15</div><div class="line">file_lock_cache               1     22    176     22</div><div class="line">Acpi-Operand               4136   4248     64     59</div><div class="line">Acpi-ParseExt                 0      0     64     59</div><div class="line">Acpi-Parse                    0      0     40     92</div><div class="line">Acpi-State                    0      0     80     48</div><div class="line">Acpi-Namespace             2871   2912     32    112</div><div class="line">delayacct_cache              81    295     64     59</div><div class="line">taskstats_cache               4     53     72     53</div><div class="line">proc_inode_cache           1427   1440    592      6</div><div class="line">sigqueue                      0      0    160     24</div><div class="line">radix_tree_node           13166  13188    536      7</div><div class="line">bdev_cache                   23     24    832      4</div><div class="line">sysfs_dir_cache            5370   5412     88     44</div><div class="line">mnt_cache                    26     30    256     15</div><div class="line">inode_cache                2009   2009    560      7</div><div class="line">dentry_cache              60952  61020    216     18</div><div class="line">filp                        479   1305    256     15</div><div class="line">names_cache                   3      3   4096      1</div><div class="line">avc_node                     14     53     72     53</div><div class="line">selinux_inode_security      994   1200     80     48</div><div class="line">key_jar                       2     20    192     20</div><div class="line">idr_layer_cache              74     77    528      7</div><div class="line">buffer_head              164045 164800     96     40</div><div class="line">mm_struct                    51     56    896      4</div><div class="line">vm_area_struct             1142   1958    176     22</div><div class="line">fs_cache                     35    177     64     59</div><div class="line">files_cache                  36     55    768      5</div><div class="line">signal_cache                 72    162    832      9</div><div class="line">sighand_cache                68     84   2112      3</div><div class="line">task_struct                  76     80   1888      2</div><div class="line">anon_vma                    458    864     24    144</div><div class="line">pid                          83    295     64     59</div><div class="line">shared_policy_node            0      0     48     77</div><div class="line">Cache                       Num  Total   Size  Pages</div><div class="line">numa_policy                  37    144     24    144</div><div class="line">size-131072(DMA)              0      0 131072      1</div><div class="line">size-131072                   0      0 131072      1</div><div class="line">size-65536(DMA)               0      0  65536      1</div><div class="line">size-65536                    1      1  65536      1</div><div class="line">size-32768(DMA)               0      0  32768      1</div><div class="line">size-32768                    2      2  32768      1</div><div class="line">size-16384(DMA)               0      0  16384      1</div><div class="line">size-16384                    5      5  16384      1</div><div class="line">size-8192(DMA)                0      0   8192      1</div><div class="line">size-8192                     7      7   8192      1</div><div class="line">size-4096(DMA)                0      0   4096      1</div><div class="line">size-4096                   110    111   4096      1</div><div class="line">size-2048(DMA)                0      0   2048      2</div><div class="line">size-2048                   602    602   2048      2</div><div class="line">size-1024(DMA)                0      0   1024      4</div><div class="line">size-1024                   344    352   1024      4</div><div class="line">size-512(DMA)                 0      0    512      8</div><div class="line">size-512                    433    480    512      8</div><div class="line">size-256(DMA)                 0      0    256     15</div><div class="line">size-256                   1139   1155    256     15</div><div class="line">size-128(DMA)                 0      0    128     30</div><div class="line">size-64(DMA)                  0      0     64     59</div><div class="line">size-64                    5639   5782     64     59</div><div class="line">size-32(DMA)                  0      0     32    112</div><div class="line">size-128                    801    930    128     30</div><div class="line">size-32                    3005   3024     32    112</div><div class="line">kmem_cache                  137    137   2688      1</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这组信息来自于/proc/slabinfo。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;slab:由于内核会有许多小对象，这些对象构造销毁十分频繁，比如i-node，dentry，这些对象如果每次构建的时候就向内存要一个页(4kb)，而其实只有几个字节，这样就会非常浪费，为了解决这个问题，就引入了一种新的机制来处理在同一个页框中如何分配小存储区，而slab可以对小对象进行分配,这样就不用为每一个对象分配页框，从而节省了空间，内核对一些小对象创建析构很频繁，slab对这些小对象进行缓冲,可以重复利用,减少内存分配次数。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux命令/">Linux命令</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-2. Linux 命令/55. Linux 命令- route" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/2. Linux 命令/55. Linux 命令- route/" class="article-date">
  	<time datetime="2017-09-02T17:57:34.303Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/2. Linux 命令/55. Linux 命令- route/">
        Linux 命令- route
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Linux系统的route命令用于显示和操作IP路由表（show / manipulate the IP routing table）。要实现两个不同的子网之间的通信，需要一台连接两个网络的路由器，或者同时位于两个网络的网关来实现。在Linux系统中，设置路由通常是为了解决以下问题：该Linux系统在一个局域网中，局域网中有一个网关，能够让机器访问Internet，那么就需要将这台机器的IP地址设置为Linux机器的默认路由。要注意的是，直接在命令行下执行route命令来添加路由，不会永久保存，当网卡重启或者机器重启之后，该路由就失效了；可以在/etc/rc.local中添加route命令来保证该路由设置永久有效。</p>
<h2 id="1．命令格式"><a href="#1．命令格式" class="headerlink" title="1．命令格式"></a>1．命令格式</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">route [-f] [-p] [Command [Destination] [mask Netmask] [Gateway] [metric Metric]] [<span class="keyword">if</span> Interface]]</div></pre></td></tr></table></figure>
<h2 id="2．命令功能"><a href="#2．命令功能" class="headerlink" title="2．命令功能"></a>2．命令功能</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Route命令是用于操作基于内核ip路由表，它的主要作用是创建一个静态路由让指定一个主机或者一个网络通过一个网络接口，如eth0。当使用”add”或者”del”参数时，路由表被修改，如果没有参数，则显示路由表当前的内容。</p>
<h2 id="3．命令参数"><a href="#3．命令参数" class="headerlink" title="3．命令参数"></a>3．命令参数</h2><ul>
<li>-c 显示更多信息</li>
<li>-n 不解析名字</li>
<li>-v 显示详细的处理信息</li>
<li>-F 显示发送信息</li>
<li>-C 显示路由缓存</li>
<li>-f 清除所有网关入口的路由表。 </li>
<li><p>-p 与 add 命令一起使用时使路由具有永久性。</p>
</li>
<li><p>add:添加一条新路由。</p>
</li>
<li>del:删除一条路由。</li>
<li>-net:目标地址是一个网络。</li>
<li>-host:目标地址是一个主机。</li>
<li>netmask:当添加一个网络路由时，需要使用网络掩码。</li>
<li>gw:路由数据包通过网关。注意，你指定的网关必须能够达到。</li>
<li>metric：设置路由跳数。</li>
<li>Command 指定您想运行的命令 (Add/Change/Delete/Print)。 </li>
<li>Destination 指定该路由的网络目标。 </li>
<li>mask Netmask 指定与网络目标相关的网络掩码（也被称作子网掩码）。 </li>
<li>Gateway 指定网络目标定义的地址集和子网掩码可以到达的前进或下一跃点 IP 地址。 </li>
<li>metric Metric 为路由指定一个整数成本值标（从 1 至 9999），当在路由表(与转发的数据包目标地址最匹配)的多个路由中进行选择时可以使用。 </li>
<li>if Interface 为可以访问目标的接口指定接口索引。若要获得一个接口列表和它们相应的接口索引，使用 route print 命令的显示功能。可以使用十进制或十六进制值进行接口索引。</li>
</ul>
<h2 id="4．使用实例"><a href="#4．使用实例" class="headerlink" title="4．使用实例"></a>4．使用实例</h2><h3 id="实例1：显示当前路由"><a href="#实例1：显示当前路由" class="headerlink" title="实例1：显示当前路由"></a>实例1：显示当前路由</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">route</div><div class="line">route -n</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>输出</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># route</span></div><div class="line">Kernel IP routing table</div><div class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</div><div class="line">192.168.120.0   *               255.255.255.0   U     0      0        0 eth0</div><div class="line">e192.168.0.0     192.168.120.1   255.255.0.0     UG    0      0        0 eth0</div><div class="line">10.0.0.0        192.168.120.1   255.0.0.0       UG    0      0        0 eth0</div><div class="line">default         192.168.120.240 0.0.0.0         UG    0      0        0 eth0</div><div class="line">[root@localhost ~]<span class="comment"># route -n</span></div><div class="line">Kernel IP routing table</div><div class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</div><div class="line">192.168.120.0   0.0.0.0         255.255.255.0   U     0      0        0 eth0</div><div class="line">192.168.0.0     192.168.120.1   255.255.0.0     UG    0      0        0 eth0</div><div class="line">10.0.0.0        192.168.120.1   255.0.0.0       UG    0      0        0 eth0</div><div class="line">0.0.0.0         192.168.120.240 0.0.0.0         UG    0      0        0 eth0</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>说明</strong></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;第一行表示主机所在网络的地址为192.168.120.0，若数据传送目标是在本局域网内通信，则可直接通过eth0转发数据包;</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;第四行表示数据传送目的是访问Internet，则由接口eth0，将数据包发送到网关192.168.120.240 </p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;其中Flags为路由标志，标记当前网络节点的状态。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>Flags标志说明：</strong></p>
<ul>
<li>U Up表示此路由当前为启动状态</li>
<li>H Host，表示此网关为一主机</li>
<li>G Gateway，表示此网关为一路由器</li>
<li>R Reinstate Route，使用动态路由重新初始化的路由</li>
<li>D Dynamically,此路由是动态性地写入</li>
<li>M Modified，此路由是由路由守护程序或导向器动态修改</li>
<li>! 表示此路由当前为关闭状态</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;备注：</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;route -n (-n 表示不解析名字,列出速度会比route 快)</p>
<h3 id="实例2：添加网关-设置网关"><a href="#实例2：添加网关-设置网关" class="headerlink" title="实例2：添加网关/设置网关"></a>实例2：添加网关/设置网关</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">route add -net 224.0.0.0 netmask 240.0.0.0 dev eth0</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>输出</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># route add -net 224.0.0.0 netmask 240.0.0.0 dev eth0</span></div><div class="line">[root@localhost ~]<span class="comment"># route</span></div><div class="line">Kernel IP routing table</div><div class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</div><div class="line">192.168.120.0   *               255.255.255.0   U     0      0        0 eth0</div><div class="line">192.168.0.0     192.168.120.1   255.255.0.0     UG    0      0        0 eth0</div><div class="line">10.0.0.0        192.168.120.1   255.0.0.0       UG    0      0        0 eth0</div><div class="line">224.0.0.0       *               240.0.0.0       U     0      0        0 eth0</div><div class="line">default         192.168.120.240 0.0.0.0         UG    0      0        0 eth0</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>说明</strong></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;增加一条 到达244.0.0.0的路由</p>
<h3 id="实例3：屏蔽一条路由"><a href="#实例3：屏蔽一条路由" class="headerlink" title="实例3：屏蔽一条路由"></a>实例3：屏蔽一条路由</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">route add -net 224.0.0.0 netmask 240.0.0.0 reject</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>输出</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># route add -net 224.0.0.0 netmask 240.0.0.0 reject</span></div><div class="line">[root@localhost ~]<span class="comment"># route</span></div><div class="line">Kernel IP routing table</div><div class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</div><div class="line">192.168.120.0   *               255.255.255.0   U     0      0        0 eth0</div><div class="line">192.168.0.0     192.168.120.1   255.255.0.0     UG    0      0        0 eth0</div><div class="line">10.0.0.0        192.168.120.1   255.0.0.0       UG    0      0        0 eth0</div><div class="line">224.0.0.0       -               240.0.0.0       !     0      -        0 -</div><div class="line">224.0.0.0       *               240.0.0.0       U     0      0        0 eth0</div><div class="line">default         192.168.120.240 0.0.0.0         UG    0      0        0 eth0</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>说明</strong></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;增加一条屏蔽的路由，目的地址为 224.x.x.x 将被拒绝</p>
<h3 id="实例4：删除路由记录"><a href="#实例4：删除路由记录" class="headerlink" title="实例4：删除路由记录"></a>实例4：删除路由记录</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">route del -net 224.0.0.0 netmask 240.0.0.0</div><div class="line">route del -net 224.0.0.0 netmask 240.0.0.0 reject</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>输出</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># route</span></div><div class="line">Kernel IP routing table</div><div class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</div><div class="line">192.168.120.0   *               255.255.255.0   U     0      0        0 eth0</div><div class="line">192.168.0.0     192.168.120.1   255.255.0.0     UG    0      0        0 eth0</div><div class="line">10.0.0.0        192.168.120.1   255.0.0.0       UG    0      0        0 eth0</div><div class="line">224.0.0.0       -               240.0.0.0       !     0      -        0 -</div><div class="line">224.0.0.0       *               240.0.0.0       U     0      0        0 eth0</div><div class="line">default         192.168.120.240 0.0.0.0         UG    0      0        0 eth0</div><div class="line">[root@localhost ~]<span class="comment"># route del -net 224.0.0.0 netmask 240.0.0.0</span></div><div class="line">[root@localhost ~]<span class="comment"># route</span></div><div class="line">Kernel IP routing table</div><div class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</div><div class="line">192.168.120.0   *               255.255.255.0   U     0      0        0 eth0</div><div class="line">192.168.0.0     192.168.120.1   255.255.0.0     UG    0      0        0 eth0</div><div class="line">10.0.0.0        192.168.120.1   255.0.0.0       UG    0      0        0 eth0</div><div class="line">224.0.0.0       -               240.0.0.0       !     0      -        0 -</div><div class="line">default         192.168.120.240 0.0.0.0         UG    0      0        0 eth0</div><div class="line">[root@localhost ~]<span class="comment"># route del -net 224.0.0.0 netmask 240.0.0.0 reject</span></div><div class="line">[root@localhost ~]<span class="comment"># route</span></div><div class="line">Kernel IP routing table</div><div class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</div><div class="line">192.168.120.0   *               255.255.255.0   U     0      0        0 eth0</div><div class="line">192.168.0.0     192.168.120.1   255.255.0.0     UG    0      0        0 eth0</div><div class="line">10.0.0.0        192.168.120.1   255.0.0.0       UG    0      0        0 eth0</div><div class="line">default         192.168.120.240 0.0.0.0         UG    0      0        0 eth0</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h3 id="实例5：删除和添加设置默认网关"><a href="#实例5：删除和添加设置默认网关" class="headerlink" title="实例5：删除和添加设置默认网关"></a>实例5：删除和添加设置默认网关</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">route del default gw 192.168.120.240</div><div class="line">route add default gw 192.168.120.240</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>输出</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># route del default gw 192.168.120.240</span></div><div class="line">[root@localhost ~]<span class="comment"># route</span></div><div class="line">Kernel IP routing table</div><div class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</div><div class="line">192.168.120.0   *               255.255.255.0   U     0      0        0 eth0</div><div class="line">192.168.0.0     192.168.120.1   255.255.0.0     UG    0      0        0 eth0</div><div class="line">10.0.0.0        192.168.120.1   255.0.0.0       UG    0      0        0 eth0</div><div class="line">[root@localhost ~]<span class="comment"># route add default gw 192.168.120.240</span></div><div class="line">[root@localhost ~]<span class="comment"># route</span></div><div class="line">Kernel IP routing table</div><div class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</div><div class="line">192.168.120.0   *               255.255.255.0   U     0      0        0 eth0</div><div class="line">192.168.0.0     192.168.120.1   255.255.0.0     UG    0      0        0 eth0</div><div class="line">10.0.0.0        192.168.120.1   255.0.0.0       UG    0      0        0 eth0</div><div class="line">default         192.168.120.240 0.0.0.0         UG    0      0        0 eth0</div><div class="line">[root@localhost ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux命令/">Linux命令</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/40/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/39/">39</a><a class="page-number" href="/page/40/">40</a><span class="page-number current">41</span><a class="page-number" href="/page/42/">42</a><a class="page-number" href="/page/43/">43</a><span class="space">&hellip;</span><a class="page-number" href="/page/63/">63</a><a class="extend next" rel="next" href="/page/42/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2017 失落的乐章
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/smackgg/hexo-theme-smackdown" target="_blank">Smackdown</a>
        </div>
    </div>
  </div>
</footer>
    </div>
    

<script>
	var yiliaConfig = {
		fancybox: ,
		mathjax: ,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="/js/main.js"></script>



  </div>
</body>
</html>