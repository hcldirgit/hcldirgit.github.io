<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>失落的乐章</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="失落的乐章的Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="失落的乐章">
<meta property="og:url" content="https://hcldirgit.github.io/page/31/index.html">
<meta property="og:site_name" content="失落的乐章">
<meta property="og:description" content="失落的乐章的Blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="失落的乐章">
<meta name="twitter:description" content="失落的乐章的Blog">
  
    <link rel="alternative" href="/atom.xml" title="失落的乐章" type="application/atom+xml">
  
  
    <link rel="icon" href="https://hcldirgit.github.io/images/0.png">
  
  <link rel="stylesheet" href="/css/style.css">
  
  
<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-85415703-1', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  <script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>
  <script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>

  
</head>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://hcldirgit.github.io/images/0.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">失落的乐章</a></h1>
		</hgroup>

		
		<p class="header-subtitle">技术面前，永远都是学生。</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Ansible/" style="font-size: 10.42px;">Ansible</a> <a href="/tags/Apache/" style="font-size: 18.33px;">Apache</a> <a href="/tags/Cacti/" style="font-size: 11.67px;">Cacti</a> <a href="/tags/DNS/" style="font-size: 13.33px;">DNS</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/FTP/" style="font-size: 11.25px;">FTP</a> <a href="/tags/Git/" style="font-size: 10.83px;">Git</a> <a href="/tags/HA集群/" style="font-size: 11.67px;">HA集群</a> <a href="/tags/Hadoop/" style="font-size: 12.5px;">Hadoop</a> <a href="/tags/Jenkins/" style="font-size: 10.42px;">Jenkins</a> <a href="/tags/LAMP/" style="font-size: 19.58px;">LAMP</a> <a href="/tags/LNMP/" style="font-size: 17.08px;">LNMP</a> <a href="/tags/LVS/" style="font-size: 16.67px;">LVS</a> <a href="/tags/Linux/" style="font-size: 19.17px;">Linux</a> <a href="/tags/Linux命令/" style="font-size: 20px;">Linux命令</a> <a href="/tags/Linux安全/" style="font-size: 14.17px;">Linux安全</a> <a href="/tags/Memcached/" style="font-size: 11.25px;">Memcached</a> <a href="/tags/MongoDB/" style="font-size: 15.42px;">MongoDB</a> <a href="/tags/MySQL/" style="font-size: 17.5px;">MySQL</a> <a href="/tags/NFS/" style="font-size: 10px;">NFS</a> <a href="/tags/Nagios/" style="font-size: 11.67px;">Nagios</a> <a href="/tags/Nginx/" style="font-size: 17.92px;">Nginx</a> <a href="/tags/OpenStack/" style="font-size: 11.25px;">OpenStack</a> <a href="/tags/Php/" style="font-size: 14.58px;">Php</a> <a href="/tags/Puppet/" style="font-size: 11.25px;">Puppet</a> <a href="/tags/Python/" style="font-size: 14.58px;">Python</a> <a href="/tags/Redis/" style="font-size: 16.25px;">Redis</a> <a href="/tags/Resin/" style="font-size: 10px;">Resin</a> <a href="/tags/Saltstack/" style="font-size: 10px;">Saltstack</a> <a href="/tags/Samba/" style="font-size: 12.08px;">Samba</a> <a href="/tags/Squid/" style="font-size: 14.58px;">Squid</a> <a href="/tags/Tomcat/" style="font-size: 13.75px;">Tomcat</a> <a href="/tags/Zabbix/" style="font-size: 15.83px;">Zabbix</a> <a href="/tags/haproxy/" style="font-size: 12.5px;">haproxy</a> <a href="/tags/keepalived/" style="font-size: 12.92px;">keepalived</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/shell练习/" style="font-size: 18.75px;">shell练习</a> <a href="/tags/正则表达式/" style="font-size: 12.92px;">正则表达式</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">失落的乐章</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="https://hcldirgit.github.io/images/0.png" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">失落的乐章</h1>
			</hgroup>
			
			<p class="header-subtitle">技术面前，永远都是学生。</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-HA集群/2. heartbeat 配置文件详解" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/HA集群/2. heartbeat 配置文件详解/" class="article-date">
  	<time datetime="2017-09-02T18:04:46.005Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/HA集群/2. heartbeat 配置文件详解/">
        heartbeat 部署过程
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-配置ha-cf"><a href="#1-配置ha-cf" class="headerlink" title="1 配置ha.cf"></a>1 配置ha.cf</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;第一个是ha.cf该文件位于在安装后创建的/etc/ha.d目录中。该文件中包括为Heartbeat使用何种介质通路和如何配置他们的信息。在源代码目录中的ha.cf文件包含了您可以使用的全部选项，详述如下：</p>
<h3 id="serial-dev-ttyS0"><a href="#serial-dev-ttyS0" class="headerlink" title="serial /dev/ttyS0"></a>serial /dev/ttyS0</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;使用串口heartbeat－如果不使用串口heartbeat，则必须使用其他的介质，如bcast（以太网）heartbeat。用适当的设备文件代替/dev/ttyS0。</p>
<h3 id="watchdog-dev-watchdog"><a href="#watchdog-dev-watchdog" class="headerlink" title="watchdog /dev/watchdog"></a>watchdog /dev/watchdog</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;该选项是可选配置。通过Watchdog 功能可以获得提供最少功能的系统，该系统不提供heartbeat，可以在持续一份钟的不正常状态后重新启动。该功能有助于避免一台机器在被认定已经死亡之后恢复heartbeat的情况。如果这种情况发生并且磁盘挂载因故障而迁移（fail over），便有可能有两个节点同时挂载一块磁盘。如果要使用这项功能，则除了这行之外，也需要加载“softdog”内核模块，并创建相应的设备文件。方法是使用命令“insmod softdog”加载模块。然后输入“grep misc /proc/devices”并记住得到的数字（应该是10）。然后输入”cat /proc/misc | grep watchdog”并记住输出的数字（应该是130）。根据以上得到的信息可以创建设备文件，“mknod /dev/watchdog c 10 130”。</p>
<h3 id="bcast-eth1"><a href="#bcast-eth1" class="headerlink" title="bcast eth1"></a>bcast eth1</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;表示在eth1接口上使用广播heartbeat（将eth1替换为eth0，eth2，或者您使用的任何接口）。</p>
<h3 id="mcast-eth1-225-0-0-1-694-1-0"><a href="#mcast-eth1-225-0-0-1-694-1-0" class="headerlink" title="mcast eth1 225.0.0.1 694 1 0"></a>mcast eth1 225.0.0.1 694 1 0</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;如果采用组播通讯，在这里可以设置组播通讯所使用的接口，绑定的组播ip地址（在224.0.0.0-239.255.255.255之间），通讯端口，ttl(time to live)所能经过路由的跳数，是否允许回环（也就是本地发出的数据包是否还接收）。</p>
<h3 id="ucast-eth1-10-0-0-1"><a href="#ucast-eth1-10-0-0-1" class="headerlink" title="ucast eth1 10.0.0.1"></a>ucast eth1 10.0.0.1</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;如果采用单播，可以配置其网络接口及其所使用的ip地址。</p>
<h3 id="keepalive-2"><a href="#keepalive-2" class="headerlink" title="keepalive 2"></a>keepalive 2</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;设定heartbeat之间的时间间隔为2秒。</p>
<h3 id="warntime-10"><a href="#warntime-10" class="headerlink" title="warntime 10"></a>warntime 10</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在日志中发出“late heartbeat“警告之前等待的时间，单位为秒。</p>
<h3 id="deadtime-30"><a href="#deadtime-30" class="headerlink" title="deadtime 30"></a>deadtime 30</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在30秒后宣布节点死亡。</p>
<h3 id="initdead-120"><a href="#initdead-120" class="headerlink" title="initdead 120"></a>initdead 120</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在某些配置下，重启后网络需要一些时间才能正常工作。这个单独的”deadtime”选项可以处理这种情况。它的取值至少应该为通常deadtime的两倍。</p>
<h3 id="baud-19200"><a href="#baud-19200" class="headerlink" title="baud 19200"></a>baud 19200</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;波特率，串口通信的速度。</p>
<h3 id="udpport-694"><a href="#udpport-694" class="headerlink" title="udpport 694"></a>udpport 694</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;使用端口694进行bcast和ucast通信。这是默认的，并且在IANA官方注册的端口号。</p>
<h3 id="auto-failback-on"><a href="#auto-failback-on" class="headerlink" title="auto_failback on"></a>auto_failback on</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;该选项是必须配置的。对于那些熟悉Tru64 Unix的人来说，heartbeat的工作方式类似于“favored member“模式。在failover之前，haresources文件中列出的主节点掌握所有的资源，之后从节点接管这些资源。当auto_failback设置为on时，一旦主节点重新恢复联机，将从从节点取回所有资源。若该选项设置为off，主节点便不能重新获得资源。该选项与废弃的nice_failback选项类似。如果要从一个nice_failback设置为off的集群升级到这个或更新的版本，需要特别注意一些事项以防止flash cut。请参阅FAQ中关于如何处理这类情况的章节。</p>
<h3 id="node-primary-mydomain-com"><a href="#node-primary-mydomain-com" class="headerlink" title="node primary.mydomain.com"></a>node primary.mydomain.com</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;该选项是必须配置的。集群中机器的主机名，与“uname –n”的输出相同。</p>
<h3 id="node-backup-mydomain-com"><a href="#node-backup-mydomain-com" class="headerlink" title="node backup.mydomain.com"></a>node backup.mydomain.com</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;该选项是必须配置的。同上。</p>
<h3 id="respawn"><a href="#respawn" class="headerlink" title="respawn"></a>respawn</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;该选项是可选配置的：列出将要执行和监控的命令。例如：要执行ccm守护进程，则要添加如下的内容：</p>
<h3 id="respawn-hacluster-usr-lib-heartbeat-ccm"><a href="#respawn-hacluster-usr-lib-heartbeat-ccm" class="headerlink" title="respawn hacluster /usr/lib/heartbeat/ccm"></a>respawn hacluster /usr/lib/heartbeat/ccm</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;使得Heartbeat以userid（在本例中为hacluster）的身份来执行该进程并监视该进程的执行情况，如果其死亡便重启之。对于ipfail，则应该是：</p>
<h3 id="respawn-hacluster-usr-lib-heartbeat-ipfail"><a href="#respawn-hacluster-usr-lib-heartbeat-ipfail" class="headerlink" title="respawn hacluster /usr/lib/heartbeat/ipfail"></a>respawn hacluster /usr/lib/heartbeat/ipfail</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;对于pingd则应该是：</p>
<h3 id="respawn-hacluster-usr-lib64-heartbeat-pingd-m-100-d-5s"><a href="#respawn-hacluster-usr-lib64-heartbeat-pingd-m-100-d-5s" class="headerlink" title="respawn hacluster /usr/lib64/heartbeat/pingd -m 100 -d 5s"></a>respawn hacluster /usr/lib64/heartbeat/pingd -m 100 -d 5s</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注意：如果结束进程的退出代码为100，则不会重启该进程。</p>
<h3 id="apiauth-pingd-gid-haclient-uid-hacluster"><a href="#apiauth-pingd-gid-haclient-uid-hacluster" class="headerlink" title="apiauth pingd gid=haclient uid=hacluster"></a>apiauth pingd gid=haclient uid=hacluster</h3><h2 id="2-配置haresources"><a href="#2-配置haresources" class="headerlink" title="2 配置haresources"></a>2 配置haresources</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;配置好ha.cf文件之后，便是haresources文件。该文件列出集群所提供的服务以及服务的默认所有者。 注意：两个集群节点上的该文件必须相同。集群的IP地址是该选项是必须配置的，不能在haresources文件以外配置该地址, haresources文件用于指定双机系统的主节点、集群IP、子网掩码、广播地址以及启动的服务等。其配置语句格式如下：</p>
<p>node-name network-config</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;其中node-name指定双机系统的主节点，取值必须匹配ha.cf文件中node选项设置的主机名中的一个，node选项设置的另一个主机名成为从节点。network-config用于网络设置，包括指定集群IP、子网掩码、广播地址等。resource-group用于设置heartbeat启动的服务，该服务最终由双机系统通过集群IP对外提供。在本文中我们假设要配置的HA服务为Apache和Samba。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在haresources文件中需要如下内容：</p>
<p>primary.mydomain.com 192.168.85.3 httpd smb</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;该行指定在启动时，节点linuxha1得到IP地址192.168.85.3，并启动Apache和Samba。在停止时，Heartbeat将首先停止smb，然后停止Apache，最后释放IP地址192.168.85.3。这里假设命令“uname –n”的输出为“primary.mydomain.com”－如果输出为“primary”，便应使用“primary”。</p>
<p>primary.mydomain.com IPaddr::192.168.21.107/24/eth0 drbddisk::r0 Filesystem::/dev/drbd1::/data::ext4 nfs</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;正确配置好haresources文件之后，将ha.cf和haresource拷贝到/etc/ha.d目录。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注意：资源文件中能执行的命令必须在/etc/ha.d/resource.d/ 中可见</p>
<h2 id="3-配置Authkeys"><a href="#3-配置Authkeys" class="headerlink" title="3 配置Authkeys"></a>3 配置Authkeys</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;需要配置的第三个文件authkeys决定了您的认证密钥。共有三种认证方式：crc，md5，和sha1。您可能会问：“我应该用哪个方法呢？”简而言之： 如果您的Heartbeat运行于安全网络之上，如本例中的交叉线，可以使用crc，从资源的角度来看，这是代价最低的方法。如果网络并不安全，但您也希望降低CPU使用，则使用md5。最后，如果您想得到最好的认证，而不考虑CPU使用情况，则使用sha1，它在三者之中最难破解。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;文件格式如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">auth []</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;因此，对于sha1，示例的/etc/ha.d/authkeys可能是</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">auth 1</div><div class="line">1 sha1 key-for-sha1-any-text-you-want</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;对于md5，只要将上面内容中的sha1换成md5就可以了。 对于crc，可作如下配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">auth 2</div><div class="line">2 crc</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;不论您在关键字auth后面指定的是什么索引值，在后面必须要作为键值再次出现。如果您指定“auth 4”，则在后面一定要有一行的内容为“4 ”。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;确保该文件的访问权限是安全的，如600。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HA集群/">HA集群</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-HA集群/1. HA 集群配置" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/HA集群/1. HA 集群配置/" class="article-date">
  	<time datetime="2017-09-02T18:04:46.004Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/HA集群/1. HA 集群配置/">
        HA 集群配置
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;HA 即 （high available）高可用，又被叫做双机热备，用于关键性业务。 简单理解就是，有两台机器A和B，正常是A提供服务，B待命闲置，当A宕机或服务宕掉，会切换至B机器继续提供服务。常用实现高可用的开源软件有heartbeat和keepalived，其中keepalived有负载均衡的功能。</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/heartbeat%E9%83%A8%E7%BD%B2%E8%BF%87%E7%A8%8B/01.jpeg?raw=true" alt="images"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;如图所示为一个 HA 结构，一个交换机下面有两台机器 web1 和 web2 ，其中 web1 为主节点，正常是它在提供服务，而 web2 备用节点是闲置的。 web1 和 web2 中间有一根心跳线，检查对方的存活状态。流动 IP ，也叫 vip 是对外提供服务的 ip ，正常情况下，是配置在 web1 上的，当 web1 宕机后， web2 会自动配置该 vip ，对外提供服务。</p>
<h2 id="heartbeat-部署"><a href="#heartbeat-部署" class="headerlink" title="heartbeat 部署"></a>heartbeat 部署</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;下面使用 heartbeat 来做 HA 集群，并且把 nginx 服务作为 HA 对应的服务</p>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;两台机器，都是 centos6.5，网卡 eth0 ip 地址为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">master 192.168.0.69</div><div class="line">slave 192.168.0.68</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;eth1 ip 地址为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">master 192.168.91.100</div><div class="line">slave 192.168.91.101</div></pre></td></tr></table></figure>
<h4 id="1-hostname-设置好，分别为-master-和-slave"><a href="#1-hostname-设置好，分别为-master-和-slave" class="headerlink" title="1. hostname 设置好，分别为 master 和 slave"></a>1. hostname 设置好，分别为 master 和 slave</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;主上设置 hostname</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@HA1 ~]<span class="comment"># hostname master</span></div><div class="line">[root@HA1 ~]<span class="comment"># bash</span></div><div class="line">[root@master ~]<span class="comment"># vim /etc/sysconfig/network</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">NETWORKING=yes</div><div class="line">HOSTNAME=master</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;从上设置 hostname</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@HA2 ~]<span class="comment"># hostname slave</span></div><div class="line">[root@HA2 ~]<span class="comment"># bash</span></div><div class="line">[root@slave ~]<span class="comment"># vim /etc/sysconfig/network</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">NETWORKING=yes</div><div class="line">HOSTNAME=master</div></pre></td></tr></table></figure>
<h4 id="2-关闭防火墙"><a href="#2-关闭防火墙" class="headerlink" title="2.关闭防火墙"></a>2.关闭防火墙</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;主和从上都操作</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -F</div><div class="line">service iptables save</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;主和从都关闭 selinux</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">setenforce 0</div><div class="line">sed -i <span class="string">'s/SELINUX=enforcing/SELINUX=disabled/'</span> /etc/selinux/config</div></pre></td></tr></table></figure>
<h4 id="3-配置-hosts"><a href="#3-配置-hosts" class="headerlink" title="3.配置 hosts"></a>3.配置 hosts</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;主和从都编辑</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vim /etc/hosts</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;增加内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">192.168.0.69 master</div><div class="line">192.168.0.68 slave</div></pre></td></tr></table></figure>
<h4 id="4-安装-epel-扩展源"><a href="#4-安装-epel-扩展源" class="headerlink" title="4.安装 epel 扩展源"></a>4.安装 epel 扩展源</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;主和从都执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y epel-release</div></pre></td></tr></table></figure>
<h4 id="5-安装-heartbeat"><a href="#5-安装-heartbeat" class="headerlink" title="5.安装 heartbeat"></a>5.安装 heartbeat</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;主和从都执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y heartbeat* libnet nginx</div></pre></td></tr></table></figure>
<h4 id="6-主上（master）配置"><a href="#6-主上（master）配置" class="headerlink" title="6.主上（master）配置"></a>6.主上（master）配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># cd /usr/share/doc/heartbeat-3.0.4/</span></div><div class="line">[root@master heartbeat-3.0.4]<span class="comment"># cp authkeys ha.cf haresources /etc/ha.d</span></div><div class="line">[root@master heartbeat-3.0.4]<span class="comment"># cd /etc/ha.d</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后编辑</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master ha.d]<span class="comment"># vim authkeys</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;更改</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#auth 1</span></div><div class="line"><span class="comment">#1 crc</span></div><div class="line"><span class="comment">#2 shal HI!</span></div><div class="line"><span class="comment">#3 md5 Hello!</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#auth 3</span></div><div class="line"><span class="comment">#1 crc</span></div><div class="line"><span class="comment">#2 shal HI!</span></div><div class="line">3 md5 Hello!</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这是用来验证的 crc 最简单， shal 最复杂。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后修改权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master ha.d]<span class="comment"># chmod 600 authkeys</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;编辑 haresources 文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master ha.d]<span class="comment"># vim haresources</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">#nodel 10.0.0.170 Filesystem::/dev/sda1::data1:;ext2</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#</span></div><div class="line">master 192.168.0.70/24/eth0:0 nginx</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明：master 为主节点 hostname ，192.168.0.70 为 vip ，/24 为24网段，eth0:0 为 vip 的设备名，nginx 为 heartbeat 监控的服务，也是两台机器对外提供的核心服务。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后编辑 ha.cf</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;清空 ha.cf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master ha.d]<span class="comment"># &gt;ha.cf</span></div><div class="line">[root@master ha.d]<span class="comment"># vim ha.cf</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;增加内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">debugfile /var/<span class="built_in">log</span>/ha-debug</div><div class="line">logfile /var/<span class="built_in">log</span>/ha-log</div><div class="line">logfacility local0</div><div class="line">keepalive 2</div><div class="line">deadtime 30</div><div class="line">warntime 10</div><div class="line">initdead 60</div><div class="line">udpport 694</div><div class="line">ucast eth1 192.168.91.101</div><div class="line">auto_failback on</div><div class="line">node master</div><div class="line">node slave</div><div class="line">ping 192.168.91.1</div><div class="line">respawn hacluster /usr/lib64/heartbeat/ipfail</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;配置说明：</p>
<ul>
<li><code>debugfile /var/log/ha-debug</code>：该文件保存 heartbeat 的调试信息;</li>
<li><code>logfile /var/log/ha-log</code>：heartbeat 的日志文件；</li>
<li><code>keepalive 2</code>：心跳的时间间隔，默认时间单位为秒；</li>
<li><code>deadtime 30</code>：超出该时间间隔未收到对方节点的心跳，则认为对方已经死亡；</li>
<li><code>warntime 10</code>：超出该时间间隔未收到对方节点的心跳，则发出警告并记录到日志中；</li>
<li><code>initdead 60</code>：在某些系统上，系统启动或重启之后需要经过一段时间网络才能正常工作，该选项用于解决这种情况产生的时间间隔。取值至少为 deadtime 的两倍；</li>
<li><code>udpport 694</code>：设置广播通信使用的端口， 694 为默认使用的端口；</li>
<li><code>ucast eth1 192.168.91.101</code>：设置为对方机器心跳检测的网卡和 ip；</li>
<li><code>auto_failback on</code>：heartbeat 的两台机器分别为主节点和从节点。主节点在正常情况下占用资源并运行所有的服务，遇到故障时把资源交给从节点并由从节点运行服务。在该选项为 on 的情况下，一旦主节点恢复运行，则自动获取资源并取代从节点，负责不取代从节点；</li>
<li><code>node</code>： 指定主和从，各占一行，主在上从在下；</li>
<li><code>respawn hacluster /usr/lib/heartbeat/ipfail</code>：指定与 heartbeat 一同启动和关闭的进程，该进程被自动监视，遇到故障则重新启动。最常用的进程是 ipfail ，该进程用于检测和处理网络故障，需要配合 ping 语句指定的 ping node 来检测网络连接。如果系统是64，注意该文件的路径<code>/usr/lib64/heartbeat/ipfail</code>。</li>
</ul>
<h4 id="7-把主上的三个配置文件拷贝到从上"><a href="#7-把主上的三个配置文件拷贝到从上" class="headerlink" title="7.把主上的三个配置文件拷贝到从上"></a>7.把主上的三个配置文件拷贝到从上</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># cd /etc/ha.d/</span></div><div class="line">[root@master ha.d]<span class="comment"># scp authkeys ha.cf haresources slave:/etc/ha.d/</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;scp 命令安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum -y install openssh-clients</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;如果提示错误，主从都安装</p>
<h4 id="8-从上（slave）编辑-ha-cf"><a href="#8-从上（slave）编辑-ha-cf" class="headerlink" title="8.从上（slave）编辑 ha.cf"></a>8.从上（slave）编辑 ha.cf</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@slave ~]<span class="comment"># vim /etc/ha.d/ha.cf</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;ucast eth1 192.168.91.101 修改为 ucast eth1 192.168.91.100</p>
<h4 id="9-启动-heartbeat"><a href="#9-启动-heartbeat" class="headerlink" title="9.启动 heartbeat"></a>9.启动 heartbeat</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;先主，后从</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># service heartbeat start</span></div></pre></td></tr></table></figure>
<h4 id="10-检查测试"><a href="#10-检查测试" class="headerlink" title="10.检查测试"></a>10.检查测试</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;主执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># ifconfig</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;看是否有 eth0:0</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/heartbeat%E9%83%A8%E7%BD%B2%E8%BF%87%E7%A8%8B/02.png?raw=true" alt="images"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># ps aux | grep nginx</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;看是否有 nginx 进程</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/heartbeat%E9%83%A8%E7%BD%B2%E8%BF%87%E7%A8%8B/03.png?raw=true" alt="images"></p>
<h4 id="11-测试1"><a href="#11-测试1" class="headerlink" title="11.测试1"></a>11.测试1</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;主上故意禁 ping </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># iptables -I INPUT -p icmp -j DROP</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;从上执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@slave ~]<span class="comment"># ifconfig</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;看是否有 eth0:0</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/heartbeat%E9%83%A8%E7%BD%B2%E8%BF%87%E7%A8%8B/04.png?raw=true" alt="images"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@slave ~]<span class="comment"># ps aux | grep nginx</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;看是否有 nginx 进程</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/heartbeat%E9%83%A8%E7%BD%B2%E8%BF%87%E7%A8%8B/05.png?raw=true" alt="images"></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;主上执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># iptables -D INPUT -p icmp -j DROP</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;主上恢复 eth0:0 和 nginx，从上停止 eth0:0 和 nginx 服务</p>
<h4 id="12-测试2"><a href="#12-测试2" class="headerlink" title="12.测试2"></a>12.测试2</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;主上停止 heartbeat 服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># service heartbeat stop</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;从上会启动 eth0:0 和 nginx 服务</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;主上开启 heartbeat 服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@master ~]<span class="comment"># service heartbeat start</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;主上恢复 eth0:0 和 nginx 服务，从上停止 eth0:0 和 nginx 服务</p>
<h4 id="13-测试脑裂"><a href="#13-测试脑裂" class="headerlink" title="13.测试脑裂"></a>13.测试脑裂</h4><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;主和从上都 down 掉 eth1 网卡</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ifdown eth1</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;主和从都会启动 eth0:0 网卡和 nginx 服务</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HA集群/">HA集群</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Haproxy/5. haproxy 基础配置文件详解" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Haproxy/5. haproxy 基础配置文件详解/" class="article-date">
  	<time datetime="2017-09-02T18:04:46.002Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Haproxy/5. haproxy 基础配置文件详解/">
        haproxy 基础配置文件详解
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="https://github.com/hcldirgit/image/blob/master/haproxy%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/01.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>HAproxy可以实现基于TCP（四层 例如:SSH,SMTP,MYSQL）和HTTP（七层 例如:web服务器）应用的代理软件，同时也可以作为负载均衡器使用，并且是开源完全免费的。HAproxy完全可以支持数以万计的并发链接，它的工作模式可以将其简单而安全地整合到当前的服务架构中，同时可以保护你的WEB服务器不暴露到网络上（设置成代理来实现的 通过VIP将后端的web服务器隐藏到内网中）。</strong></p>
<h2 id="HAProxy有以下几个优点"><a href="#HAProxy有以下几个优点" class="headerlink" title="HAProxy有以下几个优点"></a>HAProxy有以下几个优点</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;1、免费开源，稳定性也非常好，其稳定性可以与硬件级别的F5 BIG-IP相媲美。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;2、负载带宽非常大。根据官方文档可知，HAproxy可以跑满10Gbps的带宽，对于软件级负载均衡器来说，是相当惊人的。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;3、支持链接拒绝。因为保护一个链接保持打开状态的开销是很低的，有时我们需要防止蠕虫攻击，也就是通过限制它们的连接打开来防止它们的危害，可以用于防止DDoS攻击，这也是其他负载均衡器所不具备的。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;4、支持全透明代理（已具备硬件防火墙的典型特点）。可以用客户端IP地址或任何其他地址来链接后端服务器，这个特性仅在Linux 2.4/2.6 内核打了cttproxy补丁后才可以使用。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;5、支持TCP层（四层）的负载均衡。HAproxy现在多用于线上的MySQL集群环境，常用它作为MySQL（读）负载均衡，不过在后端的MySQL Slaves数量超过10台时性能不如LVS，所以更推荐推荐LVS+Keepalived。<strong>一般情况下都是前端通过LVS做四层负载 HAProxy做后端web服务器的负载 这样性能会比单独用HAProxy高很多</strong></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;6、强大的监控服务。自带强大的监控服务器状态的页面，在生产环境中可结合Nagios来实现邮件或短信报警。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;7、能支持多种的负载均衡算法，现在为止可以支持8种</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;8、支持虚拟主机。</p>
<h2 id="haproxy-的配置文件（haproxy-conf）详解"><a href="#haproxy-的配置文件（haproxy-conf）详解" class="headerlink" title="haproxy 的配置文件（haproxy.conf）详解"></a>haproxy 的配置文件（haproxy.conf）详解</h2><h3 id="1-global"><a href="#1-global" class="headerlink" title="1.global"></a>1.global</h3><ul>
<li>local0日志设备，info日志级别，日志界别有：err warning  info  debug  4种。这个配置表示使用127.0.0.1上的rsyslog服务中的local0日志设备</li>
<li>maxconn 20480   最大并发数</li>
<li>daemon  后台模式</li>
<li>nbproc：进程数</li>
<li>user：需要些用户名</li>
<li>gid：需要写数字</li>
<li>pidfile：pid文件、</li>
</ul>
<h3 id="2-defaults"><a href="#2-defaults" class="headerlink" title="2.defaults"></a>2.defaults</h3><ul>
<li>mode：http    tcp模式，http模式和health模式（健康检查已经废弃）</li>
<li>retries：3   设置后端服务器的失败重试次数，如果连接失败的次数超过这里设置的值，haproxy就会对后端服务器标记不可用，也可以在后面进行设置</li>
<li>timeout connect 10s 设置成功连接到一台服务器的最长等待时间，默认单位是毫秒，也可以使用其他单位换算</li>
<li>timeout client 20s   设置成功连接客户端发动数据时最长等待时间，………………</li>
<li>imeout server 30s     设置服务器端回应客户端数据发送的最长等待时间…………</li>
<li>timeout check 5s      设置对后端服务器的检测超时时间，…………</li>
</ul>
<h3 id="3-frontend"><a href="#3-frontend" class="headerlink" title="3.frontend"></a>3.frontend</h3><ul>
<li>frontend关键字定义了一个名字为www的前端虚拟节点</li>
<li>bind格式：bind [<address>:<port>]  interface <interface>    interface可选项，用来指定网络接口的名称，只在linux上使用</interface></port></address></li>
<li>option httplog        默认情况下，haproxy日志是不记录http请求的，这样不方便haproxy的排错和监控，此项启动日志记录http请求</li>
<li>option forwardfor     后端服务器需要获得客户端的真实ip，就需要配置此参数</li>
<li>option httpclose:           此项表示客户端和服务器端完成一次连接请求后，haproxy将主动关闭tcp连接。这是对性能非常有帮助的参数</li>
<li>log global：     表示使用全局的日志配置，</li>
<li>default_backend：    指定默认的后端服务器池，也就是指一组后端真是服务器，而真是服务器组将在backend段定义。这里的htmpool就是一个后端服务器组。</li>
</ul>
<h3 id="4-backend"><a href="#4-backend" class="headerlink" title="4.backend"></a>4.backend</h3><ul>
<li>backend关键字定义了一个名为htmpool的后端真是服务器组。</li>
<li>mode  http   http模式</li>
<li>option  redispatch：此参数用于cookie保持的环境中。在默认的环境下，HAProxy会将其请求的后端服务器的serverID插入到cookie中，以保证会话的session持久性。而如果后端的服务器出现故障，客户端的cookie是不会刷新的，这就会出现问题。此时如果设置此参数，将会将客户端的请求强制定向到另外一台监控的后端服务器上，一保证服务器的正常。</li>
<li>option abortonclose：如果设置此参数，在服务器负载很高的情况下，自动结束当前队列处理时间比较长的连接</li>
<li>balance：此关键字用来定义负载均衡算法：常用的算法有：<ul>
<li>1.roundrobin：基于权重轮训    </li>
<li>2.static-rr：静态权重轮训，运行时调整其服务器权重不会生效</li>
<li>3.source：ip算法，ip_hash，同一个客户端的请求转发在特定的后端服务器上</li>
<li>4.leastconn：此算法会将新的连接请求转发到最少连接数目的后端服务器，在回话时间较长的环境中使用，比如：数据库负载均衡等，不适合会话短的环境</li>
<li>5.uri：此算法会对部分或者整个URL进行hash运算，在经过与服务器的总权重相除，最后转发到某台匹配的后端服务器上</li>
<li>6.uri_param：此算法会根据URL路劲中的参数进行转发，这样可保证在后端真是服务器数量不变时，同一个用户的请求始终分发到一台机器上</li>
<li>7.hdr：此算法根据http头进行转发，如果指定的http头名称不存在，则使用roundrobin算法进行策略转发。</li>
</ul>
</li>
<li>cookie：表示允许向cookie插入SERVERID，每台服务器的SERVERID可在下面的server关键字中使用cookie关键字定义</li>
<li>option httpchk：此选项表示启用http的服务状态监测功能。haproxy作为一个专业的负载均衡器，他支持对backend部分指定的后端服务器节点的健康检查，以保证在后端backend中某个节点不能服务时，吧从frotend段进来的客户端请求分配至backend中其他健康节点上，从而保证整理服务的可用性。option httpchk具体用法如下：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">option httpchk &lt;mothod&gt; &lt;uri&gt; &lt;version&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;method:常用的请求的方法：OPTIONS, GET,HEAD，一般用head方式，head仅检查response的head是不是状态码200，head相对get更快，更简单<br>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;uri：表示要检测的url地址，200为正常，其他都为错误<br>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;version：指定心跳检测时的http版本号    </p>
<ul>
<li>server：定义后端真实服务器，不能用于default和frontend部分，使用格式：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">server	&lt;name&gt;		&lt;address&gt;[:port]  [param*]</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;参数含义：</p>
<ul>
<li><p><name>：后端服务器指定一个内部名称，随便写</name></p>
</li>
<li><p>[param*]：常用参数：</p>
</li>
<li><p>check：表示启用对此后端服务器执行健康检查</p>
</li>
<li><p>inter：设置健康状态检查的时间间隔，单位毫秒</p>
</li>
<li><p>rise：社会中重故障状态转换正常状态的次数</p>
</li>
<li><p>fall：设置后端服务器从正常状态转换至不可用状态的检查次数：</p>
</li>
<li><p>cookie：指定后端服务器设定的cookie值。</p>
</li>
<li><p>weight：权重，值1-256，0代表不参与负载均衡</p>
</li>
<li><p>backup：设置后端服务器的备份服务器，仅仅在后端所有真是服务器均不可用的情况下次啊启用</p>
</li>
</ul>
<h3 id="5-listen"><a href="#5-listen" class="headerlink" title="5.listen"></a>5.listen</h3><ul>
<li>listen关键字定义了一个admin_stats的实例，</li>
<li>stats refresh：设置haproxy监控统计页面自动刷新的时间。</li>
<li>stats uri：设置haproxy监控统计页面的URL路劲，通过ip：port/haproxy-status查看，路劲自己随意设置</li>
<li>stats realm：设置登录haproxy统计页面的密码框上的文本信息</li>
<li>stats auth：设置登录haproxy统计页面的用户名和密码。可以设置多个，设置多行</li>
<li>stats hide-version：用来隐藏统计页面上haproxy的版本信息</li>
<li>stats admin if TURE：在1.4.9版本以后，可以在监控页面上手工启动或者禁用后端服务器</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/haproxy/">haproxy</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Haproxy/6. 源码编译安装 haproxy" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Haproxy/6. 源码编译安装 haproxy/" class="article-date">
  	<time datetime="2017-09-02T18:04:46.002Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Haproxy/6. 源码编译安装 haproxy/">
        haproxy 源码编译安装
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># cd /usr/local/src</span></div><div class="line">[root@localhost src]<span class="comment"># wget http://www.haproxy.org/download/1.4/src/haproxy-1.4.25.tar.gz</span></div><div class="line">[root@localhost src]<span class="comment"># yum -y install cmake  gcc gcc-c++  autoconf automake zlib*  libxml* \  </span></div><div class="line">ncurses ncurses-devel libtool-ltdl-devel* make  bison bison-devel libaio   </div><div class="line">[root@localhost src]<span class="comment"># tar zxvf haproxy-1.4.25.tar.gz   </span></div><div class="line">[root@localhost src]<span class="comment"># cd haproxy-1.4.25  </span></div><div class="line">[root@localhost haproxy-1.4.25]<span class="comment">#</span></div></pre></td></tr></table></figure>
<h2 id="开始编译安装"><a href="#开始编译安装" class="headerlink" title="开始编译安装"></a>开始编译安装</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;MAKE 参数参考文件中的 README 文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@localhost haproxy-1.4.25]<span class="comment"># make TARGET=linux26 PREFIX=/usr/local/haproxy  </span></div><div class="line">[root@localhost haproxy-1.4.25]<span class="comment"># make install PREFIX=/usr/local/haproxy  </span></div><div class="line">[root@localhost haproxy-1.4.25]<span class="comment"># install -d /usr/local/sbin  </span></div><div class="line">[root@localhost haproxy-1.4.25]<span class="comment"># install haproxy /usr/local/sbin  </span></div><div class="line">[root@localhost haproxy-1.4.25]<span class="comment"># install -d /usr/local/share/man/man1  </span></div><div class="line">[root@localhost haproxy-1.4.25]<span class="comment"># install -m 644 doc/haproxy.1 /usr/local/share/man/man1  </span></div><div class="line">[root@localhost haproxy-1.4.25]<span class="comment"># install -d /usr/local/doc/haproxy  </span></div><div class="line">[root@localhost haproxy-1.4.25]<span class="comment"># for x in configuration architecture haproxy-en haproxy-fr; do \  </span></div><div class="line">&gt; install -m 644 doc/<span class="variable">$x</span>.txt /usr/<span class="built_in">local</span>/doc/haproxy ; \  </div><div class="line">&gt; <span class="keyword">done</span>  </div><div class="line">[root@localhost haproxy-1.4.25]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;安装完成，检测是否安装成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@localhost haproxy-1.4.25]<span class="comment"># haproxy -v  </span></div><div class="line">HA-Proxy version 1.4.25 2014/03/27  </div><div class="line">Copyright 2000-2014 Willy Tarreau &lt;w@1wt.eu&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;则安装成功</p>
<h2 id="配置-haproxy-cfg-文件"><a href="#配置-haproxy-cfg-文件" class="headerlink" title="配置 haproxy.cfg 文件"></a>配置 haproxy.cfg 文件</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;用的 /root/haproxy-1.4.25/examples/haproxy.cfg   这个是自带的配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line">[root@localhost examples]<span class="comment"># vim haproxy.cfg  </span></div><div class="line">  </div><div class="line"><span class="comment"># this config needs haproxy-1.1.28 or haproxy-1.2.1  </span></div><div class="line">  </div><div class="line">global  </div><div class="line">        <span class="built_in">log</span> 127.0.0.1   local0  </div><div class="line">        <span class="built_in">log</span> 127.0.0.1   local1 notice  </div><div class="line">        <span class="comment">#log loghost    local0 info  </span></div><div class="line">        maxconn 4096  </div><div class="line"><span class="comment">#       chroot /usr/share/haproxy  </span></div><div class="line">        chroot  /usr/<span class="built_in">local</span>/haproxy  </div><div class="line">        uid 99  </div><div class="line">        gid 99  </div><div class="line">        daemon  </div><div class="line">        <span class="comment">#debug  </span></div><div class="line">        <span class="comment">#quiet  </span></div><div class="line">  </div><div class="line">defaults  </div><div class="line">        <span class="built_in">log</span>     global  </div><div class="line">        mode    http  </div><div class="line">        option  httplog  </div><div class="line">        option  dontlognull  </div><div class="line">        retries 3  </div><div class="line">        <span class="comment">#redispatch  </span></div><div class="line">        maxconn 2000  </div><div class="line">        contimeout      5000  </div><div class="line">        clitimeout      50000  </div><div class="line">        srvtimeout      50000  </div><div class="line"><span class="comment">#============================这一段是后面加上去的。 就是WEB代理  </span></div><div class="line">listen web_proxy  </div><div class="line">        <span class="built_in">bind</span> *:80  </div><div class="line">        mode    http  </div><div class="line">        option httpchk GET /index.html  </div><div class="line">        server s1 192.168.11.210:80 weight 3 check  </div><div class="line">        server s2 192.168.11.211:80 weight 3 check  </div><div class="line"><span class="comment">#后面的我做的注释  </span></div><div class="line"><span class="comment">#listen appli1-rewrite 0.0.0.0:10001  </span></div><div class="line"><span class="comment">#       cookie  SERVERID rewrite  </span></div><div class="line"><span class="comment">#       balance roundrobin  </span></div><div class="line"><span class="comment">#       server  app1_1 192.168.34.23:8080 cookie app1inst1 check inter 2000 rise 2 fall 5  </span></div><div class="line"><span class="comment">#       server  app1_2 192.168.34.32:8080 cookie app1inst2 check inter 2000 rise 2 fall 5  </span></div><div class="line"><span class="comment">#       server  app1_3 192.168.34.27:8080 cookie app1inst3 check inter 2000 rise 2 fall 5  </span></div><div class="line"><span class="comment">#       server  app1_4 192.168.34.42:8080 cookie app1inst4 check inter 2000 rise 2 fall 5  </span></div><div class="line"><span class="comment">#  </span></div><div class="line"><span class="comment">#listen appli2-insert 0.0.0.0:10002  </span></div><div class="line"><span class="comment">#       option  httpchk  </span></div><div class="line"><span class="comment">#       balance roundrobin  </span></div><div class="line"><span class="comment">#       cookie  SERVERID insert indirect nocache  </span></div><div class="line"><span class="comment">#       server  inst1 192.168.114.56:80 cookie server01 check inter 2000 fall 3  </span></div><div class="line"><span class="comment">#       server  inst2 192.168.114.56:81 cookie server02 check inter 2000 fall 3  </span></div><div class="line"><span class="comment">#       capture cookie vgnvisitor= len 32  </span></div><div class="line"><span class="comment">#  </span></div><div class="line"><span class="comment">#       option  httpclose               # disable keep-alive  </span></div><div class="line"><span class="comment">#       rspidel ^Set-cookie:\ IP=       # do not let this cookie tell our internal IP address  </span></div><div class="line"><span class="comment">#         </span></div><div class="line"><span class="comment">#listen appli3-relais 0.0.0.0:10003  </span></div><div class="line"><span class="comment">#       dispatch 192.168.135.17:80  </span></div><div class="line"><span class="comment">#  </span></div><div class="line"><span class="comment">#listen appli4-backup 0.0.0.0:10004  </span></div><div class="line"><span class="comment">#       option  httpchk /index.html  </span></div><div class="line"><span class="comment">#       option  persist  </span></div><div class="line"><span class="comment">#       balance roundrobin  </span></div><div class="line"><span class="comment">#       server  inst1 192.168.114.56:80 check inter 2000 fall 3  </span></div><div class="line"><span class="comment">#       server  inst2 192.168.114.56:81 check inter 2000 fall 3 backup  </span></div><div class="line"><span class="comment">#  </span></div><div class="line"><span class="comment">#listen ssl-relay 0.0.0.0:8443  </span></div><div class="line"><span class="comment">#       option  ssl-hello-chk  </span></div><div class="line"><span class="comment">#       balance source  </span></div><div class="line"><span class="comment">#       server  inst1 192.168.110.56:443 check inter 2000 fall 3  </span></div><div class="line"><span class="comment">#       server  inst2 192.168.110.57:443 check inter 2000 fall 3  </span></div><div class="line"><span class="comment">#       server  back1 192.168.120.58:443 backup  </span></div><div class="line"><span class="comment">#listen appli5-backup 0.0.0.0:10005  </span></div><div class="line"><span class="comment">#       option  httpchk *  </span></div><div class="line"><span class="comment">#       balance roundrobin  </span></div><div class="line"><span class="comment">#       cookie  SERVERID insert indirect nocache  </span></div><div class="line"><span class="comment">#       server  inst1 192.168.114.56:80 cookie server01 check inter 2000 fall 3  </span></div><div class="line"><span class="comment">#       server  inst2 192.168.114.56:81 cookie server02 check inter 2000 fall 3  </span></div><div class="line"><span class="comment">#       server  inst3 192.168.114.57:80 backup check inter 2000 fall 3  </span></div><div class="line"><span class="comment">#       capture cookie ASPSESSION len 32  </span></div><div class="line"><span class="comment">#       srvtimeout      20000  </span></div><div class="line"><span class="comment">#       option  httpclose               # disable keep-alive  </span></div><div class="line"><span class="comment">#       option  checkcache              # block response if set-cookie &amp; cacheable  </span></div><div class="line"><span class="comment">#       rspidel ^Set-cookie:\ IP=       # do not let this cookie tell our internal IP address  </span></div><div class="line"><span class="comment">#       errorloc        502     http://192.168.114.58/error502.html  </span></div><div class="line"><span class="comment">#       errorfile       503     /etc/haproxy/errors/503.http</span></div></pre></td></tr></table></figure>
<h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@localhost examples]<span class="comment"># haproxy -f /root/haproxy-1.4.25/examples/haproxy.cfg   </span></div><div class="line">[WARNING] 316/220055 (2376) : parsing [/root/haproxy-1.4.25/examples/haproxy.cfg:22]: keyword <span class="string">'redispatch'</span> is deprecated, please use <span class="string">'option redispatch'</span> instead.  </div><div class="line">[ALERT] 316/220055 (2376) : [haproxy.main()] Cannot chroot(/usr/<span class="built_in">local</span>/sbin/haproxy).</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;出现的报错信息，下面我们来解决问题。因为上面配置文件是我改后的，应该没有什么问题。<br>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<code>[ALERT] 316/220055 (2376) : [haproxy.main()] Cannot chroot(/usr/local/sbin/haproxy).</code></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<code>是配置文件chroot的目录不对，根据我的文档安装改成 chroot /urs/local/haproxy 就可以解决了</code>  执行 mkdir /usr/share/haproxy</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<code>[WARNING] 316/220055 (2376) : parsing [/root/haproxy-1.4.25/examples/haproxy.cfg:22]: keyword &#39;redispatch&#39; is deprecated, please use &#39;option redispatch&#39; instead.</code></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<code>这个报错信息是配置文件22行的问题， 我是做了注释掉就可以起动服务了。   注释到相对应的错误行</code></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;再次起动服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@localhost examples]<span class="comment"># haproxy -f /root/haproxy-1.4.25/examples/haproxy.cfg   </span></div><div class="line">[root@localhost examples]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;没有任何提示，那我们检测一下是否启动成功</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;看一下进程信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@localhost examples]<span class="comment"># ps -ef |grep haproxy  </span></div><div class="line">nobody    3826     1  0 22:38 ?        00:00:00 haproxy -f /root/haproxy-1.4.25/examples/haproxy.cfg  </div><div class="line">root      3837  1260  0 22:38 pts/0    00:00:00 grep haproxy</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;进程已经在</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;看一下端口信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@localhost examples]<span class="comment"># netstat -anp |grep haproxy  </span></div><div class="line">tcp        0      0 0.0.0.0:80                  0.0.0.0:*                   LISTEN      3826/haproxy          </div><div class="line">udp        0      0 0.0.0.0:43549               0.0.0.0:*                               3826/haproxy</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;把配置文件移动到/etc目录下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@localhost examples]<span class="comment"># cd /etc/  </span></div><div class="line">[root@localhost etc]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;复制haproxy配置文件到/etc/目录下面  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost etc]<span class="comment"># cp /root/haproxy-1.4.25/examples/haproxy.cfg haproxy.cfg</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;再一次查看进程 kill掉。 在用/etc/haproxy.cfg的配置文件启动看看  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[root@localhost etc]<span class="comment"># ps -ef | grep haproxy  </span></div><div class="line">nobody    3826     1  0 22:38 ?        00:00:00 haproxy -f /root/haproxy-1.4.25/examples/haproxy.cfg  </div><div class="line">root      3901  1260  0 22:40 pts/0    00:00:00 grep haproxy  </div><div class="line">[root@localhost etc]<span class="comment"># kill 3826  </span></div><div class="line">[root@localhost etc]<span class="comment"># ps -ef | grep haproxy  </span></div><div class="line">root      3928  1260  0 22:41 pts/0    00:00:00 grep haproxy  </div><div class="line">```  </div><div class="line"></div><div class="line">&amp;<span class="comment">#160;&amp;#160;&amp;#160;&amp;#160;&amp;#160;&amp;#160;&amp;#160;&amp;#160;已经kill掉进程，进程已经没有在运行了， 我们现在用/etc/haproxy.cfg 来运行服务  </span></div><div class="line"></div><div class="line">```bash</div><div class="line">[root@localhost etc]<span class="comment"># haproxy -f /etc/haproxy.cfg  </span></div><div class="line">[root@localhost etc]<span class="comment"># ps -ef |grep haproxy.cfg  </span></div><div class="line">nobody    3959     1  0 22:42 ?        00:00:00 haproxy -f /etc/haproxy.cfg  </div><div class="line">root      3965  1260  0 22:43 pts/0    00:00:00 grep haproxy.cfg</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;已经看到运行成功</p>
<h2 id="设置以服务形式启动"><a href="#设置以服务形式启动" class="headerlink" title="设置以服务形式启动"></a>设置以服务形式启动</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;目录切换到/etc/init.d</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div></pre></td><td class="code"><pre><div class="line">[root@localhost etc]<span class="comment"># cd /etc/init.d/  </span></div><div class="line">[root@localhost init.d]<span class="comment"># vi haproxy  </span></div><div class="line">  </div><div class="line"><span class="meta">#!/bin/bash  </span></div><div class="line">    <span class="comment">#  </span></div><div class="line">    <span class="comment"># haproxy  </span></div><div class="line">    <span class="comment">#  </span></div><div class="line">    <span class="comment"># chkconfig: 35 85 15  </span></div><div class="line">    <span class="comment"># description: HAProxy is a free, very fast and reliable solution \  </span></div><div class="line">    <span class="comment"># offering high availability, load balancing, and \  </span></div><div class="line">    <span class="comment"># proxying for TCP and HTTP-based applications  </span></div><div class="line">    <span class="comment"># processname: haproxy  </span></div><div class="line">    <span class="comment"># config: /etc/haproxy.cfg  </span></div><div class="line">    <span class="comment"># pidfile: /var/run/haproxy.pid  </span></div><div class="line">    <span class="comment"># Source function library.  </span></div><div class="line">    . /etc/rc.d/init.d/<span class="built_in">functions</span>  </div><div class="line">    <span class="comment"># Source networking configuration.  </span></div><div class="line">    . /etc/sysconfig/network  </div><div class="line">    <span class="comment"># Check that networking is up.  </span></div><div class="line">    [ <span class="string">"<span class="variable">$NETWORKING</span>"</span> = <span class="string">"no"</span> ] &amp;&amp; <span class="built_in">exit</span> 0  </div><div class="line">    config=<span class="string">"/etc/haproxy.cfg"</span>  </div><div class="line">    <span class="built_in">exec</span>=<span class="string">"/usr/local/haproxy/sbin/haproxy"</span>  </div><div class="line">    prog=$(basename <span class="variable">$exec</span>)  </div><div class="line">    [ -e /etc/sysconfig/<span class="variable">$prog</span> ] &amp;&amp; . /etc/sysconfig/<span class="variable">$prog</span>  </div><div class="line">    lockfile=/var/lock/subsys/haproxy  </div><div class="line">    <span class="function"><span class="title">check</span></span>() &#123;  </div><div class="line">        <span class="variable">$exec</span> -c -V -f <span class="variable">$config</span>  </div><div class="line">    &#125;  </div><div class="line">    <span class="function"><span class="title">start</span></span>() &#123;  </div><div class="line">        <span class="variable">$exec</span> -c -q -f <span class="variable">$config</span>  </div><div class="line">        <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span>  </div><div class="line">            <span class="built_in">echo</span> <span class="string">"Errors in configuration file, check with <span class="variable">$prog</span> check."</span>  </div><div class="line">            <span class="built_in">return</span> 1  </div><div class="line">        <span class="keyword">fi</span>  </div><div class="line">        <span class="built_in">echo</span> -n $<span class="string">"Starting <span class="variable">$prog</span>: "</span>  </div><div class="line">        <span class="comment"># start it up here, usually something like "daemon $exec"  </span></div><div class="line">        daemon <span class="variable">$exec</span> -D -f <span class="variable">$config</span> -p /var/run/<span class="variable">$prog</span>.pid  </div><div class="line">        retval=$?  </div><div class="line">        <span class="built_in">echo</span>  </div><div class="line">        [ <span class="variable">$retval</span> -eq 0 ] &amp;&amp; touch <span class="variable">$lockfile</span>  </div><div class="line">        <span class="built_in">return</span> <span class="variable">$retval</span>  </div><div class="line">    &#125;  </div><div class="line">    <span class="function"><span class="title">stop</span></span>() &#123;  </div><div class="line">        <span class="built_in">echo</span> -n $<span class="string">"Stopping <span class="variable">$prog</span>: "</span>  </div><div class="line">        <span class="comment"># stop it here, often "killproc $prog"  </span></div><div class="line">        killproc <span class="variable">$prog</span>  </div><div class="line">        retval=$?  </div><div class="line">        <span class="built_in">echo</span>  </div><div class="line">        [ <span class="variable">$retval</span> -eq 0 ] &amp;&amp; rm -f <span class="variable">$lockfile</span>  </div><div class="line">        <span class="built_in">return</span> <span class="variable">$retval</span>  </div><div class="line">    &#125;  </div><div class="line">    <span class="function"><span class="title">restart</span></span>() &#123;  </div><div class="line">        <span class="variable">$exec</span> -c -q -f <span class="variable">$config</span>  </div><div class="line">        <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span>  </div><div class="line">            <span class="built_in">echo</span> <span class="string">"Errors in configuration file, check with <span class="variable">$prog</span> check."</span>  </div><div class="line">            <span class="built_in">return</span> 1  </div><div class="line">        <span class="keyword">fi</span>  </div><div class="line">        stop  </div><div class="line">        start  </div><div class="line">    &#125;  </div><div class="line">    <span class="function"><span class="title">reload</span></span>() &#123;  </div><div class="line">        <span class="variable">$exec</span> -c -q -f <span class="variable">$config</span>  </div><div class="line">        <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span>  </div><div class="line">            <span class="built_in">echo</span> <span class="string">"Errors in configuration file, check with <span class="variable">$prog</span> check."</span>  </div><div class="line">            <span class="built_in">return</span> 1  </div><div class="line">        <span class="keyword">fi</span>  </div><div class="line">        <span class="built_in">echo</span> -n $<span class="string">"Reloading <span class="variable">$prog</span>: "</span>  </div><div class="line">        <span class="variable">$exec</span> -D -f <span class="variable">$config</span> -p /var/run/<span class="variable">$prog</span>.pid -sf $(cat /var/run/<span class="variable">$prog</span>.pid)  </div><div class="line">        retval=$?  </div><div class="line">        <span class="built_in">echo</span>  </div><div class="line">        <span class="built_in">return</span> <span class="variable">$retval</span>  </div><div class="line">    &#125;  </div><div class="line">    <span class="function"><span class="title">force_reload</span></span>() &#123;  </div><div class="line">        restart  </div><div class="line">    &#125;  </div><div class="line">    <span class="function"><span class="title">fdr_status</span></span>() &#123;  </div><div class="line">        status <span class="variable">$prog</span>  </div><div class="line">    &#125;  </div><div class="line">    <span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span>  </div><div class="line">        start|stop|restart|reload)  </div><div class="line">            <span class="variable">$1</span>  </div><div class="line">            ;;  </div><div class="line">        force-reload)  </div><div class="line">            force_reload  </div><div class="line">            ;;  </div><div class="line">        checkconfig)  </div><div class="line">            check  </div><div class="line">            ;;  </div><div class="line">        status)  </div><div class="line">            fdr_status  </div><div class="line">            ;;  </div><div class="line">        condrestart|try-restart)  </div><div class="line">          [ ! -f <span class="variable">$lockfile</span> ] || restart  </div><div class="line">        ;;  </div><div class="line">        *)  </div><div class="line">            <span class="built_in">echo</span> $<span class="string">"Usage: <span class="variable">$0</span> &#123;start|stop|status|checkconfig|restart|try-restart|reload|force-reload&#125;"</span>  </div><div class="line">            <span class="built_in">exit</span> 2  </div><div class="line">    <span class="keyword">esac</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;重起服务haproxy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@localhost init.d]<span class="comment"># service haproxy restart  </span></div><div class="line">env: /etc/init.d/haproxy: Permission denied</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这个提示。大概是权限问题。下面加上执行权限  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@localhost init.d]<span class="comment"># ll haproxy   </span></div><div class="line">-rw-r--r--. 1 root root 2588 Nov 13 23:02 haproxy  </div><div class="line">[root@localhost init.d]<span class="comment"># chmod -R 655 haproxy   </span></div><div class="line">[root@localhost init.d]<span class="comment"># ll haproxy   </span></div><div class="line">-rw-r-xr-x. 1 root root 2588 Nov 13 23:02 haproxy</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;看一下进程是否存在，不存在重起haproxy服务  </p>
<pre><code class="bash">[root@localhost init.d]<span class="comment"># ps -ef | grep haproxy  </span>
root      7409  1260  0 23:56 pts/0    00:00:00 grep haproxy  
[root@localhost init.d]<span class="comment"># service haproxy restart  </span>
Stopping haproxy:                                          [FAILED]  
Starting haproxy:                                          [  OK  ]  
[root@localhost init.d]<span class="comment"># ps -ef | grep haproxy  </span>
nobody    7444     1  0 23:56 ?        00:00:00 /usr/<span class="built_in">local</span>/haproxy/sbin/haproxy -D -f /etc/haproxy.cfg -p /var/run/haproxy.pid  
root      7449  1260  0 23:56 pts/0    00:00:00 grep haproxy  
[root@localhost init.d]<span class="comment">#</span>
</code></pre>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;配置上面就完成了  </p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/haproxy/">haproxy</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Haproxy/4. haproxy 常用的8种算法" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Haproxy/4. haproxy 常用的8种算法/" class="article-date">
  	<time datetime="2017-09-02T18:04:46.001Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Haproxy/4. haproxy 常用的8种算法/">
        haproxy 常用的8种算法
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;HAProxy的负载均衡算法现在也越来越多了，具体有如下8种：</p>
<ol>
<li>roundrobin，表示简单的轮询，这个不多说，这个是负载均衡基本都具备的；</li>
<li>static-rr，表示根据权重，建议关注；</li>
<li>leastconn，表示最少连接者先处理，建议关注；</li>
<li>source，表示根据请求源IP，这个跟Nginx的IP_hash机制类似，我们用其作为解决session问题的一种方法</li>
<li>ri，表示根据请求的URI；</li>
<li>rl_param，表示根据请求的URl参数’balance url_param’ requires an URL parameter name；</li>
<li>hdr(name)，表示根据HTTP请求头来锁定每一次HTTP请求；</li>
<li>rdp-cookie(name)，表示根据据cookie(name)来锁定并哈希每一次TCP请求。</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/haproxy/">haproxy</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Haproxy/3. hapronxy 的特性" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Haproxy/3. hapronxy 的特性/" class="article-date">
  	<time datetime="2017-09-02T18:04:46.000Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Haproxy/3. hapronxy 的特性/">
        haproxy 的特性
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;负载均衡软件中，硬件设备有：F5，Big-IP等</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;基于软件的：HAProxy, LVS, Nginx等，在软件发负载均衡中，又分为两种实现方式，分贝时基于操作系统的负载均衡如：lvs, 和基于第三方应用实现的软件负载均衡。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;HAProxy 是一款提供高可用性、负载均衡以及基于TCP（第四层）和HTTP（第七层）应用的代理软件，支持虚拟主机，它是免费、快速并且可靠的一种解决方案。 HAProxy特别适用于那些负载特大的web站点，这些站点通常又需要会话保持或七层处理。HAProxy运行在时下的硬件上，完全可以支持数以万计的 并发连接。并且它的运行模式使得它可以很简单安全的整合进您当前的架构中， 同时可以保护你的web服务器不被暴露到网络上。它的优点如下：</p>
<ol>
<li>可靠性和稳定性非常好，可以与硬件F5负载均衡设备相媲美</li>
<li>最高可以同时维护40000-50000个并发连接，单位时间内处理的最大请求数为20000个，最大数据处理能力可达10Gbps。作为软件级别的负载均衡来说，HAProxy性能可以见一般</li>
<li>支持多于8种负载均衡算法，同时支持session保持</li>
<li>支持虚拟主机功能，这样实现web负载均衡更加灵活</li>
<li>从haproxy1.3版本后开始支持连接拒绝，全透明代理等功能，这些功能是其他负载均衡器锁不具备的。</li>
<li>haproxy拥有一个功能强大的服务器转台监控界面，通过此页面可以实时连接系统的运行状况，</li>
<li>haproxy拥有强大的acl支持，能给使用带来更大的方便。</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/haproxy/">haproxy</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Haproxy/2. LVS、Nginx、HaProxy 优缺点" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Haproxy/2. LVS、Nginx、HaProxy 优缺点/" class="article-date">
  	<time datetime="2017-09-02T18:04:45.999Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Haproxy/2. LVS、Nginx、HaProxy 优缺点/">
        LVS、Nginx、HaProxy 优缺点
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;搭建负载均衡高可用环境相对简单，主要是要理解其中原理。此文描述了三种负载均衡器的优缺点，以便在实际的生产应用中，按需求取舍。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;目前，在线上环境中应用较多的负载均衡器硬件有F5 BIG-IP,软件有LVS，Nginx及HAProxy,高可用软件有Heartbeat、Keepalived，成熟的架构有LVS+Keepalived、Nginx+Keepalived、HAProxy+keepalived及DRBD+Heartbeat.</p>
<h2 id="三种负载均衡器的优缺点说明如下："><a href="#三种负载均衡器的优缺点说明如下：" class="headerlink" title="三种负载均衡器的优缺点说明如下："></a>三种负载均衡器的优缺点说明如下：</h2><h3 id="LVS"><a href="#LVS" class="headerlink" title="LVS"></a>LVS</h3><h4 id="LVS的优点："><a href="#LVS的优点：" class="headerlink" title="LVS的优点："></a>LVS的优点：</h4><ol>
<li>抗负载能力强、工作在第4层仅作分发之用，没有流量的产生，这个特点也决定了它在负载均衡软件里的性能最强的；无流量，同时保证了均衡器IO的性能不会受到大流量的影响；</li>
<li>工作稳定，自身有完整的双机热备方案，如LVS+Keepalived和LVS+Heartbeat；</li>
<li>应用范围比较广，可以对所有应用做负载均衡；</li>
<li>配置性比较低，这是一个缺点也是一个优点，因为没有可太多配置的东西，所以并不需要太多接触，大大减少了人为出错的几率；</li>
</ol>
<h4 id="LVS的缺点："><a href="#LVS的缺点：" class="headerlink" title="LVS的缺点："></a>LVS的缺点：</h4><ol>
<li>软件本身不支持正则处理，不能做动静分离，这就凸显了Nginx/HAProxy+Keepalived的优势。</li>
<li>如果网站应用比较庞大，LVS/DR+Keepalived就比较复杂了，特别是后面有Windows Server应用的机器，实施及配置还有维护过程就比较麻烦，相对而言，Nginx/HAProxy+Keepalived就简单多了。</li>
</ol>
<hr>
<ul>
<li>LVS/DR如何处理请求报文的，会修改IP包内容吗？<ul>
<li>vs/dr本身不会关心IP层以上的信息，即使是端口号也是tcp/ip协议栈去判断是否正确，vs/dr本身主要做这么几个事：<ul>
<li>接收client的请求，根据你设定的负载均衡算法选取一台realserver的ip；</li>
<li>以选取的这个ip对应的mac地址作为目标mac，然后重新将IP包封装成帧转发给这台RS；</li>
<li>在hash table中记录连接信息。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;vs/dr做的事情很少，也很简单，所以它的效率很高，不比硬件负载均衡设备差多少。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;数据包、数据帧的大致流向是这样的：client –&gt; VS –&gt; RS –&gt; client</p>
<pre><code>- 前面已作了回答，vs/dr不会修改IP包的内容.
</code></pre><ul>
<li>RealServer为什么要在lo接口上配置VIP？在出口网卡上配置VIP可以吗？<ul>
<li>既然要让RS能够处理目标地址为vip的IP包，首先必须要让RS能接收到这个包。</li>
</ul>
</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在lo上配置vip能够完成接收包并将结果返回client。</p>
<pre><code>- 答案是不可以将VIP设置在出口网卡上,否则会响应客户端的arp request,造成client/gateway arp table紊乱，以至于整个load balance都不能正常工作。
</code></pre><ul>
<li>RealServer为什么要抑制arp帧？<br>  &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这个问题在上一问题中已经作了说明，这里结合实施命令进一步阐述。我们在具体实施部署的时候都会作如下调整： </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">"1"</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore    </div><div class="line"><span class="built_in">echo</span> <span class="string">"2"</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_announce    </div><div class="line"><span class="built_in">echo</span> <span class="string">"1"</span> &gt;/proc/sys/net/ipv4/conf/all/arp_ignore    </div><div class="line"><span class="built_in">echo</span> <span class="string">"2"</span> &gt;/proc/sys/net/ipv4/conf/all/arp_announce</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;相信很多人都不会弄懂它们的作用是什么，只知道一定得有。我这里也不打算拿出来详细讨论，只是作几点说明，就当是补充吧。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">"1"</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore    </div><div class="line"><span class="built_in">echo</span> <span class="string">"2"</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这两条是可以不用的，因为arp对逻辑接口没有意义。</p>
<ul>
<li>如果你的RS的外部网络接口是eth0，那么     </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">"1"</span> &gt;/proc/sys/net/ipv4/conf/all/arp_ignore     </div><div class="line"><span class="built_in">echo</span> <span class="string">"2"</span> &gt;/proc/sys/net/ipv4/conf/all/arp_announce</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;其实真正要执行的是：      </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">"1"</span> &gt;/proc/sys/net/ipv4/conf/eth0/arp_ignore      </div><div class="line"><span class="built_in">echo</span> <span class="string">"2"</span> &gt;/proc/sys/net/ipv4/conf/eth0/arp_announce</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;所以我个人建议把上面两条也加到你的脚本里去，因为万一系统里上面两条默认的值不是0，那有可能是会出问题滴。</p>
<ul>
<li>LVS/DR load balancer（director）与RS为什么要在同一网段中？<br>  从第一个问题中大家应该明白vs/dr是如何将请求转发给RS的了吧？它是在数据链路层来实现的，所以director必须和RS在同一网段里面。</li>
<li>为什么director上lo接口除了VIP另外还要在eth0配一个ip（即DIP）？<ul>
<li>如果是用了keepalived等工具做HA或者Load Balance,则在健康检查时需要用到DIP。</li>
<li>没有健康检查机制的HA或者Load Balance则没有存在的实际意义。</li>
</ul>
</li>
<li>LVS/DR ip_forward需要开启吗？<br>  不需要。因为director跟realserver是同一个网段，无需开启转发。</li>
<li>director的vip的netmask一定要是255.255.255.255吗？<br>  lvs/dr里，director的vip的netmask 没必要设置为255.255.255.255，也不需要再去<br>  route add -host $VIP dev eth0:0<br>  director的vip本来就是要像正常的ip地址一样对外通告的,不要搞得这么特殊.          </li>
<li>LVS/DR如何进行tcp的三次握手？</li>
</ul>
<hr>
<h3 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h3><h4 id="Nginx的优点："><a href="#Nginx的优点：" class="headerlink" title="Nginx的优点："></a>Nginx的优点：</h4><ol>
<li>工作在OSI第7层，可以针对http应用做一些分流的策略。比如针对域名、目录结构。它的正则比HAProxy更为强大和灵活；</li>
<li>Nginx对网络的依赖非常小，理论上能ping通就就能进行负载功能，这个也是它的优势所在；</li>
<li>Nginx安装和配置比较简单，测试起来比较方便；</li>
<li>可以承担高的负载压力且稳定，一般能支撑超过几万次的并发量；</li>
<li>Nginx可以通过端口检测到服务器内部的故障，比如根据服务器处理网页返回的状态码、超时等等，并且会把返回错误的请求重新提交到另一个节点；</li>
<li>Nginx不仅仅是一款优秀的负载均衡器/反向代理软件，它同时也是功能强大的Web应用服务器。LNMP现在也是非常流行的web环境，大有和LAMP环境分庭抗礼之势，Nginx在处理静态页面、特别是抗高并发方面相对apache有优势；</li>
<li>Nginx现在作为Web反向加速缓存越来越成熟了，速度比传统的Squid服务器更快，有需求的朋友可以考虑用其作为反向代理加速器；</li>
</ol>
<h4 id="Nginx的缺点："><a href="#Nginx的缺点：" class="headerlink" title="Nginx的缺点："></a>Nginx的缺点：</h4><ol>
<li>Nginx不支持url来检测。</li>
<li>Nginx仅能支持http和Email，这个它的弱势。</li>
<li>Nginx的Session的保持，Cookie的引导能力相对欠缺。</li>
</ol>
<h3 id="HaProxy"><a href="#HaProxy" class="headerlink" title="HaProxy"></a>HaProxy</h3><h4 id="HAProxy的优点："><a href="#HAProxy的优点：" class="headerlink" title="HAProxy的优点："></a>HAProxy的优点：</h4><ol>
<li>HAProxy是支持虚拟主机的，可以工作在4、7层(支持多网段)；</li>
<li>能够补充Nginx的一些缺点比如Session的保持，Cookie的引导等工作；</li>
<li>支持url检测后端的服务器；</li>
<li>它跟LVS一样，本身仅仅就只是一款负载均衡软件；单纯从效率上来讲HAProxy更会比Nginx有更出色的负载均衡速度，在并发处理上也是优于Nginx的；</li>
<li>HAProxy可以对Mysql读进行负载均衡，对后端的MySQL节点进行检测和负载均衡，不过在后端的MySQL slaves数量超过10台时性能不如LVS；</li>
<li>HAProxy的算法较多，达到8种；</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LVS/">LVS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/haproxy/">haproxy</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Haproxy/1. HAProxy 配置文件结构" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Haproxy/1. HAProxy 配置文件结构/" class="article-date">
  	<time datetime="2017-09-02T18:04:45.998Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Haproxy/1. HAProxy 配置文件结构/">
        haproxy 配置文件结构
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;HAProxy配置文件主要由5个部分组成，但是有些部分并不是必需的，可以根据需要选择相应的部分进行配置：</p>
<h2 id="1-global部分"><a href="#1-global部分" class="headerlink" title="1.global部分"></a>1.global部分</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;设定全局参数变量，属于进程级别的配置，通常和操作系统配置有关</p>
<h2 id="2-defaults部分"><a href="#2-defaults部分" class="headerlink" title="2.defaults部分"></a>2.defaults部分</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;模式参数的配置部分。在此部分设置的参数值，默认会自动引用到下面的frontend。backend和listen部分中，因此，如果某些参数属于公用的配置，只需要在defaults部分添加一次即可。如果在frontend、backend和listen部分中也配置了于defaults部分一样的参数，那么defaults部分参数对应的值自动覆盖</p>
<h2 id="3-frontend部分"><a href="#3-frontend部分" class="headerlink" title="3.frontend部分"></a>3.frontend部分</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;此部分用于设置接收用户请求的前段虚拟节点。frontend是在haproxy1.3版本以后才引入的一个组件，同事引入的还有backend组件。通过引入这些组件，在很大程度上简化了HAProxy配置文件的复杂性。frontend可以根据ACL规则直接指定要是用的后端backend。</p>
<h2 id="4-backend部分"><a href="#4-backend部分" class="headerlink" title="4.backend部分"></a>4.backend部分</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;此部分用于设置集群后端服务集群的配置，也就是用来添加一组真是服务器，以处理前端用户的请求。添加的真是服务器类似于LVS中的real server节点</p>
<h2 id="5-listen部分"><a href="#5-listen部分" class="headerlink" title="5. listen部分"></a>5. listen部分</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;此部分是frontend部分和backend部分的结合体。在HAProxy 1.3版本之前，HAProxy的所有配置选项都在这个部分上设置。为了保持兼容性，HAProxy新的版本仍然保留了listen组件的配置方式。目前在HAProxy中，两种配置方式任选其一即可。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/haproxy/">haproxy</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Memcached/4. Memcached数据被踢(evictions0)现象分析" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Memcached/4. Memcached数据被踢(evictions0)现象分析/" class="article-date">
  	<time datetime="2017-09-02T18:04:45.996Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Memcached/4. Memcached数据被踢(evictions0)现象分析/">
        Memcached数据被踢(evictions0)现象分析
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;很多同学可能熟知Memcached的LRU淘汰算法，它是在slab内部进行的，如果所有空间都被slabs分配，即使另外一个slab里面有空位，仍然存在踢数据可能。你可以把slab理解为教室，如果你的教室满了，即使别的教室有空位你的教室也只能踢人才能进人。</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Memcached%E6%95%B0%E6%8D%AE%E8%A2%AB%E8%B8%A2evictions0%E7%8E%B0%E8%B1%A1%E5%88%86%E6%9E%90/01.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;本文介绍的却是另外一种现象。今天监控发现线上一memcached发生数据被踢现象，用stats命令看evictions&gt;0,因为以前也出现过此问题，后来对这个参数增加了一个监控，所以这次主动就发现了。由于给memcached分配的内存远大于业务存储数据所需内存，因此初步判断是“灵异现象”。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;第一步，netstat查看所有连接，排除是否被一些未规划的client使用，经排查后断定无此可能。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;第二步，用tcpdump抽样检查set的指令，排除是否有忘记设cache过期时间的client，初步检查所有典型的业务都有expire time。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;第三步，Google，未果</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;第四步，看源代码，了解evictions计数器增加时的具体细节.</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;in items.c, memcached-1.2.8,</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (search = tails[id]; tries &gt; 0 &amp;&amp; search != NULL; tries--, search=search-&gt;prev) &#123;</div><div class="line">    <span class="keyword">if</span> (search-&gt;refcount == 0) &#123;</div><div class="line">        <span class="keyword">if</span> (search-&gt;exptime == 0 || search-&gt;exptime &gt; current_time) &#123;</div><div class="line">            itemstats[id].evicted++;</div><div class="line">            itemstats[id].evicted_time = current_time - search-&gt;time;</div><div class="line">            STATS_LOCK();</div><div class="line">            stats.evictions++;</div><div class="line">            STATS_UNLOCK();</div><div class="line">        &#125;</div><div class="line">        do_item_unlink(search);</div><div class="line">        <span class="built_in">break</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;从源代码发现踢数据只判断一个条件，if (search-&gt;refcount == 0)，这个refcount是多线程版本计数用，在当前服务器未启用多线程情况下，refcount应该始终为0,因此初步判断memcached是从访问队列尾部直接踢数据。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;为了证实想法，设计以下场景：</p>
<ol>
<li><p>部署一个memcached测试环境，分配比较小的内存，比如8M</p>
</li>
<li><p>设置1条永远不过期的数据到memcached中，然后再get一次，这条数据后续应该存在LRU队尾。</p>
</li>
<li><p>每隔1S向memcached set(并get一次) 1,000条数据，过期时间设为3秒。</p>
</li>
<li><p>一段时间后，stats命令显示evictions=1</p>
</li>
</ol>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;按我以前的理解，第2步的数据是永远不会被踢的，因为有足够过期的数据空间可以给新来的数据用，LRU淘汰算法应该跳过没过期的数据，但结果证实这种判断是错误的。以上业务的服务器发生被踢的现象是由于保存了大量存活期短的key/value,且key是不重复的。另外又有一业务保存了小量不过期的数据，因此导致不过期的数据惨遭被挤到队列踢出。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;本来这个问题就告一段落了，但在写完这篇文章后，顺便又看了新一代memcached 1.4.1的源代码，很惊喜发现以下代码被增加。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;items.c, memcached 1.4.1<br>/<em> do a quick check if we have any expired items in the tail.. </em>/<br>int tries = 50;<br>item *search;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (search = tails[id];</div><div class="line">    tries &gt; 0 &amp;&amp; search != NULL;</div><div class="line">    tries--, search=search-&gt;prev) &#123;</div><div class="line">    <span class="keyword">if</span> (search-&gt;refcount == 0 &amp;&amp;</div><div class="line">        (search-&gt;exptime != 0 &amp;&amp; search-&gt;exptime &lt; current_time)) &#123;</div><div class="line">        it = search;</div><div class="line">        /* I don<span class="string">'t want to actually free the object, just steal</span></div><div class="line"><span class="string">         * the item to avoid to grab the slab mutex twice ;-)</span></div><div class="line"><span class="string">         */</span></div><div class="line"><span class="string">        it-&gt;refcount = 1;</span></div><div class="line"><span class="string">        do_item_unlink(it);</span></div><div class="line"><span class="string">        /* Initialize the item block: */</span></div><div class="line"><span class="string">        it-&gt;slabs_clsid = 0;</span></div><div class="line"><span class="string">        it-&gt;refcount = 0;</span></div><div class="line"><span class="string">        break;</span></div><div class="line"><span class="string">    &#125;</span></div><div class="line"><span class="string">&#125;</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;重复进行上述测试，未发生evictions。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;9/8 Update: 注意到L108的tries=50没有？试想把测试第2步设置51条不过期数据到cache中，情况会怎样？因此新版的Memcached也同样存在本文描述问题。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;几条总结：</p>
<ul>
<li>过期的数据如果没被显式调用get，则也要占用空间。</li>
<li>过期的不要和不过期的数据存在一起，否则不过期的可能被踢。</li>
<li>从节约内存的角度考虑，即使数据会过期，也不要轻易使用随机字符串作为key，尽量使用定值如uid，这样占用空间的大小相对固定。</li>
<li>估算空间大小时候请用slab size计算，不要按value长度去计算。</li>
<li>不要把cache当作更快的key value store来用, cache不是storage。</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Memcached/">Memcached</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Memcached/3. Memcache 查看列出所有key方法" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Memcached/3. Memcache 查看列出所有key方法/" class="article-date">
  	<time datetime="2017-09-02T18:04:45.995Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Memcached/3. Memcache 查看列出所有key方法/">
        Memcache 查看列出所有key方法
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;今天在做一个Memcache的session测试，但是在测试的过程中，发现Memcache没有一个比较简单的方法可以直接象redis那样keys *列出所有的Session key，并根据key get对应 的session内容</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;于是，我开始查找资料，翻出来的大部分是一些memcache常用命令等</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;但是对列出key的办法，讲解却不多，于是来到google，找到了一个国外的资料</p>
<p><a href="http://www.darkcoding.net/software/memcached-list-all-keys/" target="_blank" rel="external">http://www.darkcoding.net/software/memcached-list-all-keys/</a></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;cmd上登录memcache</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;telnet 127.0.0.1 11211</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;具体的内容我套用我的测试环境中，操作如下</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;首先列出所有keys</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">stats items</div><div class="line">STAT items:7:number 1</div><div class="line">STAT items:7:age 188</div><div class="line">END</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;接下来基于列出的items id，本例中为7，第2个参数为列出的长度，0为全部列出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">stats cachedump 7 0</div><div class="line">ITEM Sess_sidsvpc1473t1np08qnkvhf6j2 [183 b; 1394527347 s]</div><div class="line">END</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;上面的stats cachedump命令列出了我的session key，接下来就用get命令查找对应的 session值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">get Sess_sidsvpc1473t1np08qnkvhf6j2</div><div class="line">VALUE</div><div class="line">Sess_sidsvpc1473t1np08qnkvhf6j2 1440 1</div><div class="line">83</div><div class="line">Sess_|a:5:&#123;s:6:”verify”;s:32:”e70981fd305170c41a5632b2a24bbcaa”;s:3:”uid”;s:1:”1</div><div class="line">“;s:8:”username”;s:5:”admin”;s:9:”logintime”;s:19:”2014-03-11 16:24:25″;s:7:”<span class="built_in">log</span></div><div class="line">inip”;s:9:”127.0.0.1″;&#125;</div></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Memcached/">Memcached</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/30/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/29/">29</a><a class="page-number" href="/page/30/">30</a><span class="page-number current">31</span><a class="page-number" href="/page/32/">32</a><a class="page-number" href="/page/33/">33</a><span class="space">&hellip;</span><a class="page-number" href="/page/63/">63</a><a class="extend next" rel="next" href="/page/32/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2017 失落的乐章
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/smackgg/hexo-theme-smackdown" target="_blank">Smackdown</a>
        </div>
    </div>
  </div>
</footer>
    </div>
    

<script>
	var yiliaConfig = {
		fancybox: ,
		mathjax: ,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="/js/main.js"></script>



  </div>
</body>
</html>