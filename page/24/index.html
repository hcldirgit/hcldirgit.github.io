<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>失落的乐章</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="失落的乐章的Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="失落的乐章">
<meta property="og:url" content="https://hcldirgit.github.io/page/24/index.html">
<meta property="og:site_name" content="失落的乐章">
<meta property="og:description" content="失落的乐章的Blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="失落的乐章">
<meta name="twitter:description" content="失落的乐章的Blog">
  
    <link rel="alternative" href="/atom.xml" title="失落的乐章" type="application/atom+xml">
  
  
    <link rel="icon" href="https://github.com/hcldirgit/image/blob/master/0.png?raw=true">
  
  <link rel="stylesheet" href="/css/style.css">
  
  
<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-85415703-1', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  <script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>
  <script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>

  
</head>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://github.com/hcldirgit/image/blob/master/0.png?raw=true" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">失落的乐章</a></h1>
		</hgroup>

		
		<p class="header-subtitle">技术面前，永远都是学生。</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/tags">静心阅读</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Ansible/" style="font-size: 10.42px;">Ansible</a> <a href="/tags/Apache/" style="font-size: 18.33px;">Apache</a> <a href="/tags/Cacti/" style="font-size: 11.67px;">Cacti</a> <a href="/tags/DNS/" style="font-size: 13.33px;">DNS</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/FTP/" style="font-size: 11.25px;">FTP</a> <a href="/tags/Git/" style="font-size: 10.83px;">Git</a> <a href="/tags/HA集群/" style="font-size: 11.67px;">HA集群</a> <a href="/tags/Hadoop/" style="font-size: 12.5px;">Hadoop</a> <a href="/tags/Jenkins/" style="font-size: 10.42px;">Jenkins</a> <a href="/tags/LAMP/" style="font-size: 19.58px;">LAMP</a> <a href="/tags/LNMP/" style="font-size: 17.08px;">LNMP</a> <a href="/tags/LVS/" style="font-size: 16.67px;">LVS</a> <a href="/tags/Linux/" style="font-size: 19.17px;">Linux</a> <a href="/tags/Linux命令/" style="font-size: 20px;">Linux命令</a> <a href="/tags/Linux安全/" style="font-size: 14.17px;">Linux安全</a> <a href="/tags/Memcached/" style="font-size: 11.25px;">Memcached</a> <a href="/tags/MongoDB/" style="font-size: 15.42px;">MongoDB</a> <a href="/tags/MySQL/" style="font-size: 17.5px;">MySQL</a> <a href="/tags/NFS/" style="font-size: 10px;">NFS</a> <a href="/tags/Nagios/" style="font-size: 11.67px;">Nagios</a> <a href="/tags/Nginx/" style="font-size: 17.92px;">Nginx</a> <a href="/tags/OpenStack/" style="font-size: 11.25px;">OpenStack</a> <a href="/tags/Php/" style="font-size: 14.58px;">Php</a> <a href="/tags/Puppet/" style="font-size: 11.25px;">Puppet</a> <a href="/tags/Python/" style="font-size: 14.58px;">Python</a> <a href="/tags/Redis/" style="font-size: 16.25px;">Redis</a> <a href="/tags/Resin/" style="font-size: 10px;">Resin</a> <a href="/tags/Saltstack/" style="font-size: 10px;">Saltstack</a> <a href="/tags/Samba/" style="font-size: 12.08px;">Samba</a> <a href="/tags/Squid/" style="font-size: 14.58px;">Squid</a> <a href="/tags/Tomcat/" style="font-size: 13.75px;">Tomcat</a> <a href="/tags/Zabbix/" style="font-size: 15.83px;">Zabbix</a> <a href="/tags/haproxy/" style="font-size: 12.5px;">haproxy</a> <a href="/tags/keepalived/" style="font-size: 12.92px;">keepalived</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/shell练习/" style="font-size: 18.75px;">shell练习</a> <a href="/tags/正则表达式/" style="font-size: 12.92px;">正则表达式</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">失落的乐章</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="https://github.com/hcldirgit/image/blob/master/0.png?raw=true" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">失落的乐章</h1>
			</hgroup>
			
			<p class="header-subtitle">技术面前，永远都是学生。</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/tags">静心阅读</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-Nginx/35. Nginx负载均衡算法分析" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Nginx/35. Nginx负载均衡算法分析/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.739Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Nginx/35. Nginx负载均衡算法分析/">
        Nginx负载均衡算法分析
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;随着互联网信息的爆炸性增长，负载均衡（load balance）已经不再是一个很陌生的话题，顾名思义，负载均衡即是将负载分摊到不同的服务单元，既保证服务的可用性，又保证响应足够快，给用户很好的体验。快速增长的访问量和数据流量催生了各式各样的负载均衡产品，很多专业的负载均衡硬件提供了很好的功能，但却价格不菲（如F5 BIG-IP、Citrix NetScaler、Radware等等，虽然可以解决问题，但其高昂的价格却往往令人望而却步），这使得负载均衡软件大受欢迎，nginx就是其中的一个。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;nginx第一个公开版本发布于2004年，2011年发布了1.0版本。它的特点是稳定性高、功能强大、资源消耗低，从其目前的市场占有而言，nginx大有与apache抢市场的势头。其中不得不提到的一个特性就是其负载均衡功能，这也成了很多公司选择它的主要原因。本文将从源码的角度介绍nginx的内置负载均衡策略和扩展负载均衡策略，以实际的工业生产为案例，对比各负载均衡策略，为nginx使用者提供参考。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;nginx的负载均衡策略可以划分为两大类：内置策略和扩展策略。内置策略包含加权轮询和ip hash，在默认情况下这两种策略会编译进nginx内核，只需在nginx配置中指明参数即可。扩展策略有很多，如fair、通用hash、consistent hash等，默认不编译进nginx内核。由于在nginx版本升级中负载均衡的代码没有本质性的变化，因此下面将以nginx1.0.15稳定版为例，从源码角度分析各个策略。</p>
<h2 id="1-加权轮询（weighted-round-robin）"><a href="#1-加权轮询（weighted-round-robin）" class="headerlink" title="1. 加权轮询（weighted round robin）"></a>1. 加权轮询（weighted round robin）</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;轮询的原理很简单，首先我们介绍一下轮询的基本流程。如下是处理一次请求的流程图：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90/01.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;图中有两点需要注意，第一，如果可以把加权轮询算法分为先深搜索和先广搜索，那么nginx采用的是先深搜索算法，即将首先将请求都分给高权重的机器，直到该机器的权值降到了比其他机器低，才开始将请求分给下一个高权重的机器；第二，当所有后端机器都down掉时，nginx会立即将所有机器的标志位清成初始状态，以避免造成所有的机器都处在timeout的状态，从而导致整个前端被夯住。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;接下来看下源码。nginx源码的目录结构很清晰，加权轮询所在路径为nginx-1.0.15/src/http/ngx_http_upstream_round_robin.[c|h]，在源码的基础上，针对重要的、不易理解的地方我加了注释。首先看下ngx_http_upstream_round_robin.h中的重要声明：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90/02.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;从变量命名中，我们就可以大致猜出其作用。其中，current_weight和weight的区别主要是前者为权重排序的值，随着处理请求会动态的变化，后者是配置值，用于恢复初始状态。<br>接下来看下轮询的创建过程，代码如下图所示。</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90/03.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这里有个tried变量需要做些说明。tried中记录了服务器当前是否被尝试连接过。他是一个位图。如果服务器数量小于32，则只需在一个int中即可记录下所有服务器状态。如果服务器数量大于32，则需在内存池中申请内存来存储。对该位图数组的使用可参考如下代码：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90/04.png?raw=true" alt=""></p>
<p>最后是实际的策略代码，逻辑很简单，代码实现也只有30行，直接上代码。</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90/05.png?raw=true" alt=""></p>
<h2 id="2-ip-hash"><a href="#2-ip-hash" class="headerlink" title="2. ip hash"></a>2. ip hash</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;ip hash是nginx内置的另一个负载均衡的策略，流程和轮询很类似，只是其中的算法和具体的策略有些变化，如下图所示：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90/06.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;ip hash算法的核心实现如下图：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90/07.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;从代码中可以看出，hash值既与ip有关又与后端机器的数量有关。经过测试，上述算法可以连续产生1045个互异的value，这是该算法的硬限制。对此nginx使用了保护机制，当经过20次hash仍然找不到可用的机器时，算法退化成轮询。因此，从本质上说，ip hash算法是一种变相的轮询算法，如果两个ip的初始hash值恰好相同，那么来自这两个ip的请求将永远落在同一台服务器上，这为均衡性埋下了很深的隐患。</p>
<h2 id="3-fair"><a href="#3-fair" class="headerlink" title="3. fair"></a>3. fair</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;fair策略是扩展策略，默认不被编译进nginx内核。其原理是根据后端服务器的响应时间判断负载情况，从中选出负载最轻的机器进行分流。这种策略具有很强的自适应性，但是实际的网络环境往往不是那么简单，因此要慎用。</p>
<h2 id="4-通用hash、一致性hash"><a href="#4-通用hash、一致性hash" class="headerlink" title="4. 通用hash、一致性hash"></a>4. 通用hash、一致性hash</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这两种也是扩展策略，在具体的实现上有些差别，通用hash比较简单，可以以nginx内置的变量为key进行hash，一致性hash采用了nginx内置的一致性hash环，可以支持memcache。<br>对上面的集中负载均衡算法进行测试（测试工具polygraph），考察下面三个关键的测试指标：</p>
<ul>
<li>均衡性：是否能够将请求均匀的发送给后端</li>
<li>一致性：同一个key的请求，是否能落到同一台机器</li>
<li>容灾性：当部分后端机器挂掉时，是否能够正常工作</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;通过实际的对比测试，我们对nginx各个负载均衡策略进行了验证。下面从均衡性、一致性、容灾性以及适用场景等角度对比各种策略。</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90/08.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;无论哪种策略都不是万金油，在具体的场景下应该选择哪种策略一定程度上依赖于使用者对这些策略的熟悉程度。希望本文的分析和测试数据能够对读者有所帮助，更希望有越来越多、越来越好的负载均衡策略产出。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="http://wiki.nginx.org/HttpUpstreamConsistentHash" target="_blank" rel="external">http://wiki.nginx.org/HttpUpstreamConsistentHash</a></p>
<p><a href="http://wiki.nginx.org/HttpUpstreamFairModule" target="_blank" rel="external">http://wiki.nginx.org/HttpUpstreamFairModule</a></p>
<p><a href="http://wiki.nginx.org/HttpUpstreamRequestHashModule" target="_blank" rel="external">http://wiki.nginx.org/HttpUpstreamRequestHashModule</a></p>
<p><a href="http://www.web-polygraph.org/" target="_blank" rel="external">http://www.web-polygraph.org/</a></p>
<p><a href="http://nginx.org/" target="_blank" rel="external">http://nginx.org/</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Nginx/34. Nginx的代理" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Nginx/34. Nginx的代理/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.738Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Nginx/34. Nginx的代理/">
        Nginx的代理
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">upstream bbs.aaa.cn&#123;</div><div class="line">        server 1.2.3.1:80;</div><div class="line">        server 1.2.3.4:80;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        listen 80;</div><div class="line">        server_name bbs.aaa.cn;</div><div class="line"></div><div class="line">        location / &#123;</div><div class="line">            proxy_pass http://bbs.aaa.cn/;</div><div class="line">            proxy_set_header Host <span class="variable">$host</span>;</div><div class="line">            proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</div><div class="line">            proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line">        &#125;</div><div class="line"><span class="comment">#         access_log /home/logs/bbs.access combined;</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    upstream blog.aaa.cn&#123;</div><div class="line">        server 1.2.3.1:80;</div><div class="line">        server 1.2.3.4:80;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        listen 80;</div><div class="line">        server_name blog.aaa.cn;</div><div class="line"></div><div class="line">        location / &#123;</div><div class="line">            proxy_pass http://blog.aaa.cn/;</div><div class="line">            proxy_set_header Host <span class="variable">$host</span>;</div><div class="line">            proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</div><div class="line">            proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line">        &#125;</div><div class="line"><span class="comment">#         access_log /home/logs/ss.access combined;</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;经测试发现，可以用nginx代理一个服务器上所有域名，方法如下：</p>
<ol>
<li><p>主配置文件不需要更改任何配置</p>
</li>
<li><p>在vhosts目录下需要建立两个文件，一个是servername 列表文件，一个是虚拟主机配置文件</p>
</li>
</ol>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;两个文件内容分别为</p>
<ul>
<li>servername</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">server_name www.123.net.cn www.alsdjfl.com www.asdfa1.com;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;就这么简单一行，当然这个server_name 还可以继续添加的</p>
<ul>
<li>虚拟主机配置文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen 80;</div><div class="line">    include vhosts/servername; <span class="comment"># 这里的文件就是上边那个servername列表文件</span></div><div class="line">    location / &#123;</div><div class="line">        proxy_pass http://1.2.1.2/; <span class="comment">#这里就是需要做代理的服务器ip地址了</span></div><div class="line">        proxy_set_header Host <span class="variable">$host</span>;</div><div class="line">        proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</div><div class="line">        proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line">    &#125;</div><div class="line">    access_log /dev/null; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Nginx/33. Nginx、LVS及HAProxy负载均衡软件的优缺点详解" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Nginx/33. Nginx、LVS及HAProxy负载均衡软件的优缺点详解/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.737Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Nginx/33. Nginx、LVS及HAProxy负载均衡软件的优缺点详解/">
        Nginx、LVS及HAProxy负载均衡软件的优缺点详解
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Nginx/LVS/HAProxy是目前使用最广泛的三种负载均衡软件，本人都在多个项目中实施过，参考了一些资料，结合自己的一些使用经验，总结一下。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;一般对负载均衡的使用是随着网站规模的提升根据不同的阶段来使用不同的技术。具体的应用需求还得具体分析，如果是中小型的Web应用，比如日PV小于1000万，用Nginx就完全可以了；如果机器不少，可以用DNS轮询，LVS所耗费的机器还是比较多的；大型网站或重要的服务，且服务器比较多时，可以考虑用LVS。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;一种是通过硬件来进行，常见的硬件有比较昂贵的F5和Array等商用的负载均衡器，它的优点就是有专业的维护团队来对这些服务进行维护、缺点就是花销太大，所以对于规模较小的网络服务来说暂时还没有需要使用；另外一种就是类似于Nginx/LVS/HAProxy的基于 Linux的开源免费的负载均衡软件，这些都是通过软件级别来实现，所以费用非常低廉。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;目前关于网站架构一般比较合理流行的架构方案：Web前端采用Nginx/HAProxy+ Keepalived作负载均衡器；后端采用 MySQL数据库一主多从和读写分离，采用LVS+Keepalived的架构。当然要根据项目具体需求制定方案。    </p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;下面说说各自的特点和适用场合。</p>
<h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><h3 id="Nginx的优点是："><a href="#Nginx的优点是：" class="headerlink" title="Nginx的优点是："></a>Nginx的优点是：</h3><ol>
<li><p>工作在网络的7层之上，可以针对http应用做一些分流的策略，比如针对域名、目录结构，它的正则规则比HAProxy更为强大和灵活，这也是它目前广泛流行的主要原因之一，Nginx单凭这点可利用的场合就远多于LVS了。 </p>
</li>
<li><p>Nginx对网络稳定性的依赖非常小，理论上能ping通就就能进行负载功能，这个也是它的优势之一；相反LVS对网络稳定性依赖比较大，这点本人深有体会； </p>
</li>
<li><p>Nginx安装和配置比较简单，测试起来比较方便，它基本能把错误用日志打印出来。LVS的配置、测试就要花比较长的时间了，LVS对网络依赖比较大。 </p>
</li>
<li><p>可以承担高负载压力且稳定，在硬件不差的情况下一般能支撑几万次的并发量，负载度比LVS相对小些。 </p>
</li>
<li><p>Nginx可以通过端口检测到服务器内部的故障，比如根据服务器处理网页返回的状态码、超时等等，并且会把返回错误的请求重新提交到另一个节点，不过其中缺点就是不支持url来检测。比如用户正在上传一个文件，而处理该上传的节点刚好在上传过程中出现故障，Nginx会把上传切到另一台服务器重新处理，而LVS就直接断掉了，如果是上传一个很大的文件或者很重要的文件的话，用户可能会因此而不满。 </p>
</li>
<li><p>Nginx不仅仅是一款优秀的负载均衡器/反向代理软件，它同时也是功能强大的Web应用服务器。LNMP也是近几年非常流行的web架构，在高流量的环境中稳定性也很好。 </p>
</li>
<li><p>Nginx现在作为Web反向加速缓存越来越成熟了，速度比传统的Squid服务器更快，可以考虑用其作为反向代理加速器。 </p>
</li>
<li><p>Nginx可作为中层反向代理使用，这一层面Nginx基本上无对手，唯一可以对比Nginx的就只有 lighttpd了，不过 lighttpd目前还没有做到Nginx完全的功能，配置也不那么清晰易读，社区资料也远远没Nginx活跃。 </p>
</li>
<li><p>Nginx也可作为静态网页和图片服务器，这方面的性能也无对手。还有Nginx社区非常活跃，第三方模块也很多。</p>
</li>
</ol>
<h3 id="Nginx的缺点是："><a href="#Nginx的缺点是：" class="headerlink" title="Nginx的缺点是："></a>Nginx的缺点是：</h3><ol>
<li>Nginx仅能支持http、https和Email协议，这样就在适用范围上面小些，这个是它的缺点。 </li>
<li><strong>对后端服务器的健康检查，只支持通过端口来检测，不支持通过url来检测</strong>。不支持Session的直接保持，但能通过ip_hash来解决。</li>
</ol>
<h2 id="LVS"><a href="#LVS" class="headerlink" title="LVS"></a>LVS</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;LVS：使用Linux内核集群实现一个高性能、高可用的负载均衡服务器，它具有很好的可伸缩性（Scalability)、可靠性（Reliability)和可管理性（Manageability)。</p>
<h3 id="LVS的优点是："><a href="#LVS的优点是：" class="headerlink" title="LVS的优点是："></a>LVS的优点是：</h3><ol>
<li><p>抗负载能力强、是工作在网络4层之上仅作分发之用，没有流量的产生，这个特点也决定了它在负载均衡软件里的性能最强的，对内存和cpu资源消耗比较低。 </p>
</li>
<li><p>配置性比较低，这是一个缺点也是一个优点，因为没有可太多配置的东西，所以并不需要太多接触，大大减少了人为出错的几率。 </p>
</li>
<li><p>工作稳定，因为其本身抗负载能力很强，自身有完整的双机热备方案，如LVS+Keepalived，不过我们在项目实施中用得最多的还是LVS/DR+Keepalived。 </p>
</li>
<li><p>无流量，LVS只分发请求，而流量并不从它本身出去，这点保证了均衡器IO的性能不会受到大流量的影响。 </p>
</li>
<li><p>应用范围比较广，因为LVS工作在4层，所以它几乎可以对所有应用做负载均衡，包括http、数据库、在线聊天室等等。</p>
</li>
</ol>
<h3 id="LVS的缺点是："><a href="#LVS的缺点是：" class="headerlink" title="LVS的缺点是："></a>LVS的缺点是：</h3><ol>
<li><p>软件本身不支持正则表达式处理，不能做动静分离；而现在许多网站在这方面都有较强的需求，这个是Nginx/HAProxy+Keepalived的优势所在。 </p>
</li>
<li><p>如果是网站应用比较庞大的话，LVS/DR+Keepalived实施起来就比较复杂了，特别后面有 Windows Server的机器的话，如果实施及配置还有维护过程就比较复杂了，相对而言，Nginx/HAProxy+Keepalived就简单多了。</p>
</li>
</ol>
<h2 id="HAProxy"><a href="#HAProxy" class="headerlink" title="HAProxy"></a>HAProxy</h2><h3 id="HAProxy的特点是："><a href="#HAProxy的特点是：" class="headerlink" title="HAProxy的特点是："></a>HAProxy的特点是：</h3><ol>
<li><p>HAProxy也是支持虚拟主机的。 </p>
</li>
<li><p>HAProxy的优点能够补充Nginx的一些缺点，比如支持Session的保持，Cookie的引导；同时支持通过获取指定的url来检测后端服务器的状态。 </p>
</li>
<li><p>HAProxy跟LVS类似，本身就只是一款负载均衡软件；单纯从效率上来讲HAProxy会比Nginx有更出色的负载均衡速度，在并发处理上也是优于Nginx的。 </p>
</li>
<li><p>HAProxy支持TCP协议的负载均衡转发，可以对MySQL读进行负载均衡，对后端的MySQL节点进行检测和负载均衡，大家可以用LVS+Keepalived对MySQL主从做负载均衡。 </p>
</li>
<li><p>HAProxy负载均衡策略非常多，HAProxy的负载均衡算法现在具体有如下8种： </p>
</li>
</ol>
<ul>
<li>roundrobin，表示简单的轮询，这个不多说，这个是负载均衡基本都具备的； </li>
<li>static-rr，表示根据权重，建议关注； </li>
<li>leastconn，表示最少连接者先处理，建议关注； </li>
<li>source，表示根据请求源IP，这个跟Nginx的IP_hash机制类似，我们用其作为解决session问题的一种方法，建议关注； </li>
<li>ri，表示根据请求的URI； </li>
<li>rl_param，表示根据请求的URl参数’balance url_param’ requires an URL parameter name； </li>
<li>hdr(name)，表示根据HTTP请求头来锁定每一次HTTP请求； </li>
<li>rdp-cookie(name)，表示根据据cookie(name)来锁定并哈希每一次TCP请求。</li>
</ul>
<h2 id="Nginx和LVS对比的总结："><a href="#Nginx和LVS对比的总结：" class="headerlink" title="Nginx和LVS对比的总结："></a>Nginx和LVS对比的总结：</h2><ol>
<li><p>Nginx工作在网络的7层，所以它可以针对http应用本身来做分流策略，比如针对域名、目录结构等，相比之下LVS并不具备这样的功能，所以Nginx单凭这点可利用的场合就远多于LVS了；但Nginx有用的这些功能使其可调整度要高于LVS，所以经常要去触碰触碰，触碰多了，人为出问题的几率也就会大。    </p>
</li>
<li><p>Nginx对网络稳定性的依赖较小，理论上只要ping得通，网页访问正常，Nginx就能连得通，这是Nginx的一大优势！Nginx同时还能区分内外网，如果是同时拥有内外网的节点，就相当于单机拥有了备份线路；LVS就比较依赖于网络环境，目前来看服务器在同一网段内并且LVS使用direct方式分流，效果较能得到保证。另外注意，LVS需要向托管商至少申请多一个ip来做Visual IP，貌似是不能用本身的IP来做VIP的。要做好LVS管理员，确实得跟进学习很多有关网络通信方面的知识，就不再是一个HTTP那么简单了。</p>
</li>
<li><p>Nginx安装和配置比较简单，测试起来也很方便，因为它基本能把错误用日志打印出来。LVS的安装和配置、测试就要花比较长的时间了；LVS对网络依赖比较大，很多时候不能配置成功都是因为网络问题而不是配置问题，出了问题要解决也相应的会麻烦得多。 </p>
</li>
<li><p>Nginx也同样能承受很高负载且稳定，但负载度和稳定度差LVS还有几个等级：Nginx处理所有流量所以受限于机器IO和配置；本身的bug也还是难以避免的。 </p>
</li>
<li><p>Nginx可以检测到服务器内部的故障，比如根据服务器处理网页返回的状态码、超时等等，并且会把返回错误的请求重新提交到另一个节点。目前LVS中 ldirectd也能支持针对服务器内部的情况来监控，但LVS的原理使其不能重发请求。比如用户正在上传一个文件，而处理该上传的节点刚好在上传过程中出现故障，Nginx会把上传切到另一台服务器重新处理，而LVS就直接断掉了，如果是上传一个很大的文件或者很重要的文件的话，用户可能会因此而恼火。 </p>
</li>
<li><p>Nginx对请求的异步处理可以帮助节点服务器减轻负载，假如使用 apache直接对外服务，那么出现很多的窄带链接时apache服务器将会占用大 量内存而不能释放，使用多一个Nginx做apache代理的话，这些窄带链接会被Nginx挡住，apache上就不会堆积过多的请求，这样就减少了相当多的资源占用。这点使用squid也有相同的作用，即使squid本身配置为不缓存，对apache还是有很大帮助的。 </p>
</li>
<li><p>Nginx能支持http、https和email（email的功能比较少用），LVS所支持的应用在这点上会比Nginx更多。在使用上，一般最前端所采取的策略应是LVS，也就是DNS的指向应为LVS均衡器，LVS的优点令它非常适合做这个任务。重要的ip地址，最好交由LVS托管，比如数据库的 ip、webservice服务器的ip等等，这些ip地址随着时间推移，使用面会越来越大，如果更换ip则故障会接踵而至。所以将这些重要ip交给 LVS托管是最为稳妥的，这样做的唯一缺点是需要的VIP数量会比较多。Nginx可作为LVS节点机器使用，一是可以利用Nginx的功能，二是可以利用Nginx的性能。当然这一层面也可以直接使用squid，squid的功能方面就比Nginx弱不少了，性能上也有所逊色于Nginx。Nginx也可作为中层代理使用，这一层面Nginx基本上无对手，唯一可以撼动Nginx的就只有lighttpd了，不过lighttpd目前还没有能做到 Nginx完全的功能，配置也不那么清晰易读。另外，中层代理的IP也是重要的，所以中层代理也拥有一个VIP和LVS是最完美的方案了。具体的应用还得具体分析，如果是比较小的网站（日PV小于1000万），用Nginx就完全可以了，如果机器也不少，可以用DNS轮询，LVS所耗费的机器还是比较多的；大型网站或者重要的服务，机器不发愁的时候，要多多考虑利用LVS。</p>
</li>
</ol>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;现在对网络负载均衡的使用是随着网站规模的提升根据不同的阶段来使用不同的技术：</p>
<ul>
<li><p>第一阶段：利用Nginx或HAProxy进行单点的负载均衡，这一阶段服务器规模刚脱离开单服务器、单数据库的模式，需要一定的负载均衡，但是仍然规模较小没有专业的维护团队来进行维护，也没有需要进行大规模的网站部署。这样利用Nginx或HAproxy就是第一选择，此时这些东西上手快， 配置容易，在七层之上利用HTTP协议就可以。这时是第一选择。</p>
</li>
<li><p>第二阶段：随着网络服务进一步扩大，这时单点的Nginx已经不能满足，这时使用LVS或者商用Array就是首要选择，Nginx此时就作为LVS或者Array的节点来使用，具体LVS或Array的是选择是根据公司规模和预算来选择，Array的应用交付功能非常强大，本人在某项目中使用过，性价比也远高于F5，商用首选，但是一般来说这阶段相关人才跟不上业务的提升，所以购买商业负载均衡已经成为了必经之路。</p>
</li>
<li><p>第三阶段：这时网络服务已经成为主流产品，此时随着公司知名度也进一步扩展，相关人才的能力以及数量也随之提升，这时无论从开发适合自身产品的定制，以及降低成本来讲开源的LVS，已经成为首选，这时LVS会成为主流。    </p>
</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;最终形成比较理想的基本架构为：Array/LVS — Nginx/Haproxy — Squid/Varnish — AppServer。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LVS/">LVS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/haproxy/">haproxy</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Nginx/32. nginx代理--根据访问的目录来区分后端的web" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Nginx/32. nginx代理--根据访问的目录来区分后端的web/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.737Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Nginx/32. nginx代理--根据访问的目录来区分后端的web/">
        nginx代理--根据访问的目录来区分后端的web
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;需求： 当请求的目录是 /aaa/ 则把请求发送到机器a，当请求的目录为/bbb/则把请求发送到机器b，除了目录/aaa/与目录/bbb/外，其他的请求发送到机器b</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;配置文件内容为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">upstream aaa.com</div><div class="line">&#123;</div><div class="line">        server 192.168.111.6;</div><div class="line">&#125;</div><div class="line">        upstream bbb.com</div><div class="line">&#123;</div><div class="line">        server 192.168.111.20;</div><div class="line">&#125;</div><div class="line">server &#123;</div><div class="line">        listen 80;</div><div class="line">        server_name li.com;</div><div class="line">        location /aaa/</div><div class="line">        &#123;</div><div class="line">        proxy_pass http://aaa.com/aaa/;</div><div class="line">        proxy_set_header Host <span class="variable">$host</span>;</div><div class="line">        proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</div><div class="line">        proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line">        &#125;</div><div class="line">location /bbb/</div><div class="line">        &#123;</div><div class="line">        proxy_pass http://bbb.com/bbb/;</div><div class="line">        proxy_set_header Host <span class="variable">$host</span>;</div><div class="line">        proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</div><div class="line">        proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line">        &#125;</div><div class="line">location /</div><div class="line">        &#123;</div><div class="line">        proxy_pass http://bbb.com/;</div><div class="line">        proxy_set_header Host <span class="variable">$host</span>;</div><div class="line">        proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</div><div class="line">        proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line">        &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明：</p>
<ol>
<li><p>以上配置文件中的 aaa.com 以及 bbb.com 都是自定义的，随便写。</p>
</li>
<li><p>upstream 中的server 可以写多个，例如</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">upstream aaa.com </div><div class="line">&#123;</div><div class="line">    server 192.168.111.6;</div><div class="line">    server 192.168.111.4;</div><div class="line">    server 192.168.111.5;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li><p>proxy_pass <a href="http://aaa.com/aaa/" target="_blank" rel="external">http://aaa.com/aaa/</a>  这里必须要加这个目录，不然就访问到根目录了。</p>
</li>
<li><p>实际上，上述配置文件中， localtion /bbb/ 部分是可以省略掉的，因为后边的 location /  已经包含了/bbb/，所以即使我们不去定义  localtion /bbb/ 也是会访问到 bbb.com 的。</p>
</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Nginx/31. nginx的负载均衡集群" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Nginx/31. nginx的负载均衡集群/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.736Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Nginx/31. nginx的负载均衡集群/">
        nginx的负载均衡和反向代理
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;之前提到过的 nginx 的负载均衡功能，实际上和 nginx 的代理是同一个功能，只是把之前代理一台机器改为代理多台机器而已。 nginx 的负载均衡和 lvs 相比， nginx 属于更该机的应用层，不牵扯到 IP 和内核的改动， 它只是单纯地把用户的请求转发到后面的机器上，这就意味着，后端的 RS 不需要配置公网 IP。</p>
<h2 id="1-环境说明"><a href="#1-环境说明" class="headerlink" title="1.环境说明"></a>1.环境说明</h2><ul>
<li>nginx 分发器（一个公网 ip 192.168.119.110 和一个内网 ip 192.168.0.67）</li>
<li>RS1 只有内网 ip（192.168.0.66）</li>
<li>RS2 只有内网 ip（192.168.0.65）</li>
</ul>
<h2 id="2-配置"><a href="#2-配置" class="headerlink" title="2.配置"></a>2.配置</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在 nginx 分发器上编辑配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@dir ~]<span class="comment"># vim /usr/local/nginx/conf/vhosts/lb.conf</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;加入内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">upstream <span class="built_in">test</span> &#123;</div><div class="line">    ip_hash;</div><div class="line">    server 192.168.0.66;</div><div class="line">    server 192.168.0.65;</div><div class="line">&#125;</div><div class="line">    server &#123;</div><div class="line">        listen 80;</div><div class="line">        server_name bbs.aaa.cn;</div><div class="line">        location / &#123;</div><div class="line">            proxy_pass http://<span class="built_in">test</span>/;</div><div class="line">            proxy_set_header Host <span class="variable">$host</span>;</div><div class="line">            proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</div><div class="line">            proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;说明：这个配置和 nginx 代理配置如出一辙，只是多了一个 upstream ，这个 upstream 用来定义后端的 RS ，可以只写一个。 ip_hash 为 nginx 的一种调度算法，加上这一行会达到这样的效果，即一个用户的请求会适中被分发到固定的一个 RS 上。这样的好处是，可以避免同一个用户的请求分发到不同的机器上而导致 session 丢失的情况。 upstream 里面，RS 后面的 ip 后面还可以加权重，比如 “server 192.168.0.66 weight=100;”。还有一点要注意， upstream 后面的 test 是自定义的一个名字，可以随便写，唯一的要求是要和 proxy_pass 后面保持一致。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;针对目录参考<a href="https://hcldirgit.github.io/2017/08/08/32.%20nginx%E4%BB%A3%E7%90%86--%E6%A0%B9%E6%8D%AE%E8%AE%BF%E9%97%AE%E7%9A%84%E7%9B%AE%E5%BD%95%E6%9D%A5%E5%8C%BA%E5%88%86%E5%90%8E%E7%AB%AF%E7%9A%84web/">nginx代理–根据访问的目录来区分后端的web</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Nginx/30. nginx的负载均衡和反向代理" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Nginx/30. nginx的负载均衡和反向代理/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.733Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Nginx/30. nginx的负载均衡和反向代理/">
        nginx的负载均衡和反向代理
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="负载均衡模块upstream："><a href="#负载均衡模块upstream：" class="headerlink" title="负载均衡模块upstream："></a>负载均衡模块upstream：</h2><p><img src="https://github.com/hcldirgit/image/blob/master/nginx%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%92%8C%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/01.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;nginx的负载均衡的算法：</p>
<ol>
<li>轮询（默认）</li>
<li>weight 权重轮询</li>
<li>ip_hash  每个请求按访问ip的hash结果分配，这样来自同一个ip的请求固定到后台的一段服务器上，有效的解决动态网页存在的session共享问题</li>
<li>fair 根据服务器的相应时间短来进行负载，需要安装nginx的upstream_fair模块</li>
<li>url_hash 根据url的hash结果分配，同一个url定向到同一后台服务器，提高缓存服务器的效率，需要安装nginx的hash包</li>
</ol>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注意：当负载均衡的算法是ip_hash时，后端服务器的在负载均衡的调度中的状态不是weight和backup</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;例如：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">upstream bakend &#123;  </div><div class="line">ip_hash;  </div><div class="line">server 192.168.0.14:88;  </div><div class="line">server 192.168.0.15:80;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;常用到的状态有：</p>
<ul>
<li>down， 表示server暂时不参与负载均衡</li>
<li>backup 备份机器</li>
<li>max_fails：应许请求失败的次数，默认为1，当超过最大次数是，返回proxy_next_upstream模块定义的错误</li>
<li>fail_timeout：经历了max_fails次失败后， 暂停服务的时间，max_fails可以和fail_timeout一起使用</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<strong>nginx对后端服务器的检查能力较弱，仅限于端口检查！</strong></p>
<h2 id="反向代理模块proxy："><a href="#反向代理模块proxy：" class="headerlink" title="反向代理模块proxy："></a>反向代理模块proxy：</h2><p><img src="https://github.com/hcldirgit/image/blob/master/nginx%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%92%8C%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/02.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;proxy_pass:http:url1要和upstream模块的url1对应；否则没法实现；</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;expires   过期时间：0为不过期</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;下面介绍http proxy模块中的相关指令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">proxy_next_upstream</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;语法： </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">proxy_next_upstream [error|timeout|invalid_header|http_500|http_502|http_503|http_504|http_404|off]</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;确定在何种情况下请求将转发到下一个服务器。转发请求只发生在没有数据传递到客户端的过程中。</p>
<ul>
<li><p>max_fails 允许请求失败的次数默认为1。当超过最大次数时，返回proxy_next_upstream 模块定义的错误</p>
</li>
<li><p>proxy_connect<em>timeout 后端服务器连接的超时时间</em>发起握手等候响应超时时间</p>
</li>
<li><p>proxy_read<em>timeout 连接成功后</em>等候后端服务器响应时间_其实已经进入后端的排队之中等候处理（也可以说是后端服务器处理请求的时间）</p>
</li>
<li><p>proxy_send<em>timeout 后端服务器数据回传时间</em>就是在规定时间之内后端服务器必须传完所有的数据</p>
</li>
<li><p>proxy_pass 这个指令设置被代理服务器的地址和被映射的URI</p>
</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Nginx/3. Apache和Nginx运行原理解析" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Nginx/3. Apache和Nginx运行原理解析/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.731Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Nginx/3. Apache和Nginx运行原理解析/">
        Apache和Nginx运行原理解析
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Web服务器"><a href="#Web服务器" class="headerlink" title="Web服务器"></a>Web服务器</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Web服务器也称为WWW(WORLD WIDE WEB)服务器，主要功能是提供网上信息浏览服务。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;应用层使用HTTP协议。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;HTML文档格式。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;浏览器统一资源定位器(URL)。<br>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Web服务器常常以B/S（Browser/Server）方式提供服务。浏览器和服务器的交互方式如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">GET /index.php HTTP/1.1</div><div class="line"></div><div class="line">+---------------+                   +----------------+</div><div class="line">|               +-------------------&gt;                |</div><div class="line">|   Browser     |                   |   Server       |</div><div class="line">|               &lt;-------------------+                |</div><div class="line">+---------------+                   +----------------+</div><div class="line"></div><div class="line">                  HTTP/1.1 200 OK</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;浏览器向服务器发出HTTP请求(Request)。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;服务器收到浏览器的请求数据，经过分析处理，向浏览器输出响应数据（Response）。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;浏览器收到服务器的响应数据，经过分析处理，将最终结果显示在浏览器中。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Apache和Nginx都属于Web服务器，两者都实现了HTTP 1.1协议。</p>
<h2 id="Apache-概述"><a href="#Apache-概述" class="headerlink" title="Apache 概述"></a>Apache 概述</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Apache HTTP Server是Apache软件基金会的一个开放源代码的网页服务器，可以在大多数计算机操作系统中运行，由于其跨平台和安全性。被广泛使用，是最流行的Web服务器端软件之一。它快速、可靠并且可通过简单的API扩充，将Perl／Python等解释器编译到服务器中。 – 维基百科</p>
<h3 id="Apache组件"><a href="#Apache组件" class="headerlink" title="Apache组件"></a>Apache组件</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Apache是基于模块化设计的，它的核心代码并不多，大多数的功能都被分散到各个模块中，各个模块在系统启动的时候按需载入。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="string">"text"</span>&gt;         +----------+</div><div class="line">      +- | Module   | -----------------+</div><div class="line">      |  +----------+                  |</div><div class="line">      |                          +------------+</div><div class="line">+-----------+   Apache HTTPD     | php module |</div><div class="line">| Module    |                    +------------+</div><div class="line">+-----------+              +----------+|</div><div class="line">      +----------+-------- |  MPM     |+</div><div class="line">                 |         +----+---+-+</div><div class="line">               +-v-----------+  |   |</div><div class="line">               |    ARP      &lt;--+   |</div><div class="line">               +------+------+      |</div><div class="line">                      |             |</div><div class="line">      +---------------v-------------v--+</div><div class="line">      |      Operating  System         |</div><div class="line">      +--------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;MPM（Multi -Processing Modules，多重处理模块）是Apache的核心组件之一，Apache通过MPM来使用操作系统的资源，对进程和线程池进行管理。Apache为了能够获得最好的运行性能，针对不同的平台 (Unix/Linux、Window)做了优化，为不同的平台提供了不同的MPM，用户可以根据实际情况进行选择，其中最常使用的MPM有 prefork和worker两种。至于您的服务器正以哪种方式运行，取决于安装Apache过程中指定的MPM编译参数,在X系统上默认的编译参数为 prefork。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;由于大多数的Unix都不支持真正的线程，所以采用了预派生子进程(prefork)方式，象Windows或者Solaris这些支持 线程的平台，基于多进程多线程混合的worker模式是一种不错的选择。Apache中还有一个重要的组件就是APR（Apache portable Runtime Library），即Apache可移植运行库，它是一个对操作系统调用的抽象库，用来实现Apache内部组件对操作系统的使用，提高系统的可移植性。 Apache对于php的解析，就是通过众多Module中的php Module来完成的。</p>
<h3 id="Apache生命周期"><a href="#Apache生命周期" class="headerlink" title="Apache生命周期"></a>Apache生命周期</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="string">"text"</span>&gt;   +--------------------------------------------------------------+</div><div class="line">   |                 +---------------------+       启动阶段        |</div><div class="line">   |                 |    系统启动, 配置     |                      |</div><div class="line">   |                 +----------+----------+                      |</div><div class="line">   |                            |                                 |</div><div class="line">   |                 +----------v----------+                      |</div><div class="line">   |                 |      模块的初始化     |                      |</div><div class="line">   |                 +-+--------+--------+-+                      |</div><div class="line">   |                   |        |        |                        |</div><div class="line">   |   +-------------+ | +------v-------+| +--------------+       |</div><div class="line">   |   | 子进程初始化  |&lt;+ | 子进程初始化   |+&gt;|  子进程初始化  |       |</div><div class="line">   |   +------+------+   +-------+------+  +-------+------+       |</div><div class="line">   +--------------------------------------------------------------+</div><div class="line">   |          |                  |                 |     运行阶段  |</div><div class="line">   |     +----v----+        +----v----+       +----v----+         |</div><div class="line">   |     | 请求循环 |        |  请求循环 |       | 请求循环 |         |</div><div class="line">   |     +----+----+        +----+----+       +----+----+         |</div><div class="line">   |          |                  |                 |              |</div><div class="line">   |   +------v------+    +------v------+   +------v------+       |</div><div class="line">   |   |  子进程结束   |    |  子进程结束  |   |   子进程结束  |       |</div><div class="line">   |   +-------------+    +-------------+   +-------------+       |</div><div class="line">   +--------------------------------------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这个生命周期是在perfork工作下的示意，从图中可以看出，Apache对于每一个请求都要启动一个单独的进程来处理。</p>
<h3 id="Apache的工作模式-prefork的工作原理"><a href="#Apache的工作模式-prefork的工作原理" class="headerlink" title="Apache的工作模式 prefork的工作原理"></a>Apache的工作模式 prefork的工作原理</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;一个单独的控制进程(父进程)负责产生子进程，这些子进程用于监听请求并作出应答。Apache总是试图保持一些备用的 (spare)或是空闲的子进程用于迎接即将到来的请求。这样客户端就无需在得到服务前等候子进程的产生。在Unix系统中，父进程通常以root身份运行以便邦定80端口，而 Apache产生的子进程通常以一个低特权的用户运行。User和Group指令用于配置子进程的低特权用户。运行子进程的用户必须要对他所服务的内容有读取的权限，但是对服务内容之外的其他资源必须拥有尽可能少的权限。</p>
<h3 id="worker的工作原理"><a href="#worker的工作原理" class="headerlink" title="worker的工作原理"></a>worker的工作原理</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;每个进程能够拥有的线程数量是固定的。服务器会根据负载情况增加或减少进程数量。一个单独的控制进程(父进程)负责子进程的建立。每个子进程能够建立ThreadsPerChild数量的服务线程和一个监听线程，该监听线程监听接入请求并将其传递给服务线程处理和应答。Apache总是试图维持一个备用(spare)或是空闲的服务线程池。这样，客户端无须等待新线程或新进程的建立即可得到处理。在Unix中，为了能够绑定80端口，父进程一般都是以root身份启动，随后，Apache以较低权限的用户建立子进程和线程。User和Group指令用于配置Apache子进程的权限。虽然子进程必须对其提供的内容拥有读权限，但应该尽可能给予他较少的特权。另外，除非使用了suexec ，否则，这些指令配置的权限将被CGI脚本所继承。</p>
<h3 id="Apache的运行-启动阶段"><a href="#Apache的运行-启动阶段" class="headerlink" title="Apache的运行 启动阶段"></a>Apache的运行 启动阶段</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在启动阶段，Apache主要进行配置文件解析(例如http.conf以及Include指令设定的配置文件等)、模块加载(例如modphp.so,modperl.so等)和系统资源初始化（例如日志文件、共享内存段等）工作。在这个阶段，Apache为了获得系统资源最大的使用权限，将以特权用户root（X系统）或超级管理员administrator(Windows系统)完成启动。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这个过程可以通过下图来深入了解：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="string">"text"</span>&gt;       +--------+</div><div class="line">       |  开始   |</div><div class="line">       +----+---+</div><div class="line">            |</div><div class="line"> +----------v------------+   解析主配置文件http.conf中配置信息，</div><div class="line"> |     解析配置文件        |   像LoadModule, AddType</div><div class="line"> +----------+------------+   等指令被加载至内存</div><div class="line">            |</div><div class="line"> +----------v------------+   依据AddModule, LoadModule等指令</div><div class="line"> |   加载静态/动态模块      |   加载Apache模块，像mod_php5.so被</div><div class="line"> +----------+------------+   加载至内存，映射到Apache地址空间。</div><div class="line">            |</div><div class="line"> +----------v------------+   日志文件、共享内存段，数据库链接</div><div class="line"> |     系统资源初始化      |    等初始化</div><div class="line"> +----------+------------+</div><div class="line">            |</div><div class="line">        +---v----+</div><div class="line">        |  结束   |</div><div class="line">        +--------+</div></pre></td></tr></table></figure>
<h3 id="运行阶段"><a href="#运行阶段" class="headerlink" title="运行阶段"></a>运行阶段</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在运行阶段，Apache主要工作是处理用户的服务请求。在这个阶段，Apache放弃特权用户级别，使用普通权限，这主要是基于安全性的考虑，防止由于代码的缺陷引起的安全漏洞。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;由于Apache的Hook机制，Apache 允许模块(包括内部模块和外部模块，例如mod_php5.so,mod_perl.so等)将自定义的函数注入到请求处理循环中。mod_php5.so/php5apache2.dll就是将所包含的自定义函数，通过Hook机制注入到Apache中，在Apache处理流程的各个阶段负责处理php请求。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Apache将请求处理循环分为11个阶段，依次是：Post-Read-Request，URI Translation，Header Parsing，Access Control，Authentication，Authorization，MIME Type Checking，FixUp，Response，Logging，CleanUp。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Apache处理http请求的生命周期:</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/Apache%E5%92%8CNginx%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/01.jpg?raw=true" alt=""></p>
<ul>
<li>Post-Read-Request阶段:在正常请求处理流程中，这是模块可以插入钩子的第一个阶段。对于那些想很早进入处理请求的模块来说，这个阶段可以被利用。</li>
<li>URI Translation阶段 : Apache在本阶段的主要工作：将请求的URL映射到本地文件系统。模块可以在这阶段插入钩子，执行自己的映射逻辑。mod_alias就是利用这个阶段工作的。</li>
<li>Header Parsing阶段 : Apache在本阶段的主要工作：检查请求的头部。由于模块可以在请求处理流程的任何一个点上执行检查请求头部的任务，因此这个钩子很少被使用。mod_setenvif就是利用这个阶段工作的。</li>
<li>Access Control阶段 : Apache在本阶段的主要工作：根据配置文件检查是否允许访问请求的资源。Apache的标准逻辑实现了允许和拒绝指令。modauthzhost就是利用这个阶段工作的。</li>
<li>Authentication阶段 : Apache在本阶段的主要工作：按照配置文件设定的策略对用户进行认证，并设定用户名区域。模块可以在这阶段插入钩子，实现一个认证方法。</li>
<li>Authorization阶段 : Apache在本阶段的主要工作：根据配置文件检查是否允许认证过的用户执行请求的操作。模块可以在这阶段插入钩子，实现一个用户权限管理的方法。</li>
<li>MIME Type Checking阶段 : Apache在本阶段的主要工作：根据请求资源的MIME类型的相关规则，判定将要使用的内容处理函数。标准模块modnegotiation和modmime实现了这个钩子。</li>
<li>FixUp阶段 : 这是一个通用的阶段，允许模块在内容生成器之前，运行任何必要的处理流程。和PostReadRequest类似，这是一个能够捕获任何信息的钩子，也是最常使用的钩子。</li>
<li>Response阶段 : Apache在本阶段的主要工作：生成返回客户端的内容，负责给客户端发送一个恰当的回复。这个阶段是整个处理流程的核心部分。</li>
<li>Logging阶段 : Apache在本阶段的主要工作：在回复已经发送给客户端之后记录事务。模块可能修改或者替换Apache的标准日志记录。</li>
<li>CleanUp阶段 : Apache在本阶段的主要工作：清理本次请求事务处理完成之后遗留的环境，比如文件、目录的处理或者Socket的关闭等等，这是Apache一次请求处理的最后一个阶段。</li>
</ul>
<h2 id="Nginx-概述"><a href="#Nginx-概述" class="headerlink" title="Nginx 概述"></a>Nginx 概述</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Nginx（发音同engine x）是一款由俄罗斯程序员Igor Sysoev所开发轻量级的网页服务器、反向代理服务器以及电子邮件（IMAP/POP3）代理服务器。起初是供俄国大型的门户网站及搜索引擎Rambler（俄语：Рамблер）使用。 – 维基百科</p>
<h3 id="Nginx的模块与工作原理"><a href="#Nginx的模块与工作原理" class="headerlink" title="Nginx的模块与工作原理"></a>Nginx的模块与工作原理</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Nginx由内核和模块组成，其中，内核的设计非常微小和简洁，完成的工作也非常简单，仅仅通过查找配置文件将客户端请求映射到一个location block（location是Nginx配置中的一个指令，用于URL匹配），而在这个location中所配置的每个指令将会启动不同的模块去完成相应的工作。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Nginx的模块从结构上分为核心模块、基础模块和第三方模块：</p>
<ul>
<li>核心模块：HTTP模块、EVENT模块和MAIL模块</li>
<li>基础模块：HTTP Access模块、HTTP FastCGI模块、HTTP Proxy模块和HTTP Rewrite模块，</li>
<li>第三方模块：HTTP Upstream Request Hash模块、Notice模块和HTTP Access Key模块。</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Nginx的模块从功能上分为如下三类:</p>
<ul>
<li>Handlers（处理器模块）。此类模块直接处理请求，并进行输出内容和修改headers信息等操作。Handlers处理器模块一般只能有一个。</li>
<li>Filters （过滤器模块）。此类模块主要对其他处理器模块输出的内容进行修改操作，最后由Nginx输出。</li>
<li>Proxies （代理类模块）。此类模块是Nginx的HTTP Upstream之类的模块，这些模块主要与后端一些服务比如FastCGI等进行交互，实现服务代理和负载均衡等功能。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="string">"text"</span>&gt;                     +                    ^</div><div class="line">        Http Request |                    |  Http Response</div><div class="line">                     |                    |</div><div class="line">    +---------+------v-----+         +----+----+</div><div class="line">    |  Conf   | Nginx Core |         | FilterN |</div><div class="line">    +---------+------+-----+         +----^----+</div><div class="line">                     |                    |</div><div class="line">                     |               +----+----+</div><div class="line">                     |               | Filter2 |</div><div class="line">choose a handler     |               +----^----+</div><div class="line">based conf           |                    |</div><div class="line">                     |               +----+----+</div><div class="line">                     |               | Filter1 |</div><div class="line">                     |               +----^----+</div><div class="line">                     |                    | Generate content</div><div class="line">               +-----v--------------------+----+</div><div class="line">               |           Handler             |</div><div class="line">               +-------------------------------+</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Nginx本身做的工作实际很少，当它接到一个HTTP请求时，它仅仅是通过查找配置文件将此次请求映射到一个location block，而此location中所配置的各个指令则会启动不同的模块去完成工作，因此模块可以看做Nginx真正的劳动工作者。通常一个location中的指令会涉及一个handler模块和多个filter模块（当然，多个location可以复用同一个模块）。handler模块负责处理请求，完成响应内容的生成，而filter模块对响应内容进行处理。</p>
<h3 id="Nginx架构及工作流程"><a href="#Nginx架构及工作流程" class="headerlink" title="Nginx架构及工作流程"></a>Nginx架构及工作流程</h3><p><img src="https://github.com/hcldirgit/image/blob/master/Apache%E5%92%8CNginx%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/02.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;上图是Nginx的架构，这个架构类似于Apache的Worker工作状态，Nginx的每一个Worker进程都管理着大量的线程，真正处理请求的是Worker之下的线程。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;所有实际上的业务处理逻辑都在worker进程。worker进程中有一个函数，执行无限循环，不断处理收到的来自客户端的请求，并进行处理，直到整个nginx服务被停止。Worker中这个函数执行内容如下：</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;操作系统提供的机制（例如epoll, kqueue等）产生相关的事件。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;接收和处理这些事件，如是接受到数据，则产生更高层的request对象。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;处理request的header和body。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;产生响应，并发送回客户端。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;完成request的处理。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;重新初始化定时器及其他事件。</p>
<h3 id="Nginx和FastCGI-FastCGI"><a href="#Nginx和FastCGI-FastCGI" class="headerlink" title="Nginx和FastCGI FastCGI"></a>Nginx和FastCGI FastCGI</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;FastCGI是一个可伸缩地、高速地在HTTP server和动态脚本语言间通信的接口。多数流行的HTTP server都支持FastCGI，包括Apache、Nginx和lighttpd等。同时，FastCGI也被许多脚本语言支持，其中就有PHP。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;FastCGI是从CGI发展改进而来的。传统CGI接口方式的主要缺点是性能很差，因为每次HTTP服务器遇到动态程序时都需要重新启动脚本解析器来执行解析，然后将结果返回给HTTP服务器。这在处理高并发访问时几乎是不可用的。另外传统的CGI接口方式安全性也很差，现在已经很少使用了。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;FastCGI接口方式采用C/S结构，可以将HTTP服务器和脚本解析服务器分开，同时在脚本解析服务器上启动一个或者多个脚本解析守护进程。当HTTP服务器每次遇到动态程序时，可以将其直接交付给FastCGI进程来执行，然后将得到的结果返回给浏览器。这种方式可以让HTTP服务器专一地处理静态请求或者将动态脚本服务器的结果返回给客户端，这在很大程度上提高了整个应用系统的性能。</p>
<h3 id="Nging和FastCGI合作"><a href="#Nging和FastCGI合作" class="headerlink" title="Nging和FastCGI合作"></a>Nging和FastCGI合作</h3><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Nginx不支持对外部程序的直接调用或者解析，所有的外部程序（包括PHP）必须通过FastCGI接口来调用。FastCGI接口在Linux下是socket（这个socket可以是文件socket，也可以是ip socket）。接下来以Nginx下PHP的运行过程来说明。PHP-FPM是管理FastCGI的一个管理器，它作为PHP的插件存在。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;FastCGI进程管理器php-fpm自身初始化，启动主进程php-fpm和启动start_servers个CGI 子进程。主进程php-fpm主要是管理fastcgi子进程，监听9000端口。fastcgi子进程等待来自Web Server的连接。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;当客户端请求到达Web Server Nginx是时，Nginx通过location指令，将所有以php为后缀的文件都交给127.0.0.1:9000来处理，即Nginx通过location指令，将所有以php为后缀的文件都交给127.0.0.1:9000来处理。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;FastCGI进程管理器PHP-FPM选择并连接到一个子进程CGI解释器。Web server将CGI环境变量和标准输入发送到FastCGI子进程。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;FastCGI子进程完成处理后将标准输出和错误信息从同一连接返回Web Server。当FastCGI子进程关闭连接时，请求便告处理完成。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;FastCGI子进程接着等待并处理来自FastCGI进程管理器（运行在 WebServer中）的下一个连接。</p>
<h2 id="Apache和Nginx比较-功能对比"><a href="#Apache和Nginx比较-功能对比" class="headerlink" title="Apache和Nginx比较 功能对比"></a>Apache和Nginx比较 功能对比</h2><ul>
<li><p>Nginx和Apache一样，都是HTTP服务器软件，在功能实现上都采用模块化结构设计，都支持通用的语言接口，如PHP、Perl、Python等，同时还支持正向和反向代理、虚拟主机、URL重写、压缩传输、SSL加密传输等。</p>
</li>
<li><p>在功能实现上，Apache的所有模块都支持动、静态编译，而Nginx模块都是静态编译的，</p>
</li>
<li><p>对FastCGI的支持，Apache对Fcgi的支持不好，而Nginx对Fcgi的支持非常好；</p>
</li>
<li><p>在处理连接方式上，Nginx支持epoll，而Apache却不支持；</p>
</li>
<li><p>在空间使用上，Nginx安装包仅仅只有几百K，和Nginx比起来Apache绝对是庞然大物。</p>
</li>
</ul>
<h2 id="Nginx相对Apache的优点"><a href="#Nginx相对Apache的优点" class="headerlink" title="Nginx相对Apache的优点"></a>Nginx相对Apache的优点</h2><ul>
<li><p>轻量级，同样起web 服务，比apache 占用更少的内存及资源</p>
</li>
<li><p>静态处理，Nginx 静态处理性能比 Apache 高 3倍以上</p>
</li>
<li><p>抗并发，nginx 处理请求是异步非阻塞的，而apache则是阻塞型的，在高并发下nginx 能保持低资源低消耗高性能。在Apache+PHP（prefork）模式下，如果PHP处理慢或者前端压力很大的情况下，很容易出现Apache进程数飙升，从而拒绝服务的现象。</p>
</li>
<li><p>高度模块化的设计，编写模块相对简单</p>
</li>
<li><p>社区活跃，各种高性能模块出品迅速啊</p>
</li>
</ul>
<h2 id="Apache相对Nginx的优点"><a href="#Apache相对Nginx的优点" class="headerlink" title="Apache相对Nginx的优点"></a>Apache相对Nginx的优点</h2><ul>
<li><p>;rewrite，比nginx 的rewrite 强大</p>
</li>
<li><p>模块超多，基本想到的都可以找到</p>
</li>
<li><p>少bug，nginx的bug相对较多</p>
</li>
<li><p>超稳定</p>
</li>
<li><p>Apache对PHP支持比较简单，Nginx需要配合其他后端用</p>
</li>
</ul>
<h2 id="选择Nginx的优势所在"><a href="#选择Nginx的优势所在" class="headerlink" title="选择Nginx的优势所在"></a>选择Nginx的优势所在</h2><ul>
<li><p>作为Web服务器: Nginx处理静态文件、索引文件，自动索引的效率非常高。</p>
</li>
<li><p>作为代理服务器，Nginx可以实现无缓存的反向代理加速，提高网站运行速度。</p>
</li>
<li><p>作为负载均衡服务器，Nginx既可以在内部直接支持Rails和PHP，也可以支持HTTP代理服务器对外进行服务，同时还支持简单的容错和利用算法进行负载均衡。</p>
</li>
<li><p>在性能方面，Nginx是专门为性能优化而开发的，在实现上非常注重效率。它采用内核Poll模型(epoll and kqueue )，可以支持更多的并发连接，最大可以支持对50 000个并发连接数的响应，而且只占用很低的内存资源。</p>
</li>
<li><p>在稳定性方面，Nginx采取了分阶段资源分配技术，使得CPU与内存的占用率非常低。Nginx官方表示，Nginx保持10 000个没有活动的连接，而这些连接只占用2.5MB内存，因此，类似DOS这样的攻击对Nginx来说基本上是没有任何作用的。</p>
</li>
<li><p>在高可用性方面，Nginx支持热部署，启动速度特别迅速，因此可以在不间断服务的情况下，对软件版本或者配置进行升级，即使运行数月也无需重新启动，几乎可以做到7×24小时不间断地运行。</p>
</li>
</ul>
<h2 id="同时使用Nginx和Apache"><a href="#同时使用Nginx和Apache" class="headerlink" title="同时使用Nginx和Apache"></a>同时使用Nginx和Apache</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;由于Nginx和Apache各自的优势，现在很多人选择了让两者在服务器中共存。在服务器端让Nginx在前，Apache在后。由Nginx做负载均衡和反向代理，并且处理静态文件，讲动态请求（如PHP应用）交给Apache去处理。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LNMP/">LNMP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Nginx/29. nginx中location的规则" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Nginx/29. nginx中location的规则/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.728Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Nginx/29. nginx中location的规则/">
        nginx中location的规则
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="语法规则"><a href="#语法规则" class="headerlink" title="语法规则"></a>语法规则</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">location [=|~|~*|^~] /uri/ &#123; … &#125;</div></pre></td></tr></table></figure>
<ul>
<li>= 开头表示精确匹配</li>
<li>^~ 开头表示uri以某个常规字符串开头，不是正则匹配。#^~表示普通字符匹配，如果该选项匹配，只匹配该选项，不匹配别的选项，一般用来匹配目录。nginx不对url做编码，因此请求为/static/20%/aa，可以被规则^~ /static/ /aa匹配到（注意是空格）。</li>
<li>~ 开头表示区分大小写的正则匹配</li>
<li>~*  开头表示不区分大小写的正则匹配</li>
<li>!~和!~*分别为区分大小写不匹配及不区分大小写不匹配 的正则</li>
<li>/ 通用匹配，任何请求都会匹配到。</li>
<li>@     #”@” 定义一个命名的 location，使用在内部定向时，例如 error_page, try_files如 error_page, try_files</li>
</ul>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;多个location配置的情况下匹配顺序为：</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;首先匹配 =，其次匹配^~, 其次是按文件中顺序的正则匹配，最后是交给 / 通用匹配。当有匹配成功时候，停止匹配，按当前匹配规则处理请求。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;”@”不能通过外部输入的url匹配<br>~ 这个指正则匹配</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;例子，有如下匹配规则：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">location = / &#123;精确匹配，必须是127.0.0.1/</div><div class="line"><span class="comment">#规则A</span></div><div class="line">&#125;</div><div class="line">location = /login &#123;精确匹配，必须是127.0.0.1/login</div><div class="line"><span class="comment">#规则B</span></div><div class="line">&#125;</div><div class="line">location ^~ /static/ &#123;非精确匹配，并且不区分大小写，比如127.0.0.1/static/js.</div><div class="line"><span class="comment">#规则C</span></div><div class="line">&#125;</div><div class="line">location ~ .(gif|jpg|png|js|css)$ &#123;区分大小写，以gif,jpg,js结尾</div><div class="line"><span class="comment">#规则D</span></div><div class="line">&#125;</div><div class="line">location ~* .png$ &#123;不区分大小写，匹配.png结尾的</div><div class="line"><span class="comment">#规则E</span></div><div class="line">&#125;</div><div class="line">location !~ .xhtml$ &#123;区分大小写，匹配不已.xhtml结尾的</div><div class="line"><span class="comment">#规则F</span></div><div class="line">&#125;</div><div class="line">location !~* .xhtml$ &#123;</div><div class="line"><span class="comment">#规则G</span></div><div class="line">&#125;</div><div class="line">location / &#123;什么都可以</div><div class="line"><span class="comment">#规则H</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="静态文件不记录日志，配置缓存"><a href="#静态文件不记录日志，配置缓存" class="headerlink" title="静态文件不记录日志，配置缓存"></a>静态文件不记录日志，配置缓存</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$</div><div class="line">&#123;</div><div class="line">        expires      30d;</div><div class="line">        access_log off;</div><div class="line">&#125;</div><div class="line"></div><div class="line">location ~ .*\.(js|css)$</div><div class="line"> &#123;</div><div class="line">        expires      12h;</div><div class="line">        access_log off;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LNMP/">LNMP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Nginx/28. 深入理解PHP之：Nginx 与 FPM 的工作机制" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Nginx/28. 深入理解PHP之：Nginx 与 FPM 的工作机制/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.727Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Nginx/28. 深入理解PHP之：Nginx 与 FPM 的工作机制/">
        深入理解PHP之：Nginx 与 FPM 的工作机制
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;网络上有很多关于如何配置 Nginx + FPM 的文章，但它们更多从操作的角度出发，告诉我们怎么做，但却没有告诉我们为什么要这么做，本文从 Nginx 与 FPM 的工作机制出发，探讨配置背后的原理，让我们真正理解 Nginx 与 PHP 是如何协同工作的。要说 Nginx 与 PHP 是如何协同工作的，首先得说 CGI (Common Gateway Interface) 和 FastCGI 这两个协议。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;CGI 是 Web Server 与后台语言交互的协议，有了这个协议，开发者可以使用任何语言处理 Web Server 发来的请求，动态的生成内容。但 CGI 有一个致命的缺点，那就是每处理一个请求都需要 fork 一个全新的进程，随着 Web 的兴起，高并发越来越成为常态， 这样低效的方式明显不能满足需求。就这样，FastCGI 诞生了，CGI 很快就退出了历史的 舞台。FastCGI，顾名思义为更快的 CGI，它允许在一个进程内处理多个请求，而不是一个 请求处理完毕就直接结束进程，性能上有了很大的提高。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;至于 FPM (FastCGI Process Manager)，它是 FastCGI 的实现，任何实现了 FastCGI 协议的 Web Server 都能够与之通信。FPM 之于标准的 FastCGI，也提供了一些增强功能，具体可以参考官方文档：PHP: FPM Installation。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;FPM 是一个 PHP 进程管理器，包含 master 进程和 worker 进程两种进程：master 进程只有一个，负责监听端口，接收来自 Web Server 的请求，而 worker 进程则一般有多个 (具体数量根据实际需要配置)，每个进程内部都嵌入了一个 PHP 解释器，是 PHP 代码真正执行的地方，下图是我本机上 fpm 的进程情况，1一个 master 进程，3个 worker 进程：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3PHP%E4%B9%8B%EF%BC%9ANginx%20%E4%B8%8E%20FPM%20%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6/01.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;从 FPM 接收到请求，到处理完毕，其具体的流程如下：</p>
<ol>
<li>FPM 的 master 进程接收到请求</li>
<li>master 进程根据配置指派特定的 worker 进程进行请求处理，如果没有可用进程，返回错误，这也是我们配合 Nginx 遇到502错误比较多的原因。</li>
<li>worker 进程处理请求，如果超时，返回504错误</li>
<li>请求处理结束，返回结果</li>
</ol>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;FPM 从接收到处理请求的流程就是这样了，那么 Nginx 又是如何发送请求给 fpm 的呢？这就需要从 Nginx 层面来说明了。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;我们知道，Nginx 不仅仅是一个 Web 服务器，也是一个功能强大的 Proxy 服务器，除了进行 http 请求的代理，也可以进行许多其他协议请求的代理，包括本文与 fpm 相关的 fastcgi 协议。为了能够使 Nginx 理解 fastcgi 协议，Nginx 提供了 fastcgi 模块来将 http 请求映射为对应的 fastcgi 请求。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Nginx 的 fastcgi 模块提供了 fastcgi_param 指令来主要处理这些映射关系，下面 Ubuntu 下 Nginx 的一个配置文件，其主要完成的工作是将 Nginx 中的变量翻译成 PHP 中能够理解的变量。</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3PHP%E4%B9%8B%EF%BC%9ANginx%20%E4%B8%8E%20FPM%20%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6/02.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;除此之外，非常重要的就是 fastcgi_pass 指令了，这个指令用于指定 fpm 进程监听的地址，Nginx 会把所有的 php 请求翻译成 fastcgi 请求之后再发送到这个地址。下面一个简单的可以工作的 Nginx 配置文件：</p>
<p><img src="https://github.com/hcldirgit/image/blob/master/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3PHP%E4%B9%8B%EF%BC%9ANginx%20%E4%B8%8E%20FPM%20%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6/03.png?raw=true" alt=""></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在这个配置文件中，我们新建了一个虚拟主机，监听在 80 端口，Web 根目录为 /home/rf/projects/wordpress。然后我们通过 location 指令，将所有的以 .php 结尾的请求都交给 fastcgi 模块处理，从而把所有的 php 请求都交给了 fpm 处理，从而完成  Nginx 到 fpm 的闭环。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;如此以来，Nginx 与 FPM 通信的整个流程应该比较清晰了吧。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;查看php-fpm.conf的配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@192 etc]<span class="comment"># cat php-fpm.conf |grep -v '^;' |grep -v '^$' |grep -v "^ "</span></div><div class="line">[global]</div><div class="line">[www]</div><div class="line">user = php-fpm</div><div class="line">group = php-fpm</div><div class="line">listen = 127.0.0.1:9000</div><div class="line">pm = dynamic</div><div class="line">pm.max_children = 5</div><div class="line">pm.start_servers = 2</div><div class="line">pm.min_spare_servers = 1</div><div class="line">pm.max_spare_servers = 3</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;慢执行日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">slowlog = /path/to/slow.log</div><div class="line">request_slowlog_timeout = 1</div><div class="line"></div><div class="line">open_basedir</div><div class="line">php_admin_value[open_basedir]=/data/www/:/tmp/</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LNMP/">LNMP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Nginx/27. Nginx：承受3万并发连接数，胜过Apache 10倍" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/03/Nginx/27. Nginx：承受3万并发连接数，胜过Apache 10倍/" class="article-date">
  	<time datetime="2017-09-02T18:06:42.726Z" itemprop="datePublished">2017-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/03/Nginx/27. Nginx：承受3万并发连接数，胜过Apache 10倍/">
        Nginx：承受3万并发连接数，胜过Apache 10倍
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Nginx是目前比较重要的开源性负载均衡技术，新浪、网易、六间房等很多网站都将Nginx部署进自己的网站系统架构，并解决部分问题。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;本文是关于搭建“Nginx + PHP（FastCGI）”Web服务器的第4篇文章。本系列文章作为国内最早详细介绍 Nginx + PHP 安装、配置、使用的资料之一，为推动 Nginx 在国内的发展产生了积极的作用。</p>
<h2 id="众网站纷纷重视Nginx"><a href="#众网站纷纷重视Nginx" class="headerlink" title="众网站纷纷重视Nginx"></a>众网站纷纷重视Nginx</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这是一篇关于Nginx 0.7.x系列版本的文章，安装、配置方式与第3篇文章相差不大，但配置参数有不同。Nginx 0.7.x系列版本虽然为开发版，但在很多大型网站的生产环境中已经使用。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Nginx (“engine x”) 是一个高性能的 HTTP 和反向代理服务器，也是一个 IMAP/POP3/SMTP 代理服务器。 Nginx 是由 Igor Sysoev 为俄罗斯访问量第二的 Rambler.ru 站点开发的，它已经在该站点运行超过两年半了。Igor 将源代码以类BSD许可证的形式发布。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Nginx 超越 Apache 的高性能和稳定性，使得国内使用 Nginx 作为 Web 服务器的网站也越来越多，其中包括新浪博客、新浪播客、网易新闻等门户网站频道，六间房、56.com等视频分享网站，Discuz!官方论坛、水木社区等知名论坛，豆瓣、YUPOO相册、海内SNS、迅雷在线等新兴Web 2.0网站。</p>
<h2 id="Nginx：承受3万并发连接数，胜过Apache-10倍"><a href="#Nginx：承受3万并发连接数，胜过Apache-10倍" class="headerlink" title="Nginx：承受3万并发连接数，胜过Apache 10倍"></a>Nginx：承受3万并发连接数，胜过Apache 10倍</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在高并发连接的情况下，Nginx是Apache服务器不错的替代品。Nginx同时也可以作为7层负载均衡服务器来使用。根据我的测试结果，Nginx 0.7.14 + PHP 5.2.6 (FastCGI) 可以承受3万以上的并发连接数，相当于同等环境下Apache的10倍。<br>根据我的经验，4GB内存的服务器+Apache（prefork模式）一般只能处理3000个并发连接，因为它们将占用3GB以上的内存，还得为系统预留1GB的内存。我曾经就有两台Apache服务器，因为在配置文件中设置的MaxClients为4000，当Apache并发连接数达到3800时，导致服务器内存和Swap空间用满而崩溃。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;而这台 Nginx 0.7.14 + PHP 5.2.6 (FastCGI) 服务器在3万并发连接下，开启的10个 Nginx进程消耗150M内存（15M<em>10=150M），开启的64个php-cgi进程消耗1280M内存 （20M</em>64=1280M），加上系统自身消耗的内存，总共消耗不到2GB内存。如果服务器内存较小，完全可以只开启25个php-cgi进程，这样php-cgi消耗的总内存数才500M。</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在3万并发连接下，访问Nginx 0.7.14 + PHP 5.2.6 (FastCGI) 服务器的PHP程序，仍然速度飞快。下图为Nginx的状态监控页面，显示的活动连接数为28457（关于Nginx的监控页配置，会在本文接下来所给出的Nginx配置文件中写明）：</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;生产环境下的两台Nginx + PHP5（FastCGI）服务器，跑多个一般复杂的纯PHP动态程序，单台Nginx + PHP5（FastCGI）服务器跑PHP动态程序的处理能力已经超过“700次请求/秒”，相当于每天可以承受6000万（700<em>60</em>60*24=60480000）的访问量（更多信息见此），而服务器的系统负载也不高：</p>
<h2 id="如何获取相关开源程序？"><a href="#如何获取相关开源程序？" class="headerlink" title="如何获取相关开源程序？"></a>如何获取相关开源程序？</h2><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;安装步骤：</p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;（系统要求：Linux 2.6+ 内核，本文中的Linux操作系统为CentOS 5.1，另在RedHat AS4上也安装成功）</p>
<h3 id="一、获取相关开源程序："><a href="#一、获取相关开源程序：" class="headerlink" title="一、获取相关开源程序："></a>一、获取相关开源程序：</h3><ol>
<li>利用CentOS Linux系统自带的yum命令安装、升级所需的程序库（RedHat等其他Linux发行版可从安装光盘中找到这些程序库的RPM包，进行安装）：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo -s</div><div class="line">LANG=C</div><div class="line">yum -y install gcc gcc-c++ autoconf libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel libxml2 libxml2-devel zlib zlib-devel glibc glibc-devel glib2 glib2-devel bzip2 bzip2-devel ncurses ncurses-devel curl curl-devel</div></pre></td></tr></table></figure>
<ol>
<li>RedHat等其他Linux发行版可从安装光盘中找到这些程序库的RPM包（事先可通过类似“rpm -qa | grep libjpeg”的命令查看所需的RPM包是否存在，通常是“xxx-devel”不存在，需要安装）。RedHat可以直接利用CentOS的RPM包安装，以下是RPM包下载网址：</li>
</ol>
<ul>
<li>RedHat AS4 &amp; CentOS 4<br><a href="http://mirror.be10.com/centos/4/os/i386/CentOS/RPMS/" target="_blank" rel="external">http://mirror.be10.com/centos/4/os/i386/CentOS/RPMS/</a><br><a href="http://mirror.be10.com/centos/4/os/x86_64/CentOS/RPMS/" target="_blank" rel="external">http://mirror.be10.com/centos/4/os/x86_64/CentOS/RPMS/</a> </li>
<li>RedHat AS5 &amp; CentOS 5<br><a href="http://mirror.be10.com/centos/5/os/i386/CentOS/" target="_blank" rel="external">http://mirror.be10.com/centos/5/os/i386/CentOS/</a><br><a href="http://mirror.be10.com/centos/5/os/x86_64/CentOS/" target="_blank" rel="external">http://mirror.be10.com/centos/5/os/x86_64/CentOS/</a> </li>
<li>RPM包搜索网站<br><a href="http://rpm.pbone.net/" target="_blank" rel="external">http://rpm.pbone.net/</a><br><a href="http://www.rpmfind.net/" target="_blank" rel="external">http://www.rpmfind.net/</a></li>
</ul>
<ol>
<li>下载程序源码包：</li>
</ol>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;本文中提到的所有开源软件为截止到2008年8月28日的最新稳定版。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">mkdir -p /data0/software</div><div class="line"><span class="built_in">cd</span> /data0/software</div><div class="line">wget http://sysoev.ru/nginx/nginx-0.7.14.tar.gz</div><div class="line">wget http://www.php.net/get/php-5.2.6.tar.gz/from/this/mirror</div><div class="line">wget http://php-fpm.anight.org/downloads/head/php-5.2.6-fpm-0.5.8.diff.gz</div><div class="line"><span class="comment">#wget http://dev.mysql.com/get/Downloads/MySQL-5.1/mysql-5.1.26-rc.tar.gz/from/http://mirror.x10.com/mirror/mysql/</span></div><div class="line">wget linux/mysql/mysql-5.1.26-rc.tar.gz<span class="string">"&gt;http://blog.s135.com/soft/linux/mysql/mysql-5.1.26-rc.tar.gz</span></div><div class="line"><span class="string">wget http://ftp.gnu.org/pub/gnu/libiconv/libiconv-1.12.tar.gz</span></div><div class="line"><span class="string">#wget "</span>http://downloads.sourceforge.net/mcrypt/libmcrypt-2.5.8.tar.gz?modtime=1171868460&amp;big_mirror=0<span class="string">"</span></div><div class="line"><span class="string">wget http://mirror.optus.net/sourceforge/m/mc/mcrypt/libmcrypt-2.5.8.tar.gz</span></div><div class="line"><span class="string">#wget "</span>http://downloads.sourceforge.net/mcrypt/mcrypt-2.6.7.tar.gz?modtime=1194463373&amp;big_mirror=0<span class="string">"</span></div><div class="line"><span class="string">wget http://mirror.optus.net/sourceforge/m/mc/mcrypt/mcrypt-2.6.7.tar.gz</span></div><div class="line"><span class="string">wget http://pecl.php.net/get/memcache-2.2.3.tgz</span></div><div class="line"><span class="string">#wget "</span>http://downloads.sourceforge.net/mhash/mhash-0.9.9.tar.gz?modtime=1175740843&amp;big_mirror=0<span class="string">"</span></div><div class="line"><span class="string">wget http://mirror.optus.net/sourceforge/m/mh/mhash/mhash-0.9.9.tar.gz</span></div><div class="line"><span class="string">wget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-7.7.tar.gz</span></div><div class="line"><span class="string">wget http://bart.eaccelerator.net/source/0.9.5.3/eaccelerator-0.9.5.3.tar.bz2</span></div></pre></td></tr></table></figure>
<h3 id="二、PHP5安装、配置内容-安装PHP-5-2-6（FastCGI模式）"><a href="#二、PHP5安装、配置内容-安装PHP-5-2-6（FastCGI模式）" class="headerlink" title="二、PHP5安装、配置内容,安装PHP 5.2.6（FastCGI模式）"></a>二、PHP5安装、配置内容,安装PHP 5.2.6（FastCGI模式）</h3><ol>
<li>编译安装PHP 5.2.6所需的支持库：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">tar zxvf libiconv-1.12.tar.gz</div><div class="line"><span class="built_in">cd</span> libiconv-1.12/</div><div class="line">./configure --prefix=/usr/<span class="built_in">local</span></div><div class="line">make</div><div class="line">make install</div><div class="line"><span class="built_in">cd</span> ../tar zxvf libmcrypt-2.5.8.tar.gz</div><div class="line"><span class="built_in">cd</span> libmcrypt-2.5.8/</div><div class="line">./configure</div><div class="line">make</div><div class="line">make install</div><div class="line">/sbin/ldconfig</div><div class="line"><span class="built_in">cd</span> libltdl/</div><div class="line">./configure --<span class="built_in">enable</span>-ltdl-install</div><div class="line">make</div><div class="line">make install</div><div class="line"><span class="built_in">cd</span> ../../</div><div class="line">tar zxvf mhash-0.9.9.tar.gz</div><div class="line"><span class="built_in">cd</span> mhash-0.9.9/</div><div class="line">./configure</div><div class="line">make</div><div class="line">make install</div><div class="line"><span class="built_in">cd</span> ../</div><div class="line">cp /usr/<span class="built_in">local</span>/lib/libmcrypt.* /usr/lib</div><div class="line">ln -s /usr/<span class="built_in">local</span>/lib/libmhash.so.2 /usr/lib/libmhash.so.2</div><div class="line">tar zxvf mcrypt-2.6.7.tar.gz</div><div class="line"><span class="built_in">cd</span> mcrypt-2.6.7/</div><div class="line">./configure</div><div class="line">make</div><div class="line">make install</div><div class="line"><span class="built_in">cd</span> ../</div></pre></td></tr></table></figure>
<ol>
<li>编译安装MySQL 5.1.26-rc</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">/usr/sbin/groupadd mysql</div><div class="line">/usr/sbin/useradd -g mysql mysql</div><div class="line">tar zxvf mysql-5.1.26-rc.tar.gz</div><div class="line"><span class="built_in">cd</span> mysql-5.1.26-rc/</div><div class="line">./configure --prefix=/usr/<span class="built_in">local</span>/webserver/mysql/ --<span class="built_in">enable</span>-assembler --with-extra-charsets=complex --<span class="built_in">enable</span>-thread-safe-client --with-big-tables --with-readline --with-ssl --with-embedded-server --<span class="built_in">enable</span>-local-infile</div><div class="line">make &amp;&amp; make install</div><div class="line">chmod +w /usr/<span class="built_in">local</span>/webserver/mysql</div><div class="line">chown -R mysql:mysql /usr/<span class="built_in">local</span>/webserver/mysql</div><div class="line">cp support-files/my-medium.cnf /usr/<span class="built_in">local</span>/webserver/mysql/my.cnf</div><div class="line"><span class="built_in">cd</span> ../</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;附：以下为附加步骤，如果你想在这台服务器上运行MySQL数据库，则执行以下两步。如果你只是希望让PHP支持MySQL扩展库，能够连接其他服务器上的MySQL数据库，那么，以下两步无需执行。</p>
<ul>
<li>以mysql用户帐号的身份建立数据表：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/<span class="built_in">local</span>/webserver/mysql/bin/mysql_install_db --defaults-file=/usr/<span class="built_in">local</span>/webserver/mysql/my.cnf --basedir=/usr/<span class="built_in">local</span>/webserver/mysql --datadir=/usr/<span class="built_in">local</span>/webserver/mysql/data --user=mysql --pid-file=/usr/<span class="built_in">local</span>/webserver/mysql/mysql.pid --skip-locking --port=3306 --socket=/tmp/mysql.sock</div></pre></td></tr></table></figure>
<ul>
<li>启动MySQL（最后的&amp;表示在后台运行）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/bin/sh /usr/local/webserver/mysql/bin/mysqld_safe --defaults-file=/usr/local/webserver/mysql/my.cnf &amp;</div></pre></td></tr></table></figure>
<ol>
<li>编译安装PHP（FastCGI模式）</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">tar zxvf php-5.2.6.tar.gz</div><div class="line">gzip -<span class="built_in">cd</span> php-5.2.6-fpm-0.5.8.diff.gz | patch -d php-5.2.6 -p1</div><div class="line"><span class="built_in">cd</span> php-5.2.6/</div><div class="line">./configure --prefix=/usr/<span class="built_in">local</span>/webserver/php --with-config-file-path=/usr/<span class="built_in">local</span>/webserver/php/etc --with-mysql=/usr/<span class="built_in">local</span>/webserver/mysql --with-mysqli=/usr/<span class="built_in">local</span>/webserver/mysql/bin/mysql_config --with-iconv-dir=/usr/<span class="built_in">local</span> --with-freetype-dir --with-jpeg-dir --with-png-dir --with-zlib --with-libxml-dir=/usr --<span class="built_in">enable</span>-xml --<span class="built_in">disable</span>-rpath --<span class="built_in">enable</span>-discard-path --<span class="built_in">enable</span>-safe-mode --<span class="built_in">enable</span>-bcmath --<span class="built_in">enable</span>-shmop --<span class="built_in">enable</span>-sysvsem --<span class="built_in">enable</span>-inline-optimization --with-curl --with-curlwrappers --<span class="built_in">enable</span>-mbregex --<span class="built_in">enable</span>-fastcgi --<span class="built_in">enable</span>-fpm --<span class="built_in">enable</span>-force-cgi-redirect --<span class="built_in">enable</span>-mbstring --with-mcrypt --with-gd --<span class="built_in">enable</span>-gd-native-ttf --with-openssl</div><div class="line">sed -i <span class="string">'s#-lz -lm -lxml2 -lz -lm -lxml2 -lz -lm -lcrypt#&amp; -liconv#'</span> Makefile</div><div class="line">make</div><div class="line">make install</div><div class="line">cp php.ini-dist /usr/<span class="built_in">local</span>/webserver/php/etc/php.ini</div><div class="line"><span class="built_in">cd</span> ../</div></pre></td></tr></table></figure>
<ol>
<li>编译安装PHP5扩展模块</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">tar zxvf memcache-2.2.3.tgz</div><div class="line"><span class="built_in">cd</span> memcache-2.2.3/</div><div class="line">/usr/<span class="built_in">local</span>/webserver/php/bin/phpize</div><div class="line">./configure --with-php-config=/usr/<span class="built_in">local</span>/webserver/php/bin/php-config</div><div class="line">make</div><div class="line">make install</div><div class="line"><span class="built_in">cd</span> ../tar jxvf eaccelerator-0.9.5.3.tar.bz2</div><div class="line"><span class="built_in">cd</span> eaccelerator-0.9.5.3/</div><div class="line">/usr/<span class="built_in">local</span>/webserver/php/bin/phpize</div><div class="line">./configure --<span class="built_in">enable</span>-eaccelerator=shared --with-php-config=/usr/<span class="built_in">local</span>/webserver/php/bin/php-config</div><div class="line">make</div><div class="line">make install</div><div class="line"><span class="built_in">cd</span> ../</div></pre></td></tr></table></figure>
<ol>
<li>修改php.ini文件</li>
</ol>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;手工修改：查找/usr/local/webserver/php/etc/php.ini中的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">extension_dir = <span class="string">"./"</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">extension_dir = <span class="string">"/usr/local/webserver/php/lib/php/extensions/no-debug-non-zts-20060613/"</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;并在此行后增加以下几行，然后保存：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">extension = <span class="string">"memcache.so"</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;再查找</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">output_buffering = Off</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">output_buffering = On</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;自动修改：若嫌手工修改麻烦，可执行以下shell命令，自动完成对php.ini文件的修改：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sed -i <span class="string">'s#extension_dir = "./"#extension_dir = "/usr/local/webserver/php/lib/php/extensions/no-debug-non-zts-20060613/"/nextension = "memcache.so"/n#'</span> /usr/<span class="built_in">local</span>/webserver/php/etc/php.ini</div><div class="line">sed -i <span class="string">'s#output_buffering = Off#output_buffering = On#'</span> /usr/<span class="built_in">local</span>/webserver/php/etc/php.ini</div><div class="line">    6、配置eAccelerator加速PHP：</div><div class="line">mkdir -p /usr/<span class="built_in">local</span>/webserver/eaccelerator_cache</div><div class="line">vi /usr/<span class="built_in">local</span>/webserver/php/etc/php.ini</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;按shift+g键跳到配置文件的最末尾，加上以下配置信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[eaccelerator]</div><div class="line">zend_extension=<span class="string">"/usr/local/webserver/php/lib/php/extensions/no-debug-non-zts-20060613/eaccelerator.so"</span></div><div class="line">eaccelerator.shm_size=<span class="string">"128"</span></div><div class="line">eaccelerator.cache_dir=<span class="string">"/usr/local/webserver/eaccelerator_cache"</span></div><div class="line">eaccelerator.enable=<span class="string">"1"</span></div><div class="line">eaccelerator.optimizer=<span class="string">"1"</span></div><div class="line">eaccelerator.check_mtime=<span class="string">"1"</span></div><div class="line">eaccelerator.debug=<span class="string">"0"</span></div><div class="line">eaccelerator.filter=<span class="string">""</span></div><div class="line">eaccelerator.shm_max=<span class="string">"0"</span></div><div class="line">eaccelerator.shm_ttl=<span class="string">"300"</span></div><div class="line">eaccelerator.shm_prune_period=<span class="string">"120"</span></div><div class="line">eaccelerator.shm_only=<span class="string">"0"</span></div><div class="line">eaccelerator.compress=<span class="string">"1"</span></div><div class="line">eaccelerator.compress_level=<span class="string">"9"</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;修改配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /etc/sysctl.conf</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;输入以下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kernel.shmmax = 134217728</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;然后执行以下命令使配置生效：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/sbin/sysctl -p</div></pre></td></tr></table></figure>
<ol>
<li>创建www用户和组，以及供blog.s135.com和www.s135.com两个虚拟主机使用的目录：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">/usr/sbin/groupadd www -g 48</div><div class="line">/usr/sbin/useradd -u 48 -g www www</div><div class="line">mkdir -p /data0/htdocs/blog</div><div class="line">chmod +w /data0/htdocs/blog</div><div class="line">chown -R www:www /data0/htdocs/blog</div><div class="line">mkdir -p /data0/htdocs/www</div><div class="line">chmod +w /data0/htdocs/www</div><div class="line">chown -R www:www /data0/htdocs/www</div></pre></td></tr></table></figure>
<ol>
<li>创建php-fpm配置文件（php-fpm是为PHP打的一个FastCGI管理补丁，可以平滑变更php.ini配置而无需重启php-cgi）：</li>
</ol>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在/usr/local/webserver/php/etc/目录中创建php-fpm.conf文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">rm -f /usr/<span class="built_in">local</span>/webserver/php/etc/php-fpm.conf</div><div class="line">vi /usr/<span class="built_in">local</span>/webserver/php/etc/php-fpm.conf</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;输入以下内容（如果安装 Nginx + PHP 用于程序调试，请将</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;value name=<span class="string">"display_errors"</span>&gt;0&lt;/value&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;改为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;value name=<span class="string">"display_errors"</span>&gt;1&lt;/value&gt;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;以便显示PHP错误信息，否则，Nginx 会报状态为500的空白错误页）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div></pre></td><td class="code"><pre><div class="line">All relative paths <span class="keyword">in</span> this config are relative to php<span class="string">'s install prefix </span></div><div class="line"><span class="string">&lt;section name="global_options"&gt;</span></div><div class="line"><span class="string">Pid file  </span></div><div class="line"><span class="string">&lt;value name="pid_file"&gt;/usr/local/webserver/php/logs/php-fpm.pid&lt;/value&gt;</span></div><div class="line"><span class="string">Error log file  </span></div><div class="line"><span class="string">&lt;value name="error_log"&gt;/usr/local/webserver/php/logs/php-fpm.log&lt;/value&gt;</span></div><div class="line"><span class="string">Log level  </span></div><div class="line"><span class="string">&lt;value name="log_level"&gt;notice&lt;/value&gt;</span></div><div class="line"><span class="string">When this amount of php processes exited with SIGSEGV or SIGBUS ...  </span></div><div class="line"><span class="string">&lt;value name="emergency_restart_threshold"&gt;10&lt;/value&gt;</span></div><div class="line"><span class="string">... in a less than this interval of time, a graceful restart will be initiated.  </span></div><div class="line"><span class="string">Useful to work around accidental curruptions in accelerator'</span>s shared memory.  </div><div class="line">&lt;value name=<span class="string">"emergency_restart_interval"</span>&gt;1m&lt;/value&gt;</div><div class="line">Time <span class="built_in">limit</span> on waiting child<span class="string">'s reaction on signals from master  </span></div><div class="line"><span class="string">&lt;value name="process_control_timeout"&gt;5s&lt;/value&gt;</span></div><div class="line"><span class="string">Set to '</span>no<span class="string">' to debug fpm  </span></div><div class="line"><span class="string">&lt;value name="daemonize"&gt;yes&lt;/value&gt;</span></div><div class="line"><span class="string">&lt;/section&gt;</span></div><div class="line"><span class="string">&lt;workers&gt;</span></div><div class="line"><span class="string">&lt;section name="pool"&gt;</span></div><div class="line"><span class="string">Name of pool. Used in logs and stats.  </span></div><div class="line"><span class="string">&lt;value name="name"&gt;default&lt;/value&gt;</span></div><div class="line"><span class="string">Address to accept fastcgi requests on.  </span></div><div class="line"><span class="string">Valid syntax is '</span>ip.ad.re.ss:port<span class="string">' or just '</span>port<span class="string">' or '</span>/path/to/unix/socket<span class="string">'  </span></div><div class="line"><span class="string">&lt;value name="listen_address"&gt;127.0.0.1:9000&lt;/value&gt;</span></div><div class="line"><span class="string">&lt;value name="listen_options"&gt;</span></div><div class="line"><span class="string">Set listen(2) backlog  </span></div><div class="line"><span class="string">&lt;value name="backlog"&gt;-1&lt;/value&gt;</span></div><div class="line"><span class="string">Set permissions for unix socket, if one used.  </span></div><div class="line"><span class="string">In Linux read/write permissions must be set in order to allow connections from web server.  </span></div><div class="line"><span class="string">Many BSD-derrived systems allow connections regardless of permissions.  </span></div><div class="line"><span class="string">&lt;value name="owner"&gt;&lt;/value&gt;</span></div><div class="line"><span class="string">&lt;value name="group"&gt;&lt;/value&gt;</span></div><div class="line"><span class="string">&lt;value name="mode"&gt;0666&lt;/value&gt;</span></div><div class="line"><span class="string">&lt;/value&gt;</span></div><div class="line"><span class="string">Additional php.ini defines, specific to this pool of workers.  </span></div><div class="line"><span class="string">&lt;value name="php_defines"&gt;</span></div><div class="line"><span class="string">&lt;value name="sendmail_path"&gt;/usr/sbin/sendmail -t -i&lt;/value&gt;</span></div><div class="line"><span class="string">&lt;value name="display_errors"&gt;0&lt;/value&gt;</span></div><div class="line"><span class="string">&lt;/value&gt;</span></div><div class="line"><span class="string">Unix user of processes  </span></div><div class="line"><span class="string">&lt;value name="user"&gt;www&lt;/value&gt;</span></div><div class="line"><span class="string">Unix group of processes  </span></div><div class="line"><span class="string">&lt;value name="group"&gt;www&lt;/value&gt;</span></div><div class="line"><span class="string">Process manager settings  </span></div><div class="line"><span class="string">&lt;value name="pm"&gt;</span></div><div class="line"><span class="string">Sets style of controling worker process count.  </span></div><div class="line"><span class="string">Valid values are '</span>static<span class="string">' and '</span>apache-like<span class="string">'  </span></div><div class="line"><span class="string">&lt;value name="style"&gt;static&lt;/value&gt;</span></div><div class="line"><span class="string">Sets the limit on the number of simultaneous requests that will be served.  </span></div><div class="line"><span class="string">Equivalent to Apache MaxClients directive.  </span></div><div class="line"><span class="string">Equivalent to PHP_FCGI_CHILDREN environment in original php.fcgi  </span></div><div class="line"><span class="string">Used with any pm_style.  </span></div><div class="line"><span class="string">&lt;value name="max_children"&gt;200&lt;/value&gt;</span></div><div class="line"><span class="string">Settings group for '</span>apache-like<span class="string">' pm style  </span></div><div class="line"><span class="string">&lt;value name="apache_like"&gt;</span></div><div class="line"><span class="string">Sets the number of server processes created on startup.  </span></div><div class="line"><span class="string">Used only when '</span>apache-like<span class="string">' pm_style is selected  </span></div><div class="line"><span class="string">&lt;value name="StartServers"&gt;20&lt;/value&gt;</span></div><div class="line"><span class="string">Sets the desired minimum number of idle server processes.  </span></div><div class="line"><span class="string">Used only when '</span>apache-like<span class="string">' pm_style is selected  </span></div><div class="line"><span class="string">&lt;value name="MinSpareServers"&gt;5&lt;/value&gt;</span></div><div class="line"><span class="string">Sets the desired maximum number of idle server processes.  </span></div><div class="line"><span class="string">Used only when '</span>apache-like<span class="string">' pm_style is selected  </span></div><div class="line"><span class="string">&lt;value name="MaxSpareServers"&gt;250&lt;/value&gt;</span></div><div class="line"><span class="string">&lt;/value&gt;</span></div><div class="line"><span class="string">&lt;/value&gt;</span></div><div class="line"><span class="string">Time limit on waiting execution of single request  </span></div><div class="line"><span class="string">Should be used when '</span>max_execution_time<span class="string">' ini option does not terminate execution for some reason  </span></div><div class="line"><span class="string">&lt;value name="request_execution_timeout"&gt;31s&lt;/value&gt;</span></div><div class="line"><span class="string">Set open file desc rlimit  </span></div><div class="line"><span class="string">&lt;value name="rlimit_files"&gt;51200&lt;/value&gt;</span></div><div class="line"><span class="string">Set max core size rlimit  </span></div><div class="line"><span class="string">&lt;value name="rlimit_core"&gt;0&lt;/value&gt;</span></div><div class="line"><span class="string">Chroot to this directory at the start  </span></div><div class="line"><span class="string">&lt;value name="chroot"&gt;&lt;/value&gt;</span></div><div class="line"><span class="string">Chdir to this directory at the start  </span></div><div class="line"><span class="string">&lt;value name="chdir"&gt;&lt;/value&gt;</span></div><div class="line"><span class="string">Redirect workers'</span> stdout and stderr into main error <span class="built_in">log</span>.  </div><div class="line">If not <span class="built_in">set</span>, they will be redirected to /dev/null, according to FastCGI specs  </div><div class="line">&lt;value name=<span class="string">"catch_workers_output"</span>&gt;yes&lt;/value&gt;</div><div class="line">How much requests each process should execute before respawn.  </div><div class="line">Useful to work around memory leaks <span class="keyword">in</span> 3rd party libraries.  </div><div class="line">For endless request processing please specify 0  </div><div class="line">Equivalent to PHP_FCGI_MAX_REQUESTS  </div><div class="line">&lt;value name=<span class="string">"max_requests"</span>&gt;51200&lt;/value&gt;</div><div class="line">Comma separated list of ipv4 addresses of FastCGI clients that allowed to connect.  </div><div class="line">Equivalent to FCGI_WEB_SERVER_ADDRS environment <span class="keyword">in</span> original php.fcgi (5.2.2+)  </div><div class="line">Makes sense only with AF_INET listening socket.  </div><div class="line">&lt;value name=<span class="string">"allowed_clients"</span>&gt;127.0.0.1&lt;/value&gt;</div><div class="line">Pass environment variables like LD_LIBRARY_PATH  </div><div class="line">All <span class="variable">$VARIABLEs</span> are taken from current environment  </div><div class="line">&lt;value name=<span class="string">"environment"</span>&gt;</div><div class="line">&lt;value name=<span class="string">"HOSTNAME"</span>&gt;<span class="variable">$HOSTNAME</span>&lt;/value&gt;</div><div class="line">&lt;value name=<span class="string">"PATH"</span>&gt;/usr/<span class="built_in">local</span>/bin:/usr/bin:/bin&lt;/value&gt;</div><div class="line">&lt;value name=<span class="string">"TMP"</span>&gt;/tmp&lt;/value&gt;</div><div class="line">&lt;value name=<span class="string">"TMPDIR"</span>&gt;/tmp&lt;/value&gt;</div><div class="line">&lt;value name=<span class="string">"TEMP"</span>&gt;/tmp&lt;/value&gt;</div><div class="line">&lt;value name=<span class="string">"OSTYPE"</span>&gt;<span class="variable">$OSTYPE</span>&lt;/value&gt;</div><div class="line">&lt;value name=<span class="string">"MACHTYPE"</span>&gt;<span class="variable">$MACHTYPE</span>&lt;/value&gt;</div><div class="line">&lt;value name=<span class="string">"MALLOC_CHECK_"</span>&gt;2&lt;/value&gt;</div><div class="line">&lt;/value&gt;</div><div class="line">&lt;/section&gt;</div><div class="line">&lt;/workers&gt;</div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure>
<ol>
<li>启动php-cgi进程，监听127.0.0.1的9000端口，进程数为200（如果服务器内存小于3GB，可以只开启64个进程），用户为www：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">ulimit</span> -SHn 51200</div><div class="line">/usr/<span class="built_in">local</span>/webserver/php/sbin/php-fpm start</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;注：/usr/local/webserver/php/sbin/php-fpm还有其他参数，包括：start|stop|quit|restart|reload|logrotate，修改php.ini后不重启php-cgi，重新加载  配置文件使用reload。</p>
<h2 id="三、安装Nginx-0-7-14"><a href="#三、安装Nginx-0-7-14" class="headerlink" title="三、安装Nginx 0.7.14"></a>三、安装Nginx 0.7.14</h2><ol>
<li>安装Nginx所需的pcre库：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">tar zxvf pcre-7.7.tar.gz</div><div class="line"><span class="built_in">cd</span> pcre-7.7/</div><div class="line">./configure</div><div class="line">make &amp;&amp; make install</div><div class="line"><span class="built_in">cd</span> ../</div></pre></td></tr></table></figure>
<ol>
<li>安装Nginx</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">tar zxvf nginx-0.7.14.tar.gz</div><div class="line"><span class="built_in">cd</span> nginx-0.7.14/</div><div class="line">./configure --user=www --group=www --prefix=/usr/<span class="built_in">local</span>/webserver/nginx --with-http_stub_status_module --with-http_ssl_module</div><div class="line">make &amp;&amp; make install</div><div class="line"><span class="built_in">cd</span> ../</div></pre></td></tr></table></figure>
<ol>
<li>创建Nginx日志目录</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mkdir -p /data1/logs</div><div class="line">chmod +w /data1/logs</div><div class="line">chown -R www:www /data1/logs</div></pre></td></tr></table></figure>
<ol>
<li>创建Nginx配置文件</li>
</ol>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在/usr/local/webserver/nginx/conf/目录中创建nginx.conf文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">rm -f /usr/<span class="built_in">local</span>/webserver/nginx/conf/nginx.conf</div><div class="line">vi /usr/<span class="built_in">local</span>/webserver/nginx/conf/nginx.conf</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;输入以下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line">user www www;</div><div class="line">worker_processes 8;</div><div class="line">error_log /data1/logs/nginx_error.log crit;</div><div class="line">pid /usr/<span class="built_in">local</span>/webserver/nginx/nginx.pid;</div><div class="line"><span class="comment">#Specifies the value for maximum file descriptors that can be opened by this process.</span></div><div class="line">worker_rlimit_nofile 51200;</div><div class="line">events</div><div class="line">&#123;</div><div class="line"> use epoll;</div><div class="line"> worker_connections 51200;</div><div class="line">&#125;</div><div class="line">http</div><div class="line">&#123;</div><div class="line"> include mime.types;</div><div class="line"> default_type application/octet-stream;</div><div class="line"><span class="comment">#charset gb2312;</span></div><div class="line">server_names_hash_bucket_size 128;</div><div class="line">client_header_buffer_size 32k;</div><div class="line">large_client_header_buffers 4 32k;</div><div class="line">sendfile on;</div><div class="line">tcp_nopush on;</div><div class="line">keepalive_timeout 60;</div><div class="line">tcp_nodelay on;</div><div class="line">fastcgi_connect_timeout 300;</div><div class="line">fastcgi_send_timeout 300;</div><div class="line">fastcgi_read_timeout 300;</div><div class="line">fastcgi_buffer_size 64k;</div><div class="line">fastcgi_buffers 4 64k;</div><div class="line">fastcgi_busy_buffers_size 128k;</div><div class="line">fastcgi_temp_file_write_size 128k;</div><div class="line">gzip on;</div><div class="line">gzip_min_length 1k;</div><div class="line">gzip_buffers 4 16k;</div><div class="line">gzip_http_version 1.0;</div><div class="line">gzip_comp_level 2;</div><div class="line">gzip_types text/plain application/x-JavaScript text/css application/xml;</div><div class="line">gzip_vary on;</div><div class="line"><span class="comment">#limit_zone crawler $binary_remote_addr 10m;</span></div><div class="line">server</div><div class="line">&#123;</div><div class="line">listen 80;</div><div class="line">server_name blog.s135.com;</div><div class="line">index index.html index.htm index.php;</div><div class="line">root /data0/htdocs/blog;</div><div class="line"><span class="comment">#limit_conn crawler 20;</span></div><div class="line">location ~ .*/.(php|php5)?$</div><div class="line">&#123;</div><div class="line"><span class="comment">#fastcgi_pass unix:/tmp/php-cgi.sock;</span></div><div class="line">fastcgi_pass 127.0.0.1:9000;</div><div class="line">fastcgi_index index.php;</div><div class="line">include fcgi.conf;</div><div class="line">&#125;</div><div class="line">location ~ .*/.(gif|jpg|jpeg|png|bmp|swf)$</div><div class="line">&#123;</div><div class="line">expires 30d;</div><div class="line">&#125;</div><div class="line">location ~ .*/.(js|css)?$</div><div class="line">&#123;</div><div class="line">expires 1h;</div><div class="line">&#125;</div><div class="line">log_format access <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></div><div class="line"><span class="string">'$status $body_bytes_sent "$http_referer" '</span></div><div class="line"><span class="string">'"$http_user_agent" $http_x_forwarded_for'</span>;</div><div class="line">access_log /data1/logs/access.log access;</div><div class="line">&#125;</div><div class="line">server</div><div class="line">&#123;</div><div class="line">listen 80;</div><div class="line">server_name www.s135.com;</div><div class="line">index index.html index.htm index.php;</div><div class="line">root /data0/htdocs/www;</div><div class="line">location ~ .*/.(php|php5)?$</div><div class="line">&#123;</div><div class="line"><span class="comment">#fastcgi_pass unix:/tmp/php-cgi.sock;</span></div><div class="line">fastcgi_pass 127.0.0.1:9000;</div><div class="line">fastcgi_index index.php;</div><div class="line">include fcgi.conf;</div><div class="line">&#125;</div><div class="line">log_format wwwlogs <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></div><div class="line"><span class="string">'$status $body_bytes_sent "$http_referer" '</span></div><div class="line"><span class="string">'"$http_user_agent" $http_x_forwarded_for'</span>;</div><div class="line">access_log /data1/logs/wwwlogs.log wwwlogs;</div><div class="line">&#125;</div><div class="line">server</div><div class="line">&#123;</div><div class="line">listen 80;</div><div class="line">server_name status.blog.s135.com;</div><div class="line">location / &#123;</div><div class="line">stub_status on;</div><div class="line">access_log off;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在/usr/local/webserver/nginx/conf/目录中创建fcgi.conf文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /usr/<span class="built_in">local</span>/webserver/nginx/conf/fcgi.conf</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;输入以下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">fastcgi_param GATEWAY_INTERFACE CGI/1.1;</div><div class="line">fastcgi_param SERVER_SOFTWARE nginx;fastcgi_param QUERY_STRING <span class="variable">$query_string</span>;</div><div class="line">fastcgi_param REQUEST_METHOD <span class="variable">$request_method</span>;</div><div class="line">fastcgi_param CONTENT_TYPE <span class="variable">$content_type</span>;</div><div class="line">fastcgi_param CONTENT_LENGTH <span class="variable">$content_length</span>;</div><div class="line">fastcgi_param SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</div><div class="line">fastcgi_param SCRIPT_NAME <span class="variable">$fastcgi_script_name</span>;</div><div class="line">fastcgi_param REQUEST_URI <span class="variable">$request_uri</span>;</div><div class="line">fastcgi_param DOCUMENT_URI <span class="variable">$document_uri</span>;</div><div class="line">fastcgi_param DOCUMENT_ROOT <span class="variable">$document_root</span>;</div><div class="line">fastcgi_param SERVER_PROTOCOL <span class="variable">$server_protocol</span>;</div><div class="line">fastcgi_param REMOTE_ADDR <span class="variable">$remote_addr</span>;</div><div class="line">fastcgi_param REMOTE_PORT <span class="variable">$remote_port</span>;</div><div class="line">fastcgi_param SERVER_ADDR <span class="variable">$server_addr</span>;</div><div class="line">fastcgi_param SERVER_PORT <span class="variable">$server_port</span>;</div><div class="line">fastcgi_param SERVER_NAME <span class="variable">$server_name</span>;</div><div class="line"><span class="comment"># PHP only, required if PHP was built with --enable-force-cgi-redirect</span></div><div class="line">fastcgi_param REDIRECT_STATUS 200;</div></pre></td></tr></table></figure>
<ol>
<li>启动Nginx</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">ulimit</span> -SHn 51200</div><div class="line">/usr/<span class="built_in">local</span>/webserver/nginx/sbin/nginx</div></pre></td></tr></table></figure>
<h2 id="四、配置开机自动启动Nginx-PHP"><a href="#四、配置开机自动启动Nginx-PHP" class="headerlink" title="四、配置开机自动启动Nginx + PHP"></a>四、配置开机自动启动Nginx + PHP</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /etc/rc.local</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在末尾增加以下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">ulimit</span> -SHn 51200</div><div class="line">/usr/<span class="built_in">local</span>/webserver/php/sbin/php-fpm start</div><div class="line">/usr/<span class="built_in">local</span>/webserver/nginx/sbin/nginx</div></pre></td></tr></table></figure>
<h2 id="五、优化Linux内核参数"><a href="#五、优化Linux内核参数" class="headerlink" title="五、优化Linux内核参数"></a>五、优化Linux内核参数</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /etc/sysctl.conf</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在末尾增加以下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">net.ipv4.tcp_fin_timeout = 30</div><div class="line">net.ipv4.tcp_keepalive_time = 300</div><div class="line">net.ipv4.tcp_syncookies = 1</div><div class="line">net.ipv4.tcp_tw_reuse = 1</div><div class="line">net.ipv4.tcp_tw_recycle = 1</div><div class="line">net.ipv4.ip_local_port_range = 5000 65000</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;使配置立即生效：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/sbin/sysctl -p</div></pre></td></tr></table></figure>
<h2 id="六、在不停止Nginx服务的情况下平滑变更Nginx配置"><a href="#六、在不停止Nginx服务的情况下平滑变更Nginx配置" class="headerlink" title="六、在不停止Nginx服务的情况下平滑变更Nginx配置"></a>六、在不停止Nginx服务的情况下平滑变更Nginx配置</h2><ol>
<li>修改/usr/local/webserver/nginx/conf/nginx.conf配置文件后，请执行以下命令检查配置文件是否正确：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/<span class="built_in">local</span>/webserver/nginx/sbin/nginx -t</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;如果屏幕显示以下两行信息，说明配置文件正确：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">the configuration file /usr/<span class="built_in">local</span>/webserver/nginx/conf/nginx.conf syntax is ok</div><div class="line">the configuration file /usr/<span class="built_in">local</span>/webserver/nginx/conf/nginx.conf was tested successfully</div></pre></td></tr></table></figure>
<ol>
<li>这时，输入以下命令查看Nginx主进程号：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ps -ef | grep <span class="string">"nginx: master process"</span> | grep -v <span class="string">"grep"</span> | awk -F <span class="string">' '</span> <span class="string">'&#123;print $2&#125;'</span></div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;屏幕显示的即为Nginx主进程号，例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">6302</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;这时，执行以下命令即可使修改过的Nginx配置文件生效：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">kill</span> -HUP 6302</div></pre></td></tr></table></figure>
<p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;或者无需这么麻烦，找到Nginx的Pid文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">kill</span> -HUP `cat /usr/<span class="built_in">local</span>/webserver/nginx/nginx.pid`</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LNMP/">LNMP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/23/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/22/">22</a><a class="page-number" href="/page/23/">23</a><span class="page-number current">24</span><a class="page-number" href="/page/25/">25</a><a class="page-number" href="/page/26/">26</a><span class="space">&hellip;</span><a class="page-number" href="/page/63/">63</a><a class="extend next" rel="next" href="/page/25/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2017 失落的乐章
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/smackgg/hexo-theme-smackdown" target="_blank">Smackdown</a>
        </div>
    </div>
  </div>
</footer>
    </div>
    

<script>
	var yiliaConfig = {
		fancybox: ,
		mathjax: ,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="/js/main.js"></script>



  </div>
</body>
</html>